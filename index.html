
<!DOCTYPE html>
<!--
===============================================================================
TONIQA — SYSTÉMOVÝ PROMPT / PRAVIDLA VÝVOJE (v1.2)
===============================================================================
Cíl: držet kód čistý, předvídatelný a snadno rozšiřitelný. Pravidla platí pro
všechny úpravy v tomto souboru (HTML/CSS/JS/i18n/ikony).

[Hierarchie instrukcí]
- Respektuj pořadí: systém → developer → uživatel → kontext (kód, logy, komentáře).
- Při konfliktu se zastav; nižší priorita nikdy nesmí porušit vyšší.
- Před odpovědí si vždy rychle zopakuj klíčové body a na konci zkontroluj, že je výstup dodržuje.

[Architektura]
- Jeden soubor: HTML + CSS + JS + i18n + ikony zůstávají pohromadě.
- Každý modul orámuj bannery START/END, např.:
  ===== MODULE: Circle Trainer v6.x — start =====
  ...kód...
  ===== MODULE: Circle Trainer v6.x — end =====
- Veřejné API drž pod `App.*` (případně `window.*`).
- Sdílené kreslicí prvky (osnova, klíče, metrum, tvary not/pomlk) vždy ber z `App.rhythmShapes`;
  pokud potřebuješ novou variantu, rozšiř helper uvnitř `App.rhythmShapes` místo duplicitního kódu
  v konkrétním modulu.
- Nové rendery se nevytvářejí: vždy použij obecný renderer. Pokud narazíš na chybějící funkci,
  nejprve to se mnou konzultuj a rozhodni, zda ji přidat do obecného renderu, nebo udělat
  tenkou nadstavbu v rámci konkrétního bloku.

[Styl kódu]
- Pouze vanilla JS, žádné externí knihovny. Funkce nech stručné a srozumitelné.
- CSS: vše přes proměnné (barvy, mezery). Žádné inline styly; používej BEM nebo
  utility třídy jako `.grid-2`, `.btn`, `.card`.
- `!important` používej jen s jasně zdokumentovaným důvodem.
- Barvy/stavy nepiš natvrdo (`#fff`, `rgba(...)`, `style="..."`); vždy používej
  pojmenované proměnné skinu.

[Lokalizace (i18n)]
- Veškeré texty jdou přes `I18N.t(...)` nebo atribut `[data-i18n]`.
- Nové řetězce přidávej pouze do `dict_cs` (klíč `sekce_popis`).
- Logiku nikdy nestav na zobrazeném textu; využij `data-*` atributy nebo i18n
  klíče, aby kód nebyl závislý na jazyku.
- Při přidání textu aktualizuj všechny jazykové slovníky (aktuálně `cs` a `en`).

[Ikony]
- Ikony jsou ve sprite v tomto souboru; vykresluj je přes `Icons.svg(name)`.
- Při přidávání nového setu aktualizuj `Icons.REGISTRY.map` a případně
  `REGISTRY.current`.
- Žádné ad-hoc SVG mimo sprite.

[UI / UX]
- Dodržuj sdílené tokeny (barvy, rádiusy, mezery). Výchozí rádius: 14 px.
- Dlaždice/tlačítka musí být konzistentní napříč velikostmi; na mobilech
  zůstávají dlaždice.
- Navigační vs. detailní obrazovky se nesmí “prat” – přepínání musí být hladké.
- Vertikální rozestupy řeš přes `.stack` (`stack-sm/md/lg`), ne ad-hoc marginy
  mezi komponentami.
- Dlaždicové sekce (teorie/procvičování) stavěj na kombinaci `.grid-3.hub-cards`
  + `.card-tile`; nevymýšlej nové obalové třídy jen kvůli skrytí tlačítek.
- `grid-3.hub-cards` musí používat `minmax(260px,1fr)` (220px pouze v media
  queri pro ≤979 px); gap řiď přes `--grid-gap` a dej pozor, aby se styly
  nevytratily při přepnutí `body.nav-mode`/`detail-mode`.

[Čistota kódu]
- Při refaktoru odstraň mrtvý nebo duplicitní kód (případné poznámky krátce
  okomentuj datem).
- Žádné externí requesty, `eval` ani dynamické injekce skriptů.
- Vyhni se overkill řešením; preferuj čitelnost.
- Žádné inline styly pro barvy/stavy – přidej raději proměnnou do skinů a třídu.
- Stavovou logiku nikdy neodvozuj z textů v DOM; potřebné informace předej přes
  datové struktury (`data-*`, JSON) a využij připravené utility (např.
  `data-eval` + `App.utils.applyEvalState`).
- Před zahájením každého úkolu si vždy načti aktuální strukturu souboru, aby
  úpravy vycházely z posledního stavu.

[Skins / motivy]
- Nové barvy/stavy přidávej jako proměnné do všech skinů i do fallbacku `:root`.
  Udržuj konzistentní skupiny (base, buttons, elevations, tiles, charts, circle)
  s jasnými komentáři.
- Názvy `--tile-*-*` reprezentují konkrétní sloty dlaždic (např. “build”, “quiz”)
  a zůstávají stejné ve všech skinech; mění se pouze jejich hodnoty.
- Nové domovské dlaždice: nejprve přidej `--tile-<název>-{from|to|bd}` do všech
  skinů + fallbacku, poté mapuj `card-tile.home-<název>` na tyto tokeny (bez
  natvrdo zapsaných barev) a rozšiř i18n, ikony a view.
- Midnight: dlaždice drž v modrých nočních tónech; „O stupnicích“ nejjemnější varianta, „Urči tóninu v kruhu“ nejvýraznější, ale stále modře laděná.
- Aurora: zajisti dostatečný kontrast textů na dlaždicích (zejména „O stupnicích“).
- Daylight: dlaždice mají plnou barvu bez gradientu (stejné počáteční i koncové barvy); jakýkoli požadavek na gradient eskaluj místo obcházení.
- Donut grafy, badge a další prvky musí používat `--chart-*`, `--ok-*`,
  `--bad-*` apod. Žádné výjimky.

[Hudební terminologie]
- Při pojmenování stupnic a klíčů používej `word_moll` / `word_dur` (překlady v i18n).
  Na výstupu zobrazuj např. `A + word_moll`, `C + word_dur`. Anglická verze má být
  v kontextu hudební teorie („minor“, „major“, „key signature“, „enharmonic variant“ atd.).

[Testování / regrese]
- Po každé úpravě udělej rychlý smoke test: navigace, kvízy, shrnutí i
  circle trainer bez chyb.
- Zvýraznění shrnutí: třídy `is-ok`/`is-bad` smí být pouze na `.eval-card`.

[Kontrolní checklist před commitem]
- Navigace Home ⇄ Scales hub ⇄ (List/Build/KS Quiz/Circle) funguje; tlačítka
  zpět a `data-action` delegace bez chyb.
- Kvízy: krokování (Předchozí/Další/Vyhodnotit), badge i závěrečná shrnutí bez
  JS chyb.
- Circle trainer (praktická sekce) drž plynulé přepínání; teoretická stránka kruhu zůstává pouze vizualizační.
  má správné odsazení.
- i18n: žádné natvrdo zapsané texty; nové klíče doplněny do `dict_cs`.
- Ikony: pouze sprite + `Icons.svg(name)`; `Icons.REGISTRY` zůstává konzistentní.
- CSS: žádná zbytečná `!important`; barvy/rádiusy ze sdílených tokenů.
- Responsivita: navigační obrazovky zůstávají dlaždicové, detailní fungují přirozeně.
- Zvýraznění shrnutí: `is-ok`/`is-bad` jen na `.eval-card`; kontejner čistý.
- Čistota: žádný mrtvý/duplicitní kód, žádné staré styly/ikony, žádné debug logy.
- Výkon: bez nekonečných smyček; MutationObserver zůstává lehký; žádné zbytečné
  reflow.
- Přístupnost: texty tlačítek dávají smysl, kontrast sedí, focus flow funguje.
- Verze: aktualizuj `<title>` s číslem verze a krátkým shrnutím změny.
- Jednosouborový build (prod/dev) bez externích závislostí zachován.
- >>> CHANGELOG POVINNÝ <<< každou úpravu zakonči záznamem ve formátu `YYYY-MM-DD: stručné shrnutí změny`.
- Osobní kontrola: před finální odpovědí ověř požadavky na barvy/gradienty, tokeny a i18n; explicitně si odškrtni, že nic neobchází pravidla skinů.

**Layout pravidlo:** Všechny sekce a stránky aplikace musí používat jednotné vnitřní odsazení (padding). Nepřidávej vlastní horizontální padding/margin do wrapperů view; spoléhej na základní `main.card` / `.section-card` / `.section-wrap` a společnou proměnnou `--section-padding`. Výjimky vyžadují výslovné schválení.

@devprompt: tato pravidla platí pro všechny další úpravy v souboru. Pro využití sdílených modulů a rendererů viz `Documentation/SHARED.md`; pro závislosti viz `Documentation/DEPS_MAP.md`; i18n konvence viz `Documentation/I18N_GUIDE.md`; CSS tokeny viz `Documentation/CSS_TOKENS.md`; před releasem projdi `Documentation/TEST_CHECKLIST.md`. Nové sdílené prvky vždy doplň do těchto dokumentů a používej je před vytvářením duplicity.
# Poznámka k posuvkám: Renderer přidává prostor a kreslí posuvky pouze pokud nota skutečně nese `accidental` (případně `meta.forceAccidental`). Při použití posuvek/předznamenání předávej do renderu plné note objekty (letter+accidental+octave) a podle potřeby nastav `accidentalSpace`/`showAccidentals`. Pro ladění mezer použij `?placeDebug` + `debugZones`/`debugPositions` (slotDebug v konzoli).


- 2026-01-04: Acc keyboard staff se přizpůsobí šířce renderu a je centrovaný.
- 2026-01-04: Acc keyboard staff je responsivní a neblokuje úzké layouty.
- 2026-01-04: Fold tlačítka mají výraznější styling bez chevronu.
- 2026-01-04: Fold bloky jsou obecné a zdokumentované ve SHARED.md.
- 2026-01-04: Přidán „peek“ efekt na hover u sbalených bloků.
- 2026-01-04: Fade náhledu sbalených bloků začíná výrazně dřív.
- 2026-01-04: Sbalené bloky stupnic mají náhled s postupným ztrácením.
- 2026-01-04: Sbalování stupnic reaguje na klik díky delegovanému handleru.
- 2026-01-04: Sbalování stupnic má viditelný toggle a jisté navázání při vstupu do stránky.
- 2026-01-04: Sbalování stupnic se inicializuje přes sdílený helper bez ReferenceError.
- 2026-01-04: Stránka Stupnice má sbalovací bloky pro mollové varianty a detail módů.
- 2026-01-04: Úvod „Co je stupnice“ nahrazen plnou verzí textu z podkladů (cs/en) a rozšířen o seznamy.
- 2026-01-04: Úvodní blok „Co je stupnice“ přepnut na HTML i18n (bold a seznamy).
- 2026-01-04: Přidán blok „Jak se stupnice liší“ s HTML formátováním (cs/en).
- 2026-01-04: Durová stupnice rozšířena podle podkladů, včetně renderu C dur osnovy (cs/en).
- 2026-01-04: Popisky renderu C dur ve „Durová stupnice“ používají základní barvu.
- 2026-01-04: Render C dur v „Durová stupnice“ zmenšen na polovinu.
- 2026-01-04: Render C dur zmenšen přes šířku containeru a přidáno tlačítko pro přehrání stupnice.
- 2026-01-04: Tlačítko přehrání stupnice v „Durová stupnice“ je kompaktní.
- 2026-01-04: Tlačítko přehrání v „Durová stupnice“ je vycentrované pod renderem.
- 2026-01-04: Nahrazeny bloky „Jak se stupnice používají“ a „Shrnutí“ novým blokem o stejné stupnici v různých tóninách s interaktivním renderem.
- 2026-01-04: Výběr tóniny vycentrován nad render, upraven noteGap pro posuvky a přidáno zvýraznění hraného tónu.
- 2026-01-04: Zvětšené rozestupy a vynucené místo pro posuvky v renderu stupnice.
- 2026-01-04: Render stupnice používá layoutMeasure s rezervou pro posuvky (béčka se nelepí).
- 2026-01-04: Vylepšený text u volby výchozího tónu a zachovaný noteGapBase=9 v ukázce.
- 2026-01-04: Pořadí výchozích tónů v ukázce upraveno na C–D–F–G–A.
- 2026-01-04: Text „Mollové stupnice“ nahrazen rozšířenou verzí (cs/en).
- 2026-01-04: Harmonická moll sekce nahrazena obsahem přirozené moll s renderem a přehráním (cs/en).
- 2026-01-04: Přidán helper `setActive` do obecného rendereru a ukázky ho používají pro zvýraznění.
- 2026-01-04: Sekce melodické moll rozšířena o nový obsah, render a přepínač směru (cs/en).
- 2026-01-04: Sekce melodické moll rozšířena o nový obsah, render a přepínač směru (cs/en).
- 2026-01-04: Přidána harmonická moll mezi přirozenou a melodickou, včetně renderu a přehrání (cs/en).
- 2026-01-04: Melodická moll render sjednocen do jedné osnovy (nahoru i dolů) a rozšířen na plnou šířku.
- 2026-01-04: Přehrávání melodické moll běží pouze v pořadí zobrazené stupnice (bez zpětného přehrání).
- 2026-01-20: Reading acc scale akce se na mobilu skládají do sloupce a vyplní šířku panelu.
- 2026-01-20: Zmenšená mobilní šířka tlačítek u reading acc scale a vycentrovaný label.
- 2026-01-20: Mobilní label přesunut nad tlačítka, mezi nimi zůstává jen tónina.
- 2026-01-20: Render nad klaviaturou se v acc sekci přizpůsobuje šířce kontejneru.
- 2026-01-20: Acc keyboard staff wrapper používá plnou šířku, aby se render nezmenšoval.
- 2026-01-20: Acc keyboard staff je na desktopu centrovaný přes flex wrapper.
- 2026-01-20: Acc keyboard staff má omezenou max šířku pro centrování nad klaviaturou.
- 2026-01-20: Acc keyboard staff render používá xMid preserveAspectRatio pro vycentrování SVG.
- 2026-01-20: Tlačítko rozbalení používá popisek „Číst víc“.
- 2026-01-20: Fold u církevních módů začíná až od přehledu základních módů.
- 2026-01-20: Fold v příbuznosti dur/moll začíná až od části o tónovém centru.
- 2026-01-20: Přidána enharmonická poznámka do sekce stejné stupnice v různých tóninách.
- 2026-01-20: Sekce stejné stupnice přesunula praktický render výš a přidala enharmonickou dvojici staffů.
- 2026-01-20: Enharmonická část ve stejné stupnici má vlastní sbalování.
- 2026-01-20: Mollové stupnice sjednoceny do jedné karty bez samostatných bloků.
- 2026-01-20: Obnovené marginy H4 nadpisů a odstavců ve scales info.
- 2026-01-20: Durová, mollová a pentatonická část jsou seskupené pod společný úvod.
- 2026-01-20: Základní typy stupnic mají vlastní sbalovací bloky pro dur/moll/pentatoniku.
- 2026-01-20: Mollové podsekce mají vlastní sbalování pro přirozenou, harmonickou a melodickou.
- 2026-01-20: Sbalování v církevních módech začíná u „Stejné tóny, jiný střed“.
- 2026-01-04: Pentatoniky rozšířeny o nový obsah a interaktivní render s typem, tónikou a přehráním (cs/en).
- 2026-01-04: Rozšířený blok „Durová a mollová příbuznost“ podle nových podkladů (cs/en).
- 2026-01-04: Build quiz má volbu typu stupnice (pentatonika/durová/mollová) s přizpůsobením otázek a vyhodnocení.
- 2026-01-04: Přidán blok „Církevní módy“ mezi příbuznost a stejné stupnice (cs/en).
- 2026-01-04: Odstraněn duplicitní blok „Přirozená moll“ včetně i18n klíčů.
- 2026-01-03: Sekce Odrazka ♮ má novou poslechovou ukázku s předznamenáním (G dur), odrazkou a posuvkou, včetně přehrávání.
- 2026-01-03: Ukázka Odrazka ♮ používá metrické měření taktů (measures) pro přesné barline pozice.
- 2026-01-03: Obecný renderer popisků not zohledňuje předznamenání a používá ♯/♭ pro posunuté tóny.
- 2026-01-03: Popisky not v obecném rendereru respektují platnost posuvek v rámci taktu.
- 2026-01-03: Ukázka „Posuvky u každé noty“ nemá zbytečnou odrazku ve 2. taktu.
- 2026-01-03: Obecný renderer popisků podporuje `accidentalScope:'note'` pro lokální posuvky bez přenosu.
- 2026-01-03: `accidentalScope` se propisuje z `renderGeneric` do rendereru, aby se popisky v chromatic ukázce neřídily předchozí posuvkou.
- 2026-01-03: Připomínková posuvka má přeformulovaný text pro všechny typy posuvek (cs/en).
- 2026-01-03: Sekce „Připomínková posuvka“ má novou ukázku s přehráváním.
- 2026-01-03: Odstraněná sekce enharmonické záměny a shrnutí z teorie posuvek.
- 2026-01-03: Aktualizovaný title a drobný cleanup mrtvého kódu v rendereru.
- 2026-01-03: Překryvné tóny v mapě oktáv jsou zobrazené s nižší opacitou.
- 2026-01-03: Mapa oktáv má základní barvu linek osnovy a zelené přehrávací tlačítko.
- 2026-01-03: Úvod mapy oktáv vysvětluje překryvné tóny a jejich zesvětlení.
- 2026-01-03: Reading-find používá layoutMeasure pro posuvky, aby béčka měla prostor.
- 2026-01-03: Detail stupnic doplňuje Db/Gb enharmonické řádky, používá layoutMeasure pro béčkové noty a zelené přehrávací tlačítko.
- 2026-01-03: Mini rendery tupletů v sekci Dělené rytmy jsou zvětšené o 50 %.
- 2026-01-03: Zvětšené minirendery porovnání dělených rytmů v hero matrix.
- 2025-12-29: Detail stupnice má zapnutou rezervu pro posuvky přes volbu rendereru a noty s posuvkami označujeme `meta.forceAccidental`, aby symboly nebyly nalepené na hlavičky not. Teorie posuvek (křížek/béčko) používá `forceAccidental` a zapnutý `accidentalSpace`, takže se posuvky nespíjí s notami. Obecný renderer posouvá hlavičky dál od posuvek, takže symbol nezasahuje do předchozí noty. Karty křížku/béčka už neupravují šířku/height SVG natvrdo, takže sloty zůstanou podle rendereru; karty mají větší prostor, aby se rendery vešly na výšku i šířku. Zvětšené sloty/staff kontejnery v kartách křížku/béčka, aby se rendery nedeformovaly na výšku.
- 2025-01-03: Stejná řada tónů v různých výškách má širší panel, fixní šířku renderu, centrovaná tlačítka a vynucené posuvky s mezerou, takže béčka nejsou nalepená a noty jsou větší bez poskakování šířky.
- 2025-01-03: Klaviatura používá fixní layout (rezerva pro posuvku v layoutMeasure), takže render nepřeskakuje při změně zápisu a má stálý noteGap.
- 2025-01-03: Ukázka „Posuvky vs. předznamenání“ běží čistě na obecném renderu s automatickými stonky a layoutMeasure (2×4/4 takty, čtvrťové noty, metrum/barlines bez vlastních konstant).
- 2025-01-03: Ukázka „Posuvky vs. předznamenání“ znovu postavená čistě na obecném renderu (2×4/4 čtvrťové noty, metrum/barlines z layoutMeasure, stonky auto, posuvky/předznamenání podle předpisu).
- 2025-01-03: Doplněná dokumentace k rendereru (layoutMeasure/barUnits/meter + drawMeterAndBar) pro taktové ukázky, aby se finální taktová čára a metrum řešily jednotně.
- 2025-01-03: Poznámky k rendereru: stonky nechávat na `defaultStem:'auto'`, metrum/barline nekreslit dvakrát (stačí `layout` + `finalBar`); dokumentace doplněna do SHARED.md.
- 2025-01-03: Předznamenání používá sjednocený výškový mapping jako lab (standardní oktávy pro klíč a rozdílné offsety pro křížky/béčka) – jedna společná funkce `drawSignatureMarks` pro ukázky i lab.
- 2025-01-03: Sekce Odrazka ♮ má zjednodušený nadpis a „Speciální případ: připomínková posuvka“ je vyvedený jako samostatný odstavec.
- 2025-01-03: „Speciální případ: připomínková posuvka“ je vytažen jako samostatný nadpis na úrovni Odrazka ♮.
- 2025-01-03: „Speciální případ: připomínková posuvka“ je přesunut do samostatného bloku (vlastní card) v sekci Odrazka ♮.
- 2025-12-29: Klaviatura používá layoutMeasure + fillWidth a větší paddingy, aby se render vycentroval, nota s posuvkou měla rezervu a label se vešel.
- 2025-12-29: Zvýšené min/max rozměry a rozestupy karet křížku/béčka, aby se rendery vešly na výšku i šířku; grid sloty jsou širší (min 320px) a staff kontejnery nemají pevné max-width. Ukázky křížku/béčka nechávají renderer roztáhnout SVG na plnou šířku kontejneru (fillWidth) a používají layoutMeasure s rezervou pro posuvky, aby měly dostatek prostoru.
- 2025-12-29: Tlačítka „Přehrát“ u křížku/béčka jsou zúžená na polovinu šířky karty.
- 2025-12-29: Půltónové ukázky běží na výchozích metrikách rendereru (bez inline height), aby se viewBox přizpůsobil obsahu. Půltónové „sousední tóny“ mají větší labelMargin/extraBottom, aby se text vešel do viewBoxu.
- 2025-12-29: Zobrazení půltónů v notové osnově vypíná meter/barUnits (žádná taktová čára) přes `meterUnits:0` a nechává renderer rozestupy přes layoutMeasure.
- 2025-12-29: Zobrazení půltónů v notové osnově má širší panel a layoutMeasure bez pevného noteGap (barUnits vypnuté), renderer si řídí mezeru mezi notami a nekreslí taktovou čáru.
- 2025-12-29: Klávesová ukázka má větší staff (šířka/padding), renderer bez ručního noteGap a s `forceAccidental` u noty, aby klíč/nota/posuvka i label měly prostor.
- 2025-12-29: Klávesová ukázka má větší staff, paddingy a `fillWidth`; posuvky u noty jsou vynucené přes `forceAccidental`, aby měly správné odsazení.
- 2025-12-29: Klávesová ukázka běží na rendereru bez ručních šířek; větší paddingy/fillWidth zajistí, že klíč, nota i posuvka mají prostor a label je vidět.
- 2025-12-11: Dynamická šířka taktů podle obsahu (layoutMeasure škáluje spany podle součtu jednotek, barline se odvíjí od reálného obsahu).
- 2025-12-11: Rozšířený debug overlay (zóny padding/clef/signatura/metrum/takty + sloty not); min. 2 linky nahoře kvůli klíči; auto směr nožek podle výšky.
- 2025-12-11: Rozměrové jednotky pro layout (durationUnits podporuje tečky i volitelné spaceUnits) a lab zjednodušený na 2 takty pro ladění rozestupů.
- 2025-12-11: Posun hlavičky noty do první třetiny slotu (x = start + span/3), aby nota nestála nalepená na začátku vyhrazeného prostoru.
- 2025-12-11: Lab render nechává šířku taktů dle obsahu bez omezení maxWidth, aby při více notách nedocházelo k “restartu” kreslení na začátku a vše se vešlo s případným horizontálním posunem.
- 2025-12-11: Lab generuje delší durovou řadu (buildMajorSequence) podle počtu eventů, aby se noty neopakovaly/nesnižovaly o oktávu při delších sekvencích.
- 2025-12-11: Trioly se počítají jako “3 za 2” (meta.tuplet === true snižuje units na 2/3), aby osminová triola zabrala šířku jedné čtvrťové a nepřetékal takt.
- 2025-12-11: Tuplety obecně – durationUnits umí { n, in } (např. kvartola 4 za 3, kvintola 5 za 4); boolean true zůstává jako triola 3 za 2.
- 2025-12-11: Trioly v labu mají explicitní tuplet {n:3,in:2} a meta se slučuje (nepřepíše), takže se fakticky počítá správná šířka trioly.
- 2025-12-12: Trámec pro down-stem se kreslí dole (bere stemBottomY), beamované noty nevytvářejí praporky.
- 2025-12-12: Fix ReferenceError u směru trámce (dir se odvozuje z note.stem nebo ze stonku bez použití stemDir).
- 2025-12-12: Korekce offsetu trámce pro směry dolů (offset kladný, aby beam ležel pod hlavičkou).
- 2025-12-12: Tuplet číslo (3/4/5...) se zobrazuje nad/pod beam skupinou, beam směry berou uložený stemDir a vícenásobné trámce mají druhý pruh poloviční tloušťky.
- 2025-12-12: Zmenšení velikosti not (~20 % přes výchozí scale 0.8); tuplet čísla větší (21 px) a v základní barvě ink.
- 2025-12-12: Taktové čáry mají základní barvu, jsou oříznuté na výšku osnovy a finální čára je dvojitá (ukončovací).
- 2025-12-12: Trámce pro nožky dolů posunuty blíž k hlavičkám; opravena propagace směru stonku pro beam; takt prodloužen o rezervu pro ukončovací dvojitou čáru.
- 2025-12-12: Sjednocená základní barva (ink) pro staff/ledger/předznamenání/klíč (clef fill nastaven na ink, muted odstín vypnut).
- 2025-12-12: Metr posunut výš (startY = bottomY - 2.5*lineGap, gap ~1.05*lineGap), aby byl uprostřed osnovy; taktové čáry zkrácené o jednu linku.
- 2025-12-12: Předznamenání v labu má standardní pozice pro houslový i basový klíč (větší symboly, sjednocená barva).
- 2025-12-12: Metr se centruje podle vyhrazeného prostoru (sigSpace + meterSpace + gap), takže bez předznamenání není odskočený daleko za klíčem.
- 2025-12-12: Přepínač v labu pro zapnutí/vypnutí podkreslených zón (debug overlay).
- 2025-12-12: Předznamenání v labu má větší symboly, sjednocenou barvu s staffColor a fixní oktávové pozice pro houslový klíč.
- 2025-12-12: Posuvky u not mají vlastní rezervu šířky a offset (x i y), jsou větší a v módu „předznamenání“ se nevykreslují (showAccidentals=false). V modu posuvek se už nealokuje prostor pro předznamenání, aby se nepřetahoval s metrem. Beam skupiny používají jednotný směr nožek podle první noty v beamu, takže trámec se neláme opačnými směry. Rezerva pro posuvky používá jednotnou pomocnou funkci (vizuální jednotky i px v renderu) a dá se omezit na “forced” režim; jednotlivé noty mohou vynutit zobrazení posuvky i v režimu předznamenání (note.meta.forceAccidental). Výchozí režim stonku u obecného renderu je „none“, pokud není výslovně potřeba (beam/flags nebo defaultStem:'auto'). Finální dvojitá čára se kreslí jen při explicitním `finalBar:true`.
- 2025-12-12: Vertikální offset předznamenání je oddělený pro křížky/béčka (samostatné laditelné hodnoty v drawSignatureMarksLab).
- 2025-12-06: Další trasování leadingSpace (loguje se i vstupní hodnota options.leadingSpace), abychom odhalili, proč zůstává 0; fallback 72/44 px pro ukázku.
- 2025-12-06: Renderer staffu má debug výpis souřadnic (clef, první nota, šířka) při zapnutém debugLayout/debugPositions, takže lze rychle ladit odsazení.
- 2025-12-06: Vykreslování staffu má parametr leadingSpace, signature/meter už mají vlastní rezervu (žádné prolínání), taktová čára se zarovnává správně a metrum je psáno pod sebou; finální lišta na konci druhého taktu.
- 2025-12-06: Ukázky „Posuvky vs. předznamenání“ mají vlastní přehrávací tlačítka, dvoutaktové zápisy s metrem 4/4 a barovou čárou; posuvka platí jen v prvním taktu, předznamenání v obou.
- 2025-12-06: Blok „Posuvky vs. předznamenání“ je pod sebou (grid 1 sloupec), takže texty neujíždějí na šířku.
- 2025-12-06: Klaviatura má nový pressed efekt pro aktivní klávesu (inset stín, minimální posun dolů místo přizvednutí).
- 2025-12-06: Vyhozené nepoužívané i18n klíče pro poznámku u „řady tónů“ (reading_acc_scale_help).
- 2025-12-06: Stupnicová ukázka přejmenovaná na řadu tónů (texty + tlačítka) s poznámkou, že zachovává intervalový vzorec, ale ne vždy odpovídá reálné durové stupnici.
- 2025-12-06: Chromatická ukázka je v užším panelu (max-width 660px) se zvětšeným vertikálním gapem mezi přepínači, staffem a tlačítkem.
- 2025-12-06: Chromatická ukázka má společný panel pro přepínače, staff i přehrání (zarovnané stejně jako stupnicová ukázka) a větší gap not.
- 2025-12-06: Chromatická ukázka má zúžený kontejner (max-width 660px + centrovaný SVG jako u stupnic) a větší gap mezi notami.
- 2025-12-06: Chromatická ukázka zobrazení půltónů má užší osovou oblast (max-width 460px) a větší rozestup not pro lepší čitelnost.
- 2025-12-06: Doplněný gap a flex i u přepínačů křížkový/béčkový zápis ve stupnicové ukázce a klaviatuře, aby měly stejný rozestup jako v bloku Zobrazení půltónů.
- 2025-12-06: Stupnicová ukázka „Stejná řada v různých výškách“ zvětšená (šířka panelu/SVG + větší mezery mezi notami) pro lepší čitelnost.
- 2025-12-06: Úpravy layoutu osnov (tight/debug) a finální dorovnání přirozené řady (bez posunu nahoru).
- 2025-12-06: Zmenšený náhled transpoziční stupnice (fixní max-width, menší SVG), aby na desktopu nezabíral celou šířku a na mobilu zůstal pružný.
- 2025-12-06: Nová transpoziční ukázka durové řady v sekci posuvek (přehrání, posun o půltón, sdílený přepínač křížky/béčka) mezi půltónovou osnovou a klaviaturou.
- 2025-12-04: Rozšířený text k posuvkám (výslovnost, enharmonika, příklady půltónů a přirozených půltónů) v sekci „Co jsou posuvky?“ + větší podnadpisy, vrácená ukázka „Jak funguje půltón“, sjednocené barvy not/linek přes skin, opravené escapování textu a anglické čtení (sharp/flat) u posuvek + zmenšená osnova a klaviatura se standardními barvami kláves (bílé s černým okrajem, černé s bílým písmem) a černými klávesami mezi bílými; klaviatura používá sdílený modul a má přepínač křížkový/béčkový zápis.
- 2025-12-03: Teorie posuvek má plný obsah podle Křížky.docx – nové texty, interaktivní půltóny, přepínání křížky/béčka, klaviatura, enharmonické dvojice i ukázka předznamenání vs. posuvky.
- 2025-12-02: Navigace restrukturalizovaná na „Hudební základy, Stupnice a tóniny, Intervaly, Akordy, Harmonie a Improvizace“, doplněné placeholdry s anotacemi a štítky „Připravujeme“ pro nové nebo přesunuté stránky.
- 2025-12-02: Intervaly a Akordy mají detailní podstránky s dlaždicemi a placeholdery včetně anotací, vše označeno štítkem „Připravujeme“.
- 2025-12-02: „Čtení rytmu“ zkracuje hlavní i shrnující osnovu přibližně o čtvrtinu, takže se škálují větší a čitelnější v rámci karty.
- 2025-12-02: Výsledné osnovy „Čtení rytmu“ se v průběhu i shrnutí přizpůsobují šířce karty, takže na užších obrazovkách nepřetékají mimo okraj.
- 2025-12-02: Teorie posuvek („Křížky, béčka a spol.“) má plný obsah: půltóny s ukázkami, typy posuvek, rozdíl posuvky/předznamenání, enharmonické dvojice a interaktivní klaviaturu.
- 2025-11-20: Ikonová paleta rytmu má dvojnásobně velké miniatury (SVG se škáluje uvnitř původního tlačítka), takže symboly not/pomlk vizuálně zaplní celý chip bez zvětšení tlačítka.
- 2025-11-20: Paleta „Doplň rytmus“ používá miniatury not/pomlk z `App.rhythmShapes`, tlačítka mají pouze ikonky a pořadí hodnot se pro každou úlohu zamíchá.
- 2025-11-20: Nabídka rytmického cvičení už netřídí noty/pomlky; vždy ukáže všech pět délek, u každé náhodně zvolí notu nebo pomlku a nechá je v jedné zamíchané řadě.
- 2025-11-20: Shrnutí „Doplň rytmus“ má tradiční donut graf s počtem správných/špatných taktů a slovní hodnocení.
- 2025-11-20: V nastavení „Doplň rytmus“ jsme odstranili vnořené karty, takže popisky i čipy sedí na stejné levé linii jako tlačítko Spustit cvičení.
- 2025-11-20: CSS blok pro „Doplň rytmus“ je mimo mobilní media dotaz, takže gap čipů funguje i na desktopu.
- 2025-11-20: Nastavení „Doplň rytmus“ má kartu i grid stažené na plnou šířku, takže všechny popisky i čipy drží levou hranu stejně jako tlačítko Spustit cvičení.
- 2025-11-20: Výběrové čipy ve „Doplň rytmus“ (počty, metrum i paleta) používají stejný gap a min. šířku jako ostatní cvičení, takže tlačítka nejsou nalepená.
- 2025-11-19: Cvičení „Doplň rytmus“ má přepracované rozvržení osnovy – klíč + metrum sedí na začátku, zmizely taktové čáry, spacing not/pomlk je dynamický podle délky i počtu prvků (vejde se i přeplnění) a stejné nastavení používá i shrnutí.
- 2025-11-19: V teoretických ukázkách rytmu (meter cards) se klíč i zápis metra kreslí přes `App.rhythmShapes`, takže vzhled odpovídá procvičovací části a nevzniká duplicitní SVG kód.
- 2025-11-19: Sdílené vykreslovací utility `App.rhythmShapes` používá i teoretická sekce rytmu – všechny noty, pomlky, houslový klíč i zápis metra se kreslí jedním kódem (bez duplicit), takže nové cvičení Doplň rytmus i původní teorie zůstávají vizuálně identické; opravená definice čtvrťové pomlky a helper teď znovu exportuje všechny funkce (klíč, metrum, tvary).
- 2025-11-18: Nové cvičení „Doplň rytmus“ (Complete the bar) nahrazuje placeholder rytmického čtení: sdílené notové tvary z teoretické sekce (stejný houslový klíč i zápis metra), dlaždice v hubu, výběr počtu otázek a metra, generování částečně vyplněných taktů, paleta not/pomlk, možnost takt přeplnit, reset, postupné otázky a finální shrnutí; doplněny i18n klíče (cs/en).
- 2025-11-18: Sekce o pentatonice nově vysvětluje, jak funguje blue note (cs/en), proč rozšiřuje mollovou pentatoniku a jak se používá v praxi.
- 2025-11-18: Z průběhu testů „Sestav stupnici“, „Poznej tóninu“ a „Urči tóninu v kruhu“ zmizela průběžná tlačítka „Vyhodnotit“ – hodnotí se až v závěrečném shrnutí.
- 2025-11-18: Do výběru „Sestav stupnici“ přibyl vysvětlující text, aby bylo jasné, že se vybrané kombinace v testu losují náhodně (cs/en i18n).
- 2025-11-18: `rhythm-tuplets-pulse` a navazující hero řádky už nepřetékají mimo kartu – gridy mají `min-width:0`, lane obsah se smí zúžit a kontejner přidává `overflow:hidden`.
- 2025-11-18: Slider „Nastav tempo“ na mobilech znovu přepisuje hodnotu BPM v nadpisu (fallback `change` + hlídání odpojeného `<span id="tempo-bpm-label">`).
- 2025-11-18: Sekce „Jak to poznat a číst“ má nový sloupcový layout – rovné dělení je nahoře, pod ním dělený rytmus a ovládání Play je vždy dole.
- 2025-11-12: Přidaná sekce „Tempo“ s vysvětlením BPM, dynamickým přepočtem délek a interaktivní ukázkou šesti osmin.
- 2025-11-12: Složená metra mají mini notovou osnovu s klíčem, taktovým označením a šesti osminami (3/4 vs. 6/8) + přímé přehrávání akcentů ze stejných dat jako „Vyzkoušej, jak zní různá metra“.
- 2025-11-12: Nadpis „Dělené rytmy – trioly, kvartoly, kvintoly“ je přímo v kartě a text už není zapuštěný v extra rámečku; vzhled ladí s blokem „Vázání not“.
- 2025-11-12: Sekce „Dělené rytmy“ sdílí stejné pozadí jako „Vázání not“, takže oba bloky vypadají jednotně napříč motivy.
- 2025-11-12: Ze sekce „Dělené rytmy“ zmizel blok s časovou osou trioly a trojicí tlačítek, včetně souvisejících překladů a JS.
- 2025-11-10: Sekce „Dělené rytmy“ má nový layout s hero pulzy, vysvětlující tabulkou, interaktivními ukázkami (triola/kvartola/kvintola), porovnáním 2/3/4/5 úderů a dvěma audio demo; doplněny styly, JS logika a i18n pro cs/en.
- 2025-11-10: Zmizely bloky „Interaktivní příklady taktů“, „Rytmické slabiky“
  a „Shrnutí délek“; tuplet demo je součástí sekce Tečka a vázání not a kód
  kolem minikaret/patternů byl vyčištěn (jen hlavní osnova zůstává přehrávací).
- 2025-11-10: Doplněná dokumentace k `METER_CARDS` (hinty pro zápis taktů),
  přejmenované příklady 6/8 („Dvakrát dvojice osmin a pomlka“, „Dvě čtvrťové
  s tečkou“) včetně nových i18n klíčů.
- 2025-11-09: Přidána připomínka v systémovém promptu, že před každým úkolem je
  nutné načíst aktuální strukturu souboru.
- 2025-11-09: Upravena osnova v sekci „Takt a metrum“ – noty jsou o 20 % menší,
  poslední osmina v paprsku dostává větší mezeru, houslový klíč i číselné
  označení taktu (např. 3/4, 6/8) mají vyhrazený prostor mimo první takt,
  akcenty (úrovně 0–3) se propisují do přehrávání (silnější hlasitost/delší
  obálka u důrazů) a pomlky se při přehrávání opravdu chovají jako ticho.
- 2025-11-06: Opravená reference basového klíče ve sdíleném rendereru (správná linka pro testy Najdi/Zapiš tón), sjednocené shrnutí Najdi/Zapiš tón (stejný layout, barevné oddělení odpovědí) a nová teoretická stránka „Rytmus a délky not“ s interaktivními ukázkami (noty, pomlky, takt, rytmické kombinace, shrnující tabulka).
- 2025-11-03: Detail stupnic – doplněné závěrečné tóny u všech modálních variant (přirozená/harmonická/melodická moll + diatonická osnova), zmenšený a centrovaný náhled stupnice, menší mezery a posun posuvek; mobilní layout s redukovanými okraji.
- 2025-11-08: Sekce s přehráváním meter cardů má vlastní list-card rámeček +
  nadpis a podnadpis (Vyzkoušej, jak zní různá metra).
- 2025-11-08: Dokončené texty i18n pro sekci „Takt a metrum“ (cs/en podle finálního zadání) + nová přepínatelná osnova s příklady taktů (tlačítka metrů, seznam ukázek, přehrání vybraného taktu/sekvence), sjednocené popisy interaktivních příkladů, chybějící klíče pro vysvětlivky zápisu metra, odstraněné nepoužívané tlačítko Poslech a prázdné tipy a opravené HTML atributy v seznamu s horním/dolním číslem taktu.
- 2025-11-06: Zarovnání ilustrace „Stavba noty“ s legendou na stránce Rytmus a odstraněná mezera před vysvětlujícím textem; spojené sekce „Vzhled not“ a „Spojování not“ do bloku „Noty v notové osnově“ se dvěma paralelními kartami a rozšířenými popisky (subtitulek + poznámka); sjednocená sekce „Délky not“ (osnovy, bez nožky u celé noty s jednotnou hlavičkou, adaptivní mřížka karet i pro pomlky, viditelné orámování napříč skiny, korektní překlady při přepnutí jazyka a fix mobilního přesahu bloků + kompaktnější padding, menší ilustraci „Stavba noty“, rozšířenou sekci „Tečka a vázání not“ se dvěma podbloky, novými texty a SVG, upravené rozestupy v kvintovém kruhu a kompletní rework bloku „Takt a metrum“ (teoretický úvod, zápis metra, tabulka, interaktivní karty 2/4–6/8 i porovnání 3/4 vs. 6/8 s přehráním)).
- 2025-11-02: „Zapiš tón“ – pod každým sloupcem se zobrazuje zadání tónu, aktivní sloupec se zvýrazní, odstraněna duplicitní zelená hláška pod osnovou, opravená hláška po dokončení a sjednocené duplicitní značky not. Sdílené helpery not (`noteDef`, `noteFromId`, `cloneNote`) jsou nově v `App.staffRenderer` a využívají je Najdi tón i Zapiš tón. Navigační huby na mobilech mají taby Teorie/Procvičování s ikonami, jedním sloupcem kompaktních karet (85 % šířky) a bez mezititulků mezi tlačítky a dlaždicemi. Omezena vertikální interakční zóna zápisu not na výšku skutečné osnovy, takže horizontální posun zůstává dostupný pod ní.
- 2025-11-01: Přesné české značení tónů (c1, h, a1), zvětšené popisky pod osnovou, jemnější drag oblast a stabilní scroll při úpravě.
- 2025-10-31: Vyčištěná interaktivní osnova pro test „Zapiš tón“ (omezené touch zóny podle pomocných linek, spolehlivý drag na mobilech, menší vertikální mezery, aktualizované texty).
- 2024-11-03: Vylepšení sdíleného slideru pro rozsah (klávesové focus zvýraznění, lepší aria popisky s přepínáním jazyka, odsazené krajní palce v mobilním zobrazení, čištění kódu v Najdi/Zapiš tón) a kosmetické úpravy stylu.
- 2024-10-31: Oprava konfigurace testu Najdi tón – převod identifikátorů s písmenem „H“ na notu B při generování rozsahu (a stejný parser i pro Zapiš tón), aby se znovu zobrazily odpovědní chipy napříč všemi klíči.
- 2024-10-30: Obnovený sdílený modul `App.staffRenderer` (univerzální kreslení osnovy), refaktor testu Najdi tón na jeho využití, rozšířené shrnutí testu a nová notová osnova s přepínačem variant ve detailu stupnice + spuštěno cvičení „Zapiš tón“ (konfigurace rozsahu/klíče, plně manuální režim s tlačítkem Vyhodnotit, interaktivní zápis noty, skrytí zadávaných not do potvrzení, zadání pod osnovou, vyhodnocení s grafem a širší osnovou, upravená responsivita a touch ovládání pro mobilní drag).
- 2024-10-28: doplnění obsahu „Co všechno najdeme v notové osnově?“, nová vizualizace not na lince/mezere, odstranění CTA a ladění responsivity (barva zvýraznění, paddingy, délky linek) + úvodní texty pro stránky Oktávy, Kvintový kruh a spuštění interaktivního cvičení Najdi tón (dynamické rozsahy, posuvky, vyhodnocení + oddělené fáze testu do samostatných stránek, zvýraznění právě řešené noty barvou správné odpovědi, plná barva osnovy/klíče, volitelný časovač s automatickým postihováním, přepracované shrnutí s širší osnovou pod grafem, motivační hláškou a badge, automatické vyhodnocení po poslední odpovědi a reset testu při návratu na dlaždice).
- 2024-10-26: sjednocení zvýraznění stránky Notová osnova (accent barva, shodné paddingy, fix délky linek na mobilech) a lokalizace kvintového kruhu podle jazyka. Opraveno vykreslování klíčů.
- 2024-10-25: přidána první verze stránky notová osnova, opravy překladů H/B
- 2024-10-24: opravy odsazení stupnic a kvintových kruhů v responzivním zobrazení,
- 2025-10-23: vizuální opravy oktáv, zobrazení popisků pod tóny, optimalizace dlaždic, optimalizace klíčů, oprava identifikace oktáv, popisky not ve formátu oktávy
- 2025-10-22: domovské dlaždice Dynamika + Hudební výrazy včetně ikon, skin tokenů, i18n a placeholder sekcí; nová teoretická stránka „Tóny v notové osnově“ (oktávová mapa) + dlaždice Artikulace, Rytmické značky a Navigace v notách; klíče přesunuty do SVG knihovny (`basic-clef-treble`, `basic-clef-bass`) a integrovány do rendereru.
- 2025-10-21: sjednocení kruhového kvízu s ostatními (toolbar, odložené vyhodnocení, shrnutí přes eval-karty, reset stavu po návratu) + čistý start kvízu Poznej tóninu; nová domovská dlaždice Akordy (ikona, placeholder), rozpracovaná sekce Noty (teorie + procvičování s dlaždicemi) a fix viewBoxu ikony intervalů.
- 2025-10-20: refaktor zvýraznění kruhového kvízu (shared createCircleModule s volitelným fill/stroke), nové proměnné skinu pro kruh a ikonka `basic-ksquiz`.
- 2025-10-19: bez zaznamenaných úprav.

[ToDo]
ß

===============================================================================
-->



<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>TonIQa v1.10.63</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Cuse href='%23basic-logo-toniqa'/%3E%3C/svg%3E" type="image/svg+xml" />
<style>
/* v5.8.10 — DRY home tile gradients via CSS vars */
.card-tile.home-blue,
.card-tile.home-green,
.card-tile.home-amber,
.card-tile.home-cyan,
.card-tile.home-violet,
.card-tile.home-ivory,
.card-tile.home-circlequiz,
.card-tile.home-chords,
.card-tile.home-dynamics,
.card-tile.home-expressions,
.card-tile.reading-theory-staff,
.card-tile.reading-theory-notes,
.card-tile.reading-theory-rhythm,
.card-tile.reading-theory-acc,
.card-tile.reading-theory-articulation,
.card-tile.reading-theory-marks,
.card-tile.reading-theory-navigation,
.card-tile.reading-find,
.card-tile.reading-place,
.card-tile.reading-rhythm,
.card-tile.reading-dynamics,
.card-tile.reading-expressions,
.card-tile.reading-clef,
.card-tile.reading-acc{
  background: linear-gradient(135deg, var(--tile-from) 0%, var(--tile-to) 100%);
  border: 1px solid var(--tile-bd, rgba(255,255,255,.08));
}
</style>
<style id="themes-skin">
/* =========================
   THEME TOKENS (skins)
   ========================= */
:root[data-theme="midnight"]{
  /* --- Core surfaces & text --- */
  --bg:#0b1020; --bg-gradient:#0f172a; --card:#111836; --surface:#0b1229;
  --ink:#e5e7eb; --muted:#94a3b8;
  --accent:#22c55e; --accent-ink:#062b13;

  /* --- Evaluation colors --- */
  --ok-bg: rgba(34,197,94,.10);  --ok-bd: rgba(34,197,94,.35);  --ok-ink:#34d399;
  --bad-bg:rgba(239,68,68,.10);  --bad-bd:rgba(239,68,68,.35);  --bad-ink:#f87171;

  /* --- Buttons --- */
  --btn-green-bg:#22c55e; --btn-green-ink:#08210f;
  --btn-cyan-bg:#0891b2;  --btn-cyan-ink:#06252c;
  --btn-violet-bg:#7c3aed;--btn-violet-ink:#12052c;
  --btn-amber-bg:#f59e0b; --btn-amber-ink:#1b1302;
  --btn-ghost-bd:rgba(255,255,255,.15);

  /* --- Brand & tiles --- */
  --brand-ring:rgba(255,255,255,.25);
  --brand-primary:#22c55e;
  --brand-secondary:rgba(255,255,255,.6);
  --tile-frame:rgba(255,255,255,.08);
  --tile-title-ink:#f8fafc;
  --tile-sub-ink:#e5e7eb;
  --tile-title-shadow:0 1px 2px rgba(0,0,0,.25);
  --tile-sub-shadow:0 1px 2px rgba(0,0,0,.25);

  /* --- Elevations (cards, tables, badges) --- */
  --card-border:rgba(255,255,255,.07);
  --card-shadow:0 10px 30px rgba(0,0,0,.35);
  --table-border:rgba(255,255,255,.08);
  --table-head-bg:rgba(255,255,255,.03);
  --table-row-border:rgba(255,255,255,.06);
  --badge-bg:rgba(255,255,255,.06);
  --badge-border:rgba(255,255,255,.1);
  --list-border:rgba(255,255,255,.08);
  --metric-border:rgba(255,255,255,.08);
  --section-padding:clamp(16px,4vw,28px);

  /* --- Circle trainer --- */
  --circle-node-fill:#0b1229;
  --circle-node-minor-fill:#131b33;
  --circle-node-stroke:rgba(255,255,255,.35);
  --circle-node-ink:#e5e7eb;
  --circle-node-on-stroke:var(--select-on-border);
  --circle-symbol-sharp:#93c5fd;
  --circle-symbol-flat:#fca5a5;
  --circq-panel-border:rgba(34,197,94,.35);
  --circq-panel-bg-top:rgba(34,197,94,.08);
  --circq-panel-bg-bottom:rgba(34,197,94,.02);
  --circq-panel-shadow:0 8px 26px rgba(0,0,0,.25);

  /* --- Selectors & chips --- */
  --select-border:rgba(255,255,255,.08);
  --select-on-border:#22c55e;
  --select-on-bg:rgba(34,197,94,.18);

  --chip-border:rgba(255,255,255,.18);
  --chip-bg:transparent;
  --chip-ink:var(--ink);
  --chip-on-border:#22c55e;
  --chip-on-bg:rgba(34,197,94,.22);
  --chip-on-ink:#d1fae5;

  /* tile tokens fallback */
  --tile-dynamics-from:#1c284d;
  --tile-dynamics-to:#f97316;
  --tile-dynamics-bd:rgba(249,115,22,.45);
  --tile-expressions-from:#2b1e4d;
  --tile-expressions-to:#ec4899;
  --tile-expressions-bd:rgba(236,72,153,.48);
  --tile-reading-theory-articulation-from:#12395a;
  --tile-reading-theory-articulation-to:#38bdf8;
  --tile-reading-theory-articulation-bd:rgba(56,189,248,.45);
  --tile-reading-theory-marks-from:#4a1f0f;
  --tile-reading-theory-marks-to:#f97316;
  --tile-reading-theory-marks-bd:rgba(249,115,22,.45);
  --tile-reading-theory-navigation-from:#2b1a51;
  --tile-reading-theory-navigation-to:#8b5cf6;
  --tile-reading-theory-navigation-bd:rgba(139,92,246,.45);

  /* --- Tile gradients --- */
  --tile-blue-from:#1e3a8a;  --tile-blue-to:#3b82f6;  --tile-blue-bd:rgba(96,165,250,.45);
  --tile-green-from:#0f3f66; --tile-green-to:#38bdf8; --tile-green-bd:rgba(125,211,252,.40);
  --tile-amber-from:#1f2a44; --tile-amber-to:#4f46e5; --tile-amber-bd:rgba(129,140,248,.38);
  --tile-cyan-from:var(--tile-green-from);  --tile-cyan-to:var(--tile-green-to);  --tile-cyan-bd:var(--tile-green-bd);
  --tile-violet-from:#1c2759;--tile-violet-to:#2f2f4b;--tile-violet-bd:rgba(129,140,248,.40);
  --tile-ivory-from:#172347; --tile-ivory-to:#454b60; --tile-ivory-bd:rgba(148,163,184,.40);
  --tile-circlequiz-from:#1d2f73; --tile-circlequiz-to:#4338ca; --tile-circlequiz-bd:rgba(99,102,241,.55);
  --tile-chords-from:#172b46; --tile-chords-to:#8b5cf6; --tile-chords-bd:rgba(139,92,246,.42);
  --tile-dynamics-from:#1c284d; --tile-dynamics-to:#f97316; --tile-dynamics-bd:rgba(249,115,22,.48);
  --tile-expressions-from:#2b1e4d; --tile-expressions-to:#ec4899; --tile-expressions-bd:rgba(236,72,153,.48);
  --tile-reading-find-from:#0b4f6c; --tile-reading-find-to:#14b8a6; --tile-reading-find-bd:rgba(20,184,166,.45);
  --tile-reading-place-from:#2f2a8b; --tile-reading-place-to:#6366f1; --tile-reading-place-bd:rgba(99,102,241,.45);
  --tile-reading-rhythm-from:#7a3410; --tile-reading-rhythm-to:#f97316; --tile-reading-rhythm-bd:rgba(249,115,22,.45);
  --tile-reading-clef-from:#0f2345; --tile-reading-clef-to:#3b82f6; --tile-reading-clef-bd:rgba(59,130,246,.45);
  --tile-reading-acc-from:#6b0f5f; --tile-reading-acc-to:#f472b6; --tile-reading-acc-bd:rgba(244,114,182,.45);
  --tile-reading-theory-staff-from:#0e1f3a; --tile-reading-theory-staff-to:#2563eb; --tile-reading-theory-staff-bd:rgba(59,130,246,.45);
  --tile-reading-theory-notes-from:#1f2c4a; --tile-reading-theory-notes-to:#6366f1; --tile-reading-theory-notes-bd:rgba(99,102,241,.45);
  --tile-reading-theory-rhythm-from:#2f223d; --tile-reading-theory-rhythm-to:#a855f7; --tile-reading-theory-rhythm-bd:rgba(168,85,247,.45);
  --tile-reading-theory-acc-from:#351a2a; --tile-reading-theory-acc-to:#f472b6; --tile-reading-theory-acc-bd:rgba(244,114,182,.45);
  --tile-reading-theory-articulation-from:#12395a; --tile-reading-theory-articulation-to:#38bdf8; --tile-reading-theory-articulation-bd:rgba(56,189,248,.48);
  --tile-reading-theory-marks-from:#4a1f0f; --tile-reading-theory-marks-to:#f97316; --tile-reading-theory-marks-bd:rgba(249,115,22,.48);
  --tile-reading-theory-navigation-from:#2b1a51; --tile-reading-theory-navigation-to:#8b5cf6; --tile-reading-theory-navigation-bd:rgba(139,92,246,.50);
  --tile-reading-dynamics-from:#123524; --tile-reading-dynamics-to:#22c55e; --tile-reading-dynamics-bd:rgba(34,197,94,.45);
  --tile-reading-expressions-from:#3a1f4a; --tile-reading-expressions-to:#f472b6; --tile-reading-expressions-bd:rgba(244,114,182,.48);

  --tile-ksquiz-from:#123851;
  --tile-ksquiz-to:#2563eb;
  --tile-ksquiz-bd:rgba(96,165,250,.38);

  /* --- Donut charts --- */
  --chart-bg:#1f2937; --chart-ok:#22c55e; --chart-warn:#f59e0b; --chart-bad:#ef4444;

  /* --- Circle background ring --- */
  --ring-fill:#0b1229; --ring-stroke:rgba(255,255,255,.08);
}
:root[data-theme="aurora"]{
  /* AURORA (Sunrise) — warm magenta + cool cyan contrast */
  /* --- Core surfaces & text --- */
  --bg:#1b0f2a; --bg-gradient:#12071f;           /* deep plum */
  --card:#24123a;          /* plum-ink card */
  --surface:#1d1033;       /* darker surface */
  --ink:#fff7f9;           /* near-white with warm tint */
  --muted:#f5c2e7;         /* soft pink-lilac for secondary text */
  --accent:#f472b6;        /* pink accent */
  --accent-ink:#290916;    /* dark ink on accent */

  /* --- Evaluation colors --- */
  --ok-bg: rgba(56,189,248,.16);   /* sky */
  --ok-bd: rgba(56,189,248,.42);
  --ok-ink:#7dd3fc;

  --bad-bg: rgba(244,114,182,.16); /* rose/pink */
  --bad-bd: rgba(244,114,182,.42);
  --bad-ink:#f9a8d4;

  /* --- Buttons --- */
  --btn-green-bg:#f472b6;  /* primary now pink */
  --btn-green-ink:#2a0a15;

  --btn-cyan-bg:#fb923c;   /* orange */
  --btn-cyan-ink:#2d1603;

  --btn-violet-bg:#38bdf8; /* sky */
  --btn-violet-ink:#06222b;

  --btn-amber-bg:#a3e635;  /* lime */
  --btn-amber-ink:#0e1a04;

  --btn-ghost-bd:rgba(255,255,255,.30); /* stronger ghost borders */

  /* --- Brand & tiles --- */
  --brand-ring:rgba(244,114,182,.50);
  --brand-primary:#f472b6;
  --brand-secondary:rgba(56,189,248,.70);

  --tile-frame:rgba(244,114,182,.35);
  --tile-title-ink:#fff7f9;
  --tile-sub-ink:#f5c2e7;
  --tile-title-shadow:0 1px 3px rgba(14,6,32,.5);
  --tile-sub-shadow:0 1px 2px rgba(14,6,32,.35);

  /* --- Elevations (cards, tables, badges) --- */
  --card-border:rgba(244,114,182,.35);
  --card-shadow:0 18px 36px rgba(14,6,32,.55);
  --table-border:rgba(244,114,182,.32);
  --table-head-bg:rgba(244,114,182,.18);
  --table-row-border:rgba(244,114,182,.20);
  --badge-bg:rgba(244,114,182,.22);
  --badge-border:rgba(244,114,182,.36);
  --list-border:rgba(244,114,182,.35);
  --metric-border:rgba(244,114,182,.32);

  /* --- Circle trainer --- */
  --circle-node-fill:#22103a;
  --circle-node-minor-fill:#2c1548;
  --circle-node-stroke:rgba(244,114,182,.45);
  --circle-node-ink:#ffe4f3;
  --circle-node-on-stroke:var(--select-on-border);
  --circle-node-on-fill:rgba(244,114,182,.24);
  --circle-node-on-fill-minor:rgba(244,114,182,.32);
  --circle-symbol-sharp:#38bdf8;
  --circle-symbol-flat:#fb7185;
  --circq-panel-border:rgba(244,114,182,.52);
  --circq-panel-bg-top:rgba(244,114,182,.22);
  --circq-panel-bg-bottom:rgba(56,189,248,.16);
  --circq-panel-shadow:0 12px 32px rgba(15,12,32,.55);

  /* --- Selectors & chips --- */
  --select-border:rgba(244,114,182,.32);
  --select-on-border:#38bdf8;
  --select-on-bg:rgba(56,189,248,.22);

  --chip-border:rgba(244,114,182,.45);
  --chip-bg:transparent;
  --chip-ink:var(--ink);
  --chip-on-border:#38bdf8;
  --chip-on-bg:rgba(56,189,248,.26);
  --chip-on-ink:#e0f2fe;

  /* --- Tile gradients --- */
  --tile-blue-from:#6d28d9;   /* violet → pink */
  --tile-blue-to:#f472b6;
  --tile-blue-bd:rgba(244,114,182,.55);

  --tile-green-from:#0ea5e9;  /* sky → cyan */
  --tile-green-to:#22d3ee;
  --tile-green-bd:rgba(125,211,252,.55);

  --tile-amber-from:#f43f5e;  /* rose → amber */
  --tile-amber-to:#f59e0b;
  --tile-amber-bd:rgba(251,191,36,.58);

  --tile-cyan-from:#10b981;   /* emerald → lime */
  --tile-cyan-to:#a3e635;
  --tile-cyan-bd:rgba(163,230,53,.55);

  --tile-violet-from:#9333ea; /* violet → fuchsia */
  --tile-violet-to:#e879f9;
  --tile-violet-bd:rgba(232,121,249,.55);
  --tile-ivory-from:#f5853a;
  --tile-ivory-to:#f39a5f;;
  --tile-ivory-bd:rgba(247, 207, 85, 0.45);
  --tile-circlequiz-from:#ec4899; /* magenta → cyan */
  --tile-circlequiz-to:#f3a8cd;
  --tile-circlequiz-bd:rgba(191, 56, 248, 0.55);
  --tile-chords-from:#4c1d95;
  --tile-chords-to:#c084fc;
  --tile-chords-bd:rgba(192,132,252,.55);
  --tile-dynamics-from:#f97316;
  --tile-dynamics-to:#facc15;
  --tile-dynamics-bd:rgba(250,204,21,.58);
  --tile-expressions-from:#a855f7;
  --tile-expressions-to:#f472b6;
  --tile-expressions-bd:rgba(244,114,182,.58);
  --tile-reading-find-from:#0284c7;
  --tile-reading-find-to:#22d3ee;
  --tile-reading-find-bd:rgba(34,211,238,.55);
  --tile-reading-place-from:#7c3aed;
  --tile-reading-place-to:#a855f7;
  --tile-reading-place-bd:rgba(168,85,247,.55);
  --tile-reading-rhythm-from:#c2410c;
  --tile-reading-rhythm-to:#f97316;
  --tile-reading-rhythm-bd:rgba(249,115,22,.55);
  --tile-reading-clef-from:#312e81;
  --tile-reading-clef-to:#6366f1;
  --tile-reading-clef-bd:rgba(99,102,241,.55);
  --tile-reading-acc-from:#9d174d;
  --tile-reading-acc-to:#f472b6;
  --tile-reading-acc-bd:rgba(244,114,182,.58);
  --tile-reading-theory-staff-from:#1e293b;
  --tile-reading-theory-staff-to:#3b82f6;
  --tile-reading-theory-staff-bd:rgba(59,130,246,.55);
  --tile-reading-theory-notes-from:#312e81;
  --tile-reading-theory-notes-to:#8b5cf6;
  --tile-reading-theory-notes-bd:rgba(139,92,246,.55);
  --tile-reading-theory-rhythm-from:#4b1d57;
  --tile-reading-theory-rhythm-to:#c084fc;
  --tile-reading-theory-rhythm-bd:rgba(192,132,252,.55);
  --tile-reading-theory-acc-from:#5f1239;
  --tile-reading-theory-acc-to:#f472b6;
  --tile-reading-theory-acc-bd:rgba(244,114,182,.58);
  --tile-reading-theory-articulation-from:#2563eb;
  --tile-reading-theory-articulation-to:#38bdf8;
  --tile-reading-theory-articulation-bd:rgba(56,189,248,.58);
  --tile-reading-theory-marks-from:#f97316;
  --tile-reading-theory-marks-to:#facc15;
  --tile-reading-theory-marks-bd:rgba(250,204,21,.58);
  --tile-reading-theory-navigation-from:#a855f7;
  --tile-reading-theory-navigation-to:#f472b6;
  --tile-reading-theory-navigation-bd:rgba(244,114,182,.58);
  --tile-reading-dynamics-from:#0f766e;
  --tile-reading-dynamics-to:#22d3ee;
  --tile-reading-dynamics-bd:rgba(34,211,238,.55);
  --tile-reading-expressions-from:#6b21a8;
  --tile-reading-expressions-to:#ec4899;
  --tile-reading-expressions-bd:rgba(236,72,153,.58);

  /* --- Tile overrides --- */
  --tile-ksquiz-from:var(--tile-green-from);
  --tile-ksquiz-to:var(--tile-green-from);
  --tile-ksquiz-bd:var(--tile-green-bd);

  /* --- Donut charts --- */
  --chart-bg:#2a1b45;
  --chart-ok:#38bdf8;    /* sky */
  --chart-warn:#a3e635;  /* lime */
  --chart-bad:#f472b6;   /* rose */

  /* --- Circle background ring --- */
  --ring-fill:#160b2c;
  --ring-stroke:rgba(255,255,255,.22);
}
:root[data-theme="daylight"]{
  /* DAYLIGHT — světlý pastelový skin pro trénink za dne */
  /* --- Core surfaces & text --- */
  --bg:#fcfbfb;;
  --bg-gradient:#dad3cc;;
  --card:#fdf7f1;
  --surface:#fefaf4;
  --ink:#1e293b;
  --muted:#64748b;
  --accent:#5b6ee3;
  --accent-ink:#f5f7ff;

  /* --- Evaluation colors --- */
  --ok-bg:rgba(34,197,94,.14);
  --ok-bd:rgba(34,197,94,.32);
  --ok-ink:#15803d;

  --bad-bg:rgba(239,68,68,.14);
  --bad-bd:rgba(239,68,68,.32);
  --bad-ink:#b91c1c;

  /* --- Buttons --- */
  --btn-green-bg:#5b6ee3;
  --btn-green-ink:#fdf7f1;
  --btn-cyan-bg:#7edce2;
  --btn-cyan-ink:#0f3d47;
  --btn-violet-bg:#bfa0f6;
  --btn-violet-ink:#2f155b;
  --btn-amber-bg:#f7c38a;
  --btn-amber-ink:#4a2b04;
  --btn-ghost-bg:#fdf7f1;
  --btn-ghost-ink:#1e293b;
  --btn-ghost-bd:rgba(91,110,227,.38);

  /* --- Brand & tiles --- */
  --brand-ring:rgba(91,110,227,.32);
  --brand-primary:#5b6ee3;
  --brand-secondary:rgba(30,41,59,.42);

  --tile-frame:rgba(148,163,184,.26);
  --tile-title-ink:#1e293b;
  --tile-sub-ink:#475569;
  --tile-title-shadow:0 1px 0 rgba(255,255,255,.7);
  --tile-sub-shadow:0 1px 0 rgba(255,255,255,.55);

  /* --- Elevations (cards, tables, badges) --- */
  --card-border:rgba(148,163,184,.28);
  --card-shadow:0 18px 40px rgba(91,110,227,.14);
  --table-border:rgba(148,163,184,.32);
  --table-head-bg:rgba(91,110,227,.12);
  --table-row-border:rgba(203,213,225,.55);
  --badge-bg:rgba(91,110,227,.12);
  --badge-border:rgba(91,110,227,.26);
  --list-border:rgba(148,163,184,.28);
  --metric-border:rgba(148,163,184,.30);

  /* --- Circle trainer --- */
  --circle-node-fill:#ffffff;
  --circle-node-minor-fill:#eef1ff;
  --circle-node-stroke:rgba(91,110,227,.32);
  --circle-node-ink:#1e293b;
  --circle-node-on-stroke:var(--select-on-border);
  --circle-node-on-fill:rgba(91,110,227,.20);
  --circle-node-on-fill-minor:rgba(91,110,227,.26);
  --circle-symbol-sharp:#5b6ee3;
  --circle-symbol-flat:#f6b487;
  --circq-panel-border:rgba(91,110,227,.26);
  --circq-panel-bg-top:rgba(91,110,227,.14);
  --circq-panel-bg-bottom:rgba(165,180,252,.15);
  --circq-panel-shadow:0 16px 38px rgba(91,110,227,.16);

  /* --- Selectors & chips --- */
  --select-border:rgba(148,163,184,.32);
  --select-bg:#ffffff;
  --select-on-border:#5b6ee3;
  --select-on-bg:rgba(91,110,227,.18);

  --chip-border:rgba(148,163,184,.38);
  --chip-bg:#ffffff;
  --chip-ink:#1e293b;
  --chip-on-border:#5b6ee3;
  --chip-on-bg:rgba(91,110,227,.22);
  --chip-on-ink:#2f3c87;

  /* --- Tile gradients --- */
  --tile-blue-from:#9faae5;
  --tile-blue-to:#9faae5;
  --tile-blue-bd:rgba(105, 119, 209, 0.32);

  --tile-green-from:#aff1cf;
  --tile-green-to:#aff1cf;;
  --tile-green-bd:rgba(112,215,162,.30);

  --tile-amber-from:#f7c38a;
  --tile-amber-to:#f7c38a;
  --tile-amber-bd:rgba(249,195,138,.30);

  --tile-cyan-from:#7edce2;
  --tile-cyan-to:#7edce2;
  --tile-cyan-bd:rgba(126,220,226,.28);

  --tile-violet-from:#bfa0f6;
  --tile-violet-to:#bfa0f6;
  --tile-violet-bd:rgba(191,160,246,.30);
  --tile-ivory-from:#fef3c7;
  --tile-ivory-to:#fef3c7;
  --tile-ivory-bd:rgba(251,191,36,.35);
  --tile-circlequiz-from:#fb923c;
  --tile-circlequiz-to:#fb923c;
  --tile-circlequiz-bd:rgba(249,115,22,.45);
  --tile-chords-from:#d9d6ff;
  --tile-chords-to:#d9d6ff;
  --tile-chords-bd:rgba(163,155,255,.32);
  --tile-dynamics-from:#fed7aa;
  --tile-dynamics-to:#fed7aa;
  --tile-dynamics-bd:rgba(250,175,110,.32);
  --tile-expressions-from:#f9d7f1;
  --tile-expressions-to:#f9d7f1;
  --tile-expressions-bd:rgba(236,148,198,.32);
  --tile-reading-find-from:#c8f2ff;
  --tile-reading-find-to:#c8f2ff;
  --tile-reading-find-bd:rgba(79,181,202,.28);
  --tile-reading-place-from:#e3d1ff;
  --tile-reading-place-to:#e3d1ff;
  --tile-reading-place-bd:rgba(132,108,210,.28);
  --tile-reading-rhythm-from:#ffe2c1;
  --tile-reading-rhythm-to:#ffe2c1;
  --tile-reading-rhythm-bd:rgba(230,152,64,.30);
  --tile-reading-clef-from:#d6e0ff;
  --tile-reading-clef-to:#d6e0ff;
  --tile-reading-clef-bd:rgba(118,149,214,.28);
  --tile-reading-acc-from:#ffd6ec;
  --tile-reading-acc-to:#ffd6ec;
  --tile-reading-acc-bd:rgba(224,134,191,.30);
  --tile-reading-theory-staff-from:#d9e4ff;
  --tile-reading-theory-staff-to:#d9e4ff;
  --tile-reading-theory-staff-bd:rgba(135,166,220,.30);
  --tile-reading-theory-notes-from:#e6ddff;
  --tile-reading-theory-notes-to:#e6ddff;
  --tile-reading-theory-notes-bd:rgba(150,140,214,.30);
  --tile-reading-theory-rhythm-from:#ffe6f1;
  --tile-reading-theory-rhythm-to:#ffe6f1;
  --tile-reading-theory-rhythm-bd:rgba(236,151,198,.30);
  --tile-reading-theory-acc-from:#ffe2d1;
  --tile-reading-theory-acc-to:#ffe2d1;
  --tile-reading-theory-acc-bd:rgba(227,157,110,.30);
  --tile-reading-theory-articulation-from:#d7ecff;
  --tile-reading-theory-articulation-to:#d7ecff;
  --tile-reading-theory-articulation-bd:rgba(129,178,255,.32);
  --tile-reading-theory-marks-from:#ffe6cc;
  --tile-reading-theory-marks-to:#ffe6cc;
  --tile-reading-theory-marks-bd:rgba(248,191,115,.32);
  --tile-reading-dynamics-from:#d8f5e2;
  --tile-reading-dynamics-to:#d8f5e2;
  --tile-reading-dynamics-bd:rgba(102,184,143,.30);
  --tile-reading-expressions-from:#f6e4fb;
  --tile-reading-expressions-to:#f6e4fb;
  --tile-reading-expressions-bd:rgba(206,155,222,.30);
  --tile-reading-theory-navigation-from:#f0d8ff;
  --tile-reading-theory-navigation-to:#f0d8ff;
  --tile-reading-theory-navigation-bd:rgba(206,168,255,.32);

  /* --- Donut charts --- */
  --chart-bg:#e8edff;
  --chart-ok:#5b6ee3;
  --chart-warn:#f6b487;
  --chart-bad:#f28ba8;

  /* --- Circle background ring --- */
  --ring-fill:#e4e9ff;
  --ring-stroke:rgba(91,110,227,.35);
}

/* map tokens to components */
.btn-green{ background:var(--btn-green-bg); color:var(--btn-green-ink); }
.btn-cyan { background:var(--btn-cyan-bg);  color:var(--btn-cyan-ink); }
.btn-violet{background:var(--btn-violet-bg);color:var(--btn-violet-ink); }
.btn-amber{ background:var(--btn-amber-bg); color:var(--btn-amber-ink); }
.btn-ghost{ border-color: var(--btn-ghost-bd); }

.card-tile.home-blue  { --tile-from: var(--tile-blue-from);  --tile-to: var(--tile-blue-to);  --tile-bd: var(--tile-blue-bd); }
.card-tile.home-green { --tile-from: var(--tile-green-from); --tile-to: var(--tile-green-to); --tile-bd: var(--tile-green-bd); }
.card-tile.home-amber { --tile-from: var(--tile-amber-from); --tile-to: var(--tile-amber-to); --tile-bd: var(--tile-amber-bd); }
.card-tile.home-cyan  { --tile-from: var(--tile-cyan-from);  --tile-to: var(--tile-cyan-to);  --tile-bd: var(--tile-cyan-bd); }
.card-tile.home-violet{ --tile-from: var(--tile-violet-from);--tile-to: var(--tile-violet-to);--tile-bd: var(--tile-violet-bd); }
.card-tile.home-ivory { --tile-from: var(--tile-ivory-from); --tile-to: var(--tile-ivory-to); --tile-bd: var(--tile-ivory-bd); }
.card-tile.home-circlequiz{ --tile-from: var(--tile-circlequiz-from); --tile-to: var(--tile-circlequiz-to); --tile-bd: var(--tile-circlequiz-bd); }
.card-tile.home-chords{ --tile-from: var(--tile-chords-from); --tile-to: var(--tile-chords-to); --tile-bd: var(--tile-chords-bd); }
.card-tile.home-dynamics{ --tile-from: var(--tile-dynamics-from); --tile-to: var(--tile-dynamics-to); --tile-bd: var(--tile-dynamics-bd); }
.card-tile.home-expressions{ --tile-from: var(--tile-expressions-from); --tile-to: var(--tile-expressions-to); --tile-bd: var(--tile-expressions-bd); }
.card-tile.reading-find{ --tile-from: var(--tile-reading-find-from); --tile-to: var(--tile-reading-find-to); --tile-bd: var(--tile-reading-find-bd); }
.card-tile.reading-place{ --tile-from: var(--tile-reading-place-from); --tile-to: var(--tile-reading-place-to); --tile-bd: var(--tile-reading-place-bd); }
.card-tile.reading-rhythm{ --tile-from: var(--tile-reading-rhythm-from); --tile-to: var(--tile-reading-rhythm-to); --tile-bd: var(--tile-reading-rhythm-bd); }
.card-tile.reading-dynamics{ --tile-from: var(--tile-reading-dynamics-from); --tile-to: var(--tile-reading-dynamics-to); --tile-bd: var(--tile-reading-dynamics-bd); }
.card-tile.reading-expressions{ --tile-from: var(--tile-reading-expressions-from); --tile-to: var(--tile-reading-expressions-to); --tile-bd: var(--tile-reading-expressions-bd); }
.card-tile.reading-clef{ --tile-from: var(--tile-reading-clef-from); --tile-to: var(--tile-reading-clef-to); --tile-bd: var(--tile-reading-clef-bd); }
.card-tile.reading-acc{ --tile-from: var(--tile-reading-acc-from); --tile-to: var(--tile-reading-acc-to); --tile-bd: var(--tile-reading-acc-bd); }
.card-tile.reading-theory-staff{ --tile-from: var(--tile-reading-theory-staff-from); --tile-to: var(--tile-reading-theory-staff-to); --tile-bd: var(--tile-reading-theory-staff-bd); }
.card-tile.reading-theory-notes{ --tile-from: var(--tile-reading-theory-notes-from); --tile-to: var(--tile-reading-theory-notes-to); --tile-bd: var(--tile-reading-theory-notes-bd); }
.card-tile.reading-theory-rhythm{ --tile-from: var(--tile-reading-theory-rhythm-from); --tile-to: var(--tile-reading-theory-rhythm-to); --tile-bd: var(--tile-reading-theory-rhythm-bd); }
.card-tile.reading-theory-acc{ --tile-from: var(--tile-reading-theory-acc-from); --tile-to: var(--tile-reading-theory-acc-to); --tile-bd: var(--tile-reading-theory-acc-bd); }
.card-tile.reading-theory-articulation{ --tile-from: var(--tile-reading-theory-articulation-from); --tile-to: var(--tile-reading-theory-articulation-to); --tile-bd: var(--tile-reading-theory-articulation-bd); }
.card-tile.reading-theory-marks{ --tile-from: var(--tile-reading-theory-marks-from); --tile-to: var(--tile-reading-theory-marks-to); --tile-bd: var(--tile-reading-theory-marks-bd); }
.card-tile.reading-theory-navigation{ --tile-from: var(--tile-reading-theory-navigation-from); --tile-to: var(--tile-reading-theory-navigation-to); --tile-bd: var(--tile-reading-theory-navigation-bd); }

/* circle rings use theme tokens */
.ring{ fill: var(--ring-fill); stroke: var(--ring-stroke); }
</style>
<style id="theme-switcher-css">
.theme-switch{ margin-left:8px; background:var(--btn-ghost-bg,transparent); color:var(--btn-ghost-ink,var(--ink)); border:1px solid var(--btn-ghost-bd); border-radius:10px; padding:6px 10px; font-weight:600; }
#lang-switch{ margin-left:auto; }
</style>
</head>
<body>
<script id="theme-boot">
(function(){
  const KEY='theme';
  const root=document.documentElement;
  function apply(t){
    root.setAttribute('data-theme', t);
    // sync SVG glow flood-color with --accent
    const accent = getComputedStyle(root).getPropertyValue('--accent').trim() || '#22c55e';
    document.querySelectorAll('#glow feDropShadow').forEach(n=>n.setAttribute('flood-color', accent));
    document.dispatchEvent(new CustomEvent('toniqa-theme-change',{detail:{theme:t}}));
  }
  const saved = localStorage.getItem(KEY) || 'midnight';
  apply(saved);
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel=document.getElementById('theme-switch');
    if(sel){ sel.value=saved; sel.addEventListener('change', ()=>{ const t=sel.value; apply(t); localStorage.setItem(KEY,t); }); }
  });
})();
</script>
<style>
:root{
  /* baseline palette used before JS sets data-theme */
  --bg:#0b1020;--bg-gradient:#0f172a;
  --card:#111836;--surface:#0b1229;
  --ink:#e5e7eb;--muted:#94a3b8;
  --accent:#22c55e;--accent-ink:#062b13;

  /* buttons (defaults -> Midnight) */
  --btn-green-bg:#22c55e;--btn-green-ink:#08210f;
  --btn-cyan-bg:#0891b2;--btn-cyan-ink:#06252c;
  --btn-violet-bg:#7c3aed;--btn-violet-ink:#12052c;
  --btn-amber-bg:#f59e0b;--btn-amber-ink:#1b1302;
  --btn-ghost-bg:transparent;--btn-ghost-bd:rgba(255,255,255,.15);--btn-ghost-ink:var(--ink);

  /* shared adornments */
  --brand-ring:rgba(255,255,255,.25);
  --brand-primary:#22c55e;
  --brand-secondary:rgba(255,255,255,.6);

  /* tile typography */
  --tile-frame:rgba(255,255,255,.08);
  --tile-title-ink:#f8fafc;
  --tile-sub-ink:#e5e7eb;
  --tile-title-shadow:0 1px 2px rgba(0,0,0,.25);
  --tile-sub-shadow:0 1px 2px rgba(0,0,0,.25);

  /* elevations */
  --card-border:rgba(255,255,255,.07);
  --card-shadow:0 10px 30px rgba(0,0,0,.35);
  --table-border:rgba(255,255,255,.08);
  --table-head-bg:rgba(255,255,255,.03);
  --table-row-border:rgba(255,255,255,.06);
  --badge-bg:rgba(255,255,255,.06);
  --badge-border:rgba(255,255,255,.1);
  --list-border:rgba(255,255,255,.08);
  --metric-border:rgba(255,255,255,.08);

  /* selection */
  --select-border:rgba(255,255,255,.08);
  --select-on-border:#22c55e;
  --select-on-bg:rgba(34,197,94,.18);

  /* chips */
  --chip-border:rgba(255,255,255,.18);
  --chip-bg:transparent;
  --chip-ink:var(--ink);
  --chip-on-border:#22c55e;
  --chip-on-bg:rgba(34,197,94,.22);
  --chip-on-ink:#d1fae5;

  /* circle trainer */
  --circle-node-fill:#0b1229;
  --circle-node-minor-fill:#131b33;
  --circle-node-stroke:rgba(255,255,255,.35);
  --circle-node-ink:#e5e7eb;
  --circle-node-on-stroke:var(--select-on-border);
  --circle-node-on-fill:rgba(34,197,94,.20);
  --circle-node-on-fill-minor:rgba(34,197,94,.28);
  --circle-symbol-sharp:#93c5fd;
  --circle-symbol-flat:#fca5a5;
  --circq-panel-border:rgba(34,197,94,.35);
  --circq-panel-bg-top:rgba(34,197,94,.08);
  --circq-panel-bg-bottom:rgba(34,197,94,.02);
  --circq-panel-shadow:0 8px 26px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
body{margin:0;font:17px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,var(--bg),var(--bg-gradient,var(--bg)))}
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:min(1100px,100%);background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:20px;box-shadow:var(--card-shadow)}
.h2{margin:6px 0 10px;font-size:18px;color:var(--muted)}
.h3{margin:0 0 8px;font-size:16px;color:var(--muted)}
.title-lg{font-weight:800;font-size:24px}
.sub{color:var(--muted);font-size:14px;margin-top:4px}
.strong{font-weight:800;font-size:20px}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn-green{background:var(--btn-green-bg);color:var(--btn-green-ink)}
.btn-cyan{background:var(--btn-cyan-bg);color:var(--btn-cyan-ink)}
.btn-violet{background:var(--btn-violet-bg);color:var(--btn-violet-ink)}
.btn-amber{background:var(--btn-amber-bg);color:var(--btn-amber-ink)}
.btn-ghost{background:var(--btn-ghost-bg,transparent);color:var(--btn-ghost-ink,var(--ink));border:1px solid var(--btn-ghost-bd);font-weight:600;padding:10px 14px}
.row{display:grid;gap:12px;margin:10px 0}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btns-center{justify-content:center}
.stack{display:grid;gap:var(--stack-gap,16px)}
.stack-sm{--stack-gap:8px}
.stack-md{--stack-gap:16px}
.stack-lg{--stack-gap:24px}
.grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--grid-gap,12px)}
.grid-3.hub-cards{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:var(--grid-gap,16px)}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:var(--grid-gap,12px)}
.hub-tabs{display:none;gap:8px;margin:12px 0;width:100%;justify-content:center;flex-wrap:wrap}
.hub-tab{flex:1;appearance:none;border:1px solid var(--list-border);background:var(--surface);color:var(--muted);border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;transition:background .2s ease,border-color .2s ease,color .2s ease;display:flex;align-items:center;justify-content:center;gap:8px}
.hub-tab.active,
.hub-tab[aria-selected="true"]{background:var(--accent);border-color:var(--accent);color:var(--accent-ink,var(--ink))}
.hub-tab:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.hub-tab .hub-tab-icon{display:inline-flex;align-items:center;justify-content:center}

table{width:100%;border-collapse:collapse;border:1px solid var(--table-border);border-radius:12px;overflow:hidden;background:var(--surface)}
thead th{text-align:left;padding:12px 14px;font-size:15px;color:var(--muted);background:var(--table-head-bg)}
tbody td{padding:12px 14px;border-top:1px solid var(--table-row-border)}
.badge{font-size:13px;padding:6px 10px;border-radius:999px;background:var(--badge-bg);border:1px solid var(--badge-border)}
.badge.badge-eval{font-weight:600;padding:6px 12px}
.badge.badge-eval.is-ok{background:var(--ok-bg);border-color:var(--ok-bd);color:var(--ok-ink)}
.badge.badge-eval.is-bad{background:var(--bad-bg);border-color:var(--bad-bd);color:var(--bad-ink)}
.badge.big{font-size:22px}
.list-card{background:var(--surface);border:1px solid var(--list-border);border-radius:12px;padding:14px}
.toolbar{margin:6px 0 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.sp{flex:1}
.chip-wrap{display:flex;flex-wrap:wrap;gap:8px}
.chip-wrap-center{justify-content:center}
.chart{width:100%;max-width:360px;height:auto}
.eval{margin-top:10px}
.summary-list{display:grid;gap:10px}
.summary-item-title{font-weight:700;margin-bottom:6px}
.select-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;border:2px solid var(--select-border,rgba(255,255,255,.08));background:var(--select-bg,var(--surface));border-radius:12px;margin:8px 0;cursor:pointer;font-size:17px}
.select-row.on{border-color:var(--select-on-border,var(--accent));background:var(--select-on-bg,rgba(34,197,94,.18))}
.kv-legend{display:grid;gap:8px}
.kv-metric{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:var(--surface);border:1px solid var(--metric-border);border-radius:10px;font-size:16px}
.kv-variant{display:flex;align-items:center;gap:8px}
.circle-wrap{display:grid;grid-template-columns:1fr;gap:12px}
.circle-view{width:100%;}
.svg{width:100%;height:auto;display:block}
.svg g circle{transition:fill .18s ease, stroke .18s ease, stroke-width .18s ease}
.svg g[data-kind="m"] circle{fill:var(--circle-node-minor-fill,var(--circle-node-fill))}
.info-scales{padding-bottom:10px}
.info-card{display:grid;gap:10px}
#view-scales-info .info-card .h4{margin:20px 0 0}
#view-scales-info .info-card p{margin:0}
.fold{display:grid;gap:10px}
.fold-head{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.fold-head .info-heading{margin:0}
.fold-head .h4{margin:0}
.fold-toggle{margin-left:auto;display:inline-flex;align-items:center;justify-content:center;min-width:120px;gap:8px;padding:8px 16px;font-weight:800;letter-spacing:.2px;border:1px solid var(--accent);background:linear-gradient(180deg,var(--surface),var(--btn-ghost-bg,transparent));color:var(--accent-ink,var(--ink));box-shadow:0 6px 14px rgba(0,0,0,.12);transition:transform .2s ease, box-shadow .2s ease, background .2s ease}
.fold-toggle:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(0,0,0,.16)}
.fold-body{display:grid;gap:10px;position:relative}
.fold.is-collapsed .fold-body{max-height:120px;overflow:hidden;transition:max-height .25s ease, box-shadow .25s ease}
.fold.is-collapsed .fold-body::after{content:"";position:absolute;left:0;right:0;bottom:0;height:90px;background:linear-gradient(180deg,rgba(0,0,0,0) 0%,var(--surface) 85%);pointer-events:none}
.fold.is-collapsed:hover .fold-body{max-height:150px;box-shadow:inset 0 -20px 30px rgba(0,0,0,.08)}
.fold-sub{margin-top:6px}
.info-heading{font-weight:800}
.info-list{margin:0;padding-left:20px;display:grid;gap:6px;list-style:disc}
.info-list li{color:var(--ink)}
.info-staff{border:1px dashed var(--list-border);border-radius:12px;padding:8px 10px;background:var(--surface);overflow:auto;width:50%;margin:0 auto}
.info-staff-wide{width:100%}
.info-staff svg{display:block;margin:0 auto;max-width:100%}
.info-staff-label{fill:var(--ink)}
.info-staff .is-playing [data-role="note-head"]{fill:var(--accent)}
.info-staff .is-playing [data-role="note-label"]{fill:var(--accent)}
.info-staff .is-playing [data-role="accidental"]{fill:var(--accent)}
.info-enharm-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
.info-enharm-card{display:grid;gap:8px}
.info-enharm-label{margin:0;font-weight:700;text-align:center}
@media (max-width: 720px){
  .info-staff{width:100%}
}
.brandbar{display:flex; align-items:center; gap:10px; margin-bottom:4px; flex-wrap:wrap}
/* Global cap for brand logo so it never grows on small screens */
.brandbar .logo{
  width: 28px;
  height: 28px;
  flex: 0 0 28px;
  max-width: 28px;
  max-height: 28px;
}
/* Unified app title + claim across all sizes */
h1.brand{
  font-size:20px;
  letter-spacing:0.5px;
  margin:0 0 4px;
  font-weight:800;
}
.claim{
  margin:0 0 12px;
  color:var(--muted);
  font-size:13px;
}
@media (min-width: 980px){
  .circle-wrap{grid-template-columns:1.2fr .8fr;align-items:center}
  .ring{fill:var(--ring-fill);stroke:var(--ring-stroke)}
  .ring.outer{stroke-width:2}
  .ring.inner{stroke-width:1}
  .kv-legend .title-lg{margin-bottom:6px}
  .home-cards .card-tile,
  .hub-cards .card-tile{display:flex;flex-direction:column;gap:12px;min-height:140px;height:100%}
  .home-cards .card-tile .btn,
  .hub-cards .card-tile .btn{margin-top:auto}
  .home-cards .btn{justify-self:start}
  /* .brandbar and logo rules moved above for global effect */

  .hub-cards .btn { display: none !important; }
  .hub-cards .card-tile .btn{ display: none !important; }
  .hub-cards .card-tile h3 { margin: 0; font-size: 18px; font-weight: 800; color: var(--tile-title-ink,var(--ink)); }
  .hub-cards .card-tile p  { margin: 0; font-size: 14px; color: var(--tile-sub-ink,var(--muted)); opacity: .92; }
  .card-tile.home-blue:hover, .card-tile.home-green:hover, .card-tile.home-amber:hover { filter: saturate(1.08) brightness(1.04); }

 /* lehčí vnitřní padding kartičky s mapou not */
  .notes-map-card{ padding: 12px 14px; }

  /* jemně menší titul */
  .notes-map-title{ font-size: 16px; }
}

@media (max-width: 979px){
  .circle-wrap{ grid-template-columns: 1fr; gap:18px; }
  .kv-legend{ width:100%; }
  .home-cards .card-tile,
  .hub-cards .card-tile{min-height:140px}
  .grid-3{--grid-gap:12px}
  .grid-3.hub-cards{--grid-gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
}
@media (max-width: 768px){
  .hub-tabs{display:flex}
  .hub-tab{font-size:15px;padding:10px 12px}
  .hub-cards{grid-template-columns:repeat(1,1fr);gap:0.75rem;--grid-gap:0.75rem;justify-items:center}
  .hub-cards .card-tile{padding:0.75rem;min-height:90px;text-align:left;justify-items:start;align-items:center;width:85%;max-width:420px}
  .hub-cards .card-tile .tile-head{display:flex;align-items:center;justify-content:flex-start;gap:8px;width:100%;justify-self:start}
  .hub-cards .card-tile h3{font-size:1rem}
  .hub-cards .card-tile p{display:none}
  .hub-groups .hub-group > .h3{display:none}
  .hub-groups{position:relative}
  .hub-groups .hub-group{display:none}
  .hub-groups[data-current="theory"] .hub-group[data-section="theory"],
  .hub-groups[data-current="practice"] .hub-group[data-section="practice"]{display:block}
}
/* === util === */
.mt-10{ margin-top:10px; }
.mt-12{ margin-top:12px; }
.hidden{ display:none !important; }

/* === icon system === */
.icon{ display:inline-block; width:1em; height:1em; vertical-align:-0.125em; fill:currentColor; }
.icon-20{ font-size:20px; } .icon-24{ font-size:24px; } .icon-28{ font-size:28px; } .icon-32{ font-size:32px; }
.tile-head{display:flex;align-items:center;gap:8px;width:100%;}
.tile-head .tile-badge{margin-left:auto;font-size:12px;font-weight:800;padding:4px 10px;border-radius:999px;background:var(--surface-subtle,rgba(15,23,42,.08));color:var(--muted);}
.tile-head .icon{ margin-right:8px; color: var(--tile-title-ink,var(--ink)); }
/* === evaluation cards === */


/* --- evaluation badges --- */
:root{
  --ok-bg: rgba(16,185,129,.18);
  --ok-ink:#34d399;
  --bad-bg: rgba(239,68,68,.18);
  --bad-ink:#f87171;
}
.eval-card.is-ok{background:var(--ok-bg);color:var(--ok-ink);}
.eval-card.is-bad{background:var(--bad-bg);color:var(--bad-ink);}
.summary-list .sub{opacity:.85}

</style>
<style>
/* v5.8.7 — chips styled globally (not only ≥980px) */
.chip{appearance:none;cursor:pointer;border:1px solid var(--chip-border,rgba(255,255,255,.18));background:var(--chip-bg,transparent);color:var(--chip-ink,var(--ink));border-radius:999px;padding:8px 12px;font-weight:700}
.chip.on{background:var(--chip-on-bg,rgba(34,197,94,.22));border-color:var(--chip-on-border,var(--accent));color:var(--chip-on-ink,var(--accent-ink,var(--ink)))}
</style>
<style>
/* v5.8.7 — navigation vs detail modes */
body.nav-mode .grid-3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));--grid-gap:12px}
body.nav-mode .home-cards .btn,
body.nav-mode .hub-cards  .btn{display:none!important}
body.nav-mode .card-tile{cursor:pointer}
@media (max-width:768px){
  body.nav-mode .hub-cards{grid-template-columns:repeat(1,1fr);gap:0.75rem;--grid-gap:0.75rem;justify-items:center}
  body.nav-mode .hub-cards .card-tile{padding:0.75rem;min-height:90px;text-align:left;justify-items:start;align-items:center;width:85%;max-width:420px}
  body.nav-mode .hub-cards .card-tile .tile-head{display:flex;align-items:center;justify-content:flex-start;gap:8px;width:100%;justify-self:start}
  body.nav-mode .hub-cards .card-tile h3{font-size:1rem}
  body.nav-mode .hub-cards .card-tile p{display:none}
  body.nav-mode .hub-groups .hub-group > .h3{display:none}
}

@media (max-width:768px){
  .wrap{padding:2px;}
  .card{padding:6px;}
  .list-card{padding:8px 10px;}
  .stack-lg{--stack-gap:12px;}
  .stack-md{--stack-gap:10px;}
  .stack-sm{--stack-gap:6px;}
  .section-hint,
  .sub{margin-top:2px;}
}
</style>
<style>

/* v5.8.5a — circq-panel spacing & sizing */
#circq2-panel{
  padding:18px 18px 20px;
  border:2px solid var(--circq-panel-border, rgba(34,197,94,.35));
  background:linear-gradient(180deg, var(--circq-panel-bg-top, rgba(34,197,94,.08)), var(--circq-panel-bg-bottom, rgba(34,197,94,.02)));
  box-shadow:var(--circq-panel-shadow, 0 8px 26px rgba(0,0,0,.25));
  border-radius:14px;
}
#circq2-panel .sub{
  font-size: 16px;
}
#circq2-panel .btns{
  gap: 10px;
}
#circq2-panel .btn{
  font-size: 16px;
  padding: 12px 16px;
  border-radius: 12px;
  min-width: 110px;
}
#circq2-wrap .toolbar .badge{
  margin-left: 0;
}

</style>

<style>
/* v5.8.5c — vizuální oddělení vyhodnocení a tlačítka Další */
#circq2-result {
  margin-bottom: 14px;
  padding-bottom: 10px;
}

</style>


<style>
  /* ToniQa v5.8.1 — summary highlighting */
  :root{
    --ok-bg: rgba(34,197,94,.10);
    --ok-bd: rgba(34,197,94,.35);
    --bad-bg: rgba(239,68,68,.10);
    --bad-bd: rgba(239,68,68,.35);
    --card-r: 14px;
  }
  .eval-card{
    position: relative;
    border-radius: var(--card-r);
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.02);
    padding: 14px 16px;
    margin: 12px 0;
    transition: background-color .2s ease, border-color .2s ease, box-shadow .2s ease;
  }
  .eval-card .eval-card{ background: transparent; border-color: transparent; box-shadow: none; }
  .eval-card.is-ok{
    background: var(--ok-bg);
    border-color: var(--ok-bd);
    box-shadow: 0 0 0 3px rgba(34,197,94,.14) inset;
  }
  .eval-card.is-bad{
    background: var(--bad-bg);
    border-color: var(--bad-bd);
    box-shadow: 0 0 0 3px rgba(239,68,68,.14) inset;
  }
  .eval-card h4, .eval-card .qtitle{ font-weight:600; letter-spacing:.2px; }
</style>

<style>
/* v5.8.9 — unify card-tile styling across all breakpoints
   Now token-based so each skin defines its own frame & typography */
.card-tile{
  background:var(--tile-bg,var(--surface));
  border:1px solid var(--tile-frame,var(--list-border));
  border-radius:14px;
  padding:16px;
  display:grid;
  gap:8px;
  cursor:pointer;
}
.card-tile h3{
  margin:0;
  font-size:18px;
  color:var(--tile-title-ink,var(--ink));
  text-shadow:var(--tile-title-shadow,none);
}
.card-tile p{
  margin:0;
  line-height:1.4;
  letter-spacing:.01em;
  font-size:14px;
  color:var(--tile-sub-ink,var(--muted));
  opacity:.92;
  text-shadow:var(--tile-sub-shadow,none);
}

:root[data-theme="aurora"] .card-tile[data-tile="ksquiz"]{
  --tile-from: var(--tile-ksquiz-from);
  --tile-to: var(--tile-ksquiz-to);
  --tile-bd: var(--tile-ksquiz-bd);
}
.home-cards .btn,
.hub-cards .btn{ display:none !important; }
</style>
</head>
<body>
<script id="i18n-lib">
(function(){
  // Lightweight i18n: central text library + applicator for elements with [data-i18n]
  const dict_cs = {
    // === Clef theory section (custom additions) ===
    brand_claim: "Hudební trénink stupnic a tónin",
    app_title: "TonIQa",
    rel_major_label: "Rel. durová",
    tonic_minor_label: "Tonika moll",

    // Home tiles
    home_basics_title: "Hudební základy",
    home_basics_desc: "Čtení not, rytmus, dynamika a výrazy – teorie i tréninky.",
    home_scales_title: "Stupnice a tóniny",
    home_scales_desc: "Kvintový kruh, tóniny, pentatoniky, tréninky.",
    home_intervals_title: "Intervaly",
    home_intervals_desc: "Druhy intervalů a jejich stavba. (Připravujeme)",
    home_chords_title: "Akordy",
    home_chords_desc: "Stavba a typy akordů. (Připravujeme)",
    home_harmony_title: "Harmonie",
    home_harmony_desc: "Funkce, kadence a akordové postupy v tónině. (Připravujeme)",
    home_improv_title: "Improvizace",
    home_improv_desc: "Základy improvizace a pentatonika v praxi. (Připravujeme)",
    home_dynamics_title: "Jak funguje dynamika",
    home_dynamics_desc: "Značky pro hlasitost, cresc./dim. a práce s výrazem. (Připravujeme)",
    home_expressions_title: "Výrazy v hudbě",
    home_expressions_desc: "Italské názvosloví pro tempo a náladu. (Připravujeme)",
    badge_coming: "Připravujeme",
    page_in_preparation: "Tato stránka je v přípravě.",
    common_open: "Otevřít",

    // Hub
    hub_title: "Stupnice – trénink",
    hub_list_title: "Všechny stupnice",
    hub_list_desc: "Přehled a detaily moll/dur.",
    hub_build_title: "Sestav stupnici",
    hub_build_desc: "Vyber předznamenání, pentatoniku a blue note.",
    hub_ksquiz_title: "Poznej tóninu",
    hub_ksquiz_desc: "Urči durovou + příbuznou moll podle předznamenání.",
    hub_circle_title: "Kvintový kruh",
    hub_circle_desc: "Vizualizace posloupnosti stupnic.",
    hub_about_scales_title: "Jak fungují stupnice",
    hub_about_scales_desc: "Základní fakta o stupnicích.",
    hub_circlequiz_title: "Urči tóninu v kruhu",
    hub_circlequiz_desc: "Vyber správnou tóninu podle předznamenání nebo příbuznosti.",
    hub_group_theory: "Teorie",
    hub_group_practice: "Procvičování",
    hub_tab_theory: "Teorie",
    hub_tab_practice: "Procvičování",

    // Common buttons / toolbars
    common_back: "← Zpět",
    common_back_to_select: "← Zpět na výběr",
    common_collapse: "Sbalit",
    common_detail_scale: "Detail stupnice",
    common_expand: "Číst víc",
    common_next: "Další",
    common_prev: "Předchozí",
    common_eval: "Vyhodnotit",

    // Section headings (samples – can be expanded later)
    build_select_title: "Sestav stupnici – výběr",
    build_select_hint: "Vyber si stupnice, které chceš procvičit. Test ti je bude náhodně míchat, takže každý pokus bude jiný.",
    build_select_type_title: "Typ stupnice v testu",
    build_select_type_hint: "Zvol, jaký typ stupnice budeš sestavovat.",
    build_select_type_penta: "Pentatonika",
    build_select_type_major: "Durová stupnice",
    build_select_type_minor: "Mollová stupnice",
    build_quiz_heading_acc: "Předznamenání",
    build_quiz_heading_penta: "Moll pentatonika (5 tónů)",
    build_quiz_heading_major: "Durová stupnice (7 tónů)",
    build_quiz_heading_minor: "Mollová stupnice (7 tónů)",
    build_quiz_heading_blue: "Blue note (b5)",
    build_header_prefix: "Sestav:",

    // Summaries
    sum_build_title: "Shrnutí – Sestav stupnici",
    sum_ksq_title: "Shrnutí – Poznej tóninu",
    sum_circq_title: "Shrnutí – Procvičuj kruh",
    sum_circquiz_title: "Shrnutí – Urči tóninu v kruhu",
    sum_home: "Zpět na úvod",
    sum_retry: "Zkusit znovu",
    sum_retry_circq: "Trénovat znovu",
    sum_retry_circquiz: "Procvičit znovu",

    // KS Quiz
    ksq_title: "Poznej tóninu – podle předznamenání",
    ksq_pick_len: "Vyber délku tréninku",
    ksq_3: "3 otázky",
    ksq_5: "5 otázek",
    ksq_10: "10 otázek",
    ksq_pick_major: "Vyber durovou",
    ksq_pick_minor: "Vyber mollovou",

    // Circle
    circle_title: "Kvintový kruh – vizualizace posloupnosti stupnic",
    circlequiz_title: "Urči tóninu v kruhu – trénink",
    circle_panel_pick: "Procvičuj kruh – vyber délku",
    circle_task: "Úkol: klikni v kruhu na <b>správnou durovou nebo příbuznou moll</b> k tomuto předznamenání:",
    circle_end: "Ukončit trénink",
    info_scales_title: "O stupnicích – přehled",
    info_intro_heading: "🧱 Co je stupnice",
    info_intro_p1: "Stupnice jsou <b>základní nástroj, díky kterému se v hudbě vyznáme</b>. Pomáhají nám chápat, proč melodie zní tak, jak zní, jaké tóny k sobě patří a proč některé kombinace fungují přirozeněji než jiné. Ať už čteš noty, improvizuješ, skládáš nebo jen posloucháš hudbu, stupnice ti dávají orientaci – jsou jakousi mapou tónového prostoru.",
    info_intro_p2: "Zjednodušeně řečeno: stupnice je <b>uspořádaná řada tónů</b>, která vychází z jednoho výchozího tónu a postupuje nahoru nebo dolů podle daných pravidel. Tato pravidla určují, <b>které tóny do stupnice patří a jaké jsou mezi nimi vzdálenosti</b>. Právě díky nim má každá stupnice svůj charakter – může znít klidně, napjatě, smutně, radostně nebo exoticky.",
    info_intro_p3: "Stupnice nejsou jen teoretický pojem. Jsou <b>základním stavebním kamenem hudby</b>:",
    info_intro_use_1: "pomáhají chápat melodii a harmonii,",
    info_intro_use_2: "určují tóninu skladby,",
    info_intro_use_3: "slouží jako opora pro improvizaci,",
    info_intro_use_4: "a dávají hudbě řád a logiku.",
    info_intro_world_heading: "Stupnice napříč světem",
    info_intro_world_intro: "Různé kultury si v průběhu historie vytvořily vlastní systémy stupnic. Existují například:",
    info_intro_world_item_1: "<b>indické rágy</b>, které nejsou jen souborem tónů, ale i pravidel použití,",
    info_intro_world_item_2: "<b>arabské maqámy</b>, pracující s jemnějšími intervaly než půltón,",
    info_intro_world_item_3: "<b>pentatonické stupnice</b>, rozšířené v lidové hudbě po celém světě,",
    info_intro_world_item_4: "nebo <b>čínské a japonské stupnice</b>, typické svým otevřeným a meditativním zvukem.",
    info_intro_world_outro: "Každý z těchto systémů odráží jiný způsob vnímání hudby, estetiky i emocí.",
    info_intro_focus_heading: "Na co se budeme soustředit zde",
    info_intro_focus_intro: "V této části se budeme věnovat <b>stupnicím západní hudby</b>, ze kterých vychází většina klasické, populární i jazzové hudby. Tyto stupnice se historicky vyvinuly z církevních modů, postupně se ustálily v durovém a mollovém systému a dnes tvoří základ hudební teorie, jak ji běžně známe.",
    info_intro_focus_list_intro: "Setkáš se zde zejména s:",
    info_intro_focus_item_1: "<b>durovými a mollovými stupnicemi</b>,",
    info_intro_focus_item_2: "<b>církevními módy</b>,",
    info_intro_focus_item_3: "<b>pentatonikami</b>,",
    info_intro_focus_item_4: "a dalšími běžně používanými typy stupnic.",
    info_intro_focus_next_intro: "U každé z nich si postupně ukážeme:",
    info_intro_focus_next_item_1: "z jakých tónů se skládá,",
    info_intro_focus_next_item_2: "jak zní,",
    info_intro_focus_next_item_3: "kde se v hudbě používá,",
    info_intro_focus_next_item_4: "a jak s ní prakticky pracovat.",
    info_diff_heading: "🧭 Jak se stupnice liší",
    info_diff_p1: "Když se řekne „stupnice“, může to znít, jako by šlo vždy o totéž – jen o jinou řadu tónů. Ve skutečnosti se ale stupnice mezi sebou liší v několika zásadních ohledech. Právě tyto rozdíly rozhodují o tom, <b>jak stupnice zní, jaký má charakter a k čemu se v hudbě používá</b>.",
    info_diff_p2: "Abychom se v různých stupnicích dokázali orientovat, je užitečné dívat se na ně z několika základních hledisek.",
    info_diff_count_heading: "Počet tónů",
    info_diff_count_p: "Ne všechny stupnice mají stejný počet tónů. Některé pracují se sedmi tóny, jiné s pěti nebo i více. Počet tónů ovlivňuje, kolik různých tónů máš při hraní k dispozici – tedy zda se melodie pohybuje v úzkém, přehledném prostoru, nebo naopak v širším a bohatším tónovém rozsahu.",
    info_diff_intervals_heading: "Vzdálenosti mezi tóny",
    info_diff_intervals_p: "Klíčovým rozdílem mezi stupnicemi nejsou samotné tóny, ale <b>vzdálenosti mezi nimi</b>. Právě sled intervalů určuje, zda stupnice zní radostně, smutně, napjatě, klidně nebo tajemně. I stupnice, které obsahují stejný počet tónů, mohou mít díky jinému uspořádání intervalů zcela odlišný charakter.",
    info_diff_mood_heading: "Charakter a nálada",
    info_diff_mood_p: "Každá stupnice v sobě nese určitý výraz. Některé působí stabilně a jasně, jiné melancholicky, dramaticky nebo exoticky. Tento charakter není náhodný – vychází z historického používání stupnice i z toho, jak lidské ucho vnímá jednotlivé intervaly.",
    info_diff_use_heading: "Použití v hudbě",
    info_diff_use_p: "Různé stupnice se uplatňují v různých typech hudby. Některé tvoří základ většiny skladeb, jiné se používají spíše pro barvu, atmosféru nebo improvizaci. Znalost stupnic tak pomáhá nejen při čtení a psaní hudby, ale i při rozhodování, <b>jaký zvuk nebo náladu chceme vytvořit</b>.",
    info_diff_outro: "V dalších částech se podíváme na konkrétní typy stupnic. U každé z nich si ukážeme, z čeho se skládá, jak zní a kde se v hudbě nejčastěji objevuje.",
    info_core_types_heading: "Základní typy stupnic",
    info_core_types_intro: "Následují tři základní skupiny stupnic používané v západní hudbě. Každá z nich má svůj charakter, typické zvukové barvy i praktické využití – a právě tyto rozdíly pomáhají lépe porozumět tóninám i tomu, proč hudba působí tak, jak působí.",
    info_major_heading: "🎼 Durová stupnice",
    info_major_p1: "Durová stupnice je <b>základní a nejčastěji používaná stupnice v západní hudbě</b>. Pokud se v hudbě mluví o „stupnici“ bez dalšího upřesnění, velmi často se tím myslí právě dur. Slouží jako výchozí bod pro pochopení dalších stupnic a tónin.",
    info_major_p2: "Durová stupnice vytváří <b>pevný a stabilní hudební rámec</b>. Díky svému uspořádání působí přirozeně, jasně a vyrovnaně, a proto se používá v obrovském množství skladeb – od lidových písní přes klasiku až po pop a filmovou hudbu.",
    info_major_parts_heading: "Z čeho se durová stupnice skládá",
    info_major_parts_p1: "Durová stupnice má <b>sedm různých tónů</b>, které se postupně střídají v přesně daných vzdálenostech. Tyto vzdálenosti nejsou náhodné – právě jejich sled určuje, že stupnice zní „durově“.",
    info_major_parts_p2: "Typický model durové stupnice vychází ze střídání <b>celých tónů a půltónů</b>. Tento vzorec je stejný pro všechny durové stupnice, bez ohledu na to, na jakém tónu začínají.",
    info_major_pattern_intro: "Konkrétně jde o sled kroků:",
    info_major_pattern_line: "<b>celý – celý – půl – celý – celý – celý – půl</b>",
    info_major_pattern_note: "Podle tohoto vzorce lze sestavit jakoukoli durovou stupnici – vždy se jen vychází z jiného výchozího tónu.",
    info_major_look_heading: "Jak durová stupnice vypadá",
    info_major_look_p1: "Aby bylo jasné, o jaké tóny jde, je užitečné podívat se na konkrétní příklad. Nejčastěji se jako ukázka používá <b>stupnice C dur</b>, protože neobsahuje žádné křížky ani béčka.",
    info_major_look_p2: "Stupnice C dur má tyto tóny:",
    info_major_look_notes: "<b>C – D – E – F – G – A – H – C</b>",
    info_major_look_p3: "Na notové osnově se projeví jako plynulý postup po sousedních notách a na klaviatuře odpovídá hraní pouze na bílých klávesách.",
    info_major_play: "Přehrát stupnici",
    info_major_sound_heading: "Jak durová stupnice zní a působí",
    info_major_sound_p: "Durová stupnice je často spojována s pocity jako:",
    info_major_sound_item_1: "jasnost,",
    info_major_sound_item_2: "stabilita,",
    info_major_sound_item_3: "radost nebo otevřenost.",
    info_major_sound_note: "Neznamená to, že každá skladba v duru musí znít „veselé“. Spíš jde o to, že dur poskytuje <b>pevnou a čitelnou oporu</b>, se kterou se dobře pracuje melodicky i harmonicky.",
    info_major_use_heading: "Kde se s ní setkáš",
    info_major_use_p: "Durová stupnice tvoří základ:",
    info_major_use_item_1: "většiny tónin v západní hudbě,",
    info_major_use_item_2: "běžných akordů a harmonií,",
    info_major_use_item_3: "hudební výuky a notového zápisu.",
    info_minor_heading: "🌒 Mollové stupnice",
    info_minor_p1: "Mollové stupnice tvoří důležitou a velmi bohatou oblast hudebního světa. Pokud durové stupnice často vnímáme jako stabilní a otevřené, moll přináší jiný druh napětí, hloubky a barevnosti. Nejde ale jen o „smutnější“ variantu duru – moll nabízí širokou škálu výrazů, od jemných a lyrických až po dramatické a temné.",
    info_minor_p2: "Na rozdíl od durové stupnice neexistuje jen jedna jediná mollová stupnice. V hudbě se setkáš s několika podobami mollu, které vznikly postupně jako praktická odpověď na hudební potřeby – především na práci s melodií, harmonií a napětím.",
    info_minor_p3: "Společným základem všech mollových stupnic je charakteristický vztah tónů, který vytváří jejich typický zvuk. Jednotlivé varianty mollu se pak liší v tom, jak s těmito tóny nakládají v určitých místech stupnice, aby lépe vyhovovaly melodickému vedení nebo harmonickému použití.",
    info_minor_p4: "V praxi se jednotlivé mollové stupnice často nepoužívají odděleně, ale přirozeně se prolínají. Hudba tak není svázána jedním pevným tvarem, ale může pružně reagovat na to, co je v daném okamžiku potřeba – ať už jde o melodii, akordy nebo celkový výraz.",
    info_minor_p5: "V následujících kapitolách se proto podíváme na jednotlivé varianty mollových stupnic samostatně. U každé z nich si ukážeme, jak vypadá, jak zní a proč vznikla, aby bylo jasné, kdy a proč se v hudbě používá.",
    info_harm_heading: "🎶 Přirozená mollová stupnice (natural minor)",
    info_harm_p1: "Přirozená mollová stupnice je <b>základní a nejpřirozenější podoba mollu</b>. Můžeš si ji představit jako výchozí tvar, ze kterého ostatní mollové stupnice vycházejí. V hudbě se s ní setkáš velmi často – jak v melodii, tak v harmonii – a právě proto je dobré začít mollové stupnice poznávat právě u ní.",
    info_harm_p2: "Její zvuk bývá vnímán jako klidnější, vážnější nebo zadumanější než u durové stupnice. Nejde ale nutně o smutek – přirozená mollová stupnice spíš vytváří <b>otevřený prostor pro výraz</b>, který může být jemný, melancholický i dramatický.",
    info_harm_parts_heading: "Z čeho se přirozená mollová stupnice skládá",
    info_harm_parts_p1: "Přirozená mollová stupnice má, stejně jako dur, <b>sedm různých tónů</b>. Její charakter vzniká jiným uspořádáním vzdáleností mezi tóny.",
    info_harm_pattern_intro: "Typický model přirozené mollové stupnice vychází ze sledu:",
    info_harm_pattern_line: "<b>celý – půl – celý – celý – půl – celý – celý</b>",
    info_harm_pattern_note: "Právě tento sled kroků dává stupnici její typický mollový charakter.",
    info_harm_look_heading: "Jak přirozená mollová stupnice vypadá",
    info_harm_look_p1: "Jako názorný příklad se často používá <b>stupnice a moll</b>, protože neobsahuje žádné křížky ani béčka.",
    info_harm_look_p2: "Stupnice a moll má tyto tóny:",
    info_harm_look_notes: "<b>A – H – C – D – E – F – G – A</b>",
    info_harm_look_p3: "Na notové osnově působí velmi podobně jako C dur, začíná ale na jiném tónu a její těžiště je posunuté. Právě to je jeden z důvodů, proč se přirozená mollová stupnice často popisuje jako „příbuzná“ k durové stupnici.",
    info_harm_play: "Přehrát stupnici",
    info_harm_sound_heading: "Jak přirozená mollová stupnice zní a působí",
    info_harm_sound_intro: "Přirozená mollová stupnice je často spojována s pocity jako:",
    info_harm_sound_item_1: "klid,",
    info_harm_sound_item_2: "hloubka,",
    info_harm_sound_item_3: "melancholie,",
    info_harm_sound_item_4: "vnitřní napětí.",
    info_harm_sound_note: "Je velmi univerzální – může znít jemně i temně, podle tempa, harmonie a způsobu použití.",
    info_harm_use_heading: "Kde se s ní setkáš",
    info_harm_use_intro: "Přirozená mollová stupnice tvoří základ:",
    info_harm_use_item_1: "mnoha lidových a klasických melodií,",
    info_harm_use_item_2: "mollových tónin bez zvýšeného sedmého stupně,",
    info_harm_use_item_3: "další práce s mollovými stupnicemi.",
    info_harm_use_outro: "Je také výchozím bodem pro pochopení toho, <b>proč vznikla harmonická a melodická mollová stupnice</b>, které tento základ dále rozvíjejí.",
    info_harmonic_heading: "🎵 Harmonická mollová stupnice (harmonic minor)",
    info_harmonic_p1: "Harmonická mollová stupnice vznikla jako <b>odpověď na harmonické potřeby hudby</b>. Vychází z přirozené mollové stupnice, ale upravuje jeden klíčový tón tak, aby bylo možné vytvářet silnější a jednoznačnější harmonii, zejména v závěrech a kadencích.",
    info_harmonic_p2: "Zatímco přirozená mollová stupnice působí melodicky přirozeně, v harmonii jí chybí napětí, které je typické pro durový systém. Harmonická mollová stupnice tento problém řeší a stává se tak <b>základním harmonickým tvarem mollu</b>.",
    info_harmonic_parts_heading: "Z čeho se harmonická mollová stupnice skládá",
    info_harmonic_parts_p1: "Harmonická mollová stupnice vychází z přirozené mollové stupnice, ale má <b>zvýšený sedmý stupeň</b>. Právě tato změna zásadně ovlivňuje její zvuk i harmonické možnosti.",
    info_harmonic_pattern_intro: "Typický model harmonické mollové stupnice lze popsat jako:",
    info_harmonic_pattern_line: "<b>celý – půl – celý – celý – půl – jeden a půl – půl</b>",
    info_harmonic_pattern_note: "Výrazný zvětšený krok mezi šestým a sedmým stupněm dodává stupnici její charakteristické napětí.",
    info_harmonic_look_heading: "Jak harmonická mollová stupnice vypadá",
    info_harmonic_look_p1: "Jako názorný příklad se často používá <b>stupnice a moll</b>.",
    info_harmonic_look_p2: "Harmonická mollová stupnice a moll má tyto tóny:",
    info_harmonic_look_notes: "<b>A – H – C – D – E – F – G♯ – A</b>",
    info_harmonic_look_p3: "Zvýšený sedmý stupeň vytváří silné směřování zpět k výchozímu tónu, což je klíčové pro harmonické zakončení.",
    info_harmonic_play: "Přehrát stupnici",
    info_harmonic_sound_heading: "Jak harmonická mollová stupnice zní a působí",
    info_harmonic_sound_p1: "Harmonická mollová stupnice působí výrazněji a dramatičtěji než přirozená moll. Typické je pro ni silné napětí před návratem k základnímu tónu, které dodává hudbě tah a směřování.",
    info_harmonic_sound_p2: "Díky zvětšenému kroku má harmonická mollová stupnice často <b>exotický nebo orientální nádech</b>, který je v hudbě snadno rozpoznatelný.",
    info_harmonic_use_heading: "Kde se s ní setkáš",
    info_harmonic_use_intro: "Harmonická mollová stupnice se používá především:",
    info_harmonic_use_item_1: "v harmonii mollových tónin,",
    info_harmonic_use_item_2: "v klasické hudbě při stavbě kadencí,",
    info_harmonic_use_item_3: "v dramatické a filmové hudbě,",
    info_harmonic_use_item_4: "jako základ pro pochopení mollových akordů.",
    info_harmonic_use_outro: "Spolu s přirozenou a melodickou mollovou stupnicí tvoří harmonická mollová stupnice <b>uzavřený systém mollových variant</b>, z nichž každá řeší jiný hudební problém.",
    info_mel_heading: "🎵 Melodická mollová stupnice (melodic minor)",
    info_mel_p1: "Melodická mollová stupnice vznikla jako <b>praktická reakce na melodické potřeby hudby</b>. Vychází z přirozené mollové stupnice, ale upravuje některé tóny tak, aby melodie zněla plynuleji a přirozeněji, zejména při pohybu směrem vzhůru.",
    info_mel_p2: "Na rozdíl od ostatních mollových stupnic se melodická mollová stupnice <b>chová odlišně při vzestupném a sestupném pohybu</b>. Právě tato vlastnost z ní dělá specifický a velmi zajímavý nástroj pro melodii.",
    info_mel_parts_heading: "Z čeho se melodická mollová stupnice skládá",
    info_mel_parts_intro: "Základ melodické mollové stupnice vychází z přirozené mollové stupnice, ale:",
    info_mel_parts_item_1: "při <b>stoupání nahoru</b> jsou zvýšeny šestý a sedmý stupeň,",
    info_mel_parts_item_2: "při <b>klesání dolů</b> se stupnice vrací k podobě přirozené mollové stupnice.",
    info_mel_parts_note: "Díky tomu se při vzestupu odstraní větší skoky v melodii a vznikne plynulejší tónový průběh.",
    info_mel_look_heading: "Jak melodická mollová stupnice vypadá",
    info_mel_look_p1: "Jako názorný příklad se často používá <b>stupnice a moll</b>.",
    info_mel_look_up_intro: "Při pohybu nahoru má melodická mollová stupnice tyto tóny:",
    info_mel_look_up_notes: "<b>A – H – C – D – E – F♯ – G♯ – A</b>",
    info_mel_look_down_intro: "Při pohybu dolů se vrací k přirozené mollové podobě:",
    info_mel_look_down_notes: "<b>A – G – F – E – D – C – H – A</b>",
    info_mel_look_note: "Tento rozdíl mezi vzestupem a sestupem je pro melodickou mollovou stupnici typický.",
    info_mel_play: "Přehrát stupnici",
    info_mel_sound_heading: "Jak melodická mollová stupnice zní a působí",
    info_mel_sound_p: "Melodická mollová stupnice působí při vzestupu otevřeněji a světleji než přirozená moll, při sestupu se naopak vrací k jejímu temnějšímu charakteru. Díky této proměnlivosti nabízí <b>velmi bohaté výrazové možnosti</b>.",
    info_mel_use_heading: "Kde se s ní setkáš",
    info_mel_use_intro: "Melodická mollová stupnice se často používá:",
    info_mel_use_item_1: "v melodickém vedení klasické hudby,",
    info_mel_use_item_2: "v jazzové a moderní hudbě,",
    info_mel_use_item_3: "v situacích, kdy je potřeba plynulý a zpěvný melodický pohyb.",
    info_mel_use_outro: "Je důležitým článkem mezi přirozenou a harmonickou mollovou stupnicí a rozšiřuje možnosti práce s mollovým charakterem.",
    info_penta_heading: "🎷 Pentatonické stupnice",
    info_penta_intro_p1: "Pentatonické stupnice patří k nejstarším a nejuniverzálnějším hudebním systémům. Název „pentatonika“ znamená, že stupnice má <b>pět tónů</b>, a právě tato jednoduchost je jedním z důvodů, proč zní pentatoniky přirozeně, otevřeně a velmi „hudebně“.",
    info_penta_intro_p2: "Pentatoniky se objevují v lidové hudbě po celém světě – v evropské, africké, asijské i americké tradici. V západní hudbě jsou dnes neodmyslitelně spojené s <b>blues, rockem, jazzem i improvizací</b>.",
    info_penta_popular_heading: "Proč jsou pentatoniky tak oblíbené",
    info_penta_popular_intro: "Omezený počet tónů znamená, že mezi nimi nevznikají silně konfliktní intervaly. Díky tomu se s pentatonikami:",
    info_penta_popular_item_1: "snadno improvizuje,",
    info_penta_popular_item_2: "melodie zní přirozeně i bez složité harmonie,",
    info_penta_popular_item_3: "hráč se může soustředit na výraz, rytmus a frázování.",
    info_penta_popular_outro: "Pentatonika je tak ideálním mostem mezi teorií a praxí.",
    info_penta_major_heading: "🎼 Durová pentatonika",
    info_penta_major_p1: "Durová pentatonika vychází z durové stupnice, ze které jsou vynechány dva tóny. Výsledkem je světle znějící, otevřená stupnice, která se často používá v lidové hudbě, popu i melodické improvizaci.",
    info_penta_major_example_intro: "Typickým příkladem je <b>C durová pentatonika</b>:",
    info_penta_major_example: "<b>C – D – E – G – A – C</b>",
    info_penta_major_traits_intro: "Durová pentatonika působí:",
    info_penta_major_trait_1: "optimisticky,",
    info_penta_major_trait_2: "stabilně,",
    info_penta_major_trait_3: "přehledně.",
    info_penta_minor_heading: "🎼 Mollová pentatonika",
    info_penta_minor_p1: "Mollová pentatonika je jednou z nejpoužívanějších stupnic v moderní hudbě. Vychází z mollového charakteru a má výraznější, syrovější zvuk než její durový protějšek.",
    info_penta_minor_example_intro: "Typickým příkladem je <b>A mollová pentatonika</b>:",
    info_penta_minor_example: "<b>A – C – D – E – G – A</b>",
    info_penta_minor_use_intro: "Mollová pentatonika je základem:",
    info_penta_minor_use_item_1: "bluesové a rockové improvizace,",
    info_penta_minor_use_item_2: "mnoha jazzových frází,",
    info_penta_minor_use_item_3: "melodického vyjadřování s výrazným napětím.",
    info_penta_blue_heading: "🎵 Blue note (blue tone)",
    info_penta_blue_p1: "V blues a příbuzných stylech se k mollové pentatonice často přidává ještě jeden tón – tzv. <b>blue note</b>. Tento tón vytváří typické bluesové napětí a „špinavější“ zvuk.",
    info_penta_blue_p2: "V případě A mollové pentatoniky je blue note tón: <b>E♭ (D♯)</b>.",
    info_penta_blue_p3: "Přidáním blue note vzniká <b>bluesová stupnice</b>, která kombinuje jednoduchost pentatoniky s výrazným napětím a charakterem.",
    info_penta_blue_p4: "Blue note se nepoužívá vždy stejně pevně jako ostatní tóny – často funguje jako <b>průchozí nebo výrazový tón</b>, který dodává melodii osobitost.",
    info_penta_demo_heading: "Vyzkoušej si rozdíly mezi pentatonikami",
    info_penta_mode_label: "Typ pentatoniky:",
    info_penta_mode_major: "Durová pentatonika",
    info_penta_mode_minor: "Mollová pentatonika",
    info_penta_mode_blue: "Mollová pentatonika + blue note",
    info_penta_root_label: "Výchozí tón:",
    info_penta_play: "Přehrát stupnici",
    info_relation_heading: "⚖️ Durová a mollová příbuznost",
    info_relation_p1: "Na první pohled může durová a mollová stupnice působit jako dva odlišné světy. Jedna zní světle a stabilně, druhá temněji a napjatě. Ve skutečnosti jsou ale <b>dur a moll úzce propojené</b> – sdílejí stejné tóny, stejné předznamenání a liší se hlavně tím, <b>kde mají svůj tónový střed</b>.",
    info_relation_rel_heading: "Příbuzné tóniny",
    info_relation_rel_intro: "Každá durová tónina má svou <b>příbuznou mollovou tóninu</b>. Tyto dvě tóniny:",
    info_relation_rel_item_1: "mají <b>stejné předznamenání</b>,",
    info_relation_rel_item_2: "používají <b>stejné tóny</b>,",
    info_relation_rel_item_3: "liší se pouze výchozím (základním) tónem.",
    info_relation_rel_examples_intro: "Například:",
    info_relation_rel_example_1: "<b>C dur</b> a <b>a moll</b> nemají žádné křížky ani béčka,",
    info_relation_rel_example_2: "<b>G dur</b> a <b>e moll</b> mají jeden křížek,",
    info_relation_rel_example_3: "<b>F dur</b> a <b>d moll</b> mají jedno béčko.",
    info_relation_rel_note: "Proto se těmto dvojicím říká <i>příbuzné</i>.",
    info_relation_center_heading: "Rozdíl není v tónech, ale v centru",
    info_relation_center_p1: "Rozdíl mezi durovou a mollovou příbuznou tóninou <b>není v tom, jaké tóny používají</b>, ale <b>jaký tón vnímáme jako hlavní</b> – jako místo návratu a odpočinku.",
    info_relation_center_intro: "Použijeme-li stejné tóny:",
    info_relation_center_item_1: "v C dur je středem tón <b>C</b>,",
    info_relation_center_item_2: "v a moll je středem tón <b>A</b>.",
    info_relation_center_note: "Hudba se tedy opírá o jiné těžiště, a právě to vytváří rozdílný charakter, i když se tóny shodují.",
    info_relation_signature_heading: "Proč mají stejné předznamenání",
    info_relation_signature_p1: "Předznamenání v notovém zápisu neurčuje, zda je skladba durová nebo mollová. Určuje pouze, <b>které tóny jsou v dané tónině trvale zvýšené nebo snížené</b>.",
    info_relation_signature_intro: "Proto:",
    info_relation_signature_item_1: "příbuzné dur a moll mají stejné křížky nebo béčka,",
    info_relation_signature_item_2: "a teprve kontext skladby (melodie, harmonie, závěr) rozhodne, zda hudbu vnímáme jako dur nebo moll.",
    info_relation_find_heading: "Jak příbuznost poznat v praxi",
    info_relation_find_intro: "Příbuznou mollovou tóninu k durové najdeme tak, že:",
    info_relation_find_item_1: "se posuneme o <b>tři půltóny (jeden a půl tónu) dolů</b> od základního tónu durové stupnice.",
    info_relation_find_examples_intro: "Například:",
    info_relation_find_example_1: "C dur → a moll",
    info_relation_find_example_2: "D dur → h moll",
    info_relation_find_example_3: "E♭ dur → c moll",
    info_relation_find_note: "Tento jednoduchý vztah je základem <b>kvintového kruhu</b>, ve kterém jsou příbuzné durové a mollové tóniny vždy zobrazeny vedle sebe.",
    info_relation_importance_heading: "Proč je tahle příbuznost důležitá",
    info_relation_importance_intro: "Jakmile pochopíš vztah mezi durovými a mollovými tóninami:",
    info_relation_importance_item_1: "přestanou být předznamenání matoucí,",
    info_relation_importance_item_2: "tóniny se začnou jevit jako propojený systém,",
    info_relation_importance_item_3: "a přechody mezi durem a mollem budou působit přirozeně a logicky.",
    info_relation_importance_outro: "Dur a moll tak nejsou protiklady, ale <b>dvě perspektivy téhož tónového materiálu</b>, mezi kterými se hudba může plynule pohybovat.",
    info_modes_heading: "🕯️ Církevní módy",
    info_modes_p1: "Církevní módy jsou <b>různé způsoby uspořádání tónů v rámci jedné stupnice</b>. Vycházejí ze stejného tónového materiálu, ale liší se tím, <b>který tón je považován za hlavní – za střed, ke kterému se hudba vztahuje</b>.",
    info_modes_p2: "Zatímco u durové nebo mollové stupnice je tento střed pevně daný, u módů se může posouvat. Právě tím vznikají různé zvukové barvy a charakter jednotlivých módů, i když používají stejné tóny.",
    info_modes_same_heading: "Stejné tóny, jiný střed",
    info_modes_same_intro: "Základní myšlenka církevních módů je jednoduchá:",
    info_modes_same_quote: "<b>Tóny zůstávají stejné, mění se jejich těžiště.</b>",
    info_modes_same_p1: "Pokud vezmeme například tóny stupnice C dur (C–D–E–F–G–A–H) a začneme je vnímat od jiného tónu než C, vznikne jiný mód – s jiným charakterem, napětím i výrazem.",
    info_modes_same_item_1: "<b>nepřidávají nové tóny</b>,",
    info_modes_same_item_2: "ale <b>mění způsob, jak je slyšíme a používáme</b>.",
    info_modes_history_heading: "Historický původ",
    info_modes_history_p1: "Církevní módy mají kořeny ve středověké hudbě, kde sloužily jako základ pro gregoriánský chorál a ranou evropskou hudbu. Každý mód měl svůj typický rozsah a charakter, který určoval, jak skladba působí.",
    info_modes_history_p2: "Později byly módy částečně vytlačeny dur-mollovým systémem, ale v moderní hudbě se znovu objevily – zejména v jazzu, filmové hudbě a improvizaci.",
    info_modes_list_heading: "Přehled základních církevních módů",
    info_modes_list_intro: "Tradičně rozlišujeme sedm základních módů. Všechny vycházejí ze stejného tónového materiálu (například z tónů C dur), ale liší se tím, <b>od kterého tónu se hudba „točí“ a kam má tendenci se vracet</b>.",
    info_modes_ionian_title: "<b>Ionický mód</b>",
    info_modes_ionian_text: "Odpovídá běžné <b>durové stupnici</b>. Pokud vezmeme tóny C dur (C–D–E–F–G–A–H) a jako hlavní tón vnímáme <b>C</b>, slyšíme klasický durový charakter. Hudba se přirozeně vrací na C a působí stabilně, jasně a vyrovnaně. Je nejběžnějším módem v západní hudbě a tvoří základ většiny známých melodií a skladeb.",
    info_modes_dorian_title: "<b>Dórský mód</b>",
    info_modes_dorian_text: "Vychází ze stejných tónů jako C dur, ale jako hlavní tón vnímáme <b>D</b> (D–E–F–G–A–H–C–D). Má mollový charakter, ale zní <b>světleji a otevřeněji</b> než běžná mollová stupnice. Hudba se točí kolem tónu D a často působí energicky, pohybově a „živě“. Často se používá v jazzu, funku a lidové hudbě.",
    info_modes_phrygian_title: "<b>Frygický mód</b>",
    info_modes_phrygian_text: "Při použití tónů C dur a vnímání tónu <b>E</b> jako hlavního (E–F–G–A–H–C–D–E) vzniká frygický mód. Zní <b>temně, napjatě a exoticky</b>, s velmi výrazným charakterem. Hudba má tendenci se vracet k E a vytváří silné napětí hned na začátku stupnice. V běžné popové hudbě se objevuje spíše výjimečně.",
    info_modes_lydian_title: "<b>Lydický mód</b>",
    info_modes_lydian_text: "Pokud z tónů C dur vytvoříme stupnici s hlavním tónem <b>F</b> (F–G–A–H–C–D–E–F), vzniká lydický mód. Zní <b>světle, otevřeně a vzdušně</b>. Hudba má pocit pohybu „nahoru“ a často působí optimisticky nebo snově. Používá se ve filmové hudbě a tam, kde je cílem vytvořit pocit prostoru nebo vznešenosti.",
    info_modes_mixolydian_title: "<b>Mixolydický mód</b>",
    info_modes_mixolydian_text: "Při vnímání tónu <b>G</b> jako hlavního (G–A–H–C–D–E–F–G) vzniká mixolydický mód. Vychází z durového charakteru, ale působí <b>uvolněněji a méně jednoznačně</b>. Hudba se často netlačí k silnému závěru a působí otevřeně. Je velmi častý v rocku, blues a folku.",
    info_modes_aeolian_title: "<b>Eolský mód</b>",
    info_modes_aeolian_text: "Pokud použijeme tóny C dur a jako hlavní tón vnímáme <b>A</b> (A–H–C–D–E–F–G–A), dostaneme eolský mód. Ten odpovídá <b>přirozené mollové stupnici</b>. Hudba se vrací k tónu A a působí melancholicky, vážně nebo zadumaně. Je jedním z nejčastěji používaných mollových módů.",
    info_modes_locrian_title: "<b>Lokrijský mód</b>",
    info_modes_locrian_text: "Při vnímání tónu <b>H</b> jako hlavního (H–C–D–E–F–G–A–H) vzniká lokrijský mód. Působí <b>nestabilně a nejistě</b>, protože postrádá pevný pocit návratu. V tradiční harmonii se používá jen zřídka, spíše jako teoretický nebo barevný prvek. Jeho charakter je výrazně napjatý a neukotvený.",
    info_modes_importance_heading: "Proč jsou módy důležité",
    info_modes_importance_intro: "Církevní módy pomáhají:",
    info_modes_importance_item_1: "rozšířit chápání duru a mollu,",
    info_modes_importance_item_2: "lépe porozumět charakteru skladeb,",
    info_modes_importance_item_3: "vědomě pracovat s náladou a barvou,",
    info_modes_importance_item_4: "improvizovat bez nutnosti měnit tónový materiál.",
    info_shift_heading: "🔁 Stejná stupnice v různých tóninách",
    info_shift_p1: "Na první pohled se může zdát, že každá stupnice je pevně svázaná s konkrétními tóny – že C dur je něco zásadně jiného než D dur nebo G dur. Při bližším pohledu ale vyjde najevo, že <b>podstatou stupnice nejsou konkrétní tóny, ale vztahy mezi nimi</b>.",
    info_shift_p2: "Každá stupnice má svou vnitřní strukturu – daný sled kroků mezi tóny. Tato struktura zůstává stejná, i když se celý tvar stupnice posune výš nebo níž. Změní se výchozí tón, ale <b>způsob, jakým jsou tóny uspořádány, zůstává zachovaný</b>.",
    info_shift_p3: "Právě díky tomu může existovat stejná stupnice v různých tóninách. Durová, mollová i další stupnice mohou začínat na různých tónech, mít odlišný zápis a jiný počet křížků či béček, ale přesto fungují podle stejných pravidel.",
    info_shift_list_intro: "Tento princip je jedním ze základů hudebního systému. Umožňuje:",
    info_shift_list_1: "hrát a zpívat skladby v různých výškách,",
    info_shift_list_2: "přizpůsobit hudbu rozsahu nástroje nebo hlasu,",
    info_shift_list_3: "pochopit, proč existují různé tóniny,",
    info_shift_list_4: "a orientovat se v dalších hudebních souvislostech, jako je kvintový kruh nebo harmonie.",
    info_shift_p4: "Jakmile si tento princip uvědomíš, přestanou být stupnice jen samostatnými seznamy tónů. Začneš je vnímat jako <b>různé podoby jednoho hudebního tvaru</b>, který se může volně pohybovat v tónovém prostoru.",
    info_shift_p5: "<b>A právě tím se kruh uzavírá:</b> stupnice nejsou cílem samy o sobě, ale nástrojem, díky kterému dává hudba smysl jako celek.",
    info_shift_enharm_heading: "Enharmonické stupnice",
    info_shift_enharm_p1: "Někdy se stejná stupnice zapisuje dvěma způsoby – zní stejně, ale používá jiné názvy tónů. Tomu se říká <b>enharmonický zápis</b>.",
    info_shift_enharm_p2: "O tom, který zápis zvolíme, rozhoduje hlavně kontext (předznamenání, harmonie), ne samotný zvuk.",
    info_shift_enharm_examples_intro: "Například:",
    info_shift_enharm_example_1: "<b>F♯ dur</b> a <b>G♭ dur</b> znějí stejně, ale mají jiné předznamenání.",
    info_shift_enharm_example_2: "<b>C♯ dur</b> a <b>D♭ dur</b> jsou enharmonické varianty téže stupnice.",
    info_shift_enharm_label_fsharp: "F♯ dur (enharmonický zápis)",
    info_shift_enharm_label_gflat: "G♭ dur (enharmonický zápis)",
    info_shift_pick: "Vyzkoušej si to v praxi: níže si přehraješ stejnou durovou stupnici v několika výchozích tónech a hned uslyšíš, co zůstává stejné a co se mění.",
    info_shift_play: "Přehrát stupnici",
    circle_intro_lead: "<strong>Kvintový kruh</strong> je vizuální pomůcka, která znázorňuje vztahy mezi durovými a mollovými stupnicemi, jejich předznamenáními a příbuzností.",
    circle_intro_p2: "Kruh je sestaven tak, že každý krok ve směru hodinových ručiček znamená posun o <strong>kvintu výš</strong> (např. z C dur na G dur), zatímco proti směru se posouváš o <strong>kvintu níž</strong>. Díky tomu vidíš, jak se stupnice mění a kolik mají křížků nebo béček.",
    circle_intro_p3: "Kvintový kruh ti pomůže lépe porozumět stavbě tónin, jejich příbuznosti i pohybu v harmonii.",
    circle_intro_p4: "Vyber libovolnou tóninu a sleduj, jak se mění její vlastnosti.",

    // Scales list / detail
    scales_title: "Seznam (přirozená moll ↔ příbuzná durová)",
    scales_tbl_moll: "moll",
    scales_tbl_major: "durová",
    scales_tbl_acc: "předznamenání",
    scales_table_intro: "V tabulce najdeš dvojice přirozených mollových stupnic a jejich příbuzných durových variant včetně počtu předznamenání. Klikni na libovolnou stupnici a zobrazí se ti detail se zápisem, tónovým obsahem i souvisejícími variantami.",
    detail_back: "← Zpět",

    dynamics_title: "Jak funguje dynamika",
    dynamics_annotation: "Značky pro hlasitost a její změny – p, f, crescendo, diminuendo a práce s výrazem.",
    expressions_title: "Výrazy v hudbě",
    expressions_annotation: "Základní italské výrazy pro tempo a náladu (allegro, andante, dolce, espressivo…).",
    harmony_functions_title: "Role tónů v tónině",
    harmony_functions_note: "Funkce stupňů v tónině – tonika, subdominanta, dominanta a role ostatních stupňů.",
    harmony_cadences_title: "Jak fungují kadence",
    harmony_cadences_note: "Základní typy kadencí (autentická, plagální, poloviční) a jejich použití.",
    harmony_progressions_title: "Akordové postupy v tónině",
    harmony_progressions_note: "Typické posloupnosti akordů (I–IV–V, II–V–I…) a jejich využití při tvorbě harmonie.",
    harmony_modulation_title: "Jak přecházet mezi tóninami",
    harmony_modulation_note: "Jednoduché přechody mezi příbuznými tóninami a základní modulační obraty.",
    improv_basics_title: "Základy improvizace",
    improv_basics_note: "Jak začít improvizovat v rámci tóniny – jednoduché strategie a práce s frázemi.",
    improv_pentatonic_title: "Pentatonika v praxi",
    improv_pentatonic_note: "Použití durové a mollové pentatoniky v praxi, základní patterny a linky.",
    improv_target_notes_title: "Cílové tóny a jejich využití",
    improv_target_notes_note: "Zaměřování na tóny akordu, zakončování frází a vytváření pocitu rozuzlení.",
    reading_title: "Hudební základy",
    reading_intro: "Jak číst noty, rozumět rytmu, dynamice i hudebním výrazům – a hned si je vyzkoušet v jednoduchých trénincích.",
    reading_theory_heading: "Teorie",
    reading_theory_staff_title: "Jak číst noty",
    reading_theory_staff_desc: "Základy notové osnovy, čar, mezer a klíčů (houslový, basový).",
    reading_staff_intro: "🎼 Noty nejsou jen značky — jsou jazykem hudby. Stejně jako písmena tvoří slova, noty skládají melodie. Umět je číst znamená rozumět řeči hudby – a díky tomu si ji víc užít, přesněji zaznamenat, nebo svobodněji tvořit. Ať už hraješ na nástroj, zpíváš nebo skládáš, pochopení notového zápisu ti otevře nové možnosti. <BR><BR> Objev, jak funguje pět linek notové osnovy a jak klíč posouvá názvy tónů.",
    reading_staff_section_staff: "Osnova",
    reading_staff_section_clefs: "Klíče",
    reading_staff_section_compare: "Proč je to důležité",
    reading_staff_clef_treble: "Houslový klíč",
    reading_staff_clef_bass: "Basový klíč",
    reading_staff_clef_alto: "Altový klíč",
    reading_staff_clef_tenor: "Tenorový klíč",
    reading_staff_clefs_intro: "🎼 Hudební klíče pomáhají určit, jaké tóny odpovídají jednotlivým linkám a mezerám v notové osnově. Bez klíče bychom nevěděli, kde leží třeba tón C nebo G – protože stejná nota může být zapsaná různě, v závislosti na výšce a rozsahu nástroje. Díky klíčům může každý nástroj číst noty v rozsahu, který mu nejlépe vyhovuje, a předejde se zbytečným pomocným linkám. <BR><BR>Vyber klíč a sleduj, kam umístí c1.",
    reading_staff_overview_heading: "📝 Co všechno najdeme v notové osnově?",
    reading_staff_overview_intro: "Notová osnova slouží k přehlednému zápisu hudby. Najdeš v ní několik stavebních kamenů, které dohromady určují, co a jak se hraje:",
    reading_staff_overview_item_keys: "<strong>Klíče</strong> – určují, jak přiřadíme linkám a mezerám názvy tónů.",
    reading_staff_overview_item_notes: "<strong>Noty</strong> – značky pro tóny určité výšky a délky.",
    reading_staff_overview_item_rests: "<strong>Pomlky</strong> – značky pro pauzy, tedy místa bez zvuku.",
    reading_staff_overview_item_accidentals: "<strong>Předznamenání</strong> – Značky za klíčem, které na začátku zápisu určují, které tóny se mají v celé skladbě hrát zvýšeně (s křížkem) nebo sníženě (s béčkem) o půl tónu. Na rozdíl od náhodných posuvek platí pro všechny stejné tóny napříč takty – určují tóninu skladby. Ojedinělé změny výšky tónu se značí samostatnými posuvkami (křížky a béčka přímo u noty).",
    reading_staff_overview_item_bars: "<strong>Taktové čáry</strong> – Svislé čáry, které rozdělují notový zápis do úseků (taktů). Pomáhají udržet rytmus a zpřehledňují strukturu hudby.",
    reading_staff_overview_item_ledger: "<strong>Pomocné linky</strong> – krátké čáry nad nebo pod osnovou pro extrémně vysoké nebo hluboké tóny, které by se jinak nevešly.",
    reading_staff_overview_linespaces: "Nota na lince protíná čáru, nota v mezeře naopak leží mezi linkami. Pět linek a čtyři mezery vytvářejí jasnou mřížku pro zápis tónů a pomocné linky ji podle potřeby rozšiřují.",
    reading_staff_desc_treble: "Tento klíč označuje druhou linku jako tón G1. Používá se pro vyšší nástroje, jako je housle, flétna, hoboj, trubka nebo pravá ruka klavíru.",
    reading_staff_desc_bass: "Tento klíč označuje čtvrtou linku jako tón F. Je vhodný pro nižší nástroje, jako je violoncello, fagot, trombon, tuba nebo levá ruka klavíru.",
    reading_staff_desc_alto: "Altový klíč označuje prostřední (třetí) linku jako tón C1. Používá se především pro violu.",
    reading_staff_desc_tenor: "Tenorový klíč označuje čtvrtou linku jako tón C1. Využívá se méně často, např. pro fagot, trombon nebo violoncello v tenorovém rejstříku.",
    reading_staff_hover_hint: "Najdi linky a mezery – přejeď myší nebo klepni pro zvýraznění.",
    reading_staff_slot_line_1: "1. linka",
    reading_staff_slot_line_2: "2. linka",
    reading_staff_slot_line_3: "3. linka (střed)",
    reading_staff_slot_line_4: "4. linka",
    reading_staff_slot_line_5: "5. linka",
    reading_staff_slot_space_1: "Mezera mezi 1. a 2. linkou (nad 1. linkou)",
    reading_staff_slot_space_2: "Mezera mezi 2. a 3. linkou (pod 3. linkou)",
    reading_staff_slot_space_3: "Mezera mezi 3. a 4. linkou",
    reading_staff_slot_space_4: "Mezera mezi 4. a 5. linkou",
    reading_staff_compare_text: "Stejný tón se v různých klíčích zapisuje na jiné pozici. Níže vidíš c1 v houslovém a basovém klíči.",
    reading_staff_compare_treble: "Houslový klíč – c1 pod osnovou",
    reading_staff_compare_bass: "Basový klíč – c1 nad osnovou",
    reading_notes_intro_heading: "Seznam se s oktávami",
    reading_notes_intro_p1: "Hudba zní v různých výškách — od hlubokých tónů kontrabasu po vysoké tóny pikoly. Abychom se v tom vyznali, rozdělujeme tóny do skupin podle výšky. Těmto skupinám říkáme <strong>oktávy</strong>.",
    reading_notes_intro_p2: "Každá oktáva má své vlastní označení – například „malá“, „velká“ nebo „jednočárková“. Když tyto názvy spojíme s konkrétním tónem, získáme přesné označení výšky – například <strong>c1</strong> označuje tón C v jednočárkové oktávě, zatímco <strong>C</strong> je tón C ve velké oktávě.",
    reading_notes_intro_p3: "Tento způsob zápisu nám umožňuje rozeznat, o jak vysoko nebo nízko položený tón jde, i když má stejné jméno jako jiný tón v jiné oktávě.",
    reading_notes_intro_p4: "V přehledu níže najdeš všechny běžně používané oktávy a jejich rozsahy. Navíc tu uvidíš i překryvné tóny, aby bylo jasné, jak na sebe oktávy plynule navazují — jsou záměrně zesvětlené, aby se odlišily od hlavního rozsahu.",
    reading_notes_map_play: "Přehrát oktávu",
    detail_scale_play: "Přehrát stupnici",
    reading_staff_summary: "Tóny nejsou v notové osnově pevně dané – klíč určuje, které linky a mezery patří konkrétním názvům. Jakmile si je osvojíš, čtení not půjde hladce.",
    reading_staff_cta: "Začněte cvičit čtení not",
    reading_theory_notes_title: "Kde leží tóny",
    reading_theory_notes_desc: "Mapa oktáv s tóny od kontra po tříčárkovanou.",
    reading_theory_rhythm_title: "Jak funguje rytmus",
    reading_theory_rhythm_desc: "Délky not a pomlk, takt a rytmické členění.",
    reading_theory_accidentals_title: "Křížky, béčka a spol.",
    reading_theory_accidentals_desc: "Předznamenání a posuvky v notovém zápisu.",
    reading_theory_accidentals_annotation: "Křížky, béčka, posuvky a předznamenání, jejich zápis a vliv na výšku tónu.",
    reading_acc_intro_text: "Křížky, béčka a další posuvky jsou značky, které mění výšku tónů. Díky nim může hudba znít různě — může být vyšší, nižší, světlejší, temnější nebo napjatější. Abychom pochopili, proč posuvky existují a jak se používají, musíme nejdřív vědět, co jsou půltóny.",
    reading_acc_halfstep_title: "Půltóny – nejmenší krok v hudbě",
    reading_acc_halfstep_p1: "Půltón je nejmenší běžná vzdálenost mezi dvěma tóny v západní hudbě. Je to nejkratší krok, kterým se může tón posunout nahoru nebo dolů — něco jako „nejmenší možný krok“ mezi dvěma notami.",
    reading_acc_halfstep_p2a: "Abychom to správně pochopili, musíme nejprve vědět, že <strong>notová osnova standardně obsahuje pouze základní tóny bez posuvek</strong>. Když se podíváš na zápis v osnově, uvidíš jen tyto tóny:",
    reading_acc_halfstep_p2b_intro: "To ale nejsou všechny tóny, které v hudbě existují — mezi některými z těchto tónů je prostor pro další tóny, které v zápisu bez posuvky nevidíš. A právě tady přichází na řadu půltóny.",
    reading_acc_halfstep_p2c_intro: "Než si ukážeme samotné posuvky, je důležité pochopit, že:",
    reading_acc_halfstep_p2b_item1: "mezi některými sousedními tóny je <strong>celý tón</strong> – tedy vzdálenost dvou půltónů,",
    reading_acc_halfstep_p2b_item2: "mezi jinými je <strong>půltón přímo</strong>, bez jakéhokoli „prostoru navíc“.",
    reading_acc_halfstep_p3: "Než si ukážeme samotné posuvky, je důležité pochopit, že: <strong>mezi některými sousedními tóny je celý tón – tedy vzdálenost dvou půltónů, mezi jinými je půltón přímo</strong>, bez jakéhokoli „prostoru navíc“.",
    reading_acc_halfstep_line: "Základní řada tónů v zápisu: <strong>C – D – E – F – G – A – H – C</strong>. Na první pohled vypadá pravidelně, ale skrývá v sobě dvě důležité výjimky.",
    reading_acc_halfstep_natural_heading: "V západní hudbě vychází řada základních tónů z historického ladění a z přirozených akustických vztahů mezi tóny. Při střídání tónů C–D–E–F–G–A–H–C najdeme dva páry, kde už mezi tóny <strong>přirozeně</strong> existuje půltón:",
    reading_acc_halfstep_natural_item1: "mezi <strong>E a F</strong>,",
    reading_acc_halfstep_natural_item2: "mezi <strong>H a C</strong>.",
    reading_acc_halfstep_natural_text: "Důvod není žádná magie — tyto dvojice tónů jsou si jednoduše tak blízko, že mezi nimi <em>už není žádný další tón, který by dávalo smysl pojmenovat a zapisovat</em>. Kdybys měl klavír před sebou, poznáš to okamžitě: mezi E–F a H–C <strong>není černá klávesa</strong>, protože hudba na těchto místech žádnou „<strong>meziklávesu</strong>“ nepotřebuje. Je to historicky ustálená vlastnost naší hudby, a proto ji dnes používáme jako samozřejmý základ.",
    reading_acc_step_type: "Typ kroku",
    reading_acc_step_from: "Od tónu",
    reading_acc_step_to: "K tónu",
    reading_acc_step_half: "půltón",
    reading_acc_step_whole: "celý tón",
    reading_acc_halfstep_table_note: "Tato tabulka ukazuje, kde jsou dva přirozené půltóny – mezi E–F a H–C. Všechny ostatní sousední tóny v základní řadě jsou od sebe vzdálené celý tón. Z tohoto schématu pak vycházejí stupnice, posuvky a celá tonalita západní hudby.",
    reading_acc_halfstep_piano: "Na klavíru je to vidět tak, že mezi těmito dvojicemi chybí černá klávesa.",
    reading_acc_halfstep_play_heading: "Přehrávej si sousední tóny a zkus, jestli uslyšíš rozdíl mezi tónem a půltónem:",
    reading_acc_halfstep_play_hint: "(Zobrazí se krátký úsek notové osnovy s houslovým klíčem a dvěma notami vedle sebe — nejprve základní dvojice, poté s posuvkou.)",
    reading_acc_pair_ef: "E → F (půltón)",
    reading_acc_pair_fg: "F → G (celý tón)",
    reading_acc_pair_hc: "H → C (půltón)",
    reading_acc_pair_cd: "C → D (celý tón)",
    reading_acc_action_play: "Přehrát",
    reading_acc_accidentals_title: "Co jsou posuvky?",
    reading_acc_accidentals_rich: "<p>Posuvky jsou značky, které mění výšku tónů v notovém zápisu. Umožňují nám použít tóny, které v základní řadě <strong>C–D–E–F–G–A–H–C</strong> nejsou vidět, ale v hudbě běžně existují. Díky nim může melodie znít jemněji, napjatěji, světleji nebo temněji — protože i malá změna o půltón dokáže tón výrazně ovlivnit.</p><p>Zvýšení nebo snížení tónu se zapisuje před notu a tón se podle toho čte i hraje jinak. Příklad:</p><ul class=\"list\"><li><strong>C → C♯ (cis)</strong> = tón zvýšený o půltón</li><li><strong>D → D♭ (des)</strong> = tón snížený o půltón</li></ul><p>I když k zápisu používáme různé značky, vždy mluvíme jen o malých posunech ve výšce tónu – o půltón nebo o celý tón.</p><h5 class=\"h5\">Jak se tyto tóny čtou?</h5><p>V češtině mají zvýšené a snížené tóny vlastní názvy.</p><h5 class=\"h5\">Zvýšené tóny (♯ – křížek)</h5><p>Přidává se koncovka -is:</p><ul class=\"list\"><li><strong>C♯ = cis</strong></li><li><strong>D♯ = dis</strong></li><li><strong>E♯ = eis</strong></li><li><strong>F♯ = fis</strong></li><li><strong>G♯ = gis</strong></li><li><strong>A♯ = ais</strong></li><li><strong>H♯ = his</strong></li></ul><h5 class=\"h5\">Snížené tóny (♭ – béčko)</h5><p>Přidává se koncovka -es, u některých tónů zjednodušeně -s:</p><ul class=\"list\"><li><strong>C♭ = ces</strong></li><li><strong>D♭ = des</strong></li><li><strong>E♭ = es</strong></li><li><strong>F♭ = fes</strong></li><li><strong>G♭ = ges</strong></li><li><strong>A♭ = as</strong></li><li><strong>H♭ = b</strong> (výjimka v označení i výslovnosti)</li></ul><h5 class=\"h5\">Proč některé tóny znějí stejně, i když se zapisují různě?</h5><p>Tohle je klíčová představa: <strong>půltón mezi dvěma tóny je vždy stejně velký, takže tón můžeš „dostat“ z různých stran.</strong></p><ul class=\"list\"><li><strong>C♯ (cis) a D♭ (des)</strong> znějí naprosto stejně</li><li><strong>F♯ (fis) = G♭ (ges)</strong></li><li><strong>E♯ (eis) = F</strong></li><li><strong>H♭ (b) = A♯ (ais)</strong></li></ul><p>Tomuto jevu se říká <strong>enharmonická záměna</strong>. Hudba tak umožňuje zapsat stejný tón dvěma (nebo i více) způsoby — podle toho, co se lépe hodí do stupnice, harmonie nebo do melodického vedení.</p><h5 class=\"h5\">Může mít posuvku i tón, který už je půltónem?</h5><p>Ano — a je důležité to vědět.</p><p>Přirozené půltóny jsou jen dva: E–F a H–C. Ale i ty můžeš pomocí posuvek zvýšit nebo snížit:</p><ul class=\"list\"><li><strong>E → E♯ (eis)</strong> = zní jako F</li><li><strong>F → F♭ (fes)</strong> = zní jako E</li><li><strong>H → H♯ (his)</strong> = zní jako C</li><li><strong>C → C♭ (ces)</strong> = zní jako H</li></ul><p>To ukazuje, že posuvky nejsou jen „mezi dvěma tóny“, ale mohou tón posunout kamkoli.</p><h5 class=\"h5\">🔊 Jak funguje půltón — poslech a vizuální ukázka</h5><p>Přehraj si dvojice tónů a sleduj jejich zápis v notách. Nejprve zazní dva sousední základní tóny bez změny. Poté uslyšíš stejnou dvojici doplněnou o půltón — buď zvýšený (křížek), nebo snížený (béčko).</p><p>Vnímej, jak půltón vyplní prostor mezi dvěma tóny:</p><ul class=\"list\"><li>zvukově vytvoří jemný krok navíc,</li><li>vizuálně se v notách objeví posuvka, která tón posune o malý, „nejmenší možný“ interval.</li></ul>",
    reading_acc_sharp_title: "Křížek ♯ — zvýšení o půltón",
    reading_acc_sharp_p: "Křížek zvýší tón o jeden půltón.",
    reading_acc_sharp_examples: "Příklady: C → C♯, F → F♯, D → D♯",
    reading_acc_sharp_demo: "",
    reading_acc_sharp_plain: "C – D",
    reading_acc_sharp_raised: "C – C♯ – D",
    reading_acc_flat_title: "Béčko ♭ — snížení o půltón",
    reading_acc_flat_p: "Béčko sníží tón o jeden půltón.",
    reading_acc_flat_examples: "Příklady: A → A♭, E → E♭",
    reading_acc_flat_demo: "",
    reading_acc_flat_plain: "A – G",
    reading_acc_flat_lowered: "A – A♭ – G",
    reading_acc_flat_hint: "Uživatel slyší A → A♭ a poznává pokles o půltón.",
    reading_acc_doubles_title: "Existují ale i složitější varianty:",
    reading_acc_double_sharp: "Dvojkřížek × — zvýšení o celý tón",
    reading_acc_double_sharp_examples: "Zvýší tón o dva půltóny: F → F× (zní jako G), C♯ → C× (zní jako D). Čte se s příponou -is i pro zdvojení: Fis → Fisis, Cis → Cisis (čti: cisís).",
    reading_acc_double_flat: "Dvojbé ♭♭ — snížení o celý tón",
    reading_acc_double_flat_examples: "Sníží tón o celý tón: H♭ → H♭♭ (zní jako A), E♭ → E♭♭ (zní jako D). Čte se s příponou -es i pro zdvojení: H♭ = b → H♭♭ = bb (heses).",
    reading_acc_chromatic_title: "Zobrazení půltónů v notové osnově",
    reading_acc_chromatic_intro: "Tóny mezi C a dalším C lze zapsat dvěma způsoby — pomocí křížků nebo pomocí béček. Oba zápisy mají stejné zvukové výsledky, ale používají se v různých situacích (jiné stupnice, jiná harmonie, jiný směr melodie). Proto nestačí mít jen jednu sadu posuvek. Hudba potřebuje oba způsoby zápisu.",
    reading_acc_spelling_sharp: "Křížkový zápis",
    reading_acc_spelling_flat: "Béčkový zápis",
    reading_acc_chromatic_text: "Obě řady <strong>zní úplně stejně</strong>, ale jejich zápis se liší. To ukazuje, že posuvky mají víc než jednu podobu a že hudba připouští různé zápisy téhož zvuku.",
    reading_acc_chromatic_hint: "",
    reading_acc_chromatic_play: "Přehrát řadu",
    reading_acc_scale_title: "Stejná řada tónů v různých výškách",
    reading_acc_scale_intro: "Tady je základní řada C–D–E–F–G–A–H–C. Přepni zápis křížky/béčky a posouvej ji po půltónech – tvar řady (intervalový vzorec celý–celý–půl–celý–celý–celý–půl) zůstává stejný, jen zní výš nebo níž.",
    reading_acc_scale_note: "Rozsah je od c<sub>1</sub> do c<sub>2</sub>. Posuvky se mění podle toho, kam řadu posuneš. (Někdy výsledek sedí na reálnou durovou stupnici, jindy je to jen posunutá řada tónů bez ohledu na zápis tóniny.)",
    reading_acc_scale_label: "Začátek řady",
    reading_acc_scale_down: "− půltón",
    reading_acc_scale_up: "+ půltón",
    reading_acc_scale_play: "Přehrát řadu",
    reading_acc_keyboard_title: "Vyzkoušej si tóny na klaviatuře",
    reading_acc_keyboard_intro: "Klikni na libovolnou bílou nebo černou klávesu a poslouchej. Nad klaviaturou se hned ukáže nota a pomocí přepínače křížkový/béčkový zápis uvidíš stejný tón ve dvou zápisech — třeba F♯ jako G♭.",
    reading_acc_keyboard_text: "Jedna klaviatura, dva zápisy: stejný tón můžeš číst jako F♯ i G♭ podle kontextu skladby.",
    reading_acc_signature_title: "Posuvky vs. předznamenání",
    reading_acc_signature_intro: "Posuvky a předznamenání vypadají na první pohled podobně — oba typy značek využívají křížky (♯), béčka (♭). Jejich význam v notovém zápisu je ale úplně jiný. Abychom přesně porozuměli, jak se mezi nimi rozhoduje skladatel i interpret, podívejme se na ně podrobněji.",
    reading_acc_signature_acc_heading: "Posuvka",
    reading_acc_signature_p1: "Posuvka je <strong>místní změna výšky tónu</strong>. Zapíše se <strong>přímo před konkrétní notu</strong> a říká: „tento tón má znít jinak než obvykle.“ Platí <strong>jen v rámci jednoho taktu</strong>. Ovlivňuje všechny výskyty stejného tónu v témže taktu. Na začátku dalšího taktu její účinek mizí.",
    reading_acc_signature_p2: "Kdy se používá? když melodie potřebuje krátké zvýšení nebo snížení tónu, když chceme vytvořit chromatický postup, když nechceme měnit charakter celé skladby, ale jen jeden okamžik.",
    reading_acc_signature_key_heading: "Předznamenání",
    reading_acc_signature_p3: "Předznamenání je <strong>trvalé pravidlo pro celý notový řádek</strong>, které se zapisuje <strong>na začátku osnovy</strong> hned za klíčem. Určuje, které tóny budou <strong>automaticky</strong> zvýšeny nebo sníženy vždy, když se vyskytují. Platí až do konce řádku. Na další řádce se znovu zopakuje, aby bylo jasno, v jaké tónině skladba pokračuje",
    reading_acc_signature_p4: "Není to náhodné! Výběr křížků nebo béček v předznamenání není libovolný. Každá kombinace vychází z konkrétní stupnice, která má svůj přesný vzorec půltónů a celých tónů. Proto má například G dur jeden křížek a F dur jeden béčkový — je to dáno stavbou jejich stupnic (vysvětleno v kapitole o stupnicích).",
    reading_acc_signature_p5: "Předznamenání se zapisuje <strong>na stejnou výškovou linku nebo mezeru</strong>, kde by v osnově ležela nota, kterou mění. Díky tomu je hned vidět, kterého tónu se změna týká – křížek u F je vždy ve výšce F, béčko u B (H♭) vždy ve výšce H.",
    reading_acc_signature_p6: "Co to znamená prakticky? Když má skladba například jeden křížek (♯), znamená to, že <strong>každé F</strong> je ve skutečnosti <strong>F♯</strong>, aniž by se muselo opakovaně zapisovat posuvkou.",
    reading_acc_signature_p7: "Předznamenání tedy říká: „Tahle skladba je vystavěná tak, že některé tóny mají být od začátku zvýšené nebo snížené.“ Je to součást tóniny – k té se dostaneme později. Jak to poznáš v zápisu? Pokud má nota před sebou kříže nebo béčko: je to posuvka. Pokud jsou křížky nebo béčka umístěné na začátku řádku: je to předznamenání. Předznamenání je tedy „dlouhodobé nastavení“, zatímco posuvka je „krátkodobá úprava jednotlivého tónu“. Oba zápisy se často kombinují, protože skladba může mít trvalé zvýšení nebo snížení některých tónů, ale zároveň může potřebovat i výjimky.",
    reading_acc_signature_p8: "Zde uvidíš ukázku dvou zápisů stejného taktu – jednou pomocí předznamenání a podruhé pomocí posuvek u každé noty. Oba zápisy znějí naprosto stejně, ale vypadají jinak. Díky tomu je krásně vidět, kdy je praktičtější použít předznamenání (když se změna týká celé skladby) a kdy posuvky (když jde jen o jednotlivé tóny v taktu).",
    reading_acc_signature_staff_signature: "Předznamenání",
    reading_acc_signature_staff_acc: "Posuvky u každé noty",
    reading_acc_natural_title: "Odrazka ♮ — návrat do původní výšky",
    reading_acc_natural_text: "Odrazka ♮ je <strong>speciální posuvka</strong>, která ruší předchozí zvýšení nebo snížení tónu. Vrací notu zpět do její <strong>původní přirozené výšky</strong>, tedy do podoby bez posuvek.",
    reading_acc_natural_scope: "Platí – stejně jako ostatní posuvky – <strong>jen v rámci jednoho taktu</strong>. Na začátku nového taktu už její účinek neplatí.",
    reading_acc_natural_demo_intro: "<strong>Podívej se na krátkou ukázku</strong>, kde je vidět, jak spolu funguje předznamenání, odrazka a jednorázová posuvka. Sleduj, co platí v rámci taktu a co se vynuluje na další takt — a hlavně si to několikrát poslechni.",
    reading_acc_cautionary_title: "Speciální případ: připomínková posuvka",
    reading_acc_cautionary_text: "Existuje ještě jedna podoba posuvky — tzv. <strong>připomínková posuvka</strong> (angl. <strong>cautionary accidental</strong>). Může to být křížek, béčko i odrazka, ale její smysl je vždy stejný: <br/><br/><strong>nezmění výšku tónu</strong><br/><br/>jen <strong>upozorní hráče</strong> na informaci, která už platí (např. že tón zůstává zvýšený/snížený, nebo že se vrací k přirozené podobě),<br/>používá se hlavně tam, kde by se změna mohla snadno přehlédnout — po delší pauze, při skoku v melodii, na začátku nového řádku nebo v hustém zápisu. <br/>V notách vypadá stejně jako běžná posuvka, ale je <strong>čistě orientační</strong> — hraje se pořád to, co by bez ní platilo. Přidává se pro čitelnost a jistotu v rychlých nebo komplikovaných pasážích.",
    reading_acc_cautionary_demo_intro: "V ukázce níže má odrazka ve druhém taktu jen připomínkovou funkci — zní úplně stejně, jako by tam nebyla.",
    reading_theory_articulation_title: "Jak zahrát tón",
    reading_theory_articulation_desc: "Způsoby hraní tónu – legato, staccato, tenuto, akcent a frázování.",
    reading_theory_articulation_annotation: "Způsoby hraní tónu – legato, staccato, tenuto, akcent a základní frázování.",
    reading_theory_marks_title: "Značky pro rytmus",
    reading_theory_marks_desc: "Rytmické značky a členění zápisu.",
    reading_theory_marks_annotation: "Značky určující rytmus a členění – ligatury, pomlky, spojování not, taktové čáry.",
    reading_theory_navigation_title: "Značky pro orientaci",
    reading_theory_navigation_desc: "Jak se v notách rychle zorientovat.",
    reading_theory_navigation_annotation: "Značky pro opakování a skoky v notách – D.C., D.S., Coda, Fine a další orientační prvky.",
    reading_rhythm_intro_tagline: "Jak dlouho nota trvá a jak se její délka zapisuje.",
    reading_rhythm_intro_heading: "Co je to rytmus?",
    reading_rhythm_intro_p1: "Rytmus je základní prvek hudby – určuje, kdy zazní jednotlivé tóny a jak dlouho znějí.",
    reading_rhythm_intro_p2: "Délka noty se měří na pomyslné jednotky zvané doby. Můžeš si je představit jako pravidelné kroky, úder metronomu nebo tlesknutí ruky.",
    reading_rhythm_intro_p3: "Některé noty znějí přes jednu dobu (čtvrťová), jiné přes dvě nebo čtyři doby (půlová, celá) a krátké noty jen půl či čtvrt doby (osminová, šestnáctinová).",
    reading_rhythm_intro_p4: "Doby se pravidelně seskupují do taktů, takže hudba má rytmický rámec. V této sekci uvidíš, jak se jednotlivé délky zapisují, jak se sčítají a jak znějí.",
    reading_rhythm_structure_heading: "Stavba noty a její vliv na délku",
    reading_rhythm_structure_intro: "Každá nota může mít několik částí – hlavičku, nožku a praporek. Podle toho, které z nich obsahuje, se mění její délka.",
    reading_rhythm_structure_step_head: "Hlavička – celá nota",
    reading_rhythm_structure_step_head_desc: "Bez nožky zní plné 4 doby.",
    reading_rhythm_structure_step_stem: "Hlavička + nožka – půlová nota",
    reading_rhythm_structure_step_stem_desc: "Přidáním nožky se délka zkrátí na 2 doby.",
    reading_rhythm_structure_step_fill: "Vyplněná hlavička – čtvrťová nota",
    reading_rhythm_structure_step_fill_desc: "Vybarvení hlavičky zkrátí délku na 1 dobu.",
    reading_rhythm_structure_step_flag: "Jeden praporek – osminová nota",
    reading_rhythm_structure_step_flag_desc: "Praporek půlí dobu na ½.",
    reading_rhythm_structure_step_double: "Dva praporky – šestnáctinová nota",
    reading_rhythm_structure_step_double_desc: "Každý další praporek dobu opět půlí.",
    reading_rhythm_part_head: "Hlavička",
    reading_rhythm_part_stem: "Nožka",
    reading_rhythm_part_flag: "Praporek",
    reading_rhythm_structure_note: "Nota může mít i více praporků – každý další zkrátí trvání na polovinu předchozí hodnoty.",
    reading_rhythm_notes_heading: "Noty v notové osnově",
    // === Noty v notové osnově ===
    reading_rhythm_stems_heading: "Směr nožky",
    reading_rhythm_stems_sub: "Jak se nožka noty orientuje v notové osnově",
    reading_rhythm_stems_text: "Směr nožky se řídí <strong>polohou noty</strong> v notové osnově – u not umístěných <strong>níž</strong> směřuje nožka <strong>nahoru</strong>, u not <strong>výš položených</strong> směřuje <strong>dolů</strong>. Tento směr neovlivňuje délku tónu, slouží pouze k <em>lepší čitelnosti</em> zápisu.",
    reading_rhythm_stems_note: "Střední hranicí bývá obvykle <strong>třetí linka osnovy</strong> – noty pod ní mají nožku nahoru, nad ní dolů.",

    // === Spojování not ===
    reading_rhythm_beams_heading: "Spojování not praporky a trámci",
    reading_rhythm_beams_sub: "Jak se zapisují kratší rytmy",
    reading_rhythm_beams_text: "Kratší noty (např. <strong>osminy</strong> nebo <strong>šestnáctiny</strong>) se spojují do skupin pomocí <strong>trámců</strong> – vodorovných čárek mezi nožkami. Dvě osminy mají jeden trámec, šestnáctiny dva. Pokud jsou napsané samostatně, mají místo trámce <strong>praporek</strong> – zakřivený ocásek na konci nožky.",
    reading_rhythm_beams_note: "Spojování not trámci <em>zjednodušuje čtení rytmu</em> – skupiny tak lépe ukazují členění do dob.",
    reading_rhythm_tuplet_heading: "Dělené rytmy – trioly, kvartoly, kvintoly",
    reading_rhythm_tuplet_text: "<strong>Dělené rytmy</strong> ukazují, jak do stejného času vmáčknout více not. Triola (3 místo 2), kvartola (4 místo 3) i kvintola (5 místo 4) mění hustotu úderů, ale časový rámec taktu zůstává stejný.",
    reading_rhythm_tuplet_meaning_heading: "Co znamená dělení rytmu",
    reading_rhythm_tuplet_meaning_p1: "V běžném rytmu se doby dělí <strong>rovnoměrně</strong> – třeba čtvrťová doba se rozdělí na dvě osminy, každá trvá polovinu.",
    reading_rhythm_tuplet_meaning_p2: "<strong>Dělené rytmy</strong> jsou „nepravidelná“ dělení: místo dvou not zahraješ tři, místo tří čtyři…",
    reading_rhythm_tuplet_meaning_p3: "Každá nota je o něco kratší, aby se <strong>celý útvar přesně vešel do stejného času</strong>.",
    reading_rhythm_tuplet_meaning_figure_label: "Porovnání rovného dělení a trioly",
    reading_rhythm_tuplet_meaning_even: "Rovné dělení – dvě osminy",
    reading_rhythm_tuplet_meaning_even_desc: "Dvě stejně dlouhé poloviny jedné doby.",
    reading_rhythm_tuplet_meaning_triplet: "Triola – tři osminy",
    reading_rhythm_tuplet_meaning_triplet_desc: "Tři údery ve stejném čase jako dvě rovné osminy.",
    reading_rhythm_tuplet_hero_even_three: "3 rovné osminy",
    reading_rhythm_tuplet_hero_even_four: "4 rovné osminy",
    reading_rhythm_tuplet_row_toggle: "Přehrát / pozastavit řádek",
    reading_rhythm_tuplet_how_heading: "Jak to funguje",
    reading_rhythm_tuplet_how_text: "Představ si takt se dvěma osminami. Když místo nich zahraješ <strong>triolu</strong>, každá nota trvá jen <strong>⅔ běžné osminy</strong>. Stejný princip platí i pro kvartoly (4 místo 3) a kvintoly (5 místo 4) – rytmus se rozdělí jemněji, ale časový rámec zůstává.",
    reading_rhythm_tuplet_table_col_division: "Dělení",
    reading_rhythm_tuplet_table_col_count: "Kolik not",
    reading_rhythm_tuplet_table_col_replace: "Nahrazuje",
    reading_rhythm_tuplet_table_col_length: "Délka 1 noty",
    reading_rhythm_tuplet_variant_even: "Rovné dělení",
    reading_rhythm_tuplet_variant_triplet: "Triola",
    reading_rhythm_tuplet_variant_quartet: "Kvartola",
    reading_rhythm_tuplet_variant_quintet: "Kvintola",
    reading_rhythm_tuplet_ratio_triplet: "⅔ běžné osminy",
    reading_rhythm_tuplet_ratio_quartet: "¾ běžné délky",
    reading_rhythm_tuplet_ratio_quintet: "⅘ běžné délky",
    reading_rhythm_tuplet_read_heading: "Jak to poznat a číst",
    reading_rhythm_tuplet_read_text: "Skupiny se označují číslem nad trámcem – neukazuje jen spojení, ale <strong>způsob dělení</strong>.",
    reading_rhythm_tuplet_count_triplet: "<strong>Triola:</strong> „tri-o-la“ nebo „1-a-a“",
    reading_rhythm_tuplet_count_quartet: "<strong>Kvartola:</strong> „1-e-&amp;-a“ – čtyři rovnoměrné údery",
    reading_rhythm_tuplet_count_quintet: "<strong>Kvintola:</strong> pět úderů v čase čtyř (často 3+2 nebo 2+3)",
    reading_rhythm_tuplet_read_tooltip: "Číslo nad trámcem určuje dělení rytmu, ne jen skupinu not.",
    reading_rhythm_tuplet_read_play_base: "Rovné osminy",
    reading_rhythm_tuplet_read_play_triplet: "Triola (3)",
    reading_rhythm_tuplet_number_two: "2",
    reading_rhythm_tuplet_number_three: "3",
    reading_rhythm_tuplet_compare_heading: "Zkus si porovnat",
    reading_rhythm_tuplet_compare_text: "Klikni na počet úderů a slyš, jak se mění hustota. 2 = rovně, 3 = triola, 4 = kvartola, 5 = kvintola – čas jedné doby se nemění.",
    reading_rhythm_tuplet_compare_label: "Výběr hustoty dělení",
    reading_rhythm_tuplet_compare_btn_2: "2 údery",
    reading_rhythm_tuplet_compare_btn_3: "3 údery",
    reading_rhythm_tuplet_compare_btn_4: "4 údery",
    reading_rhythm_tuplet_compare_btn_5: "5 úderů",
    reading_rhythm_tuplet_timeline_base: "2 rovnoměrné údery (základ)",
    reading_rhythm_tuplet_timeline_triplet: "Triola – 3 údery v čase dvou",
    reading_rhythm_tuplet_timeline_quartet: "Kvartola – 4 údery v čase tří",
    reading_rhythm_tuplet_timeline_quintet: "Kvintola – 5 úderů v čase čtyř",
    reading_rhythm_tuplet_hero_even: "Rovné dělení",
    reading_rhythm_lengths_heading: "Délky not",
    reading_rhythm_lengths_intro: "Každá nota má jinou stavbu a proto i jinou délku trvání – každé přidání praporku nebo trámce dělí dobu na polovinu.",
    reading_rhythm_lengths_desc: "Klikni na notu a poslechni si, jak dlouho zní při tempu 80 BPM (čtvrťová nota = jedna doba).",
    reading_rhythm_note_whole: "Celá nota",
    reading_rhythm_note_half: "Půlová nota",
    reading_rhythm_note_quarter: "Čtvrťová nota",
    reading_rhythm_note_eighth: "Osminová nota",
    reading_rhythm_note_sixteenth: "Šestnáctinová nota",
    reading_rhythm_note_beats_whole: "4 doby",
    reading_rhythm_note_beats_half: "2 doby",
    reading_rhythm_note_beats_quarter: "1 doba",
    reading_rhythm_note_beats_eighth: "½ doby",
    reading_rhythm_note_beats_sixteenth: "¼ doby",
    reading_rhythm_play: "Přehrát",
    reading_rhythm_rests_heading: "Pomlky se stejnou délkou",
    reading_rhythm_rests_desc: "Pomlky značí ticho. Mají stejné trvání jako odpovídající noty – jen se místo tónu píše pauza.",
    reading_rhythm_rest_whole: "Celá pomlka",
    reading_rhythm_rest_half: "Půlová pomlka",
    reading_rhythm_rest_quarter: "Čtvrťová pomlka",
    reading_rhythm_rest_eighth: "Osminová pomlka",
    reading_rhythm_rest_sixteenth: "Šestnáctinová pomlka",
    reading_rhythm_rest_caption_whole: "Ticho o délce 4 dob.",
    reading_rhythm_rest_caption_half: "Ticho o délce 2 dob.",
    reading_rhythm_rest_caption_quarter: "Ticho o délce 1 doby.",
    reading_rhythm_rest_caption_eighth: "Ticho o délce ½ doby.",
    reading_rhythm_rest_caption_sixteenth: "Ticho o délce ¼ doby.",
    reading_rhythm_extension_heading: "Rytmické finesy",
    reading_rhythm_extension_p1: "Tečka za notou prodlužuje její délku o polovinu. Půlová s tečkou tedy trvá tři doby (2 + 1).",
    reading_rhythm_extension_p2: "Vázání spojuje dvě noty stejné výšky. Znějí jako jeden dlouhý tón – například dvě čtvrťové můžou vytvořit dvou-dobový úsek.",
    reading_rhythm_extension_btn: "Přehrát prodlouženou notu",
    reading_rhythm_dot_heading: "Tečka za notou",
    reading_rhythm_dot_text: "<strong>Tečka za notou</strong> prodlužuje její délku o <strong>polovinu původní hodnoty</strong>. Půlová s tečkou proto trvá <strong>tři doby</strong> (2 + 1), čtvrťová s tečkou <strong>jednu a půl doby</strong> (1 + ½). Tečka se používá tam, kde by jinak bylo potřeba zapisovat více not stejné výšky – například místo „půlová + čtvrťová“ stačí <strong>půlová s tečkou</strong>. Pokud se za notou objeví <strong>druhá tečka</strong>, prodlouží délku ještě o čtvrtinu původní hodnoty.",
    reading_rhythm_dot_caption: "2 + 1 doba = 3 doby",
    reading_rhythm_tie_heading: "Vázání not",
    reading_rhythm_tie_text: "<strong>Vázání</strong> spojuje <strong>dvě nebo více not stejné výšky</strong>, které mají znít jako <strong>jeden dlouhý tón bez přerušení</strong>. Hodí se zejména, když má tón pokračovat přes taktovou čáru nebo přes rytmické dělení, které by jednou notou nešlo zapsat. Dvě čtvrťové spojené vázáním znějí dohromady dvě doby. Na rozdíl od <strong>legata (slur)</strong>, které spojuje noty různé výšky a značí plynulý způsob hry, vázání pouze prodlužuje tón – <strong>výška se nemění</strong>.",
    reading_rhythm_tie_caption: "Tón zní přes taktovou čáru – dohromady dvě doby.",
    reading_rhythm_meter_heading: "Takt a metrum",
    reading_rhythm_meter_intro_heading: "Takt a metrum – jak hudba dýchá",
    reading_rhythm_meter_intro_text: "Hudba se odvíjí v čase. Abychom ji dokázali přehledně zapisovat a číst, dělíme ji na menší pravidelné úseky – <strong>takty</strong>. Každý takt obsahuje určitý počet <strong>dob</strong>, které se opakují v rytmickém cyklu. Tomuto pravidelnému opakování říkáme <strong>metrum</strong>. Můžeme si ho představit jako rytmické kroky nebo údery, které se stále opakují – třeba když tleskáš do rytmu písničky. Každá písnička má své metrum: někde cítíme čtyři doby na jedno kolečko, jinde tři, podle toho, jak hudba „kráčí“. (Např. 4/4, 3/4, 6/8).",
    reading_rhythm_meter_usage_text: "Bez taktů by hudba byla jen nepřehledná řada not. Takt pomáhá <strong>držet rytmus</strong> a orientovat se v čase, umožňuje <strong>společnou interpretaci</strong> více hráčů a dává hudbě <strong>pulz a přirozené frázování</strong>. Taktová čára tedy není jen dělicí linka – je to <strong>pomyslné nadechnutí</strong> mezi úseky hudby.",
    reading_rhythm_meter_notation_heading: "Jak se zapisuje metrum",
    reading_rhythm_meter_notation_text: "Metrum se zapisuje <strong>na začátku notové osnovy</strong> – hned za klíč (a případné předznamenání). Zapisuje se pomocí <strong>dvou čísel</strong>, jedno je napsané nad druhým. <strong>Horní číslo</strong> ukazuje, <strong>kolik úderů nebo dob</strong> má každý takt – můžeme si ho představit jako počet tlesknutí, které se vejdou mezi dvě taktové čáry. <strong>Dolní číslo</strong> říká, <strong>jaká nota odpovídá jedné době</strong> – třeba čtvrťová nebo osminová.",
    reading_rhythm_meter_notation_top: "<strong>Horní číslo</strong> ukazuje, <strong>kolik dob</strong> se vejde do jednoho taktu.",
    reading_rhythm_meter_notation_bottom: "<strong>Dolní číslo</strong> určuje, <strong>která nota odpovídá jedné době</strong> – například čtvrťová nebo osminová.",
    reading_rhythm_meter_notation_examples: "<strong>4/4</strong> – čtyři údery, každá doba jako čtvrťová nota (nejběžnější metrum). <strong>3/4</strong> – tři údery; tak hraje valčík. <strong>2/4</strong> – dva údery jako pochod.",
    reading_rhythm_meter_table_heading: "Základní metra a jejich použití",
    reading_rhythm_meter_table_col_meter: "Metrum",
    reading_rhythm_meter_table_col_beats: "Počet dob",
    reading_rhythm_meter_table_col_example: "Typ hudby / příklad",
    reading_rhythm_meter_table_col_character: "Charakter",
    reading_rhythm_meter_table_beats_24: "2",
    reading_rhythm_meter_table_type_24: "pochod, polka",
    reading_rhythm_meter_table_char_24: "přímý, energický",
    reading_rhythm_meter_example_24: "Dvě doby – pochod, polka. Přímý a pravidelný rytmus.",
    reading_rhythm_meter_table_beats_34: "3",
    reading_rhythm_meter_table_type_34: "valčík",
    reading_rhythm_meter_table_char_34: "houpavý, taneční",
    reading_rhythm_meter_example_34: "Tři doby – valčík. Houpavý, taneční pohyb.",
    reading_rhythm_meter_table_beats_44: "4",
    reading_rhythm_meter_table_type_44: "většina popu a jazzu",
    reading_rhythm_meter_table_char_44: "stabilní, univerzální",
    reading_rhythm_meter_example_44: "Čtyři doby – nejběžnější metrum v populární a jazzové hudbě. Stabilní, univerzální rytmus.",
    reading_rhythm_meter_table_beats_68: "6 (2×3 osminy)",
    reading_rhythm_meter_table_type_68: "balady, pomalé tance",
    reading_rhythm_meter_table_char_68: "kolébavý, plynulý",
    reading_rhythm_meter_example_68: "Šest dob – dvě skupiny po třech osminách. Používá se v baladách a pomalých tancích, zní plynule a kolébavě.",
    reading_rhythm_meter_accent_text: "Když posloucháš rytmus, zkus vnímat, kde hudba klade důraz – tedy na které době se cítí „těžce“. Tyto <strong>důrazné doby</strong> se pravidelně opakují a právě ony dávají hudbě její rytmický charakter.",
    reading_rhythm_meter_play_heading: "Vyzkoušej, jak zní různá metra",
    reading_rhythm_meter_play_sub: "Klikni na metrum a poslouchej, jak se v jednotlivých taktech střídají důrazy.",
    reading_rhythm_meter_cards_heading: "Interaktivní příklady taktů",
    reading_rhythm_meter_card_24_title: "2/4 takt",
    reading_rhythm_meter_card_24_desc: "Dvě doby – pochod, polka. Přímý a pravidelný rytmus.",
    reading_rhythm_meter_card_34_title: "3/4 takt",
    reading_rhythm_meter_card_34_desc: "Tři doby – valčík. Houpavý, taneční pohyb.",
    reading_rhythm_meter_card_44_title: "4/4 takt",
    reading_rhythm_meter_card_44_desc: "Čtyři doby – nejběžnější metrum v populární a jazzové hudbě. Stabilní, univerzální rytmus.",
    reading_rhythm_meter_card_68_title: "6/8 takt",
    reading_rhythm_meter_card_68_desc: "Šest dob – dvě skupiny po třech osminách. Používá se v baladách a pomalých tancích, zní plynule a kolébavě.",
    reading_rhythm_meter_examples_hint: "Klikni na metrum a jednotlivé takty. Vidíš zápis různých rytmů a můžeš je přehrát po jednom nebo jako celou sekvenci.",
    reading_rhythm_meter_play_selected: "Přehrát vybraný takt",
    reading_rhythm_meter_play_all: "Přehrát všechny takty",
    reading_rhythm_meter_24_example_quarters: "Dvě čtvrťové noty",
    reading_rhythm_meter_24_example_half: "Půlová nota – drží obě doby",
    reading_rhythm_meter_24_example_march: "Pochodový rytmus: čtvrťová + dvě osminy",
    reading_rhythm_meter_34_example_dotted_half: "Půlová s tečkou (3 doby)",
    reading_rhythm_meter_34_example_half_quarter: "Půlová + čtvrťová",
    reading_rhythm_meter_34_example_quarters: "Tři čtvrťové noty",
    reading_rhythm_meter_34_example_quarter_eighths: "Čtvrťová + dvě osminy + čtvrťová",
    reading_rhythm_meter_34_example_eighth_groups: "Tři skupiny osmin (2 + 2 + 2)",
    reading_rhythm_meter_44_example_whole: "Celá nota zaplní celý takt",
    reading_rhythm_meter_44_example_halves: "Dvě půlové noty",
    reading_rhythm_meter_44_example_quarters: "Čtyři čtvrťové noty",
    reading_rhythm_meter_44_example_combo: "Půlová + čtvrťová + dvě osminy",
    reading_rhythm_meter_44_example_triplet: "Triola čtvrťových přes dvě doby + půlová",
    reading_rhythm_meter_44_example_rest_mix: "Čtvrťová pomlka a navazující noty",
    reading_rhythm_meter_68_example_groups: "Dvě trojice osmin (akcenty na 1 a 4)",
    reading_rhythm_meter_68_example_trip_groups_rest: "Dvakrát dvojice osmin a pomlka.",
    reading_rhythm_meter_68_example_dotted_quarters: "Dvě čtvrťové noty s tečkou – každá zabere polovinu taktu.",
    reading_rhythm_meter_play_bar: "Přehrát takt",
    reading_rhythm_meter_play_sequence: "Přehrát sekvenci",
    reading_rhythm_meter_compound_heading: "Složená metra (6/8, 9/8, 12/8)",
    reading_rhythm_meter_compound_text: "Některé skladby kombinují <strong>trojkové</strong> vnímání (3/4) s plynulým, kolébavým rytmem osmin. V takovém případě mluvíme o metru <strong>6/8</strong>, které můžeme chápat jako dvě trojice osmin. Zatímco 3/4 má jen tři doby a cítíme jeden silný důraz na začátku, 6/8 se vnímá jako <strong>dva menší celky po třech osminách</strong> – jako kdyby hudba udělala <strong>dva jemné houpavé kroky</strong> místo jednoho dlouhého. To je důvod, proč 6/8 zní plynuleji a „valivěji“ než 3/4, i když mají obě šest osmin v jednom taktu. <strong>6/8</strong> používáme, když chceme hudbě dodat měkčí pohyb nebo kolébavý charakter.",
    reading_rhythm_meter_compare_text: "Porovnej 3/4 a 6/8 – i když mají podobný počet dob, akcenty a rytmické rozložení působí zcela jinak. Díky tomu má 6/8 měkčí a kolébavý pohyb, zatímco 3/4 jasně taneční trojkový rytmus.",
    reading_rhythm_meter_compare_button: "Porovnat přehrání",
    reading_rhythm_meter_compare_play_single: "Přehrát takt",
    reading_rhythm_meter_compare_beats_label: "Šest osmin s akcenty",
    reading_rhythm_tempo_heading: "Tempo – jak rychle hudba plyne",
    reading_rhythm_tempo_intro: "<strong>Tempo</strong> říká, kolik dob se vejde do jedné minuty. Teprve kombinace délky noty a tempa určí, jak dlouho skutečně zní.",
    reading_rhythm_tempo_length_heading: "Co znamená délka noty",
    reading_rhythm_tempo_length_text: "Délka noty popisuje pouze <strong>poměr v rámci taktu</strong>. Čtvrťová zabere polovinu doby půlové, osmina polovinu čtvrťové… ale nic to neříká o tom, <strong>kolik sekund</strong> bude tón znít.",
    reading_rhythm_tempo_speed_heading: "Tempo určuje rychlost",
    reading_rhythm_tempo_speed_text: "Tempo se zapisuje jako počet dob za minutu (často ♩ = 120). V 6/8 taktu se může udávat i na osminu nebo na čtvrťovou s tečkou. Nejčastější příklady:",
    reading_rhythm_tempo_example_q60: "♩ = 60 → 60 čtvrťových za minutu, 1 čtvrťová = 1 s",
    reading_rhythm_tempo_example_q120: "♩ = 120 → 120 čtvrťových za minutu, 1 čtvrťová = 0,5 s",
    reading_rhythm_tempo_example_e120: "♪ = 120 → 120 osmin za minutu (1 osmina = 0,5 s při počítání na osminu)",
    reading_rhythm_tempo_demo_heading: "Jak tempo mění pocit délky",
    reading_rhythm_tempo_demo_label: "Nastav tempo (♩ = <strong><span id=\"tempo-bpm-label\">120</span></strong> BPM)",
    reading_rhythm_tempo_demo_hint: "Zvýrazněné akcenty ukazují těžkou dobu – poslouchej, jak se mění délka osmin.",
    reading_rhythm_tempo_demo_context: "Ukázka je napsaná jako takt 6/8 – dvě trojice osmin za sebou.",
    reading_rhythm_tempo_duration_quarter: "Čtvrťová",
    reading_rhythm_tempo_duration_eighth: "Osminová",
    reading_rhythm_tempo_duration_dotted: "Čtvrťová s tečkou",
    reading_rhythm_tempo_play: "Přehrát osminy",
    reading_rhythm_tempo_compare_heading: "Příklad: čtvrťová může být „rychlejší“ než osmina",
    reading_rhythm_tempo_compare_meter: "Takt",
    reading_rhythm_tempo_compare_tempo: "Tempo",
    reading_rhythm_tempo_compare_beats: "Čas jedné doby",
    reading_rhythm_tempo_compare_row1_meter: "1) Čtvrťové noty",
    reading_rhythm_tempo_compare_row1_tempo: "♩ = 120",
    reading_rhythm_tempo_compare_row1_comment: "Každá čtvrťová ≈ 0,5 s (rychlé)",
    reading_rhythm_tempo_compare_row2_meter: "2) Osminové noty",
    reading_rhythm_tempo_compare_row2_tempo: "♩ = 60",
    reading_rhythm_tempo_compare_row2_comment: "Každá osmina ≈ 0,5 s (pomalé)",
    reading_rhythm_tempo_compare_note: "Ačkoli je osmina „kratší“ než čtvrťová, při ♩ = 60 trvá stejně dlouho jako čtvrťová v ♩ = 120. Proto se vždy dívej i na tempo.",
    reading_rhythm_tempo_terms_heading: "Nejčastější názvy temp",
    reading_rhythm_tempo_terms_intro: "Tempo se nemusí zapisovat jen číslem – oblíbená jsou i slovní označení, která naznačí charakter nebo náladu hudby.",
    reading_rhythm_tempo_terms_label: "Označení",
    reading_rhythm_tempo_terms_range: "Přibližný rozsah (♩/min)",
    reading_rhythm_tempo_terms_character: "Charakter",
    reading_rhythm_tempo_term_largo: "Largo",
    reading_rhythm_tempo_term_largo_range: "40–60",
    reading_rhythm_tempo_term_largo_character: "velmi pomalu",
    reading_rhythm_tempo_term_adagio: "Adagio",
    reading_rhythm_tempo_term_adagio_range: "60–76",
    reading_rhythm_tempo_term_adagio_character: "pomalu",
    reading_rhythm_tempo_term_andante: "Andante",
    reading_rhythm_tempo_term_andante_range: "76–108",
    reading_rhythm_tempo_term_andante_character: "středně pomalu – „krokem“",
    reading_rhythm_tempo_term_moderato: "Moderato",
    reading_rhythm_tempo_term_moderato_range: "108–120",
    reading_rhythm_tempo_term_moderato_character: "mírně rychle",
    reading_rhythm_tempo_term_allegro: "Allegro",
    reading_rhythm_tempo_term_allegro_range: "120–168",
    reading_rhythm_tempo_term_allegro_character: "rychle",
    reading_rhythm_tempo_term_presto: "Presto",
    reading_rhythm_tempo_term_presto_range: "168–200+",
    reading_rhythm_tempo_term_presto_character: "velmi rychle",
    reading_rhythm_meter_compare_play_single: "Přehrát takt",
    reading_rhythm_meter_compare_beats_label: "Šest osmin s akcenty",
    reading_rhythm_patterns_heading: "Rytmické slabiky",
    reading_rhythm_patterns_desc: "Jednoduché rytmické fráze s hlasitými slabikami „tá/ti“. Klikni na Přehrát a počítej dobový zápis.",
    reading_rhythm_pattern_ta_ta: "Tá tá",
    reading_rhythm_pattern_ta_ti_ti: "Tá ti ti",
    reading_rhythm_pattern_ti_ta_ti: "Ti tá ti",
    reading_rhythm_patterns_syllable_ta_ta: "Dvě čtvrťové noty.",
    reading_rhythm_patterns_syllable_ta_ti_ti: "Čtvrťová a dvě osminy.",
    reading_rhythm_patterns_syllable_ti_ta_ti: "Osmina, čtvrťová, osmina.",
    reading_rhythm_pattern_ta_ta_ta: "Tá tá tá",
    reading_rhythm_patterns_syllable_ta_ta_ta: "Triola tří osmin ve stejném čase jako dvě.",
    reading_rhythm_summary_heading: "Shrnutí délek",
    reading_rhythm_summary_table_note: "Nota",
    reading_rhythm_summary_table_rest: "Pomlka",
    reading_rhythm_summary_table_beats: "Počet dob",
    reading_rhythm_summary_play_all: "Přehrát všechny délky",
    reading_rhythm_summary_hint: "Všimni si, jak se rytmus postupně zrychluje.",
    reading_rhythm_summary_tuplet_label: "Dělený rytmus",
    reading_rhythm_summary_tuplet_example: "Triola osminová",
    reading_rhythm_summary_tuplet_ratio: "tři osminy místo dvou – poměr 2 : 3",
    reading_rhythm_audio_not_supported: "Tvoje zařízení nepodporuje přehrávání zvuku v prohlížeči.",
    oct_subcontra: "Subkontra oktáva",
    oct_contra: "Kontra oktáva",
    oct_great: "Velká oktáva",
    oct_small: "Malá oktáva",
    oct_one: "Jednočárkovaná oktáva",
    oct_two: "Dvoučárkovaná oktáva",
    oct_three: "Tříčárkovaná oktáva",
    oct_range_from: " – noty od ",
    oct_range_to: " po ",
    note_letter_C: "C",
    note_letter_D: "D",
    note_letter_E: "E",
    note_letter_F: "F",
    note_letter_G: "G",
    note_letter_A: "A",
    note_letter_B: "H",
    reading_practice_heading: "Procvičování",
    reading_practice_find_title: "Najdi správný tón",
    reading_practice_find_desc: "Zobrazená nota – tvým úkolem je určit její název (např. „E“).",
    reading_find_clef_treble: "Houslový",
    reading_find_clef_bass: "Basový",
    reading_practice_place_title: "Zapiš správný tón",
    reading_practice_place_desc: "Zadaný tón (např. „A“) – klikni na správnou pozici v osnově.",
    reading_practice_rhythm_title: "Slož správný rytmus",
    reading_practice_rhythm_desc: "Doplň chybějící rytmus do taktu.",
    intervals_title: "Vše o intervalech",
    intervals_intro: "Přehled intervalů od úplného základu po praktické použití v melodii i harmonii.",
    intervals_annotation: "Typy intervalů (čisté, velké, malé…), jejich stavba, zápis a chování.",
    intervals_what_title: "Co je interval",
    intervals_what_desc: "Melodické vs. harmonické intervaly a proč jsou zásadní. (Připravujeme)",
    intervals_what_annotation: "Úvod do toho, co intervaly jsou, proč se používají a jak fungují v hudbě. Vysvětlení pojmů melodický a harmonický interval a jejich rozdíl. Základní orientace – jak se interval měří (počítání tónů), směrování (vzestupně, sestupně) a proč jsou intervaly důležité pro melodii i harmonii.",
    intervals_names_title: "Názvy intervalů (prima–oktáva)",
    intervals_names_desc: "Prima až oktáva, jak se počítá vzdálenost a zapisuje interval. (Připravujeme)",
    intervals_names_annotation: "Přehled všech základních intervalových názvů — prima, sekunda, tercie, kvarta, kvinta, sexta, septima, oktáva. Jak se určují, jak se počítají vzdálenosti ve stupnici a jak se interval zapisuje. Užitečné tabulky a vizuální příklady.",
    intervals_sizes_title: "Velikosti intervalů",
    intervals_sizes_desc: "Čisté, velké, malé, zvětšené a zmenšené intervaly. (Připravujeme)",
    intervals_sizes_annotation: "Vysvětlení, proč nejsou všechny intervaly stejné. Rozdíl mezi čistými, velkými, malými, zvětšenými a zmenšenými intervaly. Logika zvětšení a zmenšení. Intervalová stavba z hlediska půltónů. Praktické ukázky — proč je velká tercie jiná než malá tercie, proč je tritonus výjimečný apod.",
    intervals_scales_title: "Intervaly ve stupnicích",
    intervals_scales_desc: "Intervalové vzory v durových i mollových stupnicích. (Připravujeme)",
    intervals_scales_annotation: "Přehled intervalů v durové stupnici a přehled intervalů v mollových systémech. Ukázky intervalových vzorů a vztah intervalů ke stupňům tóniny. Praktické příklady — jak určit interval mezi dvěma tóny ve stupnici a mimo ni.",
    intervals_color_title: "Barva a charakter intervalů",
    intervals_color_desc: "Jak intervaly znějí a jaký nesou pocit. (Připravujeme)",
    intervals_color_annotation: "Hudební psychologie intervalů: proč některé znějí klidně, jiné napjatě nebo smutně. Charakteristické vlastnosti — velká tercie (světlá), malá tercie (temná), tritonus (napětí), sekunda (drsnost), sexta (zpěvnost), oktáva (stabilita). Praktické využití v melodii a harmonii.",
    intervals_use_title: "Intervaly v melodii a harmonii",
    intervals_use_desc: "Intervalové kroky, skoky a role v akordech. (Připravujeme)",
    intervals_use_annotation: "Jak se intervaly používají v praxi: melodické kroky vs. skoky, melodické směry, intervalové patterny. V harmonii pak role intervalů při stavbě akordů (tercie, kvinta, septima), význam tritonu pro dominantu. Jak intervaly ovlivňují hudební fráze.",
    chords_title: "Jak vznikají akordy",
    chords_intro: "Vše o akordech: od základního pojmu po obraty, funkce a čtení značek.",
    chords_annotation: "Stavba akordů — triády, septakordy, obraty a čtení značek.",
    chords_what_title: "Co je akord",
    chords_what_desc: "Definice akordu, trojzvuky a proč alespoň tři tóny. (Připravujeme)",
    chords_what_annotation: "Základní definice akordu. Proč jsou k akordu potřeba alespoň tři tóny. Rozdíl mezi hraním tónů současně a postupně. Jak akordy vznikají z intervalů a stupnic. Vizualizace trojzvuků na notové osnově.",
    chords_build_title: "Stavba akordů (tercie a kvinty)",
    chords_build_desc: "Základní tón, tercie, kvinta a jejich kombinace. (Připravujeme)",
    chords_build_annotation: "Jak se akord skládá: základní tón, tercie a kvinta. Jak různé kombinace intervalů určují typ akordu. Vysvětlení vztahu k durové a mollové stupnici. Intervalový rozklad akordů — proč jsou tercie klíčové.",
    chords_triads_title: "Typy triád",
    chords_triads_desc: "Dur, moll, zvětšená, zmenšená – stavba a zvuk. (Připravujeme)",
    chords_triads_annotation: "Čtyři základní druhy triád, jejich stavba a zvuk. Proč durová triáda zní „jasně“ a mollová „temně“. Zvětšené a zmenšené triády — jejich použití a charakter. Tabulky, vizuální ukázky, příklady v tóninách.",
    chords_seventh_title: "Septakordy (7 akordy)",
    chords_seventh_desc: "Durový, mollový, dominantní, polozmenšený, zmenšený. (Připravujeme)",
    chords_seventh_annotation: "Rozšíření triád o septimu: durový, mollový, dominantní, polozmenšený a zmenšený septakord. Jak se tvoří, jak se značí (např. Cmaj7, Dm7, G7). Praktické ukázky, proč má dominantní septakord zásadní význam v harmonii.",
    chords_inversions_title: "Akordové obraty",
    chords_inversions_desc: "1./2./3. obrat a proč je používáme. (Připravujeme)",
    chords_inversions_annotation: "Co jsou obraty a proč existují. 1. obrat — tercie v basu, 2. obrat — kvinta v basu, u septakordů i 3. obrat — septima v basu. Jak obraty pomáhají plynule vést basovou linku a proč se používají v harmonii.",
    chords_diatonic_title: "Akordy v tónině (T–S–D)",
    chords_diatonic_desc: "Harmonizace stupnice a akordové funkce. (Připravujeme)",
    chords_diatonic_annotation: "Vztah akordů ke stupnici. Harmonizace diatonické stupnice: I–ii–iii–IV–V–vi–vii°. Rozdělení akordů na funkce: Tonika, Subdominanta, Dominanta. Role jednotlivých stupňů v hudbě. Praktické ukázky a typické postupy.",
    chords_reading_title: "Jak číst akordové značky",
    chords_reading_desc: "Logika značek C, Dm, G7, sus, maj7… (Připravujeme)",
    chords_reading_annotation: "Srozumitelný úvod do čtení značek: C, Dm, G7, Csus4, Cmaj7, C°, Dm/F. Logika písmen, akordových typů, přidaných tónů a basových obratů. Syntaktická pravidla pro čtení akordů v moderní hudbě.",
    reading_find_title: "Najdi správný tón",
    reading_find_intro_heading: "Najdi tón v notové osnově",
    reading_find_intro_copy: "Rychlá a přesná orientace v notách je klíčem k plynulému čtení. V tomto cvičení si procvičíš, jak rychle rozpoznáš tóny v notové osnově podle klíče, rozsahu i případných posuvek. Najdeš správnou odpověď i pod tlakem času?",
    reading_find_config_heading: "Nastav si cvičení",
    reading_find_param_clef: "Klíč",
    reading_find_param_range: "Rozsah tónů",
    reading_find_param_range_from: "Od",
    reading_find_param_range_to: "Do",
    reading_find_param_acc: "Křížky a béčka",
    reading_find_param_acc_off: "Bez posuvek",
    reading_find_param_acc_on: "S posuvkami",
    reading_find_param_count: "Počet not v testu",
    reading_find_param_timer: "Časovač",
    reading_find_timer_off: "Vypnuto",
    reading_find_timer_5: "5 vteřin",
    reading_find_timer_3: "3 vteřiny",
    reading_find_timer_1: "1 vteřina",
    reading_find_timer_label: "Čas",
    reading_find_start: "Spustit cvičení",
    reading_find_instruction: "Vyber název tónu pro zvýrazněnou notu.",
    reading_find_evaluate: "Vyhodnotit",
    reading_find_reset: "Zrušit odpovědi",
    reading_find_summary_heading: "Výsledek cvičení",
    reading_find_summary_correct: "Správně",
    reading_find_summary_wrong: "Špatně",
    reading_find_restart: "Zopakovat se stejnými parametry",
    reading_find_back: "Zpět na nastavení",
    reading_place_title: "Zapiš tón",
    reading_place_intro: "Dostaneš název tónu, tvým úkolem je zapsat ho na správnou linku nebo mezeru v notové osnově. Přizpůsob si klíč a rozsah, potom zapisuj noty v libovolném pořadí a vyhodnoť se, až budeš připraven.",
    reading_place_param_clef: "Klíč",
    reading_place_param_range: "Rozsah tónů",
    reading_place_param_range_start: "Od",
    reading_place_param_range_end: "Do",
    reading_place_param_count: "Počet not v testu",
    reading_place_start: "Spustit cvičení",
    reading_place_instruction: "Klikni do osnovy a přetáhni notu na správné místo. Zadání (např. g1) vidíš pod sloupcem, kam notu zapisuješ. Až budeš hotový, klikni na Vyhodnotit.",
    reading_place_target_label: "{note}",
    reading_place_target_done: "Hotovo – vyhodnoť test",
    reading_place_evaluate: "Vyhodnotit",
    reading_place_reset: "Zrušit odpovědi",
    reading_place_summary_correct: "Správně",
    reading_place_summary_wrong: "Chybně",
    reading_place_restart: "Zopakovat se stejnými parametry",
    reading_place_back: "Zpět na nastavení",
    reading_rhythm_practice_title: "Slož správný rytmus",
    reading_rhythm_practice_intro: "Doplň chybějící hodnoty tak, aby takt přesně seděl na dané metrum. Vyber si typy taktů i počet otázek a trénuj počítání dob.",
    reading_rhythm_practice_counts: "Počet otázek",
    reading_rhythm_practice_meters: "Vyber metrum",
    reading_rhythm_practice_start: "Spustit cvičení",
    reading_rhythm_practice_reset: "Vymazat takt",
    reading_rhythm_practice_back: "Zpět na výběr",
    reading_rhythm_practice_next: "Další",
    reading_rhythm_practice_remaining: "Zbývá doplnit: {beats}",
    reading_rhythm_practice_palette_notes: "Noty",
    reading_rhythm_practice_palette_rests: "Pomlky",
    reading_rhythm_practice_palette_pool: "Dostupné hodnoty",
    reading_rhythm_practice_summary_title: "Výsledek cvičení",
    reading_rhythm_practice_summary_again: "Procvičit znovu",
    reading_rhythm_practice_summary_select: "Zpět na výběr",
    reading_rhythm_practice_summary_correct: "Správně",
    reading_rhythm_practice_summary_wrong: "Potřebuje opravu",
    reading_rhythm_practice_diff_ok: "Sedí přesně.",
    reading_rhythm_practice_diff_over: "Přebývá: {beats}",
    reading_rhythm_practice_diff_under: "Chybí: {beats}",
    reading_clef_title: "Čtení klíčů",
    reading_clef_coming: "Sekce se připravuje. Brzy budeš přepínat mezi houslovým a basovým klíčem.",
    reading_acc_title: "Posuvky a předznamenání",
    reading_acc_coming: "Sekce se připravuje. Ukážeme různá předznamenání a posuvky v praxi.",
    select_all: "Označit vše",
    clear_all: "Zrušit vše",
    detail_minor7: "Přirozená moll",
    detail_harmonic_minor: "Harmonická moll",
    detail_melodic_minor: "Melodická moll",
    detail_major7: "Durová (ionická)",
    detail_penta_minor: "Moll pentatonika",
    detail_penta_major: "Dur pentatonika",
    detail_triad_minor: "Kvintakord (moll)",
    detail_triad_major: "Kvintakord (dur)",
    detail_blue: "Blue note (b5 z moll)",
    correct_short: "Správně!",
    correct_is: "Správně je",
    correct_label: "Správně:",
    your_click: "Tvoje kliknutí",
    summary_acc_label: "Předznamenání"

    // Labels & common nouns
    ,label_acc: "Předznamenání"
    ,label_penta_minor: "Minor pentatonika"
    ,label_scale_major: "Durová stupnice"
    ,label_scale_minor: "Mollová stupnice"
    ,label_blue: "Blue note"
    ,label_major: "Durová"
    ,label_minor: "Mollová"
    ,word_dur: "dur"
    ,word_moll: "moll"
    ,label_yours: "tvoje"
    ,label_correct: "správně"
    ,finish: "Dokončit"
    // Circle legend labels
    ,variant: "Varianta"
    ,circle_acc_label: "Předznamenání"
    ,circle_count_label: "Počet (♯/♭)"
    ,circle_rel_minor: "Příbuzná moll"
    ,circle_next_sharp: "O kvintu výš (→)"
    ,circle_next_flat: "O kvintu níž (←)"
    // KSQ small heading
    ,ksq_heading_acc: "Předznamenání"

    // Mottos & badges (evaluation)
    ,motto_low: "Každý mistr začínal z nuly. Zkus to znovu!"
    ,motto_mid: "Solidní výkon! Zkus se zaměřit na detaily."
    ,motto_high: "Výborně, máš to skoro v malíku!"
    ,motto_perfect: "Skvělá práce! Tvoje uši ladí jako koncertní flétna 🎶"
    ,badge_gold: "🥇 Zlatý tón"
    ,badge_silver: "🥈 Stříbrný tón"
    ,badge_bronze: "🥉 Bronzový tón"
    ,badge_retry: "😩 Musíš ještě trénovat"
  };

  const dict_en = {
    brand_claim: "Practice for scales & key signatures",
    app_title: "ToniQa",
    rel_major_label: "Relative major",
    tonic_minor_label: "Tonic (minor)",

    // Home tiles
    home_basics_title: "Music basics",
    home_basics_desc: "Reading notes, rhythm, dynamics and expressions with quick drills.",
    home_scales_title: "Scales & keys",
    home_scales_desc: "Circle of fifths, key signatures, pentatonics, trainers.",
    home_intervals_title: "Intervals",
    home_intervals_desc: "Types of intervals and how to build them. (Coming soon)",
    home_chords_title: "Chords",
    home_chords_desc: "Chord structure and types. (Coming soon)",
    home_harmony_title: "Harmony",
    home_harmony_desc: "Functions, cadences and chord progressions. (Coming soon)",
    home_improv_title: "Improvisation",
    home_improv_desc: "Improv basics and pentatonic practice. (Coming soon)",
    home_dynamics_title: "How dynamics work",
    home_dynamics_desc: "Volume markings, cresc./dim. and expressive playing. (Coming soon)",
    home_expressions_title: "Musical expressions",
    home_expressions_desc: "Italian tempo & mood terminology. (Coming soon)",
    badge_coming: "Coming soon",
    page_in_preparation: "This page is in preparation.",
    common_open: "Open",

    // Hub
    hub_title: "Scales – practice",
    hub_list_title: "All scales",
    hub_list_desc: "Overview and details for minor/major.",
    hub_build_title: "Build a scale",
    hub_build_desc: "Choose key signature, pentatonic scale & blue note.",
    hub_ksquiz_title: "Identify the key",
    hub_ksquiz_desc: "Identify the major & relative minor from the key signature.",
    hub_circle_title: "Circle of fifths trainer",
    hub_circle_desc: "Visualise the scale sequence.",
    hub_about_scales_title: "How scales work",
    hub_about_scales_desc: "Essential facts about scales.",
    hub_circlequiz_title: "Find the key in the circle",
    hub_circlequiz_desc: "Pick the correct key by the signature or relatives.",
    hub_group_theory: "Theory",
    hub_group_practice: "Practice",
    hub_tab_theory: "Theory",
    hub_tab_practice: "Practice",

    // Common buttons / toolbars
    common_back: "← Back",
    common_back_to_select: "← Back to selection",
    common_collapse: "Collapse",
    common_detail_scale: "Scale detail",
    common_expand: "Expand",
    common_next: "Next",
    common_prev: "Previous",
    common_eval: "Check",

    // Section headings
    build_select_title: "Build a scale – selection",
    build_select_hint: "Pick the scales you want to practice. The trainer shuffles them randomly, so every run feels different.",
    build_select_type_title: "Scale type in the quiz",
    build_select_type_hint: "Choose which scale type you want to build.",
    build_select_type_penta: "Pentatonic",
    build_select_type_major: "Major scale",
    build_select_type_minor: "Minor scale",
    build_quiz_heading_acc: "Key signature",
    build_quiz_heading_penta: "Minor pentatonic (5 notes)",
    build_quiz_heading_major: "Major scale (7 notes)",
    build_quiz_heading_minor: "Minor scale (7 notes)",
    build_quiz_heading_blue: "Blue note (♭5)",
    build_header_prefix: "Build:",

    // Summaries
    sum_build_title: "Build a scale — summary",
    sum_ksq_title: "Identify the key — summary",
    sum_circq_title: "Circle of fifths — summary",
    sum_circquiz_title: "Find the key in the circle — summary",
    sum_home: "Back home",
    sum_retry: "Try again",
    sum_retry_circq: "Train again",
    sum_retry_circquiz: "Retry the circle challenge",

    // KS Quiz
    ksq_title: "Identify the key — from the key signature",
    ksq_pick_len: "Choose quiz length",
    ksq_3: "3 questions",
    ksq_5: "5 questions",
    ksq_10: "10 questions",
    ksq_pick_major: "Pick the major key",
    ksq_pick_minor: "Pick the minor key",

    // Circle
    circle_title: "Circle of fifths – scale sequence visualiser",
    circlequiz_title: "Find the key in the circle – trainer",
    circle_panel_pick: "Circle trainer – choose length",
    circle_task: "Task: click the <b>correct major or relative minor</b> for this key signature:",
    circle_end: "End trainer",
    info_scales_title: "Scales – overview",
    info_intro_heading: "🧱 What is a scale",
    info_intro_p1: "Scales are a <b>core tool for making sense of music</b>. They help us understand why melodies sound the way they do, which tones belong together, and why some combinations feel more natural than others. Whether you read music, improvise, compose, or simply listen, scales give you orientation — a map of tonal space.",
    info_intro_p2: "Put simply, a scale is an <b>ordered sequence of pitches</b> that starts from a reference tone and moves upward or downward according to set rules. Those rules determine <b>which tones belong and how far apart they are</b>. That spacing gives each scale its character — calm, tense, sad, bright, or exotic.",
    info_intro_p3: "Scales are not just a theoretical term. They are the <b>building blocks of music</b>:",
    info_intro_use_1: "they help explain melody and harmony,",
    info_intro_use_2: "they define the key of a piece,",
    info_intro_use_3: "they serve as a guide for improvisation,",
    info_intro_use_4: "and they give music structure and logic.",
    info_intro_world_heading: "Scales across the world",
    info_intro_world_intro: "Different cultures have developed their own scale systems over time. For example:",
    info_intro_world_item_1: "<b>Indian ragas</b>, which are more than pitch sets — they include usage rules,",
    info_intro_world_item_2: "<b>Arabic maqam</b>, working with intervals smaller than a semitone,",
    info_intro_world_item_3: "<b>pentatonic scales</b>, common in folk music across the globe,",
    info_intro_world_item_4: "or <b>Chinese and Japanese scales</b>, known for their open, meditative sound.",
    info_intro_world_outro: "Each of these systems reflects a different way of hearing music, aesthetics, and emotion.",
    info_intro_focus_heading: "What we focus on here",
    info_intro_focus_intro: "In this section we concentrate on <b>Western scales</b>, which underpin most classical, popular, and jazz music. Historically they grew out of church modes, settled into the major/minor system, and form the basis of the theory we use today.",
    info_intro_focus_list_intro: "You will encounter mainly:",
    info_intro_focus_item_1: "<b>major and minor scales</b>,",
    info_intro_focus_item_2: "<b>church modes</b>,",
    info_intro_focus_item_3: "<b>pentatonic scales</b>,",
    info_intro_focus_item_4: "and other commonly used scale types.",
    info_intro_focus_next_intro: "For each one we will gradually cover:",
    info_intro_focus_next_item_1: "which tones it contains,",
    info_intro_focus_next_item_2: "how it sounds,",
    info_intro_focus_next_item_3: "where it is used in music,",
    info_intro_focus_next_item_4: "and how to work with it in practice.",
    info_diff_heading: "🧭 How scales differ",
    info_diff_p1: "When we say “scale”, it can sound as if it is always the same thing — just another row of notes. In reality, scales differ in a few essential ways. Those differences decide <b>how a scale sounds, what character it has, and how it is used in music</b>.",
    info_diff_p2: "To find our way around different scales, it helps to look at them from a few basic perspectives.",
    info_diff_count_heading: "Number of tones",
    info_diff_count_p: "Not all scales have the same number of tones. Some use seven notes, others five or more. The count affects how many pitches you have available while playing — whether the melody moves in a narrow, clear space or in a wider, richer range.",
    info_diff_intervals_heading: "Distances between tones",
    info_diff_intervals_p: "The key difference is not the tones themselves, but <b>the distances between them</b>. The interval pattern determines whether a scale sounds bright, sad, tense, calm, or mysterious. Even scales with the same number of tones can feel very different when the spacing changes.",
    info_diff_mood_heading: "Character and mood",
    info_diff_mood_p: "Every scale carries a certain expression. Some feel stable and bright, others melancholic, dramatic, or exotic. This character is not random — it reflects historical usage and how the human ear perceives individual intervals.",
    info_diff_use_heading: "Use in music",
    info_diff_use_p: "Different scales appear in different kinds of music. Some form the foundation of most pieces; others are used mainly for color, atmosphere, or improvisation. Knowing scales helps not only with reading and writing music, but also with deciding <b>what sound or mood we want to create</b>.",
    info_diff_outro: "In the next sections we will look at specific scale types. For each one we will show what it contains, how it sounds, and where it most often appears in music.",
    info_core_types_heading: "Core types of scales",
    info_core_types_intro: "Below are three fundamental groups of scales used in Western music. Each has its own character, typical colors and practical uses — and those differences help explain keys and why music feels the way it does.",
    info_major_heading: "🎼 Major scale",
    info_major_p1: "The major scale is the <b>basic and most frequently used scale in Western music</b>. When people say “scale” without further specification, they often mean the major scale. It serves as a starting point for understanding other scales and keys.",
    info_major_p2: "The major scale provides a <b>solid, stable musical framework</b>. Its structure feels natural, clear, and balanced, which is why it appears in a vast range of music — from folk songs and classical repertoire to pop and film scores.",
    info_major_parts_heading: "What the major scale consists of",
    info_major_parts_p1: "The major scale has <b>seven distinct tones</b> arranged in a precise sequence of steps. Those distances are not random — they are what makes the scale sound “major.”",
    info_major_parts_p2: "The typical major pattern is built from alternating <b>whole tones and semitones</b>. This pattern stays the same for every major scale, no matter which note it starts on.",
    info_major_pattern_intro: "Specifically, the steps follow:",
    info_major_pattern_line: "<b>whole – whole – half – whole – whole – whole – half</b>",
    info_major_pattern_note: "Using this pattern you can build any major scale — you simply start from a different tonic.",
    info_major_look_heading: "What the major scale looks like",
    info_major_look_p1: "To make the tones concrete, it helps to look at a specific example. The most common one is <b>C major</b>, because it contains no sharps or flats.",
    info_major_look_p2: "C major consists of these tones:",
    info_major_look_notes: "<b>C – D – E – F – G – A – B – C</b>",
    info_major_look_p3: "On the staff it appears as a smooth stepwise motion, and on the piano it corresponds to playing only the white keys.",
    info_major_play: "Play the scale",
    info_major_sound_heading: "How the major scale sounds and feels",
    info_major_sound_p: "The major scale is often associated with feelings such as:",
    info_major_sound_item_1: "clarity,",
    info_major_sound_item_2: "stability,",
    info_major_sound_item_3: "joy or openness.",
    info_major_sound_note: "That does not mean every major piece has to sound “happy.” Rather, major provides a <b>clear, reliable foundation</b> that works well melodically and harmonically.",
    info_major_use_heading: "Where you encounter it",
    info_major_use_p: "The major scale is the basis of:",
    info_major_use_item_1: "most keys in Western music,",
    info_major_use_item_2: "common chords and harmonic progressions,",
    info_major_use_item_3: "music education and notation.",
    info_minor_heading: "🌒 Minor scales",
    info_minor_p1: "Minor scales form an important and richly varied part of the musical world. While major scales often feel stable and open, minor brings a different kind of tension, depth, and color. It is not just a “sadder” version of major — minor offers a wide range of expression, from gentle and lyrical to dramatic and dark.",
    info_minor_p2: "Unlike the major scale, there is not only one single minor scale. In practice you will meet several forms of minor that evolved over time as practical answers to musical needs — especially for melody, harmony, and tension.",
    info_minor_p3: "All minor scales share a characteristic set of relationships that creates their typical sound. The individual variants differ in how they treat certain degrees of the scale to better suit melodic movement or harmonic use.",
    info_minor_p4: "In real music, the different minor scales are rarely used in isolation; they naturally blend into one another. Music is therefore not bound to one fixed shape, but can respond flexibly to what is needed in the moment — whether melody, chords, or overall expression.",
    info_minor_p5: "In the following sections we will look at the individual minor variants one by one. For each we will show what it looks like, how it sounds, and why it developed, so it is clear when and why it is used in music.",
    info_harm_heading: "🎶 Natural minor scale",
    info_harm_p1: "The natural minor scale is the <b>basic and most natural form of minor</b>. You can think of it as the default shape from which the other minor scales evolve. It appears very often in music — in melody and harmony — which is why it is a great starting point for learning minor scales.",
    info_harm_p2: "Its sound is often perceived as calmer, more serious, or more introspective than the major scale. It is not necessarily “sad” — the natural minor creates an <b>open space for expression</b> that can feel gentle, melancholic, or dramatic.",
    info_harm_parts_heading: "What the natural minor scale consists of",
    info_harm_parts_p1: "Like major, the natural minor has <b>seven distinct tones</b>. Its character comes from a different arrangement of the distances between them.",
    info_harm_pattern_intro: "The typical natural minor pattern follows:",
    info_harm_pattern_line: "<b>whole – half – whole – whole – half – whole – whole</b>",
    info_harm_pattern_note: "This sequence of steps gives the scale its characteristic minor color.",
    info_harm_look_heading: "What the natural minor scale looks like",
    info_harm_look_p1: "A common example is <b>A minor</b>, because it contains no sharps or flats.",
    info_harm_look_p2: "A minor consists of these tones:",
    info_harm_look_notes: "<b>A – B – C – D – E – F – G – A</b>",
    info_harm_look_p3: "On the staff it looks very similar to C major, but it starts on a different note and its tonal center shifts. This is one reason the natural minor is often described as “related” to a major scale.",
    info_harm_play: "Play the scale",
    info_harm_sound_heading: "How the natural minor scale sounds and feels",
    info_harm_sound_intro: "The natural minor is often associated with feelings such as:",
    info_harm_sound_item_1: "calm,",
    info_harm_sound_item_2: "depth,",
    info_harm_sound_item_3: "melancholy,",
    info_harm_sound_item_4: "inner tension.",
    info_harm_sound_note: "It is very versatile — it can sound gentle or dark, depending on tempo, harmony, and use.",
    info_harm_use_heading: "Where you encounter it",
    info_harm_use_intro: "The natural minor scale is the foundation of:",
    info_harm_use_item_1: "many folk and classical melodies,",
    info_harm_use_item_2: "minor keys without a raised seventh degree,",
    info_harm_use_item_3: "further work with minor scales.",
    info_harm_use_outro: "It is also the starting point for understanding <b>why harmonic and melodic minor scales emerged</b> as extensions of this base.",
    info_harmonic_heading: "🎵 Harmonic minor scale",
    info_harmonic_p1: "The harmonic minor scale emerged as a <b>response to harmonic needs</b>. It is based on the natural minor, but it alters one key tone to enable stronger, more decisive harmony, especially in cadences and endings.",
    info_harmonic_p2: "While the natural minor feels melodically natural, it lacks the tension typical of the major system in harmony. The harmonic minor addresses this and becomes a <b>core harmonic form of minor</b>.",
    info_harmonic_parts_heading: "What the harmonic minor scale consists of",
    info_harmonic_parts_p1: "The harmonic minor is derived from the natural minor but has a <b>raised seventh degree</b>. This single change profoundly shapes its sound and harmonic potential.",
    info_harmonic_pattern_intro: "The typical harmonic minor pattern is:",
    info_harmonic_pattern_line: "<b>whole – half – whole – whole – half – one-and-a-half – half</b>",
    info_harmonic_pattern_note: "The enlarged step between the 6th and 7th degrees creates its characteristic tension.",
    info_harmonic_look_heading: "What the harmonic minor scale looks like",
    info_harmonic_look_p1: "A common example is <b>A minor</b>.",
    info_harmonic_look_p2: "A harmonic minor consists of these tones:",
    info_harmonic_look_notes: "<b>A – B – C – D – E – F – G♯ – A</b>",
    info_harmonic_look_p3: "The raised seventh creates a strong pull back to the tonic, which is essential for harmonic resolution.",
    info_harmonic_play: "Play the scale",
    info_harmonic_sound_heading: "How the harmonic minor scale sounds and feels",
    info_harmonic_sound_p1: "The harmonic minor sounds more intense and dramatic than the natural minor. Its signature is the strong tension before the return to the tonic, which gives music drive and direction.",
    info_harmonic_sound_p2: "Because of the augmented step, harmonic minor often carries an <b>exotic or oriental color</b> that is easy to recognize.",
    info_harmonic_use_heading: "Where you encounter it",
    info_harmonic_use_intro: "The harmonic minor is used mainly:",
    info_harmonic_use_item_1: "in harmony of minor keys,",
    info_harmonic_use_item_2: "in classical music for cadences,",
    info_harmonic_use_item_3: "in dramatic and film music,",
    info_harmonic_use_item_4: "as a basis for understanding minor chords.",
    info_harmonic_use_outro: "Together with the natural and melodic minor, the harmonic minor forms a <b>closed system of minor variants</b>, each solving a different musical problem.",
    info_mel_heading: "🎵 Melodic minor scale",
    info_mel_p1: "The melodic minor scale emerged as a <b>practical response to melodic needs</b>. It starts from the natural minor but adjusts certain tones so melodies sound smoother and more natural, especially when moving upward.",
    info_mel_p2: "Unlike other minor scales, the melodic minor <b>behaves differently when ascending and descending</b>. This makes it a distinctive and very useful tool for melody.",
    info_mel_parts_heading: "What the melodic minor scale consists of",
    info_mel_parts_intro: "It begins with the natural minor, but:",
    info_mel_parts_item_1: "when <b>ascending</b>, the 6th and 7th degrees are raised,",
    info_mel_parts_item_2: "when <b>descending</b>, it returns to the natural minor form.",
    info_mel_parts_note: "This removes larger melodic gaps on the way up and creates a smoother tonal line.",
    info_mel_look_heading: "What the melodic minor scale looks like",
    info_mel_look_p1: "A common example is <b>A minor</b>.",
    info_mel_look_up_intro: "Ascending, the melodic minor uses these tones:",
    info_mel_look_up_notes: "<b>A – B – C – D – E – F♯ – G♯ – A</b>",
    info_mel_look_down_intro: "Descending, it returns to the natural minor:",
    info_mel_look_down_notes: "<b>A – G – F – E – D – C – B – A</b>",
    info_mel_look_note: "This difference between ascent and descent is characteristic of the melodic minor scale.",
    info_mel_play: "Play the scale",
    info_mel_sound_heading: "How the melodic minor scale sounds and feels",
    info_mel_sound_p: "Ascending, the melodic minor feels more open and brighter than the natural minor; descending, it returns to a darker color. This dual behavior offers <b>very rich expressive possibilities</b>.",
    info_mel_use_heading: "Where you encounter it",
    info_mel_use_intro: "The melodic minor is often used:",
    info_mel_use_item_1: "in melodic lines of classical music,",
    info_mel_use_item_2: "in jazz and modern music,",
    info_mel_use_item_3: "when a smooth, singable melodic movement is needed.",
    info_mel_use_outro: "It is an important link between the natural and harmonic minor scales and expands the expressive range of minor.",
    info_penta_heading: "🎷 Pentatonic scales",
    info_penta_intro_p1: "Pentatonic scales are among the oldest and most universal musical systems. The term “pentatonic” means the scale has <b>five tones</b>, and that simplicity is one reason pentatonics sound natural, open, and very musical.",
    info_penta_intro_p2: "Pentatonics appear in folk music worldwide — European, African, Asian, and American traditions. In Western music they are closely associated with <b>blues, rock, jazz, and improvisation</b>.",
    info_penta_popular_heading: "Why pentatonics are so popular",
    info_penta_popular_intro: "With fewer tones, there are fewer harsh interval clashes. As a result, pentatonics:",
    info_penta_popular_item_1: "are easy to improvise with,",
    info_penta_popular_item_2: "sound natural even without complex harmony,",
    info_penta_popular_item_3: "let players focus on expression, rhythm, and phrasing.",
    info_penta_popular_outro: "That makes pentatonics a perfect bridge between theory and practice.",
    info_penta_major_heading: "🎼 Major pentatonic",
    info_penta_major_p1: "The major pentatonic is derived from the major scale by omitting two tones. The result is a bright, open sound used in folk music, pop, and melodic improvisation.",
    info_penta_major_example_intro: "A typical example is <b>C major pentatonic</b>:",
    info_penta_major_example: "<b>C – D – E – G – A – C</b>",
    info_penta_major_traits_intro: "Major pentatonic feels:",
    info_penta_major_trait_1: "optimistic,",
    info_penta_major_trait_2: "stable,",
    info_penta_major_trait_3: "clear and straightforward.",
    info_penta_minor_heading: "🎼 Minor pentatonic",
    info_penta_minor_p1: "Minor pentatonic is one of the most used scales in modern music. It keeps the minor character and has a rawer sound than its major counterpart.",
    info_penta_minor_example_intro: "A typical example is <b>A minor pentatonic</b>:",
    info_penta_minor_example: "<b>A – C – D – E – G – A</b>",
    info_penta_minor_use_intro: "Minor pentatonic is the foundation of:",
    info_penta_minor_use_item_1: "blues and rock improvisation,",
    info_penta_minor_use_item_2: "many jazz phrases,",
    info_penta_minor_use_item_3: "melodic expression with strong tension.",
    info_penta_blue_heading: "🎵 Blue note (blue tone)",
    info_penta_blue_p1: "In blues and related styles, one extra tone is often added to the minor pentatonic — the <b>blue note</b>. It creates the characteristic blues tension and a “dirtier” sound.",
    info_penta_blue_p2: "In A minor pentatonic, the blue note is: <b>E♭ (D♯)</b>.",
    info_penta_blue_p3: "Adding it creates the <b>blues scale</b>, combining pentatonic simplicity with a sharper, expressive edge.",
    info_penta_blue_p4: "The blue note is not always treated as a stable tone — it often works as a <b>passing or expressive tone</b> that gives melodies character.",
    info_penta_demo_heading: "Try the differences between pentatonics",
    info_penta_mode_label: "Pentatonic type:",
    info_penta_mode_major: "Major pentatonic",
    info_penta_mode_minor: "Minor pentatonic",
    info_penta_mode_blue: "Minor pentatonic + blue note",
    info_penta_root_label: "Starting tone:",
    info_penta_play: "Play the scale",
    info_relation_heading: "⚖️ Major–minor relativity",
    info_relation_p1: "At first glance, major and minor scales can seem like two different worlds. One sounds bright and stable, the other darker and more tense. In reality, <b>major and minor are closely connected</b> — they share the same tones, the same key signature, and mainly differ in <b>where their tonal center lies</b>.",
    info_relation_rel_heading: "Relative keys",
    info_relation_rel_intro: "Every major key has its <b>relative minor</b>. These two keys:",
    info_relation_rel_item_1: "share the <b>same key signature</b>,",
    info_relation_rel_item_2: "use the <b>same tones</b>,",
    info_relation_rel_item_3: "differ only in the starting (tonic) tone.",
    info_relation_rel_examples_intro: "For example:",
    info_relation_rel_example_1: "<b>C major</b> and <b>A minor</b> have no sharps or flats,",
    info_relation_rel_example_2: "<b>G major</b> and <b>E minor</b> have one sharp,",
    info_relation_rel_example_3: "<b>F major</b> and <b>D minor</b> have one flat.",
    info_relation_rel_note: "That is why they are called <i>relative</i> keys.",
    info_relation_center_heading: "The difference is the center, not the tones",
    info_relation_center_p1: "The difference between a major key and its relative minor <b>is not which tones they use</b>, but <b>which tone feels like “home”</b> — the point of return and rest.",
    info_relation_center_intro: "Using the same tones:",
    info_relation_center_item_1: "in C major the center is <b>C</b>,",
    info_relation_center_item_2: "in A minor the center is <b>A</b>.",
    info_relation_center_note: "The music leans on a different center, which creates a different character even with the same pitch set.",
    info_relation_signature_heading: "Why they share the same key signature",
    info_relation_signature_p1: "A key signature does not tell us whether the music is major or minor. It only shows <b>which tones are consistently raised or lowered</b> in that key.",
    info_relation_signature_intro: "Therefore:",
    info_relation_signature_item_1: "relative major and minor share the same sharps or flats,",
    info_relation_signature_item_2: "and only the musical context (melody, harmony, cadence) reveals whether we hear major or minor.",
    info_relation_find_heading: "How to find the relative minor in practice",
    info_relation_find_intro: "You can find the relative minor of a major key by:",
    info_relation_find_item_1: "moving <b>down three semitones (a minor third)</b> from the major tonic.",
    info_relation_find_examples_intro: "For example:",
    info_relation_find_example_1: "C major → A minor",
    info_relation_find_example_2: "D major → B minor",
    info_relation_find_example_3: "E♭ major → C minor",
    info_relation_find_note: "This simple relationship is a foundation of the <b>circle of fifths</b>, where relative major and minor keys appear next to each other.",
    info_relation_importance_heading: "Why this relationship matters",
    info_relation_importance_intro: "Once you understand the link between major and minor keys:",
    info_relation_importance_item_1: "key signatures stop being confusing,",
    info_relation_importance_item_2: "keys begin to feel like a connected system,",
    info_relation_importance_item_3: "and shifts between major and minor sound natural and logical.",
    info_relation_importance_outro: "Major and minor are not opposites, but <b>two perspectives on the same tonal material</b> that music can move between.",
    info_modes_heading: "🕯️ Church modes",
    info_modes_p1: "Church modes are <b>different ways of organizing tones within a single scale</b>. They use the same pitch material, but differ in <b>which tone is treated as the main center</b> — the point the music relates to.",
    info_modes_p2: "While major or minor has a fixed center, modes shift that center. This creates different colors and characters even though the tones are the same.",
    info_modes_same_heading: "Same tones, different center",
    info_modes_same_intro: "The core idea of modes is simple:",
    info_modes_same_quote: "<b>The tones stay the same; the center changes.</b>",
    info_modes_same_p1: "If we take the tones of C major (C–D–E–F–G–A–B) and hear them from a tone other than C, we get a different mode — with a different character, tension, and expression.",
    info_modes_same_item_1: "<b>do not add new tones</b>,",
    info_modes_same_item_2: "but <b>change how we hear and use them</b>.",
    info_modes_history_heading: "Historical roots",
    info_modes_history_p1: "Church modes come from medieval music, where they formed the basis of Gregorian chant and early European music. Each mode had its own range and character that shaped how a piece felt.",
    info_modes_history_p2: "Later they were partly replaced by the major–minor system, but returned in modern music — especially jazz, film scoring, and improvisation.",
    info_modes_list_heading: "Overview of the basic modes",
    info_modes_list_intro: "Traditionally we distinguish seven basic modes. All use the same pitch material (for example the tones of C major), but differ in <b>which tone the music gravitates toward and returns to</b>.",
    info_modes_ionian_title: "<b>Ionian mode</b>",
    info_modes_ionian_text: "It matches the standard <b>major scale</b>. Using the tones of C major (C–D–E–F–G–A–B) with <b>C</b> as the center gives the familiar major character. The music naturally returns to C and feels stable, bright, and balanced. This is the most common mode in Western music.",
    info_modes_dorian_title: "<b>Dorian mode</b>",
    info_modes_dorian_text: "Uses the same tones as C major but centers on <b>D</b> (D–E–F–G–A–B–C–D). It has a minor flavor but sounds <b>brighter and more open</b> than natural minor. Often used in jazz, funk, and folk music.",
    info_modes_phrygian_title: "<b>Phrygian mode</b>",
    info_modes_phrygian_text: "Centering on <b>E</b> (E–F–G–A–B–C–D–E) yields the phrygian mode. It sounds <b>dark, tense, and exotic</b>, with strong tension early in the scale. It is relatively rare in mainstream pop.",
    info_modes_lydian_title: "<b>Lydian mode</b>",
    info_modes_lydian_text: "With <b>F</b> as the center (F–G–A–B–C–D–E–F), we get lydian. It feels <b>bright, open, and airy</b> — often used in film music or to evoke spacious, uplifting color.",
    info_modes_mixolydian_title: "<b>Mixolydian mode</b>",
    info_modes_mixolydian_text: "Centering on <b>G</b> (G–A–B–C–D–E–F–G) gives mixolydian. It is major-like but feels <b>more relaxed and less final</b>. Common in rock, blues, and folk.",
    info_modes_aeolian_title: "<b>Aeolian mode</b>",
    info_modes_aeolian_text: "With <b>A</b> as the center (A–B–C–D–E–F–G–A), this is the aeolian mode — the <b>natural minor scale</b>. It feels melancholic, serious, or introspective and is widely used.",
    info_modes_locrian_title: "<b>Locrian mode</b>",
    info_modes_locrian_text: "With <b>B</b> as the center (B–C–D–E–F–G–A–B), locrian feels <b>unstable and unsettled</b> because it lacks a firm sense of resolution. It is rare in traditional harmony.",
    info_modes_importance_heading: "Why modes matter",
    info_modes_importance_intro: "Church modes help you:",
    info_modes_importance_item_1: "expand your understanding of major and minor,",
    info_modes_importance_item_2: "grasp the character of pieces more clearly,",
    info_modes_importance_item_3: "work deliberately with mood and color,",
    info_modes_importance_item_4: "improvise without changing the pitch material.",
    info_shift_heading: "🔁 The same scale in different keys",
    info_shift_p1: "At first glance it can seem that each scale is tied to specific tones — that C major is fundamentally different from D major or G major. A closer look shows that <b>the essence of a scale is not the specific tones, but the relationships between them</b>.",
    info_shift_p2: "Every scale has an internal structure — a fixed sequence of steps. That structure stays the same even when the whole shape shifts up or down. The tonic changes, but <b>the way the tones are arranged remains intact</b>.",
    info_shift_p3: "Thanks to this, the same scale can exist in different keys. Major, minor, and other scales can start on different tones, have different spellings and different numbers of sharps or flats, yet still follow the same rules.",
    info_shift_list_intro: "This principle is one of the foundations of the musical system. It allows you to:",
    info_shift_list_1: "play and sing pieces in different ranges,",
    info_shift_list_2: "adapt music to the range of an instrument or voice,",
    info_shift_list_3: "understand why different keys exist,",
    info_shift_list_4: "and navigate related topics like the circle of fifths or harmony.",
    info_shift_p4: "Once you grasp this, scales stop being isolated lists of tones. You start to see them as <b>different shapes of a single musical form</b> that can move freely through tonal space.",
    info_shift_p5: "<b>And that closes the circle:</b> scales are not an end in themselves, but a tool that makes music coherent as a whole.",
    info_shift_enharm_heading: "Enharmonic spellings",
    info_shift_enharm_p1: "Sometimes the same scale can be written in two ways — it sounds the same but uses different note names. This is called <b>enharmonic spelling</b>.",
    info_shift_enharm_p2: "Which spelling we choose depends on context (key signature, harmony), not on the sound itself.",
    info_shift_enharm_examples_intro: "For example:",
    info_shift_enharm_example_1: "<b>F♯ major</b> and <b>G♭ major</b> sound the same but use different key signatures.",
    info_shift_enharm_example_2: "<b>C♯ major</b> and <b>D♭ major</b> are enharmonic versions of the same scale.",
    info_shift_enharm_label_fsharp: "F♯ major (enharmonic spelling)",
    info_shift_enharm_label_gflat: "G♭ major (enharmonic spelling)",
    info_shift_pick: "Try it in practice: below you can play the same major scale from several starting tones and hear what stays the same and what changes.",
    info_shift_play: "Play the scale",
    circle_intro_lead: "The <strong>Circle of Fifths</strong> is a visual tool that shows the relationships between major and minor scales, their key signatures, and how closely they’re related.",
    circle_intro_p2: "Moving <strong>clockwise</strong> takes you up a fifth (e.g. from C major to G major), while moving <strong>counterclockwise</strong> takes you down a fifth. This helps you see how scales change and how many sharps or flats they have.",
    circle_intro_p3: "The circle helps musicians understand key structure, relationships, and harmonic movement.",
    circle_intro_p4: "Select any key to see how its properties change.",

    // Scales list / detail
    scales_title: "List (natural minor ↔ relative major)",
    scales_tbl_moll: "minor",
    scales_tbl_major: "major",
    scales_tbl_acc: "key signature",
    scales_table_intro: "This table pairs each natural minor scale with its relative major and shows how many accidentals they share. Tap any row to open a detail page with notation, tone content and related variants.",
    detail_back: "← Back",

    intervals_title: "All about intervals",
    intervals_intro: "A complete overview of intervals: what they are, how they work, and how to use them.",
    intervals_annotation: "Interval types (perfect, major, minor…), how to build them, notation and basic behaviour.",
    intervals_what_title: "What is an interval",
    intervals_what_desc: "Melodic vs. harmonic intervals and why they matter. (Coming soon)",
    intervals_what_annotation: "Introduction to what intervals are, why they are used, and how they work in music. Explains melodic vs. harmonic intervals and their difference. Basics of measuring intervals (counting tones), direction (ascending/descending) and why intervals matter for melody and harmony.",
    intervals_names_title: "Interval names (unison–octave)",
    intervals_names_desc: "Unison through octave; how to count and notate an interval. (Coming soon)",
    intervals_names_annotation: "Overview of all core interval names — unison, second, third, fourth, fifth, sixth, seventh, octave. How to determine them, how to count distance in a scale, and how to notate an interval. Handy tables and visual examples.",
    intervals_sizes_title: "Interval qualities",
    intervals_sizes_desc: "Perfect, major, minor, augmented, diminished. (Coming soon)",
    intervals_sizes_annotation: "Why intervals differ: the distinction between perfect, major, minor, augmented and diminished intervals. The logic of sharpening/flattening. Interval construction in semitones. Practical examples — why a major third differs from a minor third, why the tritone is special, and more.",
    intervals_scales_title: "Intervals in scales",
    intervals_scales_desc: "Interval patterns in major and minor systems. (Coming soon)",
    intervals_scales_annotation: "Overview of intervals within the major scale and the minor systems. Examples of interval patterns and how intervals relate to scale degrees. Practical examples — how to identify intervals between two tones in and outside a scale.",
    intervals_color_title: "Colour & character of intervals",
    intervals_color_desc: "How intervals sound and feel. (Coming soon)",
    intervals_color_annotation: "The psychology of intervals: why some sound calm, tense or sad. Signature traits — major third (bright), minor third (dark), tritone (tension), second (grit), sixth (lyrical), octave (stable). Practical use in melody and harmony.",
    intervals_use_title: "Intervals in melody & harmony",
    intervals_use_desc: "Steps vs. leaps, and roles inside chords. (Coming soon)",
    intervals_use_annotation: "How intervals work in practice: melodic steps vs. leaps, contour, intervallic patterns. In harmony, the role of intervals in building chords (third, fifth, seventh) and the tritone for dominants. How intervals shape phrases.",
    chords_title: "How chords are built",
    chords_intro: "Everything about chords: from the basic definition to inversions, functions and reading symbols.",
    chords_annotation: "Building chords — triads, seventh chords, inversions and core chord notation.",
    chords_what_title: "What is a chord",
    chords_what_desc: "Definition, triads and why you need at least three tones. (Coming soon)",
    chords_what_annotation: "Basic definition of a chord. Why at least three tones are needed. Difference between playing tones together and separately. How chords arise from intervals and scales. Visualising triads on the staff.",
    chords_build_title: "Chord construction (thirds & fifths)",
    chords_build_desc: "Root, third, fifth and how combinations define the chord. (Coming soon)",
    chords_build_annotation: "How a chord is built: root, third and fifth. How different interval combinations define chord quality. Relation to major/minor scales. Interval breakdown of chords and why thirds are key.",
    chords_triads_title: "Types of triads",
    chords_triads_desc: "Major, minor, augmented, diminished — build and sound. (Coming soon)",
    chords_triads_annotation: "Four core triad types, their construction and sound. Why major feels “bright” and minor “dark”. Augmented and diminished triads — usage and character. Tables, visuals, examples in keys.",
    chords_seventh_title: "Seventh chords",
    chords_seventh_desc: "Major, minor, dominant, half-diminished, diminished. (Coming soon)",
    chords_seventh_annotation: "Extending triads with the seventh: major, minor, dominant, half-diminished and diminished seventh chords. How to build and label them (e.g., Cmaj7, Dm7, G7). Practical examples and why the dominant seventh is crucial in harmony.",
    chords_inversions_title: "Chord inversions",
    chords_inversions_desc: "1st/2nd/3rd inversion and why we use them. (Coming soon)",
    chords_inversions_annotation: "What inversions are and why they exist. 1st inversion — third in the bass, 2nd — fifth in the bass, and for sevenths also 3rd — seventh in the bass. How inversions smooth bass movement and why they matter in harmony.",
    chords_diatonic_title: "Chords in a key (T–S–D)",
    chords_diatonic_desc: "Diatonic harmonisation and functions. (Coming soon)",
    chords_diatonic_annotation: "Chords related to the scale. Diatonic harmonisation: I–ii–iii–IV–V–vi–vii°. Grouping into functions: Tonic, Subdominant, Dominant. Roles of each degree with examples and typical progressions.",
    chords_reading_title: "How to read chord symbols",
    chords_reading_desc: "Logic behind C, Dm, G7, sus, maj7… (Coming soon)",
    chords_reading_annotation: "Clear guide to reading symbols: C, Dm, G7, Csus4, Cmaj7, C°, Dm/F. The logic of letter names, chord types, added tones and slash bass notes. Syntax for modern chord reading.",
    dynamics_title: "How dynamics work",
    dynamics_annotation: "Dynamic markings and changes — p, f, crescendo, diminuendo and expressive playing.",
    expressions_title: "Musical expressions",
    expressions_annotation: "Core Italian expressions for tempo and character (allegro, andante, dolce, espressivo…).",
    harmony_functions_title: "Scale-degree functions",
    harmony_functions_note: "Functions within the key — tonic, subdominant, dominant and the roles of other degrees.",
    harmony_cadences_title: "How cadences work",
    harmony_cadences_note: "Core cadence types (authentic, plagal, half) and how to use them.",
    harmony_progressions_title: "Chord progressions in a key",
    harmony_progressions_note: "Typical chord sequences (I–IV–V, II–V–I…) and how to use them when writing or arranging.",
    harmony_modulation_title: "How to move between keys",
    harmony_modulation_note: "Simple modulations between related keys and basic modulation moves.",
    improv_basics_title: "Improvisation basics",
    improv_basics_note: "How to start improvising within a key — simple strategies and phrasing ideas.",
    improv_pentatonic_title: "Pentatonic in practice",
    improv_pentatonic_note: "Using major and minor pentatonics in practice, core patterns and lines.",
    improv_target_notes_title: "Target notes and how to use them",
    improv_target_notes_note: "Aiming for chord tones, closing phrases and creating resolution.",
    reading_title: "Music basics",
    reading_intro: "Learn to read notes, understand rhythm, dynamics and musical expressions—with quick drills to practise them.",
    reading_theory_heading: "Theory",
    reading_theory_staff_title: "How to read notes",
    reading_theory_staff_desc: "Staff basics, lines, spaces, and clefs (treble, bass).",
    reading_staff_intro: "🎼 Notes are more than symbols — they are the language of music. Just as letters form words, notes form melodies. Learning to read them means understanding musical speech — which helps you enjoy music more, write it down clearly, and create more freely. Whether you play, sing, or compose, mastering notation opens new doors. <BR><BR>Discover how the five staff lines work and how clefs shift note names.",
    reading_staff_section_staff: "The Staff",
    reading_staff_section_clefs: "Clefs",
    reading_staff_section_compare: "Why It Matters",
    reading_staff_clef_treble: "Treble clef",
    reading_staff_clef_bass: "Bass clef",
    reading_staff_clef_alto: "Alto clef",
    reading_staff_clef_tenor: "Tenor clef",

    // === Clef theory section (custom additions) ===
    reading_staff_clefs_intro: "🎼 Clefs help determine which notes correspond to each line and space of the staff. Without a clef, we wouldn't know where to place notes like C or G — because the same note can appear differently depending on the instrument’s range. Clefs allow each instrument to read music in a range that suits it best and avoid excessive ledger lines.<BR><BR>Pick a clef to see where middle C lands.",
    reading_staff_overview_heading: "📝 What lives on the staff?",
    reading_staff_overview_intro: "The staff provides a tidy grid for writing music. Several building blocks work together so you can read what to play:",
    reading_staff_overview_item_keys: "<strong>Clefs</strong> – assign note names to lines and spaces.",
    reading_staff_overview_item_notes: "<strong>Notes</strong> – symbols that combine pitch and duration.",
    reading_staff_overview_item_rests: "<strong>Rests</strong> – symbols for measured silence.",
    reading_staff_overview_item_accidentals: "<strong>Key signatures</strong> – Symbols placed after the clef that specify which notes throughout the piece should be played sharpened (with a sharp) or flattened (with a flat) by a semitone. Unlike accidentals, they apply globally to all matching notes – they define the key of the piece. Individual pitch changes are marked with accidentals (sharps and flats written directly next to the note).",
    reading_staff_overview_item_bars: "<strong>Barlines</strong> – Vertical lines that divide the music notation into segments (bars). They help maintain rhythm and make the music structure clearer.",
    reading_staff_overview_item_ledger: "<strong>Ledger lines</strong> – short lines above or below the staff for notes that sit beyond the core five lines.",
    reading_staff_overview_linespaces: "A note on a line touches the stroke, while a note in a space sits between two lines. Five lines plus four spaces create a clear grid, and ledger lines simply extend it when needed.",
    reading_staff_desc_treble: "This clef designates the second line as the note G4. It is used for higher-pitched instruments like the violin, flute, oboe, trumpet, or the right hand of the piano.",
    reading_staff_desc_bass: "This clef designates the fourth line as the note F3. It is suited for lower-pitched instruments such as the cello, bassoon, trombone, tuba, or the left hand of the piano.",
    reading_staff_desc_alto: "The alto clef designates the middle (third) line as the note C4. It is mainly used for the viola.",
    reading_staff_desc_tenor: "The tenor clef designates the fourth line as the note C4. It is used occasionally for instruments like the bassoon, trombone, or cello in the tenor range.",


    reading_staff_hover_hint: "Hover or tap to highlight each staff line or space.",
    reading_staff_slot_line_1: "1st line",
    reading_staff_slot_line_2: "2nd line",
    reading_staff_slot_line_3: "3rd line (middle)",
    reading_staff_slot_line_4: "4th line",
    reading_staff_slot_line_5: "5th line",
    reading_staff_slot_space_1: "Space between 1st and 2nd line",
    reading_staff_slot_space_2: "Space between 2nd and 3rd line (below 3rd line)",
    reading_staff_slot_space_3: "Space between 3rd and 4th line",
    reading_staff_slot_space_4: "Space between 4th and 5th line",
    reading_staff_compare_text: "The same pitch appears in different places depending on the clef. Below is middle C in treble and bass clef.",
    reading_staff_compare_treble: "Treble clef – middle C below the staff",
    reading_staff_compare_bass: "Bass clef – middle C above the staff",
    reading_notes_intro_heading: "Get to know the octaves",
    reading_notes_intro_p1: "Music spans a wide range of pitches — from the deep notes of a double bass to the high tones of a piccolo. To make sense of this range, we group notes by pitch into <strong>octaves</strong>.",
    reading_notes_intro_p2: "Each octave has its own name — such as “small”, “great”, or “one-lined”. By combining the octave name with a tone, we can precisely describe its pitch — for example, <strong>c1</strong> refers to the note C in the one-lined octave, while <strong>C</strong> refers to the note C in the great octave.",
    reading_notes_intro_p3: "This system helps us distinguish how high or low a tone actually sounds, even if it shares the same name as another tone in a different octave.",
    reading_notes_intro_p4: "The overview below shows all commonly used octaves and their respective ranges. You’ll also see the overlap tones so it’s clear how the octaves connect — they’re intentionally lighter to distinguish them from the main range.",
    reading_notes_map_play: "Play octave",
    detail_scale_play: "Play scale",
    reading_staff_summary: "Clefs redefine which lines and spaces map to each note name. Once you know the mapping, sight-reading becomes much easier.",
    reading_staff_cta: "Start sight-reading practice",
    reading_theory_notes_title: "Where notes sit",
    reading_theory_notes_desc: "Octave map showing the staff from contra to three-line.",
    reading_theory_rhythm_title: "How rhythm works",
    reading_theory_rhythm_desc: "Durations of notes and rests, time signatures, and rhythmic grouping.",
    reading_rhythm_intro_tagline: "How long a note lasts and how we write its duration.",
    reading_rhythm_intro_heading: "What is rhythm?",
    reading_rhythm_intro_p1: "Rhythm is the backbone of music – it defines when notes arrive and how long they ring.",
    reading_rhythm_intro_p2: "A note length is measured in beats. Think of beats as steady steps, a metronome click, or a regular clap.",
    reading_rhythm_intro_p3: "Some notes last one beat (quarter), others span two or four beats (half, whole) and the shortest ones take only half or a quarter beat (eighth, sixteenth).",
    reading_rhythm_intro_p4: "Beats group into bars to create a rhythmic frame. This section shows how note values are written, how they relate, and how they sound.",
    reading_rhythm_structure_heading: "How note shapes affect duration",
    reading_rhythm_structure_intro: "Any note can include a head, stem, and one or more flags. Adding parts shortens the duration.",
    reading_rhythm_structure_step_head: "Head only – whole note",
    reading_rhythm_structure_step_head_desc: "With no stem it rings for 4 beats.",
    reading_rhythm_structure_step_stem: "Head + stem – half note",
    reading_rhythm_structure_step_stem_desc: "Adding the stem halves the value to 2 beats.",
    reading_rhythm_structure_step_fill: "Filled head – quarter note",
    reading_rhythm_structure_step_fill_desc: "A filled head halves it again to 1 beat.",
    reading_rhythm_structure_step_flag: "Single flag – eighth note",
    reading_rhythm_structure_step_flag_desc: "One flag makes it ½ beat.",
    reading_rhythm_structure_step_double: "Double flag – sixteenth note",
    reading_rhythm_structure_step_double_desc: "Each extra flag halves the beat once more.",
    reading_rhythm_part_head: "Notehead",
    reading_rhythm_part_stem: "Stem",
    reading_rhythm_part_flag: "Flag",
    reading_rhythm_structure_note: "A note can carry multiple flags — every additional one halves the remaining duration.",
    reading_rhythm_notes_heading: "Notes on the staff",
    // === Notes on the staff ===
    reading_rhythm_stems_heading: "Stem direction",
    reading_rhythm_stems_sub: "How the stem direction is set on the staff",
    reading_rhythm_stems_text: "The direction of a stem depends on the note’s <strong>position on the staff</strong> – stems point <strong>upward</strong> for notes placed <strong>below the middle line</strong> and <strong>downward</strong> for notes above it. This direction doesn’t affect the note’s duration; it simply improves <em>readability</em>.",
    reading_rhythm_stems_note: "The middle line is usually the <strong>reference point</strong> – notes below it have upward stems, notes above have downward ones.",

    // === Beaming and flags ===
    reading_rhythm_beams_heading: "Beaming and flags",
    reading_rhythm_beams_sub: "How shorter rhythms are written",
    reading_rhythm_beams_text: "Shorter notes (such as <strong>eighths</strong> or <strong>sixteenths</strong>) are grouped together with <strong>beams</strong> – horizontal lines connecting stems. Two eighths share one beam, sixteenths have two. When written individually, they use a <strong>flag</strong> – a curved tail at the end of the stem.",
    reading_rhythm_beams_note: "Beaming <em>helps to clarify rhythm</em> by visually grouping notes that belong to the same beat.",
    reading_rhythm_tuplet_heading: "Split rhythms – triplets, quadruplets, quintuplets",
    reading_rhythm_tuplet_text: "<strong>Split rhythms</strong> show how to fit more notes into the very same span. Triplets (3 for 2), quadruplets (4 for 3) and quintuplets (5 for 4) change the beat density, yet the bar still lasts equally long.",
    reading_rhythm_tuplet_meaning_heading: "What split rhythms mean",
    reading_rhythm_tuplet_meaning_p1: "In regular rhythm the beats are split <strong>evenly</strong> – a quarter beat becomes two eighth-notes of the same length.",
    reading_rhythm_tuplet_meaning_p2: "<strong>Split rhythms</strong> are “irregular” divisions: three notes instead of two, four instead of three…",
    reading_rhythm_tuplet_meaning_p3: "Each note becomes a little shorter so that the <strong>whole group still fits the original time</strong>.",
    reading_rhythm_tuplet_meaning_figure_label: "Even eighths vs. triplet comparison",
    reading_rhythm_tuplet_meaning_even: "Even division – two eighths",
    reading_rhythm_tuplet_meaning_even_desc: "Two identical halves of one beat.",
    reading_rhythm_tuplet_meaning_triplet: "Triplet – three eighths",
    reading_rhythm_tuplet_meaning_triplet_desc: "Three hits in the time normally taken by two.",
    reading_rhythm_tuplet_hero_even_three: "3 even eighths",
    reading_rhythm_tuplet_hero_even_four: "4 even eighths",
    reading_rhythm_tuplet_row_toggle: "Play or pause this row",
    reading_rhythm_tuplet_how_heading: "How it works",
    reading_rhythm_tuplet_how_text: "Imagine a bar that usually holds two eighth-notes. If you play a <strong>triplet</strong> instead, every note lasts only <strong>two thirds of a regular eighth</strong>. The same logic applies to quadruplets (4 for 3) and quintuplets (5 for 4) – the rhythm is sliced more finely while the total time stays fixed.",
    reading_rhythm_tuplet_table_col_division: "Division",
    reading_rhythm_tuplet_table_col_count: "Notes",
    reading_rhythm_tuplet_table_col_replace: "Replaces",
    reading_rhythm_tuplet_table_col_length: "Length per note",
    reading_rhythm_tuplet_variant_even: "Even split",
    reading_rhythm_tuplet_variant_triplet: "Triplet",
    reading_rhythm_tuplet_variant_quartet: "Quadruplet",
    reading_rhythm_tuplet_variant_quintet: "Quintuplet",
    reading_rhythm_tuplet_ratio_triplet: "⅔ of a regular eighth",
    reading_rhythm_tuplet_ratio_quartet: "¾ of the usual value",
    reading_rhythm_tuplet_ratio_quintet: "⅘ of the usual value",
    reading_rhythm_tuplet_read_heading: "How to spot and read them",
    reading_rhythm_tuplet_read_text: "The small number above the beam tells you the special division – it is more than a simple grouping mark.",
    reading_rhythm_tuplet_count_triplet: "<strong>Triplet:</strong> “tri-o-la” or “1-and-a”",
    reading_rhythm_tuplet_count_quartet: "<strong>Quadruplet:</strong> “1-e-&amp;-a” – four even hits",
    reading_rhythm_tuplet_count_quintet: "<strong>Quintuplet:</strong> five hits inside four beats (often felt as 3+2 or 2+3)",
    reading_rhythm_tuplet_read_tooltip: "The number above the beam defines the rhythmic split, not only the visual grouping.",
    reading_rhythm_tuplet_read_play_base: "Even eighths",
    reading_rhythm_tuplet_read_play_triplet: "Triplet (3)",
    reading_rhythm_tuplet_number_two: "2",
    reading_rhythm_tuplet_number_three: "3",
    reading_rhythm_tuplet_compare_heading: "Try to compare",
    reading_rhythm_tuplet_compare_text: "Tap a count and hear the change in density. 2 = even, 3 = triplet, 4 = quadruplet, 5 = quintuplet – the overall beat stays put.",
    reading_rhythm_tuplet_compare_label: "Select subdivision density",
    reading_rhythm_tuplet_compare_btn_2: "2 beats",
    reading_rhythm_tuplet_compare_btn_3: "3 beats",
    reading_rhythm_tuplet_compare_btn_4: "4 beats",
    reading_rhythm_tuplet_compare_btn_5: "5 beats",
    reading_rhythm_tuplet_timeline_base: "2 even hits (reference)",
    reading_rhythm_tuplet_timeline_triplet: "Triplet – 3 hits in the time of two",
    reading_rhythm_tuplet_timeline_quartet: "Quadruplet – 4 hits in the time of three",
    reading_rhythm_tuplet_timeline_quintet: "Quintuplet – 5 hits in the time of four",
    reading_rhythm_tuplet_hero_even: "Even split",
    reading_rhythm_lengths_heading: "Note values",
    reading_rhythm_lengths_intro: "Each note shape maps to a specific duration — every extra flag or beam halves the beat.",
    reading_rhythm_lengths_desc: "Tap a note to hear its length at 80 BPM (a quarter note equals one beat).",
    reading_rhythm_note_whole: "Whole note",
    reading_rhythm_note_half: "Half note",
    reading_rhythm_note_quarter: "Quarter note",
    reading_rhythm_note_eighth: "Eighth note",
    reading_rhythm_note_sixteenth: "Sixteenth note",
    reading_rhythm_note_beats_whole: "4 beats",
    reading_rhythm_note_beats_half: "2 beats",
    reading_rhythm_note_beats_quarter: "1 beat",
    reading_rhythm_note_beats_eighth: "½ beat",
    reading_rhythm_note_beats_sixteenth: "¼ beat",
    reading_rhythm_play: "Play",
    reading_rhythm_rests_heading: "Matching rests",
    reading_rhythm_rests_desc: "Rests mark silence. They last exactly as long as the related notes — only the sound stays muted.",
    reading_rhythm_rest_whole: "Whole rest",
    reading_rhythm_rest_half: "Half rest",
    reading_rhythm_rest_quarter: "Quarter rest",
    reading_rhythm_rest_eighth: "Eighth rest",
    reading_rhythm_rest_sixteenth: "Sixteenth rest",
    reading_rhythm_rest_caption_whole: "Silence for 4 beats.",
    reading_rhythm_rest_caption_half: "Silence for 2 beats.",
    reading_rhythm_rest_caption_quarter: "Silence for 1 beat.",
    reading_rhythm_rest_caption_eighth: "Silence for half a beat.",
    reading_rhythm_rest_caption_sixteenth: "Silence for a quarter beat.",
    reading_rhythm_extension_heading: "Rhythmic touches",
    reading_rhythm_extension_p1: "A dot adds half of the note value. A dotted half note therefore lasts three beats (2 + 1).",
    reading_rhythm_extension_p2: "A tie connects two notes of the same pitch so they sound like one long tone – for instance two quarters can blend into a two-beat sound.",
    reading_rhythm_extension_btn: "Play the extended note",
    reading_rhythm_dot_heading: "Dotted notes",
    reading_rhythm_dot_text: "A <strong>dot</strong> after a note extends its duration by <strong>half of its original value</strong>. A dotted half note therefore lasts <strong>three beats</strong> (2 + 1) and a dotted quarter note lasts <strong>one and a half beats</strong> (1 + ½). The dot is used where writing multiple tied notes of the same pitch would be redundant – instead of “half + quarter”, you can simply write a <strong>dotted half</strong>. If a <strong>second dot</strong> is added, it extends the note by another quarter of the original value.",
    reading_rhythm_dot_caption: "2 + 1 beat = 3 beats",
    reading_rhythm_tie_heading: "Tied notes",
    reading_rhythm_tie_text: "A <strong>tie</strong> connects <strong>two or more notes of the same pitch</strong> so that they sound as <strong>one continuous tone</strong>. It is mainly used when a tone needs to continue across a barline or rhythmic division that cannot be written as a single note. Two tied quarter notes, for example, add up to two beats. Unlike a <strong>slur</strong>, which connects notes of different pitches to indicate a smooth articulation, a tie only lengthens the tone – <strong>the pitch stays the same</strong>.",
    reading_rhythm_tie_caption: "The tone crosses the barline – two beats total.",
    reading_rhythm_meter_heading: "Time signatures",
    reading_rhythm_meter_intro_heading: "Time signatures – how music breathes",
    reading_rhythm_meter_intro_text: "Music flows in time. To make it readable and clear, we divide it into smaller regular parts – <strong>bars</strong>. Each bar contains a certain number of <strong>beats</strong> that repeat in a rhythmic cycle. This repetition is called the <strong>meter</strong>. You can imagine it as rhythmic steps or claps that repeat – when you clap along to a song, you're feeling its meter. Each song has its own: sometimes we feel four beats, sometimes three, depending on how the music moves. (e.g. 4/4, 3/4, 6/8).",
    reading_rhythm_meter_usage_text: "Without bars, music would be just a confusing row of notes. Bars help <strong>keep the rhythm</strong>, <strong>organize time</strong>, and <strong>coordinate multiple players</strong>, giving the music its <strong>pulse and phrasing</strong>. The barline is not only a divider – it's a <strong>moment to breathe</strong> between musical phrases.",
    reading_rhythm_meter_notation_heading: "How meter is written",
    reading_rhythm_meter_notation_text: "The meter is written <strong>at the beginning of the staff</strong> – right after the clef and any key signature. It's written as <strong>two numbers</strong>, one above the other. The <strong>top number</strong> shows <strong>how many beats</strong> each bar has – you can think of it as the number of claps that fit between two barlines. The <strong>bottom number</strong> tells <strong>which note equals one beat</strong> – for example, a quarter or an eighth note.",
    reading_rhythm_meter_notation_top: "The <strong>top number</strong> shows <strong>how many beats</strong> are in each bar.",
    reading_rhythm_meter_notation_bottom: "The <strong>bottom number</strong> tells <strong>which note equals one beat</strong> – for example a quarter or an eighth note.",
    reading_rhythm_meter_notation_examples: "<strong>4/4</strong> – four beats, each a quarter note (most common). <strong>3/4</strong> – three beats, like in a waltz. <strong>2/4</strong> – two beats, march-like.",
    reading_rhythm_meter_table_heading: "Basic meters and their use",
    reading_rhythm_meter_table_col_meter: "Meter",
    reading_rhythm_meter_table_col_beats: "Beats",
    reading_rhythm_meter_table_col_example: "Style / example",
    reading_rhythm_meter_table_col_character: "Character",
    reading_rhythm_meter_table_beats_24: "2",
    reading_rhythm_meter_table_type_24: "march, polka",
    reading_rhythm_meter_table_char_24: "direct, energetic",
    reading_rhythm_meter_example_24: "Two beats – march or polka. Straight, regular rhythm.",
    reading_rhythm_meter_table_beats_34: "3",
    reading_rhythm_meter_table_type_34: "waltz",
    reading_rhythm_meter_table_char_34: "swaying, dance-like",
    reading_rhythm_meter_example_34: "Three beats – waltz. Flowing, dance-like motion.",
    reading_rhythm_meter_table_beats_44: "4",
    reading_rhythm_meter_table_type_44: "most pop and jazz",
    reading_rhythm_meter_table_char_44: "stable, universal",
    reading_rhythm_meter_example_44: "Four beats – the most common meter in pop and jazz. Stable, universal rhythm.",
    reading_rhythm_meter_table_beats_68: "6 (2×3 eighths)",
    reading_rhythm_meter_table_type_68: "ballad, slow dance",
    reading_rhythm_meter_table_char_68: "rolling, flowing",
    reading_rhythm_meter_example_68: "Six beats – two groups of three eighths. Used in ballads and slow dances, smooth and swaying.",
    reading_rhythm_meter_accent_text: "When you listen to rhythm, notice where the music places emphasis – the beats that feel 'heavy'. These <strong>strong beats</strong> repeat regularly and give the music its rhythmic character.",
    reading_rhythm_meter_play_heading: "Hear how each meter feels",
    reading_rhythm_meter_play_sub: "Pick a meter and listen for the accents inside each bar.",
    reading_rhythm_meter_cards_heading: "Interactive meter cards",
    reading_rhythm_meter_card_24_title: "2/4 time",
    reading_rhythm_meter_card_24_desc: "Two beats – march or polka. Straight, regular rhythm.",
    reading_rhythm_meter_card_34_title: "3/4 time",
    reading_rhythm_meter_card_34_desc: "Three beats – waltz. Flowing, dance-like motion.",
    reading_rhythm_meter_card_44_title: "4/4 time",
    reading_rhythm_meter_card_44_desc: "Four beats – the most common meter in pop and jazz. Stable, universal rhythm.",
    reading_rhythm_meter_card_68_title: "6/8 time",
    reading_rhythm_meter_card_68_desc: "Six beats – two groups of three eighths. Used in ballads and slow dances, smooth and swaying.",
    reading_rhythm_meter_examples_hint: "Pick a meter, tap a bar on the staff, then play a single bar or the entire sequence.",
    reading_rhythm_meter_play_selected: "Play selected bar",
    reading_rhythm_meter_play_all: "Play full sequence",
    reading_rhythm_meter_24_example_quarters: "Two quarter notes",
    reading_rhythm_meter_24_example_half: "Half note covering both beats",
    reading_rhythm_meter_24_example_march: "March pulse: quarter plus two eighths",
    reading_rhythm_meter_34_example_dotted_half: "Dotted half note (3 beats)",
    reading_rhythm_meter_34_example_half_quarter: "Half note plus a quarter",
    reading_rhythm_meter_34_example_quarters: "Three quarter notes",
    reading_rhythm_meter_34_example_quarter_eighths: "Quarter + two eighths + quarter",
    reading_rhythm_meter_34_example_eighth_groups: "Three groups of eighths (2 + 2 + 2)",
    reading_rhythm_meter_44_example_whole: "Whole note filling the bar",
    reading_rhythm_meter_44_example_halves: "Two half notes",
    reading_rhythm_meter_44_example_quarters: "Four quarter notes",
    reading_rhythm_meter_44_example_combo: "Half + quarter + two eighths",
    reading_rhythm_meter_44_example_triplet: "Quarter-note triplet across two beats plus half note",
    reading_rhythm_meter_44_example_rest_mix: "Quarter rest followed by notes",
    reading_rhythm_meter_68_example_groups: "Two groups of three eighths (accents on 1 and 4)",
    reading_rhythm_meter_68_example_trip_groups_rest: "Two pairs of eighths followed by a quarter rest.",
    reading_rhythm_meter_68_example_dotted_quarters: "Two dotted quarter notes, each covering half of the bar.",
    reading_rhythm_meter_play_bar: "Play one bar",
    reading_rhythm_meter_play_sequence: "Play sequence",
    reading_rhythm_meter_compound_heading: "Compound meters (6/8, 9/8, 12/8)",
    reading_rhythm_meter_compound_text: "Some pieces combine a <strong>triple feel</strong> (3/4) with a flowing rhythm of eighth notes. In such cases we speak of a <strong>6/8</strong> meter, which can be understood as two groups of three eighths. While 3/4 has three beats with one strong accent at the start, 6/8 feels like <strong>two smaller swaying groups</strong> – as if the music takes <strong>two gentle rocking steps</strong> instead of one long one. That's why 6/8 sounds smoother and more rolling than 3/4, even though both fill the same time. <strong>6/8</strong> is used when we want to give the music a softer, lilting flow.",
    reading_rhythm_meter_compare_text: "Compare 3/4 and 6/8 – even though they have a similar number of beats, the accents and rhythmic feel are completely different. 6/8 has a softer, rocking motion, while 3/4 has a clear, dance-like triple rhythm.",
    reading_rhythm_meter_compare_button: "Play comparison",
    reading_rhythm_meter_compare_play_single: "Play bar",
    reading_rhythm_meter_compare_beats_label: "Six eighth-notes with accents",
    reading_rhythm_tempo_heading: "Tempo – how fast the music really flows",
    reading_rhythm_tempo_intro: "<strong>Tempo</strong> tells you how many beats happen per minute. Only the combination of note value and tempo reveals the actual duration in seconds.",
    reading_rhythm_tempo_length_heading: "What a note value means",
    reading_rhythm_tempo_length_text: "A note length only describes the <strong>ratio inside the bar</strong>. A quarter is half of a half note, an eighth is half of a quarter… but it says nothing about <strong>how many seconds</strong> the tone lasts.",
    reading_rhythm_tempo_speed_heading: "Tempo sets the speed",
    reading_rhythm_tempo_speed_text: "Tempo is written as beats per minute (often ♩ = 120). In 6/8 it can be shown on the eighth or on the dotted quarter. Common examples:",
    reading_rhythm_tempo_example_q60: "♩ = 60 → 60 quarter notes per minute, 1 quarter = 1 s",
    reading_rhythm_tempo_example_q120: "♩ = 120 → 120 quarter notes per minute, 1 quarter = 0.5 s",
    reading_rhythm_tempo_example_e120: "♪ = 120 → 120 eighth notes per minute (1 eighth = 0.5 s when counted on the eighth)",
    reading_rhythm_tempo_demo_heading: "How tempo changes the feeling of length",
    reading_rhythm_tempo_demo_label: "Set the tempo (♩ = <strong><span id=\"tempo-bpm-label\">120</span></strong> BPM)",
    reading_rhythm_tempo_demo_hint: "Highlighted accents mark the strong beats – listen to how the eighths stretch or squeeze.",
    reading_rhythm_tempo_demo_context: "The demo is written as a 6/8 bar – two groups of three eighths.",
    reading_rhythm_tempo_duration_quarter: "Quarter note",
    reading_rhythm_tempo_duration_eighth: "Eighth note",
    reading_rhythm_tempo_duration_dotted: "Dotted quarter",
    reading_rhythm_tempo_play: "Play the eighths",
    reading_rhythm_tempo_compare_heading: "Example: a quarter can feel faster than an eighth",
    reading_rhythm_tempo_compare_meter: "Bar",
    reading_rhythm_tempo_compare_tempo: "Tempo",
    reading_rhythm_tempo_compare_beats: "Time per beat",
    reading_rhythm_tempo_compare_row1_meter: "1) Quarter notes",
    reading_rhythm_tempo_compare_row1_tempo: "♩ = 120",
    reading_rhythm_tempo_compare_row1_comment: "Each quarter ≈ 0.5 s (fast feel)",
    reading_rhythm_tempo_compare_row2_meter: "2) Eighth notes",
    reading_rhythm_tempo_compare_row2_tempo: "♩ = 60",
    reading_rhythm_tempo_compare_row2_comment: "Each eighth ≈ 0.5 s (slow feel)",
    reading_rhythm_tempo_terms_heading: "Most common tempo names",
    reading_rhythm_tempo_compare_note: "Even though the eighth is “shorter”, at ♩ = 60 it lasts as long as a quarter at ♩ = 120. You always need to know the tempo.",
    reading_rhythm_tempo_terms_intro: "Tempo markings are often written as words as well – they hint at the mood and character of the music.",
    reading_rhythm_tempo_terms_label: "Marking",
    reading_rhythm_tempo_terms_range: "Approx. range (♩/min)",
    reading_rhythm_tempo_terms_character: "Character",
    reading_rhythm_tempo_term_largo: "Largo",
    reading_rhythm_tempo_term_largo_range: "40–60",
    reading_rhythm_tempo_term_largo_character: "very slow",
    reading_rhythm_tempo_term_adagio: "Adagio",
    reading_rhythm_tempo_term_adagio_range: "60–76",
    reading_rhythm_tempo_term_adagio_character: "slow",
    reading_rhythm_tempo_term_andante: "Andante",
    reading_rhythm_tempo_term_andante_range: "76–108",
    reading_rhythm_tempo_term_andante_character: "medium slow, “walking”",
    reading_rhythm_tempo_term_moderato: "Moderato",
    reading_rhythm_tempo_term_moderato_range: "108–120",
    reading_rhythm_tempo_term_moderato_character: "moderately fast",
    reading_rhythm_tempo_term_allegro: "Allegro",
    reading_rhythm_tempo_term_allegro_range: "120–168",
    reading_rhythm_tempo_term_allegro_character: "fast",
    reading_rhythm_tempo_term_presto: "Presto",
    reading_rhythm_tempo_term_presto_range: "168–200+",
    reading_rhythm_tempo_term_presto_character: "very fast",
    reading_rhythm_meter_compare_play_single: "Play bar",
    reading_rhythm_meter_compare_beats_label: "Six eighth-notes with accents",
    reading_rhythm_patterns_heading: "Rhythmic syllables",
    reading_rhythm_patterns_desc: "Short rhythmic phrases with syllables “ta/ti”. Hit Play and count the beats.",
    reading_rhythm_pattern_ta_ta: "Ta ta",
    reading_rhythm_pattern_ta_ti_ti: "Ta ti ti",
    reading_rhythm_pattern_ti_ta_ti: "Ti ta ti",
    reading_rhythm_patterns_syllable_ta_ta: "Two quarter notes.",
    reading_rhythm_patterns_syllable_ta_ti_ti: "One quarter followed by two eighths.",
    reading_rhythm_patterns_syllable_ti_ta_ti: "Eighth, quarter, eighth.",
    reading_rhythm_pattern_ta_ta_ta: "Ta ta ta",
    reading_rhythm_patterns_syllable_ta_ta_ta: "Triplet of eighth notes fitting into two beats.",
    reading_rhythm_summary_heading: "Value summary",
    reading_rhythm_summary_table_note: "Note",
    reading_rhythm_summary_table_rest: "Rest",
    reading_rhythm_summary_table_beats: "Beats",
    reading_rhythm_summary_play_all: "Play all lengths",
    reading_rhythm_summary_hint: "Notice how the pulse speeds up gradually.",
    reading_rhythm_summary_tuplet_label: "Split rhythm",
    reading_rhythm_summary_tuplet_example: "Eighth-note triplet",
    reading_rhythm_summary_tuplet_ratio: "three eighths instead of two – ratio 2 : 3",
    reading_rhythm_audio_not_supported: "Your device cannot play audio in this browser.",
    reading_theory_accidentals_title: "Sharps, flats & co.",
    reading_theory_accidentals_desc: "Key signatures and accidentals in notation.",
    reading_theory_accidentals_annotation: "Sharps, flats, key signatures and how they affect pitch.",
    reading_acc_intro_text: "Sharps, flats and other accidentals are symbols that change a note’s pitch. They can make music brighter, darker or more tense. To understand why they exist and how to use them, we first need to know what half-steps are.",
    reading_acc_halfstep_title: "Half-steps – the smallest move in Western music",
    reading_acc_halfstep_p1: "A half-step is the smallest common distance between two tones in Western music. It is the tiniest move a note can make up or down — the “smallest possible step” between two notes.",
    reading_acc_halfstep_p2a: "To get this right, remember that <strong>the staff shows only the basic natural tones without accidentals</strong>. When you look at a staff, you see these notes:",
    reading_acc_halfstep_p2b: "That’s not every tone that exists — between some of these notes there is room for extra tones you don’t see without accidentals. That is where half-steps come in.",
    reading_acc_halfstep_line: "The basic row of tones in notation: <strong>C – D – E – F – G – A – B – C</strong>. At first glance it looks regular, but it hides two key exceptions.",
    reading_acc_halfstep_natural_heading: "In Western music the core tones come from historical tuning and natural acoustic relationships. In the row C–D–E–F–G–A–B–C there are two pairs where a <strong>natural</strong> half-step already exists:",
    reading_acc_halfstep_natural_item1: "between <strong>E and F</strong>,",
    reading_acc_halfstep_natural_item2: "between <strong>B and C</strong>.",
    reading_acc_halfstep_natural_text: "It isn’t magic — these notes sit so close that there is <em>no extra tone that would make sense to name or notate</em>. On a piano you notice right away: between E–F and B–C there is <strong>no black key</strong>, because music simply doesn’t need a “<strong>middle key</strong>” there. This is a settled feature of our music, so we treat it as the standard foundation.",
    reading_acc_halfstep_p2b_intro: "That’s not every tone that exists — between some of these notes there is room for extra tones you don’t see without accidentals. That’s where half-steps come in.",
    reading_acc_halfstep_p2c_intro: "Before we show accidentals, it’s important to understand that:",
    reading_acc_halfstep_p2b_item1: "some neighbouring tones are a <strong>whole step apart</strong> – two half-steps,",
    reading_acc_halfstep_p2b_item2: "others are a <strong>direct half-step</strong> with no extra space.",
    reading_acc_step_type: "Step type",
    reading_acc_step_from: "From",
    reading_acc_step_to: "To",
    reading_acc_step_half: "half-step",
    reading_acc_step_whole: "whole step",
    reading_acc_halfstep_table_note: "This table shows where the two natural half-steps sit — between E–F and B–C. All other neighbouring tones are a whole step apart. Scales, accidentals and tonal harmony are built on this pattern.",
    reading_acc_halfstep_piano: "On the piano you can see it because those pairs have no black key between them.",
    reading_acc_halfstep_play_heading: "Play neighbouring tones and see if you can hear the difference between a whole step and a half-step:",
    reading_acc_halfstep_play_hint: "(A short staff segment appears with a treble clef and two notes side by side — first the natural pair, then with an accidental.)",
    reading_acc_pair_ef: "E → F (half-step)",
    reading_acc_pair_fg: "F → G (whole step)",
    reading_acc_pair_hc: "B → C (half-step)",
    reading_acc_pair_cd: "C → D (whole step)",
    reading_acc_action_play: "Play",
    reading_acc_accidentals_title: "What are accidentals?",
    reading_acc_accidentals_rich: "<p>Accidentals are symbols that change a note’s pitch in notation. They let us use tones that aren’t visible in the basic row <strong>C–D–E–F–G–A–B–C</strong> but are common in music. With them a melody can feel gentler, tighter, brighter or darker — even a tiny half-step change can shape the sound a lot.</p><p>Raising or lowering a tone is written before the note, and the tone is read and played differently. For example:</p><ul class=\"list\"><li><strong>C → C♯</strong> = raised by a half-step</li><li><strong>D → D♭</strong> = lowered by a half-step</li></ul><p>Even though the symbols differ, we’re always talking about small pitch moves — a half-step or a whole step.</p><h5 class=\"h5\">How do we read these tones?</h5><p>Say them as “note + sharp” or “note + flat”.</p><h5 class=\"h5\">Raised tones (♯ – sharp)</h5><p>Read them as:</p><ul class=\"list\"><li><strong>C♯</strong> (C sharp)</li><li><strong>D♯</strong> (D sharp)</li><li><strong>E♯</strong> (E sharp)</li><li><strong>F♯</strong> (F sharp)</li><li><strong>G♯</strong> (G sharp)</li><li><strong>A♯</strong> (A sharp)</li><li><strong>B♯</strong> (B sharp)</li></ul><h5 class=\"h5\">Lowered tones (♭ – flat)</h5><p>Read them as:</p><ul class=\"list\"><li><strong>C♭</strong> (C flat)</li><li><strong>D♭</strong> (D flat)</li><li><strong>E♭</strong> (E flat)</li><li><strong>F♭</strong> (F flat)</li><li><strong>G♭</strong> (G flat)</li><li><strong>A♭</strong> (A flat)</li><li><strong>B♭</strong> (B flat)</li></ul><h5 class=\"h5\">Why do some tones sound the same but look different?</h5><p>Here’s the key idea: <strong>a half-step between two tones is always the same size, so you can “reach” a tone from different sides.</strong></p><ul class=\"list\"><li><strong>C♯ and D♭</strong> sound exactly the same</li><li><strong>F♯ = G♭</strong></li><li><strong>E♯ = F</strong></li><li><strong>B♭ = A♯</strong></li></ul><p>This is called an <strong>enharmonic equivalent</strong>. Music can write the same tone in two (or more) ways depending on what fits the scale, harmony or melodic line.</p><h5 class=\"h5\">Can a tone that’s already a half-step still use an accidental?</h5><p>Yes — and it matters.</p><p>Natural half-steps are only two: E–F and B–C. But you can still raise or lower them:</p><ul class=\"list\"><li><strong>E → E♯</strong> = sounds like F</li><li><strong>F → F♭</strong> = sounds like E</li><li><strong>B → B♯</strong> = sounds like C</li><li><strong>C → C♭</strong> = sounds like B</li></ul><p>Accidentals aren’t just “between two tones”; they can push any tone wherever you need.</p><h5 class=\"h5\">🔊 How a half-step works — listen and watch</h5><p>Play the tone pairs and watch their notation. First you hear two neighbouring natural tones. Then the same pair with a half-step added — raised (sharp) or lowered (flat).</p><p>Notice how the half-step fills the space between the tones:</p><ul class=\"list\"><li>sonically it adds a subtle extra step,</li><li>visually a symbol appears that shifts the tone by the smallest possible interval.</li></ul>",
    reading_acc_sharp_title: "Sharp ♯ — raises by a half-step",
    reading_acc_sharp_p: "A sharp raises a tone by one half-step.",
    reading_acc_sharp_examples: "Examples: C → C♯, F → F♯, D → D♯",
    reading_acc_sharp_demo: "Listen to the sequence and see it in the staff:",
    reading_acc_sharp_plain: "C – D",
    reading_acc_sharp_raised: "C – C♯ – D",
    reading_acc_flat_title: "Flat ♭ — lowers by a half-step",
    reading_acc_flat_p: "A flat lowers a tone by one half-step.",
    reading_acc_flat_examples: "Examples: A → A♭, E → E♭",
    reading_acc_flat_demo: "Try it:",
    reading_acc_flat_plain: "A – G",
    reading_acc_flat_lowered: "A – A♭ – G",
    reading_acc_flat_hint: "You hear A → A♭ and notice the half-step drop.",
    reading_acc_doubles_title: "There are trickier variants too:",
    reading_acc_double_sharp: "Double sharp × — raises by a whole step",
    reading_acc_double_sharp_examples: "Raises a note by two half-steps: F → F× (sounds as G), C♯ → C× (sounds as D)",
    reading_acc_double_flat: "Double flat ♭♭ — lowers by a whole step",
    reading_acc_double_flat_examples: "Lowers a note by a whole step: B♭ → B♭♭ (sounds as A)",
    reading_acc_chromatic_title: "Seeing half-steps in the staff",
    reading_acc_chromatic_intro: "Here you can see the <strong>full chromatic row from C to the next C</strong>. Switch between two spellings: <strong>sharp version</strong> (C – C♯ – D – D♯ …) or <strong>flat version</strong> (C – D♭ – D – E♭ …).",
    reading_acc_spelling_sharp: "Sharp spelling",
    reading_acc_spelling_flat: "Flat spelling",
    reading_acc_chromatic_text: "Both rows <strong>sound exactly the same</strong>, but they look different. That shows accidentals have more than one spelling and music allows multiple ways to write the same sound.",
    reading_acc_chromatic_hint: "The tones between C and the next C can be notated in two ways — with sharps or with flats. They sound identical, but each spelling fits different contexts (scales, harmony, melodic direction). Music needs both systems.",
    reading_acc_chromatic_play: "Play the row",
    reading_acc_scale_title: "Same tone row at different heights",
    reading_acc_scale_intro: "Here’s the basic row C–D–E–F–G–A–B–C. Toggle sharp/flat spelling and shift it by half-steps — the interval pattern (whole–whole–half–whole–whole–whole–half) stays the same; only the pitch height changes.",
    reading_acc_scale_note: "Range: from middle C up to the next C. Accidentals change as you move the row. (Sometimes it matches a real major scale, other times it’s just a shifted row regardless of key signature.)",
    reading_acc_scale_label: "Row starts on",
    reading_acc_scale_down: "− half-step",
    reading_acc_scale_up: "+ half-step",
    reading_acc_scale_play: "Play the row",
    reading_acc_keyboard_title: "Try the tones on a keyboard",
    reading_acc_keyboard_intro: "Tap any white or black key to hear it and see the note above. Use the sharp/flat toggle to view the same pitch in both spellings — e.g., F♯ as G♭.",
    reading_acc_keyboard_text: "One keyboard, two spellings: the same pitch can appear as F♯ or G♭ depending on the musical context.",
    reading_acc_signature_title: "Accidentals vs. key signatures",
    reading_acc_signature_intro: "At first glance accidentals and key signatures look similar — both use sharps (♯) and flats (♭). But their meaning in notation is very different. To see how composers and performers choose between them, let’s look closer.",
    reading_acc_signature_acc_heading: "Accidental",
    reading_acc_signature_p1: "An accidental is a <strong>local change of pitch</strong>. It is written <strong>directly before the note</strong> and says: “this note should sound different from usual.” It applies <strong>only within one bar</strong>. It affects every instance of the same note in that bar. At the start of the next bar its effect disappears.",
    reading_acc_signature_p2: "When to use it? when a melody needs a brief raise or lower, when you want a chromatic move, when you don’t want to change the character of the whole piece — only a moment.",
    reading_acc_signature_key_heading: "Key signature",
    reading_acc_signature_p3: "A key signature is a <strong>permanent rule for the staff line</strong>, written <strong>at the start of the staff</strong> right after the clef. It tells which tones are <strong>automatically</strong> raised or lowered whenever they appear. It lasts to the end of the line. On the next line it is repeated so it’s clear which key the music continues in.",
    reading_acc_signature_p4: "It is not arbitrary! The sharps or flats in a key signature aren’t random. Each combination comes from a specific scale with its exact pattern of half-steps and whole steps. That’s why G major has one sharp and F major one flat — their scales dictate it (explained in the scales chapter).",
    reading_acc_signature_p5: "A key signature is written <strong>on the same staff line or space</strong> where the affected note would sit. That way you immediately see which note changes — a sharp on F is always on F’s height, a flat on B (B♭) always on B’s height.",
    reading_acc_signature_p6: "Practically: if a piece has one sharp (♯), it means <strong>every F</strong> is actually <strong>F♯</strong> without writing the sharp again.",
    reading_acc_signature_p7: "The key signature says: “This piece is built so some tones are raised or lowered from the start.” It is part of the key — more on that later. How to spot it? If a note has a sharp or flat before it, that’s an accidental. If the sharps or flats are at the start of the line, that’s a key signature. The signature is the “long-term setting”, the accidental is the “short-term tweak”. They often work together: a piece can have a lasting raise or lower, yet still need one-off exceptions.",
    reading_acc_signature_p8: "Here you can see two spellings of the same bar – once with a key signature and once with accidentals on each note. They sound identical but look different. That shows when a signature is clearer (a change for the whole piece) and when accidentals make more sense (only a few notes in the bar).",
    reading_acc_signature_staff_signature: "Key signature",
    reading_acc_signature_staff_acc: "Accidentals on each note",
    reading_acc_natural_title: "Natural ♮ — returning to the original pitch (and one special case)",
    reading_acc_natural_text: "The natural sign ♮ is a <strong>special accidental</strong> that cancels a previous sharp or flat. It brings the note back to its <strong>original natural pitch</strong>, the form without accidentals.",
    reading_acc_natural_scope: "It applies — like other accidentals — <strong>only within one bar</strong>. At the start of a new bar its effect is gone.",
    reading_acc_natural_demo_intro: "<strong>Check out this short example</strong> to see how a key signature, a natural, and a one-off accidental work together. Watch what holds for the whole bar and what resets at the barline — and listen a few times to lock it in.",
    reading_acc_cautionary_title: "Special case: cautionary accidental",
    reading_acc_cautionary_text: "There’s another type of accidental — the <strong>cautionary accidental</strong>. It can be a sharp, flat, or natural, but its purpose is always the same: <br/><br/><strong>it does not change the pitch</strong><br/><br/>it only <strong>alerts the player</strong> to something that already applies (e.g., a note is still sharp/flat, or it returns to natural),<br/>it is used where the change could be easily missed — after a long pause, a melodic leap, at a new line, or in dense notation. <br/>It looks identical to a regular accidental, but it is <strong>purely a reminder</strong> — the sound stays the same as it would without it. It’s added for clarity and confidence in fast or complex passages.",
    reading_acc_cautionary_demo_intro: "In the example below the natural sign in bar two is purely a reminder — it sounds the same even without it.",
    reading_theory_articulation_title: "How to play a note",
    reading_theory_articulation_desc: "Legato, staccato, tenuto, accents and phrasing.",
    reading_theory_articulation_annotation: "Ways to shape the sound — legato, staccato, tenuto, accent and basic phrasing.",
    reading_theory_marks_title: "Rhythm signs",
    reading_theory_marks_desc: "Symbols that organise rhythm, grouping and emphasis.",
    reading_theory_marks_annotation: "Signs for rhythm and grouping — beams, rests, ligatures, barlines and ties.",
    reading_theory_navigation_title: "Navigation marks",
    reading_theory_navigation_desc: "Wayfinding in notation: repeats, D.C./D.S., coda and segno cues.",
    reading_theory_navigation_annotation: "Navigation marks for repeats and jumps — D.C., D.S., coda, fine and other wayfinding cues.",
    oct_subcontra: "Sub-contra octave",
    oct_contra: "Contra octave",
    oct_great: "Great octave",
    oct_small: "Small octave",
    oct_one: "One-line octave",
    oct_two: "Two-line octave",
    oct_three: "Three-line octave",
    oct_range_from: " – notes from ",
    oct_range_to: " up to ",
    note_letter_C: "C",
    note_letter_D: "D",
    note_letter_E: "E",
    note_letter_F: "F",
    note_letter_G: "G",
    note_letter_A: "A",
    note_letter_B: "B",
    reading_practice_heading: "Practice",
    reading_practice_find_title: "Find the right note",
    reading_practice_find_desc: "A note is shown—identify its name (e.g. “E”).",
    reading_find_clef_treble: "Treble",
    reading_find_clef_bass: "Bass",
    reading_practice_place_title: "Write the right note",
    reading_practice_place_desc: "Given a note name (“A”), click its correct position on the staff.",
    reading_practice_rhythm_title: "Build the right rhythm",
    reading_practice_rhythm_desc: "Fill in the missing rhythm to complete the bar.",
    reading_practice_clef_title: "Clef reading",
    reading_practice_clef_desc: "Switch between treble and bass clefs and recognise note positions quickly.",
    reading_practice_accidentals_title: "Accidentals & signatures",
    reading_practice_accidentals_desc: "Identify the correct pitch for notes with accidentals (e.g. G♯, B♭).",
    reading_find_title: "Find the right note",
    reading_find_intro_heading: "Find the Note on the Staff",
    reading_find_intro_copy: "Quick and accurate note recognition is the key to fluent reading. In this exercise, you'll practice identifying tones in the staff based on the clef, chosen range, and accidentals. Can you keep your cool and pick the right answer every time?",
    reading_find_config_heading: "Set up your exercise",
    reading_find_param_clef: "Clef",
    reading_find_param_range: "Note range",
    reading_find_param_range_from: "From",
    reading_find_param_range_to: "To",
    reading_find_param_acc: "Sharps and flats",
    reading_find_param_acc_off: "No accidentals",
    reading_find_param_acc_on: "Include accidentals",
    reading_find_param_count: "Number of notes",
    reading_find_param_timer: "Timer",
    reading_find_timer_off: "Off",
    reading_find_timer_5: "5 s",
    reading_find_timer_3: "3 s",
    reading_find_timer_1: "1 s",
    reading_find_timer_label: "Time",
    reading_find_start: "Start practice",
    reading_find_instruction: "Pick the note name for the highlighted symbol.",
    reading_find_evaluate: "Evaluate",
    reading_find_reset: "Clear answers",
    reading_find_summary_heading: "Practice results",
    reading_find_summary_correct: "Correct",
    reading_find_summary_wrong: "Incorrect",
    reading_find_restart: "Try again with same settings",
    reading_find_back: "Back to setup",
    reading_place_title: "Place the note",
    reading_place_intro: "You’ll be given a note name — place it on the correct line or space of the staff. Pick the clef and range you want, place notes in any order, then hit Evaluate when you're ready.",
    reading_place_param_clef: "Clef",
    reading_place_param_range: "Note range",
    reading_place_param_range_start: "From",
    reading_place_param_range_end: "To",
    reading_place_param_count: "Number of notes",
    reading_place_start: "Start practice",
    reading_place_instruction: "Tap or click inside the staff and drag to adjust the pitch. The assignment (e.g. g1) stays below each column—hit Evaluate whenever you’re ready.",
    reading_place_target_label: "{note}",
    reading_place_target_done: "All set – hit Evaluate",
    reading_place_evaluate: "Evaluate",
    reading_place_reset: "Clear answers",
    reading_place_summary_correct: "Correct",
    reading_place_summary_wrong: "Incorrect",
    reading_place_restart: "Try again with same settings",
    reading_place_back: "Back to setup",
    reading_rhythm_practice_title: "Build the right rhythm",
    reading_rhythm_practice_intro: "Fill the missing values so the bar exactly matches the meter. Pick the meters and number of questions, then practise counting beats.",
    reading_rhythm_practice_counts: "Number of questions",
    reading_rhythm_practice_meters: "Choose meters",
    reading_rhythm_practice_start: "Start exercise",
    reading_rhythm_practice_reset: "Reset bar",
    reading_rhythm_practice_back: "Back to selection",
    reading_rhythm_practice_next: "Next",
    reading_rhythm_practice_remaining: "Remaining: {beats}",
    reading_rhythm_practice_palette_notes: "Notes",
    reading_rhythm_practice_palette_rests: "Rests",
    reading_rhythm_practice_palette_pool: "Available values",
    reading_rhythm_practice_summary_title: "Exercise result",
    reading_rhythm_practice_summary_again: "Practice again",
    reading_rhythm_practice_summary_select: "Back to selection",
    reading_rhythm_practice_summary_correct: "Correct",
    reading_rhythm_practice_summary_wrong: "Needs fix",
    reading_rhythm_practice_diff_ok: "Looks perfect.",
    reading_rhythm_practice_diff_over: "Too much: {beats}",
    reading_rhythm_practice_diff_under: "Missing: {beats}",
    reading_clef_title: "Clef reading",
    reading_clef_coming: "Coming soon: instant switching between treble and bass clefs.",
    reading_acc_title: "Accidentals & signatures",
    reading_acc_coming: "Coming soon: exercises with sharps, flats, and key signatures in context.",
    select_all: "Select all",
    clear_all: "Clear all",
    detail_minor7: "Natural minor",
    detail_harmonic_minor: "Harmonic minor",
    detail_melodic_minor: "Melodic minor",
    detail_major7: "Major (Ionian)",
    detail_penta_minor: "Minor pentatonic",
    detail_penta_major: "Major pentatonic",
    detail_triad_minor: "Minor triad",
    detail_triad_major: "Major triad",
    detail_blue: "Blue note (b5 from minor)",
    correct_short: "Correct!",
    correct_is: "Correct answer",
    correct_label: "Correct:",
    your_click: "Your choice",
    summary_acc_label: "Key signature",

    // Labels & common nouns
    label_acc: "Key signature",
    label_penta_minor: "Minor pentatonic",
    label_scale_major: "Major scale",
    label_scale_minor: "Minor scale",
    label_blue: "Blue note",
    label_major: "Major",
    label_minor: "Minor",
    word_dur: "major",
    word_moll: "minor",
    label_yours: "yours",
    label_correct: "correct",
    finish: "Finish",

    // Circle legend labels
    variant: "farmonic variant",
    circle_acc_label: "Key signature",
    circle_count_label: "Accidentals (♯/♭)",
    circle_rel_minor: "Relative minor",
    circle_next_sharp: "Up a fifth (→)",
    circle_next_flat: "Down a fifth (←)",
    ksq_heading_acc: "Signature",

    // Mottos & badges
    motto_low: "Every master started from zero. Try again!",
    motto_mid: "Solid effort! Focus on the details.",
    motto_high: "Great job! You're almost there.",
    motto_perfect: "Awesome work! Your ears are on point 🎶",
    badge_gold: "🥇 Golden tone",
    badge_silver: "🥈 Silver tone",
    badge_bronze: "🥉 Bronze tone",
    badge_retry: "😩 Start over"
  };

  const LANG_KEY = 'lang';
  const SUPPORTED_DICT = { cs: dict_cs, en: dict_en };
  const storedLang = (()=>{
    try { return localStorage.getItem(LANG_KEY); } catch(e){ return null; }
  })();

  // Simple translator
  const I18N = {
    lang: SUPPORTED_DICT[storedLang] ? storedLang : 'cs',
    dict: SUPPORTED_DICT,
    t(key){
      return (I18N.dict[I18N.lang] || {})[key] || key;
    },
    apply(root=document){
      root.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const html = el.getAttribute('data-i18n-html') === '1';
        const val = I18N.t(key);
        if(html){ el.innerHTML = val; }
        else { el.textContent = val; }
      });
    },
    setLang(lang){
      if(!I18N.dict[lang]) return;
      I18N.lang = lang;
      try { localStorage.setItem(LANG_KEY, lang); } catch(e){}
      I18N.apply();
      const sel = document.getElementById('lang-switch');
      if(sel && sel.value !== lang) sel.value = lang;
      if(window.App && typeof App.refreshLang==='function') App.refreshLang();
      if(window.__toniqa_colorizeSummaries) window.__toniqa_colorizeSummaries();
    }
  };

  window.I18N = I18N;
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel = document.getElementById('lang-switch');
    if(sel){
      sel.value = I18N.lang;
      sel.addEventListener('change', ()=> I18N.setLang(sel.value));
    }
    I18N.apply();
  });
})();
</script>
<script>

(function(){
  const BAD = new Set(['eval-ok','eval-bad','eval-card-ok','eval-card-bad','is-ok','is-bad']);
  const CONTAINER_SEL = ['main.card','.summary-list','.list-card','.grid-2','.card','.wrap','.brandbar','#view-build-summary','#view-ksq-summary','#view-circq2-summary'].join(',');
  const LEAF_SEL = '.eval-card, .badge-eval'; // only these may keep is-ok / is-bad
  function scrub(el){
    if(!el) return;
    // do not touch leaves
    if(el.matches && el.matches(LEAF_SEL)) return;
    // strip status-y classes
    if(el.classList){
      let changed = false;
      BAD.forEach(c=>{ if(el.classList.contains(c)){ el.classList.remove(c); changed = true; } });
    }
  }
  function deepScrub(root){
    try{
      document.querySelectorAll(CONTAINER_SEL).forEach(scrub);
    }catch(e){}
  }
  function installObserver(){
    const obs = new MutationObserver((muts)=>{
      for(const m of muts){
        if(m.type==='attributes' && m.attributeName==='class'){
          const t = m.target;
          if(t && t.nodeType===1){
            // Only allow is-ok/is-bad on leaf rows
            if(!t.matches(LEAF_SEL)){
              BAD.forEach(c=>{ if(t.classList.contains(c)) t.classList.remove(c); });
            }
          }
        }
      }
    });
    // observe fairly high in the tree
    obs.observe(document.documentElement, { attributes:true, attributeFilter:['class'], subtree:true });
    return obs;
  }
  // Run ASAP
  if(document.readyState === 'loading'){
    // initial purge as soon as possible
    document.addEventListener('DOMContentLoaded', deepScrub, {once:true});
  } else {
    deepScrub(document);
  }
  // also purge right now any already-present containers
  deepScrub(document);
  // install observer to prevent re-adding
  installObserver();
  // expose manual API if needed
  window.__evalLeafGuard = { refresh: deepScrub };
})();
</script>
<!-- ===== ICON SPRITE (set: basic) — start ===== -->
<svg aria-hidden="true" width="0" height="0" style="position:absolute;left:-9999px;top:-9999px;">
  <!-- Basic set: scalable, stroke-current icons -->
  <symbol id="basic-scales" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
  <!-- subtilní notová osnova -->
    <path d="M6 20H90M6 28H90M6 36H90M6 44H90"/>
  </g>

  <!-- dva křížky (♯♯) -->
  <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
    <!-- první ♯ -->
    <path d="M18 14V50M24 12V48"/>
    <path d="M12 26L30 22M12 38L30 34"/>

    <!-- druhý ♯ -->
    <path d="M42 14V50M48 12V48"/>
    <path d="M36 26L54 22M36 38L54 34"/>
  </g>

  <!-- dvě béčka (♭♭) -->
  <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
    <!-- první ♭ -->
    <path d="M66 12V50"/>
    <path d="M66 36
             c 10 -12, 16 0,  0 14
"/>

    <!-- druhé ♭ -->
    <path d="M80 12V50"/>
    <path d="M80 36
             c 10 -12, 16 0,  0 14
             "/>
  </g>

  </symbol>
  <symbol id="basic-intervals" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M6 44h52M6 36h52M6 28h52M6 20h52"/>
      <circle cx="20" cy="36" r="4" fill="currentColor"/>
      <path d="M24 36v-14h10"/>
      <circle cx="38" cy="30" r="4" fill="currentColor"/>
      <path d="M42 30v-10h8"/>
    </g>
  </symbol>
  <symbol id="basic-chords" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
     
    </g>
    <circle cx="20" cy="40" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>
    <circle cx="20" cy="32" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>
    <circle cx="20" cy="24" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>

    <circle cx="33" cy="36" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>
    <circle cx="33" cy="28" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>
    <circle cx="33" cy="20" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>

    <circle cx="46" cy="32" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>
    <circle cx="46" cy="24" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>
    <circle cx="46" cy="16" r="3.5" stroke = "currentColor" stroke-width="3" fill="transparent"/>


  </symbol>
  <symbol id="basic-dynamics" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 44L30 32 10 20"/>
      <path d="M28 44L48 32 28 20"/>
      <path d="M54 20v24"/>
      <path d="M54 32c-4 0-6 2-6 6s2 6 6 6"/>
    </g>
  </symbol>
  <symbol id="basic-expressions" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 42c6-10 14-10 20 0"/>
      <path d="M18 24c2-4 4-6 8-6"/>
      <path d="M30 30c2-6 6-10 12-10 6 0 10 4 10 10s-4 10-10 10c-4 0-6-2-8-4"/>
      <path d="M50 22c4-2 8-2 12 0"/>
    </g>
  </symbol>
  <symbol id="basic-reading-find" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h32M8 36h32M8 28h32M8 20h32"/>
      <circle cx="30" cy="32" r="4.2" fill="currentColor"/>
      <path d="M34 32v-10"/>
      <circle cx="46" cy="38" r="7"/>
      <path d="M51 43l7 7"/>
    </g>
  </symbol>
  <symbol id="basic-reading-place" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M32 18v28"/>
      <circle cx="32" cy="32" r="5" fill="currentColor"/>
      <path d="M20 24l-6-6M20 40l-6 6M44 24l6-6M44 40l6 6"/>
    </g>
  </symbol>
  <symbol id="basic-reading-rhythm" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M22 18v26"/>
      <path d="M34 22v22"/>
      <path d="M46 26v18"/>
      <path d="M22 28c6-6 12-6 16 0 4-6 10-6 14 0" fill="none"/>
      <circle cx="22" cy="38" r="4.2" fill="currentColor"/>
      <circle cx="34" cy="34" r="4.2" fill="currentColor"/>
      <circle cx="46" cy="30" r="4.2" fill="currentColor"/>
    </g>
  </symbol>
  <symbol id="basic-reading-clef" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M26 16c-6 0-8 6-4 10s10 2 10-4-6-8-10-4"/>
      <path d="M32 22c0 8-6 14-12 18"/>
      <path d="M40 26c0-5 4-8 8-8 6 0 8 5 5 8-3 4-13 4-13 9 0 3 3 5 6 5 4 0 6-2 7-4"/>
      <circle cx="40" cy="42" r="2" fill="currentColor"/>
      <circle cx="48" cy="38" r="2" fill="currentColor"/>
    </g>
  </symbol>
  <symbol id="basic-reading-acc" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M24 16v36M32 14v36"/>
      <path d="M20 26h16M20 34h16"/>
      <circle cx="46" cy="30" r="4.2" fill="none"/>
      <path d="M46 22v16"/>
      <path d="M42 34c3 2 5 2 8 0" />
    </g>
  </symbol>
  <symbol id="basic-reading-theory-staff" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
 <path d="m30.049 3.5296c0.305 3.1263-2.019 5.6563-4.0772 7.7014-0.9349 0.897-0.155 0.148-0.6437 0.594-0.1022-0.479-0.2986-1.731-0.2802-2.11 0.1304-2.6939 2.3198-6.5875 4.2381-8.0236 0.309 0.5767 0.563 0.6231 0.763 1.8382zm0.651 16.142c-1.232-0.906-2.85-1.144-4.3336-0.885-0.1913-1.255-0.3827-2.51-0.574-3.764 2.3506-2.329 4.9066-5.0322 5.0406-8.5394 0.059-2.232-0.276-4.6714-1.678-6.4836-1.7004 0.12823-2.8995 2.156-3.8019 3.4165-1.4889 2.6705-1.1414 5.9169-0.57 8.7965-0.8094 0.952-1.9296 1.743-2.7274 2.734-2.3561 2.308-4.4085 5.43-4.0046 8.878 0.18332 3.334 2.5894 6.434 5.8702 7.227 1.2457 0.315 2.5639 0.346 3.8241 0.099 0.2199 2.25 1.0266 4.629 0.0925 6.813-0.7007 1.598-2.7875 3.004-4.3325 2.192-0.5994-0.316-0.1137-0.051-0.478-0.252 1.0698-0.257 1.9996-1.036 2.26-1.565 0.8378-1.464-0.3998-3.639-2.1554-3.358-2.262 0.046-3.1904 3.14-1.7356 4.685 1.3468 1.52 3.833 1.312 5.4301 0.318 1.8125-1.18 2.0395-3.544 1.8325-5.562-0.07-0.678-0.403-2.67-0.444-3.387 0.697-0.249 0.209-0.059 1.193-0.449 2.66-1.053 4.357-4.259 3.594-7.122-0.318-1.469-1.044-2.914-2.302-3.792zm0.561 5.757c0.214 1.991-1.053 4.321-3.079 4.96-0.136-0.795-0.172-1.011-0.2626-1.475-0.4822-2.46-0.744-4.987-1.116-7.481 1.6246-0.168 3.4576 0.543 4.0226 2.184 0.244 0.577 0.343 1.197 0.435 1.812zm-5.1486 5.196c-2.5441 0.141-4.9995-1.595-5.6343-4.081-0.749-2.153-0.5283-4.63 0.8207-6.504 1.1151-1.702 2.6065-3.105 4.0286-4.543 0.183 1.127 0.366 2.254 0.549 3.382-2.9906 0.782-5.0046 4.725-3.215 7.451 0.5324 0.764 1.9765 2.223 2.7655 1.634-1.102-0.683-2.0033-1.859-1.8095-3.227-0.0821-1.282 1.3699-2.911 2.6513-3.198 0.4384 2.869 0.9413 6.073 1.3797 8.943-0.5054 0.1-1.0211 0.143-1.536 0.143z"/>

    </g>
  </symbol>
  <symbol id="basic-reading-theory-notes" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <circle cx="18" cy="38" r="4.2" fill="currentColor"/>
      <path d="M22 38v-14"/>
      <circle cx="32" cy="30" r="4.2" fill="currentColor"/>
      <path d="M36 30v-12"/>
      <circle cx="46" cy="24" r="4.2" fill="currentColor"/>
      <path d="M50 24v-10"/>
      <path d="M14 32c4-4 8-4 12 0 4-4 8-4 12 0 4-4 8-4 12 0"/>
    </g>
  </symbol>
  <symbol id="basic-reading-theory-rhythm" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M18 18v26"/>
      <path d="M30 22v22"/>
      <path d="M42 26v18"/>
      <path d="M54 30v14"/>
      <circle cx="18" cy="38" r="4.2" fill="currentColor"/>
      <circle cx="30" cy="34" r="4.2" fill="currentColor"/>
      <circle cx="42" cy="30" r="4.2" fill="currentColor"/>
      <circle cx="54" cy="28" r="4.2" fill="currentColor"/>
    </g>
  </symbol>
  <symbol id="basic-reading-theory-acc" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M20 16v36M28 14v36"/>
      <path d="M16 26h16M16 34h16"/>
      <path d="M38 22c6 0 8 4 8 8s-2 8-8 8"/>
      <path d="M38 38c4 0 6 2 6 6s-2 6-6 6"/>
      <path d="M48 16v36"/>
      <path d="M56 18v32"/>
      <path d="M48 26h8M48 34h8"/>
    </g>
  </symbol>
<symbol id="basic-clef-treble" viewBox="0 0 15.3 41" overflow="visible">
  <path
    fill="currentColor"
    stroke="currentColor"
    stroke-width="0.8"
    stroke-linecap="round"
    stroke-linejoin="round"
    d="M12.049 3.5296c0.305 3.1263-2.019 5.6563-4.0772 7.7014-0.9349 0.897-0.155 0.148-0.6437 0.594-0.1022-0.479-0.2986-1.731-0.2802-2.11 0.1304-2.6939 2.3198-6.5875 4.2381-8.0236 0.309 0.5767 0.563 0.6231 0.763 1.8382zm0.651 16.142c-1.232-0.906-2.85-1.144-4.3336-0.885-0.1913-1.255-0.3827-2.51-0.574-3.764 2.3506-2.329 4.9066-5.0322 5.0406-8.5394 0.059-2.232-0.276-4.6714-1.678-6.4836-1.7004 0.12823-2.8995 2.156-3.8019 3.4165-1.4889 2.6705-1.1414 5.9169-0.57 8.7965-0.8094 0.952-1.9296 1.743-2.7274 2.734-2.3561 2.308-4.4085 5.43-4.0046 8.878 0.18332 3.334 2.5894 6.434 5.8702 7.227 1.2457 0.315 2.5639 0.346 3.8241 0.099 0.2199 2.25 1.0266 4.629 0.0925 6.813-0.7007 1.598-2.7875 3.004-4.3325 2.192-0.5994-0.316-0.1137-0.051-0.478-0.252 1.0698-0.257 1.9996-1.036 2.26-1.565 0.8378-1.464-0.3998-3.639-2.1554-3.358-2.262 0.046-3.1904 3.14-1.7356 4.685 1.3468 1.52 3.833 1.312 5.4301 0.318 1.8125-1.18 2.0395-3.544 1.8325-5.562-0.07-0.678-0.403-2.67-0.444-3.387 0.697-0.249 0.209-0.059 1.193-0.449 2.66-1.053 4.357-4.259 3.594-7.122-0.318-1.469-1.044-2.914-2.302-3.792zm0.561 5.757c0.214 1.991-1.053 4.321-3.079 4.96-0.136-0.795-0.172-1.011-0.2626-1.475-0.4822-2.46-0.744-4.987-1.116-7.481 1.6246-0.168 3.4576 0.543 4.0226 2.184 0.244 0.577 0.343 1.197 0.435 1.812zm-5.1486 5.196c-2.5441 0.141-4.9995-1.595-5.6343-4.081-0.749-2.153-0.5283-4.63 0.8207-6.504 1.1151-1.702 2.6065-3.105 4.0286-4.543 0.183 1.127 0.366 2.254 0.549 3.382-2.9906 0.782-5.0046 4.725-3.215 7.451 0.5324 0.764 1.9765 2.223 2.7655 1.634-1.102-0.683-2.0033-1.859-1.8095-3.227-0.0821-1.282 1.3699-2.911 2.6513-3.198 0.4384 2.869 0.9413 6.073 1.3797 8.943-0.5054 0.1-1.0211 0.143-1.536 0.143z"
  />
</symbol>
  <symbol id="basic-clef-bass" viewBox="0 0 50.160763 50" overflow="visible">
    <g transform="translate(-80.59801,-338.389)">
      <path fill="currentColor" stroke="currentColor" stroke-width="0.8" stroke-linecap="round" stroke-linejoin="round" d="M 94.573707,338.62098 C 85.788865,338.82892 79.05876,344.98307 81.239785,354.40822 C 81.242355,354.41932 81.253126,354.42897 81.255716,354.44008 C 81.511763,357.69062 84.216419,360.25476 87.532378,360.25476 C 91.017261,360.25476 93.8409,357.43111 93.8409,353.94623 C 93.8409,350.87486 91.650198,348.31384 88.743104,347.74923 C 87.584624,347.33934 85.847143,346.40732 85.923385,344.91358 C 85.95853,344.17015 86.826419,342.8217 88.217394,342.14165 C 89.907945,341.3483 91.651172,340.91899 93.410772,341.2814 C 96.0781,341.76834 102.8994,346.66633 103.43113,355.15696 C 103.73634,361.60349 100.11523,370.30719 96.580965,374.433 C 90.883353,380.93635 81.730382,384.97598 82.625749,385.69594 C 83.42938,386.41591 94.235755,381.47668 99.862669,375.27732 C 106.72952,367.84162 110.12894,361.64359 109.80337,354.10554 C 109.60755,346.56749 103.77166,338.40634 94.573707,338.62098 z"/>
        <circle cx="120" cy="345" r="4" fill="currentColor"/>
        <circle cx="120" cy="357" r="4" fill="currentColor"/>
    </g>
  </symbol>
  <symbol id="basic-clef-alto" viewBox="0 0 290 290">
    <g >
    <rect id="XMLID_517_" y="7.5" width="60" height="270"/>
    <rect id="XMLID_518_" x="90" y="7.5" width="30" height="270"/>
    <path id="XMLID_519_" d="M225,157.428v-29.855c33.084,0,60-26.916,60-60c0-33.084-26.916-60-60-60
      c-31.424,0-57.18,23.901-59.779,54.892c-0.02,0.158-0.173,1.825-0.173,2.515c0,0.031,0.005,0.06,0.005,0.091
      c-0.001,0.024-0.004,0.047-0.005,0.071l0.009,0.001c0.088,10.97,9,19.837,19.991,19.837c11.046,0,20-8.954,20-20
      c0-5.252-2.041-10.017-5.353-13.586c5.326-8.344,14.666-13.821,25.305-13.821c16.542,0,30,13.458,30,30c0,16.542-13.458,30-30,30
      V82.5l-75,60l75,60v-15.072c16.542,0,30,13.458,30,29.999c0,16.542-13.458,30.001-30,30.001c-10.639,0-19.979-5.477-25.305-13.821
      c3.312-3.569,5.353-8.333,5.353-13.586c0-11.046-8.954-20-20-20c-10.991,0-19.903,8.868-19.991,19.837l-0.009,0.001
      c0.001,0.024,0.004,0.047,0.005,0.071c0,0.031-0.005,0.06-0.005,0.091c0,0.69,0.153,2.357,0.173,2.515
      c2.6,30.991,28.355,54.892,59.779,54.892c33.084,0,60-26.916,60-60.001C285,184.343,258.084,157.428,225,157.428z"/>
  </symbol>
  <symbol id="basic-clef-tenor" viewBox="0 0 290 290">
    <g >
    <rect id="XMLID_517_" y="7.5" width="60" height="270"/>
    <rect id="XMLID_518_" x="90" y="7.5" width="30" height="270"/>
    <path id="XMLID_519_" d="M225,157.428v-29.855c33.084,0,60-26.916,60-60c0-33.084-26.916-60-60-60
      c-31.424,0-57.18,23.901-59.779,54.892c-0.02,0.158-0.173,1.825-0.173,2.515c0,0.031,0.005,0.06,0.005,0.091
      c-0.001,0.024-0.004,0.047-0.005,0.071l0.009,0.001c0.088,10.97,9,19.837,19.991,19.837c11.046,0,20-8.954,20-20
      c0-5.252-2.041-10.017-5.353-13.586c5.326-8.344,14.666-13.821,25.305-13.821c16.542,0,30,13.458,30,30c0,16.542-13.458,30-30,30
      V82.5l-75,60l75,60v-15.072c16.542,0,30,13.458,30,29.999c0,16.542-13.458,30.001-30,30.001c-10.639,0-19.979-5.477-25.305-13.821
      c3.312-3.569,5.353-8.333,5.353-13.586c0-11.046-8.954-20-20-20c-10.991,0-19.903,8.868-19.991,19.837l-0.009,0.001
      c0.001,0.024,0.004,0.047,0.005,0.071c0,0.031-0.005,0.06-0.005,0.091c0,0.69,0.153,2.357,0.173,2.515
      c2.6,30.991,28.355,54.892,59.779,54.892c33.084,0,60-26.916,60-60.001C285,184.343,258.084,157.428,225,157.428z"/>
    </g>
    </symbol>
  <symbol id="basic-reading-theory-articulation" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M12 34c10-14 30-14 40 0"/>
      <circle cx="20" cy="38" r="3" fill="currentColor"/>
      <circle cx="30" cy="34" r="3" fill="currentColor"/>
      <path d="M44 24v12"/>
      <path d="M44 24l8-6"/>
    </g>
  </symbol>
  <symbol id="basic-reading-theory-marks" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M20 18v22c0 8-10 10-10 0"/>
      <path d="M34 18v26"/>
      <path d="M34 24c4-4 8-4 12 0"/>
      <path d="M46 30c4-4 8-4 12 0"/>
      <path d="M34 30l8-4"/>
      <path d="M46 36l8-4"/>
    </g>
    <circle cx="26" cy="34" r="3" fill="currentColor"/>
  </symbol>
  <symbol id="basic-reading-theory-navigation" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M20 18v26"/>
      <path d="M44 18v26"/>
      <path d="M20 26l-8-8M20 34l-8 8"/>
      <path d="M44 26l8-8M44 34l8 8"/>
      <circle cx="32" cy="20" r="3.5" fill="none"/>
      <path d="M32 23v11"/>
      <path d="M28 30h8"/>
    </g>
  </symbol>
  <symbol id="basic-build" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 44h48M8 36h48M8 28h48M8 20h48"/>
      <path d="M26 36V24M38 28V16M50 20V10"/>
      <path d="M26 24L50 8"/>
      <path d="M44 12L50 8 50 14"/>
    </g>
    <circle cx="26" cy="36" r="4.2" fill="currentColor"/>
    <circle cx="38" cy="28" r="4.2" fill="currentColor"/>
    <circle cx="50" cy="20" r="4.2" fill="currentColor"/>
  </symbol>
  <symbol id="basic-reading" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 50c8-6 16-6 24 0c8-6 16-6 24 0V14c-8-6-16-6-24 0c-8-6-16-6-24 0z"/>
      <path d="M32 14v36"/>
      <path d="M20 26h8M20 34h6M44 26h-8M44 34h-6"/>
    </g>
  </symbol>
  <symbol id="basic-info" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="32" cy="32" r="22"/>
      <line x1="32" x2="32" y1="26" y2="44"/>
    </g>
    <circle cx="32" cy="20" r="2.5" fill="currentColor"/>
  </symbol>
  <symbol id="basic-circle" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="32" cy="32" r="22"/>
      <path d="M32 10v8M54 32h-8M32 54v-8M10 32h8"/>
    </g>
  </symbol>
  <symbol id="basic-circle-quiz" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="32" cy="32" r="22"/>
      <path d="M32 10v8M54 32h-8M32 54v-8M10 32h8"/>
      <path d="M32 20c5 0 9 3.4 9 8 0 3-1.4 5-4.4 6.8-2.2 1.3-3.6 2.4-3.6 5.2v2" />
    </g>
    <circle cx="32" cy="48" r="2.5" fill="currentColor"/>
  </symbol>
  <symbol id="basic-ksquiz" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20h40"/>
      <path d="M12 28h40"/>
      <path d="M12 36h40"/>
      <path d="M12 44h40"/>
      <path d="M18 16v26"/>
       <path d="M12 26L30 22M12 38L30 34"/>
      <path d="M24 16v26"/>
     
      <path d="M36 18v28"/>
      <path d="M36 36c8-6 12 6 0 10"/>
      
    </g>
 
  </symbol>
  <symbol id="basic-back" viewBox="0 0 64 64">
    <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M30 16L14 32l16 16"/>
      <path d="M50 32H16"/>
    </g>
  </symbol>
</svg>
<!-- ===== ICON SPRITE (set: basic) — end ===== -->
<script id="icon-lib">
(function(){
  // ===== ICON LIB (registry + helper) — set: basic =====
  const REGISTRY = {
    current: 'basic',
    map: {
      basic: {
        scales:  'basic-scales',
        intervals:'basic-intervals',
        chords:  'basic-chords',
        dynamics:'basic-dynamics',
        expressions:'basic-expressions',
        readingFind:'basic-reading-find',
        readingPlace:'basic-reading-place',
        readingRhythm:'basic-reading-rhythm',
        readingClef:'basic-reading-clef',
        readingAcc:'basic-reading-acc',
        readingTheoryStaff:'basic-reading-theory-staff',
        readingTheoryNotes:'basic-reading-theory-notes',
        readingTheoryRhythm:'basic-reading-theory-rhythm',
        readingTheoryAcc:'basic-reading-theory-acc',
        readingTheoryArticulation:'basic-reading-theory-articulation',
        readingTheoryMarks:'basic-reading-theory-marks',
        readingTheoryNavigation:'basic-reading-theory-navigation',
        clefTreble:'basic-clef-treble',
        clefBass:'basic-clef-bass',
        clefAlto:'basic-clef-alto',
        clefTenor:'basic-clef-tenor',
        build:   'basic-build',
        ksquiz:  'basic-ksquiz',
        reading: 'basic-reading',
        info:    'basic-info',
        circle:  'basic-circle',
        circleQuiz: 'basic-circle-quiz',
        back:    'basic-back'
      }
    }
  };
  function svg(name, sizeClass){
    const id = (REGISTRY.map[REGISTRY.current]||{})[name];
    if(!id) return null;
    const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
    if(sizeClass) s.setAttribute('class', sizeClass);
    s.setAttribute('aria-hidden','true');
    const u = document.createElementNS('http://www.w3.org/2000/svg','use');
    u.setAttribute('href', `#${id}`);
    s.appendChild(u);
    return s;
  }
  window.Icons = { REGISTRY, svg };
})();
</script>
<div class="wrap">
<main class="card" role="main">
<div class="brandbar">
<svg aria-hidden="true" class="logo" viewbox="0 0 64 64">
<circle cx="32" cy="32" fill="none" r="30" stroke="var(--brand-ring)" stroke-width="3"></circle>
<path d="M26 44a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" fill="var(--brand-primary)"></path>
<path d="M26 32V18h16" fill="none" stroke="var(--brand-primary)" stroke-linecap="round" stroke-width="4"></path>
<circle cx="42" cy="18" fill="var(--brand-primary)" r="2.5"></circle>
<path d="M42 44c5 0 9-4 9-9s-4-9-9-9" fill="none" stroke="var(--brand-secondary)" stroke-linecap="round" stroke-width="3"></path>
<circle cx="49" cy="50" fill="var(--brand-secondary)" r="3"></circle>
</svg>
<h1 class="brand"><script>document.write(I18N.t('app_title'));</script></h1>
<select id="lang-switch" class="theme-switch" aria-label="Změnit jazyk">
  <option value="cs">Čeština</option>
  <option value="en">English</option>
</select>
<select id="theme-switch" class="theme-switch" aria-label="Změnit motiv">
  <option value="midnight">Midnight</option>
  <option value="aurora">Aurora</option>
  <option value="daylight">Daylight</option>
</select>
</div><p class="claim" data-i18n="brand_claim"></p>
<section id="view-home">
<div class="grid-3 home-cards">
<div class="card-tile home-amber" data-tile="basics">
<div class="tile-head"><span data-icon="reading" class="icon-slot icon icon-28"></span><h3 data-i18n="home_basics_title"></h3></div>
<p class="sub" data-i18n="home_basics_desc"></p>
<button class="btn btn-ghost" id="go-basics" data-i18n="common_open"></button>
</div>
<div class="card-tile home-blue" data-tile="scales">
<div class="tile-head"><span data-icon="scales" class="icon-slot icon icon-28"></span><h3 data-i18n="home_scales_title"></h3></div>
<p class="sub" data-i18n="home_scales_desc"></p>
<button class="btn btn-green" id="go-scales-hub" data-i18n="common_open"></button>
</div>
<div class="card-tile home-green" data-tile="intervals">
<div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="home_intervals_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
<p class="sub" data-i18n="home_intervals_desc"></p>
<button class="btn btn-ghost" id="go-intervals" data-i18n="common_open"></button>
</div>
<div class="card-tile home-chords" data-tile="chords">
<div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="home_chords_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
<p class="sub" data-i18n="home_chords_desc"></p>
<button class="btn btn-ghost" id="go-chords" data-i18n="common_open"></button>
</div>
<div class="card-tile home-dynamics" data-tile="harmony">
<div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="home_harmony_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
<p class="sub" data-i18n="home_harmony_desc"></p>
<button class="btn btn-ghost" id="go-harmony" data-i18n="common_open"></button>
</div>
<div class="card-tile home-expressions" data-tile="improv">
<div class="tile-head"><span data-icon="reading-find" class="icon-slot icon icon-28"></span><h3 data-i18n="home_improv_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
<p class="sub" data-i18n="home_improv_desc"></p>
<button class="btn btn-ghost" id="go-improv" data-i18n="common_open"></button>
</div>
</div>
</section>
<style>
#view-reading-theory-acc .reading-acc-view{ width:100%; max-width:100%; margin:0 0 48px; padding:0 0 48px; }
#view-reading-theory-acc .reading-acc-hero{ display:flex; flex-direction:column; gap:10px; }
#view-reading-theory-acc .reading-acc-hero .h2{ margin:0; }
#view-reading-theory-acc .reading-acc-hero .sub{ margin:0; font-size:18px; color:var(--muted); }
#view-reading-theory-acc .reading-acc-card{ display:grid; gap:14px; }
#view-reading-theory-acc .reading-acc-card .h5{ font-size:18px; line-height:1.35; margin:12px 0 6px; }
#view-reading-theory-acc .reading-acc-demo,
#view-reading-theory-acc .reading-acc-demo-head .hint{ margin:0; color:var(--muted); }
#view-reading-theory-acc .reading-acc-staff{ border:1px dashed var(--border-subtle,rgba(15,23,42,.18)); border-radius:14px; background:var(--surface-subtle,rgba(15,23,42,.03)); padding:10px 12px; display:grid; gap:8px; }
#view-reading-theory-acc .reading-acc-staff svg{ width:100%; height:auto; max-height:320px; color:var(--ink); }
#view-reading-theory-acc .reading-acc-halfsteps{ gap:10px; }
#view-reading-theory-acc .acc-variant-grid{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
#view-reading-theory-acc .acc-variant-card{ border:1px solid var(--border-subtle,rgba(15,23,42,.14)); border-radius:12px; padding:16px; background:var(--surface-subtle,rgba(15,23,42,.04)); display:grid; gap:12px; align-content:start; width:100%; }
#view-reading-theory-acc .acc-variant-card .variant-label{ margin:0; font-weight:700; color:var(--ink); font-size:14px; text-align:center; }
#view-reading-theory-acc .acc-variant-card .reading-acc-staff{ padding:16px; border-radius:10px; border:1px dashed var(--border-subtle,rgba(15,23,42,.18)); margin:0 auto; display:flex; align-items:center; justify-content:center; min-height:260px; width:100%; }
#view-reading-theory-acc .acc-variant-card .reading-acc-staff svg{ width:100%; height:auto; margin:0 auto; display:block; }
#view-reading-theory-acc .acc-variant-card .btn{ width:50%; margin:0 auto; }
#view-reading-theory-acc .reading-acc-staff svg line{ stroke:var(--ink); }
#view-reading-theory-acc .reading-acc-staff svg [data-role="note-head"],
#view-reading-theory-acc .reading-acc-staff svg [data-role="ledger"],
#view-reading-theory-acc .reading-acc-staff svg [data-role="accidental"]{ fill:var(--ink); stroke:var(--ink); }
#view-reading-theory-acc .acc-pairs-grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
#view-reading-theory-acc .acc-pair-card{ border:1px solid var(--border-subtle,rgba(15,23,42,.16)); border-radius:12px; padding:10px; background:var(--surface-subtle,rgba(15,23,42,.02)); display:grid; gap:8px; align-content:start; }
#view-reading-theory-acc .acc-pair-card .pair-label{ font-weight:700; color:var(--ink); margin:0; }
#view-reading-theory-acc .acc-pair-card .reading-acc-staff{ padding:8px; border-radius:10px; }
#view-reading-theory-acc #acc-natural-staff{ min-height:260px; background:var(--surface-subtle,rgba(255,255,255,.04)); border:1px solid var(--border-strong,rgba(255,255,255,.12)); border-radius:12px; padding:10px 16px 14px; max-width:1240px; margin:6px auto 0; display:flex; align-items:center; justify-content:center; }
#view-reading-theory-acc #acc-natural-staff svg{ width:100%; height:auto; max-height:360px; display:block; color:var(--ink); }
#view-reading-theory-acc #acc-natural-staff svg line{ stroke:var(--ink); }
#view-reading-theory-acc #acc-natural-staff svg [data-role="note-head"],
#view-reading-theory-acc #acc-natural-staff svg [data-role="ledger"],
#view-reading-theory-acc #acc-natural-staff svg [data-role="accidental"]{ fill:var(--ink); stroke:var(--ink); }
#view-reading-theory-acc #acc-natural-staff svg text{ fill:var(--ink); font-weight:700; font-size:14px; }
#view-reading-theory-acc #acc-chromatic-staff{ max-width:900px; margin:0 auto; }
#view-reading-theory-acc #acc-chromatic-staff svg{ width:100%; max-width:100%; height:auto; display:block; margin:0 auto; border:0; }
#view-reading-theory-acc .reading-acc-chromatic-panel{ display:grid; gap:14px; max-width:900px; margin:0 auto; }
#view-reading-theory-acc .reading-acc-chromatic-panel .reading-acc-toggle{ justify-content:flex-start; }
#view-reading-theory-acc .reading-acc-chromatic-panel .chip-row{ justify-content:flex-start; }
#view-reading-theory-acc .reading-acc-chromatic-panel .btns{ justify-content:flex-start; }
#view-reading-theory-acc .reading-acc-staff svg [data-role="note-label"]{ fill:var(--ink); }
#view-reading-theory-acc .reading-acc-grid{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
#view-reading-theory-acc .reading-acc-doubles-grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
#view-reading-theory-acc .reading-acc-double{ border:1px solid var(--border-subtle,rgba(15,23,42,.14)); border-radius:12px; padding:12px 14px; background:var(--surface-subtle,rgba(15,23,42,.04)); display:grid; gap:8px; }
#view-reading-theory-acc .reading-acc-toggle{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
#view-reading-theory-acc .reading-acc-toggle .chip-row{ gap:8px; display:flex; flex-wrap:wrap; min-height:40px; align-items:center; width:100%; }
#view-reading-theory-acc .reading-acc-toggle .chip{ min-height:38px; }
#view-reading-theory-acc .reading-acc-scale-panel{ display:grid; gap:12px; max-width:760px; margin:0 auto; }
#view-reading-theory-acc .reading-acc-scale-spelling{ display:flex; gap:8px; justify-content:flex-start; }
#view-reading-theory-acc .reading-acc-scale-actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; }
#view-reading-theory-acc .reading-acc-scale-transpose{ display:flex; gap:8px; align-items:center; justify-content:center; padding:8px 10px; border:1px solid var(--border-subtle,rgba(15,23,42,.14)); border-radius:12px; background:var(--surface-subtle,rgba(15,23,42,.04)); }
#view-reading-theory-acc .reading-acc-scale-label{ display:flex; flex-direction:column; gap:2px; align-items:center; min-width:120px; color:var(--ink); }
#view-reading-theory-acc .reading-acc-scale-label .hint{ margin:0; font-size:13px; color:var(--muted); }
#view-reading-theory-acc .reading-acc-scale-actions .btn{ min-width:120px; }
#view-reading-theory-acc #acc-scale-staff{ display:flex; justify-content:center; }
#view-reading-theory-acc #acc-scale-staff svg{ width:clamp(520px, 72vw, 560px); max-width:100%; height:auto; display:block; margin:0 auto; }
#view-reading-theory-acc .reading-acc-scale-actions{ width:100%; }
@media (max-width:560px){
  #view-reading-theory-acc .reading-acc-scale-actions{ flex-direction:column; align-items:center; }
  #view-reading-theory-acc .reading-acc-scale-actions .btn,
  #view-reading-theory-acc .reading-acc-scale-transpose{ width:100%; max-width:280px; }
  #view-reading-theory-acc .reading-acc-scale-actions .btn{ width:100%; max-width:280px; min-width:0; }
  #view-reading-theory-acc .reading-acc-scale-transpose{ display:grid; grid-template-columns:1fr auto 1fr; grid-template-areas:"label label label" "down tone up"; row-gap:6px; column-gap:10px; align-items:center; justify-items:center; }
  #view-reading-theory-acc #acc-scale-down{ grid-area:down; justify-self:stretch; }
  #view-reading-theory-acc #acc-scale-up{ grid-area:up; justify-self:stretch; }
  #view-reading-theory-acc .reading-acc-scale-label{ min-width:0; text-align:center; display:contents; }
  #view-reading-theory-acc .reading-acc-scale-label .hint{ grid-area:label; }
  #view-reading-theory-acc #acc-scale-label{ grid-area:tone; }
}
#view-reading-theory-acc .reading-acc-keyboard-wrap{ display:grid; gap:12px; }
#view-reading-theory-acc .reading-acc-keyboard-wrap .chip-row{ display:flex; justify-content:center; gap:8px; }
#view-reading-theory-acc #acc-keyboard-staff{ width:100%; max-width:760px; margin:0 auto; display:flex; justify-content:center; }
#view-reading-theory-acc #acc-keyboard-staff svg{ width:100%; max-width:100%; height:auto; display:block; }
#view-reading-theory-acc .reading-acc-staff.small{ padding:20px 22px; min-height:340px; display:flex; align-items:center; justify-content:center; }
#view-reading-theory-acc .reading-acc-staff .is-active [data-role="note-head"],
#view-reading-theory-acc .reading-acc-staff .is-active [data-role="accidental"]{ fill:var(--accent); color:var(--accent); }
#view-reading-theory-acc .reading-acc-staff .is-active [data-role="note-label"]{ fill:var(--accent); }
.piano-keyboard,
#view-reading-theory-acc .acc-keyboard{ position:relative; border:1px solid var(--border-subtle,rgba(15,23,42,.14)); border-radius:14px; padding:12px 10px 14px; background:var(--surface); min-height:180px; overflow:hidden; --key-white-bg:#f8fafc; --key-white-border:#0f172a; --key-white-ink:#0f172a; --key-black-bg:#0b1020; --key-black-ink:#f8fafc; }
.piano-keys-white,
#view-reading-theory-acc .acc-keys-white{ display:flex; gap:0; height:150px; align-items:flex-end; }
.piano-key,
#view-reading-theory-acc .acc-key{ border:1px solid var(--key-white-border); border-radius:6px; background:var(--key-white-bg); color:var(--key-white-ink); font-weight:700; display:flex; align-items:flex-end; justify-content:center; cursor:pointer; transition:transform .15s ease, border-color .15s ease, box-shadow .15s ease; padding:8px 6px; }
.piano-key.white,
#view-reading-theory-acc .acc-key.white{ flex:1 1 auto; height:100%; min-width:0; background:var(--key-white-bg); border-color:var(--key-white-border); border-radius:8px; }
.piano-keys-black,
#view-reading-theory-acc .acc-keys-black{ position:absolute; inset:12px 10px auto 10px; height:110px; pointer-events:none; }
.piano-keys-black .piano-key,
#view-reading-theory-acc .acc-keys-black .acc-key{ pointer-events:auto; }
.piano-key.black,
#view-reading-theory-acc .acc-key.black{ position:absolute; bottom:14px; width:7%; height:90px; background:var(--key-black-bg); color:var(--key-black-ink); border-color:var(--key-black-bg); z-index:2; border-radius:6px; }
#view-reading-theory-acc .acc-key.is-active{
  border-color:var(--accent);
  transform:translateY(1px);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.22), 0 2px 6px rgba(0,0,0,.12);
}
#view-reading-theory-acc .reading-acc-signature-grid{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
#view-reading-theory-acc .reading-acc-signature-grid.is-column{ grid-template-columns:1fr; }
#view-reading-theory-acc .reading-acc-signature-block{ border:1px solid var(--border-subtle,rgba(15,23,42,.14)); border-radius:12px; padding:12px 14px; background:var(--surface-subtle,rgba(15,23,42,.04)); display:grid; gap:8px; }
#view-reading-theory-acc .reading-acc-signature-staff{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); align-items:start; }
#view-reading-theory-acc .reading-acc-staff-label{ font-weight:700; color:var(--ink); margin-bottom:6px; }
#view-reading-theory-acc .reading-acc-demo .chip-row{ gap:8px; }
#view-reading-theory-acc .reading-acc-signature-demo .btns{ justify-content:flex-start; }
#view-reading-theory-acc .reading-acc-signature-demo .reading-acc-staff{ display:grid; gap:10px; }
#view-reading-theory-acc .reading-acc-demo[data-kind="chromatic"]{ display:grid; gap:12px; max-width:660px; margin:0 auto; }
#view-reading-theory-acc .reading-acc-demo[data-kind="chromatic"] .chip-row{ justify-content:flex-start; }
#view-reading-theory-rhythm .reading-rhythm-view{ width:100%; padding:clamp(12px,4vw,24px); }
#view-reading-theory-rhythm .reading-rhythm-hero{ display:grid; gap:16px; }
#view-reading-theory-rhythm .reading-rhythm-intro-card{ padding:20px 22px; display:grid; gap:12px; }
#view-reading-theory-rhythm .reading-rhythm-intro-card .h3{ margin:0; color:var(--ink); font-weight:700; }
#view-reading-theory-rhythm .reading-rhythm-intro{ color:var(--muted); gap:10px; }
#view-reading-theory-rhythm .rhythm-audio-warning{ background:var(--surface-soft,rgba(248,250,252,.9)); border:1px solid var(--border-strong,rgba(15,23,42,.18)); border-radius:12px; padding:12px 16px; font-weight:600; color:var(--bad-ink,#dc2626); }
#view-reading-theory-rhythm .rhythm-card{ display:flex; flex-direction:column; gap:18px; }
#view-reading-theory-rhythm .rhythm-card[data-section="structure"]{ gap:12px; }
#view-reading-theory-rhythm .rhythm-structure-layout{ display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
#view-reading-theory-rhythm .rhythm-structure-figure{ border:1px solid var(--border-subtle,rgba(15,23,42,.1)); border-radius:18px; padding:12px 18px 18px; background:var(--surface-subtle,rgba(15,23,42,.02)); flex:1 1 220px; align-self:flex-start; }
#view-reading-theory-rhythm .rhythm-structure-figure svg{ width:100%; max-width:220px; height:auto; display:block; color:var(--ink); }
#view-reading-theory-rhythm .rhythm-notes-layout{ display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; }
#view-reading-theory-rhythm .rhythm-notes-block{ flex:1 1 260px; display:grid; gap:12px; align-content:flex-start; }
#view-reading-theory-rhythm .rhythm-notes-block .h4{ margin:0; color:var(--ink); }
#view-reading-theory-rhythm .rhythm-notes-block button{ width:100%; }
#view-reading-theory-rhythm .rhythm-block .sub{ font-size:15px; color:var(--muted); margin:-4px 0 10px; }
#view-reading-theory-rhythm .rhythm-block .note{ font-size:15px; color:var(--muted); font-style:italic; margin:8px 0 0; }
#view-reading-theory-rhythm .rhythm-structure-legend{ display:grid; gap:12px; flex:1 1 180px; align-self: center;}
#view-reading-theory-rhythm .rhythm-structure-legend-item{ display:flex; align-items:center; gap:10px; font-weight:600; color:var(--ink); }
#view-reading-theory-rhythm .rhythm-structure-legend-mark{ width:26px; height:26px; border-radius:50%; background:var(--accent); color:#fff; font-weight:700; display:inline-flex; align-items:center; justify-content:center; font-size:14px; }
#view-reading-theory-rhythm .rhythm-structure-note{ margin-top:0; }
#view-reading-theory-rhythm .rhythm-stems-trigger,
#view-reading-theory-rhythm .rhythm-beams-trigger{ border:1px solid var(--border-subtle,rgba(15,23,42,.1)); border-radius:18px; padding:16px; background:var(--surface-subtle,rgba(15,23,42,.02)); cursor:pointer; transition:transform .18s ease, border-color .18s ease, box-shadow .18s ease; }
#view-reading-theory-rhythm .rhythm-stems-trigger.is-playing,
#view-reading-theory-rhythm .rhythm-beams-trigger.is-playing{ border-color:var(--accent); transform:scale(1.01); box-shadow:0 8px 24px rgba(15,23,42,.08); }
#view-reading-theory-rhythm .rhythm-stems-figure svg,
#view-reading-theory-rhythm .rhythm-beams-figure svg,
#view-reading-theory-rhythm .rhythm-tuplet-figure svg{ width:100%; height:auto; display:block; color:var(--ink); }
#view-reading-theory-rhythm .rhythm-tuplet-figure{ border:1px dashed var(--border-subtle,rgba(15,23,42,.2)); border-radius:18px; padding:18px; }
#view-reading-theory-rhythm .rhythm-tuplet-figure.is-playing{ border-color:var(--accent); }
#view-reading-theory-rhythm .rhythm-extension-block.rhythm-tuplets{ grid-template-columns:1fr; gap:24px; background:var(--surface); }
#view-reading-theory-rhythm .rhythm-tuplets-hero{ border:1px solid var(--border-strong,rgba(15,23,42,.18)); border-radius:18px; padding:20px; background:var(--surface-soft,rgba(15,23,42,.02)); overflow:hidden; }
#view-reading-theory-rhythm .rhythm-tuplets-pulse{ display:grid; gap:16px; width:100%; min-width:0; }
#view-reading-theory-rhythm .rhythm-tuplets-hero-desc{ margin:14px 0 0; color:var(--muted); }
#view-reading-theory-rhythm .tuplets-hero-matrix{ display:grid; gap:18px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); align-items:start; width:100%; min-width:0; }
#view-reading-theory-rhythm .tuplets-hero-row{ display:grid; grid-template-rows:auto auto auto; gap:16px; align-items:start; width:100%; min-width:0; }
#view-reading-theory-rhythm .tuplets-hero-row-controls{ display:flex; justify-content:center; margin-top:auto; }
#view-reading-theory-rhythm .tuplets-hero-row-controls .btn-icon{ width:38px; height:38px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:700; transition:opacity .2s ease, transform .2s ease; box-shadow:0 8px 18px rgba(15,23,42,.18); }
#view-reading-theory-rhythm .tuplets-hero-row-controls .btn-icon.is-paused{ background:var(--surface); color:var(--accent); border-color:var(--accent); opacity:.85; }
#view-reading-theory-rhythm .tuplets-hero-lane{ display:flex; gap:16px; align-items:center; min-width:0; }
#view-reading-theory-rhythm .tuplets-hero-figure{ flex:0 0 129px; height:108px; border:1px solid var(--border-strong,rgba(15,23,42,.2)); border-radius:12px; background:var(--surface); display:flex; align-items:center; justify-content:center; padding:15px 9px 18px; box-shadow:0 6px 18px rgba(15,23,42,.08); }
#view-reading-theory-rhythm .tuplets-hero-figure svg{ width:100%; height:auto; color:var(--ink); }
#view-reading-theory-rhythm .tuplets-hero-content{ flex:1 1 auto; display:grid; gap:8px; min-width:0; }
#view-reading-theory-rhythm .tuplets-hero-head{ display:flex; align-items:center; gap:8px; }
#view-reading-theory-rhythm .tuplets-hero-label{ font-size:13px; font-weight:600; text-transform:uppercase; letter-spacing:.04em; color:var(--ink); }
#view-reading-theory-rhythm .tuplets-hero-count{ min-width:26px; height:26px; border-radius:50%; border:1px solid var(--border-strong,rgba(15,23,42,.2)); display:inline-flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:var(--ink); background:var(--surface); box-shadow:0 2px 6px rgba(15,23,42,.08); }
#view-reading-theory-rhythm .tuplets-hero-dots{ display:flex; gap:10px; align-items:center; }
#view-reading-theory-rhythm .tuplets-hero-dot{ width:12px; height:12px; border-radius:50%; background:var(--accent); opacity:.2; transform:scale(.55); transition:transform .14s ease, opacity .14s ease; }
#view-reading-theory-rhythm .tuplets-hero-dot.is-base{ background:var(--ink); opacity:.25; }
#view-reading-theory-rhythm .tuplets-hero-dot.is-active{ transform:scale(1.2); opacity:1; }
#view-reading-theory-rhythm .rhythm-tuplets-grid{ display:grid; gap:20px; }
#view-reading-theory-rhythm .tuplets-section{ border:0; border-radius:0; padding:0; background:none; display:grid; gap:16px; }
#view-reading-theory-rhythm .tuplets-section .h5{ margin:0; color:var(--ink); }
#view-reading-theory-rhythm .tuplets-section p{ margin:0; color:var(--muted); }
#view-reading-theory-rhythm .tuplets-meaning-figure{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
#view-reading-theory-rhythm .tuplets-meaning-card{ border:1px solid var(--border-subtle,rgba(15,23,42,.1)); border-radius:16px; padding:14px; background:var(--surface-subtle,rgba(15,23,42,.02)); display:grid; gap:10px; text-align:left; transition:border-color .2s ease, box-shadow .2s ease; }
#view-reading-theory-rhythm .tuplets-meaning-card.is-playing{ border-color:var(--accent); box-shadow:0 10px 28px rgba(15,23,42,.08); }
#view-reading-theory-rhythm .tuplets-meaning-label{ font-weight:600; color:var(--ink); }
#view-reading-theory-rhythm .tuplets-meaning-hint{ font-size:14px; color:var(--muted); }
#view-reading-theory-rhythm .tuplets-mini-staff{ width:100%; min-height:295px; display:flex; justify-content:center; align-items:center; }
#view-reading-theory-rhythm .tuplets-mini-staff svg{ width:100%; min-height:295px; max-width:390px; height:auto; color:var(--ink); }
#view-reading-theory-rhythm .tuplets-table-wrap{ overflow-x:auto; border-radius:14px; border:1px solid var(--border-strong,rgba(15,23,42,.35)); background:var(--surface); box-shadow:0 8px 26px rgba(15,23,42,.15); }
#view-reading-theory-rhythm .tuplets-table{ width:100%; border-collapse:collapse; min-width:420px; }
#view-reading-theory-rhythm .tuplets-table th,
#view-reading-theory-rhythm .tuplets-table td{ padding:18px 16px; text-align:left; border-bottom:1px solid rgba(255,255,255,.06); font-size:15px; color:var(--ink); }
#view-reading-theory-rhythm .tuplets-table thead th{ font-size:12px; text-transform:uppercase; letter-spacing:.08em; background:rgba(255,255,255,.08); color:var(--ink); }
#view-reading-theory-rhythm .tuplets-table tbody tr:nth-child(even){ background:rgba(255,255,255,.03); }
#view-reading-theory-rhythm .tuplets-table tbody tr:last-child th,
#view-reading-theory-rhythm .tuplets-table tbody tr:last-child td{ border-bottom:none; }

#view-reading-theory-rhythm .rhythm-meter-table{ border:1px solid rgba(255,255,255,.18); border-radius:14px; background:var(--surface); overflow:hidden; box-shadow:0 10px 30px rgba(15,23,42,.25); }

:root[data-theme="daylight"] #view-reading-theory-rhythm .tuplets-table-wrap,
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-meter-table{
  border-color:rgba(0,0,0,.2);
  box-shadow:none;
  background:#fff;
}
:root[data-theme="daylight"] #view-reading-theory-rhythm .tuplets-table th,
:root[data-theme="daylight"] #view-reading-theory-rhythm .tuplets-table td,
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-meter-table th,
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-meter-table td{
  border-bottom:1px solid rgba(0,0,0,.13);
  color:#1a1a1a;
}
:root[data-theme="daylight"] #view-reading-theory-rhythm .tuplets-table thead th,
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-meter-table th{
  background:rgba(0,0,0,.08);
}
:root[data-theme="daylight"] #view-reading-theory-rhythm .tuplets-table tbody tr:nth-child(even),
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-meter-table tr:nth-child(even) td{
  background:rgba(0,0,0,.02);
}
:root[data-theme="daylight"] #view-reading-theory-rhythm .tuplets-table tbody tr:nth-child(odd),
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-meter-table tr:nth-child(odd) td{
  background:#fff;
}
#view-reading-theory-rhythm .tuplets-timeline{ flex:2 1 240px; display:grid; gap:8px; }
#view-reading-theory-rhythm .tuplets-timeline-label{ font-weight:600; color:var(--muted); }
#view-reading-theory-rhythm .tuplets-timeline-track{ display:flex; align-items:center; gap:6px; padding:6px 0; }
#view-reading-theory-rhythm .tuplets-timeline-dot{ width:14px; height:14px; border-radius:999px; background:var(--ink); opacity:.28; position:relative; }
#view-reading-theory-rhythm .tuplets-timeline-dot::after{ content:''; position:absolute; inset:0; border-radius:inherit; background:var(--accent); opacity:0; transition:opacity .2s ease; }
#view-reading-theory-rhythm .tuplets-timeline-dot.is-accent::after{ opacity:1; }
#view-reading-theory-rhythm .tuplets-counting{ margin:0; padding-left:20px; color:var(--muted); display:grid; gap:4px; }
#view-reading-theory-rhythm .tuplets-audio{ display:flex; flex-wrap:wrap; gap:12px; }
#view-reading-theory-rhythm .tuplets-audio .btn{ flex:1 1 200px; }
@media (max-width:860px){
  #view-reading-theory-rhythm .tuplets-hero-row{ grid-template-columns:1fr; }
}
@media (max-width:640px){
  #view-reading-theory-rhythm .tuplets-hero-lane{ flex-wrap:wrap; }
  #view-reading-theory-rhythm .tuplets-hero-figure{ flex-basis:100%; height:111px; }
}
@media (prefers-reduced-motion:reduce){
  #view-reading-theory-rhythm .tuplets-hero-dot{ transition:none; }
}
#view-reading-theory-rhythm .rhythm-lengths-grid{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
#view-reading-theory-rhythm .rhythm-rests-grid{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
@media (max-width:979px){
  #view-reading-theory-rhythm .rhythm-lengths-grid{ grid-template-columns:repeat(3,1fr); }
  #view-reading-theory-rhythm .rhythm-rests-grid{ grid-template-columns:repeat(3,1fr); }
}
@media (max-width:720px){
  #view-reading-theory-rhythm .rhythm-lengths-grid,
  #view-reading-theory-rhythm .rhythm-rests-grid{ grid-template-columns:repeat(2,1fr); }
}
@media (max-width:560px){
  #view-reading-theory-rhythm .rhythm-lengths-grid,
  #view-reading-theory-rhythm .rhythm-rests-grid{ grid-template-columns:1fr; }
}
#view-reading-theory-rhythm .rhythm-meter-content{ display:grid; gap:18px; }
#view-reading-theory-rhythm .rhythm-meter-intro,
#view-reading-theory-rhythm .rhythm-meter-notation,
#view-reading-theory-rhythm .rhythm-meter-table-card,
#view-reading-theory-rhythm .rhythm-meter-compare{ border:1px solid var(--list-border,rgba(255,255,255,.08)); border-radius:16px; background:var(--surface); padding:16px 18px; display:grid; gap:12px; }
#view-reading-theory-rhythm .rhythm-meter-notation ul{ margin:0 0 4px 18px; padding:0; color:var(--muted); display:grid; gap:4px; }
#view-reading-theory-rhythm .rhythm-meter-notation-figure svg{ width:100%; max-width:320px; height:auto; color:var(--ink); display:block; margin:auto; }
#view-reading-theory-rhythm .rhythm-meter-examples{ display:flex; flex-direction:column; gap:20px; }
#view-reading-theory-rhythm .rhythm-meter-switch{ display:flex; flex-wrap:wrap; gap:8px; }
#view-reading-theory-rhythm .rhythm-meter-switch button{ border:1px solid var(--border-subtle,rgba(15,23,42,.15)); border-radius:999px; padding:8px 18px; background:var(--surface-subtle,rgba(15,23,42,.04)); color:var(--ink); font-weight:600; cursor:pointer; transition:border-color .2s ease, background-color .2s ease, color .2s ease; }
#view-reading-theory-rhythm .rhythm-meter-switch button.is-active{ border-color:var(--accent); background:var(--accent-soft,rgba(15,23,42,.08)); color:var(--accent,#fefefe); }
#view-reading-theory-rhythm .rhythm-meter-switch button:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
#view-reading-theory-rhythm .rhythm-meter-active{ border:1px solid var(--border-subtle,rgba(15,23,42,.12)); border-radius:16px; padding:20px; background:var(--surface-subtle,rgba(15,23,42,.03)); display:flex; flex-direction:column; gap:20px; }
#view-reading-theory-rhythm .rhythm-meter-active-head{ display:flex; flex-wrap:wrap; gap:16px; justify-content:space-between; align-items:flex-start; }
#view-reading-theory-rhythm .rhythm-meter-active-head .hint{ margin:0; color:var(--muted); max-width:320px; }
#view-reading-theory-rhythm .rhythm-meter-example-figure{ border:1px dashed var(--border-subtle,rgba(15,23,42,.2)); border-radius:14px; padding:12px; background:var(--card); }
#view-reading-theory-rhythm .rhythm-meter-example-figure svg{ width:100%; height:auto; display:block; color:var(--ink); }
#view-reading-theory-rhythm .meter-measure-highlight{ fill:var(--accent-soft,rgba(15,23,42,.08)); stroke:var(--accent); stroke-width:2; opacity:0; transition:opacity .2s ease; }
#view-reading-theory-rhythm .meter-measure-highlight.is-selected{ opacity:.35; }
#view-reading-theory-rhythm .meter-measure-highlight.is-playing{ opacity:.65; }
#view-reading-theory-rhythm .meter-measure-hit{ fill:transparent; cursor:pointer; }
#view-reading-theory-rhythm .meter-measure-hit:hover{ fill:rgba(15,23,42,.04); }
#view-reading-theory-rhythm .rhythm-meter-example-list{ display:grid; gap:8px; }
#view-reading-theory-rhythm .rhythm-meter-example-list button{ width:100%; text-align:left; padding:10px 14px; border-radius:12px; border:1px solid var(--border-subtle,rgba(15,23,42,.14)); background:var(--card); color:var(--ink); cursor:pointer; transition:border-color .2s ease, background-color .2s ease, color .2s ease; display:flex; gap:10px; align-items:center; }
#view-reading-theory-rhythm .rhythm-meter-example-list button strong{ font-size:16px; color:var(--ink); min-width:32px; }
#view-reading-theory-rhythm .rhythm-meter-example-list button .meta{ display:block; font-size:14px; color:var(--muted); flex:1; }
#view-reading-theory-rhythm .rhythm-meter-example-list button.is-active{ border-color:var(--accent); background:var(--accent-soft,rgba(15,23,42,.08)); color:var(--accent,#fefefe); }
#view-reading-theory-rhythm .rhythm-meter-example-list button.is-active .meta{ color:var(--accent,#fefefe); }
#view-reading-theory-rhythm .rhythm-meter-example-list button.is-active strong{ color:var(--accent,#fefefe); }
#view-reading-theory-rhythm .rhythm-meter-example-list button:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
#view-reading-theory-rhythm .rhythm-meter-table{ border:1px solid rgba(255,255,255,.18); border-radius:14px; background:var(--surface); overflow:hidden; box-shadow:0 10px 30px rgba(15,23,42,.25); }
#view-reading-theory-rhythm .rhythm-meter-table table{ width:100%; border-collapse:collapse; table-layout:fixed; }
#view-reading-theory-rhythm .rhythm-meter-table th,
#view-reading-theory-rhythm .rhythm-meter-table td{ padding:18px 16px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; color:var(--ink); font-size:15px; }
#view-reading-theory-rhythm .rhythm-meter-table th{ text-transform:uppercase; letter-spacing:.08em; font-size:12px; background:rgba(255,255,255,.08); }
#view-reading-theory-rhythm .rhythm-meter-table tr:nth-child(even) td{ background:rgba(255,255,255,.03); }
#view-reading-theory-rhythm .rhythm-meter-table tr:last-child td{ border-bottom:none; }
#view-reading-theory-rhythm .rhythm-meter-compare-figures{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
#view-reading-theory-rhythm .rhythm-meter-compare-card{ border:1px dashed var(--border-subtle,rgba(15,23,42,.2)); border-radius:14px; padding:14px; display:grid; gap:14px; justify-items:center; background:var(--surface-subtle,rgba(15,23,42,.03)); }
#view-reading-theory-rhythm .meter-mini-figure{ width:100%; border:1px solid var(--border-subtle,rgba(15,23,42,.2)); border-radius:12px; padding:10px; background:var(--card); }
#view-reading-theory-rhythm .meter-mini-figure svg{ width:100%; height:auto; display:block; color:var(--ink); }
#view-reading-theory-rhythm .meter-mini-actions{ display:flex; gap:8px; }
#view-reading-theory-rhythm .meter-mini-actions .btn{ flex:1 1 auto; }
#view-reading-theory-rhythm .rhythm-meter-beats{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
#view-reading-theory-rhythm .rhythm-meter-beats.is-compact{ gap:8px; }
#view-reading-theory-rhythm .rhythm-meter-beat{ width:42px; height:42px; border-radius:50%; border:2px solid var(--border-subtle,rgba(15,23,42,.2)); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--muted); transition:transform .18s ease, border-color .18s ease, color .18s ease; }
#view-reading-theory-rhythm .rhythm-meter-beat[data-accent="true"]{ border-color:var(--accent); color:var(--accent); }
#view-reading-theory-rhythm .rhythm-meter-beat.is-active{ transform:scale(1.08); border-color:var(--accent); color:var(--ink); }
#view-reading-theory-rhythm .rhythm-meter-beat.is-compact{ width:34px; height:34px; font-size:14px; }
#view-reading-theory-rhythm .tempo-grid{ display:grid; gap:20px; }
#view-reading-theory-rhythm .tempo-block{ border:1px solid var(--border-subtle,rgba(15,23,42,.15)); border-radius:14px; padding:16px 18px; background:var(--surface-subtle,rgba(15,23,42,.02)); display:grid; gap:12px; }
#view-reading-theory-rhythm .tempo-examples{ margin:0; padding-left:18px; color:var(--muted); display:grid; gap:6px; }
#view-reading-theory-rhythm .tempo-demo-card{ border:1px solid var(--accent); border-radius:18px; padding:18px 20px; background:var(--surface); display:grid; gap:14px; box-shadow:0 10px 28px rgba(15,23,42,.08); }
#view-reading-theory-rhythm .tempo-slider-label{ font-weight:700; color:var(--ink); display:block; }
#view-reading-theory-rhythm .tempo-demo-card input[type=range]{ width:100%; accent-color:var(--accent); }
#view-reading-theory-rhythm .tempo-demo-hint,
#view-reading-theory-rhythm .tempo-demo-context{ margin:0; font-size:14px; color:var(--muted); }
#view-reading-theory-rhythm .tempo-duration-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; }
#view-reading-theory-rhythm .tempo-duration-grid div{ border:1px solid var(--border-subtle,rgba(15,23,42,.2)); border-radius:12px; padding:10px 14px; background:var(--card); display:grid; gap:4px; }
#view-reading-theory-rhythm .tempo-duration-grid span{ font-size:14px; color:var(--muted); }
#view-reading-theory-rhythm .tempo-duration-grid strong{ font-size:20px; color:var(--ink); }
#view-reading-theory-rhythm .tempo-compare-table table,
#view-reading-theory-rhythm .tempo-terms-table table{ width:100%; border-collapse:collapse; }
#view-reading-theory-rhythm .tempo-compare-table th,
#view-reading-theory-rhythm .tempo-compare-table td,
#view-reading-theory-rhythm .tempo-terms-table th,
#view-reading-theory-rhythm .tempo-terms-table td{ padding:12px; text-align:left; border-bottom:1px solid var(--border-subtle,rgba(15,23,42,.15)); color:var(--ink); }
#view-reading-theory-rhythm .tempo-terms-table td:nth-child(3){ color:var(--muted); }
#view-reading-theory-rhythm .rhythm-length-card,
#view-reading-theory-rhythm .rhythm-rest-card{ border:1px solid var(--list-border,rgba(255,255,255,.08)); border-radius:14px; background:var(--surface); box-shadow:0 0 0 1px var(--list-border,rgba(255,255,255,.08)); padding:18px; display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center; cursor:pointer; width:100%; transition:background-color .2s ease, border-color .2s ease, box-shadow .2s ease, transform .18s ease; }
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-length-card,
:root[data-theme="daylight"] #view-reading-theory-rhythm .rhythm-rest-card,
:root[data-theme="aurora"] #view-reading-theory-rhythm .rhythm-length-card,
:root[data-theme="aurora"] #view-reading-theory-rhythm .rhythm-rest-card{ border-color:rgba(0,0,0,.1); box-shadow:0 0 0 1px rgba(0,0,0,.08); }
#view-reading-theory-rhythm .rhythm-length-meta strong,
#view-reading-theory-rhythm .rhythm-length-meta span{ display:block; }
#view-reading-theory-rhythm .rhythm-length-meta strong{ font-size:16px; color:var(--ink); }
#view-reading-theory-rhythm .rhythm-length-meta span{ font-size:14px; color:var(--muted); }
#view-reading-theory-rhythm .rhythm-length-card.is-playing,
#view-reading-theory-rhythm .rhythm-rest-card.is-active{ transform:scale(1.015); border-color:var(--accent); box-shadow:0 8px 20px rgba(15,23,42,.08); }
#view-reading-theory-rhythm .rhythm-staff{ width:100%; }
#view-reading-theory-rhythm .rhythm-staff svg{ width:100%; height:auto; display:block; color:var(--ink); }
#view-reading-theory-rhythm .note-demo{ display:flex; align-items:center; justify-content:center; height:120px; width:100%; }
#view-reading-theory-rhythm .note-demo svg{ display:block; margin:auto; max-width:170px; }
#view-reading-theory-rhythm .rhythm-extension-blocks{ display:grid; gap:18px; }
#view-reading-theory-rhythm .rhythm-extension-block{ border:1px solid var(--list-border,rgba(255,255,255,.08)); border-radius:14px; background:var(--surface); padding:16px 18px; display:grid; gap:20px; grid-template-columns:minmax(0,1fr) minmax(0,220px); align-items:center; }
#view-reading-theory-rhythm .rhythm-extension-text .h4{ margin:0; color:var(--ink); }
#view-reading-theory-rhythm .rhythm-extension-text p{ margin:0; color:var(--muted); }
#view-reading-theory-rhythm .rhythm-extension-figure{ text-align:center; }
#view-reading-theory-rhythm .rhythm-extension-svg{ display:flex; justify-content:center; align-items:center; padding:8px; }
#view-reading-theory-rhythm .rhythm-extension-svg svg{ width:100%; max-width:260px; height:auto; color:var(--ink); transition:color .2s ease, transform .2s ease; }
#view-reading-theory-rhythm .rhythm-extension-svg.is-playing svg{ color:var(--accent); transform:scale(1.02); }
#view-reading-theory-rhythm .rhythm-extension-caption{ margin:8px 0 0; font-size:14px; color:var(--muted); font-weight:600; }
@media (max-width:768px){
  #view-reading-theory-rhythm .rhythm-extension-block{ grid-template-columns:1fr; }
  #view-reading-theory-rhythm .rhythm-extension-figure{ order:2; }
}
@media (max-width:720px){
  #view-reading-theory-rhythm .rhythm-staff svg{ min-height:120px; }
  #view-reading-theory-rhythm .rhythm-structure-figure svg{ min-height:200px; }
  #view-reading-theory-rhythm .rhythm-structure-layout{ flex-direction:column; }
  #view-reading-theory-rhythm .rhythm-meter-beat{ width:34px; height:34px; font-size:13px; }
}
</style>
<script>
(function(){
  const App = window.App = window.App || {};
  if(App.audio) return;
  const AudioCtor = window.AudioContext || window.webkitAudioContext || null;
  const state = {
    ctx: null,
    timers: new Set(),
    sources: new Set(),
    supported: Boolean(AudioCtor)
  };

  function ensureContext(){
    if(!state.supported) return null;
    if(!state.ctx){
      try{
        state.ctx = new AudioCtor();
      }catch(e){
        state.ctx = null;
        state.supported = false;
        return null;
      }
    }
    if(state.ctx && state.ctx.state === 'suspended'){
      try{ state.ctx.resume(); }catch(e){}
    }
    return state.ctx;
  }

  function clearTimers(){
    state.timers.forEach(id=>clearTimeout(id));
    state.timers.clear();
  }

  function stopAll(){
    clearTimers();
    state.sources.forEach(node=>{
      try{ node.stop(); }catch(e){}
    });
    state.sources.clear();
  }

  function scheduleTone(ctx, opts={}){
    if(!ctx) return;
    const {
      freq=440,
      duration=0.5,
      offset=0,
      gain=0.2,
      type='sine',
      attack=0.01,
      release=0.06
    } = opts;
    if(gain <= 0 || freq <= 0){
      return;
    }
    const start = ctx.currentTime + Math.max(0, offset);
    const osc = ctx.createOscillator();
    const amp = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, start);
    const safeAttack = Math.max(0, attack || 0.001);
    const safeRelease = Math.max(0, release || 0.05);
    const attackEnd = Math.min(start + safeAttack, start + duration);
    const releaseStart = Math.max(attackEnd, start + duration - safeRelease);
    amp.gain.setValueAtTime(0.0001, start);
    amp.gain.linearRampToValueAtTime(gain, attackEnd);
    amp.gain.setValueAtTime(gain, releaseStart);
    amp.gain.linearRampToValueAtTime(0.0001, start + duration);
    osc.connect(amp);
    amp.connect(ctx.destination);
    osc.start(start);
    osc.stop(start + duration + 0.05);
    state.sources.add(osc);
    osc.addEventListener('ended', ()=>state.sources.delete(osc));
  }

  function playPattern(pattern=[], options={}){
    stopAll();
    const ctx = ensureContext();
    const secPerBeat = 60 / Math.max(1, options.bpm || 80);
    const gap = Math.max(0, options.gap || 0);
    let elapsed = 0;
    pattern.forEach((beats, index)=>{
      const duration = Math.max(0.05, Number(beats) * secPerBeat);
      if(ctx){
        const accent = typeof options.isAccent === 'function'
          ? !!options.isAccent(index, beats)
          : (options.accentFirst && index === 0);
        const freq = typeof options.freq === 'function'
          ? options.freq(index, accent)
          : (accent ? (options.accentFreq || 660) : (options.freq || 440));
        const gain = typeof options.gain === 'function'
          ? options.gain(index, accent)
          : (accent ? 0.28 : 0.22);
        const envelope = typeof options.envelope === 'function'
          ? options.envelope(index, accent)
          : (options.envelope || {});
        scheduleTone(ctx, {
          freq,
          duration,
          offset: elapsed,
          gain,
          type: options.type || 'sine',
          attack: envelope.attack,
          release: envelope.release
        });
      }
      const startMs = elapsed * 1000;
      const timer = window.setTimeout(()=>{
        if(typeof options.onStep === 'function'){
          options.onStep(index, beats);
        }
      }, startMs);
      state.timers.add(timer);
      elapsed += duration + gap;
    });
    const finishTimer = window.setTimeout(()=>{
      if(typeof options.onFinish === 'function'){
        options.onFinish();
      }
    }, elapsed * 1000);
    state.timers.add(finishTimer);
  }

  App.audio = {
    supported: state.supported,
    playPattern(pattern, options){
      const list = Array.isArray(pattern) ? pattern : [];
      playPattern(list, options || {});
    },
    stop: stopAll
  };
})();
</script>
<script>
(function(){
  const App = window.App = window.App || {};
  if(App.rhythmShapes) return;
  const SVG_NS = 'http://www.w3.org/2000/svg';

  function createStaffBase(width=360, height=150, opts={}){
    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.setAttribute('preserveAspectRatio', 'xMinYMid meet');
    const inset = opts.inset ?? 24;
    const startY = opts.startY ?? 35;
    const gap = opts.gap ?? 14;
    for(let i=0;i<5;i++){
      const line = document.createElementNS(SVG_NS, 'line');
      line.setAttribute('x1', String(inset));
      line.setAttribute('x2', String(width - inset));
      line.setAttribute('y1', String(startY + i * gap));
      line.setAttribute('y2', String(startY + i * gap));
      line.setAttribute('stroke', 'currentColor');
      line.setAttribute('stroke-width', '2');
      line.setAttribute('stroke-linecap', 'round');
      line.setAttribute('stroke-opacity', '0.75');
      svg.appendChild(line);
    }
    return { svg, startY, gap, width, height, inset };
  }

  function addFlags(svg, x, y, direction, count, scale=1){
    for(let i=0;i<count;i++){
      const flag = document.createElementNS(SVG_NS, 'path');
      const offset = i * 12 * scale;
      if(direction === 'up'){
        const startY = y + offset;
        flag.setAttribute('d', `M${x} ${startY} C ${x} ${startY + 7 * scale} ${x + 15 * scale} ${startY + 14 * scale} ${x + 15 * scale} ${startY + 28 * scale}`);
      } else {
        const startY = y - offset;
        flag.setAttribute('d', `M${x} ${startY} C ${x} ${startY - 7 * scale} ${x - 15 * scale} ${startY - 14 * scale} ${x - 15 * scale} ${startY - 28 * scale}`);
      }
      flag.setAttribute('fill', 'none');
      flag.setAttribute('stroke', 'currentColor');
      flag.setAttribute('stroke-width', '4');
      flag.setAttribute('stroke-linecap', 'round');
      svg.appendChild(flag);
    }
  }

  function addSimpleNote(svg, x, y, opts={}){
    const scale = typeof opts.scale === 'number' ? opts.scale : 0.8; // základně menší ~20 %
    const ink = opts.color ? opts.color : (typeof getInk === 'function' ? getInk() : 'currentColor');
    const head = document.createElementNS(SVG_NS, 'ellipse');
    const noteType = opts.noteType || null;
    const isWhole = noteType === 'whole';
    head.setAttribute('data-role', 'note-head');
    head.setAttribute('cx', String(x));
    head.setAttribute('cy', String(y));
    head.setAttribute('rx', String(12 * scale));
    head.setAttribute('ry', String(8.25 * scale));
    if(isWhole){
      head.removeAttribute('transform');
    } else {
      head.setAttribute('transform', `rotate(-15 ${x} ${y})`);
    }
    head.setAttribute('fill', opts.hollow ? 'none' : ink);
    head.setAttribute('stroke', opts.hollow ? ink : 'none');
    head.setAttribute('stroke-width', opts.hollow ? '3' : '0');
    svg.appendChild(head);
    let stemTopY = null;
    let stemBottomY = null;
    let stemX = null;
    const stemDir = opts.stem || 'up';
    const hasStem = stemDir !== 'none' && stemDir !== null && stemDir !== false;
    if(!hasStem){
      return { stemX:null, stemTopY:null, stemBottomY:null, headX:x, headY:y };
    }
    const baseStemLength = typeof opts.stemLength === 'number' ? opts.stemLength : 55;
    const stemLength = baseStemLength * scale;
    if(stemDir === 'up'){
      const stem = document.createElementNS(SVG_NS, 'line');
      stem.setAttribute('x1', String(x + 10 * scale));
      stem.setAttribute('x2', String(x + 13 * scale));
      stem.setAttribute('y1', String(y));
      stem.setAttribute('y2', String(y - stemLength));
      stem.setAttribute('stroke', ink);
      stem.setAttribute('stroke-width', '4');
      stem.setAttribute('stroke-linecap', 'round');
      svg.appendChild(stem);
      stemTopY = y - stemLength;
      stemBottomY = y;
      stemX = x + 14 * scale;
      if(opts.flags){
        addFlags(svg, stemX, stemTopY, stemDir, opts.flags || 0, scale);
      }
    } else {
      const stem = document.createElementNS(SVG_NS, 'line');
      stem.setAttribute('x1', String(x - 10 * scale));
      stem.setAttribute('x2', String(x - 13 * scale));
      stem.setAttribute('y1', String(y));
      stem.setAttribute('y2', String(y + stemLength));
      stem.setAttribute('stroke', ink);
      stem.setAttribute('stroke-width', '4');
      stem.setAttribute('stroke-linecap', 'round');
      svg.appendChild(stem);
      stemTopY = y;
      stemBottomY = y + stemLength;
      stemX = x - 14 * scale;
      if(opts.flags){
        addFlags(svg, stemX, stemBottomY, stemDir, opts.flags || 0, scale);
      }
    }
    return { stemX, stemTopY, stemBottomY, headX:x, headY:y };
  }

  function addBeamBetween(svg, from, to, direction='up', thickness=8, beams=1){
    if(!from || !to) return;
    const path = document.createElementNS(SVG_NS, 'path');
    const startY = direction === 'up' ? from.stemTopY : from.stemBottomY;
    const endY = direction === 'up' ? to.stemTopY : to.stemBottomY;
    // pro down zvedneme trámec blíž k hlavičkám (negativní offset)
    const offset = direction === 'up' ? thickness : -thickness;
    const gap = Math.abs(offset) + 2;
    const count = Math.max(1, beams);
    for(let i=0;i<count;i++){
      const yShift = i === 0 ? 0 : (direction === 'up' ? i * gap : -i * gap);
      const thisThickness = i === 0 ? thickness : thickness * 0.5;
      const y1 = startY + yShift;
      const y2 = endY + yShift;
      const y1b = direction === 'up' ? y1 + thisThickness : y1 - thisThickness;
      const y2b = direction === 'up' ? y2 + thisThickness : y2 - thisThickness;
      const beam = document.createElementNS(SVG_NS, 'path');
      beam.setAttribute('d', `M ${from.stemX} ${y1} L ${to.stemX} ${y2} L ${to.stemX} ${y2b} L ${from.stemX} ${y1b} Z`);
      beam.setAttribute('fill', 'currentColor');
      svg.appendChild(beam);
    }
  }

  function addNumberMarker(svg, x, y, label){
    const circle = document.createElementNS(SVG_NS, 'circle');
    circle.setAttribute('cx', String(x));
    circle.setAttribute('cy', String(y));
    circle.setAttribute('r', '10');
    circle.setAttribute('fill', 'var(--accent)');
    circle.setAttribute('stroke', 'var(--card)');
    circle.setAttribute('stroke-width', '2');
    svg.appendChild(circle);
    const text = document.createElementNS(SVG_NS, 'text');
    text.setAttribute('x', String(x));
    text.setAttribute('y', String(y + 4));
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('font-size', '13');
    text.setAttribute('font-weight', '700');
    text.setAttribute('fill', '#fff');
    text.textContent = label;
    svg.appendChild(text);
  }

  function addTupletBracket(svg, startX, endX, y, label, opts={}){
    const line = document.createElementNS(SVG_NS, 'path');
    line.setAttribute('d', `M ${startX} ${y} L ${endX} ${y}`);
    line.setAttribute('stroke', 'currentColor');
    line.setAttribute('stroke-width', String(opts.strokeWidth || 2));
    line.setAttribute('stroke-linecap', 'round');
    svg.appendChild(line);
    const text = document.createElementNS(SVG_NS, 'text');
    text.setAttribute('x', String((startX + endX) / 2));
    const textOffset = typeof opts.textOffset === 'number' ? opts.textOffset : 6;
    text.setAttribute('y', String(y - textOffset));
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('font-weight', opts.fontWeight || '700');
    text.setAttribute('font-size', String(opts.fontSize || 18));
    text.setAttribute('fill', opts.fill || 'currentColor');
    text.textContent = label;
    svg.appendChild(text);
  }

  function appendTimeSignature(svg, meterId, opts={}){
    if(!svg || !meterId) return null;
    const [top,bottom] = String(meterId).split('/');
    const x = typeof opts.x === 'number' ? opts.x : 0;
    const startY = typeof opts.startY === 'number' ? opts.startY : 0;
    const gap = typeof opts.gap === 'number' ? opts.gap : 14;
    const fontSize = typeof opts.fontSize === 'number' ? opts.fontSize : 24;
    const color = opts.color || 'currentColor';
    const topText = document.createElementNS(SVG_NS, 'text');
    topText.setAttribute('x', String(x));
    topText.setAttribute('y', String(startY - gap * 0.5));
    topText.setAttribute('text-anchor','middle');
    topText.setAttribute('font-size', String(fontSize));
    topText.setAttribute('font-weight','700');
    topText.setAttribute('fill', color);
    topText.textContent = top || '';
    svg.appendChild(topText);
    const bottomText = document.createElementNS(SVG_NS, 'text');
    bottomText.setAttribute('x', String(x));
    bottomText.setAttribute('y', String(startY + gap * 1));
    bottomText.setAttribute('text-anchor','middle');
    bottomText.setAttribute('font-size', String(fontSize));
    bottomText.setAttribute('font-weight','700');
    bottomText.setAttribute('fill', color);
    bottomText.textContent = bottom || '';
    svg.appendChild(bottomText);
    return { topText, bottomText };
  }

  function buildRestGlyph(type){
    const group = document.createElementNS(SVG_NS, 'g');
    if(type === 'whole'){
      const rect = document.createElementNS(SVG_NS, 'rect');
      rect.setAttribute('x', '-18');
      rect.setAttribute('y', '-15');
      rect.setAttribute('width', '36');
      rect.setAttribute('height', '10');
      rect.setAttribute('fill', 'currentColor');
      group.appendChild(rect);
    } else if(type === 'half'){
      const rect = document.createElementNS(SVG_NS, 'rect');
      rect.setAttribute('x', '-18');
      rect.setAttribute('y', '-10');
      rect.setAttribute('width', '36');
      rect.setAttribute('height', '10');
      rect.setAttribute('fill', 'currentColor');
      group.appendChild(rect);
    } else if(type === 'quarter'){
      const path = document.createElementNS(SVG_NS, 'path'); 
      path.setAttribute('transform','translate(-380,-1225) scale(2.1)');
      path.setAttribute('d', 'M 181.69909,588.76398 C 182.47362,589.08988 182.3797,590.46481 181.42371,589.80261 C 180.70644,588.91354 179.33831,588.14481 178.34093,589.11155 C 177.5139,589.8776 177.78694,591.27023 178.71609,591.81509 C 179.37044,591.94893 179.86732,593.05704 178.79518,592.642 C 177.25015,592.11543 175.60062,590.79176 175.7257,588.99985 C 175.70261,587.7787 176.9577,587.02175 178.07209,587.106 C 178.52013,586.94555 179.75824,587.58632 179.70251,587.30253 C 178.94921,586.14553 178.08957,585.05126 177.41509,583.84762 C 177.17661,583.12078 177.69942,582.42905 177.9199,581.7502 C 178.39967,580.55313 178.93636,579.37651 179.37409,578.16438 C 179.41525,577.41801 178.75249,576.88912 178.40914,576.2772 C 178.01153,575.64334 177.49169,575.07309 177.20209,574.38225 C 177.22225,573.50455 178.13012,574.48596 178.37637,574.84393 C 179.45036,576.11832 180.57945,577.34906 181.61509,578.65383 C 182.30749,579.4973 181.66158,580.48525 181.32581,581.32734 C 180.82735,582.58309 180.19033,583.79167 179.82409,585.09323 C 179.77639,586.1646 180.5603,587.05185 181.06346,587.94062 C 181.25685,588.22883 181.47282,588.50112 181.69909,588.76398 z');
      path.setAttribute('fill', 'currentColor');
      path.setAttribute('stroke', 'currentColor');
      path.setAttribute('stroke-width', '1');
      path.setAttribute('stroke-linecap', 'round');
      path.setAttribute('stroke-linejoin', 'round');
      group.appendChild(path);
    } else if(type === 'eighth'){
      const path = document.createElementNS(SVG_NS, 'path');
      path.setAttribute('transform','matrix(1.8,0,0,1.8,-1530,-230) scale(1.6)');
      path.setAttribute('d', 'm 531.098,74.847 c -0.52,0.098 -0.918,0.457 -1.098,0.953 -0.039,0.16 -0.039,0.199 -0.039,0.418 0,0.301 0.019,0.461 0.16,0.699 0.199,0.399 0.617,0.719 1.094,0.836 0.5,0.141 1.336,0.02 2.293,-0.297 l 0.238,-0.082 -1.176,3.25 -1.156,3.246 c 0,0 0.039,0.02 0.102,0.063 0.117,0.078 0.316,0.137 0.457,0.137 0.238,0 0.539,-0.137 0.578,-0.258 0,-0.039 0.558,-1.934 1.234,-4.184 l 1.195,-4.125 -0.039,-0.058 c -0.097,-0.121 -0.296,-0.16 -0.418,-0.063 -0.039,0.039 -0.101,0.121 -0.14,0.18 -0.18,0.301 -0.637,0.836 -0.875,1.035 -0.219,0.18 -0.34,0.199 -0.539,0.121 -0.18,-0.098 -0.239,-0.199 -0.36,-0.738 -0.117,-0.535 -0.257,-0.778 -0.558,-0.977 -0.278,-0.179 -0.637,-0.238 -0.953,-0.156 z');
      path.setAttribute('fill', 'currentColor');
      path.setAttribute('stroke', 'currentColor');
      path.setAttribute('stroke-width', '0');
      path.setAttribute('stroke-linecap', 'round');
      path.setAttribute('stroke-linejoin', 'round');
      group.appendChild(path);
    } else if(type === 'sixteenth'){
      const path = document.createElementNS(SVG_NS, 'path');
      path.setAttribute('transform','matrix(1.8,0,0,1.8,-1560,-230) scale(1.6)');
      path.setAttribute('d', 'M 544.191,74.847 C 543.672,74.945 543.273,75.304 543.098,75.8 C 543.055,75.96 543.055,75.999 543.055,76.218 C 543.055,76.519 543.074,76.679 543.215,76.917 C 543.414,77.316 543.832,77.636 544.313,77.753 C 544.809,77.894 545.605,77.792 546.563,77.476 C 546.703,77.417 546.82,77.374 546.82,77.394 C 546.82,77.417 545.926,80.324 545.887,80.425 C 545.785,80.683 545.445,81.16 545.148,81.46 C 544.871,81.738 544.73,81.8 544.512,81.699 C 544.332,81.601 544.273,81.499 544.152,80.96 C 544.051,80.562 543.973,80.343 543.813,80.187 C 543.395,79.726 542.676,79.667 542.121,80.027 C 541.859,80.206 541.66,80.484 541.543,80.785 C 541.5,80.941 541.5,80.984 541.5,81.202 C 541.5,81.499 541.523,81.66 541.66,81.898 C 541.859,82.296 542.277,82.617 542.758,82.734 C 542.977,82.796 543.535,82.796 543.914,82.734 C 544.23,82.675 544.609,82.577 544.988,82.456 C 545.148,82.398 545.289,82.359 545.289,82.378 C 545.289,82.378 543.336,88.734 543.297,88.831 C 543.297,88.851 543.453,88.972 543.613,89.011 C 543.773,89.074 543.934,89.074 544.094,89.011 C 544.25,88.972 544.41,88.874 544.41,88.812 C 544.43,88.792 545.227,85.785 546.203,82.136 L 547.977,75.503 L 547.938,75.445 C 547.859,75.324 547.699,75.304 547.559,75.363 C 547.48,75.402 547.48,75.402 547.242,75.761 C 547.043,76.081 546.762,76.417 546.602,76.577 C 546.383,76.757 546.266,76.796 546.066,76.718 C 545.887,76.62 545.824,76.519 545.707,75.98 C 545.586,75.445 545.445,75.202 545.148,75.003 C 544.871,74.824 544.512,74.765 544.191,74.847 z');
      path.setAttribute('fill', 'currentColor');
      path.setAttribute('stroke', 'currentColor');
      path.setAttribute('stroke-width', '0');
      path.setAttribute('stroke-linecap', 'round');
      path.setAttribute('stroke-linejoin', 'round');
      group.appendChild(path);
    }
   
    return group;
  }

  function buildNoteGlyph(type){
    const group = document.createElementNS(SVG_NS, 'g');
    const opts = {
      stem: type === 'whole' ? 'none' : (type === 'sixteenth' ? 'down' : 'up'),
      flags: ({ eighth:1, sixteenth:2 }[type] || 0),
      hollow: type === 'whole' || type === 'half',
      noteType: type
    };
    addSimpleNote(group, 0, 0, opts);
    return group;
  }

  function appendTrebleClef(svg, opts={}){
    if(!svg) return null;
    const viewBox = svg.viewBox && svg.viewBox.baseVal;
    const width = typeof opts.width === 'number'
      ? opts.width
      : (viewBox ? viewBox.width : 360);
    const inset = typeof opts.inset === 'number' ? opts.inset : 24;
    const startY = typeof opts.startY === 'number' ? opts.startY : 35;
    const gap = typeof opts.gap === 'number' ? opts.gap : 14;
    const hasRatio = typeof opts.offsetRatio === 'number' && Number.isFinite(opts.offsetRatio);
    const ratioX = hasRatio ? opts.offsetRatio : null;
    const x = typeof opts.x === 'number'
      ? opts.x
      : (ratioX !== null ? ratioX * width : inset - 80);
    const y = typeof opts.y === 'number' ? opts.y : startY - gap * 1.5;
    const scale = typeof opts.scale === 'number' ? opts.scale : 0.62;
    const use = document.createElementNS(SVG_NS, 'use');
    use.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '#basic-clef-treble');
    use.setAttribute('transform', `translate(${x},${y}) scale(${scale})`);
    use.setAttribute('fill', 'none');
    use.setAttribute('stroke', 'currentColor');
    svg.appendChild(use);
    return use;
  }

  function appendTimeSignature(svg, meter='4/4', opts={}){
    if(!svg) return null;
    const viewBox = svg.viewBox && svg.viewBox.baseVal;
    const width = typeof opts.width === 'number'
      ? opts.width
      : (viewBox ? viewBox.width : 360);
    const [top='4', bottom='4'] = String(meter).split('/');
    const inset = typeof opts.inset === 'number' ? opts.inset : 24;
    const startY = typeof opts.startY === 'number' ? opts.startY : 35;
    const gap = typeof opts.gap === 'number' ? opts.gap : 14;
    const hasRatio = typeof opts.offsetRatio === 'number' && Number.isFinite(opts.offsetRatio);
    const ratioX = hasRatio ? opts.offsetRatio : null;
    const x = typeof opts.x === 'number'
      ? opts.x
      : (ratioX !== null ? ratioX * width : inset + 70);
    const topY = typeof opts.topY === 'number' ? opts.topY : startY + gap * 2;
    const bottomY = typeof opts.bottomY === 'number' ? opts.bottomY : startY + gap * 4;
    const fontSize = typeof opts.fontSize === 'number' ? opts.fontSize : 32;
    const fontWeight = opts.fontWeight || '700';
    const textTop = document.createElementNS(SVG_NS, 'text');
    textTop.setAttribute('x', String(x));
    textTop.setAttribute('y', String(topY));
    textTop.setAttribute('text-anchor', 'middle');
    textTop.setAttribute('font-size', String(fontSize));
    textTop.setAttribute('font-weight', fontWeight);
    textTop.setAttribute('fill', 'currentColor');
    textTop.textContent = top;
    svg.appendChild(textTop);
    const textBottom = document.createElementNS(SVG_NS, 'text');
    textBottom.setAttribute('x', String(x));
    textBottom.setAttribute('y', String(bottomY));
    textBottom.setAttribute('text-anchor', 'middle');
    textBottom.setAttribute('font-size', String(fontSize));
    textBottom.setAttribute('font-weight', fontWeight);
    textBottom.setAttribute('fill', 'currentColor');
    textBottom.textContent = bottom;
    svg.appendChild(textBottom);
    return { top:textTop, bottom:textBottom };
  }

  App.rhythmShapes = {
    createStaffBase,
    addSimpleNote,
    addFlags,
    addBeamBetween,
    addNumberMarker,
    addTupletBracket,
    buildRestGlyph,
    buildNoteGlyph,
    appendTrebleClef,
    appendTimeSignature,
    SVG_NS
  };
})();
</script>
<script>
(function(){
  const App = window.App = window.App || {};
  const rhythmShapes = App.rhythmShapes;
  if(!rhythmShapes) return;
  const {
    SVG_NS,
    createStaffBase,
    addSimpleNote,
    addBeamBetween,
    addNumberMarker,
    addTupletBracket,
    buildRestGlyph,
    buildNoteGlyph,
    appendTrebleClef,
    appendTimeSignature
  } = rhythmShapes;
  const TEMPO = 80;
  const NOTE_VALUES = [
    { id:'whole', icon:'whole', beats:4, labelKey:'reading_rhythm_note_whole', descKey:'reading_rhythm_structure_step_head_desc' },
    { id:'half', icon:'half', beats:2, labelKey:'reading_rhythm_note_half', descKey:'reading_rhythm_structure_step_stem_desc' },
    { id:'quarter', icon:'quarter', beats:1, labelKey:'reading_rhythm_note_quarter', descKey:'reading_rhythm_structure_step_fill_desc' },
    { id:'eighth', icon:'eighth', beats:0.5, labelKey:'reading_rhythm_note_eighth', descKey:'reading_rhythm_structure_step_flag_desc' },
    { id:'sixteenth', icon:'sixteenth', beats:0.25, labelKey:'reading_rhythm_note_sixteenth', descKey:'reading_rhythm_structure_step_double_desc' }
  ];
  const REST_VALUES = [
    { id:'whole-rest', icon:'whole', labelKey:'reading_rhythm_rest_whole', descKey:'reading_rhythm_rest_caption_whole' },
    { id:'half-rest', icon:'half', labelKey:'reading_rhythm_rest_half', descKey:'reading_rhythm_rest_caption_half' },
    { id:'quarter-rest', icon:'quarter', labelKey:'reading_rhythm_rest_quarter', descKey:'reading_rhythm_rest_caption_quarter' },
    { id:'eighth-rest', icon:'eighth', labelKey:'reading_rhythm_rest_eighth', descKey:'reading_rhythm_rest_caption_eighth' },
    { id:'sixteenth-rest', icon:'sixteenth', labelKey:'reading_rhythm_rest_sixteenth', descKey:'reading_rhythm_rest_caption_sixteenth' }
  ];
  const TUPLET_BASE = {
    id:'straight',
    count:2,
    replaces:2,
    pattern:[0.5,0.5],
    labelKey:'reading_rhythm_tuplet_variant_even',
    timelineLabelKey:'reading_rhythm_tuplet_timeline_base',
    compareLabelKey:'reading_rhythm_tuplet_compare_btn_2'
  };
  const TUPLET_HERO_DURATION = 2;
  const TUPLET_VARIANTS = [
    { id:'triplet', count:3, replaces:2, labelKey:'reading_rhythm_tuplet_variant_triplet', ratioKey:'reading_rhythm_tuplet_ratio_triplet', timelineLabelKey:'reading_rhythm_tuplet_timeline_triplet', compareLabelKey:'reading_rhythm_tuplet_compare_btn_3' },
    { id:'quartet', count:4, replaces:3, labelKey:'reading_rhythm_tuplet_variant_quartet', ratioKey:'reading_rhythm_tuplet_ratio_quartet', timelineLabelKey:'reading_rhythm_tuplet_timeline_quartet', compareLabelKey:'reading_rhythm_tuplet_compare_btn_4' },
    { id:'quintet', count:5, replaces:4, labelKey:'reading_rhythm_tuplet_variant_quintet', ratioKey:'reading_rhythm_tuplet_ratio_quintet', timelineLabelKey:'reading_rhythm_tuplet_timeline_quintet', compareLabelKey:'reading_rhythm_tuplet_compare_btn_5' }
  ].map(def=>({ ...def, pattern: makeTupletPattern(def.count, def.replaces) }));
  const TUPLET_HERO_ROWS = [
    {
      id:'row-2-3',
      base:{ id:'even-2', labelKey:'reading_rhythm_tuplet_hero_even', count:2, dotClass:'tuplets-hero-dot is-base', figure:{ plainCount:2 } },
      tuple:{ id:'triplet', labelKey:'reading_rhythm_tuplet_variant_triplet', count:3, dotClass:'tuplets-hero-dot', figure:{ variantId:'triplet' } }
    },
    {
      id:'row-3-4',
      base:{ id:'even-3', labelKey:'reading_rhythm_tuplet_hero_even_three', count:3, dotClass:'tuplets-hero-dot is-base', figure:{ plainCount:3 } },
      tuple:{ id:'quartet', labelKey:'reading_rhythm_tuplet_variant_quartet', count:4, dotClass:'tuplets-hero-dot', figure:{ variantId:'quartet' } }
    },
    {
      id:'row-4-5',
      base:{ id:'even-4', labelKey:'reading_rhythm_tuplet_hero_even_four', count:4, dotClass:'tuplets-hero-dot is-base', figure:{ plainCount:4 } },
      tuple:{ id:'quintet', labelKey:'reading_rhythm_tuplet_variant_quintet', count:5, dotClass:'tuplets-hero-dot', figure:{ variantId:'quintet' } }
    }
  ];
  const TUPLET_COMPARE_STEPS = [2,3,4,5];
  const TUPLET_SOUND_PATTERNS = {
    straight:[0.5,0.5,0.5,0.5],
    swing:[2/3,1/3,2/3,1/3]
  };

  /*
    === Meter cards data format ===
    - Each entry in METER_CARDS describes one meter and the illustrative bars shown in the big staff.
    - `examples` is an array of measures; every measure contains `items`, which are rendered left-to-right.
    - Supported item helpers:
        * `makeNote(value, opts)` — value: whole|half|quarter|eighth|sixteenth; opts:
            - `beam`: string identifier to beam neighbouring notes.
            - `accent`: 0–3 (influences playback dynamics).
            - `dots`: number of augmentation dots.
            - `offsetY`: vertical tweak in px.
            - `duration`: override rhythm value (in beats).
            - `scale`: optional size multiplier (defaults to `METER_NOTE_SCALE`).
        * `makeRest(value)` — same values as notes; automatically marks the playback as silence.
    - To show tuplets, add `tuplets:[ { from:<index>, to:<index>, label:'3' } ]`.
    - Use consistent beam identifiers per measure (e.g., `68-group-a`) so the renderer knows which notes share a beam.
  */

  // === Meter example helpers ===
  const NOTE_LENGTHS = { whole:4, half:2, quarter:1, eighth:0.5, sixteenth:0.25 };
  const METER_NOTE_SCALE = 0.8;
  const METER_BEAM_GAP = 0.18;
  const BASE_TONE_FREQ = 392; // g1
  const ACCENT_LEVELS = {
    0:{ gain:0.5, attack:0.04, release:0.05 },
    1:{ gain:0.65, attack:0.008, release:0.06 },
    2:{ gain:0.80, attack:0.008, release:0.08 },
    3:{ gain:1.00, attack:0.008, release:0.11 }
  };

  function durationFromValue(value, dots){
    let base = NOTE_LENGTHS[value] ?? 1;
    if(dots === 1) base *= 1.5;
    else if(dots === 2) base *= 1.75;
    return base;
  }

  function makeNote(value, opts={}){
    const dots = opts.dots || 0;
    const duration = typeof opts.duration === 'number' ? opts.duration : durationFromValue(value, dots);
    return { kind:'note', value, dots, ...opts, duration };
  }

  function makeRest(value, opts={}){
    const dots = opts.dots || 0;
    const duration = typeof opts.duration === 'number' ? opts.duration : durationFromValue(value, dots);
    return { kind:'rest', value, dots, ...opts, duration };
  }

  const METER_CARDS = [
    {
      id:'24', titleKey:'reading_rhythm_meter_card_24_title', descKey:'reading_rhythm_meter_card_24_desc',
      beats:2, noteValue:'quarter', accent:[0],
      patternBar:[1,1], patternSeq:[1,1,1,1],
      examples:[
        {
          id:'24-quarter-duo',
          labelKey:'reading_rhythm_meter_24_example_quarters',
          items:[ makeNote('quarter'), makeNote('quarter', { stem:'down', accent:2 }) ]
        },
        {
          id:'24-half',
          labelKey:'reading_rhythm_meter_24_example_half',
          items:[ makeNote('half', { stem:'up' }) ]
        },
        {
          id:'24-march',
          labelKey:'reading_rhythm_meter_24_example_march',
          items:[
            makeNote('quarter'),
            makeNote('eighth', { beam:'24-march', accent:2  }),
            makeNote('eighth', { beam:'24-march' })
          ]
        }
      ]
    },
    {
      id:'34', titleKey:'reading_rhythm_meter_card_34_title', descKey:'reading_rhythm_meter_card_34_desc',
      beats:3, noteValue:'quarter', accent:[0],
      patternBar:[1,1,1], patternSeq:[1,1,1,1,1,1],
      examples:[
        {
          id:'34-dotted-half',
          labelKey:'reading_rhythm_meter_34_example_dotted_half',
          items:[ makeNote('half', { dots:1 }) ]
        },
        {
          id:'34-half-quarter',
          labelKey:'reading_rhythm_meter_34_example_half_quarter',
          items:[ makeNote('half'), makeNote('quarter', { accent:2}) ]
        },
        {
          id:'34-quarters',
          labelKey:'reading_rhythm_meter_34_example_quarters',
          items:[ makeNote('quarter'), makeNote('quarter', { accent:2}), makeNote('quarter', { accent:2}) ]
        },
        {
          id:'34-quarter-eighths',
          labelKey:'reading_rhythm_meter_34_example_quarter_eighths',
          items:[
            makeNote('quarter'),
            makeNote('eighth', { beam:'34-swing' , accent:2}),
            makeNote('eighth', { beam:'34-swing' }),
            makeNote('quarter', { accent:2})
          ]
        },
        {
          id:'34-eighth-groups',
          labelKey:'reading_rhythm_meter_34_example_eighth_groups',
          items:[
            makeNote('eighth', { beam:'34-group-a', accent:3}),
            makeNote('eighth', { beam:'34-group-a' }),
            makeNote('eighth', { beam:'34-group-b', accent:2}),
            makeNote('eighth', { beam:'34-group-b' }),
            makeNote('eighth', { beam:'34-group-c', accent:2 }),
            makeNote('eighth', { beam:'34-group-c' })
          ]
        }
      ]
    },
    {
      id:'44', titleKey:'reading_rhythm_meter_card_44_title', descKey:'reading_rhythm_meter_card_44_desc',
      beats:4, noteValue:'quarter', accent:[0],
      patternBar:[1,1,1,1], patternSeq:[1,1,1,1,1,1,1,1],
      examples:[
        {
          id:'44-whole',
          labelKey:'reading_rhythm_meter_44_example_whole',
          items:[ makeNote('whole') ]
        },
        {
          id:'44-halves',
          labelKey:'reading_rhythm_meter_44_example_halves',
          items:[ makeNote('half'), makeNote('half', { accent:2}) ]
        },
        {
          id:'44-quarters',
          labelKey:'reading_rhythm_meter_44_example_quarters',
          items:[ makeNote('quarter'), makeNote('quarter', { accent:2}), makeNote('quarter', { accent:2}), makeNote('quarter', { accent:2}) ]
        },
        {
          id:'44-combo',
          labelKey:'reading_rhythm_meter_44_example_combo',
          items:[
            makeNote('half'),
            makeNote('quarter', { accent:2}),
            makeNote('eighth', { beam:'44-combo', accent:2}),
            makeNote('eighth', { beam:'44-combo' })
          ]
        },
        {
          id:'44-triplet',
          labelKey:'reading_rhythm_meter_44_example_triplet',
          items:[
            makeNote('quarter', { duration:2/3 }),
            makeNote('quarter', { duration:2/3 }),
            makeNote('quarter', { duration:2/3 }),
            makeNote('half', { stem:'down' ,  accent:2})
          ],
          tuplets:[ { from:0, to:2, label:'3' } ]
        },
        {
          id:'44-rest',
          labelKey:'reading_rhythm_meter_44_example_rest_mix',
          items:[
            makeRest('quarter'),
            makeNote('quarter',{accent:2}),
            makeNote('eighth', { beam:'44-rest', accent:2 }),
            makeNote('eighth', { beam:'44-rest' }),
            makeNote('quarter',{accent:2})
          ]
        }
      ]
    },
    {
      id:'68', titleKey:'reading_rhythm_meter_card_68_title', descKey:'reading_rhythm_meter_card_68_desc',
      beats:6, noteValue:'eighth', accent:[0,3],
      patternBar:Array(6).fill(0.5), patternSeq:Array(12).fill(0.5),
      examples:[
        {
          id:'68-trip-groups',
          labelKey:'reading_rhythm_meter_68_example_groups',
          items:[
            makeNote('eighth', { beam:'68-trip-a' }),
            makeNote('eighth', { beam:'68-trip-a' }),
            makeNote('eighth', { beam:'68-trip-a' }),
            makeNote('eighth', { beam:'68-trip-b' , accent:2}),
            makeNote('eighth', { beam:'68-trip-b' }),
            makeNote('eighth', { beam:'68-trip-b' })
          ]
        },
        {
          id:'68-trip-groups_with_rest',
          labelKey:'reading_rhythm_meter_68_example_trip_groups_rest',
          items:[
            makeNote('eighth', { beam:'68-rest-a' }),
            makeNote('eighth', { beam:'68-rest-a' }),
            makeRest('eighth'),            
            makeNote('eighth', { beam:'68-rest-b', accent:2 }),
            makeNote('eighth', { beam:'68-rest-b' }),
            makeRest('eighth')
          ]
        },
        {
          id:'68-dotted_quarters',
          labelKey:'reading_rhythm_meter_68_example_dotted_quarters',
          items:[
            makeNote('quarter', { dots:1 , accent:2 }),
            makeNote('quarter', { dots:1 , accent:2 })
          ]
        }
      ]
    }
  ];
  const METER_COMPARE_MINI = [
    {
      id:'meter-mini-34',
      meterId:'34',
      figureId:'meter-mini-figure-34',
      beatsId:'meter-mini-beats-34',
      buttonId:'meter-mini-play-34',
      pattern:Array(6).fill(0.5),
      accentTimeline:[3,0,2,0,2,0],
      items:[
        makeNote('eighth', { beam:'mini34-a', accent:3 }),
        makeNote('eighth', { beam:'mini34-a' }),
        makeNote('eighth', { beam:'mini34-b', accent:1 }),
        makeNote('eighth', { beam:'mini34-b' }),
        makeNote('eighth', { beam:'mini34-c', accent:1 }),
        makeNote('eighth', { beam:'mini34-c' })
      ]
    },
    {
      id:'meter-mini-68',
      meterId:'68',
      figureId:'meter-mini-figure-68',
      beatsId:'meter-mini-beats-68',
      buttonId:'meter-mini-play-68',
      pattern:Array(6).fill(0.5),
      accentTimeline:[3,0,0,2,0,0],
      items:[
        makeNote('eighth', { beam:'mini68-a', accent:3 }),
        makeNote('eighth', { beam:'mini68-a' }),
        makeNote('eighth', { beam:'mini68-a' }),
        makeNote('eighth', { beam:'mini68-b', accent:2 }),
        makeNote('eighth', { beam:'mini68-b' }),
        makeNote('eighth', { beam:'mini68-b' })
      ]
    }
  ];
  const els = {};
  const state = {
    initialized:false,
    noteButtons:new Map(),
    meterPlaying:null,
    meterTimer:null,
    activeMeterId:(METER_CARDS[0] && METER_CARDS[0].id) || '24',
    activeExampleIndex:0,
    meterSwitchButtons:new Map(),
    meterExampleListButtons:[],
    meterMeasureRects:[],
    currentExamples:[],
    meterExampleCache:new Map(),
    stemsBusy:false,
    beamsBusy:false,
    tuplets:{
      activeVariant:'triplet',
      compareActive:2,
      tableRows:new Map(),
      compareButtons:new Map(),
      playingNodes:new Set()
    },
    meterCompareMini:new Map(),
    tempo:{
      bpm:120,
      nodes:[],
      slider:null,
      durationNodes:{
        quarter:null,
        eighth:null,
        dotted:null
      }
    },
    tupletHero:{
      lanes:[],
      rows:[],
      duration:TUPLET_HERO_DURATION,
      baseStep:null,
      rafId:null,
      startTime:null,
      motionQuery:null
    }
  };

  function ready(fn){
    if(document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  ready(init);

  function init(){
    if(state.initialized) return;
    mapEls();
    bindEvents();
    renderAll();
    updateAudioWarning();
    state.initialized = true;
  }

  function logPlace(tag, payload){
    if(!placeState.debug) return;
    try{
      console.log('[place drag]', tag, payload);
    } catch(_e){}
  }

  function mapEls(){
    els.view = document.getElementById('view-reading-theory-rhythm');
    els.structureFigure = document.getElementById('rhythm-structure-figure');
    els.noteList = document.getElementById('rhythm-note-list');
    els.restList = document.getElementById('rhythm-rest-list');
    els.dotFigure = document.getElementById('rhythm-dot-figure');
    els.tieFigure = document.getElementById('rhythm-tie-figure');
    els.extensionBtn = document.getElementById('rhythm-extension-play');
    els.stemsTrigger = document.getElementById('rhythm-stems-trigger');
    els.stemsFigure = document.getElementById('rhythm-stems-figure');
    els.beamsTrigger = document.getElementById('rhythm-beams-trigger');
    els.beamsFigure = document.getElementById('rhythm-beams-figure');
    els.meterNotation = document.getElementById('rhythm-meter-notation');
    els.meterSwitch = document.getElementById('rhythm-meter-switch');
    els.meterActiveTitle = document.getElementById('rhythm-meter-active-title');
    els.meterActiveDesc = document.getElementById('rhythm-meter-active-desc');
    els.meterExampleFigure = document.getElementById('rhythm-meter-example-figure');
    els.meterExampleList = document.getElementById('rhythm-meter-example-list');
    els.meterPlaySelected = document.getElementById('rhythm-meter-play-selected');
    els.meterPlayAll = document.getElementById('rhythm-meter-play-all');
    els.meterCompareButton = document.getElementById('rhythm-meter-compare-play-both');
    els.tempoSlider = document.getElementById('tempo-control');
    els.tempoBpmLabel = document.getElementById('tempo-bpm-label');
    els.tempoDurationQuarter = document.getElementById('tempo-duration-quarter');
    els.tempoDurationEighth = document.getElementById('tempo-duration-eighth');
    els.tempoDurationDotted = document.getElementById('tempo-duration-dotted');
    els.tempoDemoBeats = document.getElementById('tempo-demo-beats');
    els.tempoPlay = document.getElementById('tempo-click');
    els.audioWarning = document.getElementById('rhythm-audio-warning');
    els.tupletFigure = document.getElementById('rhythm-tuplet-figure');
    els.tupletHero = document.getElementById('rhythm-tuplet-hero');
    els.tupletMeaningFigure = document.getElementById('rhythm-tuplet-meaning-figure');
    els.tupletTable = document.getElementById('rhythm-tuplet-table');
    els.tupletReadingBase = document.getElementById('rhythm-tuplet-reading-base');
    els.tupletReadingTriplet = document.getElementById('rhythm-tuplet-reading-triplet');
    els.tupletSoundStraight = document.getElementById('rhythm-tuplet-sound-straight');
    els.tupletSoundSwing = document.getElementById('rhythm-tuplet-sound-swing');
    els.tupletCompareButtons = document.getElementById('rhythm-tuplet-compare-buttons');
    els.tupletCompareTimeline = document.getElementById('rhythm-tuplet-compare-timeline');
  }

  function bindEvents(){
    if(els.extensionBtn) els.extensionBtn.addEventListener('click', playExtension);
    if(els.stemsTrigger) els.stemsTrigger.addEventListener('click', playStemsDemo);
    if(els.beamsTrigger) els.beamsTrigger.addEventListener('click', playBeamsDemo);
    if(els.tupletReadingBase) els.tupletReadingBase.addEventListener('click', ()=>playTupletVariant(TUPLET_BASE.id, [els.tupletReadingBase]));
    if(els.tupletReadingTriplet) els.tupletReadingTriplet.addEventListener('click', ()=>{
      setActiveTupletVariant('triplet');
      playTupletVariant('triplet', [els.tupletReadingTriplet]);
    });
    if(els.tupletSoundStraight) els.tupletSoundStraight.addEventListener('click', ()=>playPatternNodes(TUPLET_SOUND_PATTERNS.straight, [els.tupletSoundStraight], { accentFirst:true }));
    if(els.tupletSoundSwing) els.tupletSoundSwing.addEventListener('click', ()=>playPatternNodes(TUPLET_SOUND_PATTERNS.swing, [els.tupletSoundSwing], { accentFirst:true }));
    METER_COMPARE_MINI.forEach(config=>{
      const btn = document.getElementById(config.buttonId);
      if(btn) btn.addEventListener('click', ()=>playMeterMiniById(config.id));
    });
    if(els.tempoSlider){
      els.tempoSlider.addEventListener('input', handleTempoSliderInput);
      els.tempoSlider.addEventListener('change', handleTempoSliderInput);
    }
    if(els.tempoPlay) els.tempoPlay.addEventListener('click', playTempoDemo);
    if(els.meterCompareButton) els.meterCompareButton.addEventListener('click', playMeterComparison);
    if(els.meterPlaySelected) els.meterPlaySelected.addEventListener('click', ()=>playMeterExamples('single'));
    if(els.meterPlayAll) els.meterPlayAll.addEventListener('click', ()=>playMeterExamples('sequence'));
    document.addEventListener('visibilitychange', handleVisibilityChange);
    window.addEventListener('pagehide', stopAudioAndReset);
  }

  function renderAll(){
    renderStructureFigure();
    renderStemsFigure();
    renderBeamsFigure();
    renderNotes();
    renderRests();
    renderDotFigure();
    renderTieFigure();
    renderMeterNotation();
    renderMeterExamples();
    renderMeterCompare();
    renderTupletFigure();
    renderTupletHero();
    renderTupletMeaning();
    renderTupletTable();
    renderTupletCompare();
    setActiveTupletVariant(state.tuplets.activeVariant);
    setActiveCompareCount(state.tuplets.compareActive);
    renderTempoSection();
  }

  function t(key){
    return (window.I18N && typeof I18N.t === 'function') ? I18N.t(key) : key;
  }

  function renderNotes(){
    if(!els.noteList) return;
    els.noteList.innerHTML = '';
    state.noteButtons.clear();
    NOTE_VALUES.forEach(def=>{
      const card = createSymbolCard(def, 'note');
      card.addEventListener('click', ()=>playSingleNote(def.id));
      els.noteList.appendChild(card);
      state.noteButtons.set(def.id, card);
    });
  }

  function createSymbolCard(def, kind){
    const btn = document.createElement('button');
    const label = `${t(def.labelKey)} – ${t(def.descKey)}`;
    btn.type = 'button';
    btn.className = kind === 'rest' ? 'rhythm-rest-card' : 'rhythm-length-card';
    btn.setAttribute('aria-label', label);
    const meta = document.createElement('div');
    meta.className = 'rhythm-length-meta';
    const title = document.createElement('strong');
    title.textContent = t(def.labelKey);
    const sub = document.createElement('span');
    sub.textContent = t(def.descKey);
    meta.appendChild(title);
    meta.appendChild(sub);
    const staffWrap = document.createElement('div');
    staffWrap.className = 'rhythm-staff note-demo';
    const staffSvg = createStaffFigure(kind, def.icon);
    staffSvg.setAttribute('aria-hidden', 'true');
    staffWrap.appendChild(staffSvg);
    btn.appendChild(meta);
    btn.appendChild(staffWrap);
    return btn;
  }

  function createStaffFigure(kind, shapeId){
    const staff = createStaffBase(220, 120, { inset:20, startY:32, gap:14 });
    const { svg, startY, gap, width } = staff;
    svg.setAttribute('viewBox', '0 0 220 120');
    const drawing = App.noteDrawing || { buildRestGlyph, buildNoteGlyph };
    const glyph = kind === 'rest'
      ? drawing.buildRestGlyph(shapeId)
      : drawing.buildNoteGlyph(shapeId);
    const centerX = width / 2;
    const centerY = startY + gap * 2;
    glyph.setAttribute('transform', `translate(${centerX},${centerY})`);
    svg.appendChild(glyph);
    return svg;
  }

  function renderRests(){
    if(!els.restList) return;
    els.restList.innerHTML = '';
    REST_VALUES.forEach(def=>{
      const card = createSymbolCard(def, 'rest');
      card.addEventListener('click', ()=>{
        card.classList.add('is-active');
        window.setTimeout(()=>card.classList.remove('is-active'), 500);
      });
      els.restList.appendChild(card);
    });
  }

  function playSingleNote(id){
    const def = NOTE_VALUES.find(item=>item.id === id);
    if(!def) return;
    const node = state.noteButtons.get(id);
    if(!node) return;
    const audio = App.audio;
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern([def.beats], {
        bpm:TEMPO,
        freq:520,
        onStep: ()=>node.classList.add('is-playing'),
        onFinish: ()=>node.classList.remove('is-playing')
      });
    } else {
      flashNode(node, 'is-playing', 600);
    }
  }

  function playStemsDemo(){
    if(state.stemsBusy) return;
    state.stemsBusy = true;
    if(els.stemsTrigger) els.stemsTrigger.classList.add('is-playing');
    const done = ()=>{
      state.stemsBusy = false;
      if(els.stemsTrigger) els.stemsTrigger.classList.remove('is-playing');
    };
    const audio = App.audio;
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern([1], { bpm:TEMPO, freq:520, onFinish: done });
    } else {
      window.setTimeout(done, (60 / TEMPO) * 1000);
    }
  }

  function playBeamsDemo(){
    if(state.beamsBusy) return;
    state.beamsBusy = true;
    if(els.beamsTrigger) els.beamsTrigger.classList.add('is-playing');
    const done = ()=>{
      state.beamsBusy = false;
      if(els.beamsTrigger) els.beamsTrigger.classList.remove('is-playing');
    };
    const audio = App.audio;
    const pattern = [0.5,0.5,0.5,0.5];
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern(pattern, { bpm:TEMPO, freq:540, onFinish: done });
    } else {
      window.setTimeout(done, pattern.reduce((sum,val)=>sum+val,0) * (60 / TEMPO) * 1000);
    }
  }

  function renderStemsFigure(){
    if(!els.stemsFigure) return;
    els.stemsFigure.innerHTML = '';
    const staff = createStaffBase(360, 150);
    const lowerY = staff.startY + staff.gap * 4;
    const upperY = staff.startY + staff.gap;
    addSimpleNote(staff.svg, 140, lowerY, { stem:'up' });
    addSimpleNote(staff.svg, 240, upperY, { stem:'down' });
    els.stemsFigure.appendChild(staff.svg);
    if(els.stemsTrigger) els.stemsTrigger.setAttribute('aria-label', t('reading_rhythm_play'));
  }

  function renderBeamsFigure(){
    if(!els.beamsFigure) return;
    els.beamsFigure.innerHTML = '';
    const staff = createStaffBase(380, 150);
    const y = staff.startY + staff.gap * 2.5;
    addSimpleNote(staff.svg, 110, y, { stem:'up' });
    addSimpleNote(staff.svg, 160, y, { stem:'up' });
    const noteA = addSimpleNote(staff.svg, 240, y, { stem:'up' });
    const noteB = addSimpleNote(staff.svg, 290, y, { stem:'up' });
    addBeamBetween(staff.svg, noteA, noteB, 'up', 10);
    els.beamsFigure.appendChild(staff.svg);
    if(els.beamsTrigger) els.beamsTrigger.setAttribute('aria-label', t('reading_rhythm_play'));
  }

  function renderTupletFigure(){
    if(!els.tupletFigure) return;
    els.tupletFigure.innerHTML = '';
    const staff = createStaffBase(460, 190, { startY:52, inset:40 });
    const baseY = staff.startY + staff.gap * 1.3;
    const tripY = staff.startY + staff.gap * 3.1;
    const baseNotes = [
      addSimpleNote(staff.svg, 150, baseY, { stem:'up' }),
      addSimpleNote(staff.svg, 220, baseY, { stem:'up' })
    ];
    addBeamBetween(staff.svg, baseNotes[0], baseNotes[1], 'up', 12);
    addTupletBracket(staff.svg, baseNotes[0].stemX - 14, baseNotes[1].stemX + 14, baseNotes[0].stemTopY - 18, '2', { fontSize:22, textOffset:8 });
    const tripPositions = [140, 200, 260];
    const tripletNotes = tripPositions.map(x=>addSimpleNote(staff.svg, x, tripY, { stem:'up' }));
    for(let i=0;i<tripletNotes.length-1;i++){
      addBeamBetween(staff.svg, tripletNotes[i], tripletNotes[i+1], 'up', 12);
    }
    addTupletBracket(staff.svg, tripletNotes[0].stemX - 14, tripletNotes[2].stemX + 14, tripletNotes[0].stemTopY - 20, '3', { fontSize:22, textOffset:8 });
    els.tupletFigure.appendChild(staff.svg);
  }

  function renderTupletHero(){
    if(!els.tupletHero) return;
    stopTupletHeroAnimation();
    els.tupletHero.innerHTML = '';
    state.tupletHero.lanes = [];
    state.tupletHero.rows = [];
    state.tupletHero.baseStep = Math.max(0.2, (state.tupletHero.duration || TUPLET_HERO_DURATION) / TUPLET_BASE.count);
    ensureTupletHeroMotionListener();
    const matrix = document.createElement('div');
    matrix.className = 'tuplets-hero-matrix';
    TUPLET_HERO_ROWS.forEach(rowDef=>{
      const row = document.createElement('div');
      row.className = 'tuplets-hero-row';
      const left = createHeroLane(rowDef.base);
      const right = createHeroLane(rowDef.tuple);
      row.appendChild(left.node);
      row.appendChild(right.node);
      const controls = document.createElement('div');
      controls.className = 'tuplets-hero-row-controls';
      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.className = 'btn btn-icon';
      toggleBtn.innerText = '▶';
      toggleBtn.setAttribute('aria-label', t('reading_rhythm_tuplet_row_toggle'));
      toggleBtn.setAttribute('aria-pressed','false');
      toggleBtn.classList.add('is-paused');
      controls.appendChild(toggleBtn);
      row.appendChild(controls);
      matrix.appendChild(row);
      const meta = {
        id:rowDef.id,
        base:left.meta,
        tuple:right.meta,
        totalDuration:left.meta.count * state.tupletHero.baseStep,
        tupleStep:(left.meta.count * state.tupletHero.baseStep) / right.meta.count,
        isRunning:false,
        button:toggleBtn
      };
      toggleBtn.addEventListener('click', ()=>toggleHeroRow(meta));
      state.tupletHero.rows.push(meta);
    });
    els.tupletHero.appendChild(matrix);
    if(!state.tupletHero.motionQuery || !state.tupletHero.motionQuery.matches){
      startTupletHeroAnimation();
    }
  }

  function createHeroLane(lane){
    const laneEl = document.createElement('div');
    laneEl.className = 'tuplets-hero-lane';
    const figure = document.createElement('div');
    figure.className = 'tuplets-hero-figure';
    figure.setAttribute('aria-hidden', 'true');
    renderMiniTupletStaff(figure, lane.figure || lane.id);
    const content = document.createElement('div');
    content.className = 'tuplets-hero-content';
    const head = document.createElement('div');
    head.className = 'tuplets-hero-head';
    const label = document.createElement('span');
    label.className = 'tuplets-hero-label';
    label.textContent = t(lane.labelKey);
    head.appendChild(label);
    if(lane.count){
      const badge = document.createElement('span');
      badge.className = 'tuplets-hero-count';
      badge.textContent = String(lane.count);
      badge.setAttribute('aria-hidden', 'true');
      head.appendChild(badge);
    }
    const dotsWrap = document.createElement('div');
    dotsWrap.className = 'tuplets-hero-dots';
    const dots = [];
    for(let i=0;i<lane.count;i++){
      const dot = document.createElement('span');
      dot.className = lane.dotClass;
      dotsWrap.appendChild(dot);
      dots.push(dot);
    }
    content.appendChild(head);
    content.appendChild(dotsWrap);
    laneEl.appendChild(figure);
    laneEl.appendChild(content);
    const meta = { count:lane.count || 1, dots, isBase:lane.dotClass.includes('is-base') };
    state.tupletHero.lanes.push(meta);
    return { node:laneEl, meta };
  }

  function ensureTupletHeroMotionListener(){
    if(state.tupletHero.motionQuery || typeof window.matchMedia !== 'function') return;
    const query = window.matchMedia('(prefers-reduced-motion: reduce)');
    const handler = ()=>{
      if(query.matches){
        stopTupletHeroAnimation();
      } else {
        startTupletHeroAnimation();
      }
    };
    if(typeof query.addEventListener === 'function') query.addEventListener('change', handler);
    else if(typeof query.addListener === 'function') query.addListener(handler);
    state.tupletHero.motionQuery = query;
  }

  function startTupletHeroAnimation(){
    if(!state.tupletHero.rows.length) return;
    if(state.tupletHero.motionQuery && state.tupletHero.motionQuery.matches) return;
    stopTupletHeroAnimation();
    const duration = Math.max(0.5, state.tupletHero.duration || TUPLET_HERO_DURATION) * 1000;
    const loop = (ts)=>{
      if(state.tupletHero.motionQuery && state.tupletHero.motionQuery.matches){
        stopTupletHeroAnimation();
        return;
      }
      if(!state.tupletHero.startTime) state.tupletHero.startTime = ts;
      const elapsed = ts - state.tupletHero.startTime;
      state.tupletHero.rows.forEach(row=>{
        if(!row.isRunning){
          return;
        }
        const rowDuration = Math.max(0.1, row.totalDuration) * 1000;
        const rowElapsed = elapsed % rowDuration;
        if(row.base){
          const baseStep = Math.max(0.05, state.tupletHero.baseStep) * 1000;
          const baseIdx = Math.floor(rowElapsed / baseStep) % row.base.count;
          setActiveLaneDot(row.base, baseIdx);
        }
        if(row.tuple){
          const tupleStep = Math.max(0.05, row.tupleStep) * 1000;
          const tupleIdx = Math.floor(rowElapsed / tupleStep) % row.tuple.count;
          setActiveLaneDot(row.tuple, tupleIdx);
        }
      });
      state.tupletHero.rafId = window.requestAnimationFrame(loop);
    };
    state.tupletHero.rafId = window.requestAnimationFrame(loop);
  }

  function stopTupletHeroAnimation(){
    if(state.tupletHero.rafId){
      cancelAnimationFrame(state.tupletHero.rafId);
      state.tupletHero.rafId = null;
    }
    state.tupletHero.startTime = null;
    state.tupletHero.lanes.forEach(lane=>{
      lane.dots.forEach(dot=>dot.classList.remove('is-active'));
    });
  }

  function setActiveLaneDot(lane, idx){
    if(!lane || !lane.dots) return;
    lane.dots.forEach((dot,i)=>dot.classList.toggle('is-active', i === idx));
  }

  function toggleHeroRow(row){
    if(!row) return;
    row.isRunning = !row.isRunning;
    if(row.button){
      row.button.innerText = row.isRunning ? '❚❚' : '▶';
      row.button.classList.toggle('is-paused', !row.isRunning);
      row.button.setAttribute('aria-pressed', row.isRunning ? 'true' : 'false');
    }
    if(!row.isRunning){
      setActiveLaneDot(row.base, -1);
      setActiveLaneDot(row.tuple, -1);
    }
  }

  function renderTupletMeaning(){
    if(!els.tupletMeaningFigure) return;
    els.tupletMeaningFigure.innerHTML = '';
    els.tupletMeaningFigure.setAttribute('aria-label', t('reading_rhythm_tuplet_meaning_figure_label'));
    const cards = [
      { variantId:TUPLET_BASE.id, labelKey:'reading_rhythm_tuplet_meaning_even', descKey:'reading_rhythm_tuplet_meaning_even_desc' },
      { variantId:'triplet', labelKey:'reading_rhythm_tuplet_meaning_triplet', descKey:'reading_rhythm_tuplet_meaning_triplet_desc' }
    ];
    cards.forEach(card=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'tuplets-meaning-card';
      const label = document.createElement('span');
      label.className = 'tuplets-meaning-label';
      label.textContent = t(card.labelKey);
      const hint = document.createElement('span');
      hint.className = 'tuplets-meaning-hint';
      hint.textContent = t(card.descKey);
      const staffHost = document.createElement('div');
      staffHost.className = 'tuplets-mini-staff';
      renderMiniTupletStaff(staffHost, card.variantId);
      btn.appendChild(label);
      btn.appendChild(hint);
      btn.appendChild(staffHost);
      btn.addEventListener('click', ()=>{
        if(card.variantId !== TUPLET_BASE.id){
          setActiveTupletVariant(card.variantId);
        }
        playTupletVariant(card.variantId, [btn]);
      });
      els.tupletMeaningFigure.appendChild(btn);
    });
  }

  function renderMiniTupletStaff(target, descriptor){
    if(!target) return;
    target.innerHTML = '';
    const config = typeof descriptor === 'string'
      ? { variantId: descriptor }
      : (descriptor || {});
    const staff = createStaffBase(220, 120, { startY:44, inset:26 });
    const y = staff.startY + staff.gap * 2;
    const miniStem = 38;
    if(config.plainCount){
      const startX = 50;
      const span = 130;
      const step = span / Math.max(config.plainCount - 1, 1);
      const notes = Array.from({ length:config.plainCount }).map((_, idx)=>{
        return addSimpleNote(staff.svg, startX + idx * step, y, { stem:'up', stemLength:miniStem });
      });
      for(let i=0;i<notes.length-1;i++){
        addBeamBetween(staff.svg, notes[i], notes[i+1], 'up', 9);
      }
    } else {
      const variantId = config.variantId || TUPLET_BASE.id;
      if(variantId === TUPLET_BASE.id){
        const left = addSimpleNote(staff.svg, 80, y, { stem:'up', stemLength:miniStem });
        const right = addSimpleNote(staff.svg, 130, y, { stem:'up', stemLength:miniStem });
        addBeamBetween(staff.svg, left, right, 'up', 9);
      } else {
        const variant = getTupletVariant(variantId) || getTupletVariant('triplet');
        const startX = 50;
        const span = 130;
        const step = span / Math.max(variant.count - 1, 1);
        const notes = Array.from({ length:variant.count }).map((_, idx)=>{
          return addSimpleNote(staff.svg, startX + idx * step, y, { stem:'up', stemLength:miniStem });
        });
        for(let i=0;i<notes.length-1;i++){
          addBeamBetween(staff.svg, notes[i], notes[i+1], 'up', 9);
        }
        addTupletBracket(
          staff.svg,
          notes[0].stemX - 10,
          notes[notes.length - 1].stemX + 10,
          notes[0].stemTopY - 8,
          String(variant.count),
          { fontSize:30, textOffset:4 }
        );
      }
    }
    target.appendChild(staff.svg);
  }

  function renderTupletTable(){
    if(!els.tupletTable) return;
    els.tupletTable.innerHTML = '';
    state.tuplets.tableRows.clear();
    TUPLET_VARIANTS.forEach(variant=>{
      const tr = document.createElement('tr');
      tr.dataset.variant = variant.id;
      const name = document.createElement('th');
      name.scope = 'row';
      name.textContent = t(variant.labelKey);
      const count = document.createElement('td');
      count.textContent = variant.count.toString();
      const replaces = document.createElement('td');
      replaces.textContent = variant.replaces.toString();
      const ratio = document.createElement('td');
      ratio.textContent = t(variant.ratioKey);
      tr.appendChild(name);
      tr.appendChild(count);
      tr.appendChild(replaces);
      tr.appendChild(ratio);
      state.tuplets.tableRows.set(variant.id, tr);
      els.tupletTable.appendChild(tr);
    });
  }

  function setActiveTupletVariant(id){
    const variant = getTupletVariant(id) || getTupletVariant('triplet');
    state.tuplets.activeVariant = variant.id;
    updateTupletTableState();
  }

  function updateTupletTableState(){
    state.tuplets.tableRows.forEach((row, variantId)=>{
      if(!row) return;
      row.classList.toggle('is-active', variantId === state.tuplets.activeVariant);
    });
  }

  function createTimelineTrack(count, opts={}){
    const track = document.createElement('div');
    track.className = opts.trackClass || 'tuplets-timeline-track';
    for(let i=0;i<count;i++){
      const dot = document.createElement('span');
      dot.className = opts.dotClass || 'tuplets-timeline-dot';
      if(i === 0) dot.classList.add('is-accent');
      track.appendChild(dot);
    }
    return track;
  }

  function renderTupletCompare(){
    if(!els.tupletCompareButtons || !els.tupletCompareTimeline) return;
    els.tupletCompareButtons.innerHTML = '';
    els.tupletCompareButtons.setAttribute('aria-label', t('reading_rhythm_tuplet_compare_label'));
    state.tuplets.compareButtons.clear();
    TUPLET_COMPARE_STEPS.forEach(count=>{
      const variant = getVariantByCount(count);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = t((variant && variant.compareLabelKey) || `reading_rhythm_tuplet_compare_btn_${count}`);
      btn.addEventListener('click', ()=>{
        setActiveCompareCount(count);
        const variantId = variant ? variant.id : TUPLET_BASE.id;
        playTupletVariant(variantId, [btn]);
      });
      els.tupletCompareButtons.appendChild(btn);
      state.tuplets.compareButtons.set(count, btn);
    });
    setActiveCompareCount(state.tuplets.compareActive);
  }

  function setActiveCompareCount(count){
    const variant = getVariantByCount(count) || TUPLET_BASE;
    state.tuplets.compareActive = variant.count;
    state.tuplets.compareButtons.forEach((btn, value)=>{
      if(btn) btn.classList.toggle('is-active', value === variant.count);
    });
    renderCompareTimeline(variant);
  }

  function renderCompareTimeline(variant){
    if(!els.tupletCompareTimeline || !variant) return;
    els.tupletCompareTimeline.innerHTML = '';
    const label = document.createElement('div');
    label.className = 'tuplets-timeline-label';
    label.textContent = t(variant.timelineLabelKey);
    const track = createTimelineTrack(variant.count);
    els.tupletCompareTimeline.appendChild(label);
    els.tupletCompareTimeline.appendChild(track);
  }

  function getTupletVariant(id){
    if(!id) return TUPLET_VARIANTS[0];
    if(id === TUPLET_BASE.id || id === 'straight') return TUPLET_BASE;
    return TUPLET_VARIANTS.find(item=>item.id === id) || TUPLET_VARIANTS[0];
  }

  function getVariantByCount(count){
    if(count === TUPLET_BASE.count) return TUPLET_BASE;
    return TUPLET_VARIANTS.find(item=>item.count === count) || null;
  }

  function playTupletVariant(id, nodes){
    const variant = getTupletVariant(id);
    if(!variant) return;
    playPatternNodes(variant.pattern, nodes);
  }

  function playPatternNodes(pattern=[], nodes=[], opts={}){
    const playable = Array.isArray(nodes) ? nodes.filter(Boolean) : [];
    if(!pattern.length){
      playable.forEach(node=>flashNode(node, 'is-playing', 600));
      return;
    }
    const audio = App.audio;
    if(audio && typeof audio.playPattern === 'function'){
      markTupletNodes(playable);
      audio.playPattern(pattern, {
        bpm:opts.bpm || TEMPO,
        freq:(idx)=>opts.freq ? opts.freq(idx) : (idx === 0 ? 580 : 500),
        accentFirst:opts.accentFirst !== false,
        onFinish: ()=>releaseTupletNodes(playable)
      });
    } else {
      playable.forEach(node=>flashNode(node, 'is-playing', 600));
    }
  }

  function markTupletNodes(nodes){
    nodes.forEach(node=>{
      node.classList.add('is-playing');
      state.tuplets.playingNodes.add(node);
    });
  }

  function releaseTupletNodes(nodes){
    nodes.forEach(node=>{
      node.classList.remove('is-playing');
      state.tuplets.playingNodes.delete(node);
    });
  }

  function clearTupletPlayingNodes(){
    releaseTupletNodes(Array.from(state.tuplets.playingNodes));
  }

  function makeTupletPattern(count, replaces){
    if(!count || !replaces) return [];
    const unit = replaces / count;
    return Array.from({ length:count }, ()=>unit);
  }

  function renderStructureFigure(){
    if(!els.structureFigure) return;
    els.structureFigure.innerHTML = '';
    els.structureFigure.setAttribute('role', 'img');
    els.structureFigure.setAttribute('aria-live', 'polite');
    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', '0 0 200 140');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    const staff = createStaffBase(280, 140, { startY:24, inset:30 });
    const noteY = staff.startY + staff.gap * 2.5;
    const note = addSimpleNote(staff.svg, 120, noteY, { stem:'up', flags:1 });
    svg.appendChild(staff.svg);
    addNumberMarker(svg, note.headX - 26, note.headY + 18, '1');
    addNumberMarker(svg, note.stemX - 26, note.stemTopY + 18, '2');
    addNumberMarker(svg, note.stemX + 36, note.stemTopY + 18, '3');
    els.structureFigure.appendChild(svg);
  }

  function renderDotFigure(){
    if(!els.dotFigure) return;
    els.dotFigure.innerHTML = '';
    const staff = createStaffBase(220, 90, { inset:18, startY:24, gap:12 });
    const noteY = staff.startY + staff.gap * 2;
    addSimpleNote(staff.svg, staff.width / 2, noteY, { stem:'none', hollow:true, noteType:'half' });
    const dot = document.createElementNS(SVG_NS, 'circle');
    dot.setAttribute('cx', String((staff.width / 2) + 24));
    dot.setAttribute('cy', String(noteY - 4));
    dot.setAttribute('r', '5');
    dot.setAttribute('fill', 'currentColor');
    staff.svg.appendChild(dot);
    els.dotFigure.appendChild(staff.svg);
  }

  function renderTieFigure(){
    if(!els.tieFigure) return;
    els.tieFigure.innerHTML = '';
    const staff = createStaffBase(320, 120, { inset:20, startY:26, gap:14 });
    const noteY = staff.startY + staff.gap * 2.5;
    const left = addSimpleNote(staff.svg, 120, noteY, { stem:'up' });
    const right = addSimpleNote(staff.svg, 220, noteY, { stem:'up' });
    const bar = document.createElementNS(SVG_NS, 'line');
    bar.setAttribute('x1', String(staff.width / 2));
    bar.setAttribute('x2', String(staff.width / 2));
    bar.setAttribute('y1', String(staff.startY));
    bar.setAttribute('y2', String(staff.startY + staff.gap * 4));
    bar.setAttribute('stroke', 'currentColor');
    bar.setAttribute('stroke-width', '2');
    bar.setAttribute('stroke-opacity', '0.7');
    staff.svg.appendChild(bar);
    const tie = document.createElementNS(SVG_NS, 'path');
    const startX = left.headX - 16;
    const endX = right.headX + 16;
    const midX = (startX + endX) / 2;
    const bottomY = noteY + 28;
    tie.setAttribute('d', `M${startX} ${noteY + 10} Q ${midX} ${bottomY} ${endX} ${noteY + 10}`);
    tie.setAttribute('fill', 'none');
    tie.setAttribute('stroke', 'currentColor');
    tie.setAttribute('stroke-width', '4');
    tie.setAttribute('stroke-linecap', 'round');
    staff.svg.appendChild(tie);
    els.tieFigure.appendChild(staff.svg);
  }

  function renderMeterNotation(){
    if(!els.meterNotation) return;
    els.meterNotation.innerHTML = '';
    const staff = createStaffBase(360, 160, { inset:40, startY:36, gap:14 });
    const svg = staff.svg;
    svg.setAttribute('preserveAspectRatio','xMinYMid meet');
    appendTrebleClef(svg, {
      inset:staff.inset,
      startY:staff.startY,
      gap:staff.gap,
      scale:0.6,
      y:staff.startY - staff.gap * 1.2
    });
    appendTimeSignature(svg, '4/4', {
      inset:staff.inset,
      startY:staff.startY,
      gap:staff.gap,
      x:staff.inset + 70,
      fontSize:32
    });
    const bar = document.createElementNS(SVG_NS, 'line');
    bar.setAttribute('x1', '260');
    bar.setAttribute('x2', '260');
    bar.setAttribute('y1', String(staff.startY));
    bar.setAttribute('y2', String(staff.startY + staff.gap * 4));
    bar.setAttribute('stroke', 'currentColor');
    bar.setAttribute('stroke-width', '2');
    svg.appendChild(bar);
    els.meterNotation.appendChild(svg);
  }

  function playExtension(){
    if(!els.dotFigure) return;
    els.dotFigure.classList.add('is-playing');
    const audio = App.audio;
    const onFinish = ()=>els.dotFigure && els.dotFigure.classList.remove('is-playing');
    const pattern = [1.5];
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern(pattern, { bpm:TEMPO, freq:520, onFinish });
    } else {
      window.setTimeout(onFinish, pattern.reduce((sum,val)=>sum+val,0) * (60 / TEMPO) * 1000);
    }
  }

  function getMeterDef(id){
    return METER_CARDS.find(card=>card.id === String(id));
  }

  function renderMeterExamples(){
    renderMeterSwitch();
    updateMeterExampleContent();
  }

  function renderMeterSwitch(){
    if(!els.meterSwitch) return;
    els.meterSwitch.innerHTML = '';
    els.meterSwitch.setAttribute('aria-label', t('reading_rhythm_meter_cards_heading'));
    state.meterSwitchButtons.clear();
    METER_CARDS.forEach(def=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = t(def.titleKey);
      btn.setAttribute('role', 'tab');
      btn.addEventListener('click', ()=>{
        if(state.activeMeterId !== def.id){
          setActiveMeter(def.id);
        }
      });
      els.meterSwitch.appendChild(btn);
      state.meterSwitchButtons.set(def.id, btn);
    });
    updateMeterSwitchState();
  }

  function updateMeterSwitchState(){
    state.meterSwitchButtons.forEach((btn, id)=>{
      if(!btn) return;
      const isActive = id === state.activeMeterId;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      btn.tabIndex = isActive ? 0 : -1;
    });
  }

  function setActiveMeter(id){
    state.activeMeterId = id;
    state.activeExampleIndex = 0;
    updateMeterSwitchState();
    updateMeterExampleContent();
  }

  function updateMeterExampleContent(){
    const def = getMeterDef(state.activeMeterId) || METER_CARDS[0];
    if(!def) return;
    if(els.meterActiveTitle) els.meterActiveTitle.textContent = t(def.titleKey);
    if(els.meterActiveDesc) els.meterActiveDesc.textContent = t(def.descKey);
    const examples = getMeterExamples(def);
    state.currentExamples = examples;
    renderMeterExampleList(examples);
    renderMeterExampleFigure(examples);
    updateMeterButtonsState(examples.length > 0);
    setActiveExample(state.activeExampleIndex);
  }

  function getMeterExamples(def){
    if(!def) return [];
    if(state.meterExampleCache.has(def.id)){
      return state.meterExampleCache.get(def.id);
    }
    const examples = buildExamples(def);
    state.meterExampleCache.set(def.id, examples);
    return examples;
  }

  function buildExamples(def){
    const list = Array.isArray(def.examples) ? def.examples : [];
    const computed = list.map(example=>{
      const items = Array.isArray(example.items) ? example.items.map(item=>({ ...item })) : [];
      const pattern = [];
      const accentTimeline = [];
      const playTimeline = [];
      let needsPrimaryAccent = true;
      items.forEach((item, idx)=>{
        const duration = getItemDuration(item);
        pattern.push(duration);
        if(item.kind === 'rest'){
          accentTimeline.push(0);
          playTimeline.push(false);
          return;
        }
        const level = typeof item.accent === 'number'
          ? clampAccentLevel(item.accent)
          : (needsPrimaryAccent && idx === 0 ? 3 : 0);
        if(level > 0) needsPrimaryAccent = false;
        accentTimeline.push(level);
        playTimeline.push(true);
      });
      const total = pattern.reduce((sum,val)=>sum + val, 0);
      return {
        ...example,
        items,
        pattern,
        accentTimeline,
        playTimeline,
        total: total || def.beats || pattern.length
      };
    });
    return computed;
  }

  function getItemDuration(item){
    if(!item) return 0;
    if(typeof item.duration === 'number') return item.duration;
    const dots = item.dots || 0;
    return durationFromValue(item.value, dots);
  }

  function getNoteValueDenominator(noteValue){
    switch(noteValue){
      case 'whole': return 1;
      case 'half': return 2;
      case 'eighth': return 8;
      case 'sixteenth': return 16;
      case 'quarter':
      default:
        return 4;
    }
  }

  function combineExampleTimelines(examples){
    const pattern = [];
    const accentTimeline = [];
    const playTimeline = [];
    examples.forEach(example=>{
      const localPattern = Array.isArray(example.pattern) ? example.pattern : [];
      const localAccent = Array.isArray(example.accentTimeline) ? example.accentTimeline : [];
      const localPlay = Array.isArray(example.playTimeline) ? example.playTimeline : [];
      localPattern.forEach((value, idx)=>{
        pattern.push(value);
        accentTimeline.push(
          typeof localAccent[idx] === 'number' ? clampAccentLevel(localAccent[idx]) : (idx === 0 ? 3 : 0)
        );
        playTimeline.push(
          typeof localPlay[idx] === 'boolean' ? localPlay[idx] : true
        );
      });
    });
    return { pattern, accentTimeline, playTimeline };
  }

  function renderMeterExampleList(examples){
    if(!els.meterExampleList) return;
    els.meterExampleList.innerHTML = '';
    state.meterExampleListButtons = [];
    examples.forEach((example, idx)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      const label = document.createElement('strong');
      label.textContent = `${idx + 1}.`;
      const desc = document.createElement('span');
      desc.className = 'meta';
      desc.textContent = t(example.labelKey);
      btn.appendChild(label);
      btn.appendChild(desc);
      btn.addEventListener('click', ()=>setActiveExample(idx));
      els.meterExampleList.appendChild(btn);
      state.meterExampleListButtons.push(btn);
    });
  }

  function renderMeterExampleFigure(examples){
    if(!els.meterExampleFigure) return;
    els.meterExampleFigure.innerHTML = '';
    state.meterMeasureRects = [];
    highlightMeasure(null);
    if(!examples.length) return;
    const meterDef = getMeterDef(state.activeMeterId) || METER_CARDS[0];
    const count = examples.length;
    const measureWidth = 170;
    const inset = 40;
    const clefScale = 0.6;
    const clefVisualWidth = 18;
    const signatureWidth = 30;
    const spacingAfterSignature = 24;
    const firstMeasureExtra = clefVisualWidth + signatureWidth + spacingAfterSignature;
    const width = inset * 2 + firstMeasureExtra + measureWidth * count + 16;
    const height = 190;
    const staff = createStaffBase(width, height, { inset, startY:50, gap:14 });
    const svg = staff.svg;
    const clefstart = -48 * count; 
    appendTrebleClef(svg, {
      x:clefstart,
      startY:staff.startY,
      gap:staff.gap,
      scale:clefScale,
      y:staff.startY - 34
    });
    const meterLabel = meterDef
      ? `${meterDef.beats || ''}/${getNoteValueDenominator(meterDef.noteValue)}`
      : '4/4';
    const sigX = inset + clefVisualWidth + 54;
    appendTimeSignature(svg, meterLabel, {
      inset,
      startY:staff.startY,
      gap:staff.gap,
      x:sigX,
      fontSize:30,
      topY:staff.startY + staff.gap * 1.8,
      bottomY:staff.startY + staff.gap * 3.7
    });
    const contentStart = inset + firstMeasureExtra;
    examples.forEach((example, idx)=>{
      const startX = contentStart + idx * measureWidth;
      const endX = startX + measureWidth;
      const highlight = document.createElementNS(SVG_NS, 'rect');
      highlight.classList.add('meter-measure-highlight');
      highlight.setAttribute('x', String(startX + 4));
      highlight.setAttribute('y', String(staff.startY - staff.gap * 1.6));
      highlight.setAttribute('width', String(measureWidth - 8));
      highlight.setAttribute('height', String(staff.gap * 4 + staff.gap * 1.9));
      highlight.setAttribute('rx', '12');
      svg.insertBefore(highlight, svg.firstChild);
      state.meterMeasureRects.push(highlight);
      if(idx > 0){
        addBarLine(svg, startX, staff.startY, staff.gap);
      }
      drawMeasureItems(svg, { example, startX, endX, staff });
      const hit = document.createElementNS(SVG_NS, 'rect');
      hit.classList.add('meter-measure-hit');
      hit.setAttribute('x', String(startX));
      hit.setAttribute('y', String(staff.startY - staff.gap * 2));
      hit.setAttribute('width', String(measureWidth));
      hit.setAttribute('height', String(staff.gap * 6));
      hit.addEventListener('click', ()=>setActiveExample(idx));
      svg.appendChild(hit);
    });
    const finalX = contentStart + measureWidth * count;
    addBarLine(svg, finalX, staff.startY, staff.gap, true);
    els.meterExampleFigure.appendChild(svg);
  }

  function addBarLine(svg, x, startY, gap, strong){
    const line = document.createElementNS(SVG_NS, 'line');
    line.setAttribute('x1', String(x));
    line.setAttribute('x2', String(x));
    line.setAttribute('y1', String(startY));
    line.setAttribute('y2', String(startY + gap * 4));
    line.setAttribute('stroke', 'currentColor');
    line.setAttribute('stroke-width', strong ? '3' : '2');
    svg.appendChild(line);
    if(strong){
      const line2 = document.createElementNS(SVG_NS, 'line');
      line2.setAttribute('x1', String(x + 6));
      line2.setAttribute('x2', String(x + 6));
      line2.setAttribute('y1', String(startY));
      line2.setAttribute('y2', String(startY + gap * 4));
      line2.setAttribute('stroke', 'currentColor');
      line2.setAttribute('stroke-width', '5');
      svg.appendChild(line2);
    }
  }

  function updateMeterButtonsState(hasExamples){
    if(els.meterPlaySelected) els.meterPlaySelected.disabled = !hasExamples;
    if(els.meterPlayAll) els.meterPlayAll.disabled = !hasExamples;
  }

  function setActiveExample(index){
    const examples = state.currentExamples || [];
    if(!examples.length) return;
    const clamped = Math.max(0, Math.min(index, examples.length - 1));
    state.activeExampleIndex = clamped;
    state.meterMeasureRects.forEach((rect, idx)=>{
      if(!rect) return;
      rect.classList.toggle('is-selected', idx === clamped);
      if(idx !== clamped) rect.classList.remove('is-playing');
    });
    state.meterExampleListButtons.forEach((btn, idx)=>{
      if(!btn) return;
      const active = idx === clamped;
      btn.classList.toggle('is-active', active);
      btn.setAttribute('aria-current', active ? 'true' : 'false');
    });
  }

  function highlightMeasure(index){
    state.meterMeasureRects.forEach((rect, idx)=>{
      if(!rect) return;
      rect.classList.toggle('is-playing', typeof index === 'number' && idx === index);
      if(index === null) rect.classList.remove('is-playing');
    });
  }

  function drawMeasureItems(svg, config){
    const example = config.example || {};
    const items = example.items || [];
    const startX = config.startX + 10;
    const endX = config.endX;
    const staff = config.staff;
    const beamPadding = items.map((item, idx)=>getBeamGap(item, items[idx + 1]));
    const total = items.reduce((sum,item, idx)=>sum + getItemDuration(item) + beamPadding[idx], 0) || 1;
    const padding = 15;
    const innerWidth = Math.max(12, (endX - startX) - padding * 2);
    const centerY = staff.startY + staff.gap * 2;
    const beamGroups = new Map();
    const positions = [];
    let cursor = 0;
    let needsPrimaryAccent = true;
    items.forEach((item, idx)=>{
      const duration = getItemDuration(item);
      const weight = duration + beamPadding[idx];
      const x = startX + padding + (cursor / total) * innerWidth;
      const y = centerY + (item.offsetY || 0);
      if(item.kind === 'rest'){
        const rest = addRestSymbol(svg, item.value, x, staff);
        positions[idx] = rest ? { x, y, type:'rest' } : null;
      } else {
        const opts = buildNoteOptions(item);
        opts.scale = typeof item.scale === 'number' ? item.scale : METER_NOTE_SCALE;
        const note = addSimpleNote(svg, x, y, opts);
        const accentLevel = typeof item.accent === 'number'
          ? clampAccentLevel(item.accent)
          : (needsPrimaryAccent ? 3 : 0);
        if(needsPrimaryAccent && accentLevel > 0){
          needsPrimaryAccent = false;
        }
        if(item.dots){
          addDots(svg, note, item.dots);
        }
        positions[idx] = { x:note.headX, y:note.headY, type:'note', accent:accentLevel };
        if(item.beam){
          if(!beamGroups.has(item.beam)) beamGroups.set(item.beam, []);
          beamGroups.get(item.beam).push({ note, item });
        }
      }
      cursor += weight;
    });
    beamGroups.forEach(nodes=>{
      for(let i=0;i<nodes.length-1;i++){
        const dir = nodes[i].item.stem === 'down' ? 'down' : 'up';
        addBeamBetween(svg, nodes[i].note, nodes[i+1].note, dir, 8);
      }
    });
    if(example.tuplets){
      example.tuplets.forEach(tuple=>{
        const from = positions[tuple.from];
        const to = positions[tuple.to];
        if(from && to) drawTupletBracket(svg, from, to, staff, tuple);
      });
    }
    return positions;
  }

  function getBeamGap(item, nextItem){
    if(!item || item.kind === 'rest') return 0;
    const value = item.value;
    const hasBeam = !!item.beam;
    const continues = nextItem && nextItem.beam && nextItem.beam === item.beam;
    if(hasBeam && !continues && (value === 'eighth' || value === 'sixteenth')){
      return METER_BEAM_GAP;
    }
    return 0;
  }

  function clampAccentLevel(level){
    if(typeof level !== 'number') return 0;
    return Math.max(0, Math.min(3, Math.round(level)));
  }

  function getAccentShape(level){
    return ACCENT_LEVELS[level] || ACCENT_LEVELS[0];
  }

  function getAccentGain(level){
    return getAccentShape(level).gain;
  }

  function getAccentEnvelope(level){
    const shape = getAccentShape(level);
    return { attack: shape.attack, release: shape.release };
  }

  function buildNoteOptions(item){
    const opts = {
      stem: item.stem || (item.value === 'sixteenth' ? 'down' : 'up'),
      hollow: item.value === 'whole' || item.value === 'half',
      noteType: item.noteType || item.value,
      scale: item.scale
    };
    if(item.value === 'whole'){
      opts.stem = 'none';
    } else if(item.value === 'eighth'){
      opts.flags = 1;
    } else if(item.value === 'sixteenth'){
      opts.flags = 2;
    }
    if(item.beam && (item.value === 'eighth' || item.value === 'sixteenth')){
      opts.flags = 0;
    }
    if(typeof item.flags === 'number') opts.flags = item.flags;
    return opts;
  }

  function addRestSymbol(svg, type, x, staff){
    const glyph = buildRestGlyph(type);
    if(!glyph) return null;
    let y = staff.startY + staff.gap * 1.5;
    if(type === 'whole') y = staff.startY + staff.gap;
    else if(type === 'half') y = staff.startY + staff.gap * 0.9;
    else if(type === 'quarter') y = staff.startY + staff.gap * 1.2;
    else if(type === 'eighth' || type === 'sixteenth') y = staff.startY + staff.gap * 1.3;
    glyph.setAttribute('transform', `translate(${x},${y})`);
    svg.appendChild(glyph);
    return glyph;
  }

  // Metrické jednotky (fixní pro obsah taktu)
  const ACC_SYMBOLS = new Set(['#','b','♯','♭','♮','natural']);

  function hasAccidental(note){
    if(!note) return false;
    const acc = note.accidental;
    if(acc === undefined || acc === null) return false;
    const normalized = typeof acc === 'string' ? acc.trim() : '';
    return ACC_SYMBOLS.has(normalized);
  }

  const VISUAL_ACC_SPACE_UNITS = 2; // kolik vizuálních jednotek navíc pro posuvku
  const VISUAL_ACC_SPACE_PX = 14;   // kolik px navíc ve fyzickém rozložení (sloty)

  function shouldAddAccidentalSpace(note, opts={}){
    if(!note) return false;
    const hasAcc = hasAccidental(note);
    if(!hasAcc) return false;
    const forced = note.meta && note.meta.forceAccidental === true;
    const mode = opts.accidentalSpaceMode || 'all'; // 'all' | 'forced' | 'none'
    if(mode === 'none') return false;
    const show = opts.showAccidentals !== false;
    const allowMode = mode === 'all' || (mode === 'forced' && forced);
    return allowMode && (show || forced);
  }

  function metricUnits(note){
    if(!note) return 1;
    const type = note.noteType || note.duration || note.value || 'quarter';
    const map = { whole:16, half:8, quarter:4, eighth:2, sixteenth:1 };
    let units = typeof map[type] === 'number' ? map[type] : 1;
    const dots = typeof note.dots === 'number' ? Math.max(0, note.dots) : 0;
    if(dots > 0){
      const factor = 2 - Math.pow(0.5, dots);
      units = units * factor;
    }
    const t = note.meta && note.meta.tuplet;
    if(t){
      const def = { n:3, in:2 };
      const num = typeof t === 'object' && typeof t.n === 'number' ? t.n : def.n;
      const den = typeof t === 'object' && typeof t.in === 'number' ? t.in : def.in;
      if(num > 0 && den > 0){
        units = units * (den / num);
      }
    }
    return units;
  }

  // Vizuální jednotky (šířka slotu) – laditelné, lze změnit mapu nebo použít note.spaceUnits
  function visualUnits(note, opts={}){
    if(!note) return 1;
    if(typeof note.spaceUnits === 'number') return Math.max(1, note.spaceUnits);
    const type = note.noteType || note.duration || note.value || 'quarter';
    const map = { whole:6, half:6, quarter:3, eighth:2, sixteenth:2 }; // laditelná mapa
    let units = typeof map[type] === 'number' ? map[type] : 1;
    const dots = typeof note.dots === 'number' ? Math.max(0, note.dots) : 0;
    if(dots > 0){
      const factor = 2 - Math.pow(0.5, dots);
      units = units * factor;
    }
    const addAccSpace = shouldAddAccidentalSpace(note, {
      accidentalSpaceMode: opts.accidentalSpace || 'all',
      showAccidentals: true
    });
    if(addAccSpace){
      units += VISUAL_ACC_SPACE_UNITS; // vizuální rezerva pro posuvku (neovlivňuje metrickou délku)
    }
    const t = note.meta && note.meta.tuplet;
    if(t){
      const def = { n:3, in:2 };
      const num = typeof t === 'object' && typeof t.n === 'number' ? t.n : def.n;
      const den = typeof t === 'object' && typeof t.in === 'number' ? t.in : def.in;
      if(num > 0 && den > 0){
        units = units * (den / num);
      }
    }
    return units;
  }

  // kompatibilita: durationUnits používáme pro metrický obsah
  function durationUnits(note){
    return metricUnits(note);
  }

  function durationValue(type, meterBase='quarter'){
    const base = meterBase;
    const map = {
      quarter: { whole:4, half:2, quarter:1, eighth:0.5, sixteenth:0.25 },
      half:    { whole:4, half:1, quarter:0.5, eighth:0.25, sixteenth:0.125 },
      eighth:  { whole:8, half:4, quarter:2, eighth:1, sixteenth:0.5 }
    };
    const val = map[base]?.[type];
    return typeof val === 'number' ? val : 1;
  }

  function glyphSpan(units){
    if(!Number.isFinite(units)) return 40;
    // rozumné rozpětí pro šestnáctinové jednotky (whole=16)
    const span = 50 + units * 3.5;
    return Math.min(120, Math.max(32, span));
  }

  function layoutMeasure(items=[], opts={}){
    const meterUnits = typeof opts.meterUnits === 'number' ? opts.meterUnits : 16;
    const maxWidth = typeof opts.maxWidth === 'number' ? opts.maxWidth : null;
    const gapBase = typeof opts.noteGapBase === 'number' ? opts.noteGapBase : 18;
    const measures = typeof opts.measures === 'number' ? Math.max(1, Math.floor(opts.measures)) : null;
    const metricList = items.map(i=>metricUnits(i));
    const visualOpts = { accidentalSpace: opts.accidentalSpace || 'all' };
    const visualList = items.map(i=>visualUnits(i, visualOpts));
    const totalUnits = metricList.reduce((sum,v)=>sum+v,0);
    const barUnits = Array.isArray(opts.barUnits)
      ? opts.barUnits
      : null;

    // Pokud máme jasný počet taktů, rozdělíme šířku podle obsahu
    if(measures && meterUnits){
      const padDefault = gapBase * 0.5;
      const barPad = typeof opts.barPad === 'number' ? opts.barPad : padDefault;
      const leadingPad = typeof opts.leadingPad === 'number' ? opts.leadingPad : gapBase * 0.8;
      const TICK = 96;
      const meterTicks = Math.round(meterUnits * TICK);
      const ticksList = metricList.map(u=>Math.round(u * TICK));

      // Nejprve spočítáme celkový prostor (bez škálování)
      let tickCursor = 0;
      let rawSpan = 0;
      ticksList.forEach((t, idx)=>{
        if(tickCursor === 0) rawSpan += leadingPad;
        rawSpan += visualList[idx] * gapBase;
        tickCursor += t;
        while(tickCursor >= meterTicks && idx < ticksList.length - 1){
          rawSpan += barPad;
          tickCursor -= meterTicks;
        }
      });
      const scale = maxWidth && rawSpan > maxWidth ? (maxWidth / rawSpan) : 1;

      // Aplikujeme škálování při generování pozic
      const xs = [];
      const spans = [];
      const barXs = [];
      tickCursor = 0;
      let cursor = 0;
      ticksList.forEach((t, idx)=>{
        if(tickCursor === 0) cursor += leadingPad * scale;
        xs.push(cursor);
        const span = visualList[idx] * gapBase * scale;
        spans.push(span);
        cursor += span;
        tickCursor += t;
        while(tickCursor >= meterTicks && idx < ticksList.length - 1){
          cursor += barPad * scale;
          barXs.push(cursor);
          tickCursor -= meterTicks;
        }
      });

      return {
        xs,
        spans,
        totalSpan: cursor,
        totalUnits,
        unitWidth: gapBase * scale,
        barUnits,
        barXs,
        spanScale: scale
      };
    }

    // fallback: proporcionální na celou šířku
    const unitsList = visualList.length ? visualList : metricList;
    const barPad = typeof opts.barPad === 'number' ? opts.barPad : gapBase * 0.5;
    const totalUnitsVisual = unitsList.reduce((sum,v)=>sum+v,0);
    const unitWidth = totalUnitsVisual > 0
      ? (maxWidth ? maxWidth / totalUnitsVisual : gapBase)
      : gapBase;
    const xs = [];
    const spans = [];
    const barXs = [];
    let cursor = 0;
    let unitCursor = 0;
    unitsList.forEach((u, idx)=>{
      xs.push(cursor);
      const span = u * unitWidth;
      spans.push(span);
      cursor += span;
      unitCursor += u;
      if(meterUnits && unitCursor % meterUnits === 0 && idx < unitsList.length - 1){
        barXs.push(cursor);
        cursor += barPad;
      }
    });
    const totalSpan = cursor;
    if(opts.centerSingle !== false && measures === 1 && xs.length === 1 && barXs.length === 0){
      const free = totalSpan - spans[0];
      const shift = free > 0 ? free / 2 : 0;
      xs[0] = xs[0] + shift;
    }
    return {
      xs,
      spans,
      totalSpan,
      totalUnits,
      unitWidth,
      barUnits,
      barXs,
      spanScale: maxWidth ? unitWidth / gapBase : 1
    };
  }

  // Expose shared note/rest helpers for reuse (guarded to avoid missing refs)
  const _addFlags = (typeof addFlags === 'function') ? addFlags : undefined;
  const _addDots = (typeof addDots === 'function') ? addDots : undefined;
  App.noteDrawing = App.noteDrawing || {};
  App.noteDrawing.addSimpleNote = addSimpleNote;
  App.noteDrawing.addRestSymbol = addRestSymbol;
  App.noteDrawing.buildRestGlyph = buildRestGlyph;
  App.noteDrawing.buildNoteGlyph = buildNoteGlyph;
  App.noteDrawing.durationUnits = durationUnits;
  App.noteDrawing.durationValue = durationValue;
  App.noteDrawing.addBeamBetween = addBeamBetween;
  App.noteDrawing.glyphSpan = glyphSpan;
  App.noteDrawing.appendTimeSignature = appendTimeSignature;
  App.noteDrawing.layoutMeasure = layoutMeasure;
  if(_addFlags) App.noteDrawing.addFlags = _addFlags;
  if(_addDots) App.noteDrawing.addDots = _addDots;

  function addDots(svg, note, count){
    if(!note) return;
    for(let i=0;i<count;i++){
      const dot = document.createElementNS(SVG_NS, 'circle');
      dot.setAttribute('cx', String(note.headX + 18 + i * 8));
      dot.setAttribute('cy', String(note.headY - 6));
      dot.setAttribute('r', '3');
      dot.setAttribute('fill', 'currentColor');
      svg.appendChild(dot);
    }
  }

  function drawTupletBracket(svg, from, to, staff, tuple){
    const x1 = from.x ;
    const x2 = to.x + 16;
    const y = (staff.startY - 2* staff.gap) + (tuple.offset || 0);
    const path = document.createElementNS(SVG_NS, 'path');
    path.setAttribute('d', `M${x1} ${y} L${x2} ${y}`);
    path.setAttribute('stroke', 'currentColor');
    path.setAttribute('stroke-width', '2');
    path.setAttribute('fill', 'none');
    svg.appendChild(path);
    const text = document.createElementNS(SVG_NS, 'text');
    text.setAttribute('x', String((x1 + x2) / 2));
    text.setAttribute('y', String(y - 4));
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('font-size', '16');
    text.setAttribute('font-weight', '600');
    text.setAttribute('fill', 'currentColor');
    text.textContent = tuple.label || '3';
    svg.appendChild(text);
  }

  function playMeterExamples(mode){
    const examples = state.currentExamples || [];
    if(!examples.length) return;
    const target = mode === 'sequence' ? examples : [examples[state.activeExampleIndex] || examples[0]];
    const stepMap = [];
    target.forEach(example=>{
      if(!example || !Array.isArray(example.pattern)) return;
      const measureIndex = examples.indexOf(example);
      example.pattern.forEach(()=>stepMap.push(measureIndex >= 0 ? measureIndex : null));
    });
    const timelines = combineExampleTimelines(target);
    if(!timelines.pattern.length) return;
    const button = mode === 'sequence' ? els.meterPlayAll : els.meterPlaySelected;
    playCustomPattern(timelines.pattern, {
      button,
      playTimeline: timelines.playTimeline,
      accentTimeline: timelines.accentTimeline,
      onStep:index=>{
        const targetMeasure = stepMap[index];
        if(typeof targetMeasure === 'number') highlightMeasure(targetMeasure);
      },
      onFinish:()=>highlightMeasure(null),
      onCancel:()=>highlightMeasure(null)
    });
  }

  function playCustomPattern(pattern, options={}){
    stopMeterPlayback();
    if(!pattern.length) return;
    const bpmValue = typeof options.bpm === 'number' ? options.bpm : TEMPO;
    const buttons = [];
    if(options.button){
      options.button.disabled = true;
      buttons.push(options.button);
    }
    const handleFinish = cancelled=>{
      buttons.forEach(btn=>btn && (btn.disabled = false));
      state.meterPlaying = null;
      if(cancelled){
        if(typeof options.onCancel === 'function') options.onCancel();
      } else if(typeof options.onFinish === 'function'){
        options.onFinish();
      }
    };
    state.meterPlaying = { stop:()=>handleFinish(true) };
    const audio = App.audio;
    const accentLine = Array.isArray(options.accentTimeline) ? options.accentTimeline : [];
    const playLine = Array.isArray(options.playTimeline) ? options.playTimeline : [];
    const accentAt = index=>{
      const level = accentLine[index];
      return clampAccentLevel(typeof level === 'number' ? level : 0);
    };
    const shouldPlay = index=>{
      if(playLine.length){
        const flag = playLine[index];
        return !!flag;
      }
      return true;
    };
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern(pattern, {
        bpm:bpmValue,
        freq:index=>shouldPlay(index) ? BASE_TONE_FREQ : 0,
        gain:index=>shouldPlay(index) ? getAccentGain(accentAt(index)) : 0,
        envelope:index=>shouldPlay(index) ? getAccentEnvelope(accentAt(index)) : {},
        onStep:index=>{
          if(typeof options.onStep === 'function') options.onStep(index);
        },
        onFinish:()=>handleFinish(false)
      });
    } else {
      let idx = 0;
      const tick = ()=>{
        if(idx >= pattern.length){
          handleFinish(false);
          return;
        }
        if(typeof options.onStep === 'function') options.onStep(idx);
        const wait = (pattern[idx] || 1) * (60 / bpmValue);
        idx++;
        state.meterTimer = window.setTimeout(tick, wait * 1000);
      };
      tick();
    }
  }

  function renderMeterCompare(){
    state.meterCompareMini.clear();
    METER_COMPARE_MINI.forEach(config=>{
      renderMeterMiniFigure(config);
      const nodes = renderMeterMiniBeats(config);
      const button = document.getElementById(config.buttonId);
      state.meterCompareMini.set(config.id, { config, nodes, button });
    });
  }

  function renderMeterMiniFigure(config){
    const target = document.getElementById(config.figureId);
    if(!target) return;
    const meterDef = getMeterDef(config.meterId);
    if(!meterDef) return;
    target.innerHTML = '';
    const width = 360;
    const height = 150;
    const inset = 8;
    const staff = createStaffBase(width, height, { inset, startY:48, gap:14 });
    const svg = staff.svg;
    drawMiniSignature(svg, meterDef, inset, staff);
    const clefVisualWidth = 42;
    const signatureWidth = 30;
    const spacingAfterSignature = 2;
    const contentStart = inset + clefVisualWidth + signatureWidth + spacingAfterSignature;
    const contentEnd = width - inset;
    const example = { items: config.items || [] };
    drawMeasureItems(svg, { example, startX:contentStart, endX:contentEnd, staff });
    target.appendChild(svg);
  }

  function drawMiniSignature(svg, meterDef, inset, staff){
    appendTrebleClef(svg, {
      inset,
      startY:staff.startY,
      gap:staff.gap,
      scale:0.6,
      y:staff.startY - 14
    });
    const sigX = inset + 70;
    const meterLabel = meterDef
      ? `${meterDef.beats || ''}/${getNoteValueDenominator(meterDef.noteValue)}`
      : '4/4';
    appendTimeSignature(svg, meterLabel, {
      inset,
      startY:staff.startY,
      gap:staff.gap,
      x:sigX,
      fontSize:26,
      topY:staff.startY + staff.gap * 1.5,
      bottomY:staff.startY + staff.gap * 3.4
    });
  }

  function renderMeterMiniBeats(config){
    const target = document.getElementById(config.beatsId);
    if(!target) return [];
    target.innerHTML = '';
    target.setAttribute('aria-label', t('reading_rhythm_meter_compare_beats_label'));
    const pattern = Array.isArray(config.pattern) ? config.pattern : [];
    const accentTimeline = Array.isArray(config.accentTimeline) ? config.accentTimeline : [];
    const nodes = [];
    pattern.forEach((_, idx)=>{
      const span = document.createElement('span');
      span.className = 'rhythm-meter-beat is-compact';
      span.textContent = String(idx + 1);
      if((accentTimeline[idx] || 0) > 0) span.dataset.accent = 'true';
      target.appendChild(span);
      nodes.push(span);
    });
    return nodes;
  }

  function highlightMeterMini(nodes=[], index){
    const hasNodes = Array.isArray(nodes) && nodes.length > 0;
    nodes.forEach((node, idx)=>{
      if(!node) return;
      const active = hasNodes && typeof index === 'number' && (idx === (index % nodes.length));
      node.classList.toggle('is-active', !!active);
      if(!active && typeof index !== 'number') node.classList.remove('is-active');
    });
  }

  function playMeterMiniById(id){
    const entry = state.meterCompareMini.get(id);
    if(!entry) return;
    playMeterMiniEntry(entry);
  }

  function playMeterMiniEntry(entry, opts={}){
    if(!entry || !entry.config) return;
    const pattern = Array.isArray(entry.config.pattern) ? entry.config.pattern : [];
    if(!pattern.length) return;
    const accentTimeline = Array.isArray(entry.config.accentTimeline) ? entry.config.accentTimeline : [];
    const playTimeline = Array(pattern.length).fill(true);
    const button = opts.disableButton === false ? null : (opts.button || entry.button || null);
    playCustomPattern(pattern, {
      button,
      accentTimeline,
      playTimeline,
      onStep:index=>{
        highlightMeterMini(entry.nodes, index);
        if(typeof opts.onStep === 'function') opts.onStep(index);
      },
      onFinish:()=>{
        highlightMeterMini(entry.nodes, null);
        if(typeof opts.onFinish === 'function') opts.onFinish();
      },
      onCancel:()=>{
        highlightMeterMini(entry.nodes, null);
        if(typeof opts.onCancel === 'function') opts.onCancel();
      }
    });
  }

  function playMeterPattern(def, nodes, button, mode='bar', opts={}){
    if(!def) return;
    stopMeterPlayback();
    const pattern = mode === 'sequence' && def.patternSeq ? def.patternSeq.slice() : (def.patternBar || def.pattern || []);
    if(!pattern.length) return;
    const accentSet = new Set(def.accent || [0]);
    const buttons = [];
    if(button && opts.disableButton !== false){
      button.disabled = true;
      buttons.push(button);
    }
    const highlight = index=>{
      if(!nodes) return;
      const rel = typeof index === 'number' ? index % nodes.length : null;
      nodes.forEach((beat, idx)=>{
        beat.classList.toggle('is-active', rel !== null && idx === rel);
      });
    };
    const handleFinish = cancelled=>{
      highlight(null);
      buttons.forEach(btn=>btn.disabled = false);
      state.meterPlaying = null;
      if(cancelled){
        if(typeof opts.onCancel === 'function') opts.onCancel();
      } else if(typeof opts.onFinish === 'function'){
        opts.onFinish();
      }
    };
    state.meterPlaying = { stop:()=>handleFinish(true) };
    const audio = App.audio;
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern(pattern, {
        bpm:TEMPO,
        freq:index=>accentSet.has(index % (def.beats || pattern.length)) ? 720 : 520,
        onStep: idx=>highlight(idx),
        onFinish: ()=>handleFinish(false)
      });
    } else {
      let idx = 0;
      const tick = ()=>{
        if(idx >= pattern.length){
          handleFinish(false);
          return;
        }
        highlight(idx);
        const wait = pattern[idx] || 1;
        idx++;
        state.meterTimer = window.setTimeout(tick, wait * (60 / TEMPO) * 1000);
      };
      tick();
    }
  }

  function playMeterComparison(){
    if(!els.meterCompareButton || els.meterCompareButton.disabled) return;
    const entries = METER_COMPARE_MINI.map(cfg=>state.meterCompareMini.get(cfg.id)).filter(Boolean);
    if(entries.length !== METER_COMPARE_MINI.length) return;
    els.meterCompareButton.disabled = true;
    const queue = entries.slice();
    const playNext = ()=>{
      if(!queue.length){
        els.meterCompareButton.disabled = false;
        return;
      }
      const current = queue.shift();
      playMeterMiniEntry(current, {
        disableButton:false,
        onFinish: playNext,
        onCancel: ()=>{
          queue.length = 0;
          els.meterCompareButton.disabled = false;
        }
      });
    };
    playNext();
  }

  function renderTempoSection(){
    if(!els.tempoSlider) return;
    state.tempo.slider = els.tempoSlider;
    const bpm = clampTempoValue(parseInt(els.tempoSlider.value, 10)) || 120;
    state.tempo.bpm = bpm;
    renderTempoBeats();
    updateTempoDisplay();
  }

  function renderTempoBeats(){
    if(!els.tempoDemoBeats) return;
    els.tempoDemoBeats.innerHTML = '';
    state.tempo.nodes = [];
    for(let i=0;i<6;i++){
      const span = document.createElement('span');
      span.className = 'rhythm-meter-beat is-compact';
      span.textContent = String(i + 1);
      if(i === 0 || i === 3) span.dataset.accent = 'true';
      els.tempoDemoBeats.appendChild(span);
      state.tempo.nodes.push(span);
    }
  }

  function handleTempoSliderInput(event){
    const slider = (event && event.currentTarget) || (event && event.target) || this || els.tempoSlider;
    if(!slider) return;
    const value = clampTempoValue(parseInt(slider.value, 10));
    state.tempo.bpm = value;
    updateTempoDisplay();
  }

  function clampTempoValue(value){
    if(!Number.isFinite(value)) return 120;
    return Math.max(40, Math.min(200, value));
  }

  function updateTempoDisplay(){
    if(!state.tempo) return;
    const bpm = clampTempoValue(state.tempo.bpm);
    if(els.tempoSlider) els.tempoSlider.value = bpm;
    if(!els.tempoBpmLabel || !els.tempoBpmLabel.isConnected){
      els.tempoBpmLabel = document.getElementById('tempo-bpm-label');
    }
    if(els.tempoBpmLabel) els.tempoBpmLabel.textContent = String(bpm);
    updateTempoDurations(bpm);
  }

  function updateTempoDurations(bpm){
    const quarter = 60 / bpm;
    const eighth = quarter / 2;
    const dotted = quarter * 1.5;
    if(els.tempoDurationQuarter) els.tempoDurationQuarter.textContent = formatSeconds(quarter);
    if(els.tempoDurationEighth) els.tempoDurationEighth.textContent = formatSeconds(eighth);
    if(els.tempoDurationDotted) els.tempoDurationDotted.textContent = formatSeconds(dotted);
  }

  function formatSeconds(value){
    if(!Number.isFinite(value)) return '–';
    const fixed = value.toFixed(2);
    const useComma = typeof window !== 'undefined' && window.I18N && I18N.lang === 'cs';
    return `${useComma ? fixed.replace('.', ',') : fixed} s`;
  }

  function playTempoDemo(){
    if(!state.tempo || !state.tempo.nodes || !state.tempo.nodes.length) return;
    const pattern = Array(6).fill(0.5);
    const accentTimeline = [3,0,0,2,0,0];
    playCustomPattern(pattern, {
      bpm: state.tempo.bpm,
      accentTimeline,
      playTimeline:Array(6).fill(true),
      button:els.tempoPlay,
      onStep:index=>highlightTempoBeats(index),
      onFinish:()=>highlightTempoBeats(null),
      onCancel:()=>highlightTempoBeats(null)
    });
  }

  function highlightTempoBeats(index){
    const nodes = state.tempo && state.tempo.nodes || [];
    nodes.forEach((node, idx)=>{
      if(!node) return;
      const active = typeof index === 'number' && idx === (index % nodes.length);
      node.classList.toggle('is-active', !!active);
      if(!active && typeof index !== 'number') node.classList.remove('is-active');
    });
  }

  function stopMeterPlayback(){
    if(state.meterTimer){
      window.clearTimeout(state.meterTimer);
      state.meterTimer = null;
    }
    if(state.meterPlaying && typeof state.meterPlaying.stop === 'function'){
      const stop = state.meterPlaying.stop;
      state.meterPlaying = null;
      stop();
    }
    highlightMeasure(null);
  }

  function clearNoteHighlights(){
    state.noteButtons.forEach(btn=>btn.classList.remove('is-playing'));
  }

  function flashNode(node, className, duration){
    if(!node) return;
    node.classList.add(className);
    window.setTimeout(()=>node.classList.remove(className), duration || 500);
  }

  function updateAudioWarning(){
    if(!els.audioWarning) return;
    const supported = App.audio && App.audio.supported;
    els.audioWarning.classList.toggle('hidden', supported);
  }

  function handleVisibilityChange(){
    if(document.hidden){
      stopAudioAndReset();
      stopTupletHeroAnimation();
    } else {
      startTupletHeroAnimation();
    }
  }

  function stopAudioAndReset(){
    if(App.audio && typeof App.audio.stop === 'function'){
      App.audio.stop();
    }
    clearNoteHighlights();
    stopMeterPlayback();
    highlightTempoBeats(null);
    if(els.dotFigure) els.dotFigure.classList.remove('is-playing');
    if(els.stemsTrigger) els.stemsTrigger.classList.remove('is-playing');
    if(els.beamsTrigger) els.beamsTrigger.classList.remove('is-playing');
    if(els.tupletFigure) els.tupletFigure.classList.remove('is-playing');
    clearTupletPlayingNodes();
    stopTupletHeroAnimation();
    state.stemsBusy = false;
    state.beamsBusy = false;
  }

  App.readingTheoryRhythm = {
    refresh(){
      if(!state.initialized){
        init();
      } else {
        renderAll();
        updateAudioWarning();
      }
    }
  };
})();
</script>
<!-- Scales HUB (moved from old home) -->
<section class="hidden" id="view-scales-hub">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-hub" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="hub_title"></h2>
<div class="hub-tabs" data-hub-tabs="scales" role="tablist">
  <button type="button" class="hub-tab active" data-target="theory" aria-selected="true" role="tab">
    <span class="hub-tab-icon icon-slot icon icon-20" data-icon="reading"></span>
    <span data-i18n="hub_tab_theory"></span>
  </button>
  <button type="button" class="hub-tab" data-target="practice" aria-selected="false" role="tab">
    <span class="hub-tab-icon icon-slot icon icon-20" data-icon="reading-find"></span>
    <span data-i18n="hub_tab_practice"></span>
  </button>
</div>
<div class="stack stack-lg hub-groups" data-hub="scales" data-current="theory">
  <div class="hub-group" data-section="theory">
    <h3 class="h3" data-i18n="hub_group_theory"></h3>
    <div class="grid-3 hub-cards">
      <div class="card-tile home-ivory" data-tile="about-scales">
        <div class="tile-head"><span data-icon="info" class="icon-slot icon icon-28"></span><h3 data-i18n="hub_about_scales_title"></h3></div>
        <p class="sub" data-i18n="hub_about_scales_desc"></p>
        <button class="btn btn-ghost" data-action="nav" data-to="view-scales-info" id="go-scales-info" data-i18n="common_open"></button>
      </div>
      <div class="card-tile home-blue" data-tile="list">
        <div class="tile-head"><span data-icon="scales" class="icon-slot icon icon-28"></span><h3 data-i18n="hub_list_title"></h3></div>
        <p class="sub" data-i18n="hub_list_desc"></p>
        <button class="btn btn-green" data-action="nav" data-to="view-scales" id="go-scales" data-i18n="common_open"></button>
      </div>
      <div class="card-tile home-amber" data-tile="circle">
        <div class="tile-head"><span data-icon="circle" class="icon-slot icon icon-28"></span><h3 data-i18n="hub_circle_title"></h3></div>
        <p class="sub" data-i18n="hub_circle_desc"></p>
        <button class="btn btn-amber" data-action="nav" data-to="view-circle" id="go-circle" data-i18n="common_open"></button>
      </div>
    </div>
  </div>
  <div class="hub-group" data-section="practice">
    <h3 class="h3" data-i18n="hub_group_practice"></h3>
    <div class="grid-3 hub-cards">
      <div class="card-tile home-cyan" data-tile="build">
        <div class="tile-head"><span data-icon="build" class="icon-slot icon icon-28"></span><h3 data-i18n="hub_build_title"></h3></div>
        <p class="sub" data-i18n="hub_build_desc"></p>
        <button class="btn btn-cyan" data-action="nav" data-to="view-build-select" id="go-build" data-i18n="common_open"></button>
      </div>
      <div class="card-tile home-violet" data-tile="ksquiz">
        <div class="tile-head"><span data-icon="ksquiz" class="icon-slot icon icon-28"></span><h3 data-i18n="hub_ksquiz_title"></h3></div>
        <p class="sub" data-i18n="hub_ksquiz_desc"></p>
        <button class="btn btn-violet" data-action="nav" data-to="view-ksquiz" id="go-ksquiz" data-i18n="common_open"></button>
      </div>
      <div class="card-tile home-circlequiz" data-tile="circle-quiz">
        <div class="tile-head"><span data-icon="circle-quiz" class="icon-slot icon icon-28"></span><h3 data-i18n="hub_circlequiz_title"></h3></div>
        <p class="sub" data-i18n="hub_circlequiz_desc"></p>
        <button class="btn btn-violet" data-action="nav" data-to="view-circle-quiz" id="go-circle-quiz" data-i18n="common_open"></button>
      </div>
    </div>
  </div>
</div>
</section>
<!-- Intervals hub -->
<section class="hidden" id="view-intervals">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-int" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="intervals_title"></h2>
<p class="sub" data-i18n="intervals_intro"></p>
<div class="grid-3 hub-cards">
  <div class="card-tile home-violet" data-tile="intervals-what">
    <div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="intervals_what_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="intervals_what_desc"></p>
    <button class="btn btn-ghost" id="go-intervals-what" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-amber" data-tile="intervals-names">
    <div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="intervals_names_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="intervals_names_desc"></p>
    <button class="btn btn-ghost" id="go-intervals-names" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-green" data-tile="intervals-sizes">
    <div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="intervals_sizes_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="intervals_sizes_desc"></p>
    <button class="btn btn-ghost" id="go-intervals-sizes" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-blue" data-tile="intervals-scales">
    <div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="intervals_scales_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="intervals_scales_desc"></p>
    <button class="btn btn-ghost" id="go-intervals-scales" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-ivory" data-tile="intervals-color">
    <div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="intervals_color_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="intervals_color_desc"></p>
    <button class="btn btn-ghost" id="go-intervals-color" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-cyan" data-tile="intervals-practice">
    <div class="tile-head"><span data-icon="intervals" class="icon-slot icon icon-28"></span><h3 data-i18n="intervals_use_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="intervals_use_desc"></p>
    <button class="btn btn-ghost" id="go-intervals-use" data-i18n="common_open"></button>
  </div>
</div>
</section>
<!-- Interval detail pages -->
<section class="hidden" id="view-intervals-what">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-intervals" id="back-intervals-what" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="intervals_what_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="intervals_what_annotation"></p>
</div>
</section>
<section class="hidden" id="view-intervals-names">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-intervals" id="back-intervals-names" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="intervals_names_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="intervals_names_annotation"></p>
</div>
</section>
<section class="hidden" id="view-intervals-sizes">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-intervals" id="back-intervals-sizes" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="intervals_sizes_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="intervals_sizes_annotation"></p>
</div>
</section>
<section class="hidden" id="view-intervals-scales">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-intervals" id="back-intervals-scales" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="intervals_scales_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="intervals_scales_annotation"></p>
</div>
</section>
<section class="hidden" id="view-intervals-color">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-intervals" id="back-intervals-color" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="intervals_color_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="intervals_color_annotation"></p>
</div>
</section>
<section class="hidden" id="view-intervals-use">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-intervals" id="back-intervals-use" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="intervals_use_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="intervals_use_annotation"></p>
</div>
</section>
<!-- Chords hub -->
<section class="hidden" id="view-chords">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-chords" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="chords_title"></h2>
<p class="sub" data-i18n="chords_intro"></p>
<div class="grid-3 hub-cards">
  <div class="card-tile home-violet" data-tile="chords-what">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_what_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_what_desc"></p>
    <button class="btn btn-ghost" id="go-chords-what" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-amber" data-tile="chords-build">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_build_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_build_desc"></p>
    <button class="btn btn-ghost" id="go-chords-build" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-green" data-tile="chords-triads">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_triads_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_triads_desc"></p>
    <button class="btn btn-ghost" id="go-chords-triads" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-blue" data-tile="chords-seventh">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_seventh_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_seventh_desc"></p>
    <button class="btn btn-ghost" id="go-chords-seventh" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-ivory" data-tile="chords-inversions">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_inversions_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_inversions_desc"></p>
    <button class="btn btn-ghost" id="go-chords-inversions" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-cyan" data-tile="chords-diatonic">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_diatonic_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_diatonic_desc"></p>
    <button class="btn btn-ghost" id="go-chords-diatonic" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-violet" data-tile="chords-reading">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="chords_reading_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="chords_reading_desc"></p>
    <button class="btn btn-ghost" id="go-chords-reading" data-i18n="common_open"></button>
  </div>
</div>
</section>
<!-- Chord detail pages -->
<section class="hidden" id="view-chords-what">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-what" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_what_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_what_annotation"></p>
</div>
</section>
<section class="hidden" id="view-chords-build">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-build" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_build_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_build_annotation"></p>
</div>
</section>
<section class="hidden" id="view-chords-triads">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-triads" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_triads_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_triads_annotation"></p>
</div>
</section>
<section class="hidden" id="view-chords-seventh">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-seventh" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_seventh_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_seventh_annotation"></p>
</div>
</section>
<section class="hidden" id="view-chords-inversions">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-inversions" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_inversions_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_inversions_annotation"></p>
</div>
</section>
<section class="hidden" id="view-chords-diatonic">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-diatonic" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_diatonic_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_diatonic_annotation"></p>
</div>
</section>
<section class="hidden" id="view-chords-reading">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-chords" id="back-chords-reading" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="chords_reading_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="chords_reading_annotation"></p>
</div>
</section>
<!-- Dynamics placeholder -->
<section class="hidden" id="view-dynamics">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-home-dynamics" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="dynamics_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="dynamics_annotation"></p>
</div>
</section>
<!-- Expressions placeholder -->
<section class="hidden" id="view-expressions">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-home-expressions" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="expressions_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="expressions_annotation"></p>
</div>
</section>
<!-- Harmony hub -->
<section class="hidden" id="view-harmony">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-harmony" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="home_harmony_title"></h2>
<p class="sub" data-i18n="home_harmony_desc"></p>
<div class="grid-3 hub-cards">
  <div class="card-tile home-dynamics" data-tile="harmony-functions">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="harmony_functions_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="harmony_functions_note"></p>
    <button class="btn btn-ghost" id="go-harmony-functions" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-dynamics" data-tile="harmony-cadences">
    <div class="tile-head"><span data-icon="chords" class="icon-slot icon icon-28"></span><h3 data-i18n="harmony_cadences_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="harmony_cadences_note"></p>
    <button class="btn btn-ghost" id="go-harmony-cadences" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-dynamics" data-tile="harmony-progressions">
    <div class="tile-head"><span data-icon="circle-quiz" class="icon-slot icon icon-28"></span><h3 data-i18n="harmony_progressions_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="harmony_progressions_note"></p>
    <button class="btn btn-ghost" id="go-harmony-progressions" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-dynamics" data-tile="harmony-modulation">
    <div class="tile-head"><span data-icon="circle" class="icon-slot icon icon-28"></span><h3 data-i18n="harmony_modulation_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="harmony_modulation_note"></p>
    <button class="btn btn-ghost" id="go-harmony-modulation" data-i18n="common_open"></button>
  </div>
</div>
</section>
<!-- Improv hub -->
<section class="hidden" id="view-improv">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-improv" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="home_improv_title"></h2>
<p class="sub" data-i18n="home_improv_desc"></p>
<div class="grid-3 hub-cards">
  <div class="card-tile home-expressions" data-tile="improv-basics">
    <div class="tile-head"><span data-icon="reading" class="icon-slot icon icon-28"></span><h3 data-i18n="improv_basics_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="improv_basics_note"></p>
    <button class="btn btn-ghost" id="go-improv-basics" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-expressions" data-tile="improv-pentatonic">
    <div class="tile-head"><span data-icon="scales" class="icon-slot icon icon-28"></span><h3 data-i18n="improv_pentatonic_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="improv_pentatonic_note"></p>
    <button class="btn btn-ghost" id="go-improv-pentatonic" data-i18n="common_open"></button>
  </div>
  <div class="card-tile home-expressions" data-tile="improv-target">
    <div class="tile-head"><span data-icon="reading-find" class="icon-slot icon icon-28"></span><h3 data-i18n="improv_target_notes_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
    <p class="sub" data-i18n="improv_target_notes_note"></p>
    <button class="btn btn-ghost" id="go-improv-target" data-i18n="common_open"></button>
  </div>
</div>
</section>
<!-- Harmony placeholders -->
<section class="hidden" id="view-harmony-functions">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-harmony" id="back-harmony-functions" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="harmony_functions_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="harmony_functions_note"></p>
</div>
</section>
<section class="hidden" id="view-harmony-cadences">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-harmony" id="back-harmony-cadences" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="harmony_cadences_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="harmony_cadences_note"></p>
</div>
</section>
<section class="hidden" id="view-harmony-progressions">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-harmony" id="back-harmony-progressions" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="harmony_progressions_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="harmony_progressions_note"></p>
</div>
</section>
<section class="hidden" id="view-harmony-modulation">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-harmony" id="back-harmony-modulation" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="harmony_modulation_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="harmony_modulation_note"></p>
</div>
</section>
<!-- Improv placeholders -->
<section class="hidden" id="view-improv-basics">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-improv" id="back-improv-basics" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="improv_basics_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="improv_basics_note"></p>
</div>
</section>
<section class="hidden" id="view-improv-pentatonic">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-improv" id="back-improv-pentatonic" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="improv_pentatonic_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="improv_pentatonic_note"></p>
</div>
</section>
<section class="hidden" id="view-improv-target">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-improv" id="back-improv-target" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="improv_target_notes_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="improv_target_notes_note"></p>
</div>
</section>
<!-- Notes (reading) -->
<section class="hidden" id="view-sight">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-sight" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="reading_title"></h2>
<p class="sub" data-i18n="reading_intro"></p>
<div class="hub-tabs" data-hub-tabs="reading" role="tablist">
  <button type="button" class="hub-tab active" data-target="theory" aria-selected="true" role="tab">
    <span class="hub-tab-icon icon-slot icon icon-20" data-icon="reading"></span>
    <span data-i18n="hub_tab_theory"></span>
  </button>
  <button type="button" class="hub-tab" data-target="practice" aria-selected="false" role="tab">
    <span class="hub-tab-icon icon-slot icon icon-20" data-icon="reading-find"></span>
    <span data-i18n="hub_tab_practice"></span>
  </button>
</div>
<div class="stack stack-lg hub-groups" data-hub="reading" data-current="theory">
  <div class="hub-group" data-section="theory">
    <h3 class="h3" data-i18n="reading_theory_heading"></h3>
    <div class="grid-3 hub-cards">
      <div class="card-tile reading-theory-staff" data-tile="reading-theory-staff">
        <div class="tile-head"><span data-icon="reading-theory-staff" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_staff_title"></h3></div>
        <p class="sub" data-i18n="reading_theory_staff_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-staff" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-theory-notes" data-tile="reading-theory-notes">
        <div class="tile-head"><span data-icon="reading-theory-notes" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_notes_title"></h3></div>
        <p class="sub" data-i18n="reading_theory_notes_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-notes" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-theory-rhythm" data-tile="reading-theory-rhythm">
        <div class="tile-head"><span data-icon="reading-theory-rhythm" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_rhythm_title"></h3></div>
        <p class="sub" data-i18n="reading_theory_rhythm_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-rhythm" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-theory-acc" data-tile="reading-theory-acc">
        <div class="tile-head"><span data-icon="reading-theory-acc" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_accidentals_title"></h3></div>
        <p class="sub" data-i18n="reading_theory_accidentals_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-acc" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-theory-articulation" data-tile="reading-theory-articulation">
        <div class="tile-head"><span data-icon="reading-theory-articulation" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_articulation_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
        <p class="sub" data-i18n="reading_theory_articulation_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-articulation" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-theory-marks" data-tile="reading-theory-marks">
        <div class="tile-head"><span data-icon="reading-theory-marks" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_marks_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
        <p class="sub" data-i18n="reading_theory_marks_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-marks" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-theory-navigation" data-tile="reading-theory-navigation">
        <div class="tile-head"><span data-icon="reading-theory-navigation" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_theory_navigation_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
        <p class="sub" data-i18n="reading_theory_navigation_desc"></p>
        <button class="btn btn-ghost" id="go-reading-theory-navigation" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-dynamics" data-tile="reading-dynamics">
        <div class="tile-head"><span data-icon="dynamics" class="icon-slot icon icon-28"></span><h3 data-i18n="home_dynamics_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
        <p class="sub" data-i18n="home_dynamics_desc"></p>
        <button class="btn btn-ghost" id="go-dynamics" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-expressions" data-tile="reading-expressions">
        <div class="tile-head"><span data-icon="expressions" class="icon-slot icon icon-28"></span><h3 data-i18n="home_expressions_title"></h3><span class="tile-badge" data-i18n="badge_coming"></span></div>
        <p class="sub" data-i18n="home_expressions_desc"></p>
        <button class="btn btn-ghost" id="go-expressions" data-i18n="common_open"></button>
      </div>
    </div>
  </div>
  <div class="hub-group" data-section="practice">
    <h3 class="h3" data-i18n="reading_practice_heading"></h3>
    <div class="grid-3 hub-cards">
      <div class="card-tile reading-find" data-tile="reading-find">
        <div class="tile-head"><span data-icon="reading-find" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_practice_find_title"></h3></div>
        <p class="sub" data-i18n="reading_practice_find_desc"></p>
        <button class="btn btn-ghost" id="go-reading-find" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-place" data-tile="reading-place">
        <div class="tile-head"><span data-icon="reading-place" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_practice_place_title"></h3></div>
        <p class="sub" data-i18n="reading_practice_place_desc"></p>
        <button class="btn btn-ghost" id="go-reading-place" data-i18n="common_open"></button>
      </div>
      <div class="card-tile reading-rhythm" data-tile="reading-rhythm">
        <div class="tile-head"><span data-icon="reading-rhythm" class="icon-slot icon icon-28"></span><h3 data-i18n="reading_practice_rhythm_title"></h3></div>
        <p class="sub" data-i18n="reading_practice_rhythm_desc"></p>
        <button class="btn btn-ghost" id="go-reading-rhythm" data-i18n="common_open"></button>
      </div>
</div>
</div>
</div>
</section>
<script>
(function(){
  function initHubTabs(){
    const tabSets = document.querySelectorAll('.hub-tabs[data-hub-tabs]');
    if(!tabSets.length) return;
    tabSets.forEach(tabs=>{
      const hubKey = tabs.dataset.hubTabs;
      if(!hubKey) return;
      const groups = document.querySelector(`.hub-groups[data-hub="${hubKey}"]`);
      if(!groups) return;
      const buttons = Array.from(tabs.querySelectorAll('.hub-tab'));
      if(!buttons.length) return;

      function setActive(target){
        if(!target) return;
        groups.dataset.current = target;
        buttons.forEach(btn=>{
          const isActive = btn.dataset.target === target;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
      }

      tabs.addEventListener('click', event=>{
        const btn = event.target.closest('.hub-tab');
        if(!btn) return;
        const target = btn.dataset.target;
        if(!target) return;
        setActive(target);
      });

      const initial = groups.dataset.current || buttons[0]?.dataset.target || 'theory';
      setActive(initial);
    });
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initHubTabs, { once:true });
  else initHubTabs();
})();
</script>
<section class="hidden" id="view-reading-find">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-find" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="reading_find_title"></h2>
<div class="stack stack-lg reading-find-wrapper">
  <div class="reading-find-setup" id="reading-find-setup">
    <article class="list-card reading-find-intro">
      <h3 class="h3" data-i18n="reading_find_intro_heading"></h3>
      <p data-i18n="reading_find_intro_copy" data-i18n-html="1"></p>
    </article>
    <article class="list-card reading-find-config">
      <h3 class="h3" data-i18n="reading_find_config_heading"></h3>
      <div class="stack stack-md">
        <div class="reading-find-param">
          <div class="param-label" data-i18n="reading_find_param_clef"></div>
          <div class="chip-row" id="reading-find-clefs"></div>
        </div>
        <div class="reading-find-param reading-find-param-range">
          <div class="param-label" data-i18n="reading_find_param_range"></div>
          <div class="range-picker range-picker-slider">
            <div class="range-slider" id="reading-find-range"></div>
            <div class="range-picker-values">
              <span>
                <span class="range-picker-label" data-i18n="reading_find_param_range_from"></span>
                <strong id="reading-find-range-start-label"></strong>
              </span>
              <span>
                <span class="range-picker-label" data-i18n="reading_find_param_range_to"></span>
                <strong id="reading-find-range-end-label"></strong>
              </span>
            </div>
          </div>
        </div>
        <div class="reading-find-param">
          <div class="param-label" data-i18n="reading_find_param_acc"></div>
          <div class="chip-row" id="reading-find-acc"></div>
        </div>
        <div class="reading-find-param">
          <div class="param-label" data-i18n="reading_find_param_timer"></div>
          <div class="chip-row" id="reading-find-timer"></div>
        </div>
        <div class="reading-find-param">
          <div class="param-label" data-i18n="reading_find_param_count"></div>
          <div class="chip-row" id="reading-find-count"></div>
        </div>
        <div class="btns">
          <button class="btn btn-green" id="reading-find-start" data-i18n="reading_find_start"></button>
        </div>
      </div>
    </article>
  </div>
  <article class="list-card reading-find-test hidden" id="reading-find-test">
  <div class="reading-find-status">
    <div class="reading-find-progress" id="reading-find-progress"></div>
    <p class="section-hint" id="reading-find-instruction" data-i18n="reading_find_instruction"></p>
    <div class="reading-find-timer" id="reading-find-timer-display"></div>
  </div>
  <div class="reading-find-staff">
    <div class="reading-find-staff-inner" id="reading-find-staff"></div>
  </div>
  <div class="reading-find-answers" id="reading-find-answers"></div>
  <div class="btns">
    <button class="btn btn-green" id="reading-find-eval" data-i18n="reading_find_evaluate" disabled></button>
    <button class="btn btn-ghost" id="reading-find-reset" data-i18n="reading_find_reset"></button>
  </div>
</article>
<article class="list-card reading-find-summary hidden" id="reading-find-summary">
  <h3 class="h3" data-i18n="reading_find_summary_heading"></h3>
  <div class="reading-find-summary-grid">
    <div class="reading-find-summary-chart">
      <canvas class="chart" id="reading-find-chart" width="220" height="220"></canvas>
      <div class="reading-find-summary-metrics">
        <div><span data-i18n="reading_find_summary_correct"></span>: <span id="reading-find-summary-correct"></span></div>
        <div><span data-i18n="reading_find_summary_wrong"></span>: <span id="reading-find-summary-wrong"></span></div>
      </div>
      <div class="reading-find-summary-note">
        <div class="reading-find-summary-motto" id="reading-find-summary-motto"></div>
        <div class="badge big reading-find-summary-badge" id="reading-find-summary-badge"></div>
      </div>
    </div>
    <div class="reading-find-summary-staff" id="reading-find-summary-staff"></div>
  </div>
  <div class="btns">
    <button class="btn btn-green" id="reading-find-restart" data-i18n="reading_find_restart"></button>
    <button class="btn btn-ghost" id="reading-find-back" data-i18n="reading_find_back"></button>
  </div>
</article>
</div>
</section>
<section class="hidden" id="view-reading-theory-staff" data-view="reading-theory-staff">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-theory-staff" data-i18n="common_back"></button></div>
<div class="reading-staff-view stack stack-lg">
  <header class="reading-staff-hero">
    <h2 class="h2" data-i18n="reading_theory_staff_title"></h2>
    <p class="lead" data-i18n="reading_staff_intro" data-i18n-html="1"></p>
  </header>
  <article class="list-card reading-staff-card" data-section="staff-map">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_staff_section_staff"></h3>
      <p class="section-hint" id="reading-staff-label" data-i18n="reading_staff_hover_hint"></p>
    </div>
    <div class="staff-canvas">
      <div class="staff-stage" id="reading-staff-stage" role="group" aria-labelledby="reading-staff-label">
        <div class="staff-slots" id="reading-staff-slots"></div>
      </div>
    </div>
  </article>
  <article class="list-card reading-staff-card" data-section="staff-overview">
    <h3 class="h3" data-i18n="reading_staff_overview_heading"></h3>
    <p class="section-hint" data-i18n="reading_staff_overview_intro"></p>
    <ul class="reading-staff-overview-list">
      <li data-i18n="reading_staff_overview_item_keys" data-i18n-html="1"></li>
      <li data-i18n="reading_staff_overview_item_notes" data-i18n-html="1"></li>
      <li data-i18n="reading_staff_overview_item_rests" data-i18n-html="1"></li>
      <li data-i18n="reading_staff_overview_item_accidentals" data-i18n-html="1"></li>
      <li data-i18n="reading_staff_overview_item_bars" data-i18n-html="1"></li>
      <li data-i18n="reading_staff_overview_item_ledger" data-i18n-html="1"></li>
    </ul>
    <div class="staff-elements">
      <figure class="staff-elements-figure" role="img" aria-labelledby="staff-elements-caption">
        <svg viewBox="-20 0 240 120" xmlns="http://www.w3.org/2000/svg">
          <g class="staff-elements-lines" stroke="var(--ink)" stroke-width="2" stroke-linecap="round">
            <line x1="-10" y1="20" x2="210" y2="20"/>
            <line x1="-10" y1="35" x2="210" y2="35"/>
            <line x1="-10" y1="50" x2="210" y2="50"/>
            <line x1="-10" y1="65" x2="210" y2="65"/>
            <line x1="-10" y1="80" x2="210" y2="80"/>
          </g>
          <g class="staff-elements-note staff-elements-note-line">
            <ellipse cx="70" cy="50" rx="10" ry="7" fill="var(--ink)"/>
            <line x1="45" y1="50" x2="95" y2="50" stroke="var(--ink)" stroke-width="2" stroke-linecap="round"/>
          </g>
          <g class="staff-elements-note staff-elements-note-space">
            <ellipse cx="150" cy="42" rx="10" ry="7" fill="var(--ink)"/>
          </g>
          <g class="staff-elements-note staff-elements-note-ledger">
            <ellipse cx="110" cy="98" rx="10" ry="7" fill="var(--ink)"/>
            <line x1="85" y1="98" x2="135" y2="98" stroke="var(--ink)" stroke-width="2" stroke-linecap="round"/>
          </g>
        </svg>
      </figure>
      <p class="sub" id="staff-elements-caption" data-i18n="reading_staff_overview_linespaces"></p>
    </div>
  </article>
  <article class="list-card reading-staff-card" data-section="clefs">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_staff_section_clefs"></h3>
      <p class="section-hint" data-i18n="reading_staff_clefs_intro" data-i18n-html="1"></p>
    </div>
    <div class="reading-staff-clef-stage">
      <div class="reading-staff-clef-buttons" id="reading-staff-clef-buttons" role="group">
        <button class="clef-button" type="button" data-role="clef-button" data-clef="treble" aria-pressed="false">
          <span data-icon="clefTreble" class="icon-slot icon icon-28"></span>
          <span class="clef-label" data-i18n="reading_staff_clef_treble"></span>
        </button>
        <button class="clef-button" type="button" data-role="clef-button" data-clef="bass" aria-pressed="false">
          <span data-icon="clefBass" class="icon-slot icon icon-28"></span>
          <span class="clef-label" data-i18n="reading_staff_clef_bass"></span>
        </button>
        <button class="clef-button" type="button" data-role="clef-button" data-clef="alto" aria-pressed="false">
          <span data-icon="clefAlto" class="icon-slot icon icon-28"></span>
          <span class="clef-label" data-i18n="reading_staff_clef_alto"></span>
        </button>
        <button class="clef-button" type="button" data-role="clef-button" data-clef="tenor" aria-pressed="false">
          <span data-icon="clefTenor" class="icon-slot icon icon-28"></span>
          <span class="clef-label" data-i18n="reading_staff_clef_tenor"></span>
        </button>
      </div>
      <div class="reading-staff-clef-preview" id="reading-staff-clef-stage">
        <div class="clef-preview-canvas" id="reading-staff-clef-preview"></div>
        <div class="clef-description">
          <h4 class="clef-title" id="reading-staff-clef-name"></h4>
          <p class="sub" id="reading-staff-clef-desc"></p>
        </div>
      </div>
    </div>
  </article>
  <article class="list-card reading-staff-card" data-section="compare">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_staff_section_compare"></h3>
      <p class="section-hint" data-i18n="reading_staff_compare_text"></p>
    </div>
    <div class="reading-staff-compare-grid">
      <figure class="clef-compare-item">
        <div class="clef-preview-canvas" id="reading-staff-compare-treble"></div>
        <figcaption class="sub" data-i18n="reading_staff_compare_treble"></figcaption>
      </figure>
      <figure class="clef-compare-item">
        <div class="clef-preview-canvas" id="reading-staff-compare-bass"></div>
        <figcaption class="sub" data-i18n="reading_staff_compare_bass"></figcaption>
      </figure>
    </div>
  </article>
</div>
</section>
<style>
#view-reading-theory-staff .reading-staff-view{max-width:960px;margin:0 auto 48px;padding:0 0 48px;}
#view-reading-theory-staff .reading-staff-hero{display:flex;flex-direction:column;gap:12px;}
#view-reading-theory-staff .reading-staff-hero .h2{margin:0;}
#view-reading-theory-staff .reading-staff-hero .lead{margin:0;font-size:18px;color:var(--muted);max-width:720px;}
#view-reading-theory-staff .reading-staff-card{display:flex;flex-direction:column;gap:20px;}
#view-reading-theory-staff .reading-staff-card .section-head{display:flex;flex-direction:column;gap:6px;}
#view-reading-theory-staff .reading-staff-card h3{margin:0;}
#view-reading-theory-staff .section-hint{margin:0;color:var(--muted);font-size:15px;}
#view-reading-theory-staff .staff-canvas{background:var(--surface-subtle,rgba(15,23,42,.04));padding:clamp(16px,3vw,24px);border-radius:20px;border:1px solid var(--border-subtle,rgba(15,23,42,.08));}
#view-reading-theory-staff .staff-stage{position:relative;width:100%;aspect-ratio:600/218;border-radius:16px;overflow:hidden;background:var(--surface,rgba(255,255,255,.85));box-shadow:inset 0 0 0 1px rgba(15,23,42,.04);}
#view-reading-theory-staff .staff-stage svg{width:100%;height:100%;display:block;}
#view-reading-theory-staff .staff-slots{position:absolute;inset:0;display:grid;grid-template-columns:1fr;pointer-events:none;}
#view-reading-theory-staff .staff-slot-btn{pointer-events:auto;border:none;background:transparent;cursor:pointer;position:relative;}
#view-reading-theory-staff .staff-slot-btn::before{content:'';position:absolute;inset:4px 0;border-radius:10px;background:var(--accent);opacity:0;transition:opacity .18s ease;}
#view-reading-theory-staff .staff-slot-btn:hover::before,
#view-reading-theory-staff .staff-slot-btn:focus-visible::before,
#view-reading-theory-staff .staff-slot-btn.is-active::before{opacity:.12;}
#view-reading-theory-staff .staff-slot-btn:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(34,197,94,.28);border-radius:10px;}
#view-reading-theory-staff .staff-zone{fill:transparent;transition:fill .2s ease,fill-opacity .2s ease;}
#view-reading-theory-staff .staff-zone--space{fill-opacity:.04;}
#view-reading-theory-staff .staff-zone.is-active{fill:var(--accent);fill-opacity:.14;}
#view-reading-theory-staff .staff-line{stroke:var(--ink);stroke-width:1.8;stroke-linecap:round;stroke-opacity:.82;transition:stroke .2s ease,stroke-width .2s ease,stroke-opacity .2s ease;}
#view-reading-theory-staff .staff-line.is-active{stroke:var(--accent);stroke-width:3.2;stroke-opacity:1;}
#view-reading-theory-staff .reading-staff-clef-stage{display:grid;gap:20px;align-items:start;}
@media (min-width:900px){
  #view-reading-theory-staff .reading-staff-clef-stage{grid-template-columns:minmax(0,1.15fr) minmax(0,1fr);}
}
#view-reading-theory-staff .reading-staff-clef-buttons{display:flex;flex-wrap:wrap;gap:12px;}
#view-reading-theory-staff .clef-button{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:14px;border:1px solid var(--border-subtle,rgba(15,23,42,.12));background:var(--surface,rgba(255,255,255,.9));color:var(--ink);font-weight:600;transition:background .2s ease,border-color .2s ease,box-shadow .2s ease,color .2s ease;}
#view-reading-theory-staff .clef-button .icon-slot{color:var(--accent);}
#view-reading-theory-staff .clef-button.is-active{border-color:var(--accent);background:rgba(34,197,94,.12);box-shadow:0 0 0 3px rgba(34,197,94,.18);}
#view-reading-theory-staff .clef-button:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(34,197,94,.3);}
#view-reading-theory-staff .clef-description{display:flex;flex-direction:column;gap:8px;}
#view-reading-theory-staff .clef-description .clef-title{margin:0;font-size:18px;font-weight:700;color:var(--ink);}
#view-reading-theory-staff .clef-description .sub{margin:0;color:var(--muted);font-size:15px;}
#view-reading-theory-staff .clef-preview-canvas{position:relative;width:100%;aspect-ratio:320/180;border-radius:16px;background:var(--surface,rgba(255,255,255,.88));border:1px solid var(--border-subtle,rgba(15,23,42,.08));overflow:hidden;box-shadow:inset 0 0 0 1px rgba(15,23,42,.03);}
#view-reading-theory-staff .clef-preview-canvas svg{width:100%;height:100%;display:block;}
#view-reading-theory-staff .clef-staff-line{stroke:var(--ink);stroke-width:1.8;stroke-linecap:round;}
#view-reading-theory-staff .clef-ledger{stroke:var(--ink);stroke-width:1.6;stroke-linecap:round;}
#view-reading-theory-staff .clef-glyph use{stroke:currentColor;fill:currentColor;color:var(--ink);}
#view-reading-theory-staff .clef-note-head{fill:var(--ink);}
#view-reading-theory-staff .reading-staff-compare-grid{display:grid;gap:18px;}
@media (min-width:780px){
  #view-reading-theory-staff .reading-staff-compare-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
}
#view-reading-theory-staff .clef-compare-item{display:flex;flex-direction:column;gap:12px;margin:0;}
#view-reading-theory-staff .clef-compare-item figcaption{margin:0;color:var(--muted);}
#view-reading-theory-staff .reading-staff-overview-list{margin:0;padding-left:20px;display:grid;gap:8px;list-style:disc;color:var(--ink);}
#view-reading-theory-staff .reading-staff-overview-list li{color:var(--ink);}
#view-reading-theory-staff .staff-elements{display:grid;gap:12px;}
#view-reading-theory-staff .staff-elements-figure{margin:0 auto;padding:10px;border-radius:12px;background:var(--surface-subtle,rgba(15,23,42,.05));border:1px solid var(--border-subtle,rgba(15,23,42,.08));max-width:260px;width:100%;}
#view-reading-theory-staff .staff-elements-figure svg{width:100%;height:auto;display:block;}
#view-reading-theory-staff .staff-elements-note-line line,
#view-reading-theory-staff .staff-elements-note-ledger line{stroke:var(--ink);}
#view-reading-theory-staff .staff-elements-note-line ellipse,
#view-reading-theory-staff .staff-elements-note-space ellipse,
#view-reading-theory-staff .staff-elements-note-ledger ellipse{fill:var(--ink);}
#view-reading-find .reading-find-wrapper{width:100%;}
#view-reading-find .reading-find-setup{display:grid;gap:16px;}
#view-reading-find .reading-find-config .reading-find-param{display:grid;gap:8px;}
#view-reading-find .reading-find-config .param-label{font-weight:600;color:var(--muted);}
#view-reading-find .chip-row{display:flex;flex-wrap:wrap;gap:8px;}
#view-reading-find .reading-find-param-range .range-picker{display:grid;gap:10px;}
#view-reading-find .range-picker-row{display:grid;gap:8px;}
#view-reading-find .range-picker-label{font-size:13px;color:var(--muted);}
#view-reading-find .chip-row .chip{min-width:44px;justify-content:center;}
#view-reading-find .chip-row .chip:disabled{opacity:.4;cursor:not-allowed;}
#view-reading-find .reading-find-test{display:grid;gap:16px;}
#view-reading-find .reading-find-status{display:flex;flex-direction:column;gap:4px;}
#view-reading-find .reading-find-progress{font-weight:700;color:var(--muted);}
#view-reading-find .reading-find-staff{border:1px solid var(--border-subtle,rgba(15,23,42,.08));border-radius:12px;background:var(--surface-subtle,rgba(15,23,42,.05));padding:12px;overflow:auto;}
#view-reading-find .reading-find-staff-inner{min-width:320px;display:inline-block;}
#view-reading-find .reading-find-staff-inner svg{display:block;}
#view-reading-find .reading-find-answers{display:flex;flex-wrap:wrap;gap:8px;}
#view-reading-find .reading-find-answers .chip{padding:10px 16px;font-weight:600;}
#view-reading-find .reading-find-answers .chip.on{background:var(--chip-on-bg,rgba(34,197,94,.22));border-color:var(--chip-on-border,var(--accent));color:var(--chip-on-ink,var(--accent-ink,var(--ink)));}
#view-reading-find .reading-find-note ellipse{fill:var(--ink);stroke:none;transition:fill .2s ease,stroke .2s ease,stroke-width .2s ease;}
#view-reading-find .reading-find-note.is-active ellipse{stroke:var(--accent);stroke-width:.2s ease;fill:var(--accent);fill-opacity:.6;}
#view-reading-find .reading-find-note.is-answered ellipse{fill-opacity:.85;}
#view-reading-find .reading-find-note.is-correct ellipse{stroke:var(--accent);stroke-width:.2s ease;fill:var(--accent);fill-opacity:.6;}
#view-reading-find .reading-find-note.is-wrong ellipse{stroke:var(--bad-ink);stroke-width:.2s ease;fill:var(--bad-ink);fill-opacity:.6;}
#view-reading-find .reading-find-note.is-timeout ellipse{stroke:var(--bad-ink);stroke-opacity:.6;fill:var(--bad-bg,rgba(239,68,68,.18));fill-opacity:.65;}
#view-reading-find .reading-find-clef{color:var(--ink);fill:currentColor;stroke:currentColor;}
#view-reading-find .reading-find-timer{font-weight:700;color:var(--muted);}
#view-reading-find .reading-find-answer-label{font-size:16px;font-weight:700;fill:var(--muted);}
#view-reading-find .reading-find-answer-label tspan.answer-correct{fill:var(--ok-ink);}
#view-reading-find .reading-find-answer-label tspan.answer-wrong{fill:var(--bad-ink);}
#view-reading-find .reading-find-answer-label tspan.answer-divider{fill:var(--muted);}
#view-reading-find .reading-find-summary{display:grid;gap:16px;}
#view-reading-find .reading-find-summary-grid{display:grid;gap:16px;grid-template-columns:minmax(220px,280px) minmax(0,1fr);align-items:center;}
#view-reading-find .reading-find-summary-chart{display:grid;gap:12px;justify-items:center;}
#view-reading-find .reading-find-summary-metrics{display:grid;gap:6px;text-align:center;font-weight:600;color:var(--muted);}
#view-reading-find .reading-find-summary-note{display:flex;flex-direction:column;gap:12px;justify-content:center;align-items:center;text-align:center;}
#view-reading-find .reading-find-summary-motto{font-size:16px;font-weight:600;color:var(--muted);}
#view-reading-find .reading-find-summary-badge{display:inline-flex;align-items:center;gap:6px;}
#view-reading-find .reading-find-summary-staff{overflow:auto;border:1px solid var(--border-subtle,rgba(15,23,42,.08));border-radius:12px;background:var(--surface-subtle,rgba(15,23,42,.05));padding:16px;margin-top:8px;}
#view-reading-find .reading-find-summary-staff svg{min-width:960px;}
@media (max-width:720px){
  #view-reading-find .reading-find-summary-grid{grid-template-columns:1fr;}
#view-reading-find .reading-find-summary-staff svg{min-width:860px;}
}
#view-reading-rhythm .rrp-layout{width:100%;}
#view-reading-rhythm .rrp-setup{width:100%;}
#view-reading-rhythm .rrp-setup-grid{display:flex;flex-direction:column;gap:12px;width:100%;}
#view-reading-rhythm .setup-actions{display:flex;justify-content:flex-start;margin-top:8px;}
#view-reading-rhythm .setup-actions .btn{margin-top:12px;}
#view-reading-rhythm .rrp-card{border:0;border-radius:12px;padding:0;display:grid;gap:12px;background:transparent;width:100%;}
#view-reading-rhythm .rrp-card .h4{margin:0;}
#view-reading-rhythm .rrp-card .chip-row,
#view-reading-rhythm .rrp-palette .chip-row{display:flex;flex-wrap:wrap;gap:8px;}
#view-reading-rhythm .chip-row .chip{min-width:44px;justify-content:center;}
#view-reading-rhythm .chip-glyph{min-width:64px;min-height:56px;padding:10px;display:flex;align-items:center;justify-content:center;}
#view-reading-rhythm .chip-glyph svg{width:36px;height:36px;color:currentColor;display:block;transform:scale(2);transform-origin:center;overflow:visible;}
#view-reading-rhythm .rrp-quiz{display:grid;gap:16px;}
#view-reading-rhythm .rrp-bar{display:grid;gap:10px;}
#view-reading-rhythm .rrp-meter{font-weight:700;color:var(--muted);}
#view-reading-rhythm .rrp-staff{border:1px solid var(--border-subtle,rgba(15,23,42,.12));border-radius:14px;padding:12px;background:var(--surface-subtle,rgba(15,23,42,.02));overflow:hidden;}
#view-reading-rhythm .rrp-staff svg{width:100%;max-width:100%;min-width:0;height:auto;color:var(--ink);display:block;}
#view-reading-rhythm .rrp-staff g[data-source="user"]{color:var(--accent);opacity:.9;}
#view-reading-rhythm .rrp-palette{display:grid;gap:12px;}
#view-reading-rhythm .rrp-palette-group{border:1px solid var(--border-subtle,rgba(15,23,42,.1));border-radius:12px;padding:12px 14px;display:grid;gap:8px;background:var(--surface);}
#view-reading-rhythm .rrp-palette-group .h5{margin:0;color:var(--ink);}
#view-reading-rhythm .rrp-summary .summary-list{display:grid;gap:12px;}
#view-reading-rhythm .rrp-summary .list-card{padding:14px;}
#view-reading-rhythm .rrp-summary .sub{color:var(--muted);}
#view-reading-rhythm .rrp-summary-hero{display:flex;flex-wrap:wrap;gap:18px;align-items:center;margin-bottom:12px;}
#view-reading-rhythm .rrp-summary-meta{display:grid;gap:8px;font-weight:600;color:var(--muted);}
#view-reading-rhythm .rrp-summary-meta strong{color:var(--ink);font-size:20px;}
#view-reading-rhythm .rrp-summary-motto{margin:4px 0 0;font-weight:700;color:var(--ink);}
@media (max-width:720px){
  #view-reading-rhythm .rrp-card{padding:14px;}
  #view-reading-rhythm .rrp-palette-group{padding:12px;}
}

#view-reading-place .reading-place-wrapper{width:100%;}
#view-reading-place .reading-place-setup,
#view-reading-place .reading-place-test,
#view-reading-place .reading-place-summary{display:grid;gap:12px;}
#view-reading-place .reading-place-config{display:grid;gap:16px;}
#view-reading-place .reading-place-param{display:grid;gap:8px;}
.range-picker.range-picker-slider{display:grid;gap:10px;}
.range-picker-values{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);gap:8px;flex-wrap:wrap;}
.range-picker-values span{display:flex;align-items:center;gap:6px;}
.range-picker-values strong{font-weight:700;color:var(--ink);}
.range-slider{position:relative;height:38px;}
.range-slider::after{content:"";position:absolute;left:-6px;right:-6px;top:50%;height:30px;border-radius:999px;border:2px solid transparent;pointer-events:none;transform:translateY(-50%);opacity:0;transition:border-color .18s ease,opacity .18s ease;}
.range-slider.range-slider-focused::after{border-color:var(--accent);opacity:.45;}
.range-slider-track{position:absolute;left:0;right:0;top:50%;height:4px;background:var(--border-subtle,rgba(15,23,42,.18));transform:translateY(-50%);border-radius:999px;}
.range-slider-fill{position:absolute;top:0;bottom:0;background:var(--accent);border-radius:999px;}
.range-slider-input{position:absolute;left:0;top:0;width:100%;height:38px;margin:0;background:transparent;pointer-events:none;-webkit-appearance:none;appearance:none;}
.range-slider-input:focus-visible{outline:none;}
.range-slider-input::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;height:18px;width:18px;border-radius:50%;background:var(--card);border:2px solid var(--accent);box-shadow:none;}
.range-slider-input::-moz-range-thumb{pointer-events:auto;height:18px;width:18px;border-radius:50%;background:var(--card);border:2px solid var(--accent);box-shadow:none;}
.range-slider-input:focus-visible::-webkit-slider-thumb{box-shadow:0 0 0 3px var(--card),0 0 0 6px var(--accent);}
.range-slider-input:focus-visible::-moz-range-thumb{box-shadow:0 0 0 3px var(--card),0 0 0 6px var(--accent);}
.range-slider-input::-webkit-slider-runnable-track{background:transparent;}
.range-slider-input::-moz-range-track{background:transparent;}
@media (max-width:640px){
  .range-slider{padding:0 14px;}
  .range-slider-track{left:14px;right:14px;}
  .range-slider-fill{left:0;right:0;}
  .range-slider-input{left:14px;right:14px;width:calc(100% - 28px);}
}

#view-reading-place .reading-place-param-range .range-picker{display:grid;gap:12px;}
#view-reading-place .range-picker-row{display:grid;gap:8px;}
#view-reading-place .range-picker-label{font-size:13px;color:var(--muted);}
#view-reading-place .chip-row{display:flex;flex-wrap:wrap;gap:8px;}
#view-reading-place .chip-row .chip{min-width:44px;justify-content:center;}
#view-reading-place .range-picker.range-picker-slider{gap:8px;}
#view-reading-place .reading-place-status{display:flex;flex-direction:column;gap:4px;margin-bottom:0;}
#view-reading-place .reading-place-progress{font-weight:700;color:var(--muted);}
#view-reading-place .reading-place-staff{border:1px solid var(--border-subtle,rgba(15,23,42,.08));border-radius:12px;background:var(--surface-subtle,rgba(15,23,42,.05));padding:12px;overflow:auto;}
#view-reading-place .reading-place-staff-inner{min-width:360px;display:inline-block;cursor:crosshair;touch-action:pan-x;-webkit-user-select:none;user-select:none;}
#view-reading-place .reading-place-staff svg{display:block;min-height:240px;touch-action:pan-x;}
#view-reading-place .reading-place-controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;}
#view-reading-place .reading-place-summary-grid{display:grid;gap:16px;grid-template-columns:minmax(220px,280px) minmax(0,1fr);align-items:center;}
@media (max-width: 640px){
  #view-reading-place .reading-place-staff{min-height:300px;}
  #view-reading-place .reading-place-staff svg{min-height:280px;}
}

#view-reading-place .reading-place-summary-chart{display:grid;gap:12px;justify-items:center;}
#view-reading-place .reading-place-summary-metrics{display:grid;gap:6px;text-align:center;font-weight:600;color:var(--muted);}
#view-reading-place .reading-place-summary-note{display:flex;flex-direction:column;gap:12px;justify-content:center;align-items:center;text-align:center;}
#view-reading-place .reading-place-summary-staff{overflow:auto;border:1px solid var(--border-subtle,rgba(15,23,42,.08));border-radius:12px;background:var(--surface-subtle,rgba(15,23,42,.05));padding:16px;margin-top:8px;}
#view-reading-place .reading-place-summary-staff svg{min-width:960px;}
#view-reading-place .detail-scale-note-head,
#view-reading-place .reading-place-note-head{fill:var(--ink);}
#view-reading-place .reading-place-note-label{font-size:18px;font-weight:700;fill:var(--muted);}
#view-reading-place .reading-place-note-label tspan.answer-correct{fill:var(--ok-ink);}
#view-reading-place .reading-place-note-label tspan.answer-wrong{fill:var(--bad-ink);}
#view-reading-place .reading-place-note-label tspan.answer-divider{fill:var(--muted);}
#view-reading-place .reading-place-note-label.is-active{fill:var(--accent);font-weight:700;}
#view-reading-place .reading-place-note[data-mode="ghost"] ellipse{fill:transparent;stroke:var(--muted);stroke-dasharray:4 4;opacity:.35;}
#view-reading-place .reading-place-note.is-active ellipse{stroke:var(--accent);stroke-width:2;fill:var(--accent);fill-opacity:.25;}
#view-reading-place .reading-place-note.is-preview ellipse{stroke:var(--accent);stroke-width:2;fill:var(--accent);fill-opacity:.35;}
#view-reading-place .reading-place-note.is-filled ellipse{fill:var(--ink);stroke:none;}
#view-reading-place .reading-place-note.is-correct ellipse{stroke:var(--accent);stroke-width:2;fill:var(--accent);fill-opacity:.6;}
#view-reading-place .reading-place-note.is-wrong ellipse{stroke:var(--bad-ink);stroke-width:2;fill:var(--bad-ink);fill-opacity:.6;}
#view-reading-place .reading-place-note.is-correct text,
#view-reading-place .reading-place-note.is-wrong text{fill:var(--ink);}
@media (max-width:720px){
  #view-reading-place .reading-place-summary-grid{grid-template-columns:1fr;}
  #view-reading-place .reading-place-summary-staff svg{min-width:860px;}
}
#view-detail .detail-scale-staff-panel{margin-top:24px;}
#view-detail .detail-scale-card{display:grid;gap:16px;}
#view-detail .detail-scale-actions{display:flex;justify-content:flex-end;}
#view-detail .detail-scale-actions .btn{min-width:160px;}
#view-detail .detail-scale-head{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;}
#view-detail .detail-scale-caption{display:flex;flex-direction:column;gap:4px;}
#view-detail .detail-scale-variant-label{font-weight:700;font-size:16px;color:var(--ink);}
#view-detail .detail-scale-variant-notes{color:var(--muted);font-size:14px;}
#view-detail .detail-scale-variant-chips{display:flex;flex-wrap:wrap;gap:8px;}
#view-detail .detail-scale-variant-chips .chip{min-width:44px;justify-content:center;}
#view-detail .detail-scale-staff-wrapper{border:1px solid var(--border-subtle,rgba(15,23,42,.08));border-radius:12px;background:var(--surface-subtle,rgba(15,23,42,.05));padding:8px;overflow:auto;}
#view-detail .detail-scale-staff{display:flex;justify-content:center;overflow:auto;}
#view-detail .detail-scale-staff svg{min-width:420px;display:block;}
#view-detail .detail-scale-clef{color:var(--ink);fill:currentColor;stroke:currentColor;}
#view-detail .detail-scale-note-label{font-size:14px;font-weight:600;fill:var(--muted);}
@media (max-width:720px){
  #view-detail .detail-scale-staff svg{min-width:320px;}
}
@media (max-width:640px){
  #view-reading-theory-staff .reading-staff-card{gap:16px;}
  #view-reading-theory-staff .reading-staff-hero .lead{font-size:16px;}
  #view-reading-theory-staff .clef-button{flex:1 1 calc(50% - 12px);justify-content:flex-start;}
}
</style>
<script>
(function(){
  const App = window.App = window.App || {};
  const helmholtzLabel = App.utils && App.utils.helmholtzLabel ? App.utils.helmholtzLabel : (note=>{
    const rawLetter = App.utils && typeof App.utils.noteName === 'function' ? App.utils.noteName(note.letter) : note.letter;
    const accidental = note.accidental === '#' ? '♯' : (note.accidental === 'b' ? '♭' : '');
    const octave = note.octave;
    let body = rawLetter;
    if(octave <= 2){ body = rawLetter.toUpperCase(); }
    else { body = rawLetter.toLowerCase(); }
    let suffix = '';
    if(octave === 0) suffix = ',,';
    else if(octave === 1) suffix = ',';
    else if(octave >= 4) suffix = String(octave - 3);
    return `${body}${accidental}${suffix}`;
  });
  const SVG_NS = 'http://www.w3.org/2000/svg';
  const SLOT_DEFS = [
    { key:'line-5', type:'line', labelKey:'reading_staff_slot_line_5', height:18 },
    { key:'space-4', type:'space', labelKey:'reading_staff_slot_space_4', height:32 },
    { key:'line-4', type:'line', labelKey:'reading_staff_slot_line_4', height:18 },
    { key:'space-3', type:'space', labelKey:'reading_staff_slot_space_3', height:32 },
    { key:'line-3', type:'line', labelKey:'reading_staff_slot_line_3', height:18 },
    { key:'space-2', type:'space', labelKey:'reading_staff_slot_space_2', height:32 },
    { key:'line-2', type:'line', labelKey:'reading_staff_slot_line_2', height:18 },
    { key:'space-1', type:'space', labelKey:'reading_staff_slot_space_1', height:32 },
    { key:'line-1', type:'line', labelKey:'reading_staff_slot_line_1', height:18 }
  ];
  const VIEW_WIDTH = 600;
  const EDGE_PAD = 16;
  const LEFT_BOUND = -EDGE_PAD;
  const RIGHT_BOUND = VIEW_WIDTH + EDGE_PAD;

  const CLEF_DEFS = {
    treble:{ key:'treble', labelKey:'reading_staff_clef_treble', descKey:'reading_staff_desc_treble', icon:'basic-clef-treble', iconScale:0.9, iconX:-80, iconY:15, noteStep:-2 },
    bass:{ key:'bass', labelKey:'reading_staff_clef_bass', descKey:'reading_staff_desc_bass', icon:'basic-clef-bass', iconScale:0.61, iconX:5, iconY:55, noteStep:10 },
    alto:{ key:'alto', labelKey:'reading_staff_clef_alto', descKey:'reading_staff_desc_alto', icon:'basic-clef-alto', iconScale:0.62, iconX:10, iconY:52, noteStep:4 },
    tenor:{ key:'tenor', labelKey:'reading_staff_clef_tenor', descKey:'reading_staff_desc_tenor', icon:'basic-clef-tenor',  iconScale:0.62, iconX:10, iconY:13, noteStep:6}
  };
  const slotMap = new Map();
  const zoneMap = new Map();
  let staffButtons = [];
  let staffStage = null;
  let staffSlotsHost = null;
  let staffLabel = null;
  let activeSlot = '';
  let clefButtons = [];
  let clefButtonsWrap = null;
  let clefNameEl = null;
  let clefDescEl = null;
  let clefDiagram = null;
  let comparisonDiagrams = [];
  let currentClef = 'treble';
  let initialized = false;

  function ready(fn){
    if(document.readyState !== 'loading'){ fn(); }
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  function buildStaff(){
    staffStage = document.getElementById('reading-staff-stage');
    staffSlotsHost = document.getElementById('reading-staff-slots');
    staffLabel = document.getElementById('reading-staff-label');
    if(!staffStage || !staffSlotsHost || staffStage.querySelector('svg')) return;

    const totalHeight = SLOT_DEFS.reduce((sum, def)=> sum + def.height, 0);
    staffStage.style.aspectRatio = `${VIEW_WIDTH} / ${totalHeight}`;

    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', `${LEFT_BOUND} 0 ${VIEW_WIDTH + EDGE_PAD * 2} ${totalHeight}`);
    svg.setAttribute('class', 'staff-svg');
    svg.setAttribute('role', 'img');
    svg.setAttribute('aria-labelledby', 'reading-staff-label');
    staffStage.insertBefore(svg, staffSlotsHost);

    let cursor = 0;
    SLOT_DEFS.forEach(def=>{
      slotMap.set(def.key, def);
      const zone = document.createElementNS(SVG_NS, 'rect');
      zone.setAttribute('x', LEFT_BOUND);
      zone.setAttribute('y', cursor);
      zone.setAttribute('width', VIEW_WIDTH + EDGE_PAD * 2);
      zone.setAttribute('height', def.height);
      zone.setAttribute('class', `staff-zone staff-zone--${def.type}`);
      zone.dataset.slot = def.key;
      svg.appendChild(zone);

      let lineEl = null;
      if(def.type === 'line'){
        const line = document.createElementNS(SVG_NS, 'line');
        const y = cursor + def.height / 2;
        line.setAttribute('x1', LEFT_BOUND);
        line.setAttribute('x2', RIGHT_BOUND);
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        line.setAttribute('class', 'staff-line');
        line.dataset.slot = def.key;
        svg.appendChild(line);
        lineEl = line;
      }
      zoneMap.set(def.key, { zone, line: lineEl });
      cursor += def.height;
    });

    const rows = SLOT_DEFS.map(def=> (def.height / totalHeight * 100).toFixed(3) + '%').join(' ');
    staffSlotsHost.style.gridTemplateRows = rows;
    staffSlotsHost.innerHTML = '';
    SLOT_DEFS.forEach(def=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'staff-slot-btn';
      btn.dataset.slot = def.key;
      btn.dataset.labelKey = def.labelKey;
      btn.dataset.kind = def.type;
      btn.setAttribute('aria-label', I18N.t(def.labelKey));
      btn.setAttribute('aria-pressed', 'false');
      staffSlotsHost.appendChild(btn);
    });
    staffButtons = Array.from(staffSlotsHost.querySelectorAll('.staff-slot-btn'));
    bindSlotEvents();
    updateStaffLabel();
  }

  function bindSlotEvents(){
    const clearIfNoFocus = ()=>{
      const activeEl = document.activeElement;
      if(!staffSlotsHost || !staffSlotsHost.contains(activeEl)){
        setActiveSlot('');
      }
    };
    staffButtons.forEach(btn=>{
      btn.addEventListener('pointermove', handleSlotEnter);
      btn.addEventListener('pointerenter', handleSlotEnter);
      btn.addEventListener('pointerdown', handleSlotEnter);
      btn.addEventListener('focus', handleSlotEnter);
      btn.addEventListener('mouseleave', clearIfNoFocus);
      btn.addEventListener('blur', clearIfNoFocus);
      btn.addEventListener('click', handleSlotEnter);
    });
    if(staffStage){
      staffStage.addEventListener('mouseleave', clearIfNoFocus);
    }
  }

  function handleSlotEnter(evt){
    const key = evt.currentTarget.dataset.slot;
    if(key) setActiveSlot(key);
  }

  function setActiveSlot(key){
    if(activeSlot === key) return;
    if(activeSlot && zoneMap.has(activeSlot)){
      const prev = zoneMap.get(activeSlot);
      if(prev.zone) prev.zone.classList.remove('is-active');
      if(prev.line) prev.line.classList.remove('is-active');
    }
    staffButtons.forEach(btn=>{
      const isActive = btn.dataset.slot === key;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    activeSlot = slotMap.has(key) ? key : '';
    if(activeSlot && zoneMap.has(activeSlot)){
      const next = zoneMap.get(activeSlot);
      if(next.zone) next.zone.classList.add('is-active');
      if(next.line) next.line.classList.add('is-active');
    }
    updateStaffLabel();
  }

  function updateStaffLabel(){
    if(!staffLabel) return;
    if(activeSlot && slotMap.has(activeSlot)){
      staffLabel.textContent = I18N.t(slotMap.get(activeSlot).labelKey);
    } else {
      staffLabel.textContent = I18N.t('reading_staff_hover_hint');
    }
  }

  function createClefDiagram(host){
    if(!host) return null;
    const width = 320;
    const topMargin = 36;
    const lineGap = 24;
    const sidePadding = 40;
    const totalHeight = topMargin + lineGap * 4 + topMargin;
    host.style.aspectRatio = `${width} / ${totalHeight}`;
    host.innerHTML = '';
    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', `0 0 ${width} ${totalHeight}`);
    svg.setAttribute('aria-hidden', 'true');
    host.appendChild(svg);

    for(let i=0;i<5;i++){
      const y = topMargin + i * lineGap;
      const line = document.createElementNS(SVG_NS, 'line');
      line.setAttribute('x1', sidePadding);
      line.setAttribute('x2', width - sidePadding);
      line.setAttribute('y1', y);
      line.setAttribute('y2', y);
      line.setAttribute('class', 'clef-staff-line');
      svg.appendChild(line);
    }

    const ledgerGroup = document.createElementNS(SVG_NS, 'g');
    ledgerGroup.setAttribute('class', 'clef-ledgers');
    svg.appendChild(ledgerGroup);

    const clefGroup = document.createElementNS(SVG_NS, 'g');
    clefGroup.setAttribute('class', 'clef-glyph');
    const clefUse = document.createElementNS(SVG_NS, 'use');
    clefGroup.appendChild(clefUse);
    svg.appendChild(clefGroup);

    const noteHead = document.createElementNS(SVG_NS, 'ellipse');
    const noteGroup = document.createElementNS(SVG_NS, 'g');
    noteHead.setAttribute('class', 'clef-note-head');
    noteHead.setAttribute('rx', '12');
    noteHead.setAttribute('ry', '9');
    noteGroup.appendChild(noteHead);
    svg.appendChild(noteGroup);

    const bottomLineY = topMargin + lineGap * 4;
    const stepHeight = lineGap / 2;
    const noteX = width * 0.64;

    function stepToY(step){
      return bottomLineY - step * stepHeight;
    }

    function drawLedgers(step){
      ledgerGroup.innerHTML = '';
      if(step > 8){
        for(let s = 10; s <= step; s += 2){
          const y = stepToY(s);
          ledgerGroup.appendChild(makeLedger(y));
        }
      } else if(step < 0){
        for(let s = -2; s >= step; s -= 2){
          const y = stepToY(s);
          ledgerGroup.appendChild(makeLedger(y));
        }
      }
    }

    function makeLedger(y){
      const line = document.createElementNS(SVG_NS, 'line');
      line.setAttribute('x1', noteX - 30);
      line.setAttribute('x2', noteX + 30);
      line.setAttribute('y1', y);
      line.setAttribute('y2', y);
      line.setAttribute('class', 'clef-ledger');
      return line;
    }

    function setClef(key){
      const def = CLEF_DEFS[key];
      if(!def) return;
      clefUse.setAttribute('href', `#${def.icon}`);
      clefGroup.setAttribute('transform', `scale(${def.iconScale}) translate(${def.iconX/def.iconScale}, ${def.iconY}) `);
      const y = stepToY(def.noteStep);
      noteHead.setAttribute('cx', noteX);
      noteHead.setAttribute('cy', y);
      noteHead.setAttribute('transform', `rotate(-18 ${noteX} ${y})`);
      drawLedgers(def.noteStep);
    }

    return { setClef };
  }

  function buildClefs(){
    clefButtons = Array.from(document.querySelectorAll('[data-role="clef-button"]'));
    clefButtonsWrap = document.getElementById('reading-staff-clef-buttons');
    clefNameEl = document.getElementById('reading-staff-clef-name');
    clefDescEl = document.getElementById('reading-staff-clef-desc');
    clefDiagram = createClefDiagram(document.getElementById('reading-staff-clef-preview'));
    clefButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> selectClef(btn.dataset.clef));
      btn.addEventListener('keydown', onClefKeydown);
    });
  }

  function onClefKeydown(evt){
    if(evt.key !== 'ArrowRight' && evt.key !== 'ArrowLeft') return;
    if(!clefButtons.length) return;
    evt.preventDefault();
    const index = clefButtons.indexOf(evt.currentTarget);
    if(index === -1) return;
    const dir = evt.key === 'ArrowRight' ? 1 : -1;
    const next = clefButtons[(index + dir + clefButtons.length) % clefButtons.length];
    if(next){
      next.focus();
      selectClef(next.dataset.clef);
    }
  }

  function selectClef(key){
    if(!CLEF_DEFS[key]) return;
    currentClef = key;
    clefButtons.forEach(btn=>{
      const isActive = btn.dataset.clef === key;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      const defBtn = CLEF_DEFS[btn.dataset.clef];
      if(defBtn){
        btn.setAttribute('aria-label', I18N.t(defBtn.labelKey));
      }
    });
    if(clefButtonsWrap){
      clefButtonsWrap.setAttribute('aria-label', I18N.t('reading_staff_section_clefs'));
    }
    const def = CLEF_DEFS[key];
    if(clefNameEl) clefNameEl.textContent = I18N.t(def.labelKey);
    if(clefDescEl) clefDescEl.textContent = I18N.t(def.descKey);
    if(clefDiagram && typeof clefDiagram.setClef === 'function'){
      clefDiagram.setClef(key);
    }
  }

  function buildComparison(){
    comparisonDiagrams = [];
    const trebleHost = document.getElementById('reading-staff-compare-treble');
    if(trebleHost){
      const diag = createClefDiagram(trebleHost);
      if(diag) diag.setClef('treble');
      comparisonDiagrams.push({ key:'treble', diagram: diag });
    }
    const bassHost = document.getElementById('reading-staff-compare-bass');
    if(bassHost){
      const diag = createClefDiagram(bassHost);
      if(diag) diag.setClef('bass');
      comparisonDiagrams.push({ key:'bass', diagram: diag });
    }
  }

  function applyLang(){
    staffButtons.forEach(btn=>{
      const key = btn.dataset.labelKey;
      if(key) btn.setAttribute('aria-label', I18N.t(key));
    });
    updateStaffLabel();
    if(clefButtonsWrap){
      clefButtonsWrap.setAttribute('aria-label', I18N.t('reading_staff_section_clefs'));
    }
    selectClef(currentClef);
  }

  function refresh(){
    applyLang();
    comparisonDiagrams.forEach(entry=>{
      if(entry.diagram && typeof entry.diagram.setClef === 'function'){
        entry.diagram.setClef(entry.key);
      }
    });
  }

  function init(){
    if(initialized) return;
    initialized = true;
    buildStaff();
    buildClefs();
    buildComparison();
    applyLang();
    selectClef(currentClef);
  }

  ready(init);
  App.readingTheoryStaff = {
    refresh
  };
})();
</script>
<!-- ===== MODULE: Reading — Notes map (octaves) — start ===== -->
<section class="hidden" id="view-reading-notes-map">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-notes-map" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="reading_theory_notes_title"></h2>
<p class="sub" data-i18n="reading_theory_notes_desc"></p>
<div class="stack stack-lg notes-map-wrap">
  <article class="list-card notes-map-intro">
    <h3 class="h3" data-i18n="reading_notes_intro_heading"></h3>
    <div class="stack stack-md">
      <p data-i18n="reading_notes_intro_p1" data-i18n-html="1"></p>
      <p data-i18n="reading_notes_intro_p2" data-i18n-html="1"></p>
      <p data-i18n="reading_notes_intro_p3" data-i18n-html="1"></p>
      <p data-i18n="reading_notes_intro_p4" data-i18n-html="1"></p>
    </div>
  </article>
  <div class="stack stack-lg notes-map" id="notes-map-list"></div>
</div>
</section>
<style>
#view-reading-notes-map .notes-map-wrap{ width:100%; }
#view-reading-notes-map .notes-map{ width:100%; }
#view-reading-notes-map .notes-map-card{ padding:16px 18px 22px; display:flex; flex-direction:column; gap:12px; }
#view-reading-notes-map .notes-map-title{ margin:0; font-size:17px; font-weight:700; color:var(--ink); }
#view-reading-notes-map .notes-map-figure{ width:100%; }
#view-reading-notes-map .notes-map-staff{ width:100%; height:auto; display:block; }
#view-reading-notes-map .notes-map-staff .note-label{
  font-weight:600;
  font-size:14px;
  fill: currentColor;
  text-anchor: middle;
  dominant-baseline: hanging;
}
#view-reading-notes-map .notes-map-staff .note-label.is-overlap{ opacity:.35; }
#view-reading-notes-map .notes-map-staff .note-label.is-active{ fill:var(--accent); }
@media (max-width:980px){
  #view-reading-notes-map .notes-map-staff .note-label{ font-size:20px; }
}
#view-reading-notes-map .notes-map-actions{ display:flex; justify-content:flex-end; }
#view-reading-notes-map .notes-map-play{ min-width:160px; }
@media (max-width: 980px) {
  #view-reading-notes-map .notes-map-staff .note-label {
    font-size: 20px; /* nebo klidně 20px podle pocitu */
  }
}
#view-reading-notes-map .notes-map-staff .staff-line,
#view-reading-notes-map .notes-map-staff .ledger-line{ stroke:var(--ink); stroke-opacity:1; stroke-width:2; stroke-linecap:round; }
#view-reading-notes-map .notes-map-staff .ledger-line.is-overlap{ stroke-opacity:.25; }
#view-reading-notes-map .notes-map-staff .note-head{ fill:var(--ink); }
#view-reading-notes-map .notes-map-staff .note-head.is-overlap{ opacity:.35; }
#view-reading-notes-map .notes-map-staff .clef{ color:var(--ink); stroke:currentColor; stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round; fill:none; }
#view-reading-notes-map .notes-map-staff .clef-treble{ stroke-width:0.7; fill:currentColor;  }
#view-reading-notes-map .notes-map-staff .clef-bass{ stroke-width:0.1; fill:currentColor; }
#view-reading-notes-map .notes-map-staff .clef-dot{ fill:var(--ink); }
</style>
<script>
(function(){
  const SVG_NS = 'http://www.w3.org/2000/svg';
  const NOTE_ORDER = ['C','D','E','F','G','A','B'];
  const NOTE_INDEX = NOTE_ORDER.reduce((acc, note, idx)=>{ acc[note] = idx; return acc; }, {});
  const NOTE_SEMITONES = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
  const CLEF_BASE = { treble: parseNote('E4'), bass: parseNote('G2') };
  const LINE_GAP = 14;
  const STAFF_HEIGHT = LINE_GAP * 4;
  const EXTRA_SPACE = LINE_GAP * 6;
  const isNarrow = window.innerWidth < 980;
  const PADDING_X = isNarrow ? 5 : 32;
  const PADDING_Y = isNarrow ? 14 : 16;
  const CLEF_WIDTH = 68;
  const NOTE_GAP = 46;
  const LEDGER_HALF = 18;

  const OCTAVES = [
    { id: 'contra', labelKey: 'oct_contra', clef: 'bass', range: { from: 'B0', to: 'D2' } },
    { id: 'great', labelKey: 'oct_great', clef: 'bass', range: { from: 'B1', to: 'D3' } },
    { id: 'small', labelKey: 'oct_small', clef: 'bass', range: { from: 'B2', to: 'D4' } },
    { id: 'oneLine', labelKey: 'oct_one', clef: 'treble', range: { from: 'B3', to: 'D5' } },
    { id: 'twoLine', labelKey: 'oct_two', clef: 'treble', range: { from: 'B4', to: 'D6' } },
    { id: 'threeLine', labelKey: 'oct_three', clef: 'treble', range: { from: 'B5', to: 'D7' } }
  ];

  window.App = window.App || {};
  const cardsState = new Map();
  let currentOctavePlayback = null;
  function get(id){ return document.getElementById(id); }

  function parseNote(str){
    const match = /^([A-Ga-gHh])([0-9])$/.exec(String(str).trim());
    if(!match) throw new Error('Invalid note: '+str);
    let letter = match[1].toUpperCase();
    if(letter === 'H') letter = 'B';
    const octave = parseInt(match[2], 10);
    return { letter, octave };
  }

  function noteStep(note){
    return note.octave * NOTE_ORDER.length + NOTE_INDEX[note.letter];
  }

  function noteFrequency(note){
    const semitoneBase = NOTE_SEMITONES[note.letter] ?? 0;
    const accidental =
      note.accidental === '#'
        ? 1
        : (note.accidental === 'b' || note.accidental === '♭') ? -1 : 0;
    const semitone = semitoneBase + accidental;
    const midi = (note.octave + 1) * 12 + semitone;
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function nextNote(note){
    const idx = NOTE_INDEX[note.letter];
    const rollover = idx === NOTE_ORDER.length - 1;
    const letter = NOTE_ORDER[(idx + 1) % NOTE_ORDER.length];
    const octave = rollover ? note.octave + 1 : note.octave;
    return { letter, octave };
  }

  function buildRange(from, to){
    const start = parseNote(from);
    const end = parseNote(to);
    const out = [];
    let cursor = { letter: start.letter, octave: start.octave };
    const target = noteStep(end);
    while(noteStep(cursor) <= target){
      out.push({ letter: cursor.letter, octave: cursor.octave });
      cursor = nextNote(cursor);
    }
    return out;
  }

  function diffFor(note, clef){
    const base = CLEF_BASE[clef];
    return noteStep(note) - noteStep(base);
  }

  function ledgerPositions(diff){
    const positions = [];
    if(diff < 0){
      for(let d = 0; d >= diff; d -= 2){
        if(d !== 0) positions.push(d);
      }
    } else if(diff > 8){
      for(let d = 8; d <= diff; d += 2){
        if(d !== 8) positions.push(d);
      }
    }
    return positions;
  }

function helmholtzLabel(note){
  const rawLetter = App.utils && typeof App.utils.noteName === 'function' ? App.utils.noteName(note.letter) : note.letter;
  const accidental = note.accidental === '#' ? '♯' : (note.accidental === 'b' ? '♭' : '');
  const octave = note.octave;
  let body = rawLetter;
  if(octave <= 2){
    body = rawLetter.toUpperCase();
  } else {
    body = rawLetter.toLowerCase();
  }
  let suffix = '';
  if(octave === 0) suffix = ',,';
  else if(octave === 1) suffix = ',';
  else if(octave >= 4) suffix = String(octave - 3);
  return `${body}${accidental}${suffix}`;
}

function formatNoteLabel(note){
    return helmholtzLabel(note);
  }

  function staffY(bottomLineY, diff){
    return bottomLineY - diff * (LINE_GAP / 2);
  }

  function svgEl(name, attrs){
    const node = document.createElementNS(SVG_NS, name);
    Object.entries(attrs||{}).forEach(([key, value])=>{
      node.setAttribute(key, String(value));
    });
    return node;
  }

  function drawTrebleClef(svg, originX, bottomLineY){
    const scale = 2.2;
    const tx = originX ;
    const ty = bottomLineY - LINE_GAP * 5;
    const pathData = 'M12.049 3.5296c0.305 3.1263-2.019 5.6563-4.0772 7.7014-0.9349 0.897-0.155 0.148-0.6437 0.594-0.1022-0.479-0.2986-1.731-0.2802-2.11 0.1304-2.6939 2.3198-6.5875 4.2381-8.0236 0.309 0.5767 0.563 0.6231 0.763 1.8382zm0.651 16.142c-1.232-0.906-2.85-1.144-4.3336-0.885-0.1913-1.255-0.3827-2.51-0.574-3.764 2.3506-2.329 4.9066-5.0322 5.0406-8.5394 0.059-2.232-0.276-4.6714-1.678-6.4836-1.7004 0.12823-2.8995 2.156-3.8019 3.4165-1.4889 2.6705-1.1414 5.9169-0.57 8.7965-0.8094 0.952-1.9296 1.743-2.7274 2.734-2.3561 2.308-4.4085 5.43-4.0046 8.878 0.18332 3.334 2.5894 6.434 5.8702 7.227 1.2457 0.315 2.5639 0.346 3.8241 0.099 0.2199 2.25 1.0266 4.629 0.0925 6.813-0.7007 1.598-2.7875 3.004-4.3325 2.192-0.5994-0.316-0.1137-0.051-0.478-0.252 1.0698-0.257 1.9996-1.036 2.26-1.565 0.8378-1.464-0.3998-3.639-2.1554-3.358-2.262 0.046-3.1904 3.14-1.7356 4.685 1.3468 1.52 3.833 1.312 5.4301 0.318 1.8125-1.18 2.0395-3.544 1.8325-5.562-0.07-0.678-0.403-2.67-0.444-3.387 0.697-0.249 0.209-0.059 1.193-0.449 2.66-1.053 4.357-4.259 3.594-7.122-0.318-1.469-1.044-2.914-2.302-3.792zm0.561 5.757c0.214 1.991-1.053 4.321-3.079 4.96-0.136-0.795-0.172-1.011-0.2626-1.475-0.4822-2.46-0.744-4.987-1.116-7.481 1.6246-0.168 3.4576 0.543 4.0226 2.184 0.244 0.577 0.343 1.197 0.435 1.812zm-5.1486 5.196c-2.5441 0.141-4.9995-1.595-5.6343-4.081-0.749-2.153-0.5283-4.63 0.8207-6.504 1.1151-1.702 2.6065-3.105 4.0286-4.543 0.183 1.127 0.366 2.254 0.549 3.382-2.9906 0.782-5.0046 4.725-3.215 7.451 0.5324 0.764 1.9765 2.223 2.7655 1.634-1.102-0.683-2.0033-1.859-1.8095-3.227-0.0821-1.282 1.3699-2.911 2.6513-3.198 0.4384 2.869 0.9413 6.073 1.3797 8.943-0.5054 0.1-1.0211 0.143-1.536 0.143z';
    svg.appendChild(svgEl('path', {
      d: pathData,
      transform: `matrix(${scale},0,0,${scale},${tx},${ty})`,
      class: 'clef clef-treble'
    }));
  }

  function drawBassClef(svg, originX, bottomLineY){
    const scale = 1.2;
    const tx = originX + 30 - scale * 94.573707;
    const ty = bottomLineY - LINE_GAP * 1.7 - scale * 360;
    const pathData = 'M 94.573707,338.62098 C 85.788865,338.82892 79.05876,344.98307 81.239785,354.40822 C 81.242355,354.41932 81.253126,354.42897 81.255716,354.44008 C 81.511763,357.69062 84.216419,360.25476 87.532378,360.25476 C 91.017261,360.25476 93.8409,357.43111 93.8409,353.94623 C 93.8409,350.87486 91.650198,348.31384 88.743104,347.74923 C 87.584624,347.33934 85.847143,346.40732 85.923385,344.91358 C 85.95853,344.17015 86.826419,342.8217 88.217394,342.14165 C 89.907945,341.3483 91.651172,340.91899 93.410772,341.2814 C 96.0781,341.76834 102.8994,346.66633 103.43113,355.15696 C 103.73634,361.60349 100.11523,370.30719 96.580965,374.433 C 90.883353,380.93635 81.730382,384.97598 82.625749,385.69594 C 83.42938,386.41591 94.235755,381.47668 99.862669,375.27732 C 106.72952,367.84162 110.12894,361.64359 109.80337,354.10554 C 109.60755,346.56749 103.77166,338.40634 94.573707,338.62098 z';
    svg.appendChild(svgEl('path', {
      d: pathData,
      transform: `matrix(${scale},0,0,${scale},${tx},${ty})`,
      class: 'clef clef-bass'
    }));
    const dot1 = svgEl('circle', { cx: originX + 55, cy: bottomLineY - LINE_GAP * 2, r: 3.2, class: 'clef-dot' });
    const dot2 = svgEl('circle', { cx: originX + 55, cy: bottomLineY - LINE_GAP * 3, r: 3.2, class: 'clef-dot' });
    svg.appendChild(dot1);
    svg.appendChild(dot2);
  }

  function renderStaff({ clef, notes, overlapFlags }){
  
    // 1) Předvýpočet „diffů“ (vertikální pozice) pro všechny noty
    const diffs = notes.map(n => diffFor(n, clef));

    const BASE_EXTRA_TOP = 0;         // dočasně 0
    const BASE_EXTRA_BOTTOM = 0;      // dočasně 0
    const bottomLineY_base = PADDING_Y + BASE_EXTRA_TOP + STAFF_HEIGHT;

    // pomocná funkce na Y (už jí máš): staffY(bottomLineY, diff)
    const ys = diffs.map(d => staffY(bottomLineY_base, d));

    let yMin = Math.min(...ys);
    let yMax = Math.max(...ys);

    for (const d of diffs){
      const ledgers = ledgerPositions(d); // už existuje
      for (const lp of ledgers){
        const ly = staffY(bottomLineY_base, lp);
        yMin = Math.min(yMin, ly);
        yMax = Math.max(yMax, ly);
      }
    }

    // přidej „poloměr notové hlavičky“ a drobný buffer
    const NOTE_RY = 5.2;        // jak používáš u <ellipse>
    const BUFFER  = 6;
    yMin -= (NOTE_RY + BUFFER);
    yMax += (NOTE_RY + BUFFER);

    const staffTop_base    = bottomLineY_base - 4*LINE_GAP;
    const staffBottom_base = bottomLineY_base;

    // kolik potřebujeme navíc nad/pod
    const extraTopNeeded    = Math.max(0, staffTop_base - yMin);
    const extraBottomNeeded = Math.max(0, yMax - staffBottom_base);

    const EXTRA_TOP    = Math.ceil(extraTopNeeded);
    const EXTRA_BOTTOM = Math.ceil(extraBottomNeeded);

    // finální spodní linka se posune dolů o EXTRA_TOP
    const bottomLineY = PADDING_Y + EXTRA_TOP + STAFF_HEIGHT;

    // počítej i s popisky pod osnovou
    const LABEL_GAP = 6;              // mezera pod osnovou
    const LABEL_H   = 18;             // odhadovaná výška textu
   
    function getContentBottomY(bottomLineY){
      let bottom = bottomLineY; // začni spodní linkou
      notes.forEach((note, idx) => {
        const d  = diffs[idx];
        // pozice středu hlavičky
        const cy = staffY(bottomLineY, d);
        if (cy + NOTE_RY > bottom) bottom = cy + NOTE_RY;

        // všechny ledger čáry pro danou notu
        ledgerPositions(d).forEach(lp => {
          const y = staffY(bottomLineY, lp);
          if (y > bottom) bottom = y;
        });
      });
      return bottom;
    }
    const contentBottomY = getContentBottomY(bottomLineY);

    const labelY = Math.ceil(contentBottomY) + LABEL_GAP;

    const totalWidth  = PADDING_X * 2 + CLEF_WIDTH + (notes.length - 0.5) * NOTE_GAP;
    const totalHeight = labelY + LABEL_H + PADDING_Y;

    const svg = svgEl('svg', {
      viewBox: `0 0 ${totalWidth} ${totalHeight}`,
      preserveAspectRatio: 'xMidYMid meet',
      class: 'notes-map-staff',
      width: '100%'
    });

    // 5 linek
    for(let i=0;i<5;i++){
      const y = bottomLineY - i*LINE_GAP;
      svg.appendChild(svgEl('line', { x1:PADDING_X, y1:y, x2:totalWidth - PADDING_X, y2:y, class:'staff-line' }));
    }

    // klíč
    const clefX = PADDING_X + 6;
    if(clef==='treble') drawTrebleClef(svg, clefX - 10, bottomLineY);
    else                drawBassClef(svg,   clefX - 18, bottomLineY - LINE_GAP*0.5);

    // noty + ledger + popisky
    const startX = PADDING_X + CLEF_WIDTH;
    notes.forEach((note, idx)=>{
      const d  = diffs[idx];
      const cx = startX + idx * NOTE_GAP;
      const cy = staffY(bottomLineY, d);
      const isOverlap = Array.isArray(overlapFlags) && overlapFlags[idx] === true;

      ledgerPositions(d).forEach(pos=>{
        const y = staffY(bottomLineY, pos);
        const ledger = svgEl('line', { x1: cx - LEDGER_HALF, y1: y, x2: cx + LEDGER_HALF, y2: y, class:'ledger-line' });
        if(isOverlap) ledger.classList.add('is-overlap');
        svg.appendChild(ledger);
      });

      const head = svgEl('ellipse', { cx, cy, rx:7.5, ry:5.2, class:'note-head' });
      if(isOverlap) head.classList.add('is-overlap');
      svg.appendChild(head);

      const t = svgEl('text', { x: cx, y: labelY, class:'note-label' });
      if(isOverlap) t.classList.add('is-overlap');
      const n = notes[idx];
      t.textContent = formatNoteLabel(n);
      t.style.left = '${x}px';
      //t.setAttribute('data-i18n', 'note_letter_' + note.letter);
      svg.appendChild(t);
    });

    

    return { svg, width: totalWidth };
  }

  function createCard(octave){
    const notes = buildRange(octave.range.from, octave.range.to);
    const card = document.createElement('article');
    card.className = 'list-card notes-map-card';
    card.setAttribute('data-octave', octave.id);

    const title = document.createElement('h3');
    title.className = 'notes-map-title';
    title.setAttribute('data-i18n', octave.labelKey);
    card.appendChild(title);

    const figure = document.createElement('div');
    figure.className = 'notes-map-figure';
    card.appendChild(figure);

    const rangeStart = parseNote(octave.range.from);
    const coreOctave = rangeStart.octave + 1;
    const coreStart = noteStep({ letter:'C', octave: coreOctave });
    const coreEnd = noteStep({ letter:'B', octave: coreOctave });
    const overlapFlags = notes.map(note=>{
      const step = noteStep(note);
      return step < coreStart || step > coreEnd;
    });
    const { svg } = renderStaff({ clef: octave.clef, notes, overlapFlags });
    const fromLabel = formatNoteLabel(notes[0]);
    const toLabel = formatNoteLabel(notes[notes.length - 1]);
    svg.setAttribute('role', 'img');
    svg.setAttribute('aria-label', I18N.t(octave.labelKey) + I18N.t('oct_range_from') + fromLabel + I18N.t('oct_range_to') + toLabel);
    figure.appendChild(svg);

    const actions = document.createElement('div');
    actions.className = 'notes-map-actions';
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-green notes-map-play';
    button.setAttribute('data-octave-play', octave.id);
    button.setAttribute('data-i18n', 'reading_notes_map_play');
    button.addEventListener('click', ()=>playOctave(octave.id));
    actions.appendChild(button);
    card.appendChild(actions);

    const labels = Array.from(svg.querySelectorAll('.note-label'));
    cardsState.set(octave.id, { notes, labels, button });

    return card;
  }

  function render(){
    const host = get('notes-map-list');
    if(!host) return;
    stopOctavePlayback();
    cardsState.clear();
    host.innerHTML = '';
    OCTAVES.forEach(oct=> host.appendChild(createCard(oct)));
    I18N.apply(host);
  }

  document.addEventListener('DOMContentLoaded', render);

  function getAudio(){
    return window.App && App.audio;
  }

  function playOctave(id){
    const data = cardsState.get(id);
    if(!data) return;
    stopOctavePlayback();
    const audio = getAudio();
    if(!audio || typeof audio.playPattern !== 'function'){
      highlightOctaveNotes(data, null);
      return;
    }
    const pattern = data.notes.map(()=>0.5);
    const freqs = data.notes.map(noteFrequency);
    data.button.disabled = true;
    currentOctavePlayback = { data };
    audio.playPattern(pattern, {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:index=>highlightOctaveNotes(data, index),
      onFinish:()=>finishOctavePlayback(data)
    });
  }

  function highlightOctaveNotes(data, index){
    if(!data || !Array.isArray(data.labels)) return;
    data.labels.forEach((label, idx)=>{
      if(!label) return;
      label.classList.toggle('is-active', typeof index === 'number' && idx === index);
      if(typeof index !== 'number') label.classList.remove('is-active');
    });
  }

  function finishOctavePlayback(data){
    if(!data) return;
    highlightOctaveNotes(data, null);
    if(data.button) data.button.disabled = false;
    if(currentOctavePlayback && currentOctavePlayback.data === data){
      currentOctavePlayback = null;
    }
  }

  function stopOctavePlayback(){
    if(!currentOctavePlayback) return;
    const audio = getAudio();
    if(audio && typeof audio.stop === 'function'){
      audio.stop();
    }
    finishOctavePlayback(currentOctavePlayback.data);
  }

  App.readingNotesMap = {
    render, OCTAVES,
    refresh(){ render(); }
  };
})();
</script>
<!-- ===== MODULE: Reading — Notes map (octaves) — end ===== -->
<!-- ===== MODULE: Shared — Piano keyboard — start ===== -->
<script>
(function(){
  const App = window.App = window.App || {};
  if(App.keyboard) return;
  const DEFAULT_LAYOUT = [
    { id:'C4', type:'white', whiteIndex:0 },
    { id:'C#4', type:'black', before:0 },
    { id:'D4', type:'white', whiteIndex:1 },
    { id:'D#4', type:'black', before:1 },
    { id:'E4', type:'white', whiteIndex:2 },
    { id:'F4', type:'white', whiteIndex:3 },
    { id:'F#4', type:'black', before:3 },
    { id:'G4', type:'white', whiteIndex:4 },
    { id:'G#4', type:'black', before:4 },
    { id:'A4', type:'white', whiteIndex:5 },
    { id:'A#4', type:'black', before:5 },
    { id:'B4', type:'white', whiteIndex:6 },
    { id:'C5', type:'white', whiteIndex:7 }
  ];

  function create({ container, layout=DEFAULT_LAYOUT, labelFor, onSelect, active }={}){
    if(!container) return null;
    container.innerHTML = '';
    container.classList.add('piano-keyboard');
    const whiteWrap = document.createElement('div');
    whiteWrap.className = 'piano-keys-white';
    const blackWrap = document.createElement('div');
    blackWrap.className = 'piano-keys-black';
    container.appendChild(whiteWrap);
    container.appendChild(blackWrap);

    const whiteKeys = layout.filter(k=>k.type==='white');
    const whiteWidth = whiteKeys.length ? 100 / whiteKeys.length : 0;
    const state = { active: active || null, labelFor: typeof labelFor === 'function' ? labelFor : (id=>id), buttons:[] };

    layout.forEach(key=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `piano-key ${key.type} acc-key ${key.type}`;
      btn.dataset.note = key.id;
      const applyLabel = ()=>{ btn.textContent = state.labelFor(key.id) || key.id; };
      applyLabel();
      const handleClick = ()=>{
        setActive(key.id);
        if(typeof onSelect === 'function') onSelect(key.id, btn);
      };
      btn.addEventListener('click', handleClick);
      state.buttons.push({ btn, key, applyLabel });
      if(key.type === 'white'){
        btn.style.flex = '1 1 auto';
        whiteWrap.appendChild(btn);
      } else {
        const center = whiteWidth * (key.before + 1);
        btn.style.left = `${center}%`;
        btn.style.transform = 'translateX(-50%)';
        btn.style.width = `${whiteWidth * 0.42}%`;
        blackWrap.appendChild(btn);
      }
    });

    function setLabels(fn){
      if(typeof fn === 'function') state.labelFor = fn;
      state.buttons.forEach(entry=>entry.applyLabel());
    }

    function setActive(noteId){
      state.active = noteId;
      state.buttons.forEach(({ btn })=>{
        btn.classList.toggle('is-active', btn.dataset.note === state.active);
      });
    }

    if(state.active) setActive(state.active);

    function destroy(){
      if(container){
        container.innerHTML = '';
      }
      state.buttons = [];
    }

    return { setLabels, setActive, getActive:()=>state.active, destroy, layout };
  }

  App.keyboard = { create, DEFAULT_LAYOUT };
})();
</script>
<!-- ===== MODULE: Shared — Piano keyboard — end ===== -->
<!-- ===== MODULE: Reading — Accidentals — start ===== -->
<script>
(function(){
  const App = window.App = window.App || {};
  const audio = App.audio;
  const utils = App.utils || {};
  function getRenderer(){
    return (window.App && App.staffRenderer && typeof App.staffRenderer.render === 'function') ? App.staffRenderer : null;
  }
  const choiceChips = typeof utils.choiceChips === 'function' ? utils.choiceChips : null;
  const noteName = typeof utils.noteName === 'function' ? utils.noteName : (x=>String(x));
  const SPELL_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const SPELL_FLAT = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
  const HALFSTEP_DEMOS = [
    { id:'ef', labelKey:'reading_acc_pair_ef', notes:['E4','F4'] },
    { id:'fg', labelKey:'reading_acc_pair_fg', notes:['F4','G4'] },
    { id:'hc', labelKey:'reading_acc_pair_hc', notes:['B4','C5'] },
    { id:'cd', labelKey:'reading_acc_pair_cd', notes:['C5','D5'] }
  ];
  const SHARP_VARIANTS = [
    { id:'plain', labelKey:'reading_acc_sharp_plain', notes:['C4','D4'] },
    { id:'raised', labelKey:'reading_acc_sharp_raised', notes:['C4','C#4','D4'] }
  ];
  const FLAT_VARIANTS = [
    { id:'plain', labelKey:'reading_acc_flat_plain', notes:['G4','A4'], preferFlats:true },
    { id:'lowered', labelKey:'reading_acc_flat_lowered', notes:['G4','Ab4','A4'], preferFlats:true }
  ];
  const CHROMATIC_VARIANTS = {
    sharp:['C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4','C5'],
    flat:['C4','Db4','D4','Eb4','E4','F4','Gb4','G4','Ab4','A4','Bb4','B4','C5']
  };
  const MAJOR_PATTERN = [0,2,4,5,7,9,11,12];
  const SCALE_RANGE = { min:'C4', max:'C5' };
  const KEYBOARD_LAYOUT = [
    { id:'C4', type:'white', whiteIndex:0 },
    { id:'C#4', type:'black', before:0 },
    { id:'D4', type:'white', whiteIndex:1 },
    { id:'D#4', type:'black', before:1 },
    { id:'E4', type:'white', whiteIndex:2 },
    { id:'F4', type:'white', whiteIndex:3 },
    { id:'F#4', type:'black', before:3 },
    { id:'G4', type:'white', whiteIndex:4 },
    { id:'G#4', type:'black', before:4 },
    { id:'A4', type:'white', whiteIndex:5 },
    { id:'A#4', type:'black', before:5 },
    { id:'B4', type:'white', whiteIndex:6 },
    { id:'C5', type:'white', whiteIndex:7 }
  ];
  const SIGNATURE_NOTES = ['G4','A4','F4','E4','G4','A4','F4','E4'];
  const SIGNATURE_MARKS = ['F#4'];
  const ACCIDENTAL_NOTES = ['G4','A4','F#4','E4','G4','A4','F4','E4'];
  const NATURAL_DEMO_BASE = Array(12).fill('F4');
  const NATURAL_DEMO_PLAYBACK = ['F#4','F#4','F#4','F#4','F#4','F#4','F4','F4','F#4','F4','F4','F#4'];
  const NATURAL_DEMO_ACCIDENTALS = { 6:'natural', 9:'natural', 11:'#' };
  const CAUTIONARY_DEMO_BASE = Array(8).fill('F4');
  const CAUTIONARY_DEMO_PLAYBACK = ['F4','F4','F#4','F#4','F4','F4','F4','F4'];
  const CAUTIONARY_DEMO_ACCIDENTALS = { 2:'#', 4:'natural' };
  const translate = (key)=> (typeof I18N !== 'undefined' && I18N && typeof I18N.t === 'function') ? I18N.t(key) : key;
  const els = {};
  const state = {
    initialized:false,
    spelling:'sharp',
    keyboardSpelling:'sharp',
    halfstep:'ef',
    sharpVariant:'plain',
    flatVariant:'plain',
    keyboardNote:'C4',
    keyboardUI:null,
    renders:{},
    scaleRootValue:null,
    scaleMin:null,
    scaleMax:null
  };

  function ready(fn){
    if(document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  function prettyLabel(str){
    return noteName(str).replace(/#/g,'♯').replace(/b/g,'♭');
  }

  function respell(note, preferFlats){
    const renderer = getRenderer();
    if(!renderer) return note;
    const value = renderer.noteValue(note);
    const octave = Math.floor(value / 12);
    const names = preferFlats ? SPELL_FLAT : SPELL_SHARP;
    const name = names[((value % 12) + 12) % 12];
    const parsed = renderer.parseNote(`${name}${octave}`);
    parsed.answer = (App.utils && typeof App.utils.noteName === 'function')
      ? App.utils.noteName(name)
      : prettyLabel(name);
    if(parsed.accidental){
      parsed.meta = Object.assign({}, parsed.meta || {}, { forceAccidental:true });
    }
    return parsed;
  }

  function buildNotes(list, preferFlats){
    return list.map(str=>{
      const renderer = getRenderer();
      if(!renderer) return null;
      const base = renderer.parseNote(str);
      return respell(base, preferFlats);
    }).filter(Boolean);
  }

  function ensureScaleBounds(){
    const renderer = getRenderer();
    if(!renderer) return;
    if(typeof state.scaleMin !== 'number'){
      const minNote = renderer.parseNote(SCALE_RANGE.min);
      const maxNote = renderer.parseNote(SCALE_RANGE.max);
      state.scaleMin = renderer.noteValue(minNote);
      state.scaleMax = renderer.noteValue(maxNote);
      state.scaleRootValue = typeof state.scaleRootValue === 'number' ? state.scaleRootValue : state.scaleMin;
    }
  }

  function clampScaleRoot(){
    if(typeof state.scaleRootValue !== 'number') return;
    if(typeof state.scaleMin === 'number' && state.scaleRootValue < state.scaleMin) state.scaleRootValue = state.scaleMin;
    if(typeof state.scaleMax === 'number' && state.scaleRootValue > state.scaleMax) state.scaleRootValue = state.scaleMax;
  }

  function valueToNote(value, preferFlats){
    const renderer = getRenderer();
    if(!renderer) return null;
    const semitone = ((value % 12) + 12) % 12;
    const octave = Math.floor(value / 12);
    const names = preferFlats ? SPELL_FLAT : SPELL_SHARP;
    const name = names[semitone] || 'C';
    return respell(renderer.parseNote(`${name}${octave}`), preferFlats);
  }

  function buildMajorScale(){
    ensureScaleBounds();
    clampScaleRoot();
    return MAJOR_PATTERN.map(step=>valueToNote((state.scaleRootValue || 0) + step, state.spelling === 'flat')).filter(Boolean);
  }

  function noteFreq(note){
    const renderer = getRenderer();
    if(!renderer) return 0;
    const val = renderer.noteValue(note);
    return 440 * Math.pow(2, (val - 57) / 12);
  }

  function renderGeneric(container, notes, opts={}){
    const renderer = getRenderer();
    if(!renderer || !container) return null;
    const fillWidth = opts.fillWidth !== false;
    const tightLayout = opts.tightLayout === true;
    const debugLayout = opts.debugLayout === true;
    const debugLabel = opts.debugLabel || null;
    const noteGap = (typeof opts.noteGap === 'number') ? opts.noteGap : null;
    const paddingX = (typeof opts.paddingX === 'number') ? opts.paddingX : null;
    const paddingY = (typeof opts.paddingY === 'number') ? opts.paddingY : null;
    const extraTop = (typeof opts.extraTop === 'number') ? opts.extraTop : null;
    const extraBottom = (typeof opts.extraBottom === 'number') ? opts.extraBottom : null;
    const labelMargin = (typeof opts.labelMargin === 'number') ? opts.labelMargin : null;
    const noteRadius = opts.noteRadius || null;
    const layout = opts.layout || null;
    const variableSpacing = opts.variableSpacing === true;
    const leadingSpace = (typeof opts.leadingSpace === 'number')
      ? opts.leadingSpace
      : (layout && typeof layout.leadingSpace === 'number' ? layout.leadingSpace : null);
    const defaultStem = opts.defaultStem || null;
    const showAccidentals = opts.showAccidentals !== false;
    const accidentalSpace = opts.accidentalSpace || 'all';
    const barUnits = Array.isArray(opts.barUnits) ? opts.barUnits.slice() : null;
    const meter = opts.meter || null;
    const finalBar = opts.finalBar === true;
    const debugStems = opts.debugStems === true;
    const signatureMarks = Array.isArray(opts.signatureMarks) ? opts.signatureMarks : null;
    const initialLabel = (typeof opts.initialLabel === 'function') ? opts.initialLabel : null;
    const renderOptions = {
      noteGap,
      accidentalSpace,
      showAccidentals,
      paddingX,
      paddingY,
      extraTop,
      extraBottom,
      labelMargin,
      noteRadius,
      fillWidth,
      tightLayout,
      debugLayout,
      layout,
      variableSpacing,
      leadingSpace,
      defaultStem,
      barUnits,
      meter,
      finalBar,
      debugStems,
      signatureMarks,
      accidentalScope: opts.accidentalScope
    };
    if(initialLabel){
      renderOptions.initialLabel = initialLabel;
    }
    const result = renderer.render({
      container,
      clef: opts.clef || 'treble',
      notes,
      options: renderOptions
    });
    // debug output disabled
    attachNoteClicks(result, notes);
    return result;
  }

  function attachNoteClicks(result, notes){
    if(!result || !Array.isArray(result.groups)) return;
    result.groups.forEach((entry, idx)=>{
      const group = entry.group;
      if(!group) return;
      group.style.cursor = 'pointer';
      group.addEventListener('click', ()=>playSequence([notes[idx]], { render: result }));
    });
  }

  function highlightGroups(renderResult, index){
    if(!renderResult || !Array.isArray(renderResult.groups)) return;
    renderResult.groups.forEach((entry, idx)=>{
      const group = entry.group;
      if(!group) return;
      const active = typeof index === 'number' && idx === index;
      group.classList.toggle('is-active', active);
      if(!active && typeof index !== 'number') group.classList.remove('is-active');
    });
  }

  function playSequence(notes, opts={}){
    if(!Array.isArray(notes) || !notes.length) return;
    if(audio && typeof audio.stop === 'function') audio.stop();
    const renderRef = opts.render || null;
    const pattern = notes.map(()=>1);
    if(audio && typeof audio.playPattern === 'function'){
      audio.playPattern(pattern, {
        bpm: opts.bpm || 88,
        gain:0.24,
        freq:index=>noteFreq(notes[index]),
        onStep:index=>highlightGroups(renderRef, index),
        onFinish:()=>highlightGroups(renderRef, null),
        onCancel:()=>highlightGroups(renderRef, null)
      });
    } else {
      highlightGroups(renderRef, null);
    }
  }

  function renderHalfsteps(){
    if(els.pairs){
      els.pairs.innerHTML = '';
      state.pairRenders = new Map();
      HALFSTEP_DEMOS.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'acc-pair-card';
        const label = document.createElement('p');
        label.className = 'pair-label';
        label.textContent = translate(item.labelKey);
        card.appendChild(label);
        const staffWrap = document.createElement('div');
        staffWrap.className = 'reading-acc-staff';
        staffWrap.id = `acc-pair-${item.id}`;
        card.appendChild(staffWrap);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-green';
        btn.textContent = translate('reading_acc_action_play');
        els.pairs.appendChild(card);
        const notes = buildNotes(item.notes, state.spelling === 'flat');
        const rendered = renderGeneric(staffWrap, notes, {
          noteGap:38,
          paddingY:10,
          extraTop:6,
          extraBottom:14,
          noteRadius:{ rx:5, ry:3.6 },
          labelMargin:28,
          finalBar:false,
          defaultStem:'none'
        });
        card.appendChild(btn);
        state.pairRenders.set(item.id, { notes, render: rendered });
        btn.addEventListener('click', ()=>playSequence(notes, { render: rendered, bpm:96 }));
      });
    }
    renderNaturalRow();
  }

  function renderNaturalRow(){
    if(!els.naturalStaff) return;
    const notes = buildNotes(['C4','D4','E4','F4','G4','A4','B4','C5'], false);
    state.renders.natural = renderGeneric(els.naturalStaff, notes, {
      fillWidth:true,
      defaultStem:'none',
      finalBar:false
    });
  }

  function renderAccidentals(kind){
    const isSharp = kind === 'sharp';
    const variants = isSharp ? SHARP_VARIANTS : FLAT_VARIANTS;
    const grid = isSharp ? els.sharpGrid : els.flatGrid;
    if(grid){
      grid.innerHTML = '';
      variants.forEach(variant=>{
        const card = document.createElement('div');
        card.className = 'acc-variant-card';
        const staffWrap = document.createElement('div');
        staffWrap.className = 'reading-acc-staff';
        card.appendChild(staffWrap);
        const notes = buildNotes(variant.notes, !!variant.preferFlats);
        const hasAcc = Array.isArray(variant.notes) && variant.notes.some(n=>/[#b♯♭]/.test(String(n)));
        const gapBase = typeof variant.noteGapBase === 'number' ? variant.noteGapBase : (hasAcc ? 16 : 28);
        const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
          ? App.noteDrawing.layoutMeasure(notes, { noteGapBase: gapBase, accidentalSpace:'all' })
          : null;
        const rendered = renderGeneric(staffWrap, notes, {
          layout,
          variableSpacing:true,
          fillWidth:true,
          accidentalSpace:'all',
          showAccidentals:true
        });
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-green';
        btn.textContent = translate('reading_acc_action_play');
        btn.addEventListener('click', ()=>playSequence(notes, { render: rendered, bpm:96 }));
        card.appendChild(btn);
        grid.appendChild(card);
      });
    }
  }

  function renderSpellingToggle(){
    const targets = [els.spellingToggle, els.scaleSpelling].filter(Boolean);
    if(!targets.length) return;
    const options = [
      { value:'sharp', label:translate('reading_acc_spelling_sharp') },
      { value:'flat', label:translate('reading_acc_spelling_flat') }
    ];
    const onSelect = (value)=>{
      state.spelling = value;
      renderSpellingToggle();
      renderChromatic();
      renderKeyboard();
      renderHalfsteps();
      renderScale();
    };
    const renderManual = (container)=>{
      if(!container) return;
      container.innerHTML = '';
      options.forEach(opt=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.dataset.value = opt.value;
        btn.textContent = opt.label;
        btn.classList.toggle('on', state.spelling === opt.value);
        btn.addEventListener('click', ()=>onSelect(opt.value));
        container.appendChild(btn);
      });
    };
    targets.forEach(container=>{
      if(choiceChips){
        choiceChips(container, options, state.spelling, onSelect);
      } else {
        renderManual(container);
      }
    });
  }

  function renderChromatic(){
    const variant = state.spelling === 'flat' ? CHROMATIC_VARIANTS.flat : CHROMATIC_VARIANTS.sharp;
    const notes = buildNotes(variant, state.spelling === 'flat');
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(notes, { accidentalSpace:'all', barUnits:[], meterUnits:0 })
      : null;
    state.renders.chromatic = renderGeneric(els.chromaticStaff, notes, {
      layout,
      variableSpacing:true,
      fillWidth:true,
      accidentalScope:'note'
    });
    if(els.chromaticPlay){
      els.chromaticPlay.onclick = ()=>playSequence(notes, { render: state.renders.chromatic, bpm:84 });
    }
  }

  function updateScaleLabel(note){
    if(!els.scaleLabel) return;
    if(!note){
      els.scaleLabel.textContent = '';
      return;
    }
    const label = prettyLabel(note.answer || `${note.letter}${note.accidental||''}`);
    els.scaleLabel.textContent = label;
  }

  function updateScaleButtons(){
    if(!els.scaleDown || !els.scaleUp) return;
    const atMin = typeof state.scaleMin === 'number' && state.scaleRootValue <= state.scaleMin;
    const atMax = typeof state.scaleMax === 'number' && state.scaleRootValue >= state.scaleMax;
    els.scaleDown.disabled = !!atMin;
    els.scaleUp.disabled = !!atMax;
  }

  function renderScale(){
    if(!els.scaleStaff) return;
    const notes = buildMajorScale().map(n=>{
      if(n.accidental){
        n.meta = Object.assign({}, n.meta || {}, { forceAccidental:true });
      }
      return n;
    });
    if(!Array.isArray(notes) || !notes.length){
      els.scaleStaff.innerHTML = '';
      updateScaleLabel(null);
      updateScaleButtons();
      return;
    }
    const layoutNotes = notes.map(n=>({
      ...n,
      accidental: n.accidental || 'b',
      meta: Object.assign({}, n.meta || {}, { forceAccidental:true })
    }));
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:9, barUnits:[], meterUnits:0 })
      : null;
    state.renders.scale = renderGeneric(els.scaleStaff, notes, {
      layout,
      variableSpacing:true,
      fillWidth:true,
      paddingX:18,
      paddingY:16,
      labelMargin:18,
      noteGap: layout && layout.noteGap ? layout.noteGap : 32,
      accidentalSpace:'all',
      showAccidentals:true
    });
    updateScaleLabel(notes[0]);
    updateScaleButtons();
    if(els.scalePlay){
      els.scalePlay.onclick = ()=>playSequence(notes, { render: state.renders.scale, bpm:90 });
    }
  }

  function nudgeScaleRoot(delta){
    ensureScaleBounds();
    if(typeof state.scaleRootValue !== 'number') return;
    state.scaleRootValue += delta;
    clampScaleRoot();
    renderScale();
  }

  function bindScaleControls(){
    if(els.scaleDown && !els.scaleDown.__bound){
      els.scaleDown.__bound = true;
      els.scaleDown.addEventListener('click', ()=>nudgeScaleRoot(-1));
    }
    if(els.scaleUp && !els.scaleUp.__bound){
      els.scaleUp.__bound = true;
      els.scaleUp.addEventListener('click', ()=>nudgeScaleRoot(1));
    }
  }

  function renderKeyboard(){
    if(!els.keyboard) return;
    if(!App.keyboard || typeof App.keyboard.create !== 'function') return;
    const labelFor = (noteId)=>{
      const renderer = getRenderer();
      if(!renderer) return noteId;
      const spelled = respell(renderer.parseNote(noteId), state.keyboardSpelling === 'flat');
      return prettyLabel(spelled.answer || `${spelled.letter}${spelled.accidental||''}`);
    };
    if(!state.keyboardUI){
      const layout = Array.isArray(App.keyboard.DEFAULT_LAYOUT) && App.keyboard.DEFAULT_LAYOUT.length
        ? App.keyboard.DEFAULT_LAYOUT
        : KEYBOARD_LAYOUT;
      state.keyboardUI = App.keyboard.create({
        container: els.keyboard,
        layout,
        labelFor,
        active: state.keyboardNote || 'C4',
        onSelect:(noteId)=>{
          state.keyboardNote = noteId;
          if(state.keyboardUI) state.keyboardUI.setActive(noteId);
          renderKeyboardStaff(noteId, { play:true });
        }
      });
    } else {
      state.keyboardUI.setLabels(labelFor);
      state.keyboardUI.setActive(state.keyboardNote || 'C4');
    }
    renderKeyboardStaff(state.keyboardNote || 'C4', { play:false });
  }

  function renderKeyboardSpelling(){
    if(!els.keyboardSpelling) return;
    const options = [
      { value:'sharp', label:translate('reading_acc_spelling_sharp') },
      { value:'flat', label:translate('reading_acc_spelling_flat') }
    ];
    const buildChips = ()=>{
      els.keyboardSpelling.innerHTML = '';
      options.forEach(opt=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.dataset.value = opt.value;
        btn.textContent = opt.label;
        btn.classList.toggle('on', state.keyboardSpelling === opt.value);
        btn.addEventListener('click', ()=>{
          state.keyboardSpelling = opt.value;
          els.keyboardSpelling.querySelectorAll('.chip').forEach(ch=>ch.classList.toggle('on', ch === btn));
          renderKeyboard();
        });
        els.keyboardSpelling.appendChild(btn);
      });
    };
    if(choiceChips){
    choiceChips(els.keyboardSpelling, options, state.keyboardSpelling, value=>{
      state.keyboardSpelling = value;
      renderKeyboard();
    });
    } else {
      buildChips();
    }
  }

  function renderKeyboardStaff(noteId, opts={}){
    const renderer = getRenderer();
    if(!renderer) return;
    const note = respell(renderer.parseNote(noteId), state.keyboardSpelling === 'flat');
    note.answer = prettyLabel(note.answer || `${note.letter}${note.accidental||''}`);
    if(note.accidental){
      note.meta = Object.assign({}, note.meta || {}, { forceAccidental:true });
    }
    const layoutNotes = [{
      ...note,
      accidental: note.accidental || 'b',
      meta: Object.assign({}, note.meta || {}, { forceAccidental:true })
    }];
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:18, barUnits:[], meterUnits:0 })
      : null;
    state.renders.keyboard = renderGeneric(els.keyboardStaff, [note], {
      layout,
      fillWidth:true,
      noteGap: layout && layout.noteGap ? layout.noteGap : 18,
      paddingX:18,
      paddingY:22,
      leadingSpace:18,
      extraTop:16,
      extraBottom:32,
      labelMargin:30,
      accidentalSpace:'all',
      showAccidentals:true
    });
    if(state.renders.keyboard && state.renders.keyboard.svg){
      state.renders.keyboard.svg.setAttribute('preserveAspectRatio','xMidYMin meet');
    }
    if(opts.play){
      playSequence([note], { render: state.renders.keyboard, bpm:100 });
    } else {
      highlightGroups(state.renders.keyboard, null);
    }
  }

  function leadingSpaceFor(marks, meter){
    const count = Array.isArray(marks) ? marks.length : 0;
    const markWidth = count ? count * 16 + 12 : 0;
    const meterWidth = meter ? 32 : 0;
    const gap = 12;
    const value = markWidth + meterWidth + gap;
    // console.log('[staff leadingSpaceFor]', { count, meter, markWidth, meterWidth, gap, value });
    return value;
  }

  function renderSignature(){
    const renderer = getRenderer();
    if(!renderer) return;
    const barUnits = [16,16]; // dva takty 4/4 v jednotkách labu (quarter = 4)
    const signatureNotes = buildNotes(SIGNATURE_NOTES, false).map(n=>({
      ...n,
      noteType:'quarter',
      duration:'quarter',
      stem:'auto'
    }));
    const accidentalNotes = buildNotes(ACCIDENTAL_NOTES, false).map((n, idx)=>{
      const meta = { ...(n.meta||{}) };
      // F# v prvním taktu (index 2) a F♮ ve druhém taktu (index 6) musí mít viditelnou posuvku
      if(idx === 2){
        meta.forceAccidental = true;
      }
      return { ...n, noteType:'quarter', duration:'quarter', stem:'auto', meta };
    });
    const layoutSig = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(signatureNotes, { barUnits, meterUnits:16, accidentalSpace:'signature' })
      : null;
    const layoutAcc = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(accidentalNotes, { barUnits, meterUnits:16, accidentalSpace:'all' })
      : null;
    const leadSig = Math.max(40, leadingSpaceFor(SIGNATURE_MARKS, '4/4') || 0);
    const leadAcc = 40;
    state.renders.signature = renderGeneric(els.signatureStaff, signatureNotes, {
      layout: layoutSig,
      variableSpacing:true,
      fillWidth:true,
      leadingSpace: leadSig,
      defaultStem:'auto',
      showAccidentals:false,
      meter:'4/4',
      signatureMarks: SIGNATURE_MARKS,
      finalBar:true
    });
    drawSignatureMarks(state.renders.signature, SIGNATURE_MARKS);

    state.renders.accidentals = renderGeneric(els.accidentalStaff, accidentalNotes, {
      layout: layoutAcc,
      variableSpacing:true,
      fillWidth:true,
      leadingSpace: leadAcc,
      defaultStem:'auto',
      showAccidentals:true,
      accidentalSpace:'all',
      meter:'4/4',
      finalBar:true
    });

    if(els.signaturePlayKey){
      els.signaturePlayKey.onclick = ()=>playSequence(signatureNotes, { render: state.renders.signature, bpm:92 });
    }
    if(els.signaturePlayAcc){
      els.signaturePlayAcc.onclick = ()=>playSequence(accidentalNotes, { render: state.renders.accidentals, bpm:92 });
    }
  }

  function renderNaturalDemo(){
    if(!els.naturalDemoStaff) return;
    const barUnits = [16,16,16]; // 3 takty 4/4 v jednotkách labu (quarter = 4)
    const demoNotes = buildNotes(NATURAL_DEMO_BASE, false).map(n=>({
      ...n,
      noteType:'quarter',
      duration:'quarter',
      stem:'auto'
    }));
    demoNotes.forEach((note, idx)=>{
      const accidental = NATURAL_DEMO_ACCIDENTALS[idx];
      if(accidental){
        note.accidental = accidental;
        note.meta = Object.assign({}, note.meta || {}, { forceAccidental:true });
      }
    });
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(demoNotes, { barUnits, meterUnits:16, measures:3, accidentalSpace:'all' })
      : null;
    const lead = Math.max(40, leadingSpaceFor(SIGNATURE_MARKS, '4/4') || 0);
    state.renders.naturalDemo = renderGeneric(els.naturalDemoStaff, demoNotes, {
      layout,
      variableSpacing:true,
      fillWidth:true,
      leadingSpace: lead,
      defaultStem:'auto',
      showAccidentals:true,
      meter:'4/4',
      signatureMarks: SIGNATURE_MARKS,
      finalBar:true
    });
    drawSignatureMarks(state.renders.naturalDemo, SIGNATURE_MARKS);

    if(els.naturalDemoPlay){
      const playbackNotes = buildNotes(NATURAL_DEMO_PLAYBACK, false).map(n=>({
        ...n,
        noteType:'quarter',
        duration:'quarter',
        stem:'auto'
      }));
      els.naturalDemoPlay.onclick = ()=>playSequence(playbackNotes, { render: state.renders.naturalDemo, bpm:92 });
    }
  }

  function renderCautionaryDemo(){
    if(!els.cautionaryDemoStaff) return;
    const barUnits = [16,16];
    const demoNotes = buildNotes(CAUTIONARY_DEMO_BASE, false).map(n=>({
      ...n,
      noteType:'quarter',
      duration:'quarter',
      stem:'auto'
    }));
    demoNotes.forEach((note, idx)=>{
      const accidental = CAUTIONARY_DEMO_ACCIDENTALS[idx];
      if(accidental){
        note.accidental = accidental;
        note.meta = Object.assign({}, note.meta || {}, { forceAccidental:true });
      }
    });
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(demoNotes, { barUnits, meterUnits:16, measures:2, accidentalSpace:'all' })
      : null;
    state.renders.cautionaryDemo = renderGeneric(els.cautionaryDemoStaff, demoNotes, {
      layout,
      variableSpacing:true,
      fillWidth:true,
      leadingSpace:40,
      defaultStem:'auto',
      showAccidentals:true,
      meter:'4/4',
      finalBar:true
    });

    if(els.cautionaryDemoPlay){
      const playbackNotes = buildNotes(CAUTIONARY_DEMO_PLAYBACK, false).map(n=>({
        ...n,
        noteType:'quarter',
        duration:'quarter',
        stem:'auto'
      }));
      els.cautionaryDemoPlay.onclick = ()=>playSequence(playbackNotes, { render: state.renders.cautionaryDemo, bpm:92 });
    }
  }

  function drawSignatureMarks(rendered, marks){
    if(!rendered || !rendered.svg || !rendered.metrics || !Array.isArray(marks)) return;
    const renderer = getRenderer();
    if(!renderer) return;
    const { svg, metrics } = rendered;
    const startX = metrics.paddingX + metrics.clefOffset + 6;
    const isBass = metrics.baseStep && metrics.baseStep < 25; // hrubý odhad pro basový klíč
    const trebleSharpOct = { F:5, C:5, G:5, D:5, A:4, E:5, H:4, B:4 }; // F# C# G# D# A# E# B#
    const trebleFlatOct = { B:4, H:4, E:5, A:4, D:5, G:4, C:5, F:4 };  // Bb Eb Ab Db Gb Cb Fb
    const bassSharpOct = { F:3, C:3, G:3, D:3, A:2, E:3, H:2, B:2 };
    const bassFlatOct = { B:2, H:2, E:3, A:2, D:3, G:2, C:3, F:2 };
    marks.forEach((name, idx)=>{
      let sigNote = renderer.parseNote(name);
      const letter = sigNote.letter ? sigNote.letter.toUpperCase() : '';
      if(sigNote.accidental === '#'){
        const tgtOct = isBass ? bassSharpOct[letter] : trebleSharpOct[letter];
        if(typeof tgtOct === 'number') sigNote.octave = tgtOct;
      } else if(sigNote.accidental === 'b'){
        const tgtOct = isBass ? bassFlatOct[letter] : trebleFlatOct[letter];
        if(typeof tgtOct === 'number') sigNote.octave = tgtOct;
      }
      const diff = renderer.noteStep(sigNote) - metrics.baseStep;
      const y = metrics.bottomY - diff * metrics.stepHeight;
      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      const sigSharpYOffset = 14;
      const sigFlatYOffset = 12;
      const isSharp = sigNote.accidental === '#';
      const yOffset = isSharp ? sigSharpYOffset : sigFlatYOffset;
      text.setAttribute('x', startX + idx * 16);
      text.setAttribute('y', y + yOffset);
      text.setAttribute('font-size','35');
      text.setAttribute('font-weight','500');
      text.style.fill = metrics.staffColor || (typeof getInk === 'function' ? getInk() : 'currentColor');
      text.textContent = isSharp ? '♯' : '♭';
      svg.appendChild(text);
    });
  }
  App.drawSignatureMarks = drawSignatureMarks;

  function drawMeterAndBar(rendered, opts={}){
    if(!rendered || !rendered.svg || !rendered.metrics) return;
    const { svg, metrics } = rendered;
    const meter = opts.meter || '4/4';
    const barAfter = typeof opts.barAfter === 'number' ? opts.barAfter : null;
    const finalBar = opts.finalBar !== false;
    const markCount = typeof opts.markCount === 'number' ? opts.markCount : 0;
    const markWidth = markCount ? (markCount * 16 + 8) : 0;
    const lead = typeof opts.leadingSpace === 'number' ? opts.leadingSpace : (metrics.leadingSpace || 0);

    if(meter){
      const [top,bottom] = String(meter).split('/');
      const cx = metrics.paddingX + metrics.clefOffset + Math.max(6, lead - 18);
      const topText = document.createElementNS('http://www.w3.org/2000/svg','text');
      topText.setAttribute('x', cx);
      topText.setAttribute('y', metrics.bottomY - metrics.stepHeight*6.5);
      topText.setAttribute('text-anchor','middle');
      topText.setAttribute('font-size','22');
      topText.setAttribute('font-weight','700');
      topText.setAttribute('fill', metrics.staffColor || getInk());
      topText.textContent = top || '';
      svg.appendChild(topText);
      const bottomText = document.createElementNS('http://www.w3.org/2000/svg','text');
      bottomText.setAttribute('x', cx);
      bottomText.setAttribute('y', metrics.bottomY - metrics.stepHeight*4.8);
      bottomText.setAttribute('text-anchor','middle');
      bottomText.setAttribute('font-size','22');
      bottomText.setAttribute('font-weight','700');
      bottomText.setAttribute('fill', metrics.staffColor || getInk());
      bottomText.textContent = bottom || '';
      svg.appendChild(bottomText);
    }

    if(typeof barAfter === 'number' && barAfter > 0){
      const unitW = metrics.unitWidth || metrics.noteGap;
      const x0 = metrics.paddingX + metrics.clefOffset + lead + barAfter * unitW;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x0);
      line.setAttribute('x2', x0);
      line.setAttribute('y1', metrics.topY + metrics.stepHeight * 2); // o jednu linku kratší (jako renderer)
      line.setAttribute('y2', metrics.bottomY);
      line.setAttribute('stroke', metrics.staffColor || getStaffColor());
      line.setAttribute('stroke-width', '2');
      svg.appendChild(line);
    }
    if(finalBar){
      const hasSpan = typeof metrics.totalSpan === 'number' && metrics.totalSpan > 0;
      const lastIndex = (rendered.groups && rendered.groups.length) ? rendered.groups.length : 0;
      const unitW = metrics.unitWidth || metrics.noteGap;
      const baseX = metrics.paddingX + metrics.clefOffset + lead + (hasSpan ? metrics.totalSpan : lastIndex * unitW);
      const barTop = metrics.topY + metrics.stepHeight * 2;
      const thin = document.createElementNS('http://www.w3.org/2000/svg','line');
      thin.setAttribute('x1', baseX - 6);
      thin.setAttribute('x2', baseX - 6);
      thin.setAttribute('y1', barTop);
      thin.setAttribute('y2', metrics.bottomY);
      thin.setAttribute('stroke', metrics.staffColor || getStaffColor());
      thin.setAttribute('stroke-width', '2');
      svg.appendChild(thin);
      const thick = document.createElementNS('http://www.w3.org/2000/svg','line');
      thick.setAttribute('x1', baseX);
      thick.setAttribute('x2', baseX);
      thick.setAttribute('y1', barTop);
      thick.setAttribute('y2', metrics.bottomY);
      thick.setAttribute('stroke', metrics.staffColor || getStaffColor());
      thick.setAttribute('stroke-width', '4');
      svg.appendChild(thick);
    }
  }


  function cacheElements(){
    els.halfstepButtons = document.getElementById('acc-halfstep-buttons');
    els.halfstepStaff = document.getElementById('acc-halfstep-staff');
    els.halfstepPlay = document.getElementById('acc-halfstep-play');
    els.pairs = document.getElementById('acc-pairs');
    els.naturalStaff = document.getElementById('acc-natural-staff');
    els.sharpGrid = document.getElementById('acc-sharp-grid');
    els.flatGrid = document.getElementById('acc-flat-grid');
    els.spellingToggle = document.getElementById('acc-spelling-toggle');
    els.spellingToggleChromatic = document.getElementById('acc-spelling-toggle');
    els.chromaticStaff = document.getElementById('acc-chromatic-staff');
    els.chromaticPlay = document.getElementById('acc-chromatic-play');
    els.scaleStaff = document.getElementById('acc-scale-staff');
    els.scalePlay = document.getElementById('acc-scale-play');
    els.scaleDown = document.getElementById('acc-scale-down');
    els.scaleUp = document.getElementById('acc-scale-up');
    els.scaleLabel = document.getElementById('acc-scale-label');
    els.scaleSpelling = document.getElementById('acc-scale-spelling');
    els.keyboard = document.getElementById('acc-keyboard');
    els.keyboardSpelling = document.getElementById('acc-keyboard-spelling');
    els.keyboardStaff = document.getElementById('acc-keyboard-staff');
    els.signatureStaff = document.getElementById('acc-signature-staff');
    els.accidentalStaff = document.getElementById('acc-accidental-staff');
    els.signaturePlayKey = document.getElementById('acc-signature-play-key');
    els.signaturePlayAcc = document.getElementById('acc-signature-play-acc');
    els.naturalDemoStaff = document.getElementById('acc-natural-demo-staff');
    els.naturalDemoPlay = document.getElementById('acc-natural-demo-play');
    els.cautionaryDemoStaff = document.getElementById('acc-cautionary-demo-staff');
    els.cautionaryDemoPlay = document.getElementById('acc-cautionary-demo-play');
  }

  function renderAll(){
    if(!getRenderer()){
      window.setTimeout(renderAll, 50);
      return;
    }
    if(!state.pairRenders) state.pairRenders = new Map();
    state.initialized = true;
    renderSpellingToggle();
    renderNaturalRow();
    renderHalfsteps();
    renderAccidentals('sharp');
    renderAccidentals('flat');
    renderChromatic();
    renderScale();
    renderKeyboardSpelling();
    renderKeyboard();
    renderSignature();
    renderNaturalDemo();
    renderCautionaryDemo();
  }

  function init(){
    if(state.initialized) return;
    cacheElements();
    bindScaleControls();
    renderAll();
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden && audio && typeof audio.stop === 'function'){
        audio.stop();
      }
    });
  }

  function safeRefresh(){
    if(state.initialized){
      renderAll();
    } else if(document.readyState !== 'loading'){
      init();
    } else {
      ready(init);
    }
  }

  ready(init);
  App.readingTheoryAcc = { refresh: safeRefresh };
})();
</script>
<!-- ===== MODULE: Reading — Accidentals — end ===== -->
<section class="hidden" id="view-reading-theory-rhythm">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-theory-rhythm" data-i18n="common_back"></button></div>
<div class="stack stack-lg reading-rhythm-view">
  <header class="reading-rhythm-hero">
    <h2 class="h2" data-i18n="reading_theory_rhythm_title"></h2>
    <p class="lead" data-i18n="reading_rhythm_intro_tagline"></p>
    <article class="list-card reading-rhythm-intro-card">
      <h3 class="h3" data-i18n="reading_rhythm_intro_heading"></h3>
      <div class="stack stack-md reading-rhythm-intro">
        <p data-i18n="reading_rhythm_intro_p1"></p>
        <p data-i18n="reading_rhythm_intro_p2"></p>
        <p data-i18n="reading_rhythm_intro_p3"></p>
        <p data-i18n="reading_rhythm_intro_p4"></p>
      </div>
    </article>
    <div class="rhythm-audio-warning hidden" id="rhythm-audio-warning" role="status" aria-live="polite">
      <span data-i18n="reading_rhythm_audio_not_supported"></span>
    </div>
  </header>

  <article class="list-card rhythm-card" data-section="structure">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_structure_heading"></h3>
      <p class="sub" data-i18n="reading_rhythm_structure_intro"></p>
    </div>
    <div class="rhythm-structure-layout">
      <div class="rhythm-structure-figure" id="rhythm-structure-figure"></div>
      <div class="rhythm-structure-legend">
        <div class="rhythm-structure-legend-item">
          <span class="rhythm-structure-legend-mark">1</span>
          <span data-i18n="reading_rhythm_part_head"></span>
        </div>
        <div class="rhythm-structure-legend-item">
          <span class="rhythm-structure-legend-mark">2</span>
          <span data-i18n="reading_rhythm_part_stem"></span>
        </div>
        <div class="rhythm-structure-legend-item">
          <span class="rhythm-structure-legend-mark">3</span>
          <span data-i18n="reading_rhythm_part_flag"></span>
        </div>
      </div>
    </div>
    <p class="sub rhythm-structure-note" data-i18n="reading_rhythm_structure_note"></p>
  </article>

  <article class="list-card rhythm-card" data-section="notes">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_notes_heading"></h3>
    </div>
    <div class="rhythm-notes-layout">
      <section class="rhythm-notes-block rhythm-block">
        <h4 class="h4" data-i18n="reading_rhythm_stems_heading"></h4>
        <p class="sub" data-i18n="reading_rhythm_stems_sub"></p>
        <p data-i18n="reading_rhythm_stems_text" data-i18n-html="1"></p>
        <p class="note" data-i18n="reading_rhythm_stems_note" data-i18n-html="1"></p>
        <button class="rhythm-stems-trigger" id="rhythm-stems-trigger" type="button" aria-label="Play stem demo">
          <div class="rhythm-stems-figure" id="rhythm-stems-figure"></div>
        </button>
      </section>
      <section class="rhythm-notes-block rhythm-block">
        <h4 class="h4" data-i18n="reading_rhythm_beams_heading"></h4>
        <p class="sub" data-i18n="reading_rhythm_beams_sub" data-i18n-html="1"></p>
        <p data-i18n="reading_rhythm_beams_text" data-i18n-html="1"></p>
        <p class="note" data-i18n="reading_rhythm_beams_note" data-i18n-html="1"></p>
        <button class="rhythm-beams-trigger" id="rhythm-beams-trigger" type="button" aria-label="Play beaming demo">
          <div class="rhythm-beams-figure" id="rhythm-beams-figure"></div>
        </button>
      </section>
    </div>
  </article>

  <article class="list-card rhythm-card" data-section="lengths">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_lengths_heading"></h3>
      <p class="sub" data-i18n="reading_rhythm_lengths_desc"></p>
      <p class="sub" data-i18n="reading_rhythm_lengths_intro"></p>
    </div>
    <div class="rhythm-lengths-grid" id="rhythm-note-list"></div>
  </article>

  <article class="list-card rhythm-card" data-section="rests">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_rests_heading"></h3>
      <p class="sub" data-i18n="reading_rhythm_rests_desc"></p>
    </div>
    <div class="rhythm-rests-grid" id="rhythm-rest-list"></div>
  </article>

  <article class="list-card rhythm-card" data-section="extension">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_extension_heading"></h3>
    </div>
    <div class="stack stack-lg rhythm-extension-blocks">
      <div class="rhythm-extension-block">
        <div class="rhythm-extension-text">
          <h4 class="h4" data-i18n="reading_rhythm_dot_heading"></h4>
          <p data-i18n="reading_rhythm_dot_text" data-i18n-html="1"></p>
          <div class="btns">
            <button class="btn btn-ghost" id="rhythm-extension-play" data-i18n="reading_rhythm_extension_btn" type="button"></button>
          </div>
        </div>
        <div class="rhythm-extension-figure">
          <div class="rhythm-extension-svg" id="rhythm-dot-figure" aria-hidden="true"></div>
          <p class="rhythm-extension-caption" data-i18n="reading_rhythm_dot_caption"></p>
        </div>
      </div>
      <div class="rhythm-extension-block">
        <div class="rhythm-extension-text">
          <h4 class="h4" data-i18n="reading_rhythm_tie_heading"></h4>
          <p data-i18n="reading_rhythm_tie_text" data-i18n-html="1"></p>
        </div>
        <div class="rhythm-extension-figure">
          <div class="rhythm-extension-svg" id="rhythm-tie-figure" aria-hidden="true"></div>
          <p class="rhythm-extension-caption" data-i18n="reading_rhythm_tie_caption"></p>
        </div>
      </div>
      <div class="rhythm-extension-block rhythm-tuplets" id="rhythm-tuplets">
        <div class="rhythm-tuplets-grid">
          <section class="tuplets-section" data-section="meaning">
            <h4 class="h4" data-i18n="reading_rhythm_tuplet_heading"></h4>
            <h5 class="h5" data-i18n="reading_rhythm_tuplet_meaning_heading"></h5>
            <div class="stack stack-sm">
              <p data-i18n="reading_rhythm_tuplet_meaning_p1" data-i18n-html="1"></p>
              <p data-i18n="reading_rhythm_tuplet_meaning_p2" data-i18n-html="1"></p>
              <p data-i18n="reading_rhythm_tuplet_meaning_p3" data-i18n-html="1"></p>
            </div>
            <div class="tuplets-meaning-figure" id="rhythm-tuplet-meaning-figure" role="group" aria-label=""></div>
            <div class="tuplets-reading-note">
              <p class="h5" data-i18n="reading_rhythm_tuplet_read_heading"></p>
              <p data-i18n="reading_rhythm_tuplet_read_text" data-i18n-html="1"></p>
              <ul class="tuplets-counting">
                <li data-i18n="reading_rhythm_tuplet_count_triplet" data-i18n-html="1"></li>
                <li data-i18n="reading_rhythm_tuplet_count_quartet" data-i18n-html="1"></li>
                <li data-i18n="reading_rhythm_tuplet_count_quintet" data-i18n-html="1"></li>
              </ul>
            </div>
            <div class="tuplets-table-wrap">
              <table class="tuplets-table">
                <thead>
                  <tr>
                    <th scope="col" data-i18n="reading_rhythm_tuplet_table_col_division"></th>
                    <th scope="col" data-i18n="reading_rhythm_tuplet_table_col_count"></th>
                    <th scope="col" data-i18n="reading_rhythm_tuplet_table_col_replace"></th>
                    <th scope="col" data-i18n="reading_rhythm_tuplet_table_col_length"></th>
                  </tr>
                </thead>
                <tbody id="rhythm-tuplet-table"></tbody>
              </table>
            </div>
          </section>
        </div>
        <header class="rhythm-tuplets-hero">
          <div class="rhythm-tuplets-pulse" id="rhythm-tuplet-hero" aria-hidden="true"></div>
        </header>
      </div>
    </div>
  </article>

  <article class="list-card rhythm-card" data-section="meter">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_meter_heading"></h3>
    </div>
    <div class="stack stack-lg rhythm-meter-content">
      <section class="rhythm-meter-intro">
        <h4 class="h4" data-i18n="reading_rhythm_meter_intro_heading"></h4>
        <p data-i18n="reading_rhythm_meter_intro_text" data-i18n-html="1"></p>
        <p class="sub" data-i18n="reading_rhythm_meter_usage_text" data-i18n-html="1"></p>
      </section>
      <section class="rhythm-meter-notation">
        <h4 class="h4" data-i18n="reading_rhythm_meter_notation_heading" data-i18n-html="1"></h4>
        <p data-i18n="reading_rhythm_meter_notation_text" data-i18n-html="1"></p>
        <ul>
          <li data-i18n="reading_rhythm_meter_notation_top" data-i18n-html="1"></li>
          <li data-i18n="reading_rhythm_meter_notation_bottom" data-i18n-html="1"></li>
        </ul>
        <p class="sub" data-i18n="reading_rhythm_meter_notation_examples" data-i18n-html="1"></p>
        <div class="rhythm-meter-notation-figure" id="rhythm-meter-notation" aria-hidden="true"></div>
      </section>
      <section class="rhythm-meter-table-card">
        <h4 class="h4" data-i18n="reading_rhythm_meter_table_heading"></h4>
        <div class="table rhythm-meter-table">
          <table>
            <thead>
              <tr>
                <th scope="col" data-i18n="reading_rhythm_meter_table_col_meter"></th>
                <th scope="col" data-i18n="reading_rhythm_meter_table_col_beats"></th>
                <th scope="col" data-i18n="reading_rhythm_meter_table_col_example"></th>
                <th scope="col" data-i18n="reading_rhythm_meter_table_col_character"></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2/4</td>
                <td data-i18n="reading_rhythm_meter_table_beats_24"></td>
                <td data-i18n="reading_rhythm_meter_table_type_24"></td>
                <td data-i18n="reading_rhythm_meter_table_char_24"></td>
              </tr>
              <tr>
                <td>3/4</td>
                <td data-i18n="reading_rhythm_meter_table_beats_34"></td>
                <td data-i18n="reading_rhythm_meter_table_type_34"></td>
                <td data-i18n="reading_rhythm_meter_table_char_34"></td>
              </tr>
              <tr>
                <td>4/4</td>
                <td data-i18n="reading_rhythm_meter_table_beats_44"></td>
                <td data-i18n="reading_rhythm_meter_table_type_44"></td>
                <td data-i18n="reading_rhythm_meter_table_char_44"></td>
              </tr>
              <tr>
                <td>6/8</td>
                <td data-i18n="reading_rhythm_meter_table_beats_68"></td>
                <td data-i18n="reading_rhythm_meter_table_type_68"></td>
                <td data-i18n="reading_rhythm_meter_table_char_68"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="sub" data-i18n="reading_rhythm_meter_accent_text" data-i18n-html="1"></p>
      </section>
      <article class="list-card rhythm-card" data-section="meter-play">
        <div class="section-head">
          <h3 class="h3" data-i18n="reading_rhythm_meter_play_heading"></h3>
          <p class="sub" data-i18n="reading_rhythm_meter_play_sub"></p>
        </div>
        <section class="rhythm-meter-examples">
          <div class="rhythm-meter-switch" id="rhythm-meter-switch" role="tablist" aria-label="Meter examples"></div>
          <div class="rhythm-meter-active">
            <div class="rhythm-meter-active-head">
              <div>
                <h4 class="h4" id="rhythm-meter-active-title"></h4>
                <p class="sub" id="rhythm-meter-active-desc"></p>
              </div>
              <p class="hint" data-i18n="reading_rhythm_meter_examples_hint" data-i18n-html="1"></p>
            </div>
            <div class="rhythm-meter-example-figure" id="rhythm-meter-example-figure" aria-hidden="true"></div>
            <div class="rhythm-meter-example-list" id="rhythm-meter-example-list"></div>
            <div class="btns">
              <button class="btn btn-ghost" id="rhythm-meter-play-selected" data-i18n="reading_rhythm_meter_play_selected" type="button"></button>
              <button class="btn btn-ghost" id="rhythm-meter-play-all" data-i18n="reading_rhythm_meter_play_all" type="button"></button>
            </div>
          </div>
        </section>
      </article>
      <section class="rhythm-meter-compare">
        <div class="rhythm-meter-compare-text">
          <h4 class="h4" data-i18n="reading_rhythm_meter_compound_heading"></h4>
          <p data-i18n="reading_rhythm_meter_compound_text" data-i18n-html="1"></p>
          <p class="sub" data-i18n="reading_rhythm_meter_compare_text"></p>
        </div>
        <div class="rhythm-meter-compare-figures">
          <div class="rhythm-meter-compare-card" data-meter="34">
            <div class="meter-badge">3/4</div>
            <div class="meter-mini-figure" id="meter-mini-figure-34" aria-hidden="true"></div>
            <div class="rhythm-meter-beats is-compact" id="meter-mini-beats-34" role="group" aria-live="polite"></div>
            <div class="meter-mini-actions">
              <button class="btn btn-ghost" id="meter-mini-play-34" data-i18n="reading_rhythm_meter_compare_play_single" type="button"></button>
            </div>
          </div>
          <div class="rhythm-meter-compare-card" data-meter="68">
            <div class="meter-badge">6/8</div>
            <div class="meter-mini-figure" id="meter-mini-figure-68" aria-hidden="true"></div>
            <div class="rhythm-meter-beats is-compact" id="meter-mini-beats-68" role="group" aria-live="polite"></div>
            <div class="meter-mini-actions">
              <button class="btn btn-ghost" id="meter-mini-play-68" data-i18n="reading_rhythm_meter_compare_play_single" type="button"></button>
            </div>
          </div>
        </div>
        <div class="btns">
          <button class="btn btn-green" id="rhythm-meter-compare-play-both" data-i18n="reading_rhythm_meter_compare_button" type="button"></button>
        </div>
      </section>
    </div>
  </article>

  <article class="list-card rhythm-card" data-section="tempo">
    <div class="section-head">
      <h3 class="h3" data-i18n="reading_rhythm_tempo_heading"></h3>
      <p class="sub" data-i18n="reading_rhythm_tempo_intro" data-i18n-html="1"></p>
    </div>
    <div class="tempo-grid">
      <section class="tempo-block">
        <h4 class="h4" data-i18n="reading_rhythm_tempo_length_heading"></h4>
        <p data-i18n="reading_rhythm_tempo_length_text" data-i18n-html="1"></p>
      </section>
      <section class="tempo-block">
        <h4 class="h4" data-i18n="reading_rhythm_tempo_speed_heading"></h4>
        <p data-i18n="reading_rhythm_tempo_speed_text" data-i18n-html="1"></p>
        <ul class="tempo-examples">
          <li data-i18n="reading_rhythm_tempo_example_q60"></li>
          <li data-i18n="reading_rhythm_tempo_example_q120"></li>
          <li data-i18n="reading_rhythm_tempo_example_e120"></li>
        </ul>
      </section>
      <section class="tempo-demo-card">
        <h4 class="h4" data-i18n="reading_rhythm_tempo_demo_heading"></h4>
        <label class="tempo-slider-label" for="tempo-control" data-i18n="reading_rhythm_tempo_demo_label" data-i18n-html="1"></label>
        <input type="range" id="tempo-control" min="40" max="200" value="120" step="1">
        <p class="tempo-demo-hint" data-i18n="reading_rhythm_tempo_demo_hint"></p>
        <p class="tempo-demo-context" data-i18n="reading_rhythm_tempo_demo_context"></p>
        <div class="tempo-duration-grid">
          <div>
            <span data-i18n="reading_rhythm_tempo_duration_quarter"></span>
            <strong id="tempo-duration-quarter">0.50 s</strong>
          </div>
          <div>
            <span data-i18n="reading_rhythm_tempo_duration_eighth"></span>
            <strong id="tempo-duration-eighth">0.25 s</strong>
          </div>
          <div>
            <span data-i18n="reading_rhythm_tempo_duration_dotted"></span>
            <strong id="tempo-duration-dotted">0.75 s</strong>
          </div>
        </div>
        <div class="rhythm-meter-beats is-compact" id="tempo-demo-beats" aria-live="polite"></div>
        <div class="btns">
          <button class="btn btn-ghost" id="tempo-click" data-i18n="reading_rhythm_tempo_play" type="button"></button>
        </div>
      </section>
      <section class="tempo-block">
        <h4 class="h4" data-i18n="reading_rhythm_tempo_compare_heading"></h4>
        <div class="table tempo-compare-table">
          <table>
            <thead>
              <tr>
                <th scope="col" data-i18n="reading_rhythm_tempo_compare_meter"></th>
                <th scope="col" data-i18n="reading_rhythm_tempo_compare_tempo"></th>
                <th scope="col" data-i18n="reading_rhythm_tempo_compare_beats"></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td data-i18n="reading_rhythm_tempo_compare_row1_meter"></td>
                <td data-i18n="reading_rhythm_tempo_compare_row1_tempo"></td>
                <td data-i18n="reading_rhythm_tempo_compare_row1_comment"></td>
              </tr>
              <tr>
                <td data-i18n="reading_rhythm_tempo_compare_row2_meter"></td>
                <td data-i18n="reading_rhythm_tempo_compare_row2_tempo"></td>
                <td data-i18n="reading_rhythm_tempo_compare_row2_comment"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="tempo-note" data-i18n="reading_rhythm_tempo_compare_note"></p>
      </section>
      <section class="tempo-terms">
        <h4 class="h4" data-i18n="reading_rhythm_tempo_terms_heading"></h4>
        <p class="tempo-note" data-i18n="reading_rhythm_tempo_terms_intro"></p>
        <div class="table tempo-terms-table">
          <table>
            <thead>
              <tr>
                <th scope="col" data-i18n="reading_rhythm_tempo_terms_label"></th>
                <th scope="col" data-i18n="reading_rhythm_tempo_terms_range"></th>
                <th scope="col" data-i18n="reading_rhythm_tempo_terms_character"></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row" data-i18n="reading_rhythm_tempo_term_largo"></th>
                <td data-i18n="reading_rhythm_tempo_term_largo_range"></td>
                <td data-i18n="reading_rhythm_tempo_term_largo_character"></td>
              </tr>
              <tr>
                <th scope="row" data-i18n="reading_rhythm_tempo_term_adagio"></th>
                <td data-i18n="reading_rhythm_tempo_term_adagio_range"></td>
                <td data-i18n="reading_rhythm_tempo_term_adagio_character"></td>
              </tr>
              <tr>
                <th scope="row" data-i18n="reading_rhythm_tempo_term_andante"></th>
                <td data-i18n="reading_rhythm_tempo_term_andante_range"></td>
                <td data-i18n="reading_rhythm_tempo_term_andante_character"></td>
              </tr>
              <tr>
                <th scope="row" data-i18n="reading_rhythm_tempo_term_moderato"></th>
                <td data-i18n="reading_rhythm_tempo_term_moderato_range"></td>
                <td data-i18n="reading_rhythm_tempo_term_moderato_character"></td>
              </tr>
              <tr>
                <th scope="row" data-i18n="reading_rhythm_tempo_term_allegro"></th>
                <td data-i18n="reading_rhythm_tempo_term_allegro_range"></td>
                <td data-i18n="reading_rhythm_tempo_term_allegro_character"></td>
              </tr>
              <tr>
                <th scope="row" data-i18n="reading_rhythm_tempo_term_presto"></th>
                <td data-i18n="reading_rhythm_tempo_term_presto_range"></td>
                <td data-i18n="reading_rhythm_tempo_term_presto_character"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </article>

</div>
</section>
<section class="hidden" id="view-reading-theory-acc">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-theory-acc" data-i18n="common_back"></button></div>
<div class="stack stack-lg reading-acc-view">
  <div class="reading-acc-hero">
    <h2 class="h2" data-i18n="reading_theory_accidentals_title"></h2>
    <p class="sub" data-i18n="reading_acc_intro_text" data-i18n-html="1"></p>
  </div>

  <article class="list-card reading-acc-card reading-acc-halfsteps">
    <div class="stack stack-md">
      <h3 class="h3" data-i18n="reading_acc_halfstep_title"></h3>
      <p data-i18n="reading_acc_halfstep_p1" data-i18n-html="1"></p>
      <p data-i18n="reading_acc_halfstep_p2a" data-i18n-html="1"></p>
      <div class="reading-acc-staff" id="acc-natural-staff"></div>
      <p data-i18n="reading_acc_halfstep_p2b_intro" data-i18n-html="1"></p>
      <p class="note" data-i18n="reading_acc_halfstep_p2c_intro" data-i18n-html="1"></p>
      <ul class="list">
        <li data-i18n="reading_acc_halfstep_p2b_item1" data-i18n-html="1"></li>
        <li data-i18n="reading_acc_halfstep_p2b_item2" data-i18n-html="1"></li>
      </ul>
      <p data-i18n="reading_acc_halfstep_line" data-i18n-html="1"></p>
      <h4 class="h5" data-i18n="reading_acc_halfstep_natural_heading" data-i18n-html="1"></h4>
      <ul class="list">
        <li data-i18n="reading_acc_halfstep_natural_item1" data-i18n-html="1"></li>
        <li data-i18n="reading_acc_halfstep_natural_item2" data-i18n-html="1"></li>
      </ul>
      <p data-i18n="reading_acc_halfstep_natural_text" data-i18n-html="1"></p>
      <div class="list-card note-table">
        <table>
          <thead>
            <tr>
              <th data-i18n="reading_acc_step_from"></th>
              <th data-i18n="reading_acc_step_to"></th>
              <th data-i18n="reading_acc_step_type"></th>
            </tr>
          </thead>
          <tbody>
            <tr><td>C</td><td>D</td><td data-i18n="reading_acc_step_whole"></td></tr>
            <tr><td>D</td><td>E</td><td data-i18n="reading_acc_step_whole"></td></tr>
            <tr><td>E</td><td>F</td><td data-i18n="reading_acc_step_half"></td></tr>
            <tr><td>F</td><td>G</td><td data-i18n="reading_acc_step_whole"></td></tr>
            <tr><td>G</td><td>A</td><td data-i18n="reading_acc_step_whole"></td></tr>
            <tr><td>A</td><td>H</td><td data-i18n="reading_acc_step_whole"></td></tr>
            <tr><td>H</td><td>C</td><td data-i18n="reading_acc_step_half"></td></tr>
          </tbody>
        </table>
      </div>
      <p data-i18n="reading_acc_halfstep_table_note"></p>
      <p class="note" data-i18n="reading_acc_halfstep_piano"></p>
    </div>
    <div class="reading-acc-demo">
      <div class="reading-acc-demo-head">
        <h4 class="h5" data-i18n="reading_acc_halfstep_play_heading"></h4>
      </div>
      <div class="acc-pairs-grid" id="acc-pairs"></div>
    </div>
  </article>

  <article class="list-card reading-acc-card reading-acc-what">
    <div class="stack stack-md">
      <h3 class="h3" data-i18n="reading_acc_accidentals_title"></h3>
      <div class="stack stack-sm" data-i18n="reading_acc_accidentals_rich" data-i18n-html="1"></div>
    </div>
    <div class="reading-acc-grid">
      <div class="reading-acc-demo" data-kind="sharp">
        <div class="stack stack-sm">
          <h4 class="h4" data-i18n="reading_acc_sharp_title"></h4>
        </div>
        <div class="acc-variant-grid" id="acc-sharp-grid"></div>
      </div>
      <div class="reading-acc-demo" data-kind="flat">
        <div class="stack stack-sm">
          <h4 class="h4" data-i18n="reading_acc_flat_title"></h4>
        </div>
        <div class="acc-variant-grid" id="acc-flat-grid"></div>
      </div>
    </div>
    <div class="reading-acc-doubles">
      <h4 class="h4" data-i18n="reading_acc_doubles_title"></h4>
      <div class="reading-acc-doubles-grid">
        <div class="reading-acc-double">
          <h5 class="h5" data-i18n="reading_acc_double_sharp"></h5>
          <p data-i18n="reading_acc_double_sharp_examples"></p>
        </div>
        <div class="reading-acc-double">
          <h5 class="h5" data-i18n="reading_acc_double_flat"></h5>
          <p data-i18n="reading_acc_double_flat_examples"></p>
        </div>
      </div>
    </div>
  </article>

  <article class="list-card reading-acc-card reading-acc-chromatic">
    <h3 class="h3" data-i18n="reading_acc_chromatic_title"></h3>
    <p data-i18n="reading_acc_chromatic_intro" data-i18n-html="1"></p>
    <div class="reading-acc-chromatic-panel">
      <div class="reading-acc-toggle">
        <div class="chip-row" id="acc-spelling-toggle"></div>
      </div>
      <div class="reading-acc-staff" id="acc-chromatic-staff"></div>
      <div class="btns">
        <button class="btn btn-green" id="acc-chromatic-play" data-i18n="reading_acc_chromatic_play" type="button"></button>
      </div>
    </div>
    <p data-i18n="reading_acc_chromatic_text" data-i18n-html="1"></p>
  </article>

  <article class="list-card reading-acc-card reading-acc-scale">
    <div class="stack stack-md">
      <h3 class="h3" data-i18n="reading_acc_scale_title"></h3>
      <p data-i18n="reading_acc_scale_intro" data-i18n-html="1"></p>
      <p class="note" data-i18n="reading_acc_scale_note" data-i18n-html="1"></p>
    </div>
    <div class="reading-acc-scale-panel">
      <div class="chip-row reading-acc-scale-spelling" id="acc-scale-spelling"></div>
      <div class="reading-acc-staff" id="acc-scale-staff"></div>
      <div class="reading-acc-scale-actions">
        <button class="btn btn-green" id="acc-scale-play" data-i18n="reading_acc_scale_play" type="button"></button>
        <div class="reading-acc-scale-transpose" aria-live="polite">
          <button class="btn btn-ghost" id="acc-scale-down" type="button" data-i18n="reading_acc_scale_down"></button>
          <div class="reading-acc-scale-label">
            <span class="hint" data-i18n="reading_acc_scale_label"></span>
            <strong id="acc-scale-label"></strong>
          </div>
          <button class="btn btn-ghost" id="acc-scale-up" type="button" data-i18n="reading_acc_scale_up"></button>
        </div>
      </div>
    </div>
  </article>

  <article class="list-card reading-acc-card reading-acc-keyboard">
    <h3 class="h3" data-i18n="reading_acc_keyboard_title"></h3>
    <p data-i18n="reading_acc_keyboard_intro" data-i18n-html="1"></p>
    <div class="reading-acc-keyboard-wrap">
      <div class="chip-row" id="acc-keyboard-spelling"></div>
      <div class="reading-acc-staff small" id="acc-keyboard-staff"></div>
      <div class="acc-keyboard" id="acc-keyboard"></div>
    </div>
    <p data-i18n="reading_acc_keyboard_text" data-i18n-html="1"></p>
  </article>

  <article class="list-card reading-acc-card reading-acc-signature">
    <h3 class="h3" data-i18n="reading_acc_signature_title"></h3>
    <p data-i18n="reading_acc_signature_intro"></p>
    <div class="reading-acc-signature-grid is-column">
      <div class="reading-acc-signature-block">
        <h4 class="h5" data-i18n="reading_acc_signature_acc_heading"></h4>
        <p data-i18n="reading_acc_signature_p1" data-i18n-html="1"></p>
        <p data-i18n="reading_acc_signature_p2" data-i18n-html="1"></p>
      </div>
      <div class="reading-acc-signature-block">
        <h4 class="h5" data-i18n="reading_acc_signature_key_heading"></h4>
        <p data-i18n="reading_acc_signature_p3" data-i18n-html="1"></p>
        <p data-i18n="reading_acc_signature_p4" data-i18n-html="1"></p>
        <p data-i18n="reading_acc_signature_p5" data-i18n-html="1"></p>
        <p data-i18n="reading_acc_signature_p6" data-i18n-html="1"></p>
        <p data-i18n="reading_acc_signature_p7" data-i18n-html="1"></p>
      </div>
    </div>
    <div class="reading-acc-demo reading-acc-signature-demo">
    <div class="reading-acc-signature-staff">
      <div class="reading-acc-staff" data-label="signature">
        <div class="reading-acc-staff-label" data-i18n="reading_acc_signature_staff_signature"></div>
        <div class="reading-acc-staff-figure" id="acc-signature-staff"></div>
        <div class="btns">
          <button class="btn btn-green" id="acc-signature-play-key" data-i18n="reading_acc_action_play"></button>
        </div>
      </div>
      <div class="reading-acc-staff" data-label="accidentals">
        <div class="reading-acc-staff-label" data-i18n="reading_acc_signature_staff_acc"></div>
        <div class="reading-acc-staff-figure" id="acc-accidental-staff"></div>
        <div class="btns">
          <button class="btn btn-green" id="acc-signature-play-acc" data-i18n="reading_acc_action_play"></button>
        </div>
      </div>
    </div>
    </div>
    <p class="note" data-i18n="reading_acc_signature_p8"></p>
  </article>

  <article class="list-card reading-acc-card">
    <div class="stack stack-md">
      <h3 class="h3" data-i18n="reading_acc_natural_title"></h3>
      <p data-i18n="reading_acc_natural_text" data-i18n-html="1"></p>
      <p data-i18n="reading_acc_natural_scope" data-i18n-html="1"></p>
      <p data-i18n="reading_acc_natural_demo_intro" data-i18n-html="1"></p>
      <div class="reading-acc-staff" id="acc-natural-demo-staff"></div>
      <div class="btns">
        <button class="btn btn-green" id="acc-natural-demo-play" data-i18n="reading_acc_action_play" type="button"></button>
      </div>
    </div>
  </article>

  <article class="list-card reading-acc-card">
    <h3 class="h3" data-i18n="reading_acc_cautionary_title"></h3>
    <p data-i18n="reading_acc_cautionary_text" data-i18n-html="1"></p>
    <p data-i18n="reading_acc_cautionary_demo_intro" data-i18n-html="1"></p>
    <div class="reading-acc-staff" id="acc-cautionary-demo-staff"></div>
    <div class="btns">
      <button class="btn btn-green" id="acc-cautionary-demo-play" data-i18n="reading_acc_action_play" type="button"></button>
    </div>
  </article>

</div>
</section>
<section class="hidden" id="view-reading-theory-articulation">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-theory-articulation" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="reading_theory_articulation_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="reading_theory_articulation_annotation"></p>
</div>
</section>
<section class="hidden" id="view-reading-theory-marks">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-theory-marks" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="reading_theory_marks_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="reading_theory_marks_annotation"></p>
</div>
</section>
<section class="hidden" id="view-reading-theory-navigation">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-theory-navigation" data-i18n="common_back"></button></div>
<div class="list-card stack stack-md">
  <h2 class="h2" data-i18n="reading_theory_navigation_title"></h2>
  <p class="sub" data-i18n="page_in_preparation"></p>
  <p data-i18n="reading_theory_navigation_annotation"></p>
</div>
</section>
<section class="hidden" id="view-reading-place">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-place" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="reading_place_title"></h2>
<div class="stack stack-lg reading-place-wrapper">
  <article class="list-card reading-place-setup" id="reading-place-setup">
    <div class="stack stack-md">
      <p class="sub" data-i18n="reading_place_intro"></p>
      <div class="reading-place-config">
        <div class="reading-place-param">
          <div class="param-label" data-i18n="reading_place_param_clef"></div>
          <div class="chip-row" id="reading-place-clefs"></div>
        </div>
        <div class="reading-place-param reading-place-param-range">
          <div class="param-label" data-i18n="reading_place_param_range"></div>
          <div class="range-picker range-picker-slider">
            <div class="range-slider" id="reading-place-range"></div>
            <div class="range-picker-values">
              <span>
                <span class="range-picker-label" data-i18n="reading_place_param_range_start"></span>
                <strong id="reading-place-range-start-label"></strong>
              </span>
              <span>
                <span class="range-picker-label" data-i18n="reading_place_param_range_end"></span>
                <strong id="reading-place-range-end-label"></strong>
              </span>
            </div>
          </div>
        </div>
        <div class="reading-place-param">
          <div class="param-label" data-i18n="reading_place_param_count"></div>
          <div class="chip-row" id="reading-place-count"></div>
        </div>
      </div>
      <div class="btns">
        <button class="btn btn-green" id="reading-place-start" data-i18n="reading_place_start"></button>
      </div>
    </div>
  </article>

  <article class="list-card reading-place-test hidden" id="reading-place-test">
    <div class="reading-place-status">
      <div class="reading-place-progress" id="reading-place-progress"></div>
      <p class="section-hint" id="reading-place-instruction" data-i18n="reading_place_instruction"></p>
    </div>
    <div class="reading-place-staff">
      <div class="reading-place-staff-inner" id="reading-place-staff"></div>
    </div>
    <div class="reading-place-controls">
      <button class="btn btn-green" id="reading-place-evaluate" data-i18n="reading_place_evaluate"></button>
      <button class="btn btn-ghost" id="reading-place-reset" data-i18n="reading_place_reset"></button>
    </div>
  </article>

  <article class="list-card reading-place-summary hidden" id="reading-place-summary">
    <div class="reading-place-summary-grid">
      <div class="reading-place-summary-chart">
        <canvas class="chart" id="reading-place-chart" width="220" height="220"></canvas>
        <div class="reading-place-summary-metrics">
          <div><span data-i18n="reading_place_summary_correct"></span>: <span id="reading-place-summary-correct"></span></div>
          <div><span data-i18n="reading_place_summary_wrong"></span>: <span id="reading-place-summary-wrong"></span></div>
        </div>
        <div class="reading-place-summary-note">
          <div class="reading-place-summary-motto" id="reading-place-summary-motto"></div>
          <div class="badge big reading-place-summary-badge" id="reading-place-summary-badge"></div>
        </div>
      </div>
      <div class="reading-place-summary-staff" id="reading-place-summary-staff"></div>
    </div>
    <div class="btns">
      <button class="btn btn-green" id="reading-place-restart" data-i18n="reading_place_restart"></button>
      <button class="btn btn-ghost" id="reading-place-back" data-i18n="reading_place_back"></button>
    </div>
  </article>
</div>
</section>
<section class="hidden" id="view-reading-rhythm">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-sight" id="back-reading-rhythm" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="reading_rhythm_practice_title"></h2>
<p class="sub" data-i18n="reading_rhythm_practice_intro"></p>
<div class="stack stack-lg rrp-layout">
  <article class="list-card rrp-setup" id="rrp-setup">
    <div class="rrp-setup-grid">
      <div class="rrp-card">
        <h3 class="h4" data-i18n="reading_rhythm_practice_counts"></h3>
        <div class="chip-row" id="rrp-counts"></div>
      </div>
      <div class="rrp-card">
        <h3 class="h4" data-i18n="reading_rhythm_practice_meters"></h3>
        <div class="chip-row" id="rrp-meters"></div>
      </div>
    </div>
    <div class="setup-actions">
      <button class="btn btn-green" id="rrp-start" data-i18n="reading_rhythm_practice_start"></button>
    </div>
  </article>

  <article class="list-card rrp-quiz hidden" id="rrp-quiz">
    <div class="toolbar">
      <div class="badge" id="rrp-progress"></div>
      <span class="sp"></span>
      <button class="btn btn-ghost" id="rrp-reset" data-i18n="reading_rhythm_practice_reset" type="button"></button>
      <button class="btn btn-ghost" id="rrp-back" data-i18n="reading_rhythm_practice_back" type="button"></button>
    </div>
    <div class="rrp-bar">
      <div class="rrp-meter" id="rrp-meter"></div>
      <div class="rrp-staff" id="rrp-staff" aria-live="polite"></div>
    </div>
    <div class="rrp-palette">
      <div class="rrp-palette-group">
        <h4 class="h5" data-i18n="reading_rhythm_practice_palette_pool"></h4>
        <div class="chip-row" id="rrp-palette"></div>
      </div>
    </div>
    <div class="btns">
      <button class="btn btn-ghost" id="rrp-prev" data-i18n="common_prev" type="button"></button>
      <button class="btn btn-green" id="rrp-next" data-i18n="reading_rhythm_practice_next" type="button"></button>
    </div>
  </article>

  <article class="list-card rrp-summary hidden" id="rrp-summary">
    <h3 class="h3" data-i18n="reading_rhythm_practice_summary_title"></h3>
    <div class="rrp-summary-hero">
      <canvas class="chart" id="rrp-summary-chart" width="220" height="220"></canvas>
      <div class="rrp-summary-meta">
        <div><span data-i18n="reading_rhythm_practice_summary_correct"></span>: <strong id="rrp-summary-correct"></strong></div>
        <div><span data-i18n="reading_rhythm_practice_summary_wrong"></span>: <strong id="rrp-summary-wrong"></strong></div>
        <p class="rrp-summary-motto" id="rrp-summary-motto"></p>
      </div>
    </div>
    <div class="summary-list" id="rrp-summary-list"></div>
    <div class="btns">
      <button class="btn btn-green" id="rrp-again" data-i18n="reading_rhythm_practice_summary_again"></button>
      <button class="btn btn-ghost" id="rrp-select" data-i18n="reading_rhythm_practice_summary_select"></button>
      <button class="btn btn-ghost" data-action="nav" data-to="view-home" id="rrp-home" data-i18n="common_back"></button>
    </div>
  </article>
</div>
</section>
<section class="hidden" id="view-scales-info">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-scales-hub" id="back-scales-info" data-i18n="common_back"></button></div>
<div class="stack stack-lg info-scales">
  <h2 class="h2" data-i18n="info_scales_title"></h2>
  <article class="list-card info-card">
    <h3 class="h3 info-heading" data-i18n="info_intro_heading"></h3>
    <p data-i18n="info_intro_p1" data-i18n-html="1"></p>
    <p data-i18n="info_intro_p2" data-i18n-html="1"></p>
    <p data-i18n="info_intro_p3" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_intro_use_1" data-i18n-html="1"></li>
      <li data-i18n="info_intro_use_2" data-i18n-html="1"></li>
      <li data-i18n="info_intro_use_3" data-i18n-html="1"></li>
      <li data-i18n="info_intro_use_4" data-i18n-html="1"></li>
    </ul>
    <h4 class="h4" data-i18n="info_intro_world_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_intro_world_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_intro_world_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_intro_world_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_intro_world_item_3" data-i18n-html="1"></li>
      <li data-i18n="info_intro_world_item_4" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_intro_world_outro" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_intro_focus_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_intro_focus_intro" data-i18n-html="1"></p>
    <p data-i18n="info_intro_focus_list_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_intro_focus_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_intro_focus_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_intro_focus_item_3" data-i18n-html="1"></li>
      <li data-i18n="info_intro_focus_item_4" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_intro_focus_next_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_intro_focus_next_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_intro_focus_next_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_intro_focus_next_item_3" data-i18n-html="1"></li>
      <li data-i18n="info_intro_focus_next_item_4" data-i18n-html="1"></li>
    </ul>
  </article>
  <article class="list-card info-card">
    <h3 class="h3 info-heading" data-i18n="info_diff_heading" data-i18n-html="1"></h3>
    <p data-i18n="info_diff_p1" data-i18n-html="1"></p>
    <p data-i18n="info_diff_p2" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_diff_count_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_diff_count_p" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_diff_intervals_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_diff_intervals_p" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_diff_mood_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_diff_mood_p" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_diff_use_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_diff_use_p" data-i18n-html="1"></p>
    <p data-i18n="info_diff_outro" data-i18n-html="1"></p>
  </article>
  <article class="list-card info-card">
    <h3 class="h3 info-heading" data-i18n="info_core_types_heading" data-i18n-html="1"></h3>
    <p data-i18n="info_core_types_intro" data-i18n-html="1"></p>
    <div class="stack stack-lg">
  <article class="list-card info-card fold is-collapsed" data-fold="core-major">
    <div class="fold-head">
      <h3 class="h3 info-heading" data-i18n="info_major_heading" data-i18n-html="1"></h3>
      <button class="chip fold-toggle" type="button" aria-controls="info-fold-core-major" aria-expanded="false" data-i18n="common_expand"></button>
    </div>
    <div class="fold-body" id="info-fold-core-major">
    <p data-i18n="info_major_p1" data-i18n-html="1"></p>
    <p data-i18n="info_major_p2" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_major_parts_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_major_parts_p1" data-i18n-html="1"></p>
    <p data-i18n="info_major_parts_p2" data-i18n-html="1"></p>
    <p data-i18n="info_major_pattern_intro" data-i18n-html="1"></p>
    <p data-i18n="info_major_pattern_line" data-i18n-html="1"></p>
    <p data-i18n="info_major_pattern_note" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_major_look_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_major_look_p1" data-i18n-html="1"></p>
    <p data-i18n="info_major_look_p2" data-i18n-html="1"></p>
    <p data-i18n="info_major_look_notes" data-i18n-html="1"></p>
    <p data-i18n="info_major_look_p3" data-i18n-html="1"></p>
    <div class="info-staff" id="info-major-staff"></div>
    <div class="btns btns-center">
      <button class="btn btn-green" id="info-major-play" data-i18n="info_major_play" type="button"></button>
    </div>
    <h4 class="h4" data-i18n="info_major_sound_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_major_sound_p" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_major_sound_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_major_sound_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_major_sound_item_3" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_major_sound_note" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_major_use_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_major_use_p" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_major_use_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_major_use_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_major_use_item_3" data-i18n-html="1"></li>
    </ul>
    </div>
  </article>
  <article class="list-card info-card fold is-collapsed" data-fold="core-minor">
    <div class="fold-head">
      <h3 class="h3 info-heading" data-i18n="info_minor_heading"></h3>
      <button class="chip fold-toggle" type="button" aria-controls="info-fold-core-minor" aria-expanded="false" data-i18n="common_expand"></button>
    </div>
    <div class="fold-body" id="info-fold-core-minor">
    <p data-i18n="info_minor_p1"></p>
    <p data-i18n="info_minor_p2"></p>
    <p data-i18n="info_minor_p3"></p>
    <p data-i18n="info_minor_p4"></p>
    <p data-i18n="info_minor_p5"></p>
    <div class="fold fold-sub is-collapsed" data-fold="minor-natural">
      <div class="fold-head">
        <h3 class="h3 info-heading" data-i18n="info_harm_heading"></h3>
        <button class="chip fold-toggle" type="button" aria-controls="info-fold-minor-natural" aria-expanded="false" data-i18n="common_expand"></button>
      </div>
      <div class="fold-body" id="info-fold-minor-natural">
        <p data-i18n="info_harm_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harm_p2" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_harm_parts_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harm_parts_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harm_pattern_intro" data-i18n-html="1"></p>
        <p data-i18n="info_harm_pattern_line" data-i18n-html="1"></p>
        <p data-i18n="info_harm_pattern_note" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_harm_look_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harm_look_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harm_look_p2" data-i18n-html="1"></p>
        <p data-i18n="info_harm_look_notes" data-i18n-html="1"></p>
        <p data-i18n="info_harm_look_p3" data-i18n-html="1"></p>
        <div class="info-staff" id="info-harm-staff"></div>
        <div class="btns btns-center">
          <button class="btn btn-green" id="info-harm-play" data-i18n="info_harm_play" type="button"></button>
        </div>
        <h4 class="h4" data-i18n="info_harm_sound_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harm_sound_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_harm_sound_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_harm_sound_item_2" data-i18n-html="1"></li>
          <li data-i18n="info_harm_sound_item_3" data-i18n-html="1"></li>
          <li data-i18n="info_harm_sound_item_4" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_harm_sound_note" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_harm_use_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harm_use_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_harm_use_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_harm_use_item_2" data-i18n-html="1"></li>
          <li data-i18n="info_harm_use_item_3" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_harm_use_outro" data-i18n-html="1"></p>
      </div>
    </div>
    <div class="fold fold-sub is-collapsed" data-fold="minor-harmonic">
      <div class="fold-head">
        <h3 class="h3 info-heading" data-i18n="info_harmonic_heading" data-i18n-html="1"></h3>
        <button class="chip fold-toggle" type="button" aria-controls="info-fold-minor-harmonic" aria-expanded="false" data-i18n="common_expand"></button>
      </div>
      <div class="fold-body" id="info-fold-minor-harmonic">
        <p data-i18n="info_harmonic_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_p2" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_harmonic_parts_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harmonic_parts_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_pattern_intro" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_pattern_line" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_pattern_note" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_harmonic_look_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harmonic_look_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_look_p2" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_look_notes" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_look_p3" data-i18n-html="1"></p>
        <div class="info-staff" id="info-harmonic-staff"></div>
        <div class="btns btns-center">
          <button class="btn btn-green" id="info-harmonic-play" data-i18n="info_harmonic_play" type="button"></button>
        </div>
        <h4 class="h4" data-i18n="info_harmonic_sound_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harmonic_sound_p1" data-i18n-html="1"></p>
        <p data-i18n="info_harmonic_sound_p2" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_harmonic_use_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_harmonic_use_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_harmonic_use_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_harmonic_use_item_2" data-i18n-html="1"></li>
          <li data-i18n="info_harmonic_use_item_3" data-i18n-html="1"></li>
          <li data-i18n="info_harmonic_use_item_4" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_harmonic_use_outro" data-i18n-html="1"></p>
      </div>
    </div>
    <div class="fold fold-sub is-collapsed" data-fold="minor-melodic">
      <div class="fold-head">
        <h3 class="h3 info-heading" data-i18n="info_mel_heading"></h3>
        <button class="chip fold-toggle" type="button" aria-controls="info-fold-minor-melodic" aria-expanded="false" data-i18n="common_expand"></button>
      </div>
      <div class="fold-body" id="info-fold-minor-melodic">
        <p data-i18n="info_mel_p1" data-i18n-html="1"></p>
        <p data-i18n="info_mel_p2" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_mel_parts_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_mel_parts_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_mel_parts_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_mel_parts_item_2" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_mel_parts_note" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_mel_look_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_mel_look_p1" data-i18n-html="1"></p>
        <p data-i18n="info_mel_look_up_intro" data-i18n-html="1"></p>
        <p data-i18n="info_mel_look_up_notes" data-i18n-html="1"></p>
        <p data-i18n="info_mel_look_down_intro" data-i18n-html="1"></p>
        <p data-i18n="info_mel_look_down_notes" data-i18n-html="1"></p>
        <p data-i18n="info_mel_look_note" data-i18n-html="1"></p>
        <div class="info-staff info-staff-wide" id="info-mel-staff"></div>
        <div class="btns btns-center">
          <button class="btn btn-green" id="info-mel-play" data-i18n="info_mel_play" type="button"></button>
        </div>
        <h4 class="h4" data-i18n="info_mel_sound_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_mel_sound_p" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_mel_use_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_mel_use_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_mel_use_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_mel_use_item_2" data-i18n-html="1"></li>
          <li data-i18n="info_mel_use_item_3" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_mel_use_outro" data-i18n-html="1"></p>
      </div>
    </div>
    </div>
  </article>
  <article class="list-card info-card fold is-collapsed" data-fold="core-penta">
    <div class="fold-head">
      <h3 class="h3 info-heading" data-i18n="info_penta_heading" data-i18n-html="1"></h3>
      <button class="chip fold-toggle" type="button" aria-controls="info-fold-core-penta" aria-expanded="false" data-i18n="common_expand"></button>
    </div>
    <div class="fold-body" id="info-fold-core-penta">
    <p data-i18n="info_penta_intro_p1" data-i18n-html="1"></p>
    <p data-i18n="info_penta_intro_p2" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_penta_popular_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_penta_popular_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_penta_popular_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_penta_popular_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_penta_popular_item_3" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_penta_popular_outro" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_penta_major_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_penta_major_p1" data-i18n-html="1"></p>
    <p data-i18n="info_penta_major_example_intro" data-i18n-html="1"></p>
    <p data-i18n="info_penta_major_example" data-i18n-html="1"></p>
    <p data-i18n="info_penta_major_traits_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_penta_major_trait_1" data-i18n-html="1"></li>
      <li data-i18n="info_penta_major_trait_2" data-i18n-html="1"></li>
      <li data-i18n="info_penta_major_trait_3" data-i18n-html="1"></li>
    </ul>
    <h4 class="h4" data-i18n="info_penta_minor_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_penta_minor_p1" data-i18n-html="1"></p>
    <p data-i18n="info_penta_minor_example_intro" data-i18n-html="1"></p>
    <p data-i18n="info_penta_minor_example" data-i18n-html="1"></p>
    <p data-i18n="info_penta_minor_use_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_penta_minor_use_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_penta_minor_use_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_penta_minor_use_item_3" data-i18n-html="1"></li>
    </ul>
    <h4 class="h4" data-i18n="info_penta_blue_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_penta_blue_p1" data-i18n-html="1"></p>
    <p data-i18n="info_penta_blue_p2" data-i18n-html="1"></p>
    <p data-i18n="info_penta_blue_p3" data-i18n-html="1"></p>
    <p class="note" data-i18n="info_penta_blue_p4" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_penta_demo_heading" data-i18n-html="1"></h4>
    <p class="sub" data-i18n="info_penta_mode_label" data-i18n-html="1"></p>
    <div class="chip-wrap chip-wrap-center" id="info-penta-mode"></div>
    <p class="sub" data-i18n="info_penta_root_label" data-i18n-html="1"></p>
    <div class="chip-wrap chip-wrap-center" id="info-penta-root"></div>
    <div class="info-staff" id="info-penta-staff"></div>
    <div class="btns btns-center">
      <button class="btn btn-green" id="info-penta-play" data-i18n="info_penta_play" type="button"></button>
    </div>
    </div>
  </article>
    </div>
  </article>
  <article class="list-card info-card">
    <h3 class="h3 info-heading" data-i18n="info_relation_heading" data-i18n-html="1"></h3>
    <p data-i18n="info_relation_p1" data-i18n-html="1"></p>
    <h4 class="h4" data-i18n="info_relation_rel_heading" data-i18n-html="1"></h4>
    <p data-i18n="info_relation_rel_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_relation_rel_item_1" data-i18n-html="1"></li>
      <li data-i18n="info_relation_rel_item_2" data-i18n-html="1"></li>
      <li data-i18n="info_relation_rel_item_3" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_relation_rel_examples_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_relation_rel_example_1" data-i18n-html="1"></li>
      <li data-i18n="info_relation_rel_example_2" data-i18n-html="1"></li>
      <li data-i18n="info_relation_rel_example_3" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_relation_rel_note" data-i18n-html="1"></p>
    <div class="fold fold-sub is-collapsed" data-fold="relation-detail">
      <div class="fold-head">
        <h4 class="h4" data-i18n="info_relation_center_heading" data-i18n-html="1"></h4>
        <button class="chip fold-toggle" type="button" aria-controls="info-fold-relation-detail" aria-expanded="false" data-i18n="common_expand"></button>
      </div>
      <div class="fold-body" id="info-fold-relation-detail">
        <p data-i18n="info_relation_center_p1" data-i18n-html="1"></p>
        <p data-i18n="info_relation_center_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_relation_center_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_relation_center_item_2" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_relation_center_note" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_relation_signature_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_relation_signature_p1" data-i18n-html="1"></p>
        <p data-i18n="info_relation_signature_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_relation_signature_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_relation_signature_item_2" data-i18n-html="1"></li>
        </ul>
        <h4 class="h4" data-i18n="info_relation_find_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_relation_find_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_relation_find_item_1" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_relation_find_examples_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_relation_find_example_1" data-i18n-html="1"></li>
          <li data-i18n="info_relation_find_example_2" data-i18n-html="1"></li>
          <li data-i18n="info_relation_find_example_3" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_relation_find_note" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_relation_importance_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_relation_importance_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_relation_importance_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_relation_importance_item_2" data-i18n-html="1"></li>
          <li data-i18n="info_relation_importance_item_3" data-i18n-html="1"></li>
        </ul>
        <p data-i18n="info_relation_importance_outro" data-i18n-html="1"></p>
      </div>
    </div>
  </article>
  <article class="list-card info-card">
    <h3 class="h3 info-heading" data-i18n="info_modes_heading" data-i18n-html="1"></h3>
    <p data-i18n="info_modes_p1" data-i18n-html="1"></p>
    <p data-i18n="info_modes_p2" data-i18n-html="1"></p>
    <div class="fold fold-sub is-collapsed" data-fold="modes-detail">
      <div class="fold-head">
        <h4 class="h4" data-i18n="info_modes_same_heading" data-i18n-html="1"></h4>
        <button class="chip fold-toggle" type="button" aria-controls="info-fold-modes-detail" aria-expanded="false" data-i18n="common_expand"></button>
      </div>
      <div class="fold-body" id="info-fold-modes-detail">
        <p data-i18n="info_modes_same_intro" data-i18n-html="1"></p>
        <p data-i18n="info_modes_same_quote" data-i18n-html="1"></p>
        <p data-i18n="info_modes_same_p1" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_modes_same_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_modes_same_item_2" data-i18n-html="1"></li>
        </ul>
        <h4 class="h4" data-i18n="info_modes_history_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_modes_history_p1" data-i18n-html="1"></p>
        <p data-i18n="info_modes_history_p2" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_modes_list_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_modes_list_intro" data-i18n-html="1"></p>
        <p data-i18n="info_modes_ionian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_ionian_text" data-i18n-html="1"></p>
        <p data-i18n="info_modes_dorian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_dorian_text" data-i18n-html="1"></p>
        <p data-i18n="info_modes_phrygian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_phrygian_text" data-i18n-html="1"></p>
        <p data-i18n="info_modes_lydian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_lydian_text" data-i18n-html="1"></p>
        <p data-i18n="info_modes_mixolydian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_mixolydian_text" data-i18n-html="1"></p>
        <p data-i18n="info_modes_aeolian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_aeolian_text" data-i18n-html="1"></p>
        <p data-i18n="info_modes_locrian_title" data-i18n-html="1"></p>
        <p data-i18n="info_modes_locrian_text" data-i18n-html="1"></p>
        <h4 class="h4" data-i18n="info_modes_importance_heading" data-i18n-html="1"></h4>
        <p data-i18n="info_modes_importance_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_modes_importance_item_1" data-i18n-html="1"></li>
          <li data-i18n="info_modes_importance_item_2" data-i18n-html="1"></li>
          <li data-i18n="info_modes_importance_item_3" data-i18n-html="1"></li>
          <li data-i18n="info_modes_importance_item_4" data-i18n-html="1"></li>
        </ul>
      </div>
    </div>
  </article>
  <article class="list-card info-card">
    <h3 class="h3 info-heading" data-i18n="info_shift_heading" data-i18n-html="1"></h3>
    <p data-i18n="info_shift_p1" data-i18n-html="1"></p>
    <p data-i18n="info_shift_p2" data-i18n-html="1"></p>
    <p data-i18n="info_shift_p3" data-i18n-html="1"></p>
    <p data-i18n="info_shift_list_intro" data-i18n-html="1"></p>
    <ul class="info-list">
      <li data-i18n="info_shift_list_1" data-i18n-html="1"></li>
      <li data-i18n="info_shift_list_2" data-i18n-html="1"></li>
      <li data-i18n="info_shift_list_3" data-i18n-html="1"></li>
      <li data-i18n="info_shift_list_4" data-i18n-html="1"></li>
    </ul>
    <p data-i18n="info_shift_p4" data-i18n-html="1"></p>
    <p data-i18n="info_shift_p5" data-i18n-html="1"></p>
    <p class="sub" data-i18n="info_shift_pick" data-i18n-html="1"></p>
    <div class="chip-wrap chip-wrap-center" id="info-shift-keys"></div>
    <div class="info-staff" id="info-shift-staff"></div>
    <div class="btns btns-center">
      <button class="btn btn-green" id="info-shift-play" data-i18n="info_shift_play" type="button"></button>
    </div>
    <div class="fold fold-sub is-collapsed" data-fold="shift-enharm">
      <div class="fold-head">
        <h4 class="h4" data-i18n="info_shift_enharm_heading" data-i18n-html="1"></h4>
        <button class="chip fold-toggle" type="button" aria-controls="info-fold-shift-enharm" aria-expanded="false" data-i18n="common_expand"></button>
      </div>
      <div class="fold-body" id="info-fold-shift-enharm">
        <p data-i18n="info_shift_enharm_p1" data-i18n-html="1"></p>
        <p data-i18n="info_shift_enharm_p2" data-i18n-html="1"></p>
        <p data-i18n="info_shift_enharm_examples_intro" data-i18n-html="1"></p>
        <ul class="info-list">
          <li data-i18n="info_shift_enharm_example_1" data-i18n-html="1"></li>
          <li data-i18n="info_shift_enharm_example_2" data-i18n-html="1"></li>
        </ul>
        <div class="info-enharm-grid">
          <div class="info-enharm-card">
            <p class="sub info-enharm-label" data-i18n="info_shift_enharm_label_fsharp" data-i18n-html="1"></p>
            <div class="info-staff info-staff-wide" id="info-shift-enharm-fsharp"></div>
          </div>
          <div class="info-enharm-card">
            <p class="sub info-enharm-label" data-i18n="info_shift_enharm_label_gflat" data-i18n-html="1"></p>
            <div class="info-staff info-staff-wide" id="info-shift-enharm-gflat"></div>
          </div>
        </div>
      </div>
    </div>
  </article>
</div>
</section>
<section class="hidden" id="view-scales">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="scales_title"></h2>
<p class="sub" data-i18n="scales_table_intro"></p>
<table id="scales-table"><thead><tr><th data-i18n="scales_tbl_moll"></th><th data-i18n="scales_tbl_major"></th><th data-i18n="scales_tbl_acc"></th></tr></thead><tbody></tbody></table>
</section>
<section class="hidden" id="view-detail">
<div class="toolbar"><button class="btn btn-ghost" data-action="back" id="back-dynamic" data-i18n="detail_back"></button><div class="badge" id="detail-badge"></div></div>
<h2 class="h2" id="detail-heading"></h2>
<div class="grid-2">
<div class="list-card"><h3 class="h3" data-i18n="detail_minor7"></h3><div id="list-minor7"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_harmonic_minor"></h3><div id="list-harmonic"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_melodic_minor"></h3><div id="list-melodic"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_major7"></h3><div id="list-major7"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_penta_minor"></h3><div id="list-minorP"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_penta_major"></h3><div id="list-majorP"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_triad_minor"></h3><div id="triad-minor"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_triad_major"></h3><div id="triad-major"></div></div>
<div class="list-card"><h3 class="h3" data-i18n="detail_blue"></h3><div id="blue-note"></div></div>
</div>
<div class="detail-scale-staff-panel">
  <article class="list-card detail-scale-card">
    <div class="detail-scale-head">
      <div class="detail-scale-caption">
        <span class="detail-scale-variant-label" id="detail-scale-variant-label"></span>
        <span class="detail-scale-variant-notes" id="detail-scale-variant-notes"></span>
      </div>
      <div class="chip-wrap detail-scale-variant-chips" id="detail-scale-variants"></div>
    </div>
    <div class="detail-scale-actions">
      <button class="btn btn-green" id="detail-scale-play" data-i18n="detail_scale_play" type="button"></button>
    </div>
    <div class="detail-scale-staff-wrapper">
      <div class="detail-scale-staff" id="detail-scale-staff"></div>
    </div>
  </article>
</div>
</section>
<section class="hidden" id="view-build-select">
<div class="toolbar">
<button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-2" data-i18n="common_back"></button>
<button class="btn btn-green" disabled="" id="start-quiz" data-i18n="common_next"></button>
<span class="sp"></span>
<button class="btn btn-ghost" id="btn-select-all" data-i18n="select_all"></button>
<button class="btn btn-ghost" id="btn-clear-all" data-i18n="clear_all"></button>
</div>
<h2 class="h2" data-i18n="build_select_title"></h2>
<p class="sub" data-i18n="build_select_hint"></p>
<article class="list-card">
  <h3 class="h3" data-i18n="build_select_type_title"></h3>
  <p class="sub" data-i18n="build_select_type_hint"></p>
  <div class="chip-wrap" id="build-type-chips"></div>
</article>
<div id="practice-list"></div>
</section>
<section class="hidden" id="view-build-quiz">
<div class="toolbar">
<button class="btn btn-ghost" data-action="back" id="back-select" data-i18n="common_back_to_select"></button>
<button class="btn btn-ghost" id="open-detail-from-quiz" data-i18n="common_detail_scale"></button>
<div class="badge" id="quiz-prog"></div>
</div>
<h2 class="h2" id="quiz-heading"></h2>
<div class="stack stack-md">
  <div class="list-card" id="build-card-ks"><h3 class="h3" id="build-heading-ks" data-i18n="build_quiz_heading_acc"></h3><div class="chip-wrap" id="ks-chips"></div></div>
  <div class="list-card" id="build-card-scale"><h3 class="h3" id="build-heading-scale" data-i18n="build_quiz_heading_penta"></h3><div class="chip-wrap" id="pent-chips"></div></div>
  <div class="list-card" id="build-card-blue"><h3 class="h3" id="build-heading-blue" data-i18n="build_quiz_heading_blue"></h3><div class="chip-wrap" id="blue-chips"></div></div>
  <div class="btns">
  <button class="btn btn-ghost" id="btn-prev" data-i18n="common_prev"></button>
  <button class="btn btn-ghost" id="btn-next" data-i18n="common_next"></button>
  </div>
</div>
</section>
<section class="hidden" id="view-build-summary">
<div class="toolbar">
<button class="btn btn-green" id="sum-build-home" data-i18n="sum_home"></button>
<button class="btn btn-ghost" id="sum-build-retry" data-i18n="sum_retry"></button>
</div>
<div class="grid-2">
<div class="list-card">
<h2 class="h2" data-i18n="sum_build_title"></h2>
<canvas class="chart" height="300" id="build-chart" width="300"></canvas>
<div class="sub" id="build-motto"></div>
<div class="badge big" id="build-badge"></div>
</div>
<div class="summary-list" id="build-summary-list"></div>
</div>
</section>
<section class="hidden" id="view-ksquiz">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-3" data-i18n="common_back"></button></div>
<h2 class="h2" data-i18n="ksq_title"></h2>
<div class="list-card" id="ksq-choose">
<div class="sub" data-i18n="ksq_pick_len"></div>
<div class="btns">
<button class="btn btn-ghost ksq-pick" data-rounds="3" data-i18n="ksq_3"></button>
<button class="btn btn-ghost ksq-pick" data-rounds="5" data-i18n="ksq_5"></button>
<button class="btn btn-ghost ksq-pick" data-rounds="10" data-i18n="ksq_10"></button>
</div>
</div>
<div class="hidden" id="ksq-wrap">
<div class="toolbar"><div class="badge" id="ksq-prog"></div></div>
<div class="stack stack-md">
  <div class="list-card"><h3 class="h3" data-i18n="ksq_heading_acc"></h3><div class="strong" id="ksq-sign"></div></div>
  <div class="grid-2">
  <div class="list-card"><h3 class="h3" data-i18n="ksq_pick_major"></h3><div class="chip-wrap" id="ksq-major"></div></div>
  <div class="list-card"><h3 class="h3" data-i18n="ksq_pick_minor"></h3><div class="chip-wrap" id="ksq-minor"></div></div>
  </div>
  <div class="btns">
  <button class="btn btn-ghost" id="ksq-prev" data-i18n="common_prev"></button>
  <button class="btn btn-ghost" id="ksq-next" data-i18n="common_next"></button>
  </div>
</div>
</div>
</section>
<section class="hidden" id="view-ksq-summary">
<div class="toolbar">
<button class="btn btn-green" id="sum-ksq-home" data-i18n="sum_home"></button>
<button class="btn btn-ghost" id="sum-ksq-retry" data-i18n="sum_retry"></button>
</div>
<div class="grid-2">
<div class="list-card">
<h2 class="h2" data-i18n="sum_ksq_title"></h2>
<canvas class="chart" height="300" id="ksq-chart" width="300"></canvas>
<div class="sub" id="ksq-motto"></div>
<div class="badge big" id="ksq-badge"></div>
</div>
<div class="summary-list" id="ksq-summary-list"></div>
</div>
</section>
<section class="hidden" id="view-circle">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-home-4" data-i18n="common_back"></button></div>
<div class="stack stack-lg circle-view">
<h2 class="h2" data-i18n="circle_title"></h2>
<article class="list-card circle-intro">
  <div class="stack stack-md">
    <p class="strong" data-i18n="circle_intro_lead" data-i18n-html="1"></p>
    <p data-i18n="circle_intro_p2" data-i18n-html="1"></p>
    <p data-i18n="circle_intro_p3" data-i18n-html="1"></p>
    <p data-i18n="circle_intro_p4" data-i18n-html="1"></p>
  </div>
</article>
<div class="circle-wrap">
<div class="list-card">
<svg class="svg" id="kv-svg" viewbox="0 0 600 600">

<circle class="ring outer" cx="300" cy="300" r="298"></circle>
<circle class="ring inner" cx="300" cy="300" r="150"></circle>
<g id="kv-symbols"></g>
</svg>
</div>
<div class="kv-legend">
  <div class="title-lg" id="kv-title" aria-live="polite"></div>
  <div class="kv-variant" id="kv-variant">
    <span class="sub" data-i18n="variant"></span>
    <button class="chip" id="kv-var-a"></button>
    <button class="chip" id="kv-var-b"></button>
  </div>
  <div class="kv-metric"><span data-i18n="circle_acc_label"></span><span id="kv-ks"></span></div>
  <div class="kv-metric"><span data-i18n="circle_count_label"></span><span id="kv-count"></span></div>
  <div class="kv-metric"><span data-i18n="circle_rel_minor"></span><span id="kv-rel"></span></div>
  <div class="kv-metric"><span data-i18n="circle_next_sharp"></span><span id="kv-next-sharp"></span></div>
  <div class="kv-metric"><span data-i18n="circle_next_flat"></span><span id="kv-next-flat"></span></div>
</div>
</div>
</div>
</section>
<section class="hidden" id="view-circle-quiz">
<div class="toolbar"><button class="btn btn-ghost" data-action="nav" data-to="view-home" id="back-circle-quiz" data-i18n="common_back"></button></div>
<div class="stack stack-lg circle-view">
<h2 class="h2" data-i18n="circlequiz_title"></h2>
<div class="circle-wrap">
<div class="list-card">
<svg class="svg" id="kvq-svg" viewbox="0 0 600 600">

<circle class="ring outer" cx="300" cy="300" r="298"></circle>
<circle class="ring inner" cx="300" cy="300" r="150"></circle>
<g id="kvq-symbols"></g>
</svg>

<style id="circle-tight-margins">
  /* tighter card padding for circle views */
  #view-circle .list-card,
  #view-circle-quiz .list-card { padding: 8px 8px 12px; }

  /* ensure the SVG uses full width without extra spacing */
  #view-circle .svg,
  #view-circle-quiz .svg { display:block; width:100%; height:auto; }

  /* slightly smaller gap between SVG and legend on narrow screens */
  @media (max-width: 979px){
    #view-circle .circle-wrap,
    #view-circle-quiz .circle-wrap { gap: 8px; }
  }
</style>
</div>
<div class="kv-legend">
<div class="mt-10" id="circq2-panel">
<div id="circq2-choose">
<div class="sub" data-i18n="circle_panel_pick"></div>
<div class="btns">
<button class="btn btn-ghost circq2-pick" data-rounds="3" data-i18n="ksq_3"></button>
<button class="btn btn-ghost circq2-pick" data-rounds="5" data-i18n="ksq_5"></button>
<button class="btn btn-ghost circq2-pick" data-rounds="10" data-i18n="ksq_10"></button>
</div>
</div>
<div class="hidden" id="circq2-wrap">
<div class="toolbar">
<div class="badge" id="circq2-prog"></div>
<button class="btn btn-ghost" id="circq2-exit" data-i18n="circle_end"></button>
</div>
<div class="sub" data-i18n="circle_task" data-i18n-html="1"></div>
<div class="strong" id="circq2-sign"></div>
<div class="eval" id="circq2-result"></div>
<div class="btns">
<button class="btn btn-ghost" id="circq2-next" data-i18n="common_next"></button>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="hidden" id="view-circq2-summary">
<div class="toolbar">
<button class="btn btn-green" id="sum-circq2-home" data-i18n="sum_home"></button>
<button class="btn btn-ghost" id="sum-circq2-retry" data-i18n="sum_retry_circquiz"></button>
</div>
<div class="grid-2">
<div class="list-card">
<h2 class="h2" data-i18n="sum_circquiz_title"></h2>
<canvas class="chart" height="300" id="circq2-chart" width="300"></canvas>
<div class="sub" id="circq2-motto"></div>
<div class="badge big" id="circq2-badge"></div>
</div>
<div class="summary-list" id="circq2-summary-list"></div>
</div>
</section>
</main>
</div><script>
function toniqaLocalizeNoteSymbol(value){
  if(value === null || value === undefined) return value;
  const str = String(value);
  if(!window.I18N || I18N.lang !== 'cs') return str;
  return str.replace(/[A-Ga-g](?:[#b♭♯]{0,2})(?:\d+)?/g, token=>{
    if(!token) return token;
    const letter = token[0];
    if(letter !== 'B' && letter !== 'b') return token;
    const prefix = (letter === 'b') ? 'h' : 'H';
    let idx = 1;
    let accidental = '';
    while(idx < token.length){
      const ch = token[idx];
      if(ch === '#' || ch === 'b' || ch === '♭' || ch === '♯'){
        accidental += ch;
        idx++;
      } else {
        break;
      }
    }
    const rest = token.slice(idx);
    return prefix + accidental + rest;
  });
}
(function(){
  window.App = window.App || {};
  const el = id => document.getElementById(id);
  function chipSet(container,labels,multi=false){
    container.innerHTML='';
    labels.forEach(l=>{
      const b=document.createElement('button');
      const text = toniqaLocalizeNoteSymbol(l);
      b.type='button'; b.className='chip'; b.textContent=text; b.dataset.label=l; b.dataset.on='0';
      b.addEventListener('click',()=>{
        if(!multi){ container.querySelectorAll('.chip').forEach(x=>{x.dataset.on='0'; x.classList.remove('on');}); }
        const on=b.dataset.on==='1'; b.dataset.on=on?'0':'1'; b.classList.toggle('on',!on);
      });
      container.appendChild(b);
    });
  }
  function selectedLabels(container){return Array.from(container.querySelectorAll('.chip[data-on="1"]')).map(b=>b.dataset.label);}
  const donutRegistry = new Map();
  const evalBadge = ok => `<span class="badge badge-eval" data-eval="${ok?'ok':'bad'}">${ok?'✓':'✕'}</span>`;

  function applyEvalState(root){
    const scope = (root && typeof root.querySelectorAll === 'function') ? root : document;
    const apply = (selector)=>{
      scope.querySelectorAll(selector).forEach(node=>{
        const state = node.dataset && node.dataset.eval;
        if(!state) return;
        const ok = state === 'ok' || state === '1' || state === 'true';
        node.classList.toggle('is-ok', ok);
        node.classList.toggle('is-bad', !ok);
      });
    };
    apply('.eval-card[data-eval]');
    apply('.badge[data-eval]');
  }

  function markEvalState(target, ok){
    if(!target) return;
    let el = target;
    const isEvalEl = (node)=> node && node.classList && (node.classList.contains('eval-card') || node.classList.contains('badge'));
    if(!isEvalEl(el) && typeof target.closest === 'function'){
      el = target.closest('.eval-card, .badge');
    }
    if(!isEvalEl(el)) return;
    el.dataset.eval = ok ? 'ok' : 'bad';
    applyEvalState(el.parentElement || el);
  }

  function drawDonut(canvas, p){
    if(!canvas) return;
    donutRegistry.set(canvas, p);
    const root = document.documentElement;
    const css = getComputedStyle(root);
    const bg   = (css.getPropertyValue('--chart-bg')   || '#1f2937').trim();
    const ok   = (css.getPropertyValue('--chart-ok')   || '#22c55e').trim();
    const warn = (css.getPropertyValue('--chart-warn') || '#f59e0b').trim();
    const bad  = (css.getPropertyValue('--chart-bad')  || '#ef4444').trim();
    const color = p < 0.4 ? bad : (p < 0.7 ? warn : ok);

    const ctx=canvas.getContext('2d');
    const dpr=window.devicePixelRatio||1;
    if(!canvas.dataset.baseSize){
      const attrW=parseInt(canvas.getAttribute('width'),10);
      const attrH=parseInt(canvas.getAttribute('height'),10);
      const fallback = canvas.clientWidth || attrW || 300;
      const base=Math.min(attrW||fallback, attrH||fallback);
      canvas.dataset.baseSize=String(base||300);
    }
    const size=parseInt(canvas.dataset.baseSize,10)||300;
    canvas.width=size*dpr; canvas.height=size*dpr;
    canvas.style.width='100%'; canvas.style.height='auto';
    ctx.scale(dpr,dpr);

    const cx=size/2, cy=size/2, r=size*0.42, thick=size*0.12;
    ctx.clearRect(0,0,size,size);
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle=bg; ctx.lineWidth=thick; ctx.stroke();
    ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+Math.PI*2*p); ctx.strokeStyle=color; ctx.lineCap='round'; ctx.lineWidth=thick; ctx.stroke();

    const pct=Math.round(p*100);
    ctx.fillStyle=css.getPropertyValue('--ink').trim() || '#e5e7eb';
    ctx.font='bold '+(size*0.18)+'px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(pct+'%',cx,cy);
  }
  document.addEventListener('toniqa-theme-change', ()=>{
    donutRegistry.forEach((value, canvas)=>{
      if(!canvas.isConnected){
        donutRegistry.delete(canvas);
        return;
      }
      drawDonut(canvas, value);
    });
  });

  function setInfoFoldState(fold, isOpen){
    if(!fold) return;
    const body = fold.querySelector('.fold-body');
    const toggle = fold.querySelector('.fold-toggle');
    fold.classList.toggle('is-open', isOpen);
    fold.classList.toggle('is-collapsed', !isOpen);
    if(body) body.hidden = false;
    if(toggle){
      toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      if(window.I18N && typeof I18N.t === 'function'){
        toggle.textContent = I18N.t(isOpen ? 'common_collapse' : 'common_expand');
      }
    }
  }

  function initInfoFolds(){
    document.querySelectorAll('.fold').forEach(fold=>{
      if(fold.__bound) return;
      const toggle = fold.querySelector('.fold-toggle');
      const body = fold.querySelector('.fold-body');
      if(!toggle || !body) return;
      fold.__bound = true;
      const openByDefault = fold.classList.contains('is-open') || !fold.classList.contains('is-collapsed');
      setInfoFoldState(fold, openByDefault);
      toggle.addEventListener('click', ()=>{
        setInfoFoldState(fold, !fold.classList.contains('is-open'));
      });
    });
  }

  function refreshInfoFolds(){
    document.querySelectorAll('.fold').forEach(fold=>{
      const isOpen = fold.classList.contains('is-open') || !fold.classList.contains('is-collapsed');
      setInfoFoldState(fold, isOpen);
    });
  }

  document.addEventListener('click', (event)=>{
    const btn = event.target && event.target.closest ? event.target.closest('.fold-toggle') : null;
    if(!btn) return;
    const fold = btn.closest('.fold');
    if(!fold) return;
    const isOpen = fold.classList.contains('is-open') || !fold.classList.contains('is-collapsed');
    setInfoFoldState(fold, !isOpen);
  });

  if(window.App){
    App.utils = App.utils || {};
    App.utils.initInfoFolds = initInfoFolds;
    App.utils.refreshInfoFolds = refreshInfoFolds;
  }


  function mottoFor(p){
    if(p<=0.4) return I18N.t('motto_low');
    if(p<=0.7) return I18N.t('motto_mid');
    if(p<=0.9) return I18N.t('motto_high');
    return I18N.t('motto_perfect');
  }
  function badgeFor(p){
    if(p>=0.9) return I18N.t('badge_gold');
    if(p>=0.7) return I18N.t('badge_silver');
    if(p>=0.5) return I18N.t('badge_bronze');
    return I18N.t('badge_retry');
  }
  const SHARP_NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const FLAT_NOTES =['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
  const SPECIAL_EQ = new Map([
    ['B#','C'],['E#','F'],['CB','B'],['FB','E'],
    ['G##','A'],['D##','E'],['A##','B'],['C##','D'],
    ['F##','G'],['E##','F#'],['B##','C#'],
    ['Gbb','F'],['Dbb','C'],['Abb','G'],['Ebb','D'],['Bbb','A'],['Cbb','Bb'],['Fbb','Eb']
  ]);
  function canonical(note){
    const raw = (note||'').trim().replace(/♭/g,'b').replace(/♯/g,'#');
    if(!raw) return '';
    const head = raw[0].toUpperCase();
    const tail = raw.slice(1).replace(/b/gi,'b').replace(/#/g,'#');
    return head+tail;
  }
  function normalizeNote(note, preferFlats){
    let n = canonical(note);
    if(SPECIAL_EQ.has(n)) n = SPECIAL_EQ.get(n);
    const idxSharp = SHARP_NOTES.indexOf(n);
    const idxFlat = FLAT_NOTES.indexOf(n);
    if(preferFlats){
      if(idxFlat>=0) return FLAT_NOTES[idxFlat];
      if(idxSharp>=0) return FLAT_NOTES[idxSharp];
    } else {
      if(idxSharp>=0) return SHARP_NOTES[idxSharp];
      if(idxFlat>=0) return SHARP_NOTES[idxFlat];
    }
    return n;
  }
  function makeScale(rootIndex, pattern){
    return pattern.map(step=>SHARP_NOTES[(rootIndex+step+120)%12]);
  }
  function toPreference(seq, preferFlats){
    return seq.map(n=>normalizeNote(n, preferFlats));
  }
  function harmonicMinorScale(root, preferFlats){
    const rootIdx = SHARP_NOTES.indexOf(normalizeNote(root,false));
    if(rootIdx<0) return [];
    const pattern=[0,2,3,5,7,8,11];
    return toPreference(makeScale(rootIdx, pattern), preferFlats);
  }
  function melodicMinorScale(root, preferFlats){
    const rootIdx = SHARP_NOTES.indexOf(normalizeNote(root,false));
    if(rootIdx<0) return { asc:[], desc:[] };
    const ascPattern=[0,2,3,5,7,9,11];
    const naturalPattern=[0,2,3,5,7,8,10];
    const asc = toPreference(makeScale(rootIdx, ascPattern), preferFlats);
    const natural = toPreference(makeScale(rootIdx, naturalPattern), preferFlats);
    const desc = natural.length ? [natural[0]].concat(natural.slice(1).reverse()) : [];
    return { asc, desc };
  }


  function helmholtzLabel(note){
    if(!note) return '';
    const letter = note.letter || 'C';
    const accidental = note.accidental === '#'
      ? '♯'
      : (note.accidental === 'b' ? '♭' : '');
    const octave = Number(note.octave ?? 0);
    const localized = toniqaLocalizeNoteSymbol(letter);
    const body = octave <= 2 ? localized.toUpperCase() : localized.toLowerCase();
    let suffix = '';
    if(octave === 0) suffix = ',,';
    else if(octave === 1) suffix = ',';
    else if(octave >= 4) suffix = String(octave - 3);
    return `${body}${accidental}${suffix}`;
  }

  function formatNoteLabel(note) {
    return helmholtzLabel(note);
  }

  function choiceChips(container, options, selectedValue, onSelect){
    if(!container) return [];
    container.innerHTML = '';
    const buttons = [];
    options.forEach(opt=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip';
      btn.dataset.value = String(opt.value);
      btn.textContent = opt.label;
      if(opt.disabled){
        btn.disabled = true;
      } else {
        btn.addEventListener('click', ()=>{
          if(btn.disabled) return;
          buttons.forEach(b=>b.classList.toggle('on', b === btn));
          if(typeof onSelect === 'function'){
            onSelect(opt.value, btn);
          }
        });
      }
      if(String(opt.value) === String(selectedValue)){
        btn.classList.add('on');
      }
      container.appendChild(btn);
      buttons.push(btn);
    });
    return buttons;
  }


  App.utils = { el, chipSet, selectedLabels, drawDonut, mottoFor, badgeFor, evalBadge, applyEvalState, markEvalState, choiceChips,
    durWord(){ return I18N.t('word_dur'); },
    mollWord(){ return I18N.t('word_moll'); },
    labelMajor(X){ return `${toniqaLocalizeNoteSymbol(X)} ${I18N.t('word_dur')}`; },
    labelMinor(x){ return `${toniqaLocalizeNoteSymbol(x)} ${I18N.t('word_moll')}`; },
    noteName(value){ return toniqaLocalizeNoteSymbol(value); },
    noteNames(list){ return Array.isArray(list) ? list.map(toniqaLocalizeNoteSymbol) : toniqaLocalizeNoteSymbol(list); },
    notesJoin(list, joiner=' '){ return Array.isArray(list) ? list.map(toniqaLocalizeNoteSymbol).join(joiner) : toniqaLocalizeNoteSymbol(list); },
    harmonicMinorScale,
    melodicMinorScale,
    formatNoteLabel,
    helmholtzLabel
  };

  document.addEventListener('DOMContentLoaded', ()=>applyEvalState(document));
  window.__toniqa_colorizeSummaries = ()=>applyEvalState(document);
})();

(function(){
  window.App = window.App || {};
  const MAJOR={'C':['C','D','E','F','G','A','B'],'G':['G','A','B','C','D','E','F#'],'D':['D','E','F#','G','A','B','C#'],'A':['A','B','C#','D','E','F#','G#'],'E':['E','F#','G#','A','B','C#','D#'],'B':['B','C#','D#','E','F#','G#','A#'],'F#':['F#','G#','A#','B','C#','D#','E#'],'C#':['C#','D#','E#','F#','G#','A#','B#'],'F':['F','G','A','Bb','C','D','E'],'Bb':['Bb','C','D','Eb','F','G','A'],'Eb':['Eb','F','G','Ab','Bb','C','D'],'Ab':['Ab','Bb','C','Db','Eb','F','G'],'Db':['Db','Eb','F','Gb','Ab','Bb','C'],'Gb':['Gb','Ab','Bb','Cb','Db','Eb','F']};
  const ORDER_MAJ_INFO=[{majors:['C']},{majors:['G']},{majors:['D']},{majors:['A']},{majors:['E']},{majors:['B']},{majors:['F#','Gb']},{majors:['C#','Db']},{majors:['Ab']},{majors:['Eb']},{majors:['Bb']},{majors:['F']}];
  const ORDER_MAJ = ORDER_MAJ_INFO.map(x=>x.majors[0]);
  const REL_MINOR={}; Object.keys(MAJOR).forEach(M=>{ const s=MAJOR[M]; REL_MINOR[M]=s[5]; });
  const ORDER_MIN = ORDER_MAJ.map(M=>REL_MINOR[M]);
  const KS_MAP={'C':{type:'none',list:[]},'G':{type:'sharp',list:['F#']},'D':{type:'sharp',list:['F#','C#']},'A':{type:'sharp',list:['F#','C#','G#']},'E':{type:'sharp',list:['F#','C#','G#','D#']},'B':{type:'sharp',list:['F#','C#','G#','D#','A#']},'F#':{type:'sharp',list:['F#','C#','G#','D#','A#','E#']},'C#':{type:'sharp',list:['F#','C#','G#','D#','A#','E#','B#']},'F':{type:'flat',list:['Bb']},'Bb':{type:'flat',list:['Bb','Eb']},'Eb':{type:'flat',list:['Bb','Eb','Ab']},'Ab':{type:'flat',list:['Bb','Eb','Ab','Db']},'Db':{type:'flat',list:['Bb','Eb','Ab','Db','Gb']},'Gb':{type:'flat',list:['Bb','Eb','Ab','Db','Gb','Cb']}};
  function ksStringForMajor(M){
    const ks=KS_MAP[M];
    if(!ks||ks.type==='none') return '—';
    if(window.App && App.utils && typeof App.utils.notesJoin === 'function'){
      return App.utils.notesJoin(ks.list, ', ');
    }
    return ks.list.join(', ');
  }
  function ksCountForMajor(M){ const ks=KS_MAP[M]; if(!ks||ks.type==='none') return '0'; return (ks.type==='sharp'?'+':'−')+ks.list.length+' ('+(ks.type==='sharp'?'♯':'♭')+')'; }
  App.data = { MAJOR, ORDER_MAJ_INFO, ORDER_MAJ, ORDER_MIN, REL_MINOR, KS_MAP, ksStringForMajor, ksCountForMajor };
})();

(function(){
  const { MAJOR } = App.data;
  const { el } = App.utils;
  const SCALES=[
    {major:'C',  ks:'—',                 minor:'A'},
    {major:'G',  ks:'F#',               minor:'E'},
    {major:'D',  ks:'F#, C#',           minor:'B'},
    {major:'A',  ks:'F#, C#, G#',       minor:'F#'},
    {major:'E',  ks:'F#, C#, G#, D#',   minor:'C#'},
    {major:'B',  ks:'F#, C#, G#, D#, A#', minor:'G#'},
    {major:'F#', ks:'F#, C#, G#, D#, A#, E#', minor:'D#'},
    {major:'C#', ks:'F#, C#, G#, D#, A#, E#, B#', minor:'A#'},
    {major:'F',  ks:'Bb',               minor:'D'},
    {major:'Bb', ks:'Bb, Eb',           minor:'G'},
    {major:'Eb', ks:'Bb, Eb, Ab',       minor:'C'},
    {major:'Ab', ks:'Bb, Eb, Ab, Db',   minor:'F'},
    {major:'Db', ks:'Bb, Eb, Ab, Db, Gb', minor:'Bb'},
    {major:'Gb', ks:'Bb, Eb, Ab, Db, Gb, Cb', minor:'Eb'}
  ];
  function renderMainTable(openDetail){
    const tbody=document.querySelector('#scales-table tbody'); tbody.innerHTML='';
    SCALES.forEach((row,idx)=>{
      const tr=document.createElement('tr');
      const ksText = App.utils.noteName(row.ks);
      tr.innerHTML=`<td>${App.utils.labelMinor(row.minor)}</td><td>${App.utils.labelMajor(row.major)}</td><td>${ksText}</td>`;
      tr.addEventListener('click',()=>openDetail(idx,'scales'));
      tbody.appendChild(tr);
    });
  }
  function naturalMinorFromMajor(maj){const a=MAJOR[maj];return[a[5],a[6],a[0],a[1],a[2],a[3],a[4]];}
  function minorPent(min7){return[min7[0],min7[2],min7[3],min7[4],min7[6]];}
  function prefersFlatsKey(maj){return['F','Bb','Eb','Ab','Db','Gb','Cb'].includes(maj);}
  function blueNoteB5(minRoot,preferSharps){
    const SHARP=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const FLAT=['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
    const arr=preferSharps?SHARP:FLAT; let i=arr.indexOf(minRoot);
    if(i<0){ i=SHARP.indexOf(minRoot); if(i<0) i=FLAT.indexOf(minRoot); }
    return arr[(i+6)%12];
  }
  App.scales = { SCALES, renderMainTable, naturalMinorFromMajor, minorPent, prefersFlatsKey, blueNoteB5 };
})();

(function(){
  const { el, chipSet, selectedLabels, drawDonut, mottoFor, badgeFor, show, choiceChips } = App.utils;
  const { SCALES, naturalMinorFromMajor, minorPent, prefersFlatsKey, blueNoteB5 } = App.scales;
  const { MAJOR } = App.data;

  let quizOrder=[], quizPos=0, quizAnswers={}, onOpenDetail=null, onShow=null, onBack=null;
  let buildType = 'penta';
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function tones12(preferSharps){ const SHARP=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; const FLAT=['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B']; return preferSharps?SHARP:FLAT; }
  function tonesForKey(row){ return tones12(!prefersFlatsKey(row.major)); }
  function ksUniverse(){ return ['—','F#','C#','G#','D#','A#','E#','B#','Bb','Eb','Ab','Db','Gb','Cb','Fb']; }
  function compareSets(a,b){ if(a.length!==b.length) return false; const sa=new Set(a), sb=new Set(b); if(sa.size!==sb.size) return false; for(const x of sa){ if(!sb.has(x)) return false; } return true; }
  function chipSetMulti(c,labels){ chipSet(c,labels,true); }
  function typeDefs(){
    return {
      penta:{
        headingKey:'build_quiz_heading_penta',
        labelKey:'label_penta_minor',
        useBlue:true,
        scale:(row)=>minorPent(naturalMinorFromMajor(row.major))
      },
      major:{
        headingKey:'build_quiz_heading_major',
        labelKey:'label_scale_major',
        useBlue:false,
        scale:(row)=>MAJOR[row.major] || []
      },
      minor:{
        headingKey:'build_quiz_heading_minor',
        labelKey:'label_scale_minor',
        useBlue:false,
        scale:(row)=>naturalMinorFromMajor(row.major)
      }
    };
  }
  function activeType(){
    const defs = typeDefs();
    return defs[buildType] || defs.penta;
  }
  function applyTypeUI(){
    const def = activeType();
    const scaleHeading = el('build-heading-scale');
    if(scaleHeading){
      scaleHeading.setAttribute('data-i18n', def.headingKey);
      I18N.apply(scaleHeading);
    }
    const blueCard = el('build-card-blue');
    if(blueCard){
      blueCard.classList.toggle('hidden', !def.useBlue);
    }
  }

  function loadStep(){
    applyTypeUI();
    const idx=quizOrder[quizPos]; const row=SCALES[idx];
    el('quiz-heading').textContent = `${I18N.t('build_header_prefix')} ${App.utils.labelMinor(row.minor)} • ${App.utils.labelMajor(row.major)}`;
    el('quiz-prog').textContent = `${quizPos+1} / ${quizOrder.length}`;
    chipSetMulti(el('ks-chips'), ksUniverse());
    chipSetMulti(el('pent-chips'), tonesForKey(row));
    chipSet(el('blue-chips'), tonesForKey(row), false);
    const ans=quizAnswers[idx]||{ks:[],pent:[],blue:null};
    const set=(cont,vals)=>{ const s=new Set(vals||[]); cont.querySelectorAll('.chip').forEach(b=>{ const on=s.has(b.dataset.label); b.dataset.on=on?'1':'0'; b.classList.toggle('on',on);}); };
    set(el('ks-chips'), ans.ks); set(el('pent-chips'), ans.pent); if(ans.blue){ set(el('blue-chips'), [ans.blue]); }
    el('open-detail-from-quiz').onclick = ()=> onOpenDetail && onOpenDetail(idx,'quiz');
    el('btn-next').textContent = (quizPos===quizOrder.length-1)? I18N.t('finish') : I18N.t('common_next');
  }
  function snapshot(){ const idx=quizOrder[quizPos];
    const def = activeType();
    quizAnswers[idx] = {
      ks:selectedLabels(el('ks-chips')).filter(x=>x!=='—'),
      pent:selectedLabels(el('pent-chips')),
      blue:def.useBlue ? (selectedLabels(el('blue-chips'))[0]||null) : null
    };
  }
  function finishSummary(){
    snapshot();
    const list=el('build-summary-list'); list.innerHTML='';
    const def = activeType();
    let correct=0,total=quizOrder.length*(def.useBlue?3:2);
    quizOrder.forEach((idx,i)=>{
      const row=SCALES[idx];
      const expectedScale = def.scale(row) || [];
      const expectedKs=(row.ks==='—')?[]:row.ks.split(',').map(s=>s.trim());
      const expectedBlue = def.useBlue ? blueNoteB5(row.minor,!prefersFlatsKey(row.major)) : null;
      const ans=quizAnswers[idx]||{ks:[],pent:[],blue:null};
      const okKs=(new Set(ans.ks)).size===(new Set(expectedKs)).size && ans.ks.every(x=>expectedKs.includes(x));
      const okScale=(new Set(ans.pent)).size===(new Set(expectedScale)).size && ans.pent.every(x=>expectedScale.includes(x));
      const okBlue=def.useBlue ? (ans.blue===expectedBlue) : true;
      const expectedKsLabel = expectedKs.length ? App.utils.notesJoin(expectedKs,' ') : '—';
      const expectedScaleLabel = expectedScale.length ? App.utils.notesJoin(expectedScale,' ') : '—';
      const expectedBlueLabel = def.useBlue ? App.utils.noteName(expectedBlue) : '—';
      const ansKsLabel = ans.ks.length ? App.utils.notesJoin(ans.ks,' ') : '—';
      const ansScaleLabel = ans.pent.length ? App.utils.notesJoin(ans.pent,' ') : '—';
      const ansBlueLabel = ans.blue ? App.utils.noteName(ans.blue) : '—';
      correct += (okKs?1:0)+(okScale?1:0)+(def.useBlue && okBlue?1:0);
      const card=document.createElement('div'); card.className='list-card';
      const rows = [
        `<div class='eval-card' data-eval='${okKs?'ok':'bad'}'>${I18N.t('label_acc')}: <span class='sub'>(${I18N.t('label_yours')}: ${ansKsLabel} / ${I18N.t('label_correct')}: ${expectedKsLabel})</span></div>`,
        `<div class='eval-card' data-eval='${okScale?'ok':'bad'}'>${I18N.t(def.labelKey)}: <span class='sub'>(${I18N.t('label_yours')}: ${ansScaleLabel} / ${I18N.t('label_correct')}: ${expectedScaleLabel})</span></div>`
      ];
      if(def.useBlue){
        rows.push(`<div class='eval-card' data-eval='${okBlue?'ok':'bad'}'>${I18N.t('label_blue')}: <span class='sub'>(${I18N.t('label_yours')}: ${ansBlueLabel} / ${I18N.t('label_correct')}: ${expectedBlueLabel})</span></div>`);
      }
      card.innerHTML = `<div class='summary-item-title'>${i+1}. ${App.utils.labelMinor(row.minor)} • ${App.utils.labelMajor(row.major)}</div>
        <div class='summary-list eval-lines'>${rows.join('')}</div>`;
      list.appendChild(card);
    });
    App.utils.applyEvalState(list);
    const percent = total? (correct/total) : 0; drawDonut(el('build-chart'), percent);
    el('build-motto').textContent = mottoFor(percent); el('build-badge').textContent = badgeFor(percent);
    onShow('buildSum');
  }

  function initBuildQuiz(api){
    onOpenDetail = api.openDetail; onShow = api.show; onBack = api.back || api.show;
    const practiceList=el('practice-list'); function updateStart(){ el('start-quiz').disabled = practiceList.querySelectorAll('.select-row.on').length===0; }
    const typeWrap = el('build-type-chips');
    function renderTypeChips(){
      if(!typeWrap || typeof choiceChips !== 'function') return;
      const options = [
        { value:'penta', label:I18N.t('build_select_type_penta') },
        { value:'major', label:I18N.t('build_select_type_major') },
        { value:'minor', label:I18N.t('build_select_type_minor') }
      ];
      choiceChips(typeWrap, options, buildType, value=>{
        buildType = value;
        applyTypeUI();
        if(!document.getElementById('view-build-quiz').classList.contains('hidden') && quizOrder.length){
          loadStep();
        }
      });
    }
  function renderSelection(selected=new Set()){ practiceList.innerHTML=''; App.scales.SCALES.forEach((row,idx)=>{
      const on=selected.has(idx);
      const div=document.createElement('div'); div.className='select-row'; div.dataset.id=String(idx); div.dataset.on=on?'1':'0';
      if(on){ div.classList.add('on'); }
      div.innerHTML=`<div>${App.utils.labelMinor(row.minor)} • ${App.utils.labelMajor(row.major)}</div><div data-role='check'>${on?'☑':'☐'}</div>`;
      div.addEventListener('click',()=>{ const active=div.dataset.on==='1'; div.dataset.on=active?'0':'1'; div.querySelector('[data-role=check]').textContent=active?'☐':'☑'; div.classList.toggle('on',!active); updateStart(); });
      practiceList.appendChild(div);
    }); updateStart(); }
    el('btn-select-all').addEventListener('click',()=>{ practiceList.querySelectorAll('.select-row').forEach(d=>{d.dataset.on='1'; d.classList.add('on'); d.querySelector('[data-role=check]').textContent='☑';}); updateStart(); });
    el('btn-clear-all').addEventListener('click',()=>{ practiceList.querySelectorAll('.select-row').forEach(d=>{d.dataset.on='0'; d.classList.remove('on'); d.querySelector('[data-role=check]').textContent='☐';}); updateStart(); });
    function selectedIds(){ return Array.from(practiceList.querySelectorAll('.select-row.on')).map(d=>Number(d.dataset.id)); }

    function start(){ quizOrder = shuffle(selectedIds()); quizPos=0; quizAnswers={}; if(!quizOrder.length) return; loadStep(); api.show('buildQuiz'); }
    el('start-quiz').addEventListener('click', start);
    el('btn-prev').addEventListener('click', ()=>{ snapshot(); if(quizPos>0){ quizPos--; loadStep(); } });
    el('btn-next').addEventListener('click', ()=>{ snapshot(); if(quizPos<quizOrder.length-1){ quizPos++; loadStep(); } else { finishSummary(); } });
    el('back-select').addEventListener('click', ()=> onBack('buildSel'));
    renderTypeChips();
    renderSelection();
    App.buildQuiz.refreshLang = ()=>{
      const selected=new Set(Array.from(practiceList.querySelectorAll('.select-row.on')).map(d=>Number(d.dataset.id)));
      renderTypeChips();
      renderSelection(selected);
      if(!document.getElementById('view-build-quiz').classList.contains('hidden') && quizOrder.length){
        loadStep();
      }
    };
  }

  App.buildQuiz = { initBuildQuiz };
})();

(function(){
  const { el, drawDonut, mottoFor, badgeFor } = App.utils;
  const { ORDER_MAJ, ORDER_MIN, REL_MINOR, ksStringForMajor } = App.data;

  let rounds=5, order=[], pos=0, answers={};

  function resetKsQuizState(){
    rounds=5;
    order=[];
    pos=0;
    answers={};
    const choose = el('ksq-choose');
    const wrap = el('ksq-wrap');
    if(choose) choose.classList.remove('hidden');
    if(wrap) wrap.classList.add('hidden');
    const prog = el('ksq-prog');
    if(prog) prog.textContent='';
    const sign = el('ksq-sign');
    if(sign) sign.textContent='';
    const maj = el('ksq-major');
    if(maj) maj.innerHTML='';
    const min = el('ksq-minor');
    if(min) min.innerHTML='';
    const summary = el('ksq-summary-list');
    if(summary) summary.innerHTML='';
  }

  function initKsQuiz(api){
    document.querySelectorAll('.ksq-pick').forEach(b=>{
      b.addEventListener('click', ()=>{
        rounds = parseInt(b.dataset.rounds,10);
        const majors = ORDER_MAJ.slice(0); for(let i=majors.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [majors[i],majors[j]]=[majors[j],majors[i]]; }
        order = majors.slice(0, rounds); pos=0; answers={};
        el('ksq-choose').classList.add('hidden'); el('ksq-wrap').classList.remove('hidden'); load();
      });
    });
    function load(){
      const M = order[pos]; el('ksq-prog').textContent = `${pos+1} / ${rounds}`; el('ksq-sign').textContent = ksStringForMajor(M);
      const maj = el('ksq-major'), min=el('ksq-minor'); maj.innerHTML=''; min.innerHTML='';
      ORDER_MAJ.forEach(X=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=App.utils.labelMajor(X); b.addEventListener('click',()=>{ maj.querySelectorAll('.chip').forEach(x=>x.classList.remove('on')); b.classList.add('on'); }); maj.appendChild(b); });
      ORDER_MIN.forEach(x=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=App.utils.labelMinor(x); b.addEventListener('click',()=>{ min.querySelectorAll('.chip').forEach(x=>x.classList.remove('on')); b.classList.add('on'); }); min.appendChild(b); });
      const prev = answers[M]||{major:null,minor:null};
      if(prev.major){ Array.from(maj.children).forEach(btn=>{ if(btn.textContent===prev.major) btn.classList.add('on'); }); }
      if(prev.minor){ Array.from(min.children).forEach(btn=>{ if(btn.textContent===prev.minor) btn.classList.add('on'); }); }
    }
    function snap(){
      const M = order[pos];
      const majSel = (Array.from(el('ksq-major').children).find(b=>b.classList.contains('on'))||{}).textContent||null;
      const minSel = (Array.from(el('ksq-minor').children).find(b=>b.classList.contains('on'))||{}).textContent||null;
      answers[M] = {major:majSel, minor:minSel};
    }
    el('ksq-prev').addEventListener('click', ()=>{ if(pos>0){ snap(); pos--; load(); } });
    el('ksq-next').addEventListener('click', ()=>{
      if(pos<rounds-1){ snap(); pos++; load(); }
      else { snap(); // summary
        const list=el('ksq-summary-list'); list.innerHTML=''; let corr=0,total=0;
        order.forEach((M,i)=>{
          const a=answers[M]||{major:null,minor:null},
            okMaj=(a.major===App.utils.labelMajor(M)),
            okMin=(a.minor===App.utils.labelMinor(REL_MINOR[M]));
          corr+=(okMaj?1:0)+(okMin?1:0); total+=2;
          const card=document.createElement('div'); card.className='list-card';
          card.innerHTML = `<div class='summary-item-title'>${i+1}. ${I18N.t('summary_acc_label')}: ${App.data.ksStringForMajor(M)}</div>
            <div class='summary-list eval-lines'>
              <div class='eval-card' data-eval='${okMaj?'ok':'bad'}'>${I18N.t('label_major')}: <span class='sub'>(${I18N.t('label_yours')}: ${a.major||'—'} / ${I18N.t('label_correct')}: ${App.utils.labelMajor(M)})</span></div>
              <div class='eval-card' data-eval='${okMin?'ok':'bad'}'>${I18N.t('label_minor')}: <span class='sub'>(${I18N.t('label_yours')}: ${a.minor||'—'} / ${I18N.t('label_correct')}: ${App.utils.labelMinor(REL_MINOR[M])})</span></div>
            </div>`;
          list.appendChild(card);
        });
        App.utils.applyEvalState(list);
        const p = total? (corr/total) : 0; App.utils.drawDonut(el('ksq-chart'), p); el('ksq-motto').textContent=App.utils.mottoFor(p); el('ksq-badge').textContent=App.utils.badgeFor(p);
        api.show('ksqSum');
      }
    });
  }

  App.ksQuiz = { initKsQuiz, reset: resetKsQuizState };
})();

(function(){
  const { el } = App.utils;
  const { ORDER_MAJ_INFO, ORDER_MAJ, ORDER_MIN, REL_MINOR, KS_MAP, ksStringForMajor, ksCountForMajor } = App.data;
  const SHARP_LETTERS=['F','C','G','D','A','E','B'];
  const FLAT_LETTERS=['B','E','A','D','G','C','F'];
  const R_MAJOR=265, R_MINOR=205, R_SYMBOL=135;
  const POS_INDEX={}; ORDER_MAJ.forEach((L,i)=>{ POS_INDEX[L]=i; });

  const pickStyle = (styles, name, fallback) => {
    const val = styles.getPropertyValue(name).trim();
    return val || fallback;
  };
  const sectorPos = (i,R)=>{
    const a=(Math.PI*2)*(i/12)-Math.PI/2;
    return {x:300+Math.cos(a)*R, y:300+Math.sin(a)*R};
  };

  function createCircleModule(config){
    const {
      svgId,
      symbolsId,
      legend={},
      variant={},
      showSymbols=true,
      activeFill=false,
      baseStrokeWidth='2',
      activeStrokeWidth=null,
      debugLabel=null
    } = config;
    const nodes=[];
    let svg=null;
    let gSymbols=null;
    let variantBound=false;
    let currentIndex=0;
    let currentVariantIndex=0;
    let currentKind='M';
    let theme = readTheme();

    function readTheme(){
      const styles = getComputedStyle(document.documentElement);
      const accent = pickStyle(styles,'--accent','#22c55e');
      const selectBorder = pickStyle(styles,'--select-on-border', accent);
      const baseFill = pickStyle(styles,'--circle-node-fill','#0b1229');
      const baseMinorFill = pickStyle(styles,'--circle-node-minor-fill', baseFill);
      const selectBg = pickStyle(styles,'--select-on-bg', baseFill);
      const activeFillColor = pickStyle(styles,'--circle-node-on-fill', selectBg);
      const activeMinorFill = pickStyle(styles,'--circle-node-on-fill-minor', activeFillColor);
      return {
        nodeFill: baseFill,
        nodeFillMinor: baseMinorFill,
        nodeStroke: pickStyle(styles,'--circle-node-stroke','rgba(255,255,255,.35)'),
        nodeInk: pickStyle(styles,'--circle-node-ink','#e5e7eb'),
        nodeOnStroke: selectBorder,
        nodeOnFill: activeFillColor || baseFill,
        nodeOnFillMinor: activeMinorFill || activeFillColor || baseMinorFill,
        symbolSharp: pickStyle(styles,'--circle-symbol-sharp','#93c5fd'),
        symbolFlat: pickStyle(styles,'--circle-symbol-flat','#fca5a5')
      };
    }

    function applyThemeToNode(circle,text,kind){
      const parentKind = (kind || (circle && circle.parentElement ? circle.parentElement.getAttribute('data-kind') : null) || 'M').toLowerCase();
      if(circle){
        const baseFill = parentKind==='m' ? theme.nodeFillMinor : theme.nodeFill;
        circle.setAttribute('fill', baseFill);
        circle.setAttribute('stroke', theme.nodeStroke);
        circle.setAttribute('stroke-width', baseStrokeWidth);
      }
      if(text){ text.setAttribute('fill', theme.nodeInk); }
    }

    function highlightCurrent(){
      if(!svg) return;
      const g = svg.querySelector(`g[data-idx='${currentIndex}'][data-kind='${currentKind}']`);
      if(!g) return;
      const circle = g.querySelector('circle');
      const label = g.querySelector('text');
      const rawLabels = (g.dataset.rawLabels || '').split(',').filter(Boolean);
      if(circle){
        const isMinor = (currentKind||'').toLowerCase()==='m';
        circle.setAttribute('filter','url(#glow)');
        circle.setAttribute('stroke', theme.nodeOnStroke);
        circle.setAttribute('stroke-width', activeStrokeWidth || baseStrokeWidth);
        if(activeFill){
          const fill = isMinor ? (theme.nodeOnFillMinor || theme.nodeFillMinor) : (theme.nodeOnFill || theme.nodeFill);
          circle.setAttribute('fill', fill);
        }
      }
      if(label){
        label.setAttribute('fill', theme.nodeInk);
        if(rawLabels.length){
          const localized = rawLabels.map(App.utils.noteName);
          label.textContent = rawLabels.length>1 ? localized.join(' / ') : localized[0];
        }
      }
    }

    function clearHi(){
      if(!svg) return;
      svg.querySelectorAll('g[data-idx]').forEach(g=>{
        const circle = g.querySelector('circle');
        const label = g.querySelector('text');
        const isMinor = (g.getAttribute('data-kind')||'').toLowerCase()==='m';
        const rawLabels = (g.dataset.rawLabels || '').split(',').filter(Boolean);
        if(circle){
          circle.removeAttribute('filter');
          circle.setAttribute('stroke', theme.nodeStroke);
          circle.setAttribute('stroke-width', baseStrokeWidth);
          circle.setAttribute('fill', isMinor ? theme.nodeFillMinor : theme.nodeFill);
        }
        if(label){
          label.setAttribute('fill', theme.nodeInk);
          if(rawLabels.length){
            const localized = rawLabels.map(App.utils.noteName);
            label.textContent = rawLabels.length>1 ? localized.join(' / ') : localized[0];
          }
        }
      });
    }

    function currentMajor(){
      const majors=ORDER_MAJ_INFO[currentIndex].majors;
      return majors[currentVariantIndex] || majors[0];
    }

    function updateVariantButtons(){
      if(!variant.box) return;
      const varBox = el(variant.box);
      if(!varBox) return;
      const majors=ORDER_MAJ_INFO[currentIndex].majors;
      const localizedMajors = majors.map(App.utils.noteName);
      const btnA = variant.a ? el(variant.a) : null;
      const btnB = variant.b ? el(variant.b) : null;
      if(localizedMajors.length===2){
        varBox.classList.remove('hidden');
        if(btnA){
          btnA.textContent = localizedMajors[0];
          btnA.classList.toggle('on', currentVariantIndex===0);
        }
        if(btnB){
          btnB.textContent = localizedMajors[1];
          btnB.classList.toggle('on', currentVariantIndex===1);
        }
      } else {
        varBox.classList.add('hidden');
      }
    }

    function renderSymbolsForMajor(M){
      if(!showSymbols) return;
      if(!gSymbols) return;
      gSymbols.innerHTML='';
      const ks=KS_MAP[M];
      if(!ks || ks.type==='none') return;
      const isSharp=ks.type==='sharp';
      const letters=isSharp?SHARP_LETTERS:FLAT_LETTERS;
      for(let i=0;i<ks.list.length;i++){
        const idx=POS_INDEX[letters[i]];
        if(typeof idx!=='number') continue;
        const p=sectorPos(idx,R_SYMBOL);
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',p.x);
        t.setAttribute('y',p.y+8);
        t.setAttribute('text-anchor','middle');
        t.setAttribute('font-size','24');
        t.setAttribute('font-weight','900');
        t.setAttribute('fill', isSharp ? theme.symbolSharp : theme.symbolFlat);
        t.textContent = isSharp ? '♯' : '♭';
        gSymbols.appendChild(t);
      }
    }

    function updateLegend(){
      const M=currentMajor();
      if(legend.title){ const node=el(legend.title); if(node) node.textContent = `${App.utils.labelMajor(M)} / ${App.utils.labelMinor(REL_MINOR[M])}`; }
      if(legend.ks){ const node=el(legend.ks); if(node) node.textContent = ksStringForMajor(M); }
      if(legend.count){ const node=el(legend.count); if(node) node.textContent = ksCountForMajor(M); }
      if(legend.rel){ const node=el(legend.rel); if(node) node.textContent = App.utils.labelMinor(REL_MINOR[M]); }
      const ns=ORDER_MAJ_INFO[(currentIndex+1)%12].majors[0];
      const nf=ORDER_MAJ_INFO[(currentIndex+11)%12].majors[0];
      if(legend.nextSharp){ const node=el(legend.nextSharp); if(node) node.textContent = `${App.utils.labelMajor(ns)} / ${App.utils.labelMinor(REL_MINOR[ns])}`; }
      if(legend.nextFlat){ const node=el(legend.nextFlat); if(node) node.textContent  = `${App.utils.labelMajor(nf)} / ${App.utils.labelMinor(REL_MINOR[nf])}`; }
      renderSymbolsForMajor(M);
      updateVariantButtons();
    }

    function refreshTheme(){
      theme = readTheme();
      nodes.forEach(({circle,text,kind})=>applyThemeToNode(circle,text,kind));
      clearHi();
      updateLegend();
      highlightCurrent();
    }

    document.addEventListener('toniqa-theme-change', refreshTheme);

    function refreshLabels(){
      if(!svg) return;
      nodes.forEach(({group,text})=>{
        if(!group || !text) return;
        const rawLabels = (group.dataset.rawLabels || '').split(',').filter(Boolean);
        if(rawLabels.length){
          const localized = rawLabels.map(App.utils.noteName);
          text.textContent = rawLabels.length>1 ? localized.join(' / ') : localized[0];
        }
      });
      updateVariantButtons();
      updateLegend();
      highlightCurrent();
    }

    function createNode(label,i,R,kind,selectNode,rawLabels){
      const p=sectorPos(i,R);
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('data-idx',i);
      g.setAttribute('data-kind',kind);
      if(Array.isArray(rawLabels) && rawLabels.length){
        g.dataset.rawLabels = rawLabels.join(',');
      }
      g.style.cursor='pointer';
      const r=kind==='M'?28:24;
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',p.x);
      c.setAttribute('cy',p.y);
      c.setAttribute('r',r);
      c.setAttribute('stroke-width','2');
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',p.x);
      t.setAttribute('y',p.y+7);
      t.setAttribute('text-anchor','middle');
      t.setAttribute('font-size',kind==='M'?'22':'20');
      t.setAttribute('font-weight','800');
      t.textContent=label;
      applyThemeToNode(c,t,kind);
      nodes.push({circle:c,text:t,kind,group:g});
      g.appendChild(c);
      g.appendChild(t);
      g.addEventListener('click',()=>selectNode(i,kind));
      return g;
    }

    function ensureVariantListeners(){
      if(variantBound) return;
      const btnA = variant.a ? el(variant.a) : null;
      const btnB = variant.b ? el(variant.b) : null;
      if(btnA){
        btnA.addEventListener('click', ()=>{
          currentVariantIndex=0;
          updateLegend();
        });
      }
      if(btnB){
        btnB.addEventListener('click', ()=>{
          currentVariantIndex=1;
          updateLegend();
        });
      }
      variantBound = true;
    }

    function ensureCircle(selectNode){
      if(!svg) svg = el(svgId);
      if(!svg) return;
      if(svg.querySelector('g[data-idx]')) return;
      gSymbols = symbolsId ? document.getElementById(symbolsId) : null;
      ORDER_MAJ_INFO.forEach((info,i)=>{
        const label = info.majors.length===2
          ? info.majors.map(App.utils.noteName).join(' / ')
          : App.utils.noteName(info.majors[0]);
        svg.appendChild(createNode(label,i,R_MAJOR,'M',selectNode, info.majors));
      });
      ORDER_MIN.forEach((m,i)=>{
        svg.appendChild(createNode(App.utils.noteName(m),i,R_MINOR,'m',selectNode, [m]));
      });
      ensureVariantListeners();
      selectNode(0,'M');
    }

    function makeSelectNode(onPicked){
      return function selectNode(i,kind){
        currentIndex=i;
        currentKind=kind;
        currentVariantIndex=0;
        clearHi();
        highlightCurrent();
        updateLegend();
        if(typeof onPicked==='function') onPicked(i,kind);
      };
    }

    return { ensureCircle, makeSelectNode, refresh: refreshLabels };
  }

  App.circle = createCircleModule({
    svgId:'kv-svg',
    symbolsId:'kv-symbols',
    legend:{
      title:'kv-title',
      ks:'kv-ks',
      count:'kv-count',
      rel:'kv-rel',
      nextSharp:'kv-next-sharp',
      nextFlat:'kv-next-flat'
    },
    variant:{ box:'kv-variant', a:'kv-var-a', b:'kv-var-b' },
    showSymbols:true,
    activeFill:false,
    baseStrokeWidth:'2'
  });

  App.circleQuiz = createCircleModule({
    svgId:'kvq-svg',
    symbolsId:null,
    legend:{},
    variant:{},
    showSymbols:false,
    activeFill:false,
    baseStrokeWidth:'2',
    activeStrokeWidth:'3',
    debugLabel:null
  });

})();

(function(){
  const App = window.App = window.App || {};
  if(App.staffRenderer) return;
  const SVG_NS = 'http://www.w3.org/2000/svg';
  const STEP_LETTERS = ['C','D','E','F','G','A','B'];
  const STEP_INDEX = STEP_LETTERS.reduce((acc, l, idx)=>{ acc[l] = idx; return acc; }, {});
  const LETTER_TO_SEMITONE = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
  const CONSTANTS = {
    LINE_GAP: 14,
    NOTE_GAP: 56,
    STAFF_PADDING_X: 42,
    STAFF_PADDING_Y: 28,
    CLEF_OFFSET: 54,
    LABEL_SPACE: 56
  };
  const VISUAL_ACC_SPACE_UNITS = 2; // kolik vizuálních jednotek navíc pro posuvku
  const VISUAL_ACC_SPACE_PX = 14;   // kolik px navíc ve fyzickém rozložení (sloty)

  function normalizeLetter(letter){
    const raw = String(letter || 'C').trim().toUpperCase();
    return raw === 'H' ? 'B' : raw;
  }

  function normalizeAccidental(accidental){
    if(!accidental) return '';
    const raw = String(accidental).trim();
    if(raw === '♯') return '#';
    if(raw === '♭') return 'b';
    return raw;
  }

  function normalizeAccidentalForLabel(accidental){
    if(!accidental) return '';
    const raw = String(accidental).trim();
    if(raw === '♯' || raw === '#') return '#';
    if(raw === '♭' || raw === 'b') return 'b';
    if(raw === '♮' || raw === 'natural') return 'natural';
    if(raw === 'bb' || raw === '##') return raw;
    return '';
  }

  function accidentalToSymbol(accidental){
    if(accidental === '#') return '♯';
    if(accidental === 'b') return '♭';
    if(accidental === 'bb') return '♭♭';
    if(accidental === '##') return '♯♯';
    return '';
  }

  function signatureMapFromMarks(marks){
    const map = new Map();
    if(!Array.isArray(marks)) return map;
    marks.forEach(mark=>{
      let note = null;
      if(!mark) return;
      if(typeof mark === 'string'){
        try {
          note = parseNote(mark);
        } catch (_err){
          return;
        }
      } else if(typeof mark === 'object' && mark.letter){
        note = mark;
      }
      if(!note) return;
      const letter = normalizeLetter(note.letter);
      const acc = normalizeAccidentalForLabel(note.accidental);
      if(acc === '#' || acc === 'b') map.set(letter, acc);
    });
    return map;
  }

  function soundingAccidentalSymbol(note, signatureMap){
    if(!note) return '';
    const acc = normalizeAccidentalForLabel(note.accidental);
    if(acc === 'natural') return '';
    if(acc) return accidentalToSymbol(acc);
    const letter = normalizeLetter(note.letter);
    const sigAcc = signatureMap && signatureMap.get(letter);
    return sigAcc ? accidentalToSymbol(sigAcc) : '';
  }

  function noteDef(letter, accidental, octave){
    const normalizedLetter = normalizeLetter(letter);
    const normalizedAcc = normalizeAccidental(accidental);
    const note = {
      letter: normalizedLetter,
      accidental: normalizedAcc,
      octave: Number(octave || 0)
    };
    note.answer = `${normalizedLetter}${normalizedAcc}`;
    return note;
  }

  function cloneNote(note){
    if(!note) return null;
    const cloned = noteDef(note.letter, note.accidental, note.octave);
    if(note.answer) cloned.answer = note.answer;
    return cloned;
  }

  function noteFromId(id){
    const match = /^([A-Ga-gHh])([#b]?)(-?\d+)$/.exec(String(id).trim());
    if(!match) throw new Error('Invalid note id: '+id);
    return noteDef(match[1], match[2] || '', parseInt(match[3], 10));
  }

  function parseNote(str){
    const match = /^([A-Ga-gHh])([#b♯♭]?)(-?\d+)$/.exec(String(str).trim());
    if(!match) throw new Error('Invalid note: '+str);
    return noteDef(match[1], normalizeAccidental(match[2] || ''), parseInt(match[3], 10));
  }

  const CLEFS = {
    treble: { icon:'basic-clef-treble', base: parseNote('E4'), glyph:{ width:42, height:120 }, offset:{ x:-8, yFactor:6.5 } },
    bass:   { icon:'basic-clef-bass', base: parseNote('G2'), glyph:{ width:55, height:120 }, offset:{ x:-8, yFactor:6.3 } }
  };

  function noteStep(note){
    const letter = note.letter.toUpperCase();
    const step = STEP_INDEX[letter];
    if(step === undefined) throw new Error('Unknown note letter: '+letter);
    return note.octave * STEP_LETTERS.length + step;
  }

  function noteValue(note){
    const letter = normalizeLetter(note.letter);
    let value = note.octave * 12 + LETTER_TO_SEMITONE[letter];
    if(note.accidental === '#') value += 1;
    if(note.accidental === 'b') value -= 1;
    return value;
  }

  function noteId(note){
    if(!note) return '';
    const letter = note.letter || 'C';
    const accidental = note.accidental || '';
    const octave = typeof note.octave === 'number' ? note.octave : 0;
    return `${letter}${accidental}${octave}`;
  }

  function stepToNote(step){
    const total = STEP_LETTERS.length;
    const normalized = ((step % total) + total) % total;
    const letter = STEP_LETTERS[normalized];
    const octave = Math.floor(step / total);
    return { letter, accidental:'', octave };
  }

  function collectLedger(diff){
    const list = [];
    if(diff < 0){
      for(let d=0; d>=diff; d-=2){ if(d!==0) list.push(d); }
    } else if(diff > 8){
      for(let d=8; d<=diff; d+=2){ if(d!==8) list.push(d); }
    }
    return list;
  }

  function getStyleVar(name, fallback){
    const root = getComputedStyle(document.documentElement);
    const raw = root.getPropertyValue(name);
    return raw && raw.trim() ? raw.trim() : fallback;
  }

  function getInk(){
    return getStyleVar('--ink', '#e5e7eb');
  }

  function getStaffColor(){
    // sjednocení na základní barvu (ink) pro čáry, předznamenání, pomocné linky…
    return getInk();
  }

  function normalizeClef(clef){
    if(!clef) return CLEFS.treble;
    if(typeof clef === 'string') return CLEFS[clef] || CLEFS.treble;
    if(clef.base && clef.icon){
      return {
        icon: clef.icon,
        base: clef.base,
        glyph: clef.glyph || { width:42, height:120 },
        offset: clef.offset || { x:-8, yFactor:6.5 }
      };
    }
    return CLEFS.treble;
  }

  function render({ container, clef, notes=[], options={} }){
    if(!container) return null;
    const config = normalizeClef(clef);
    const classes = options.classes || {};
    const selectable = Boolean(options.selectable);
    const signatureMap = signatureMapFromMarks(options.signatureMarks);
    const hasCustomLabel = typeof options.initialLabel === 'function';
    const initialLabel = hasCustomLabel ? options.initialLabel : null;
    const accidentalScope = options.accidentalScope === 'note' ? 'note' : 'bar';
    const barEpsilon = 0.5;
    let barXs = null;
    let barIndex = 0;
    let nextBarX = null;
    let accState = new Map(signatureMap);
    const resetAccidentals = ()=>{ accState = new Map(signatureMap); };
    const renderNote = typeof options.renderNote === 'function' ? options.renderNote : ()=>'visible';
    const debugStems = options.debugStems === true;
    const noteRadius = options.noteRadius || { rx:9, ry:7 };
    const defaultStemMode = options.defaultStem || 'none'; // 'none' | 'auto'
    const showAccidentals = options.showAccidentals !== false;

    const paddingX = typeof options.paddingX === 'number' ? options.paddingX : CONSTANTS.STAFF_PADDING_X;
    const paddingY = typeof options.paddingY === 'number' ? options.paddingY : CONSTANTS.STAFF_PADDING_Y;
    const labelMargin = typeof options.labelMargin === 'number' ? options.labelMargin : CONSTANTS.LABEL_SPACE;
    const clefOffset = typeof options.clefOffset === 'number' ? options.clefOffset : CONSTANTS.CLEF_OFFSET;
    const noteGap = typeof options.noteGap === 'number' ? options.noteGap : CONSTANTS.NOTE_GAP;
    const lineGap = typeof options.lineGap === 'number' ? options.lineGap : CONSTANTS.LINE_GAP;
    const rawLeadingSpace = options.leadingSpace;
    const leadingSpace = typeof rawLeadingSpace === 'number' ? rawLeadingSpace : 0;
    const extraTopOpt = typeof options.extraTop === 'number' ? options.extraTop : 0;
    const extraBottomOpt = typeof options.extraBottom === 'number' ? options.extraBottom : 0;
    const fillWidth = options.fillWidth !== false;
    const layout = options.layout || null;
    const barUnitsOpt = Array.isArray(options.barUnits) ? options.barUnits.slice() : (layout && Array.isArray(layout.barUnits) ? layout.barUnits.slice() : null);
    const finalBar = options.finalBar === true; // výchozí: nekreslit koncovou čáru, jen na vyžádání
    const FINAL_BAR_GAP_BEFORE = 22;
    const FINAL_BAR_GAP_BETWEEN = 6;
    const FINAL_BAR_THICK_WIDTH = 4;

    const baseStep = noteStep(config.base);
    const noteSteps = notes.length ? notes.map(noteStep) : [baseStep];
    const maxStep = Math.max(...noteSteps);
    const minStep = Math.min(...noteSteps);
    const ledgerTopPx = Math.max(0, maxStep - (baseStep + 8)) * (lineGap / 2);
    const ledgerBottomPx = Math.max(0, baseStep - minStep) * (lineGap / 2);
    // rezervujeme místo nahoře alespoň o dvě linky (kvůli klíči)
    const minTopPad = lineGap * 2;
    const extraTopPx = Math.max(extraTopOpt, ledgerTopPx, minTopPad);
    const extraBottomPx = Math.max(extraBottomOpt, ledgerBottomPx);

    const staffHeight = lineGap * 5;
    const totalHeight = paddingY * 2 + extraTopPx + staffHeight + extraBottomPx + labelMargin;
    const variableSpacing = options.variableSpacing === true || !!layout;
    const durations = variableSpacing
      ? notes.map(n=> (App.noteDrawing && typeof App.noteDrawing.durationUnits === 'function') ? App.noteDrawing.durationUnits(n) : 1)
      : notes.map(()=>1);
    let spans = variableSpacing
      ? (layout && Array.isArray(layout.spans) ? layout.spans.slice() : durations.map(u=> (App.noteDrawing && typeof App.noteDrawing.glyphSpan === 'function') ? App.noteDrawing.glyphSpan(u) : (u * noteGap)))
      : durations.map(()=>noteGap);
    const rawSpan = spans.reduce((sum,v)=>sum + v, 0);
    const spanScaleTarget = typeof options.maxContentWidth === 'number' ? options.maxContentWidth : null;
    const spanScale = layout && typeof layout.spanScale === 'number'
      ? layout.spanScale
      : (spanScaleTarget && rawSpan > 0 ? Math.min(1, spanScaleTarget / rawSpan) : 1);
    if(!layout && spanScale !== 1) spans = spans.map(v=>v * spanScale);
    let totalSpan = layout && typeof layout.totalSpan === 'number'
      ? layout.totalSpan
      : spans.reduce((sum,v)=>sum + v, 0);
    const totalUnits = layout && typeof layout.totalUnits === 'number'
      ? layout.totalUnits
      : durations.reduce((sum,v)=>sum + v, 0);
    if(layout && Array.isArray(layout.barXs) && layout.barXs.length){
      barXs = layout.barXs.slice();
    } else if(barUnitsOpt && barUnitsOpt.length){
      const unitWidth = variableSpacing && totalUnits ? (totalSpan / totalUnits) : noteGap;
      barXs = barUnitsOpt.map(u=> u * unitWidth);
    }
    nextBarX = barXs && barXs.length ? barXs[0] : null;
    const span = Math.max(0, notes.length - 1);
    const barPadSpace = 0;
    const finalExtra = finalBar ? (FINAL_BAR_GAP_BEFORE + FINAL_BAR_GAP_BETWEEN ) : 0;
    const width = paddingX * 2 + clefOffset + leadingSpace + (variableSpacing ? totalSpan + barPadSpace : span * noteGap + noteGap) + finalExtra;
    const stepHeight = lineGap / 2;
    const debugLabel = options.debugLabel || 'staff';
    // if(options.debugLayout || options.debugPositions){
    //   const clefX = paddingX + (config.offset && typeof config.offset.x === 'number' ? config.offset.x : -8);
    //   const firstNoteX = paddingX + clefOffset + leadingSpace;
    //   const formula = `${firstNoteX} = paddingX(${paddingX}) + clefOffset(${clefOffset}) + leadingSpace(${leadingSpace}) + noteGap*0`;
    //   const widthFormula = `${width} = paddingX(${paddingX})*2 + clefOffset(${clefOffset}) + leadingSpace(${leadingSpace}) + span(${span})*noteGap(${noteGap}) + noteGap(${noteGap})`;
    //   console.log('[staff debug]', debugLabel, {
    //     rawLeadingSpace,
    //     clefX,
    //     paddingX,
    //     clefOffset,
    //     leadingSpace,
    //     noteGap,
    //     span,
    //     firstNoteX,
    //     formula,
    //     width,
    //     widthFormula
    //   });
    // }

    container.innerHTML = '';
    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', `0 0 ${width} ${totalHeight}`);
    svg.setAttribute('width', width);
    svg.setAttribute('height', totalHeight);
    svg.setAttribute('preserveAspectRatio', 'xMinYMid meet');
    if(fillWidth){
      svg.style.width = '100%';
      svg.style.maxWidth = '100%';
    } else {
      svg.style.width = `${width}px`;
    }
    svg.style.height = 'auto';
    svg.style.color = getInk();
    container.appendChild(svg);

    const staffColor = getStaffColor();
    const bottomY = paddingY + extraTopPx + staffHeight;
    const labelY = bottomY + extraBottomPx + labelMargin;

    for(let i=0;i<5;i++){
      const y = bottomY - i * lineGap;
      const line = document.createElementNS(SVG_NS, 'line');
      line.setAttribute('x1', paddingX);
      line.setAttribute('x2', width - paddingX);
      line.setAttribute('y1', y);
      line.setAttribute('y2', y);
      line.setAttribute('stroke', staffColor);
      line.setAttribute('stroke-width', '2');
      line.setAttribute('stroke-linecap', 'round');
      svg.appendChild(line);
    }

    const clefUse = document.createElementNS(SVG_NS, 'use');
    clefUse.setAttribute('href', `#${config.icon}`);
    const offsetX = config.offset && typeof config.offset.x === 'number' ? config.offset.x : -8;
    const offsetFactor = config.offset && typeof config.offset.yFactor === 'number' ? config.offset.yFactor : 6.5;
    clefUse.setAttribute('x', paddingX + offsetX);
    clefUse.setAttribute('y', bottomY - offsetFactor * lineGap);
    const glyph = config.glyph || {};
    clefUse.setAttribute('width', String(glyph.width || 42));
    clefUse.setAttribute('height', String(glyph.height || 120));
    clefUse.setAttribute('fill', getInk());
    if(classes.clef) clefUse.setAttribute('class', classes.clef);
    svg.appendChild(clefUse);

    // Optional meter (after clef + signature + gap)
    if(options.meter && App.noteDrawing && typeof App.noteDrawing.appendTimeSignature === 'function'){
      const sigSpace = typeof options.debugSignatureSpace === 'number' ? options.debugSignatureSpace : 0;
      const meterSpace = typeof options.debugMeterSpace === 'number' ? options.debugMeterSpace : 32;
      const gapSpace = Math.max(0, leadingSpace - sigSpace - meterSpace);
      const meterX = paddingX + clefOffset + sigSpace + (meterSpace / 2) + gapSpace;
      App.noteDrawing.appendTimeSignature(svg, options.meter, {
        x: meterX,
        startY: bottomY - lineGap * 4.5, // posun výš, aby bylo metrum uprostřed osnovy
        gap: lineGap * 1.1,
        fontSize:30,
        color: staffColor
      });
    }

    const groups = [];
    let unitCursor = 0;
    const beamStems = new Map();
    const beamDirChoice = new Map(); // drží jednotný směr nožek pro každou beam skupinu
      notes.forEach((note, index)=>{
        const mode = String(renderNote(note, index) || 'visible');
        const isRest = mode !== 'skip' && (note.kind === 'rest' || (note.meta && note.meta.kind === 'rest'));
        const noteType = note.noteType || note.duration || note.value || 'quarter';
        const diff = isRest ? 4 : (noteStep(note) - baseStep);
        const centerY = bottomY - diff * stepHeight;
      const slotStart = layout && Array.isArray(layout.xs) ? (layout.xs[index] || 0) : (variableSpacing ? unitCursor : index * noteGap);
      if(accidentalScope === 'bar'){
        while(nextBarX !== null && slotStart >= (nextBarX - barEpsilon)){
          barIndex += 1;
          resetAccidentals();
          nextBarX = barXs && barIndex < barXs.length ? barXs[barIndex] : null;
        }
      }
      const slotSpanBase = layout && Array.isArray(layout.spans) ? (layout.spans[index] || 0) : (variableSpacing ? (spans[index] || noteGap) : noteGap);
      const hasLayoutSpans = layout && Array.isArray(layout.spans);
      const forceAccidental = note.meta && note.meta.forceAccidental === true;
      const accSpaceFn = (typeof shouldAddAccidentalSpace === 'function') ? shouldAddAccidentalSpace : () => false;
      const addAccSpace = accSpaceFn(note, {
        showAccidentals,
        accidentalSpaceMode: options.accidentalSpace || 'all'
      }) || forceAccidental;
      const effectiveAccSpace = (addAccSpace && !isRest) ? VISUAL_ACC_SPACE_PX : 0;
      // Pokud už layout přepočítal vizuální jednotky (spans), další px rezervu nepřidáváme do šířky.
      const accidentalSpace = (!hasLayoutSpans && addAccSpace && !isRest) ? effectiveAccSpace : 0;
      const slotSpan = slotSpanBase + accidentalSpace;
      const headShiftFactor = addAccSpace ? 0.28 : 0.30; // s posuvkou posuň hlavičku víc doprava (víc místa vlevo)
      const accLeftPad = addAccSpace ? accidentalSpace * 0.6 : 0; // posuň hlavičku víc doprava, aby se posuvka nevepsala do předchozí noty
      const slotShift = addAccSpace ? (slotSpanBase * headShiftFactor + accLeftPad) : (slotSpanBase * headShiftFactor);
      const x = paddingX + clefOffset + leadingSpace + slotStart + slotShift;

      const group = document.createElementNS(SVG_NS, 'g');
      if(classes.group) group.setAttribute('class', classes.group);
      group.dataset.index = String(index);
      group.dataset.mode = mode;
      if(selectable) group.style.cursor = 'pointer';

        let circleEl = null;
        let noteShape = null;
        if(mode !== 'skip'){
          if(isRest && App.noteDrawing && typeof App.noteDrawing.buildRestGlyph === 'function'){
            const glyph = App.noteDrawing.buildRestGlyph(noteType);
          if(glyph){
            glyph.setAttribute('transform', `translate(${x},${centerY})`);
            group.appendChild(glyph);
          }
          } else {
            const hollow = noteType === 'whole' || noteType === 'half';
            let flags = typeof note.flags === 'number'
              ? note.flags
              : (noteType === 'sixteenth' ? 2 : (noteType === 'eighth' ? 1 : 0));
            if(note.beam) flags = 0; // beamované noty bez praporků
            const explicitStem = note.stem;
            let stemDir = (()=>{ // auto směr nožky podle výšky (nad střední linkou dolů)
              if(explicitStem === 'up' || explicitStem === 'down' || explicitStem === 'none') return explicitStem;
              if(noteType === 'whole') return 'none';
              if(note.beam || flags > 0) return diff >= 4 ? 'down' : 'up';
              if(defaultStemMode === 'auto') return diff >= 4 ? 'down' : 'up';
              return 'none';
            })();
            if(note.beam){
              const beamId = String(note.beam);
              const chosen = beamDirChoice.get(beamId);
              if(chosen){
                stemDir = chosen;
              } else {
                const dir = stemDir === 'down' ? 'down' : 'up';
                beamDirChoice.set(beamId, dir);
                stemDir = dir;
              }
            }
            if(App.noteDrawing && typeof App.noteDrawing.addSimpleNote === 'function'){
              noteShape = App.noteDrawing.addSimpleNote(group, x, centerY, {
                noteType,
                stem: stemDir,
                hollow,
              flags,
              scale: note.scale
            });
            if(noteShape) noteShape.beamDir = stemDir;
          } else {
            const circle = document.createElementNS(SVG_NS, 'ellipse');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', centerY);
            circle.setAttribute('rx', String(noteRadius.rx || 9));
            circle.setAttribute('ry', String(noteRadius.ry || 7));
            circle.setAttribute('stroke', 'none');
            circle.setAttribute('data-role', 'note-head');
            circle.setAttribute('fill', getInk());
            if(classes.noteHead) circle.setAttribute('class', classes.noteHead);
            group.appendChild(circle);
            circleEl = circle;
          }

          if((showAccidentals || forceAccidental) && mode !== 'ghost' && !isRest){
            if(note.accidental === '#'){
              const acc = document.createElementNS(SVG_NS, 'text');
              const accOffset = hasLayoutSpans ? 26 : (accidentalSpace ? Math.max(18, accidentalSpace * 0.8 + 14) : 16);
              acc.setAttribute('x', x - accOffset);
              acc.setAttribute('y', centerY + 10);
              acc.setAttribute('font-size', '30');
              acc.setAttribute('font-weight', '500');
              acc.setAttribute('fill', getInk());
              acc.setAttribute('data-role', 'accidental');
              acc.textContent = '♯';
              group.appendChild(acc);
            } else if(note.accidental === 'b'){
              const acc = document.createElementNS(SVG_NS, 'text');
              const accOffset = hasLayoutSpans ? 26 : (accidentalSpace ? Math.max(16, accidentalSpace * 0.8 + 10) : 10);
              acc.setAttribute('x', x - accOffset);
              acc.setAttribute('y', centerY + 10);
              acc.setAttribute('font-size', '34');
              acc.setAttribute('font-weight', '500');
              acc.setAttribute('fill', getInk());
              acc.setAttribute('data-role', 'accidental');
              acc.textContent = '♭';
              group.appendChild(acc);
            } else if(note.accidental === '♮' || note.accidental === 'natural'){
              const acc = document.createElementNS(SVG_NS, 'text');
              const accOffset = hasLayoutSpans ? 26 : (accidentalSpace ? Math.max(14, accidentalSpace * 0.6 + 6) : 6);
              acc.setAttribute('x', x - accOffset);
              acc.setAttribute('y', centerY + 10);
              acc.setAttribute('font-size', '30');
              acc.setAttribute('font-weight', '500');
              acc.setAttribute('fill', getInk());
              acc.setAttribute('data-role', 'accidental');
              acc.textContent = '♮';
              group.appendChild(acc);
            }
          }
        }
      }

      if(mode !== 'ghost' && !isRest){
        collectLedger(diff).forEach(pos=>{
          const y = bottomY - pos * stepHeight;
          const line = document.createElementNS(SVG_NS, 'line');
          line.setAttribute('x1', x - 18);
          line.setAttribute('x2', x + 18);
          line.setAttribute('y1', y);
          line.setAttribute('y2', y);
          line.setAttribute('stroke', staffColor);
          line.setAttribute('stroke-width', '2');
          line.setAttribute('stroke-linecap', 'round');
          line.setAttribute('data-role', 'ledger');
          group.appendChild(line);
        });
      }

      svg.appendChild(group);

      const label = document.createElementNS(SVG_NS, 'text');
      label.setAttribute('x', x);
      label.setAttribute('y', labelY + 10); // posun níž kvůli překryvu s nejnižšími notami
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('font-size','16');
      label.setAttribute('font-weight','700');
      label.setAttribute('data-role', 'note-label');
      if(classes.label) label.setAttribute('class', classes.label);
      let labelValue = '';
      if(initialLabel){
        labelValue = initialLabel(note, index, mode);
      } else {
        const isRest = note && (note.kind === 'rest' || (note.meta && note.meta.kind === 'rest'));
        const hidden = mode === 'skip';
        if(!note || isRest || hidden){
          labelValue = '';
        } else {
          const letter = normalizeLetter(note.letter);
          const explicit = normalizeAccidentalForLabel(note.accidental);
          let effective = '';
          if(explicit){
            if(explicit === 'natural'){
              effective = '';
              if(accidentalScope === 'bar') accState.set(letter, '');
            } else {
              effective = explicit;
              if(accidentalScope === 'bar') accState.set(letter, explicit);
            }
          } else {
            effective = (accidentalScope === 'bar') ? (accState.get(letter) || '') : '';
          }
          const labelRaw = `${letter}${accidentalToSymbol(effective)}`;
          labelValue = (window.App && App.utils && typeof App.utils.noteName === 'function')
            ? App.utils.noteName(labelRaw)
            : labelRaw;
        }
      }
      label.textContent = labelValue || '';
      svg.appendChild(label);

      groups.push({ group, circle: circleEl, answerLabel: label, note, mode });
      unitCursor += slotSpan;

      if(options.debugPositions && typeof placeLog === 'function'){
        placeLog('slotDebug', {
          idx: index,
          accidental: note.accidental || '',
          slotStart,
          slotSpanBase,
          accidentalSpace,
          slotSpan,
          slotShift,
          x
        });
      }

      if(noteShape && note && note.beam){
        const beamId = String(note.beam);
        if(!beamStems.has(beamId)) beamStems.set(beamId, []);
        const chosenDir = beamDirChoice.get(beamId) || note.stem || (noteShape && noteShape.beamDir);
        const dir = chosenDir === 'down' ? 'down' : 'up';
        beamStems.get(beamId).push({
          stemX: noteShape.stemX,
          stemTopY: noteShape.stemTopY,
          stemBottomY: noteShape.stemBottomY,
          headY: noteShape.headY,
          dir,
          note,
          beams: Math.max(1, (typeof note.flags === 'number' && note.flags > 0) ? note.flags : (noteType === 'sixteenth' ? 2 : (noteType === 'eighth' ? 1 : 1)))
        });
      }
    });

    // Draw beams for notes sharing the same beam id
    if(App.noteDrawing && typeof App.noteDrawing.addBeamBetween === 'function' && beamStems.size){
      beamStems.forEach(list=>{
        list.sort((a,b)=> (a.stemX || 0) - (b.stemX || 0));
        for(let i=0;i<list.length-1;i++){
          const cur = list[i];
          const next = list[i+1];
          const dir = cur.dir || 'up';
          const beams = Math.max(cur.beams || 1, next.beams || 1);
          App.noteDrawing.addBeamBetween(svg, cur, next, dir, 8, beams);
        }
        // Tuplet číslo: pokud některý z členů má meta.tuplet, zobrazíme nad/pod skupinou
        const tupleNote = list.find(n=> n.note && n.note.meta && n.note.meta.tuplet);
        if(tupleNote){
          const t = tupleNote.note.meta.tuplet;
          const num = (t && typeof t === 'object' && typeof t.n === 'number') ? t.n : 3;
          const dir = list[0].dir || 'up';
          const x1 = list[0].stemX;
          const x2 = list[list.length - 1].stemX;
          const yBase = dir === 'up'
            ? Math.min(...list.map(n=>n.stemTopY || n.headY || 0)) - 10
            : Math.max(...list.map(n=>n.stemBottomY || n.headY || 0)) + 18;
          const txt = document.createElementNS(SVG_NS, 'text');
          txt.setAttribute('x', String((x1 + x2) / 2));
          txt.setAttribute('y', String(yBase));
          txt.setAttribute('text-anchor', 'middle');
          txt.setAttribute('font-size', '21'); // o 50 % větší
          txt.setAttribute('font-weight', '600');
          txt.setAttribute('fill', getInk()); // základní barva
          txt.textContent = String(num);
          svg.appendChild(txt);
        }
      });
    }

    // možnost zamknout metriky (pro stabilní layout při přerenderu)
    let metrics = {
      baseStep,
      bottomY,
      topY: bottomY - staffHeight,
      stepHeight,
      paddingX,
      clefOffset,
      noteGap,
      leadingSpace,
      width,
      labelY,
      totalHeight,
      paddingY,
      extraTop: extraTopPx,
      extraBottom: extraBottomPx,
      staffColor,
      minStep,
      maxStep,
      variableSpacing,
      totalSpan,
      totalUnits,
      unitWidth: variableSpacing && totalUnits ? totalSpan / totalUnits : noteGap,
      spanScale
    };
    if(options.lockMetrics && options.prevMetrics){
      const prev = options.prevMetrics;
      const locked = ['noteGap','paddingX','paddingY','clefOffset','leadingSpace','bottomY','topY','stepHeight','totalHeight','width','labelY','baseStep'];
      locked.forEach(key=>{
        if(prev && Object.prototype.hasOwnProperty.call(prev, key)) metrics[key] = prev[key];
      });
      // přepočet odvozených hodnot podle width/leadingSpace a případného uzamčeného noteGap
      const unitW = variableSpacing && totalUnits ? totalSpan / totalUnits : metrics.noteGap;
      metrics.unitWidth = unitW;
      totalSpan = layout && typeof layout.totalSpan === 'number'
        ? layout.totalSpan
        : totalUnits * unitW;
    }

    // Barlines (optional, based on units; uses unitWidth)
    const barPositions = layout && Array.isArray(layout.barXs) && layout.barXs.length
      ? layout.barXs.map(x=> paddingX + clefOffset + leadingSpace + x)
      : (barUnitsOpt && barUnitsOpt.length
        ? barUnitsOpt.map(u=> paddingX + clefOffset + leadingSpace + u * (metrics.unitWidth || metrics.noteGap))
        : []);
    const barTop = bottomY - staffHeight + lineGap; // zkrácení o jednu linku
    barPositions.forEach(x0=>{
      const line = document.createElementNS(SVG_NS, 'line');
      line.setAttribute('x1', x0);
      line.setAttribute('x2', x0);
      line.setAttribute('y1', barTop);
      line.setAttribute('y2', bottomY);
      line.setAttribute('stroke', getInk()); // základní barva
      line.setAttribute('stroke-width', '2');
      line.setAttribute('stroke-linecap', 'butt');
      svg.appendChild(line);
    });
    if(finalBar){
      const finalGapBefore = FINAL_BAR_GAP_BEFORE;
      const endX = paddingX + clefOffset + leadingSpace + (layout && typeof layout.totalSpan === 'number'
        ? layout.totalSpan
        : totalUnits * (metrics.unitWidth || metrics.noteGap)) + finalGapBefore;
      // ukončovací dvojitá čára: tenká + silná s mezerou
      const endY1 = barTop;
      const endY2 = bottomY;
      const thin = document.createElementNS(SVG_NS, 'line');
      thin.setAttribute('x1', endX);
      thin.setAttribute('x2', endX);
      thin.setAttribute('y1', endY1);
      thin.setAttribute('y2', endY2);
      thin.setAttribute('stroke', getInk());
      thin.setAttribute('stroke-width', '2');
      thin.setAttribute('stroke-linecap', 'butt');
      svg.appendChild(thin);

      const gap = FINAL_BAR_GAP_BETWEEN;
      const thickX = endX + gap;
      const thick = document.createElementNS(SVG_NS, 'line');
      thick.setAttribute('x1', thickX);
      thick.setAttribute('x2', thickX);
      thick.setAttribute('y1', endY1);
      thick.setAttribute('y2', endY2);
      thick.setAttribute('stroke', getInk());
      thick.setAttribute('stroke-width', String(FINAL_BAR_THICK_WIDTH));
      thick.setAttribute('stroke-linecap', 'butt');
      svg.appendChild(thick);
    }

    // Debug zóny: padding, klíč/leading, takty
    if(options.debugZones){
      const zones = [];
      const contentStart = paddingX;
      const clefZoneEnd = paddingX + clefOffset - leadingSpace;
      const contentEnd = finalBar
        ? paddingX + clefOffset + leadingSpace + (layout && typeof layout.totalSpan === 'number'
          ? layout.totalSpan
          : totalUnits * (metrics.unitWidth || metrics.noteGap))
        : width - paddingX;

      zones.push({ x:0, w:paddingX, label:`padL ${Math.round(paddingX)}` , color:'rgba(46, 204, 113, 0.18)' });
      zones.push({ x:contentStart, w:(width - paddingX) - contentStart, label:`content ${Math.round((width - paddingX) - contentStart)}`, color:'rgba(52, 152, 219, 0.1)' });
      zones.push({ x:paddingX, w:(clefZoneEnd - paddingX), label:`clef+lead ${Math.round(clefZoneEnd - paddingX)}`, color:'rgba(231, 76, 60, 0.12)' });

      // Podzóna pro předznamenání a metrum (pokud máme data)
      const sigW = typeof options.debugSignatureSpace === 'number' ? options.debugSignatureSpace : 0;
      const meterW = typeof options.debugMeterSpace === 'number' ? options.debugMeterSpace : 0;
      const leadGap = 0;//Math.max(0, leadingSpace - sigW - meterW);
      let subX = paddingX + clefOffset;
      if(sigW > 0) zones.push({ x: subX, w: sigW, label:`sig ${Math.round(sigW)}`, color:'rgba(155, 89, 182, 0.18)' });
      subX += sigW;
      if(meterW > 0) zones.push({ x: subX, w: meterW, label:`meter ${Math.round(meterW)}`, color:'rgba(241, 196, 15, 0.18)' });
      subX += meterW;
      if(leadGap > 0) zones.push({ x: subX, w: leadGap, label:`gap ${Math.round(leadGap)}`, color:'rgba(52, 73, 94, 0.12)' });

      const measureStarts = [];
      const allBars = barPositions.slice().sort((a,b)=>a-b);
      const firstStart = paddingX + clefOffset + leadingSpace;
      measureStarts.push(firstStart);
      allBars.forEach(bx=>measureStarts.push(bx));
      if(finalBar) measureStarts.push(contentEnd);
      for(let i=0;i<measureStarts.length-1;i++){
        const start = measureStarts[i];
        const end = measureStarts[i+1];
        const w = end - start;
        if(w > 0){
          zones.push({
            x:start,
            w,
            label:`bar${i+1} ${Math.round(w)}`,
            color: i%2===0 ? 'rgba(155, 89, 182, 0.12)' : 'rgba(241, 196, 15, 0.12)'
          });
        }
      }

      const addZone = (z)=>{
        const rect = document.createElementNS(SVG_NS, 'rect');
        rect.setAttribute('x', z.x);
        rect.setAttribute('y', paddingY / 2);
        rect.setAttribute('width', z.w);
        rect.setAttribute('height', staffHeight + extraTopPx + extraBottomPx);
        rect.setAttribute('fill', z.color);
        rect.setAttribute('stroke', 'none');
        svg.insertBefore(rect, svg.firstChild);
        const txt = document.createElementNS(SVG_NS, 'text');
        txt.setAttribute('x', z.x + z.w / 2);
        txt.setAttribute('y', paddingY / 2 + 12);
        txt.setAttribute('text-anchor', 'middle');
        txt.setAttribute('font-size', '12');
        txt.setAttribute('fill', staffColor);
        txt.textContent = z.label;
        svg.insertBefore(txt, svg.firstChild);
      };
      zones.forEach(addZone);

      // highlight jednotlivé notové sloty (spans) pro ladění mezer
      const slotY = paddingY / 2 + 24;
      notes.forEach((_, idx)=>{
        const x = paddingX + clefOffset + leadingSpace + (layout && Array.isArray(layout.xs) ? (layout.xs[idx] || 0) : 0);
        const w = (layout && Array.isArray(layout.spans)) ? (layout.spans[idx] || 0) : (noteGap);
        if(w <= 0) return;
        const rect = document.createElementNS(SVG_NS, 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', slotY);
        rect.setAttribute('width', w);
        rect.setAttribute('height', Math.max(16, staffHeight * 0.18));
        rect.setAttribute('fill', 'rgba(52, 73, 94, 0.12)');
        rect.setAttribute('stroke', 'none');
        svg.insertBefore(rect, svg.firstChild);
        const txt = document.createElementNS(SVG_NS, 'text');
        txt.setAttribute('x', x + w / 2);
        txt.setAttribute('y', slotY + 12);
        txt.setAttribute('text-anchor', 'middle');
        txt.setAttribute('font-size', '11');
        txt.setAttribute('fill', staffColor);
        txt.textContent = `${idx+1}:${Math.round(w)}`;
        svg.insertBefore(txt, svg.firstChild);
      });
    }

    function setActive(index){
      const idx = typeof index === 'number' ? index : -1;
      groups.forEach((entry, i)=>{
        if(entry && entry.group){
          entry.group.classList.toggle('is-playing', i === idx);
        }
      });
    }

    return { svg, groups, metrics, setActive };
  }

  App.staffRenderer = {
    render,
    parseNote,
    noteStep,
    noteValue,
    noteId,
    stepToNote,
    collectLedger,
    noteDef,
    cloneNote,
    noteFromId,
    constants: CONSTANTS,
    getClefConfig: normalizeClef,
    CLEFS
  };


(function(){
  const App = window.App = window.App || {};
  function create({ container, items = [], value = { min:0, max:0 }, onChange, minLabel, maxLabel }){
    if(!container) return null;
    container.innerHTML = '';
    container.classList.add('range-slider-ready');

    const track = document.createElement('div');
    track.className = 'range-slider-track';
    const fill = document.createElement('div');
    fill.className = 'range-slider-fill';
    track.appendChild(fill);
    container.appendChild(track);

    const inputMin = document.createElement('input');
    inputMin.type = 'range';
    inputMin.step = 1;
    inputMin.className = 'range-slider-input range-slider-input--min';
    container.appendChild(inputMin);

    const inputMax = document.createElement('input');
    inputMax.type = 'range';
    inputMax.step = 1;
    inputMax.className = 'range-slider-input range-slider-input--max';
    container.appendChild(inputMax);

    let optionItems = Array.isArray(items) ? items.slice() : [];
    let labels = {
      min: typeof minLabel === 'string' ? minLabel : '',
      max: typeof maxLabel === 'string' ? maxLabel : ''
    };

    const applyLabels = ()=>{
      if(labels.min && labels.min.length){
        inputMin.setAttribute('aria-label', labels.min);
      } else {
        inputMin.removeAttribute('aria-label');
      }
      if(labels.max && labels.max.length){
        inputMax.setAttribute('aria-label', labels.max);
      } else {
        inputMax.removeAttribute('aria-label');
      }
    };

    const handleFocus = ()=> container.classList.add('range-slider-focused');
    const handleBlur = ()=> container.classList.remove('range-slider-focused');

    const clamp = (min, max)=>{
      const upper = optionItems.length ? optionItems.length - 1 : 0;
      let a = Math.max(0, Math.min(min, upper));
      let b = Math.max(a, Math.min(max, upper));
      return { min:a, max:b };
    };

    const applyAttributes = ()=>{
      const upper = optionItems.length ? optionItems.length - 1 : 0;
      inputMin.min = '0';
      inputMin.max = String(upper);
      inputMax.min = '0';
      inputMax.max = String(upper);
    };

    const updateFill = ()=>{
      const upper = optionItems.length > 1 ? optionItems.length - 1 : 1;
      const minVal = Number(inputMin.value);
      const maxVal = Number(inputMax.value);
      const minPct = upper ? (minVal / upper) * 100 : 0;
      const maxPct = upper ? (maxVal / upper) * 100 : 100;
      fill.style.left = `${minPct}%`;
      fill.style.right = `${100 - maxPct}%`;
    };

    const emitChange = ()=>{
      if(typeof onChange === 'function'){
        onChange({ min: Number(inputMin.value), max: Number(inputMax.value) });
      }
    };

    const setValues = (min, max, silent)=>{
      const clamped = clamp(min, max);
      inputMin.value = String(clamped.min);
      inputMax.value = String(clamped.max);
      updateFill();
      if(!silent) emitChange();
    };

    const handleMin = (evt)=>{
      const min = Number(evt.target.value);
      const max = Number(inputMax.value);
      if(min > max){
        setValues(max, max, true);
        updateFill();
        emitChange();
        return;
      }
      updateFill();
      emitChange();
    };

    const handleMax = (evt)=>{
      const max = Number(evt.target.value);
      const min = Number(inputMin.value);
      if(max < min){
        setValues(min, min, true);
        updateFill();
        emitChange();
        return;
      }
      updateFill();
      emitChange();
    };

    inputMin.addEventListener('input', handleMin);
    inputMax.addEventListener('input', handleMax);
    inputMin.addEventListener('focus', handleFocus);
    inputMin.addEventListener('blur', handleBlur);
    inputMax.addEventListener('focus', handleFocus);
    inputMax.addEventListener('blur', handleBlur);

    const api = {
      setItems(newItems, newValue, newLabels){
        optionItems = Array.isArray(newItems) ? newItems.slice() : [];
        applyAttributes();
        const upper = optionItems.length ? optionItems.length - 1 : 0;
        const desired = newValue || { min:0, max:upper };
        setValues(desired.min ?? 0, desired.max ?? upper, true);
        if(newLabels) api.setLabels(newLabels);
      },
      setValue(range){
        if(!range) return;
        setValues(range.min, range.max, true);
      },
      getValue(){
        return { min:Number(inputMin.value), max:Number(inputMax.value) };
      },
      setLabels(newLabels={}){
        if(!newLabels || typeof newLabels !== 'object') return;
        if(Object.prototype.hasOwnProperty.call(newLabels, 'min')){
          labels.min = newLabels.min ?? '';
        }
        if(Object.prototype.hasOwnProperty.call(newLabels, 'max')){
          labels.max = newLabels.max ?? '';
        }
        applyLabels();
      },
      destroy(){
        inputMin.removeEventListener('input', handleMin);
        inputMax.removeEventListener('input', handleMax);
        inputMin.removeEventListener('focus', handleFocus);
        inputMin.removeEventListener('blur', handleBlur);
        inputMax.removeEventListener('focus', handleFocus);
        inputMax.removeEventListener('blur', handleBlur);
        container.classList.remove('range-slider-focused');
        container.innerHTML = '';
      }
    };

    applyAttributes();
    applyLabels();
    const initialUpper = optionItems.length ? optionItems.length - 1 : 0;
    const initValue = value || { min:0, max:initialUpper };
    api.setItems(optionItems, initValue);
    updateFill();

    return api;
  }

  App.rangeSlider = { create };
})();
})();

(function(){
  const App = window.App = window.App || {};
  const staffRenderer = App.staffRenderer;
  if(!staffRenderer) return;
  const { render: renderStaffShared, parseNote, noteValue, noteId, noteDef, cloneNote, noteFromId, getClefConfig, CLEFS } = staffRenderer;
  const utils = App.utils || {};
  const choiceChips = typeof utils.choiceChips === 'function' ? utils.choiceChips : function(container, options, selectedValue, onSelect){
    if(!container) return [];
    container.innerHTML = '';
    const buttons = [];
    options.forEach(opt=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip';
      btn.dataset.value = String(opt.value);
      btn.textContent = opt.label;
      if(opt.disabled){
        btn.disabled = true;
      } else {
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.toggle('on', b === btn));
          if(typeof onSelect === 'function'){
            onSelect(opt.value);
          }
        });
      }
      if(String(opt.value) === String(selectedValue)){
        btn.classList.add('on');
      }
      container.appendChild(btn);
      buttons.push(btn);
    });
    return buttons;
  };
  const formatNoteLabel = typeof utils.formatNoteLabel === 'function'
    ? utils.formatNoteLabel
    : (note)=>`${note.letter}${note.accidental||''}${note.octave}`;
  const STEP_LETTERS = ['C','D','E','F','G','A','B'];
  const STEP_INDEX = STEP_LETTERS.reduce((acc, l, idx)=>{ acc[l] = idx; return acc; }, {});
  const LETTER_TO_SEMITONE = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
  const NATURAL_SET = new Set([0,2,4,5,7,9,11]);

  const SEMITONE_TO_LETTER = Object.entries(LETTER_TO_SEMITONE).reduce((acc, [key, val])=>{ acc[val] = key; return acc; }, {});

  const CLEF_OPTIONS = [
    { value:'treble', labelKey:'reading_find_clef_treble', icon:CLEFS.treble.icon, base:CLEFS.treble.base },
    { value:'bass', labelKey:'reading_find_clef_bass', icon:CLEFS.bass.icon, base:CLEFS.bass.base }
  ];
  const CLEF_BOUNDS = {
    treble: { from: noteDef('B','',3), to: noteDef('C','',7) },
    bass:   { from: noteDef('G','',0), to: noteDef('C','',4) }
  };

  const NOTE_POOL_CACHE = {};

  const COUNT_OPTIONS = [10,15,20];
  const TIMER_OPTIONS = [
    { value:0, labelKey:'reading_find_timer_off' },
    { value:5, labelKey:'reading_find_timer_5' },
    { value:3, labelKey:'reading_find_timer_3' },
    { value:1, labelKey:'reading_find_timer_1' }
  ];

  const DEFAULT_CONFIG = { clef:'treble', rangeStart:'H3', rangeEnd:'C7', accidentals:false, timer:0, count:10 };

  const SHARP_BASE = { 1:'C', 3:'D', 6:'F', 8:'G', 10:'A' };
  const FLAT_BASE  = { 1:'D', 3:'E', 6:'G', 8:'A', 10:'B' };
  const SVG_NS = 'http://www.w3.org/2000/svg';

  const state = {
    config: { ...DEFAULT_CONFIG },
    notes: [],
    answers: [],
    currentIndex: 0,
    testStaff: null,
    summaryStaff: null,
    view: null,
    pendingEval: null,
    timerDuration: 0,
    timerId: null,
    timerInterval: null,
    timerDeadline: null,
    timerIndex: null,
    lastResults: null,
    rangeSlider: null,
    debug: false
  };

  const els = {};

  function ready(fn){
    if(document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  ready(init);

  function init(){
    state.view = document.getElementById('view-reading-find');
    if(!state.view) return;
    const url = new URL(window.location.href);
    state.debug = url.searchParams.has('placeDebug');
    // nezapisujeme do konzole, globální placeLog nevytváříme

    els.setup = document.getElementById('reading-find-setup');
    els.clefRow = document.getElementById('reading-find-clefs');
    els.rangeSlider = document.getElementById('reading-find-range');
    els.rangeStartLabel = document.getElementById('reading-find-range-start-label');
    els.rangeEndLabel = document.getElementById('reading-find-range-end-label');
    els.accRow = document.getElementById('reading-find-acc');
    els.timerRow = document.getElementById('reading-find-timer');
    els.countRow = document.getElementById('reading-find-count');
    els.startBtn = document.getElementById('reading-find-start');
    els.testCard = document.getElementById('reading-find-test');
    els.summaryCard = document.getElementById('reading-find-summary');
    els.progress = document.getElementById('reading-find-progress');
    els.instruction = document.getElementById('reading-find-instruction');
    els.timerDisplay = document.getElementById('reading-find-timer-display');
    els.staffContainer = document.getElementById('reading-find-staff');
    els.answers = document.getElementById('reading-find-answers');
    els.evalBtn = document.getElementById('reading-find-eval');
    els.resetBtn = document.getElementById('reading-find-reset');
    els.summaryStaff = document.getElementById('reading-find-summary-staff');
    els.summaryMotto = document.getElementById('reading-find-summary-motto');
    els.summaryBadge = document.getElementById('reading-find-summary-badge');
    els.chart = document.getElementById('reading-find-chart');
    els.summaryCorrect = document.getElementById('reading-find-summary-correct');
    els.summaryWrong = document.getElementById('reading-find-summary-wrong');
    els.restartBtn = document.getElementById('reading-find-restart');
    els.backBtn = document.getElementById('reading-find-back');

    renderConfigOptions();
    bindEvents();
    resetView();
  }

  function bindEvents(){
    if(els.startBtn) els.startBtn.addEventListener('click', ()=>{ startQuiz(true); });
    if(els.evalBtn){
      els.evalBtn.classList.add('hidden');
      els.evalBtn.setAttribute('aria-hidden', 'true');
      els.evalBtn.setAttribute('tabindex', '-1');
    }
    if(els.resetBtn) els.resetBtn.addEventListener('click', ()=>{ resetCurrentAnswers(); });
    if(els.restartBtn) els.restartBtn.addEventListener('click', ()=>{ startQuiz(true); });
    if(els.backBtn) els.backBtn.addEventListener('click', ()=>{ resetView(); });
  }

  function clearPendingEval(){
    if(state.pendingEval !== null){
      cancelAnimationFrame(state.pendingEval);
      state.pendingEval = null;
    }
  }

  function scheduleAutoEvaluate(){
    if(!els.testCard || els.testCard.classList.contains('hidden')) return;
    clearPendingEval();
    state.pendingEval = window.requestAnimationFrame(()=>{
      state.pendingEval = null;
      if(state.answers.length && state.answers.every(val=>val !== null)){
        evaluateQuiz();
      }
    });
  }

  function clearNoteTimer(){
    if(state.timerId !== null){
      clearTimeout(state.timerId);
      state.timerId = null;
    }
    if(state.timerInterval !== null){
      clearInterval(state.timerInterval);
      state.timerInterval = null;
    }
    state.timerDeadline = null;
    state.timerIndex = null;
    updateTimerDisplay();
  }

  function updateTimerDisplay(override){
    if(!els.timerDisplay) return;
    const label = (typeof I18N !== 'undefined' && I18N.t) ? I18N.t('reading_find_timer_label') : 'Čas';
    if(!state.timerDuration || state.timerDuration <= 0){
      els.timerDisplay.textContent = '';
      return;
    }
    let remaining = typeof override === 'number' ? override : null;
    if(remaining === null && state.timerDeadline){
      remaining = Math.max(0, Math.ceil((state.timerDeadline - Date.now()) / 1000));
    }
    if(remaining === null){
      els.timerDisplay.textContent = `${label}: —`;
    } else {
      els.timerDisplay.textContent = `${label}: ${remaining}s`;
    }
  }

  function startNoteTimer(){
    clearNoteTimer();
    if(!state.timerDuration || state.timerDuration <= 0) return;
    if(!els.testCard || els.testCard.classList.contains('hidden')) return;
    if(state.currentIndex === null) return;
    if(state.answers[state.currentIndex] !== null) return;
    state.timerIndex = state.currentIndex;
    state.timerDeadline = Date.now() + state.timerDuration * 1000;
    updateTimerDisplay(state.timerDuration);
    state.timerId = window.setTimeout(()=>{
      state.timerId = null;
      state.timerDeadline = null;
      handleTimeout();
    }, state.timerDuration * 1000);
    state.timerInterval = window.setInterval(()=>{
      if(state.timerDeadline === null){
        clearNoteTimer();
        return;
      }
      updateTimerDisplay();
    }, 200);
  }

  function handleTimeout(){
    clearPendingEval();
    const index = state.timerIndex;
    clearNoteTimer();
    if(index === null || !state.testStaff) return;
    if(state.answers[index] !== null) return;
    const data = state.testStaff.groups[index];
    if(data){
      data.group.classList.add('is-answered','is-timeout');
      data.answerLabel.textContent = '—';
    }
    state.answers[index] = '';
    const nextIndex = findNextUnanswered(index + 1);
    state.currentIndex = nextIndex;
    highlightCurrent();
    updateProgress();
    if(nextIndex === null){
      scheduleAutoEvaluate();
    }
  }

  function resetView(){
    clearNoteTimer();
    clearPendingEval();
    state.timerDuration = Number(state.config.timer) || 0;
    updateTimerDisplay();
    ensureRangeBounds();
    if(els.setup) els.setup.classList.remove('hidden');
    els.testCard.classList.add('hidden');
    els.summaryCard.classList.add('hidden');
    state.notes = [];
    state.answers = [];
    state.currentIndex = 0;
    state.lastResults = null;
    els.staffContainer.innerHTML = '';
    els.summaryStaff.innerHTML = '';
    if(els.summaryMotto) els.summaryMotto.textContent = '';
    if(els.summaryBadge) els.summaryBadge.textContent = '';
    els.answers.innerHTML = '';
    els.progress.textContent = '';
  }

  function renderConfigOptions(){
    const clefOptions = CLEF_OPTIONS.map(opt=>({ value: opt.value, label: I18N.t(opt.labelKey) }));
    choiceChips(els.clefRow, clefOptions, state.config.clef, value=>{
      state.config.clef = value;
      delete NOTE_POOL_CACHE[value];
      renderRangeSelectors();
    });

    renderRangeSelectors();

    const accOptions = [
      { value: false, label: I18N.t('reading_find_param_acc_off') },
      { value: true, label: I18N.t('reading_find_param_acc_on') }
    ];
    choiceChips(els.accRow, accOptions, state.config.accidentals, value=>{
      state.config.accidentals = value;
      renderAnswerButtons();
    });

    const timerOptions = TIMER_OPTIONS.map(opt=>({ value: opt.value, label: I18N.t(opt.labelKey) }));
    choiceChips(els.timerRow, timerOptions, state.config.timer, value=>{
      state.config.timer = Number(value);
      if(!els.testCard || els.testCard.classList.contains('hidden')){
        state.timerDuration = Number(value) || 0;
      }
      updateTimerDisplay();
    });

    const countOptions = COUNT_OPTIONS.map(num=>({ value: num, label: String(num) }));
    choiceChips(els.countRow, countOptions, state.config.count, value=>{
      state.config.count = Number(value);
    });
  }

  function ensureRangeBounds(){
    const pool = getClefPool(state.config.clef);
    if(!pool.find(item=>item.id===state.config.rangeStart)){
      state.config.rangeStart = pool[0].id;
    }
    if(!pool.find(item=>item.id===state.config.rangeEnd)){
      state.config.rangeEnd = pool[pool.length-1].id;
    }
    const startIdx = pool.findIndex(item=>item.id===state.config.rangeStart);
    let endIdx = pool.findIndex(item=>item.id===state.config.rangeEnd);
    if(endIdx < startIdx){
      state.config.rangeEnd = pool[startIdx].id;
    }
  }

  function renderRangeSelectors(){
    ensureRangeBounds();
    const pool = getClefPool(state.config.clef);
    if(!pool.length){
      updateFindRangeLabels(null, null);
      return;
    }
    const startIdx = Math.max(0, pool.findIndex(item=>item.id === state.config.rangeStart));
    const endIdx = Math.max(startIdx, pool.findIndex(item=>item.id === state.config.rangeEnd));
    const rangeStart = Math.min(startIdx, pool.length - 1);
    const rangeEnd = Math.min(Math.max(endIdx, rangeStart), pool.length - 1);
    const handleRangeChange = ({ min, max })=>{
      const activePool = getClefPool(state.config.clef);
      if(!activePool.length) return;
      const clampedMin = Math.min(Math.max(min, 0), activePool.length - 1);
      const clampedMax = Math.min(Math.max(max, clampedMin), activePool.length - 1);
      state.config.rangeStart = activePool[clampedMin].id;
      state.config.rangeEnd = activePool[clampedMax].id;
      ensureRangeBounds();
      updateFindRangeLabels(activePool[clampedMin], activePool[clampedMax]);
      renderAnswerButtons();
    };
    const sliderLabels = {
      min: I18N.t ? I18N.t('reading_find_param_range_from') : 'Min',
      max: I18N.t ? I18N.t('reading_find_param_range_to') : 'Max'
    };
    if(!state.rangeSlider && App.rangeSlider && els.rangeSlider){
      state.rangeSlider = App.rangeSlider.create({
        container: els.rangeSlider,
        items: pool,
        value: { min: rangeStart, max: rangeEnd },
        onChange: handleRangeChange,
        minLabel: sliderLabels.min,
        maxLabel: sliderLabels.max
      });
    } else if(state.rangeSlider){
      state.rangeSlider.setItems(pool, { min: rangeStart, max: rangeEnd }, sliderLabels);
    }
    updateFindRangeLabels(pool[rangeStart], pool[rangeEnd]);
    renderAnswerButtons();
  }

  function updateFindRangeLabels(minItem, maxItem){
    if(els.rangeStartLabel) els.rangeStartLabel.textContent = minItem ? formatNoteLabel(minItem.note) : '—';
    if(els.rangeEndLabel) els.rangeEndLabel.textContent = maxItem ? formatNoteLabel(maxItem.note) : '—';
  }

  function getClefPool(clef){
    if(!NOTE_POOL_CACHE[clef]){
      const bounds = CLEF_BOUNDS[clef] || CLEF_BOUNDS.treble;
      const list = buildRangePool(bounds).map(note=>({ id: noteId(note), note }));
      NOTE_POOL_CACHE[clef] = list;
    }
    return NOTE_POOL_CACHE[clef];
  }

  function buildRangePool(rangeDef, includeAccidentals=false){
    if(!rangeDef) return [];
    const start = noteValue(rangeDef.from);
    const end = noteValue(rangeDef.to);
    if(!Number.isFinite(start) || !Number.isFinite(end)) return [];
    const min = Math.min(start, end);
    const max = Math.max(start, end);
    const pool = [];
    for(let value = min; value <= max; value++){
      const semitone = ((value % 12) + 12) % 12;
      if(NATURAL_SET.has(semitone)){
        const letter = SEMITONE_TO_LETTER[semitone];
        if(letter) pool.push(createNoteForValue(letter, '', value));
      } else if(includeAccidentals){
        const sharpLetter = SHARP_BASE[semitone];
        if(sharpLetter) pool.push(createNoteForValue(sharpLetter, '#', value));
        const flatLetter = FLAT_BASE[semitone];
        if(flatLetter) pool.push(createNoteForValue(flatLetter, 'b', value));
      }
    }
    return pool;
  }

  function createNoteForValue(letter, accidental, targetValue){
    let octave = Math.floor(targetValue / 12);
    let candidate = noteDef(letter, accidental, octave);
    let computed = noteValue(candidate);
    while(computed > targetValue){
      octave -= 1;
      candidate = noteDef(letter, accidental, octave);
      computed = noteValue(candidate);
    }
    while(computed < targetValue){
      octave += 1;
      candidate = noteDef(letter, accidental, octave);
      computed = noteValue(candidate);
    }
    return candidate;
  }

  function getSelectedRange(){
    return {
      from: noteFromId(state.config.rangeStart),
      to: noteFromId(state.config.rangeEnd)
    };
  }

  function startQuiz(regenerate){
    clearPendingEval();
    clearNoteTimer();
    state.timerDuration = Number(state.config.timer) || 0;
    updateTimerDisplay();
    if(els.setup) els.setup.classList.add('hidden');
    els.summaryCard.classList.add('hidden');
    els.testCard.classList.remove('hidden');
    ensureRangeBounds();

    if(regenerate || !state.notes.length){
      state.notes = generateNoteSet();
    }
    state.answers = new Array(state.notes.length).fill(null);
    state.currentIndex = 0;

    renderTestStaff();
    renderAnswerButtons();
    updateProgress();
    highlightCurrent();
  }

  function resetCurrentAnswers(){
    clearPendingEval();
    clearNoteTimer();
    state.timerDuration = Number(state.config.timer) || 0;
    updateTimerDisplay();
    if(!state.notes.length){
      startQuiz(true);
      return;
    }
    state.answers = new Array(state.notes.length).fill(null);
    state.currentIndex = 0;
    renderTestStaff();
    renderAnswerButtons();
    updateProgress();
    highlightCurrent();
  }

  function generateNoteSet(){
    const rangeDef = getSelectedRange();
    const pool = buildRangePool(rangeDef, state.config.accidentals);
    const count = state.config.count;
    const notes = [];
    for(let i=0;i<count;i++){
      const base = pool[Math.floor(Math.random()*pool.length)];
      notes.push({
        ...base,
        accidental: base.accidental || '',
        meta: { ...(base.meta || {}), forceAccidental: true }
      });
    }
    return notes;
  }

  function renderTestStaff(){
    const clefConfig = getClefConfig(state.config.clef);
    const layout = (state.config.accidentals && App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(state.notes, { accidentalSpace:'all', noteGapBase:26, barUnits:[], meterUnits:0 })
      : null;
    state.testStaff = renderStaffShared({
      container: els.staffContainer,
      clef: clefConfig,
      notes: state.notes,
      options: {
        classes:{
          group:'reading-find-note',
          noteHead:'reading-find-note-circle',
          label:'reading-find-answer-label',
          clef:'reading-find-clef'
        },
        selectable:true,
        noteGap: 96,
        layout,
        accidentalSpace:'all',
        showAccidentals:true,
        fillWidth:false,
        debugZones: state.debug === true,
        debugPositions: state.debug === true,
        initialLabel: ()=>''
      }
    });

    if(!state.testStaff) return;

    state.testStaff.groups.forEach(({ group }, index)=>{
      group.addEventListener('click', ()=>{
        state.currentIndex = index;
        highlightCurrent();
      });
    });

    state.testStaff.groups.forEach((data, index)=>{
      if(!data || !data.answerLabel) return;
      const stored = state.answers[index];
      if(stored !== null){
        const display = stored ? displayAnswer(stored) : '—';
        data.answerLabel.textContent = display;
        data.group.classList.add('is-answered');
        data.group.classList.toggle('is-timeout', stored === '');
      } else {
        data.answerLabel.textContent = '';
        data.group.classList.remove('is-answered','is-timeout');
      }
    });
  }

  function renderAnswerButtons(){
    if(!els.answers) return;
    els.answers.innerHTML = '';
    const options = buildAnswerOptions();
    options.forEach(opt=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip';
      btn.dataset.value = opt.value;
      btn.textContent = opt.label;
      btn.addEventListener('click', ()=>handleAnswer(opt.value, btn));
      els.answers.appendChild(btn);
    });
    markAnswerButton(state.currentIndex !== null ? state.answers[state.currentIndex] : null);
  }

  function buildAnswerOptions(){
    const rangeDef = getSelectedRange();
    const pool = buildRangePool(rangeDef, state.config.accidentals);
    const map = new Map();
    pool.forEach(note=>{
      const key = note.answer;
      if(map.has(key)) return;
      const order = STEP_INDEX[note.letter] + (note.accidental === '#' ? 0.5 : note.accidental === 'b' ? -0.5 : 0);
      map.set(key, { value:key, label: displayAnswer(key), order });
    });
    return Array.from(map.values()).sort((a,b)=>a.order-b.order);
  }

  function handleAnswer(value, button){
    clearPendingEval();
    clearNoteTimer();
    if(state.currentIndex === null) return;
    state.answers[state.currentIndex] = value;
    const display = value ? displayAnswer(value) : '—';
    const data = state.testStaff && state.testStaff.groups[state.currentIndex];
    if(data){
      data.answerLabel.textContent = display;
      data.group.classList.add('is-answered');
      data.group.classList.toggle('is-timeout', value === '');
    }

    if(els.answers){
      Array.from(els.answers.querySelectorAll('.chip')).forEach(chip=>{
        chip.classList.toggle('on', chip === button);
      });
    }

    const nextIndex = findNextUnanswered(state.currentIndex + 1);
    state.currentIndex = nextIndex;
    highlightCurrent();
    updateProgress();
    if(nextIndex === null){
      scheduleAutoEvaluate();
    }
  }

  function findNextUnanswered(startIndex){
    const total = state.answers.length;
    for(let i=startIndex;i<total;i++){
      if(state.answers[i] == null) return i;
    }
    for(let i=0;i<state.answers.length;i++){
      if(state.answers[i] == null) return i;
    }
    return null;
  }

  function highlightCurrent(){
    clearNoteTimer();
    if(!state.testStaff){
      updateTimerDisplay();
      return;
    }
    state.testStaff.groups.forEach(({ group }, idx)=>{
      group.classList.toggle('is-active', state.currentIndex === idx);
    });
    if(state.currentIndex !== null){
      const active = state.testStaff.groups[state.currentIndex];
      if(active){
        active.group.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
      }
      markAnswerButton(state.answers[state.currentIndex]);
    } else {
      markAnswerButton(null);
    }
    startNoteTimer();
  }

  function markAnswerButton(value){
    if(!els.answers) return;
    Array.from(els.answers.querySelectorAll('.chip')).forEach(btn=>{
      btn.classList.toggle('on', value !== null && btn.dataset.value === String(value));
    });
  }

  function updateProgress(){
    if(!els.progress) return;
    const answered = state.answers.filter(val=>val !== null).length;
    const total = state.answers.length;
    if(state.currentIndex !== null){
      els.progress.textContent = `${state.currentIndex + 1} / ${total}`;
    } else {
      els.progress.textContent = `${answered} / ${total}`;
    }
  }

  function evaluateQuiz(){
    clearPendingEval();
    clearNoteTimer();
    const results = state.notes.map((note, index)=>{
      const expected = note.answer;
      const given = state.answers[index];
      const ok = (given === expected);
      return { note, expected, given, ok };
    });

    const correct = results.filter(r=>r.ok).length;
    const wrong = results.length - correct;

    renderSummary(results, correct, wrong);
    els.testCard.classList.add('hidden');
    els.summaryCard.classList.remove('hidden');
  }

  function setSummaryLabel(label, parts){
    if(!label) return;
    while(label.firstChild) label.removeChild(label.firstChild);
    const segments = Array.isArray(parts) && parts.length ? parts : [{ text:'' }];
    segments.forEach(part=>{
      const tspan = document.createElementNS(SVG_NS, 'tspan');
      if(part.className) tspan.setAttribute('class', part.className);
      tspan.textContent = part.text ?? '';
      label.appendChild(tspan);
    });
  }

  function renderSummary(results, correct, wrong){
    if(els.setup) els.setup.classList.add('hidden');
    if(els.summaryCorrect) els.summaryCorrect.textContent = `${correct}`;
    if(els.summaryWrong) els.summaryWrong.textContent = `${wrong}`;

    const total = correct + wrong;
    const ratio = total ? correct / total : 0;

    if(els.chart && App.utils && typeof App.utils.drawDonut === 'function'){
      App.utils.drawDonut(els.chart, ratio);
    }
    if(els.summaryMotto && App.utils && typeof App.utils.mottoFor === 'function'){
      els.summaryMotto.textContent = App.utils.mottoFor(ratio);
    }
    if(els.summaryBadge && App.utils && typeof App.utils.badgeFor === 'function'){
      els.summaryBadge.textContent = App.utils.badgeFor(ratio);
    }

    const clefConfig = getClefConfig(state.config.clef);
    const summaryLayout = (state.config.accidentals && App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(results.map(r=>r.note), { accidentalSpace:'all', noteGapBase:26, barUnits:[], meterUnits:0 })
      : null;
    state.summaryStaff = renderStaffShared({
      container: els.summaryStaff,
      clef: clefConfig,
      notes: results.map(r=>r.note),
      options: {
        classes:{
          group:'reading-find-note',
          noteHead:'reading-find-note-circle',
          label:'reading-find-answer-label',
          clef:'reading-find-clef'
        },
        noteGap: 110,
        layout: summaryLayout,
        paddingX: 48,
        paddingY: 32,
        extraTop: 48,
        extraBottom: 112,
        noteRadius:{ rx:12, ry:9 },
        fillWidth:false,
        initialLabel: ()=>''
      }
    });

    state.summaryStaff.groups.forEach((data, idx)=>{
      if(!data || !data.group) return;
      const res = results[idx];
      const expectedLabel = displayAnswer(res.expected);
      const labelNode = data.answerLabel;
      if(res.ok){
        setSummaryLabel(labelNode, [{ text: expectedLabel, className: 'answer-correct' }]);
        data.group.classList.add('is-correct');
        data.group.classList.remove('is-wrong');
      } else {
        const givenLabel = res.given ? displayAnswer(res.given) : '—';
        setSummaryLabel(labelNode, [
          { text: givenLabel, className: 'answer-wrong' },
          { text: ' / ', className: 'answer-divider' },
          { text: expectedLabel, className: 'answer-correct' }
        ]);
        data.group.classList.add('is-wrong');
        data.group.classList.remove('is-correct');
      }
    });
    state.lastResults = { results, correct, wrong };
  }

  function displayAnswer(answer){
    if(!answer) return '';
    const letter = String(answer).charAt(0).toUpperCase();
    const accidental = answer.length > 1 ? answer.slice(1) : '';
    const localized = App.utils && typeof App.utils.noteName === 'function' ? App.utils.noteName(letter) : letter;
    const accidentalSymbol = accidental === '#' ? '♯' : accidental === 'b' ? '♭' : '';
    return `${localized}${accidentalSymbol}`;
  }

  function buildAnswerForNote(note){
    return note.answer;
  }

  function displayResultLabel(note){
    return displayAnswer(buildAnswerForNote(note));
  }

  App.readingFind = {
    refresh(){
      renderConfigOptions();
      resetView();
    },
    reset(){
      resetView();
    }
  };

})();

(function(){
  const App = window.App = window.App || {};
  const staffRenderer = App.staffRenderer;
  if(!staffRenderer) return;

  const { render: renderStaffShared, parseNote, noteStep, noteValue, noteId, noteDef, cloneNote, noteFromId, stepToNote, getClefConfig, CLEFS, collectLedger } = staffRenderer;
  const utils = App.utils || {};
  const choiceChips = typeof utils.choiceChips === 'function' ? utils.choiceChips : ()=>[];
  const formatNoteLabel = typeof utils.formatNoteLabel === 'function'
    ? utils.formatNoteLabel
    : (note)=>`${note.letter}${note.accidental||''}${note.octave}`;
  const SVG_NS = 'http://www.w3.org/2000/svg';
  const NOTE_RADIUS = { rx:12, ry:9 };

  const CLEF_OPTIONS = [
    { value:'treble', labelKey:'reading_find_clef_treble', icon:CLEFS.treble.icon, base:CLEFS.treble.base },
    { value:'bass', labelKey:'reading_find_clef_bass', icon:CLEFS.bass.icon, base:CLEFS.bass.base }
  ];
  const CLEF_BOUNDS = {
    treble: { from: parseNote('H3'), to: parseNote('C7') },
    bass:   { from: parseNote('G0'), to: parseNote('C4') }
  };

  const NOTE_POOL_CACHE = {};
  const COUNT_OPTIONS = [10,15,20];
  const STEP_LETTERS = ['C','D','E','F','G','A','B'];
  const STEP_INDEX = STEP_LETTERS.reduce((acc, letter, idx)=>{ acc[letter] = idx; return acc; }, {});
  const LETTER_TO_SEMITONE = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
  const SEMITONE_TO_LETTER = Object.entries(LETTER_TO_SEMITONE).reduce((acc, [key, val])=>{ acc[val] = key; return acc; }, {});
  const NATURAL_SET = new Set([0,2,4,5,7,9,11]);
  const SHARP_BASE = { 1:'C', 3:'D', 6:'F', 8:'G', 10:'A' };
  const FLAT_BASE  = { 1:'D', 3:'E', 6:'G', 8:'A', 10:'B' };

  const DEFAULT_CONFIG = { clef:'treble', rangeStart:'H3', rangeEnd:'C7', count:10 };

  const placeState = {
    config: { ...DEFAULT_CONFIG },
    targets: [],
    answers: [],
    currentIndex: null,
    view: null,
    testStaff: null,
    summaryStaff: null,
    metrics: null,
    pointer: null,
    lastResults: null,
    staffColor: null,
    noteRadius: NOTE_RADIUS,
    stepBounds: null,
    rangeSlider: null,
    debug: false
  };

  const els = {};

  ready(init);

  function ready(fn){
    if(document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  function init(){
    placeState.view = document.getElementById('view-reading-place');
    if(!placeState.view) return;
    const url = new URL(window.location.href);
    placeState.debug = url.searchParams.has('placeDebug');
    mapEls();
    renderConfigOptions();
    bindEvents();
    resetView();
  }

  function placeLog(tag, payload){
    // logging vypnuto
    return;
  }

  function mapEls(){
    els.setup = document.getElementById('reading-place-setup');
    els.testCard = document.getElementById('reading-place-test');
    els.summaryCard = document.getElementById('reading-place-summary');
    els.clefRow = document.getElementById('reading-place-clefs');
    els.rangeSlider = document.getElementById('reading-place-range');
    els.rangeStartLabel = document.getElementById('reading-place-range-start-label');
    els.rangeEndLabel = document.getElementById('reading-place-range-end-label');
    els.countRow = document.getElementById('reading-place-count');
    els.startBtn = document.getElementById('reading-place-start');
    els.evalBtn = document.getElementById('reading-place-evaluate');
    els.resetBtn = document.getElementById('reading-place-reset');
    els.progress = document.getElementById('reading-place-progress');
    els.instruction = document.getElementById('reading-place-instruction');
    els.target = document.getElementById('reading-place-target');
    els.staffHost = document.getElementById('reading-place-staff');
    els.summaryCorrect = document.getElementById('reading-place-summary-correct');
    els.summaryWrong = document.getElementById('reading-place-summary-wrong');
    els.summaryStaff = document.getElementById('reading-place-summary-staff');
    els.summaryMotto = document.getElementById('reading-place-summary-motto');
    els.summaryBadge = document.getElementById('reading-place-summary-badge');
    els.summaryChart = document.getElementById('reading-place-chart');
    els.restartBtn = document.getElementById('reading-place-restart');
    els.backBtn = document.getElementById('reading-place-back');
  }

  function bindEvents(){
    if(els.startBtn) els.startBtn.addEventListener('click', ()=>startQuiz(true));
    if(els.evalBtn) els.evalBtn.addEventListener('click', ()=>evaluateQuiz());
    if(els.resetBtn) els.resetBtn.addEventListener('click', ()=>resetAnswers());
    if(els.restartBtn) els.restartBtn.addEventListener('click', ()=>startQuiz(true));
    if(els.backBtn) els.backBtn.addEventListener('click', ()=>resetView());
  }

  function resetView(){
    placeState.targets = [];
    placeState.answers = [];
    placeState.currentIndex = null;
    placeState.pointer = null;
    placeState.lastResults = null;
    placeState.stepBounds = null;
    placeState.testStaff = null;
    placeState.summaryStaff = null;
    if(els.setup) els.setup.classList.remove('hidden');
    if(els.testCard) els.testCard.classList.add('hidden');
    if(els.summaryCard) els.summaryCard.classList.add('hidden');
    if(els.progress) els.progress.textContent = '';
    if(els.target) els.target.textContent = '';
    if(els.staffHost) els.staffHost.innerHTML = '';
    if(els.summaryStaff) els.summaryStaff.innerHTML = '';
    if(els.summaryCorrect) els.summaryCorrect.textContent = '';
    if(els.summaryWrong) els.summaryWrong.textContent = '';
    if(els.summaryMotto) els.summaryMotto.textContent = '';
    if(els.summaryBadge) els.summaryBadge.textContent = '';
  }

  function renderConfigOptions(){
    const clefOptions = CLEF_OPTIONS.map(opt=>({ value: opt.value, label: I18N.t(opt.labelKey) }));
    choiceChips(els.clefRow, clefOptions, placeState.config.clef, value=>{
      placeState.config.clef = value;
      delete NOTE_POOL_CACHE[value];
      ensureRangeBounds();
      renderRangeSelectors();
    });
    renderRangeSelectors();
    const countOptions = COUNT_OPTIONS.map(num=>({ value: String(num), label: String(num) }));
    choiceChips(els.countRow, countOptions, String(placeState.config.count), value=>{
      placeState.config.count = Number(value);
    });
  }

  function renderRangeSelectors(){
    ensureRangeBounds();
    const pool = getClefPool(placeState.config.clef);
    if(!pool.length){
      updatePlaceRangeLabels(null, null);
      return;
    }
    const startIdx = Math.max(0, pool.findIndex(item=>item.id === placeState.config.rangeStart));
    const endIdx = Math.max(startIdx, pool.findIndex(item=>item.id === placeState.config.rangeEnd));
    const rangeStart = Math.min(startIdx, pool.length - 1);
    const rangeEnd = Math.min(Math.max(endIdx, rangeStart), pool.length - 1);
    const handleRangeChange = ({ min, max })=>{
      const activePool = getClefPool(placeState.config.clef);
      if(!activePool.length) return;
      const clampedMin = Math.min(Math.max(min, 0), activePool.length - 1);
      const clampedMax = Math.min(Math.max(max, clampedMin), activePool.length - 1);
      placeState.config.rangeStart = activePool[clampedMin].id;
      placeState.config.rangeEnd = activePool[clampedMax].id;
      ensureRangeBounds();
      updatePlaceRangeLabels(activePool[clampedMin], activePool[clampedMax]);
    };
    const sliderLabels = {
      min: I18N.t ? I18N.t('reading_place_param_range_start') : 'Min',
      max: I18N.t ? I18N.t('reading_place_param_range_end') : 'Max'
    };
    if(!placeState.rangeSlider && App.rangeSlider && els.rangeSlider){
      placeState.rangeSlider = App.rangeSlider.create({
        container: els.rangeSlider,
        items: pool,
        value: { min: rangeStart, max: rangeEnd },
        onChange: handleRangeChange,
        minLabel: sliderLabels.min,
        maxLabel: sliderLabels.max
      });
    } else if(placeState.rangeSlider){
      placeState.rangeSlider.setItems(pool, { min: rangeStart, max: rangeEnd }, sliderLabels);
    }
    updatePlaceRangeLabels(pool[rangeStart], pool[rangeEnd]);
  }

  function updatePlaceRangeLabels(minItem, maxItem){
    if(els.rangeStartLabel) els.rangeStartLabel.textContent = minItem ? formatNoteLabel(minItem.note) : '—';
    if(els.rangeEndLabel) els.rangeEndLabel.textContent = maxItem ? formatNoteLabel(maxItem.note) : '—';
  }

  function ensureRangeBounds(){
    const pool = getClefPool(placeState.config.clef);
    if(!pool.length) return;
    if(!pool.find(item=>item.id === placeState.config.rangeStart)){
      placeState.config.rangeStart = pool[0].id;
    }
    if(!pool.find(item=>item.id === placeState.config.rangeEnd)){
      placeState.config.rangeEnd = pool[pool.length - 1].id;
    }
    const startIdx = pool.findIndex(item=>item.id === placeState.config.rangeStart);
    let endIdx = pool.findIndex(item=>item.id === placeState.config.rangeEnd);
    if(endIdx < startIdx){
      placeState.config.rangeEnd = pool[startIdx].id;
    }
  }

  function getClefPool(clef){
    if(!NOTE_POOL_CACHE[clef]){
      const bounds = CLEF_BOUNDS[clef] || CLEF_BOUNDS.treble;
      const list = buildRangePool(bounds).map(note=>({ id: noteId(note), note }));
      NOTE_POOL_CACHE[clef] = list;
    }
    return NOTE_POOL_CACHE[clef];
  }

  function buildRangePool(rangeDef, includeAccidentals=false){
    const start = noteValue(rangeDef.from);
    const end = noteValue(rangeDef.to);
    const min = Math.min(start, end);
    const max = Math.max(start, end);
    const list = [];
    for(let value=min; value<=max; value++){
      const semitone = ((value % 12) + 12) % 12;
      if(NATURAL_SET.has(semitone)){
        const letter = SEMITONE_TO_LETTER[semitone];
        if(letter) list.push(noteDef(letter, '', Math.floor(value/12)));
        continue;
      }
      if(includeAccidentals){
        const sharpLetter = SHARP_BASE[semitone];
        if(sharpLetter) list.push(noteDef(sharpLetter, '#', Math.floor((value-1)/12)));
        const flatLetter = FLAT_BASE[semitone];
        if(flatLetter) list.push(noteDef(flatLetter, 'b', Math.floor((value+1)/12)));
      }
    }
    return list;
  }

  function getSelectedRange(){
    return {
      from: noteFromId(placeState.config.rangeStart),
      to: noteFromId(placeState.config.rangeEnd)
    };
  }

  function getSelectedPool(){
    const pool = getClefPool(placeState.config.clef);
    const startIdx = pool.findIndex(item=>item.id === placeState.config.rangeStart);
    const endIdx = pool.findIndex(item=>item.id === placeState.config.rangeEnd);
    const from = startIdx >= 0 ? startIdx : 0;
    const to = endIdx >= 0 ? endIdx : pool.length - 1;
    return pool.slice(Math.min(from, to), Math.max(from, to) + 1);
  }

  function generateTargets(){
    const subset = getSelectedPool();
    if(!subset.length){
      placeState.targets = [];
      placeState.stepBounds = null;
      return;
    }
    const minStep = noteStep(subset[0].note);
    const maxStep = noteStep(subset[subset.length - 1].note);
    placeState.stepBounds = { min:minStep, max:maxStep };
    const count = placeState.config.count;
    const list = [];
    for(let i=0;i<count;i++){
      const base = subset[Math.floor(Math.random() * subset.length)];
      const note = cloneNote(base.note);
      list.push({
        note,
        id: noteId(note),
        step: noteStep(note),
        value: noteValue(note),
        label: formatNoteLabel(note)
      });
    }
    placeState.targets = list;
  }

  function startQuiz(regenerate){
    if(regenerate || !placeState.targets.length){
      generateTargets();
    }
    placeState.answers = new Array(placeState.targets.length).fill(null);
    placeState.pointer = null;
    placeState.lastResults = null;
    placeState.currentIndex = placeState.targets.length ? 0 : null;
    if(els.setup) els.setup.classList.add('hidden');
    if(els.summaryCard) els.summaryCard.classList.add('hidden');
    if(els.testCard) els.testCard.classList.remove('hidden');
    renderTestStaff();
    updateProgress();
    updateTargetLabel();
  }

  function resetAnswers(){
    if(!placeState.targets.length) return;
    placeState.answers = new Array(placeState.targets.length).fill(null);
    placeState.pointer = null;
    placeState.lastResults = null;
    placeState.currentIndex = 0;
    renderTestStaff();
    updateProgress();
    updateTargetLabel();
  }

  function setCurrentIndex(index){
    if(index === null || index < 0 || index >= placeState.targets.length){
      placeState.currentIndex = null;
    } else {
      placeState.currentIndex = index;
    }
    highlightCurrent();
    updateTargetLabel();
  }

  function updateProgress(){
    if(!els.progress) return;
    const answered = placeState.answers.filter(Boolean).length;
    const total = placeState.targets.length;
    els.progress.textContent = total ? `${answered} / ${total}` : '';
  }

  function updateTargetLabel(){
    if(!els.target) return;
    if(placeState.currentIndex === null){
    if(placeState.targets.length && placeState.answers.every(Boolean)){
      if(typeof I18N !== 'undefined' && I18N.t){
        const done = I18N.t('reading_place_target_done');
        if(done && done !== 'reading_place_target_done'){
          els.target.textContent = done;
          return;
        }
      }
      els.target.textContent = 'Hotovo – vyhodnoť test';
      } else {
        els.target.textContent = '';
      }
      return;
    }
    const target = placeState.targets[placeState.currentIndex];
    if(!target){
      els.target.textContent = '';
      return;
    }
    const label = target.label;
    if(typeof I18N !== 'undefined' && I18N.t){
      const template = I18N.t('reading_place_target_label');
      if(template && template !== 'reading_place_target_label'){
        els.target.textContent = template.replace(/\{note\}/g, label);
        return;
      }
    }
    els.target.textContent = label;
  }

  function renderTestStaff(){
    if(!els.staffHost) return;
    els.staffHost.innerHTML = '';
    if(!placeState.targets.length){
      placeState.testStaff = null;
      placeState.metrics = null;
      return;
    }
    const clefConfig = getClefConfig(placeState.config.clef);
    const placeholderTemplate = cloneNote(clefConfig.base);
    const notesForRender = placeState.targets.map((target, index)=>{
      const answer = placeState.answers[index];
      if(answer && answer.note) return answer.note;
      if(placeState.pointer && placeState.pointer.index === index && placeState.pointer.preview){
        return placeState.pointer.preview.note;
      }
      return cloneNote(placeholderTemplate);
    });
    // Minimal/stabilní nastavení (srovnatelné s rel.html) pro ladění pozic
    const result = renderStaffShared({
      container: els.staffHost,
      clef: clefConfig,
      notes: notesForRender,
      options:{
        classes:{
          group:'reading-place-note',
          noteHead:'reading-place-note-head',
          label:'reading-place-note-label',
          clef:'reading-place-clef'
        },
        selectable:false,
        noteGap: 112,
        paddingX: 48,
        paddingY: 32,
        extraTop: 48,
        extraBottom: 96,
        labelMargin: 40,
        noteRadius: placeState.noteRadius,
        fillWidth:false,
        renderNote:(_, index)=>{
          const hasAnswer = Boolean(placeState.answers[index]);
          const isPreview = placeState.pointer && placeState.pointer.index === index && placeState.pointer.preview;
          return (hasAnswer || isPreview) ? 'visible' : 'ghost';
        },
        initialLabel: (_note, index)=> placeState.targets[index] ? placeState.targets[index].label : ''
      }
    });
    placeState.testStaff = result;
    placeState.metrics = result.metrics;
    placeState.staffColor = result.metrics.staffColor || placeState.staffColor;
    attachPointerHandlers(result.svg);
    if(placeState.debug){
      placeLog('metricsInit', {
        noteGap: result.metrics.noteGap,
        paddingX: result.metrics.paddingX,
        clefOffset: result.metrics.clefOffset,
        width: result.metrics.width,
        totalHeight: result.metrics.totalHeight
      });
    }
    highlightCurrent();
  }

  function attachPointerHandlers(svg){
    if(!svg) return;
    svg.addEventListener('pointerdown', handlePointerDown);
    svg.addEventListener('pointermove', handlePointerMove);
    svg.addEventListener('pointerup', handlePointerUp);
    svg.addEventListener('pointercancel', handlePointerCancel);
    svg.addEventListener('pointerleave', handlePointerCancel);
  }

  function handlePointerDown(evt){
    if(!placeState.testStaff || !placeState.targets.length) return;
    if(evt && typeof evt.preventDefault === 'function') evt.preventDefault();
    const preview = snapPointerToNote(evt);
    if(!preview) return;
    const index = resolveIndex(evt);
    if(index === null) return;
    placeLog('pointerDown', {
      id: evt.pointerId,
      clientX: evt.clientX,
      clientY: evt.clientY,
      index,
      preview: preview.note
    });
    placeState.testStaff.svg.setPointerCapture(evt.pointerId);
    placeState.pointer = { id: evt.pointerId, index, preview };
    updateGroupForNote(index, preview.note, placeState.answers[index] ? 'visible' : 'preview', preview.step);
    setCurrentIndex(index);
    updatePointerPreview(evt);
  }

  function handlePointerMove(evt){
    if(!placeState.pointer || placeState.pointer.id !== evt.pointerId) return;
    if(evt && typeof evt.preventDefault === 'function') evt.preventDefault();
    placeLog('pointerMove', {
      id: evt.pointerId,
      clientX: evt.clientX,
      clientY: evt.clientY,
      idx: placeState.pointer.index
    });
    updatePointerPreview(evt);
  }

  function handlePointerUp(evt){
    if(!placeState.pointer || placeState.pointer.id !== evt.pointerId) return;
    if(placeState.testStaff && placeState.testStaff.svg.hasPointerCapture(evt.pointerId)){
      placeState.testStaff.svg.releasePointerCapture(evt.pointerId);
    }
    const { index, preview } = placeState.pointer;
    placeState.pointer = null;
    if(preview && preview.note){
      commitAnswer(index, preview.note);
    } else {
      highlightCurrent();
    }
  }

  function handlePointerCancel(evt){
    if(!placeState.pointer || placeState.pointer.id !== evt.pointerId) return;
    if(placeState.testStaff && placeState.testStaff.svg.hasPointerCapture(evt.pointerId)){
      placeState.testStaff.svg.releasePointerCapture(evt.pointerId);
    }
    placeState.pointer = null;
    highlightCurrent();
  }

  function resolveIndex(evt){
    if(!placeState.testStaff || !placeState.targets.length) return null;
    const metrics = placeState.testStaff.metrics;
    const svg = placeState.testStaff.svg;
    const pt = svgPointerCoords(evt, svg);
    const x = pt ? pt.x : (metrics.paddingX + metrics.clefOffset);
    const startX = metrics.paddingX + metrics.clefOffset;
    let idx = Math.round((x - startX) / metrics.noteGap);
    if(Number.isNaN(idx)) idx = 0;
    if(idx < 0) idx = 0;
    if(idx >= placeState.targets.length) idx = placeState.targets.length - 1;
    placeLog('resolveIndex', {
      clientX: evt && evt.clientX,
      svgX: x,
      startX,
      noteGap: metrics.noteGap,
      width: metrics.width,
      rectW: svg.getBoundingClientRect().width,
      paddingX: metrics.paddingX,
      clefOffset: metrics.clefOffset,
      idx
    });
    return idx;
  }

  function updatePointerPreview(evt){
    const preview = snapPointerToNote(evt);
    if(!preview){
      if(placeState.pointer){
        const idx = placeState.pointer.index;
        placeState.pointer.preview = null;
        const baseNote = placeState.answers[idx]?.note || (placeState.testStaff.groups?.[idx]?.note) || null;
        const mode = placeState.answers[idx] ? 'visible' : 'ghost';
        if(baseNote) updateGroupForNote(idx, baseNote, mode);
        highlightCurrent();
      }
      return;
    }
    if(!placeState.pointer) return;
    const { index } = placeState.pointer;
    placeState.pointer.preview = preview;
    updateGroupForNote(index, preview.note, 'preview');
    if(placeState.debug){
      const m = placeState.testStaff?.metrics;
      placeLog('previewMetrics', {
        noteGap: m?.noteGap,
        paddingX: m?.paddingX,
        clefOffset: m?.clefOffset,
        width: m?.width,
        totalHeight: m?.totalHeight
      });
    }
    updateTargetLabel();
  }

  function snapPointerToNote(evt){
    if(!placeState.testStaff) return null;
    const metrics = placeState.testStaff.metrics;
    const svg = placeState.testStaff.svg;
    const pt = svgPointerCoords(evt, svg);
    const y = pt ? pt.y : 0;
    const stepHeight = metrics.stepHeight || 7;
    const minStep = placeState.stepBounds ? placeState.stepBounds.min : metrics.baseStep;
    const maxStep = placeState.stepBounds ? placeState.stepBounds.max : metrics.baseStep;
    const lowestY = metrics.bottomY - (minStep - metrics.baseStep) * stepHeight;
    const highestY = metrics.bottomY - (maxStep - metrics.baseStep) * stepHeight;
    const hitPadding = stepHeight * 2.5;
    if(y > lowestY + hitPadding) return null;
    if(y < highestY - hitPadding) return null;
    let diff = (metrics.bottomY - y) / metrics.stepHeight;
    if(!Number.isFinite(diff)) diff = 0;
    let step = Math.round(metrics.baseStep + diff);
    if(placeState.stepBounds){
      if(step < placeState.stepBounds.min) step = placeState.stepBounds.min;
      if(step > placeState.stepBounds.max) step = placeState.stepBounds.max;
    }
    const snapped = stepToNote(step);
    const note = {
      letter: snapped.letter,
      accidental: '',
      octave: snapped.octave
    };
    placeLog('snapPointer', {
      clientX: evt && evt.clientX,
      clientY: evt && evt.clientY,
      svgY: y,
      step,
      snappedY: metrics.bottomY - (step - metrics.baseStep) * metrics.stepHeight,
      note: `${note.letter}${note.accidental}${note.octave}`
    });
    return { note, step };
  }

  function svgPointerCoords(evt, svg){
    if(!evt || !svg || typeof svg.createSVGPoint !== 'function') return null;
    const ctm = svg.getScreenCTM && svg.getScreenCTM();
    if(!ctm || typeof ctm.inverse !== 'function') return null;
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    const inv = ctm.inverse();
    if(!inv) return null;
    const res = pt.matrixTransform(inv);
    if(!res || !Number.isFinite(res.x) || !Number.isFinite(res.y)) return null;
    return { x: res.x, y: res.y };
  }

  function commitAnswer(index, rawNote){
    const note = normalizeAnswerNote(rawNote);
    const entry = {
      note,
      step: noteStep(note),
      id: noteId(note),
      label: formatNoteLabel(note)
    };
    placeState.answers[index] = entry;
    const next = findNextUnanswered(index + 1);
    placeState.currentIndex = next;
    renderTestStaff();
    updateTargetLabel();
    updateProgress();
  }

  function normalizeAnswerNote(raw){
    const base = cloneNote(raw);
    base.accidental = '';
    return base;
  }

  function findNextUnanswered(startIndex){
    const total = placeState.answers.length;
    for(let i=startIndex;i<total;i++){
      if(!placeState.answers[i]) return i;
    }
    for(let i=0;i<total;i++){
      if(!placeState.answers[i]) return i;
    }
    return null;
  }

  function highlightCurrent(){
    if(!placeState.testStaff) return;
    const groups = placeState.testStaff.groups || [];
    groups.forEach((data, idx)=>{
      const group = data.group;
      if(!group) return;
      const target = placeState.targets[idx];
      if(data.answerLabel){
        data.answerLabel.textContent = target ? target.label : '';
      }
      const mode = placeState.answers[idx] ? 'visible' : 'ghost';
      group.dataset.mode = mode;
      group.classList.toggle('is-active', idx === placeState.currentIndex);
      group.classList.toggle('is-filled', Boolean(placeState.answers[idx]));
      if(data.answerLabel){
        data.answerLabel.classList.toggle('is-active', idx === placeState.currentIndex);
        data.answerLabel.classList.toggle('is-filled', Boolean(placeState.answers[idx]));
      }
      const isPreview = placeState.pointer && placeState.pointer.index === idx && placeState.pointer.preview;
      group.classList.toggle('is-preview', isPreview);
    });
  }

  function updateGroupForNote(index, note, mode, stepOverride){
    if(!placeState.testStaff) return;
    const data = placeState.testStaff.groups?.[index];
    if(!data) return;
    const metrics = placeState.testStaff.metrics;
    const group = data.group;
    const circle = group.querySelector('[data-role=\"note-head\"]');
    const cx = circle ? Number(circle.getAttribute('cx')) : (metrics.paddingX + metrics.clefOffset + index * metrics.noteGap);
    const diff = (typeof stepOverride === 'number' ? stepOverride : noteStep(note)) - metrics.baseStep;
    const cy = metrics.bottomY - diff * metrics.stepHeight;
    if(circle){
      circle.setAttribute('cx', cx);
      circle.setAttribute('cy', cy);
      if(circle.hasAttribute('transform')){
        circle.setAttribute('transform', `rotate(-15 ${cx} ${cy})`);
      }
    }
    if(placeState.debug){
      placeLog('updateGroup', {
        mode,
        idx: index,
        cx,
        cy,
        acc: note.accidental || '',
        slot: {
          span: metrics.slotSpans && metrics.slotSpans[index],
          start: metrics.slotStarts && metrics.slotStarts[index]
        },
        metrics: {
          noteGap: metrics.noteGap,
          paddingX: metrics.paddingX,
          clefOffset: metrics.clefOffset,
          bottomY: metrics.bottomY,
          stepHeight: metrics.stepHeight
        }
      });
    }
    if(placeState.debug){
      placeLog('updateGroup', {
        mode,
        idx: index,
        cx,
        cy,
        note: `${note.letter}${note.accidental || ''}${note.octave}`,
        metrics: {
          noteGap: metrics.noteGap,
          paddingX: metrics.paddingX,
          clefOffset: metrics.clefOffset,
          bottomY: metrics.bottomY,
          stepHeight: metrics.stepHeight
        }
      });
    }
    group.querySelectorAll('line[data-role=\"ledger\"]').forEach(line=>line.remove());
    if(mode !== 'ghost'){
      collectLedger(diff).forEach(pos=>{
        const y = metrics.bottomY - pos * metrics.stepHeight;
        const ledger = document.createElementNS(SVG_NS, 'line');
        ledger.setAttribute('x1', cx - 18);
        ledger.setAttribute('x2', cx + 18);
        ledger.setAttribute('y1', y);
        ledger.setAttribute('y2', y);
        ledger.setAttribute('stroke', placeState.staffColor || 'currentColor');
        ledger.setAttribute('stroke-width', '2');
        ledger.setAttribute('stroke-linecap', 'round');
        ledger.setAttribute('data-role', 'ledger');
        group.appendChild(ledger);
      });
    }
    group.dataset.mode = mode;
    group.classList.toggle('is-preview', mode === 'preview');
    group.classList.toggle('is-filled', mode === 'visible');
    data.note = cloneNote(note);
  }

  function evaluateQuiz(){
    if(!placeState.targets.length) return;
    const results = placeState.targets.map((target, idx)=>{
      const answer = placeState.answers[idx];
      const ok = Boolean(answer) && answer.id === target.id;
      return { target, answer, ok };
    });
    const correct = results.filter(r=>r.ok).length;
    const wrong = results.length - correct;
    placeState.lastResults = { results, correct, wrong };
    renderSummary(results, correct, wrong);
    if(els.testCard) els.testCard.classList.add('hidden');
    if(els.summaryCard) els.summaryCard.classList.remove('hidden');
  }

  function setSummaryLabel(label, parts){
    if(!label) return;
    while(label.firstChild) label.removeChild(label.firstChild);
    const segments = Array.isArray(parts) && parts.length ? parts : [{ text:'' }];
    segments.forEach(part=>{
      const tspan = document.createElementNS(SVG_NS, 'tspan');
      if(part.className) tspan.setAttribute('class', part.className);
      tspan.textContent = part.text ?? '';
      label.appendChild(tspan);
    });
  }

  function renderSummary(results, correct, wrong){
    if(els.summaryCorrect) els.summaryCorrect.textContent = String(correct);
    if(els.summaryWrong) els.summaryWrong.textContent = String(wrong);
    const total = results.length;
    const ratio = total ? correct / total : 0;
    if(els.summaryChart && App.utils && typeof App.utils.drawDonut === 'function'){
      App.utils.drawDonut(els.summaryChart, ratio);
    }
    if(els.summaryMotto){
      const motto = App.utils && typeof App.utils.mottoFor === 'function' ? App.utils.mottoFor(ratio) : '';
      els.summaryMotto.textContent = motto || '';
    }
    if(els.summaryBadge){
      const badge = App.utils && typeof App.utils.badgeFor === 'function' ? App.utils.badgeFor(ratio) : '';
      els.summaryBadge.textContent = badge || '';
    }
    if(els.summaryStaff) els.summaryStaff.innerHTML = '';
    const clefConfig = getClefConfig(placeState.config.clef);
    const summaryNotes = results.map(res=>{
      if(res.answer && res.answer.note) return res.answer.note;
      return res.target.note;
    });
    const summary = renderStaffShared({
      container: els.summaryStaff,
      clef: clefConfig,
      notes: summaryNotes,
      options:{
        classes:{
          group:'reading-place-note',
          noteHead:'reading-place-note-head',
          label:'reading-place-note-label',
          clef:'reading-place-clef'
        },
        selectable:false,
        noteGap: 112,
        paddingX: 48,
        paddingY: 32,
        extraTop: 48,
        extraBottom: 96,
        labelMargin: 40,
        noteRadius: placeState.noteRadius,
        fillWidth:false,
        renderNote:()=>'visible',
        initialLabel:()=>''
      }
    });
    summary.groups.forEach((data, idx)=>{
      if(!data || !data.group) return;
      const res = results[idx];
      const group = data.group;
      const labelNode = data.answerLabel;
      if(res.ok){
        group.classList.add('is-correct');
        group.classList.remove('is-wrong');
        const labelText = res.answer ? res.answer.label : res.target.label;
        setSummaryLabel(labelNode, [{ text: labelText, className: 'answer-correct' }]);
      } else {
        group.classList.add('is-wrong');
        group.classList.remove('is-correct');
        const expected = res.target.label;
        const userLabel = res.answer ? res.answer.label : '—';
        setSummaryLabel(labelNode, [
          { text: userLabel, className: 'answer-wrong' },
          { text: ' / ', className: 'answer-divider' },
          { text: expected, className: 'answer-correct' }
        ]);
      }
    });
    placeState.summaryStaff = summary;
  }

  document.addEventListener('toniqa-theme-change', ()=>{
    if(!placeState.view || placeState.view.classList.contains('hidden')) return;
    if(placeState.targets.length && els.testCard && !els.testCard.classList.contains('hidden')){
      renderTestStaff();
    }
    if(placeState.lastResults && els.summaryCard && !els.summaryCard.classList.contains('hidden')){
      const { results, correct, wrong } = placeState.lastResults;
      renderSummary(results, correct, wrong);
    }
  });

  App.readingPlace = {
    refresh(){
      renderConfigOptions();
      resetView();
    },
    reset(){
      resetView();
    }
  };

})();

(function(){
  const App = window.App = window.App || {};
  const SVG_NS = 'http://www.w3.org/2000/svg';
  const METER_DEFS = {
    '2/4':{ total:2, base:'quarter', allowed:['whole','half','quarter','eighth','sixteenth'] },
    '3/4':{ total:3, base:'quarter', allowed:['half','quarter','eighth','sixteenth'] },
    '4/4':{ total:4, base:'quarter', allowed:['whole','half','quarter','eighth','sixteenth'] },
    '2/2':{ total:2, base:'half', allowed:['half','quarter','eighth','sixteenth'] },
    '3/8':{ total:3, base:'eighth', allowed:['eighth','sixteenth'] },
    '6/8':{ total:6, base:'eighth', allowed:['half','quarter','eighth','sixteenth'] }
  };
  const COUNT_OPTIONS = [5,10,15];
  const NOTE_KEYS = { whole:'reading_rhythm_note_whole', half:'reading_rhythm_note_half', quarter:'reading_rhythm_note_quarter', eighth:'reading_rhythm_note_eighth', sixteenth:'reading_rhythm_note_sixteenth' };
  const REST_KEYS = { whole:'reading_rhythm_rest_whole', half:'reading_rhythm_rest_half', quarter:'reading_rhythm_rest_quarter', eighth:'reading_rhythm_rest_eighth', sixteenth:'reading_rhythm_rest_sixteenth' };
  const LENGTH_TYPES = ['whole','half','quarter','eighth','sixteenth'];

  const rhythmShapes = window.App && App.rhythmShapes;
  if(!rhythmShapes) return;
  const { createStaffBase, buildRestGlyph, buildNoteGlyph, appendTrebleClef, appendTimeSignature } = rhythmShapes;

  const state = {
    view:null,
    config:{ count:5, meters:new Set(Object.keys(METER_DEFS)) },
    tasks:[],
    pos:0
  };
  const els = {};
  const STAFF_LAYOUT_MAIN = {
    inset:30,
    startY:40,
    gap:14,
    height:170,
    minWidth:520,
    maxWidth:720,
    lead:110,
    tail:60
  };
  const STAFF_LAYOUT_SUMMARY = {
    inset:24,
    startY:34,
    gap:14,
    height:150,
    minWidth:360,
    maxWidth:620,
    lead:90,
    tail:40
  };

  ready(init);

  function ready(fn){
    if(document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  function init(){
    state.view = document.getElementById('view-reading-rhythm');
    if(!state.view) return;
    mapEls();
    renderControls();
    bindEvents();
    reset();
  }

  function mapEls(){
    els.setup = document.getElementById('rrp-setup');
    els.counts = document.getElementById('rrp-counts');
    els.meters = document.getElementById('rrp-meters');
    els.start = document.getElementById('rrp-start');
    els.quiz = document.getElementById('rrp-quiz');
    els.summary = document.getElementById('rrp-summary');
    els.progress = document.getElementById('rrp-progress');
    els.meterLabel = document.getElementById('rrp-meter');
    els.staff = document.getElementById('rrp-staff');
    els.palette = document.getElementById('rrp-palette');
    els.reset = document.getElementById('rrp-reset');
    els.back = document.getElementById('rrp-back');
    els.prev = document.getElementById('rrp-prev');
    els.next = document.getElementById('rrp-next');
    els.summaryList = document.getElementById('rrp-summary-list');
    els.summaryChart = document.getElementById('rrp-summary-chart');
    els.summaryCorrect = document.getElementById('rrp-summary-correct');
    els.summaryWrong = document.getElementById('rrp-summary-wrong');
    els.summaryMotto = document.getElementById('rrp-summary-motto');
    els.again = document.getElementById('rrp-again');
    els.select = document.getElementById('rrp-select');
    els.home = document.getElementById('rrp-home');
  }

  function t(key, params){
    const raw = (window.I18N && typeof I18N.t === 'function') ? I18N.t(key) : key;
    if(!params) return raw;
    return raw.replace(/\{(\w+)\}/g, (_,p)=> params[p] ?? '');
  }

  function renderControls(){
    renderChips(els.counts, COUNT_OPTIONS, state.config.count, val=>{ state.config.count = val; });
    renderMeterChips();
    updateStartState();
  }

  function renderMeterChips(){
    if(!els.meters) return;
    if(els.meters.innerHTML) return;
    Object.keys(METER_DEFS).forEach(id=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip';
      btn.dataset.value = id;
      btn.textContent = id;
      btn.classList.toggle('on', state.config.meters.has(id));
      btn.addEventListener('click', ()=>{
        if(state.config.meters.has(id)){ state.config.meters.delete(id); }
        else state.config.meters.add(id);
        btn.classList.toggle('on', state.config.meters.has(id));
        updateStartState();
      });
      els.meters.appendChild(btn);
    });
  }

  function renderChips(container, values, current, onChange){
    if(!container) return;
    container.innerHTML = '';
    values.forEach(val=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip';
      btn.dataset.value = String(val);
      btn.textContent = String(val);
      btn.classList.toggle('on', current === val);
      btn.addEventListener('click', ()=>{
        onChange(val);
        Array.from(container.children).forEach(c=>c.classList.toggle('on', c === btn));
      });
      container.appendChild(btn);
    });
  }

  function bindEvents(){
    if(els.start) els.start.addEventListener('click', start);
    if(els.reset) els.reset.addEventListener('click', resetBar);
    if(els.back) els.back.addEventListener('click', reset);
    if(els.prev) els.prev.addEventListener('click', prevTask);
    if(els.next) els.next.addEventListener('click', nextTask);
    if(els.again) els.again.addEventListener('click', ()=>{ reset(); start(); });
    if(els.select) els.select.addEventListener('click', reset);
    if(els.home) els.home.addEventListener('click', ()=>reset());
  }

  function updateStartState(){
    if(els.start) els.start.disabled = state.config.meters.size === 0;
  }

  function reset(){
    state.tasks = [];
    state.pos = 0;
    if(els.summaryList) els.summaryList.innerHTML = '';
    toggleView('setup');
  }

  function start(){
    const meters = Array.from(state.config.meters);
    if(!meters.length) return;
    const order = [];
    for(let i=0;i<state.config.count;i++){
      order.push(meters[i % meters.length]);
    }
    shuffle(order);
    state.tasks = order.map(mId=>createTask(mId));
    state.pos = 0;
    toggleView('quiz');
    renderTask();
  }

  function createTask(meterId){
    const def = METER_DEFS[meterId];
    const total = def.total;
    const minFill = total * 0.3;
    const maxFill = total * 0.7;
    let current = 0;
    const given = [];
    const allowed = allowedTypes(meterId);
    const minDur = Math.min(...allowed.map(t=>durationValue(t.type, meterId)));
    while(current < minFill){
      const pick = allowed[Math.floor(Math.random()*allowed.length)];
      const d = durationValue(pick.type, meterId);
      if(current + d > Math.min(maxFill, total) || current + d > total - minDur) continue;
      given.push({ kind: pick.kind, type: pick.type });
      current += d;
    }
    return { meterId, total, limit: total * 2, given, user:[], paletteOrder: buildPaletteOrder() };
  }

  function allowedTypes(meterId){
    const def = METER_DEFS[meterId];
    const result = [];
    def.allowed.forEach(type=>{
      result.push({ kind:'note', type });
      result.push({ kind:'rest', type });
    });
    return result.filter(item=>durationValue(item.type, meterId) <= def.total);
  }

  function buildPaletteOrder(){
    const items = LENGTH_TYPES.map(type=>({
      type,
      kind: Math.random() > 0.5 ? 'note' : 'rest'
    }));
    shuffle(items);
    return items;
  }

  function renderTask(){
    const task = state.tasks[state.pos];
    if(!task) return;
    const { meterId } = task;
    if(els.progress) els.progress.textContent = `${state.pos+1} / ${state.tasks.length}`;
    if(els.meterLabel) els.meterLabel.textContent = meterId;
    renderPalette(task);
    renderStaff(task);
  }

  function renderPalette(task){
    if(!task) return;
    if(!Array.isArray(task.paletteOrder)) task.paletteOrder = buildPaletteOrder();
    renderPalettePool(els.palette, task.paletteOrder, task);
  }

  function renderPalettePool(container, items, task){
    if(!container) return;
    container.innerHTML = '';
    (items || []).forEach(item=>{
      const keyMap = item.kind === 'note' ? NOTE_KEYS : REST_KEYS;
      const label = t(keyMap[item.type] || item.type);
      const btn = createPaletteButton(task, item, label);
      container.appendChild(btn);
    });
  }

  function createPaletteButton(task, item, label){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip chip-glyph';
    btn.setAttribute('aria-label', label);
    btn.setAttribute('title', label);
    const icon = createGlyphIcon(item);
    if(icon){
      btn.appendChild(icon);
    } else {
      btn.textContent = label;
    }
    btn.addEventListener('click', ()=>addElement(task, item));
    return btn;
  }

  function createGlyphIcon(item){
    if(!item) return null;
    const glyph = item.kind === 'rest' ? buildRestGlyph(item.type) : buildNoteGlyph(item.type);
    if(!glyph) return null;
    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', '-60 -90 120 180');
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    svg.setAttribute('role', 'presentation');
    svg.setAttribute('focusable', 'false');
    svg.setAttribute('aria-hidden', 'true');
    svg.classList.add('rrp-glyph');
    svg.appendChild(glyph);
    return svg;
  }

  function addElement(task, item){
    const dur = durationValue(item.type, task.meterId);
    const used = sumDurations([...task.given, ...task.user], task.meterId);
    const limit = typeof task.limit === 'number' ? task.limit : task.total * 2;
    if(used + dur > limit + 1e-4) return;
    task.user.push({ kind:item.kind, type:item.type });
    renderTask();
  }

  function resetBar(){
    const task = state.tasks[state.pos];
    if(!task) return;
    task.user = [];
    renderTask();
  }

  function prevTask(){
    if(state.pos > 0){ state.pos--; renderTask(); }
  }

  function nextTask(){
    if(state.pos < state.tasks.length-1){
      state.pos++; renderTask();
    } else {
      renderSummary();
    }
  }

  function sumDurations(list, meterId){
    return list.reduce((sum,item)=>sum + durationValue(item.type, meterId), 0);
  }

  function formatBeats(value){
    const rounded = Math.round(value * 100) / 100;
    if(Number.isInteger(rounded)) return String(rounded);
    if(Math.abs(rounded - 0.5) < 1e-4) return '1/2';
    if(Math.abs(rounded - 0.25) < 1e-4) return '1/4';
    if(Math.abs(rounded - 0.75) < 1e-4) return '3/4';
    if(Math.abs(rounded - 0.125) < 1e-4) return '1/8';
    return rounded.toFixed(2);
  }

  function glyphSpan(duration){
    if(!Number.isFinite(duration)) return 40;
    const span = 55 + duration * 14;
    return Math.min(98, Math.max(32, span));
  }

  function renderStaff(task){
    if(!els.staff) return;
    els.staff.innerHTML = '';
    if(!METER_DEFS[task.meterId]) return;
    const layout = STAFF_LAYOUT_MAIN;
    const items = [
      ...task.given.map(item=>({ ...item, source:'given' })),
      ...task.user.map(item=>({ ...item, source:'user' }))
    ];
    const durations = items.map(item=>durationValue(item.type, task.meterId));
    const width = layout.maxWidth;
    const staff = createStaffBase(width, layout.height, { inset:layout.inset, startY:layout.startY, gap:layout.gap });
    const svg = staff.svg;
    svg.setAttribute('viewBox',`0 0 ${width} ${layout.height}`);
    svg.setAttribute('preserveAspectRatio','xMinYMid meet');
    svg.style.width = '100%';
    svg.style.maxWidth = `${layout.maxWidth}px`;
    svg.style.height = 'auto';
    appendTrebleClef(svg, { x:layout.inset - 200, startY:layout.startY, gap:layout.gap });
    appendTimeSignature(svg, task.meterId, { x:layout.inset+70, startY:layout.startY, gap:layout.gap });
    const drawableWidth = width - (layout.inset * 2 + layout.lead + layout.tail);
    const totalSpan = durations.reduce((sum,d)=>sum + glyphSpan(d), 0);
    const spanScale = totalSpan > drawableWidth ? drawableWidth / totalSpan : 1;
    const startX = layout.inset + layout.lead + 10;
    const centerY = staff.startY + staff.gap * 2;
    let offset = startX;
    items.forEach((item, idx)=>{
      const dur = durations[idx];
      const glyph = item.kind === 'rest' ? buildRestGlyph(item.type) : buildNoteGlyph(item.type);
      glyph.setAttribute('transform', `translate(${offset},${centerY})`);
      glyph.setAttribute('data-source', item.source || 'user');
      svg.appendChild(glyph);
      offset += glyphSpan(dur) * spanScale;
    });
    els.staff.appendChild(svg);
  }

  function renderSummary(){
    toggleView('summary');
    const entries = state.tasks.map(task=>{
      const expected = task.total;
      const userTotal = sumDurations([...task.given, ...task.user], task.meterId);
      const diff = userTotal - expected;
      return { task, expected, userTotal, diff };
    });
    updateSummaryHero(entries);
    if(els.summaryList) els.summaryList.innerHTML = '';
    entries.forEach((entry, idx)=>{
      const { task, expected, userTotal, diff } = entry;
      const card = document.createElement('div');
      card.className = 'list-card';
      const ok = Math.abs(diff) < 1e-4;
      const diffText = ok
        ? t('reading_rhythm_practice_diff_ok')
        : (diff > 0 ? t('reading_rhythm_practice_diff_over', { beats: formatBeats(diff) }) : t('reading_rhythm_practice_diff_under', { beats: formatBeats(Math.abs(diff)) }));
      const header = document.createElement('div');
      header.className = 'summary-item-title';
      header.textContent = `${idx+1}. ${task.meterId}`;
      const sub = document.createElement('p');
      sub.className = 'sub';
      sub.textContent = diffText;
      card.appendChild(header);
      card.appendChild(sub);
      const meta = document.createElement('p');
      meta.className = 'sub';
      meta.textContent = `${t('label_correct')}: ${formatBeats(expected)} • ${t('label_yours')}: ${formatBeats(userTotal)}`;
      card.appendChild(meta);
      const mini = document.createElement('div');
      mini.className = 'rrp-staff';
      mini.appendChild(renderSummaryStaff(task));
      card.appendChild(mini);
      card.dataset.eval = ok ? 'ok' : 'bad';
      card.classList.add('eval-card');
      if(els.summaryList) els.summaryList.appendChild(card);
    });
    if(els.summaryList && App.utils && typeof App.utils.applyEvalState === 'function'){
      App.utils.applyEvalState(els.summaryList);
    }
  }

  function updateSummaryHero(entries){
    const total = Array.isArray(entries) ? entries.length : 0;
    const ok = (entries || []).filter(entry=>Math.abs(entry.diff) < 1e-4).length;
    const wrong = Math.max(0, total - ok);
    if(els.summaryCorrect) els.summaryCorrect.textContent = String(ok);
    if(els.summaryWrong) els.summaryWrong.textContent = String(wrong);
    const ratio = total ? ok / total : 0;
    if(els.summaryChart && App.utils && typeof App.utils.drawDonut === 'function'){
      App.utils.drawDonut(els.summaryChart, ratio);
    }
    if(els.summaryMotto){
      const motto = App.utils && typeof App.utils.mottoFor === 'function' ? App.utils.mottoFor(ratio) : '';
      els.summaryMotto.textContent = motto || '';
    }
  }

  function renderSummaryStaff(task){
    const layout = STAFF_LAYOUT_SUMMARY;
    const def = METER_DEFS[task.meterId];
    if(!def) return document.createElementNS(SVG_NS,'svg');
    const items = [
      ...task.given.map(item=>({ ...item, source:'given' })),
      ...task.user.map(item=>({ ...item, source:'user' }))
    ];
    const durations = items.map(item=>durationValue(item.type, task.meterId));
    const width = layout.maxWidth;
    const staff = createStaffBase(width, layout.height, { inset:layout.inset, startY:layout.startY, gap:layout.gap });
    const svg = staff.svg;
    svg.setAttribute('viewBox',`0 0 ${width} ${layout.height}`);
    svg.setAttribute('preserveAspectRatio','xMinYMid meet');
    svg.style.width = '100%';
    svg.style.maxWidth = `${layout.maxWidth}px`;
    svg.style.height = 'auto';
    appendTrebleClef(svg, { x:layout.inset - 190, startY:layout.startY, gap:layout.gap, scale:0.65 });
    appendTimeSignature(svg, task.meterId, { x:layout.inset +50, startY:layout.startY - 10, gap:layout.gap, fontSize:24 });
    const drawableWidth = width - (layout.inset * 2 + layout.lead + layout.tail);
    const totalSpan = durations.reduce((sum,d)=>sum + glyphSpan(d), 0);
    const spanScale = totalSpan > drawableWidth ? drawableWidth / totalSpan : 1;
    const startX = layout.inset + layout.lead + 10;
    const centerY = staff.startY + staff.gap * 2;
    let offset = startX;
    items.forEach((item, idx)=>{
      const dur = durations[idx];
      const glyph = item.kind === 'rest' ? buildRestGlyph(item.type) : buildNoteGlyph(item.type);
      glyph.setAttribute('transform', `translate(${offset},${centerY})`);
      glyph.setAttribute('data-source', item.source || 'user');
      svg.appendChild(glyph);
      offset += glyphSpan(dur) * spanScale;
    });
    return svg;
  }

  function toggleView(target){
    if(els.setup) els.setup.classList.toggle('hidden', target !== 'setup');
    if(els.quiz) els.quiz.classList.toggle('hidden', target !== 'quiz');
    if(els.summary) els.summary.classList.toggle('hidden', target !== 'summary');
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  function durationValue(type, meterId){
    const base = METER_DEFS[meterId]?.base || 'quarter';
    const map = {
      quarter: { whole:4, half:2, quarter:1, eighth:0.5, sixteenth:0.25 },
      half:    { whole:4, half:1, quarter:0.5, eighth:0.25, sixteenth:0.125 },
      eighth:  { whole:8, half:4, quarter:2, eighth:1, sixteenth:0.5 }
    };
    const val = map[base]?.[type];
    return typeof val === 'number' ? val : 1;
  }

  App.rhythmPractice = {
    reset
  };
})();


(function(){
  const { el } = App.utils;
  const { renderMainTable, naturalMinorFromMajor, minorPent, prefersFlatsKey, blueNoteB5, SCALES } = App.scales;
  const { MAJOR, ORDER_MAJ_INFO, ORDER_MAJ, ORDER_MIN, REL_MINOR, ksStringForMajor } = App.data;
  const { initBuildQuiz } = App.buildQuiz;
  const { initKsQuiz } = App.ksQuiz;
  const { ensureCircle, makeSelectNode } = App.circle;
  const { ensureCircle: ensureCircleQuiz, makeSelectNode: makeSelectNodeQuiz } = App.circleQuiz;

  const views={home:el('view-home'),scalesHub:el('view-scales-hub'),intervals:el('view-intervals'),
    intervalsWhat:el('view-intervals-what'),intervalsNames:el('view-intervals-names'),intervalsSizes:el('view-intervals-sizes'),intervalsScales:el('view-intervals-scales'),intervalsColor:el('view-intervals-color'),intervalsUse:el('view-intervals-use'),
    chords:el('view-chords'),chordsWhat:el('view-chords-what'),chordsBuild:el('view-chords-build'),chordsTriads:el('view-chords-triads'),chordsSeventh:el('view-chords-seventh'),chordsInversions:el('view-chords-inversions'),chordsDiatonic:el('view-chords-diatonic'),chordsReading:el('view-chords-reading'),
    harmony:el('view-harmony'),harmonyFunctions:el('view-harmony-functions'),harmonyCadences:el('view-harmony-cadences'),harmonyProgressions:el('view-harmony-progressions'),harmonyModulation:el('view-harmony-modulation'),
    improv:el('view-improv'),improvBasics:el('view-improv-basics'),improvPentatonic:el('view-improv-pentatonic'),improvTarget:el('view-improv-target'),
    dynamics:el('view-dynamics'),expressions:el('view-expressions'),sight:el('view-sight'),
    readingTheoryStaff:el('view-reading-theory-staff'),readingNotesMap:el('view-reading-notes-map'),readingTheoryRhythm:el('view-reading-theory-rhythm'),readingTheoryAcc:el('view-reading-theory-acc'),
    readingTheoryArticulation:el('view-reading-theory-articulation'),readingTheoryMarks:el('view-reading-theory-marks'),readingTheoryNavigation:el('view-reading-theory-navigation'),
    readingFind:el('view-reading-find'),readingPlace:el('view-reading-place'),readingRhythm:el('view-reading-rhythm'),
    scalesInfo:el('view-scales-info'),scales:el('view-scales'),detail:el('view-detail'),
    buildSel:el('view-build-select'),buildQuiz:el('view-build-quiz'),buildSum:el('view-build-summary'),
    ksquiz:el('view-ksquiz'),ksqSum:el('view-ksq-summary'),circle:el('view-circle'),
    circleQuiz:el('view-circle-quiz'),circq2Sum:el('view-circq2-summary')};

  const staffRenderer = App.staffRenderer;
  const detailEls = { variants:null, staff:null, label:null, notes:null };
  const detailState = { variants:[], activeId:'', staff:null };
  const STEP_LETTERS = ['C','D','E','F','G','A','B'];
  const STEP_INDEX = STEP_LETTERS.reduce((acc, letter, idx)=>{ acc[letter] = idx; return acc; }, {});
  const DETAIL_SEMITONES = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };

  function ensureDetailElements(){
    if(!detailEls.variants) detailEls.variants = el('detail-scale-variants');
    if(!detailEls.staff) detailEls.staff = el('detail-scale-staff');
    if(!detailEls.label) detailEls.label = el('detail-scale-variant-label');
    if(!detailEls.notes) detailEls.notes = el('detail-scale-variant-notes');
    if(!detailEls.playBtn) detailEls.playBtn = el('detail-scale-play');
    if(detailEls.playBtn && !detailEls.playBtn.hasListener){
      detailEls.playBtn.addEventListener('click', playActiveScale);
      detailEls.playBtn.hasListener = true;
    }
  }

  function clearDetailStaff(){
    ensureDetailElements();
    detailState.staff = null;
    if(detailEls.staff) detailEls.staff.innerHTML = '';
    if(detailEls.label) detailEls.label.textContent = '';
    if(detailEls.notes) detailEls.notes.textContent = '';
    if(detailEls.variants) detailEls.variants.innerHTML = '';
  }

  function parseScaleToken(token){
    let str = String(token || '').trim();
    if(!str) return { letter:'C', accidental:'' };
    str = str.replace('♯','#').replace('♭','b');
    let letter = str.charAt(0).toUpperCase();
    if(letter === 'H') letter = 'B';
    let accidental = '';
    const extra = str.charAt(1);
    if(extra === '#' || extra === 'b'){
      accidental = extra;
    }
    return { letter, accidental };
  }

  function buildScaleNotes(noteNames, clef){
    if(!staffRenderer || typeof staffRenderer.parseNote !== 'function') return [];
    const config = staffRenderer.getClefConfig(clef || 'treble');
    const baseStepValue = staffRenderer.noteStep(config.base);
    let prevStepValue = baseStepValue;
    let first = true;
    return noteNames.map(name=>{
      const { letter, accidental } = parseScaleToken(name);
      const stepIndex = STEP_INDEX[letter] ?? STEP_INDEX.C;
      let bestStepValue = null;
      let bestDiff = Infinity;
      for(let octave = config.base.octave - 3; octave <= config.base.octave + 4; octave++){
        const stepValue = octave * STEP_LETTERS.length + stepIndex;
        const reference = first ? baseStepValue : prevStepValue;
        const diff = Math.abs(stepValue - reference);
        if(diff < bestDiff || (diff === bestDiff && (bestStepValue === null || stepValue < bestStepValue))){
          bestDiff = diff;
          bestStepValue = stepValue;
        }
      }
      if(bestStepValue === null){
        bestStepValue = prevStepValue;
      }
      prevStepValue = bestStepValue;
      first = false;
      const octave = Math.floor(bestStepValue / STEP_LETTERS.length);
      const parsed = staffRenderer.parseNote(`${letter}${accidental}${octave}`);
      parsed.answer = `${letter}${accidental}`;
      if(accidental){
        parsed.meta = Object.assign({}, parsed.meta || {}, { forceAccidental:true });
      }
      return parsed;
    });
  }

  function buildMajorInfoNotes(){
    if(!staffRenderer || typeof staffRenderer.parseNote !== 'function') return [];
    const ids = ['C4','D4','E4','F4','G4','A4','B4','C5'];
    return ids.map(id=>{
      const note = staffRenderer.parseNote(id);
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  const majorInfoState = { notes:[], render:null };
  function renderMajorInfoStaff(){
    const host = el('info-major-staff');
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildMajorInfoNotes();
    if(!notes.length) return;
    majorInfoState.notes = notes;
    const rendered = staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:32,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    majorInfoState.render = rendered || null;
    if(majorInfoState.render && typeof majorInfoState.render.setActive === 'function'){
      majorInfoState.render.setActive(-1);
    }
  }

  const SHIFT_TONICS = ['C','D','F','G','A'];
  const shiftState = { tonic:'C', notes:[], render:null };

  function buildShiftNotes(tonic){
    const scale = MAJOR && MAJOR[tonic] ? MAJOR[tonic] : [];
    if(!scale.length) return [];
    const tokens = scale.concat(scale[0]);
    return buildScaleNotes(tokens, 'treble').map(note=>{
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  function renderShiftScale(){
    const host = el('info-shift-staff');
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildShiftNotes(shiftState.tonic || 'C');
    if(!notes.length) return;
    shiftState.notes = notes;
    const layoutNotes = notes.map(note=>({
      ...note,
      accidental: 'b',
      meta: Object.assign({}, note.meta || {}, { forceAccidental:true })
    }));
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:9, barUnits:[], meterUnits:0 })
      : null;
    const rendered = staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:32,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        layout,
        accidentalSpace:'all',
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    shiftState.render = rendered || null;
    if(shiftState.render && typeof shiftState.render.setActive === 'function'){
      shiftState.render.setActive(-1);
    }
  }

  function buildEnharmonicNotes(tonic){
    const scale = MAJOR && MAJOR[tonic] ? MAJOR[tonic] : [];
    if(!scale.length) return [];
    const tokens = scale.concat(scale[0]);
    return buildScaleNotes(tokens, 'treble').map(note=>{
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  function renderEnharmonicStaff(tonic, hostId){
    const host = el(hostId);
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildEnharmonicNotes(tonic);
    if(!notes.length){
      host.innerHTML = '';
      return;
    }
    const layoutNotes = notes.map(note=>({
      ...note,
      accidental: note.accidental || 'b',
      meta: Object.assign({}, note.meta || {}, { forceAccidental:true })
    }));
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:10, barUnits:[], meterUnits:0 })
      : null;
    staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:30,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        layout,
        accidentalSpace:'all',
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
  }

  function renderEnharmonicPair(){
    renderEnharmonicStaff('F#', 'info-shift-enharm-fsharp');
    renderEnharmonicStaff('Gb', 'info-shift-enharm-gflat');
  }

  function renderShiftKeyChips(){
    const wrap = el('info-shift-keys');
    if(!wrap || !App.utils || typeof App.utils.choiceChips !== 'function') return;
    const options = SHIFT_TONICS.map(value=>({ value, label: App.utils.noteName(value) }));
    App.utils.choiceChips(wrap, options, shiftState.tonic, value=>{
      shiftState.tonic = value;
      renderShiftScale();
    });
  }

  function playShiftScale(){
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const base = (shiftState.notes && shiftState.notes.length)
      ? shiftState.notes
      : buildShiftNotes(shiftState.tonic || 'C');
    if(!base.length) return;
    const down = base.slice(0, -1).reverse();
    const sequence = base.concat(down);
    const freqs = sequence.map(detailNoteFrequency);
    const baseLen = base.length;
    audio.playPattern(sequence.map(()=>0.5), {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:(idx)=>{
        if(!shiftState.render || typeof shiftState.render.setActive !== 'function') return;
        if(idx < baseLen){
          shiftState.render.setActive(idx);
        } else {
          const downIndex = idx - baseLen;
          const mapped = (baseLen - 2) - downIndex;
          shiftState.render.setActive(mapped);
        }
      },
      onFinish:()=>{
        if(shiftState.render && typeof shiftState.render.setActive === 'function'){
          shiftState.render.setActive(-1);
        }
      }
    });
  }

  function playMajorInfoScale(){
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const base = (majorInfoState.notes && majorInfoState.notes.length)
      ? majorInfoState.notes
      : buildMajorInfoNotes();
    if(!base.length) return;
    const down = base.slice(0, -1).reverse();
    const sequence = base.concat(down);
    const freqs = sequence.map(detailNoteFrequency);
    const baseLen = base.length;
    audio.playPattern(sequence.map(()=>0.5), {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:(idx)=>{
        if(!majorInfoState.render || typeof majorInfoState.render.setActive !== 'function') return;
        if(idx < baseLen){
          majorInfoState.render.setActive(idx);
        } else {
          const downIndex = idx - baseLen;
          const mapped = (baseLen - 2) - downIndex;
          majorInfoState.render.setActive(mapped);
        }
      },
      onFinish:()=>{
        if(majorInfoState.render && typeof majorInfoState.render.setActive === 'function'){
          majorInfoState.render.setActive(-1);
        }
      }
    });
  }

  const naturalMinorState = { notes:[], render:null };
  const harmonicMinorState = { notes:[], render:null };
  const melodicMinorState = { notes:[], render:null };
  const pentaState = { mode:'major', root:'C', notes:[], render:null };
  function buildNaturalMinorInfoNotes(){
    if(!staffRenderer || typeof staffRenderer.parseNote !== 'function') return [];
    const ids = ['A3','B3','C4','D4','E4','F4','G4','A4'];
    return ids.map(id=>{
      const note = staffRenderer.parseNote(id);
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  function renderNaturalMinorInfoStaff(){
    const host = el('info-harm-staff');
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildNaturalMinorInfoNotes();
    if(!notes.length) return;
    naturalMinorState.notes = notes;
    const rendered = staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:32,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    naturalMinorState.render = rendered || null;
    if(naturalMinorState.render && typeof naturalMinorState.render.setActive === 'function'){
      naturalMinorState.render.setActive(-1);
    }
  }

  function buildHarmonicMinorInfoNotes(){
    const tokens = ['A','B','C','D','E','F','G#','A'];
    return buildScaleNotes(tokens, 'treble').map(note=>{
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  function renderHarmonicMinorInfoStaff(){
    const host = el('info-harmonic-staff');
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildHarmonicMinorInfoNotes();
    if(!notes.length) return;
    harmonicMinorState.notes = notes;
    const layoutNotes = notes.map(note=>({
      ...note,
      accidental: 'b',
      meta: Object.assign({}, note.meta || {}, { forceAccidental:true })
    }));
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:9, barUnits:[], meterUnits:0 })
      : null;
    const rendered = staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:32,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        layout,
        accidentalSpace:'all',
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    harmonicMinorState.render = rendered || null;
    if(harmonicMinorState.render && typeof harmonicMinorState.render.setActive === 'function'){
      harmonicMinorState.render.setActive(-1);
    }
  }

  function playHarmonicMinorInfoScale(){
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const base = (harmonicMinorState.notes && harmonicMinorState.notes.length)
      ? harmonicMinorState.notes
      : buildHarmonicMinorInfoNotes();
    if(!base.length) return;
    const down = base.slice(0, -1).reverse();
    const sequence = base.concat(down);
    const freqs = sequence.map(detailNoteFrequency);
    const baseLen = base.length;
    audio.playPattern(sequence.map(()=>0.5), {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:(idx)=>{
        if(!harmonicMinorState.render || typeof harmonicMinorState.render.setActive !== 'function') return;
        if(idx < baseLen){
          harmonicMinorState.render.setActive(idx);
        } else {
          const downIndex = idx - baseLen;
          const mapped = (baseLen - 2) - downIndex;
          harmonicMinorState.render.setActive(mapped);
        }
      },
      onFinish:()=>{
        if(harmonicMinorState.render && typeof harmonicMinorState.render.setActive === 'function'){
          harmonicMinorState.render.setActive(-1);
        }
      }
    });
  }

  function buildMelodicMinorNotes(){
    const tokensUp = ['A','B','C','D','E','F#','G#','A'];
    const tokensDown = ['G','F','E','D','C','B','A'];
    const tokens = tokensUp.concat(tokensDown);
    return buildScaleNotes(tokens, 'treble').map(note=>{
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  function renderMelodicMinorInfoStaff(){
    const host = el('info-mel-staff');
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildMelodicMinorNotes();
    if(!notes.length) return;
    melodicMinorState.notes = notes;
    const layoutNotes = notes.map(note=>({
      ...note,
      accidental: 'b',
      meta: Object.assign({}, note.meta || {}, { forceAccidental:true })
    }));
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:9, barUnits:[], meterUnits:0 })
      : null;
    const rendered = staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:32,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        layout,
        accidentalSpace:'all',
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    melodicMinorState.render = rendered || null;
    if(melodicMinorState.render && typeof melodicMinorState.render.setActive === 'function'){
      melodicMinorState.render.setActive(-1);
    }
  }

  function playMelodicMinorInfoScale(){
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const base = (melodicMinorState.notes && melodicMinorState.notes.length)
      ? melodicMinorState.notes
      : buildMelodicMinorNotes();
    if(!base.length) return;
    const sequence = base;
    const freqs = sequence.map(detailNoteFrequency);
    audio.playPattern(sequence.map(()=>0.5), {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:(idx)=>{
        if(!melodicMinorState.render || typeof melodicMinorState.render.setActive !== 'function') return;
        melodicMinorState.render.setActive(idx);
      },
      onFinish:()=>{
        if(melodicMinorState.render && typeof melodicMinorState.render.setActive === 'function'){
          melodicMinorState.render.setActive(-1);
        }
      }
    });
  }

  function buildPentatonicTokens(root, mode){
    const SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const FLAT = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
    const preferSharps = mode === 'major' ? !prefersFlatsKey(root) : false;
    const arr = preferSharps ? SHARP : FLAT;
    let idx = arr.indexOf(root);
    if(idx < 0){
      idx = (preferSharps ? FLAT : SHARP).indexOf(root);
    }
    const base = idx >= 0 ? idx : 0;
    const pattern = mode === 'major'
      ? [0,2,4,7,9,12]
      : (mode === 'blue' ? [0,3,5,6,7,10,12] : [0,3,5,7,10,12]);
    return pattern.map(step=>arr[(base + step) % 12]);
  }

  function buildPentatonicNotes(){
    const tokens = buildPentatonicTokens(pentaState.root, pentaState.mode);
    return buildScaleNotes(tokens, 'treble').map(note=>{
      note.noteType = 'quarter';
      note.duration = 'quarter';
      note.kind = 'note';
      return note;
    });
  }

  function renderPentatonicStaff(){
    const host = el('info-penta-staff');
    if(!host || !staffRenderer || typeof staffRenderer.render !== 'function') return;
    const notes = buildPentatonicNotes();
    if(!notes.length) return;
    pentaState.notes = notes;
    const layoutNotes = notes.map(note=>({
      ...note,
      accidental: 'b',
      meta: Object.assign({}, note.meta || {}, { forceAccidental:true })
    }));
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(layoutNotes, { accidentalSpace:'all', noteGapBase:9, barUnits:[], meterUnits:0 })
      : null;
    const rendered = staffRenderer.render({
      container: host,
      clef: 'treble',
      notes,
      options:{
        classes:{ label:'info-staff-label' },
        defaultStem:'none',
        noteGap:32,
        paddingX:16,
        paddingY:12,
        extraTop:6,
        extraBottom:18,
        labelMargin:18,
        fillWidth:true,
        layout,
        accidentalSpace:'all',
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    pentaState.render = rendered || null;
    if(pentaState.render && typeof pentaState.render.setActive === 'function'){
      pentaState.render.setActive(-1);
    }
  }

  function renderPentatonicChips(){
    const modeWrap = el('info-penta-mode');
    const rootWrap = el('info-penta-root');
    if(!modeWrap || !rootWrap || !App.utils || typeof App.utils.choiceChips !== 'function') return;
    const modeOptions = [
      { value:'major', label: I18N.t('info_penta_mode_major') },
      { value:'minor', label: I18N.t('info_penta_mode_minor') },
      { value:'blue', label: I18N.t('info_penta_mode_blue') }
    ];
    App.utils.choiceChips(modeWrap, modeOptions, pentaState.mode, value=>{
      pentaState.mode = value;
      renderPentatonicStaff();
    });
    const rootOptions = ['C','A','D','G'].map(value=>({ value, label: App.utils.noteName(value) }));
    App.utils.choiceChips(rootWrap, rootOptions, pentaState.root, value=>{
      pentaState.root = value;
      renderPentatonicStaff();
    });
  }

  function playPentatonicScale(){
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const base = (pentaState.notes && pentaState.notes.length)
      ? pentaState.notes
      : buildPentatonicNotes();
    if(!base.length) return;
    const down = base.slice(0, -1).reverse();
    const sequence = base.concat(down);
    const freqs = sequence.map(detailNoteFrequency);
    const baseLen = base.length;
    audio.playPattern(sequence.map(()=>0.5), {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:(idx)=>{
        if(!pentaState.render || typeof pentaState.render.setActive !== 'function') return;
        if(idx < baseLen){
          pentaState.render.setActive(idx);
        } else {
          const downIndex = idx - baseLen;
          const mapped = (baseLen - 2) - downIndex;
          pentaState.render.setActive(mapped);
        }
      },
      onFinish:()=>{
        if(pentaState.render && typeof pentaState.render.setActive === 'function'){
          pentaState.render.setActive(-1);
        }
      }
    });
  }

  function playNaturalMinorInfoScale(){
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const base = (naturalMinorState.notes && naturalMinorState.notes.length)
      ? naturalMinorState.notes
      : buildNaturalMinorInfoNotes();
    if(!base.length) return;
    const down = base.slice(0, -1).reverse();
    const sequence = base.concat(down);
    const freqs = sequence.map(detailNoteFrequency);
    const baseLen = base.length;
    audio.playPattern(sequence.map(()=>0.5), {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true,
      onStep:(idx)=>{
        if(!naturalMinorState.render || typeof naturalMinorState.render.setActive !== 'function') return;
        if(idx < baseLen){
          naturalMinorState.render.setActive(idx);
        } else {
          const downIndex = idx - baseLen;
          const mapped = (baseLen - 2) - downIndex;
          naturalMinorState.render.setActive(mapped);
        }
      },
      onFinish:()=>{
        if(naturalMinorState.render && typeof naturalMinorState.render.setActive === 'function'){
          naturalMinorState.render.setActive(-1);
        }
      }
    });
  }

  function renderDetailStaffVariant(variant){
    ensureDetailElements();
    if(!detailEls.staff || !staffRenderer || !variant) return;
    detailEls.staff.innerHTML = '';
    const clefConfig = staffRenderer.getClefConfig(variant.clef || 'treble');
    const compact = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
    const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
      ? App.noteDrawing.layoutMeasure(variant.staffNotes, { accidentalSpace:'all', noteGapBase:18, barUnits:[], meterUnits:0 })
      : null;
    detailState.staff = staffRenderer.render({
      container: detailEls.staff,
      clef: clefConfig,
      notes: variant.staffNotes,
      options:{
        classes:{
          group:'detail-scale-note',
          noteHead:'detail-scale-note-head',
          label:'detail-scale-note-label',
          clef:'detail-scale-clef'
        },
        noteGap: compact ? 26 : 36,
        layout,
        variableSpacing: true,
        paddingX: compact ? 18 : 24,
        paddingY: compact ? 10 : 14,
        extraTop: compact ? 6 : 10,
        extraBottom: compact ? 18 : 24,
        noteRadius: compact ? { rx:5.2, ry:3.7 } : { rx:6.6, ry:4.6 },
        labelMargin: compact ? 16 : 22,
        fillWidth:false,
        accidentalSpace:'all',
        showAccidentals:true,
        initialLabel:(note)=>App.utils.noteName(note.answer || note.letter)
      }
    });
    detailState.activeId = variant.id;
    if(detailEls.label) detailEls.label.textContent = variant.label || '';
    if(detailEls.notes) detailEls.notes.textContent = variant.summary || '';
    if(detailEls.playBtn) detailEls.playBtn.disabled = !(variant.staffNotes && variant.staffNotes.length);
  }

  function renderDetailVariantChips(){
    ensureDetailElements();
    if(!detailEls.variants) return;
    detailEls.variants.innerHTML = '';
    detailState.variants.forEach(variant=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip';
      btn.dataset.variant = variant.id;
      btn.textContent = variant.label;
      if(detailState.activeId === variant.id){
        btn.classList.add('on');
      }
      btn.addEventListener('click', ()=>{
        if(detailState.activeId === variant.id) return;
        detailState.activeId = variant.id;
        renderDetailVariantChips();
        renderDetailStaffVariant(variant);
      });
      detailEls.variants.appendChild(btn);
    });
  }

  function setupDetailStaffPanel(config){
    ensureDetailElements();
    if(!staffRenderer || !detailEls.staff || !detailEls.variants){
      clearDetailStaff();
      return;
    }
    const { minor7, harmonicMinor, melodicMinor, melodicCombined, major7, minorP, majorP } = config;
    const clef = 'treble';
    const melodicAsc = melodicMinor && Array.isArray(melodicMinor.asc) ? melodicMinor.asc : (Array.isArray(melodicMinor) ? melodicMinor : []);
    const melodicDesc = melodicMinor && Array.isArray(melodicMinor.desc) ? melodicMinor.desc : [];
    const melodicTokens = Array.isArray(melodicCombined) && melodicCombined.length
      ? melodicCombined
      : (melodicAsc.length && melodicDesc.length ? [...melodicAsc, ...melodicDesc.slice(1)] : melodicAsc);
    const variants = [
      { id:'nat', label: I18N.t('detail_minor7'), tokens: minor7, summary: App.utils.notesJoin(minor7,' - ') },
      { id:'harm', label: I18N.t('detail_harmonic_minor'), tokens: harmonicMinor, summary: App.utils.notesJoin(harmonicMinor,' - ') },
      { id:'mel', label: I18N.t('detail_melodic_minor'), tokens: melodicTokens, summary: melodicDesc.length ? `↑ ${App.utils.notesJoin(melodicAsc, ' - ')} / ↓ ${App.utils.notesJoin(melodicDesc, ' - ')}` : `↑ ${App.utils.notesJoin(melodicAsc, ' - ')}` },
      { id:'maj', label: I18N.t('detail_major7'), tokens: major7, summary: App.utils.notesJoin(major7,' - ') },
      { id:'minp', label: I18N.t('detail_penta_minor'), tokens: minorP, summary: App.utils.notesJoin(minorP,' - ') },
      { id:'majp', label: I18N.t('detail_penta_major'), tokens: majorP, summary: App.utils.notesJoin(majorP,' - ') }
    ].filter(item=>Array.isArray(item.tokens) && item.tokens.length);
    if(!variants.length){
      detailState.variants = [];
      detailState.activeId = '';
      clearDetailStaff();
      return;
    }
    detailState.variants = variants.map(variant=>({
      ...variant,
      clef,
      staffNotes: buildScaleNotes(variant.tokens, clef)
    }));
    detailState.activeId = detailState.variants[0].id;
    renderDetailVariantChips();
    renderDetailStaffVariant(detailState.variants[0]);
  }

  function detailNoteFrequency(note){
    const parsed = parseScaleToken(note.answer || `${note.letter}${note.accidental || ''}`);
    const semitoneBase = DETAIL_SEMITONES[parsed.letter] ?? 0;
    const accidental = parsed.accidental === '#'
      ? 1
      : (parsed.accidental === 'b' || parsed.accidental === '♭') ? -1 : 0;
    const semitone = semitoneBase + accidental;
    const midi = (note.octave + 1) * 12 + semitone;
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function playActiveScale(){
    if(!detailState.activeId) return;
    const active = detailState.variants.find(variant=>variant.id === detailState.activeId);
    if(!active || !active.staffNotes || !active.staffNotes.length) return;
    const audio = App.audio;
    if(!audio || typeof audio.playPattern !== 'function') return;
    const pattern = active.staffNotes.map(()=>0.5);
    const freqs = active.staffNotes.map(detailNoteFrequency);
    audio.playPattern(pattern, {
      bpm:100,
      freq:index=>freqs[index] || freqs[freqs.length - 1],
      accentFirst:true
    });
  }

  document.addEventListener('toniqa-theme-change', ()=>{
    renderMajorInfoStaff();
    renderNaturalMinorInfoStaff();
    renderHarmonicMinorInfoStaff();
    renderMelodicMinorInfoStaff();
    renderPentatonicStaff();
    renderShiftScale();
    if(!detailState.variants.length) return;
    renderDetailVariantChips();
    const active = detailState.variants.find(variant=>variant.id===detailState.activeId) || detailState.variants[0];
    renderDetailStaffVariant(active);
  });

  function renderView(name){
    if(!name || !views[name]) return;
    Object.values(views).forEach(v=>v && v.classList && v.classList.add('hidden'));
    const target = views[name];
    if(!target || !target.classList) return;
    target.classList.remove('hidden');
    const isNav = (name==='home' || name==='scalesHub');
    document.body.classList.toggle('nav-mode', isNav);
    document.body.classList.toggle('detail-mode', !isNav);
  }

  const historySupported = !!(window.history && typeof window.history.pushState === 'function');
  const baseUrl = window.location.pathname + window.location.search;
  const canonical = (str='')=>str.replace(/[-_]/g,'');
  const VIEW_ID_MAP = {};
  Object.entries(views).forEach(([key, el])=>{
    if(el && el.id){
      VIEW_ID_MAP[el.id] = key;
      VIEW_ID_MAP[canonical(el.id)] = key;
      if(el.id.startsWith('view-')){
        const without = el.id.slice(5);
        VIEW_ID_MAP[without] = key;
        VIEW_ID_MAP[canonical(without)] = key;
      }
    }
    VIEW_ID_MAP[key] = key;
    VIEW_ID_MAP[canonical(key)] = key;
  });

  const VIEW_BACK = {
    home:null,
    scalesHub:'home',
    intervals:'home',
    intervalsWhat:'intervals',
    intervalsNames:'intervals',
    intervalsSizes:'intervals',
    intervalsScales:'intervals',
    intervalsColor:'intervals',
    intervalsUse:'intervals',
    chords:'home',
    chordsWhat:'chords',
    chordsBuild:'chords',
    chordsTriads:'chords',
    chordsSeventh:'chords',
    chordsInversions:'chords',
    chordsDiatonic:'chords',
    chordsReading:'chords',
    harmony:'home',
    harmonyFunctions:'harmony',
    harmonyCadences:'harmony',
    harmonyProgressions:'harmony',
    harmonyModulation:'harmony',
    improv:'home',
    improvBasics:'improv',
    improvPentatonic:'improv',
    improvTarget:'improv',
    dynamics:'sight',
    expressions:'sight',
    sight:'home',
    readingTheoryStaff:'sight',
    readingNotesMap:'sight',
    readingTheoryRhythm:'sight',
    readingTheoryAcc:'sight',
    readingTheoryArticulation:'sight',
    readingTheoryMarks:'sight',
    readingTheoryNavigation:'sight',
    readingFind:'sight',
    readingPlace:'sight',
    readingRhythm:'sight',
    scalesInfo:'scalesHub',
    scales:'scalesHub',
    detail: ()=> (lastFrom==='quiz' ? 'buildQuiz' : (lastFrom==='ksquiz' ? 'ksquiz' : 'scales')),
    buildSel:'scalesHub',
    buildQuiz:'buildSel',
    buildSum:null,
    ksquiz:'scalesHub',
    ksqSum:null,
    circle:'scalesHub',
    circleQuiz:'scalesHub',
    circq2Sum:null
  };

  function resolveBack(view){
    const entry = VIEW_BACK[view];
    if(typeof entry === 'function') return entry();
    return entry || null;
  }

  const PLACEHOLDER_PAGES = [
    { id:'view-intervals-what', titleKey:'intervals_what_title', annotationKey:'intervals_what_annotation' },
    { id:'view-intervals-names', titleKey:'intervals_names_title', annotationKey:'intervals_names_annotation' },
    { id:'view-intervals-sizes', titleKey:'intervals_sizes_title', annotationKey:'intervals_sizes_annotation' },
    { id:'view-intervals-scales', titleKey:'intervals_scales_title', annotationKey:'intervals_scales_annotation' },
    { id:'view-intervals-color', titleKey:'intervals_color_title', annotationKey:'intervals_color_annotation' },
    { id:'view-intervals-use', titleKey:'intervals_use_title', annotationKey:'intervals_use_annotation' },
    { id:'view-chords-what', titleKey:'chords_what_title', annotationKey:'chords_what_annotation' },
    { id:'view-chords-build', titleKey:'chords_build_title', annotationKey:'chords_build_annotation' },
    { id:'view-chords-triads', titleKey:'chords_triads_title', annotationKey:'chords_triads_annotation' },
    { id:'view-chords-seventh', titleKey:'chords_seventh_title', annotationKey:'chords_seventh_annotation' },
    { id:'view-chords-inversions', titleKey:'chords_inversions_title', annotationKey:'chords_inversions_annotation' },
    { id:'view-chords-diatonic', titleKey:'chords_diatonic_title', annotationKey:'chords_diatonic_annotation' },
    { id:'view-chords-reading', titleKey:'chords_reading_title', annotationKey:'chords_reading_annotation' },
    { id:'view-dynamics', titleKey:'dynamics_title', annotationKey:'dynamics_annotation' },
    { id:'view-expressions', titleKey:'expressions_title', annotationKey:'expressions_annotation' },
    { id:'view-harmony-functions', titleKey:'harmony_functions_title', annotationKey:'harmony_functions_note' },
    { id:'view-harmony-cadences', titleKey:'harmony_cadences_title', annotationKey:'harmony_cadences_note' },
    { id:'view-harmony-progressions', titleKey:'harmony_progressions_title', annotationKey:'harmony_progressions_note' },
    { id:'view-harmony-modulation', titleKey:'harmony_modulation_title', annotationKey:'harmony_modulation_note' },
    { id:'view-improv-basics', titleKey:'improv_basics_title', annotationKey:'improv_basics_note' },
    { id:'view-improv-pentatonic', titleKey:'improv_pentatonic_title', annotationKey:'improv_pentatonic_note' },
    { id:'view-improv-target', titleKey:'improv_target_notes_title', annotationKey:'improv_target_notes_note' },
    { id:'view-reading-theory-articulation', titleKey:'reading_theory_articulation_title', annotationKey:'reading_theory_articulation_annotation' },
    { id:'view-reading-theory-marks', titleKey:'reading_theory_marks_title', annotationKey:'reading_theory_marks_annotation' },
    { id:'view-reading-theory-navigation', titleKey:'reading_theory_navigation_title', annotationKey:'reading_theory_navigation_annotation' }
  ];

  function renderPlaceholderPage(section, def){
    if(!section || !def) return;
    const toolbar = section.querySelector('.toolbar');
    const existingCard = section.querySelector('.placeholder-card');
    if(existingCard) existingCard.remove();
    const oldCard = Array.from(section.children).find(node=>node.classList && node.classList.contains('list-card'));
    if(oldCard) oldCard.remove();
    const card = document.createElement('div');
    card.className = 'list-card stack stack-md placeholder-card';
    const h2 = document.createElement('h2');
    h2.className = 'h2';
    h2.setAttribute('data-i18n', def.titleKey);
    h2.textContent = I18N.t(def.titleKey);
    const sub = document.createElement('p');
    sub.className = 'sub';
    sub.setAttribute('data-i18n','page_in_preparation');
    sub.textContent = I18N.t('page_in_preparation');
    const body = document.createElement('p');
    body.setAttribute('data-i18n', def.annotationKey);
    body.textContent = I18N.t(def.annotationKey);
    card.appendChild(h2);
    card.appendChild(sub);
    card.appendChild(body);
    if(toolbar && toolbar.parentNode){
      toolbar.parentNode.insertBefore(card, toolbar.nextSibling);
    } else {
      section.appendChild(card);
    }
  }

  function renderPlaceholderPages(){
    (PLACEHOLDER_PAGES || []).forEach(def=>{
      const sec = el(def.id);
      renderPlaceholderPage(sec, def);
    });
  }

  function normalizeTarget(value){
    if(!value) return null;
    if(views[value]) return value;
    if(VIEW_ID_MAP[value]) return VIEW_ID_MAP[value];
    return null;
  }

  let currentView = Object.keys(views).find(key => views[key] && !views[key].classList.contains('hidden')) || 'home';
  const initialHash = (window.location.hash || '').replace('#','');
  const normalizedInitial = normalizeTarget(initialHash);
  if(normalizedInitial){
    renderView(normalizedInitial);
    currentView = normalizedInitial;
    setTimeout(()=>window.I18N && I18N.apply(),0);
  }

  function navigate(to, opts={}){
    const target = normalizeTarget(to);
    if(!target || currentView === target) return;
    if(currentView === 'readingFind' && target !== 'readingFind'){
      if(App.readingFind && typeof App.readingFind.reset === 'function'){
        App.readingFind.reset();
      }
    }
    renderView(target);
    currentView = target;
    if(historySupported){
      const url = baseUrl + '#'+(opts.id || views[target]?.id || target);
      if(opts.push !== false){
        history.pushState({view:target}, '', url);
      } else if(opts.replace){
        history.replaceState({view:target}, '', url);
      }
    }
    setTimeout(()=>window.I18N && I18N.apply(),0);
  }

  function backTo(to){
    navigate(to, {push:false, replace:true});
  }

  if(historySupported){
    const currentId = views[currentView] && views[currentView].id ? views[currentView].id : currentView;
    history.replaceState({view:currentView}, '', baseUrl + '#'+currentId);
    window.addEventListener('popstate', ()=>{
      const backTarget = resolveBack(currentView);
      if(!backTarget){
        const curId = views[currentView] && views[currentView].id ? views[currentView].id : currentView;
        history.pushState({view:currentView}, '', baseUrl + '#'+curId);
        return;
      }
      navigate(backTarget, {push:false, replace:true});
    });
  }

  if(App.utils){
    App.utils.navigate = (to, opts)=>navigate(to, opts||{});
    App.utils.backTo = (to)=>backTo(to);
    App.utils.show = function(arg1, arg2){
      let target;
      let opts = {};

      if(typeof arg1 === 'object' && arg1 !== null && typeof arg2 === 'string'){
        opts = arg1;
        target = arg2;
      } else if(typeof arg1 === 'string' && (typeof arg2 === 'undefined' || typeof arg2 === 'object')){
        target = arg1;
        opts = (typeof arg2 === 'object' && arg2) ? arg2 : {};
      } else if(typeof arg2 === 'string'){
        target = arg2;
      } else {
        target = arg1;
      }

      if(!target) return;
      navigate(target, opts);
    };
  }

  let lastFrom='scales';
  let activeDetailIndex=null;
  function openDetail(index,from){
    lastFrom=from||'scales';
    const row=SCALES[index];
    const majKey=row.major, minRoot=row.minor, flats=prefersFlatsKey(majKey);
    const minor7=naturalMinorFromMajor(majKey), major7=MAJOR[majKey];
    const harmonicMinorBase = App.utils.harmonicMinorScale(minRoot, flats);
    const melodicMinorBase = App.utils.melodicMinorScale(minRoot, flats);
    const minorP=[minor7[0],minor7[2],minor7[3],minor7[4],minor7[6],minor7[0]];
    const majorP=[major7[0],major7[1],major7[2],major7[4],major7[5],major7[0]];
    const triMin=[minor7[0],minor7[2],minor7[4]], triMaj=[major7[0],major7[2],major7[4]];
    const blue=blueNoteB5(minRoot,!flats);

    const minor7Full = [...minor7, minor7[0]];
    const major7Full = [...major7, major7[0]];
    const harmonicFull = Array.isArray(harmonicMinorBase) && harmonicMinorBase.length ? [...harmonicMinorBase, harmonicMinorBase[0]] : harmonicMinorBase;
    const melodicAscBase = melodicMinorBase && Array.isArray(melodicMinorBase.asc) ? melodicMinorBase.asc : (Array.isArray(melodicMinorBase) ? melodicMinorBase : []);
    const melodicDescBase = melodicMinorBase && Array.isArray(melodicMinorBase.desc) ? melodicMinorBase.desc : [];
    const melodicAscFull = melodicAscBase.length ? [...melodicAscBase, melodicAscBase[0]] : [];
    const melodicDescFull = melodicDescBase.length ? [...melodicDescBase, melodicDescBase[0]] : [];
    const minorPentFull = minorP;
    const majorPentFull = majorP;
    const melodicCombinedFull = melodicAscFull.length && melodicDescFull.length
      ? [...melodicAscFull, ...melodicDescFull.slice(1)]
      : melodicAscFull;
    activeDetailIndex = index;
    const localizedKs = App.utils.noteName(row.ks);
    el('detail-heading').textContent=`${App.utils.labelMinor(row.minor)} ↔ ${App.utils.labelMajor(majKey)} — ${localizedKs}`;
    el('detail-badge').textContent = `${I18N.t('rel_major_label')}: ${App.utils.noteName(majKey)} • ${I18N.t('tonic_minor_label')}: ${App.utils.noteName(minRoot)}`;
    el('list-minor7').textContent=App.utils.notesJoin(minor7Full,' - ');
    el('list-harmonic').textContent=App.utils.notesJoin(harmonicFull,' - ');
    const melodicAscLabel = melodicAscFull.length ? App.utils.notesJoin(melodicAscFull,' - ') : '';
    const melodicDescLabel = melodicDescFull.length ? App.utils.notesJoin(melodicDescFull,' - ') : '';
    el('list-melodic').textContent = melodicDescFull.length ? `↑ ${melodicAscLabel} / ↓ ${melodicDescLabel}` : `↑ ${melodicAscLabel}`;
    el('list-major7').textContent=App.utils.notesJoin(major7Full,' - ');
    el('list-minorP').textContent=App.utils.notesJoin(minorPentFull,' - ');
    el('list-majorP').textContent=App.utils.notesJoin(majorPentFull,' - ');
    el('triad-minor').textContent=App.utils.notesJoin(triMin,' - ');
    el('triad-major').textContent=App.utils.notesJoin(triMaj,' - ');
    el('blue-note').textContent=App.utils.noteName(blue);
    setupDetailStaffPanel({
      minor7: minor7Full,
      harmonicMinor: harmonicFull,
      melodicMinor: { asc: melodicAscFull, desc: melodicDescFull },
      melodicCombined: melodicCombinedFull,
      major7: major7Full,
      minorP: minorPentFull,
      majorP: majorPentFull
    });
    navigate('detail');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.body.classList.add('nav-mode');
    renderPlaceholderPages();
    let selectNode;
    let selectNodeQuiz;
    renderMainTable(openDetail);

    // v2 navigation
    el('go-basics').addEventListener('click', ()=>navigate('sight'));
    el('go-scales-hub').addEventListener('click', ()=>navigate('scalesHub'));
    el('back-home-hub').addEventListener('click', ()=>backTo('home'));
    el('go-intervals').addEventListener('click', ()=>navigate('intervals'));
    el('back-home-int').addEventListener('click', ()=>backTo('home'));
    el('go-intervals-what').addEventListener('click', ()=>navigate('intervalsWhat'));
    el('go-intervals-names').addEventListener('click', ()=>navigate('intervalsNames'));
    el('go-intervals-sizes').addEventListener('click', ()=>navigate('intervalsSizes'));
    el('go-intervals-scales').addEventListener('click', ()=>navigate('intervalsScales'));
    el('go-intervals-color').addEventListener('click', ()=>navigate('intervalsColor'));
    el('go-intervals-use').addEventListener('click', ()=>navigate('intervalsUse'));
    el('back-intervals-what').addEventListener('click', ()=>backTo('intervals'));
    el('back-intervals-names').addEventListener('click', ()=>backTo('intervals'));
    el('back-intervals-sizes').addEventListener('click', ()=>backTo('intervals'));
    el('back-intervals-scales').addEventListener('click', ()=>backTo('intervals'));
    el('back-intervals-color').addEventListener('click', ()=>backTo('intervals'));
    el('back-intervals-use').addEventListener('click', ()=>backTo('intervals'));
    el('go-chords').addEventListener('click', ()=>navigate('chords'));
    el('back-home-chords').addEventListener('click', ()=>backTo('home'));
    el('go-chords-what').addEventListener('click', ()=>navigate('chordsWhat'));
    el('go-chords-build').addEventListener('click', ()=>navigate('chordsBuild'));
    el('go-chords-triads').addEventListener('click', ()=>navigate('chordsTriads'));
    el('go-chords-seventh').addEventListener('click', ()=>navigate('chordsSeventh'));
    el('go-chords-inversions').addEventListener('click', ()=>navigate('chordsInversions'));
    el('go-chords-diatonic').addEventListener('click', ()=>navigate('chordsDiatonic'));
    el('go-chords-reading').addEventListener('click', ()=>navigate('chordsReading'));
    el('back-chords-what').addEventListener('click', ()=>backTo('chords'));
    el('back-chords-build').addEventListener('click', ()=>backTo('chords'));
    el('back-chords-triads').addEventListener('click', ()=>backTo('chords'));
    el('back-chords-seventh').addEventListener('click', ()=>backTo('chords'));
    el('back-chords-inversions').addEventListener('click', ()=>backTo('chords'));
    el('back-chords-diatonic').addEventListener('click', ()=>backTo('chords'));
    el('back-chords-reading').addEventListener('click', ()=>backTo('chords'));
    el('go-harmony').addEventListener('click', ()=>navigate('harmony'));
    el('back-home-harmony').addEventListener('click', ()=>backTo('home'));
    el('go-harmony-functions').addEventListener('click', ()=>navigate('harmonyFunctions'));
    el('go-harmony-cadences').addEventListener('click', ()=>navigate('harmonyCadences'));
    el('go-harmony-progressions').addEventListener('click', ()=>navigate('harmonyProgressions'));
    el('go-harmony-modulation').addEventListener('click', ()=>navigate('harmonyModulation'));
    el('back-harmony-functions').addEventListener('click', ()=>backTo('harmony'));
    el('back-harmony-cadences').addEventListener('click', ()=>backTo('harmony'));
    el('back-harmony-progressions').addEventListener('click', ()=>backTo('harmony'));
    el('back-harmony-modulation').addEventListener('click', ()=>backTo('harmony'));
    el('go-improv').addEventListener('click', ()=>navigate('improv'));
    el('back-home-improv').addEventListener('click', ()=>backTo('home'));
    el('go-improv-basics').addEventListener('click', ()=>navigate('improvBasics'));
    el('go-improv-pentatonic').addEventListener('click', ()=>navigate('improvPentatonic'));
    el('go-improv-target').addEventListener('click', ()=>navigate('improvTarget'));
    el('back-improv-basics').addEventListener('click', ()=>backTo('improv'));
    el('back-improv-pentatonic').addEventListener('click', ()=>backTo('improv'));
    el('back-improv-target').addEventListener('click', ()=>backTo('improv'));
    el('go-dynamics').addEventListener('click', ()=>navigate('dynamics'));
    el('back-home-dynamics').addEventListener('click', ()=>backTo('sight'));
    el('go-expressions').addEventListener('click', ()=>navigate('expressions'));
    el('back-home-expressions').addEventListener('click', ()=>backTo('sight'));
    el('back-home-sight').addEventListener('click', ()=>backTo('home'));
    el('go-reading-theory-staff').addEventListener('click', ()=>navigate('readingTheoryStaff'));
    el('go-reading-theory-notes').addEventListener('click', ()=>navigate('readingNotesMap'));
    el('go-reading-theory-rhythm').addEventListener('click', ()=>navigate('readingTheoryRhythm'));
    el('go-reading-theory-acc').addEventListener('click', ()=>{
      if(App.readingTheoryAcc && typeof App.readingTheoryAcc.refresh==='function'){ App.readingTheoryAcc.refresh(); }
      navigate('readingTheoryAcc');
    });
    el('go-reading-theory-articulation').addEventListener('click', ()=>navigate('readingTheoryArticulation'));
    el('go-reading-theory-marks').addEventListener('click', ()=>navigate('readingTheoryMarks'));
    el('go-reading-theory-navigation').addEventListener('click', ()=>navigate('readingTheoryNavigation'));
    el('go-reading-find').addEventListener('click', ()=>{
      if(App.readingFind && typeof App.readingFind.reset==='function') App.readingFind.reset();
      navigate('readingFind');
    });
    el('go-reading-place').addEventListener('click', ()=>{
      if(App.readingPlace && typeof App.readingPlace.reset==='function') App.readingPlace.reset();
      navigate('readingPlace');
    });
    el('go-reading-rhythm').addEventListener('click', ()=>{
      if(App.rhythmPractice && typeof App.rhythmPractice.reset==='function') App.rhythmPractice.reset();
      navigate('readingRhythm');
    });
    el('back-reading-theory-staff').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-notes-map').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-theory-rhythm').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-theory-acc').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-theory-articulation').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-theory-marks').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-theory-navigation').addEventListener('click', ()=>backTo('sight'));
    el('back-reading-find').addEventListener('click', ()=>{
      if(App.readingFind && typeof App.readingFind.reset==='function') App.readingFind.reset();
      backTo('sight');
    });
    el('back-reading-place').addEventListener('click', ()=>{
      if(App.readingPlace && typeof App.readingPlace.reset==='function') App.readingPlace.reset();
      backTo('sight');
    });
    el('back-reading-rhythm').addEventListener('click', ()=>{
      if(App.rhythmPractice && typeof App.rhythmPractice.reset==='function') App.rhythmPractice.reset();
      backTo('sight');
    });
    
    const infoPlay = el('info-major-play');
    if(infoPlay && !infoPlay.__bound){
      infoPlay.__bound = true;
      infoPlay.addEventListener('click', playMajorInfoScale);
    }
    const harmPlay = el('info-harm-play');
    if(harmPlay && !harmPlay.__bound){
      harmPlay.__bound = true;
      harmPlay.addEventListener('click', playNaturalMinorInfoScale);
    }
    const harmonicPlay = el('info-harmonic-play');
    if(harmonicPlay && !harmonicPlay.__bound){
      harmonicPlay.__bound = true;
      harmonicPlay.addEventListener('click', playHarmonicMinorInfoScale);
    }
    const melPlay = el('info-mel-play');
    if(melPlay && !melPlay.__bound){
      melPlay.__bound = true;
      melPlay.addEventListener('click', playMelodicMinorInfoScale);
    }
    const pentaPlay = el('info-penta-play');
    if(pentaPlay && !pentaPlay.__bound){
      pentaPlay.__bound = true;
      pentaPlay.addEventListener('click', playPentatonicScale);
    }
    const shiftPlay = el('info-shift-play');
    if(shiftPlay && !shiftPlay.__bound){
      shiftPlay.__bound = true;
      shiftPlay.addEventListener('click', playShiftScale);
    }

    el('go-scales-info').addEventListener('click', ()=>{
      navigate('scalesInfo');
      renderMajorInfoStaff();
      renderNaturalMinorInfoStaff();
      renderHarmonicMinorInfoStaff();
      renderMelodicMinorInfoStaff();
      renderPentatonicChips();
      renderPentatonicStaff();
      renderShiftKeyChips();
      renderShiftScale();
      renderEnharmonicPair();
      if(App.utils && typeof App.utils.initInfoFolds === 'function'){
        App.utils.initInfoFolds();
      }
    });
    el('go-scales').addEventListener('click', ()=>navigate('scales'));
    el('go-build').addEventListener('click', ()=>navigate('buildSel'));
    el('go-ksquiz').addEventListener('click', ()=>navigate('ksquiz'));
    el('go-circle').addEventListener('click', ()=>{
      navigate('circle');
      ensureCircle(selectNode);
    });
    el('go-circle-quiz').addEventListener('click', ()=>{
      navigate('circleQuiz');
      ensureCircleQuiz(selectNodeQuiz);
    });

    // v4: delegated clicks for summary buttons to avoid wiring issues
    document.addEventListener('click', (ev)=>{
      const id = ev.target && ev.target.id;
      if(!id) return;
      if(id==='sum-build-home'){ navigate('scalesHub'); }
      if(id==='sum-build-retry'){ navigate('buildSel'); }
      if(id==='sum-ksq-home'){ if(App.ksQuiz && typeof App.ksQuiz.reset==='function') App.ksQuiz.reset(); navigate('scalesHub'); }
      if(id==='sum-ksq-retry'){ if(App.ksQuiz && typeof App.ksQuiz.reset==='function') App.ksQuiz.reset(); navigate('ksquiz'); }
      if(id==='sum-circq2-home'){ resetCircq2State(); navigate('scalesHub'); }
      if(id==='sum-circq2-retry'){ resetCircq2State(); navigate('circleQuiz'); }
    });

    el('back-home').addEventListener('click', ()=>backTo('scalesHub'));
    el('back-home-2').addEventListener('click', ()=>backTo('scalesHub'));
    el('back-home-3').addEventListener('click', ()=>{
      if(App.ksQuiz && typeof App.ksQuiz.reset==='function') App.ksQuiz.reset();
      backTo('scalesHub');
    });
    el('back-home-4').addEventListener('click', ()=>backTo('scalesHub'));
    el('back-scales-info').addEventListener('click', ()=>backTo('scalesHub'));
    el('back-circle-quiz').addEventListener('click', ()=>{
      resetCircq2State();
      backTo('scalesHub');
    });
    el('back-dynamic').addEventListener('click', ()=>{ const target = (lastFrom==='quiz'?'buildQuiz':(lastFrom==='ksquiz'?'ksquiz':'scales')); backTo(target); });

    App.buildQuiz.initBuildQuiz({ openDetail, show:navigate, back: backTo });
    App.ksQuiz.initKsQuiz({ show:navigate });

    selectNode = App.circle.makeSelectNode();
    selectNodeQuiz = App.circleQuiz.makeSelectNode(onCircleQuizPicked);
    window.selectNode = selectNode;
    window.selectCircleQuizNode = selectNodeQuiz;
    ensureCircle(selectNode);
    ensureCircleQuiz(selectNodeQuiz);

    // Centralized i18n re-application after view navigation
    document.addEventListener('click', function(e){
      const a = e.target.closest('[data-action="nav"], [data-action="back"], a[href^="#view-"]');
      if(a){ setTimeout(()=>window.I18N && I18N.apply(), 0); }
    }, true);

    renderMajorInfoStaff();
    renderNaturalMinorInfoStaff();
    renderHarmonicMinorInfoStaff();
    renderMelodicMinorInfoStaff();
    renderPentatonicChips();
    renderPentatonicStaff();
    renderShiftKeyChips();
    renderShiftScale();
    renderEnharmonicPair();
    if(App.utils && typeof App.utils.initInfoFolds === 'function'){
      App.utils.initInfoFolds();
    } else if(typeof initInfoFolds === 'function'){
      initInfoFolds();
    }
  });

  function resetCircq2State(){
    circ2Active=false;
    circ2Rounds=0;
    circ2List=[];
    circ2Pos=0;
    circ2Answers=[];
    const choose=el('circq2-choose');
    const wrap=el('circq2-wrap');
    if(choose) choose.classList.remove('hidden');
    if(wrap) wrap.classList.add('hidden');
    const result=el('circq2-result');
    if(result) result.innerHTML='';
    const prog=el('circq2-prog');
    if(prog) prog.textContent='';
    const sign=el('circq2-sign');
    if(sign) sign.textContent='';
    const nextBtn=el('circq2-next');
    if(nextBtn){
      const fallbackNext = (typeof I18N!=='undefined' && I18N && typeof I18N.t==='function') ? I18N.t('common_next') : 'Další';
      nextBtn.textContent = fallbackNext;
    }
  }

  let circ2Active=false,circ2Rounds=0,circ2List=[],circ2Pos=0,circ2Answers=[];
  function initCirc2Answers(){
    circ2Answers = circ2List.map(target=>({ target, clicked:undefined, label:null, evaluated:false, ok:false }));
  }
  function startCirc2(rounds){
    circ2Active=true; circ2Rounds=rounds;
    const idxs=[...Array(12).keys()]; for(let i=idxs.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [idxs[i],idxs[j]]=[idxs[j],idxs[i]]; }
    circ2List=idxs.slice(0,rounds); circ2Pos=0; initCirc2Answers();
    el('circq2-choose').classList.add('hidden'); el('circq2-wrap').classList.remove('hidden'); loadCirc2();
  }
  function endCirc2(){ resetCircq2State(); }
  function ensureCirc2Defaults(record){
    if(!record) return;
    if(typeof record.clicked!=='number'){
      record.label = record.label || '—';
      record.ok = false;
    } else {
      record.ok = (record.clicked === record.target);
    }
  }
  function renderCirc2Result(record){
    if(!record) return;
    ensureCirc2Defaults(record);
    const targetMajor = ORDER_MAJ_INFO[record.target].majors[0];
    const targetLabel = `${App.utils.labelMajor(targetMajor)} / ${App.utils.labelMinor(ORDER_MIN[record.target])}`;
    const badge = App.utils.evalBadge(record.ok);
    const yours = record.label || '—';
    el('circq2-result').innerHTML = `<div class='summary-list eval-lines'>
      <div class='eval-card' data-eval='${record.ok?'ok':'bad'}'>
        ${badge} ${I18N.t('your_click')}: ${yours}${record.ok ? '' : `<div class='sub'>${I18N.t('correct_is')} ${targetLabel}</div>`}
      </div>
    </div>`;
    App.utils.applyEvalState(el('circq2-result'));
  }
  function loadCirc2(){
    const i=circ2List[circ2Pos]; const M=ORDER_MAJ_INFO[i].majors[0];
    el('circq2-prog').textContent = `${circ2Pos+1} / ${circ2Rounds}`;
    el('circq2-sign').textContent = ksStringForMajor(M);
    const record = circ2Answers[circ2Pos];
    if(record && record.evaluated){
      renderCirc2Result(record);
    } else {
      el('circq2-result').innerHTML='';
    }
    const nextLabel = (circ2Pos===circ2Rounds-1) ? I18N.t('finish') : I18N.t('common_next');
    el('circq2-next').textContent = nextLabel;
  }
  function onCircleQuizPicked(i,kind){
    if(!circ2Active) return;
    const target=circ2List[circ2Pos];
    const label = (kind==='M')
      ? App.utils.labelMajor(ORDER_MAJ_INFO[i].majors[0])
      : `${App.utils.labelMajor(ORDER_MAJ_INFO[i].majors[0])} / ${App.utils.labelMinor(ORDER_MIN[i])}`;
    const record = circ2Answers[circ2Pos];
    if(record){
      record.clicked = i;
      record.label = label;
      record.evaluated = false;
      ensureCirc2Defaults(record);
    }
    el('circq2-result').innerHTML='';
  }
  function evaluateCirc2(){
    if(!circ2Active) return;
    const record = circ2Answers[circ2Pos];
    if(!record) return;
    ensureCirc2Defaults(record);
    record.evaluated = true;
    renderCirc2Result(record);
  }
  document.addEventListener('click',(e)=>{
    if(e.target.classList.contains('circq2-pick')) startCirc2(parseInt(e.target.dataset.rounds,10));
    if(e.target.id==='circq2-exit') endCirc2();
    if(e.target.id==='circq2-next'){
      const record = circ2Answers[circ2Pos];
      ensureCirc2Defaults(record);
      if(circ2Pos<circ2Rounds-1){ circ2Pos++; loadCirc2(); }
      else {
        const list=el('circq2-summary-list'); list.innerHTML=''; let corr=0;
        circ2Answers.forEach((r,i)=>{
          if(!r) return;
          ensureCirc2Defaults(r);
          if(r.ok) corr++;
          const M=ORDER_MAJ_INFO[r.target].majors[0];
          const correctMinor = App.data.REL_MINOR[M];
          const targetLabel = `${App.utils.labelMajor(M)} / ${App.utils.labelMinor(correctMinor)}`;
          const yourLabel = r.label || '—';
          const div=document.createElement('div'); div.className='list-card';
          div.innerHTML = `<div class='summary-item-title'>${i+1}. ${I18N.t('summary_acc_label')}: ${App.data.ksStringForMajor(M)}</div>
            <div class='summary-list eval-lines'>
              <div class='eval-card' data-eval='${r.ok?'ok':'bad'}'>${I18N.t('your_click')}: ${yourLabel} <span class='sub'>(${I18N.t('label_correct')}: ${targetLabel})</span></div>
            </div>`;
          list.appendChild(div);
        });
        App.utils.applyEvalState(list);
        const total = circ2Answers.length || circ2Rounds;
        const p = total ? (corr/total) : 0;
        App.utils.drawDonut(el('circq2-chart'), p); el('circq2-motto').textContent=App.utils.mottoFor(p); el('circq2-badge').textContent=App.utils.badgeFor(p);
        navigate('circq2Sum'); endCirc2();
      }
    }
  });

  App.refreshLang = function(){
    renderMainTable(openDetail);
    renderMajorInfoStaff();
    renderNaturalMinorInfoStaff();
    renderHarmonicMinorInfoStaff();
    renderMelodicMinorInfoStaff();
    renderPentatonicChips();
    renderPentatonicStaff();
    renderShiftKeyChips();
    renderShiftScale();
    if(App.utils && typeof App.utils.refreshInfoFolds === 'function'){
      App.utils.refreshInfoFolds();
    } else if(typeof refreshInfoFolds === 'function'){
      refreshInfoFolds();
    }
    if(App.buildQuiz && typeof App.buildQuiz.refreshLang==='function') App.buildQuiz.refreshLang();
    if(App.readingNotesMap && typeof App.readingNotesMap.refresh==='function') App.readingNotesMap.refresh();
    if(App.readingTheoryStaff && typeof App.readingTheoryStaff.refresh==='function') App.readingTheoryStaff.refresh();
    if(App.readingTheoryAcc && typeof App.readingTheoryAcc.refresh==='function') App.readingTheoryAcc.refresh();
    if(App.readingTheoryRhythm && typeof App.readingTheoryRhythm.refresh==='function') App.readingTheoryRhythm.refresh();
    if(App.readingFind && typeof App.readingFind.refresh==='function') App.readingFind.refresh();
    if(App.circle && typeof App.circle.refresh==='function') App.circle.refresh();
    if(App.circleQuiz && typeof App.circleQuiz.refresh==='function') App.circleQuiz.refresh();
    if(activeDetailIndex!==null && !views.detail.classList.contains('hidden')){
      openDetail(activeDetailIndex,lastFrom);
    }
  };
})();

</script>
<script>
/* v5.1 — interaktivní dlaždice, ikony a corner značky */
(function(){
  const ICON_MAP = {
    basics:'reading',
    scales:'scales',
    list:'scales',
    build:'build',
    intervals:'intervals',
    'intervals-what':'intervals',
    'intervals-names':'intervals',
    'intervals-sizes':'intervals',
    'intervals-scales':'intervals',
    'intervals-color':'intervals',
    'intervals-use':'intervals',
    chords:'chords',
    'chords-what':'chords',
    'chords-build':'chords',
    'chords-triads':'chords',
    'chords-seventh':'chords',
    'chords-inversions':'chords',
    'chords-diatonic':'chords',
    'chords-reading':'chords',
    ksquiz:'ksquiz',
    harmony:'chords',
    'harmony-functions':'chords',
    'harmony-cadences':'chords',
    'harmony-progressions':'circle-quiz',
    'harmony-modulation':'circle',
    improv:'reading-find',
    'improv-basics':'reading',
    'improv-pentatonic':'scales',
    'improv-target':'reading-find',
    reading:'reading',
    'reading-find':'readingFind',
    'reading-place':'readingPlace',
    'reading-rhythm':'readingRhythm',
    'reading-dynamics':'dynamics',
    'reading-expressions':'expressions',
    'reading-theory-staff':'readingTheoryStaff',
    'reading-theory-notes':'readingTheoryNotes',
    'reading-theory-rhythm':'readingTheoryRhythm',
    'reading-theory-acc':'readingTheoryAcc',
    'reading-theory-articulation':'readingTheoryArticulation',
    'reading-theory-marks':'readingTheoryMarks',
    'reading-theory-navigation':'readingTheoryNavigation',
    'about-scales':'info',
    circle:'circle',
    'circle-quiz':'circleQuiz'
  };
  function bindTiles(){
    ['view-home','view-scales-hub','view-sight','view-harmony','view-improv','view-intervals','view-chords'].forEach(function(contId){
      var wrap = document.getElementById(contId);
      if(!wrap) return;
      wrap.querySelectorAll('.card-tile').forEach(function(tile){
        if(tile.__bound) return;
        tile.__bound = true;
        tile.addEventListener('click', function(e){
          if(e.target.closest('a,button')) return;
          var action = tile.querySelector('a,button');
          if(action){ action.click(); }
        });
      });
    });
  }

  function renderInlineIcons(){
    if(!window.Icons) return;
    document.querySelectorAll('.icon-slot[data-icon]').forEach(slot=>{
      if(slot.__rendered) return;
      const key = slot.dataset.icon;
      const iconName = ICON_MAP[key] || key;
      const classes = Array.from(slot.classList).filter(c=>c!=='icon-slot').join(' ').trim() || 'icon';
      const svg = Icons.svg(iconName, classes);
      if(!svg) return;
      svg.classList.add('icon');
      slot.replaceWith(svg);
    });
  }

  function refreshTiles(){
    bindTiles();
    renderInlineIcons();
  }

  window.addEventListener('load', refreshTiles);
})();
</script>
<style id="interval-icon-override"></style>

<style>
/* v5.8.6 — toolbar buttons: unified sizing, spacing & contrast */
.toolbar{
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  padding: 10px 12px;
  margin: 6px 0 12px;
}
.toolbar .btn{
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 15px;
  line-height: 1.2;
}
  .toolbar .btn-ghost{
    border-color: var(--btn-ghost-bd);
  }
.toolbar .btn.btn-green{
  /* subtle inner emphasis for primary actions in toolbars */
  box-shadow: 0 0 0 2px rgba(34,197,94,.14) inset;
}
.toolbar .badge{
  /* when present in toolbars, let it align to the right side */
  margin-left: auto;
}
@media (max-width: 560px){
  .toolbar{ gap: 8px; }
  .toolbar .btn{ padding: 9px 12px; font-size: 14px; }
  .toolbar .sp{ flex-basis: 100%; height: 0; }
}
</style>
<script id="appstate-delegation">
(function(){
  const ENABLE_DELEGATION = false;
  window.ToniQa = window.ToniQa || {};
  const State = window.ToniQa.State = window.ToniQa.State || {
    currentView: 'view-home',
    history: []
  };
  function showView(id){
    try{
      var views = document.querySelectorAll('[id^="view-"]');
      views.forEach(function(v){ v.classList.add('hidden'); });
      var el = document.getElementById(id);
      if(el){ el.classList.remove('hidden'); State.currentView = id; }
    }catch(e){}
  }
  function closestWithAction(el){
    while(el && el !== document){
      if(el.dataset && el.dataset.action) return el;
      el = el.parentElement;
    }
    return null;
  }
  var Actions = {
    nav: function(e, el){ var to = el.dataset.to; if(to){ showView(to); } },
    back: function(e, el){
      if(State.history && State.history.length){ showView(State.history.pop()); }
      else { showView('view-home'); }
    }
  };
  function handleAction(e, el){
    var act = el.dataset.action; if(!act) return;
    var fn = Actions[act];
    if(fn){
      var to = el.dataset.to;
      if(to && State.currentView && State.currentView !== to){
        State.history.push(State.currentView);
      }
      fn(e, el);
    }
  }
  if(ENABLE_DELEGATION){
    document.addEventListener('click', function(e){
      // Priority: data-action
      var el = closestWithAction(e.target);
      if(el){
        var link = el.tagName === 'A' ? el : (e.target.closest && e.target.closest('a[href]'));
        if(link){
          var href = (link.getAttribute('href')||'').trim();
          if(/^https?:\/\//i.test(href)) return;
        }
        e.preventDefault();
        handleAction(e, el);
        return;
      }
      // Fallback: anchors href="#view-..."
      var a = e.target.closest && e.target.closest('a[href^="#view-"]');
      if(a){
        var href = a.getAttribute('href') || '';
        var to = href.replace(/^#/, '');
        if(to){
          e.preventDefault();
          if(State.currentView && State.currentView !== to){
            State.history.push(State.currentView);
          }
          showView(to);
        }
      }
    }, true);
  }
  window.addEventListener('load', function(){
    var vis = Array.from(document.querySelectorAll('[id^="view-"]')).find(function(v){ return !v.classList.contains('hidden'); });
    if(vis){ State.currentView = vis.id; }
  });
})();
</script>


<script>
  // one-shot purge right before first summary render
  (function(){ try { window.__evalLeafGuard && window.__evalLeafGuard.refresh(document); } catch(e){} })();
</script>

<!-- Hidden renderGeneric lab (access via #render-lab or ?renderLab=1) -->
<section id="view-render-lab" class="hidden render-lab">
  <div class="render-lab-card">
  <div class="render-lab-head">
    <div>
      <p class="eyebrow">Render lab (hidden)</p>
      <p class="sub">Testujeme kombinace renderGeneric: klíče, předznamenání vs. posuvky, metrum, dvouoktávové stupnice a zkušební pomlky.</p>
    </div>
    <div class="render-lab-controls">
      <label>
        Klíč
        <select id="render-lab-clef">
          <option value="treble">Houslový</option>
          <option value="bass">Basový</option>
          <option value="alto">Altový</option>
          <option value="tenor">Tenorový</option>
        </select>
      </label>
      <label>
        Mód
        <select id="render-lab-mode">
          <option value="signature">Předznamenání</option>
          <option value="inline">Posuvky u not</option>
        </select>
      </label>
      <label>
        Durová stupnice
        <select id="render-lab-scale"></select>
      </label>
      <label class="zones-toggle">
        Zóny
        <input type="checkbox" id="render-lab-zones" checked />
      </label>
    </div>
  </div>
    <div class="render-lab-staff" id="render-lab-staff"></div>
    <pre class="render-lab-debug" id="render-lab-debug"></pre>
    <div class="render-lab-legend">
      <span class="chip muted">4/4 metrum</span>
      <span class="chip muted">2 oktávy</span>
      <span class="chip muted">Mix délek + pomlky</span>
      <span class="chip muted">Posuvky u not testují odrazky</span>
    </div>
  </div>
</section>

<style>
  #view-render-lab{padding:24px;}
  .render-lab-card{border:1px dashed var(--border-subtle,rgba(15,23,42,.18));border-radius:16px;background:var(--surface,rgba(15,23,42,.04));padding:20px;display:flex;flex-direction:column;gap:16px;}
  .render-lab-head{display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;}
  .render-lab-controls{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;}
  .render-lab-controls label{display:flex;flex-direction:column;font-size:14px;color:var(--muted);}
  .render-lab-controls select{min-width:140px;border:1px solid var(--border-subtle,rgba(15,23,42,.15));border-radius:10px;padding:8px 10px;background:var(--surface,white);color:var(--ink);}
  .render-lab-controls .zones-toggle{flex-direction:row;align-items:center;gap:6px;}
  .render-lab-controls .zones-toggle input{width:18px;height:18px;}
  .render-lab-staff{border:1px dashed var(--border-subtle,rgba(15,23,42,.18));border-radius:14px;padding:12px;background:var(--surface-subtle,rgba(15,23,42,.03));overflow:auto;}
  .render-lab-staff svg{display:block;margin:0 auto;max-width:100%;}
  .render-lab-legend{display:flex;gap:8px;flex-wrap:wrap;}
  .render-lab-legend .chip{background:var(--surface,rgba(15,23,42,.05));border:1px solid var(--border-subtle,rgba(15,23,42,.15));}
  .render-lab-debug{background:transparent;border:none;margin:0;padding:0;color:var(--muted);font-size:12px;white-space:pre-wrap;}
  :root[data-theme="night"] .render-lab-card{background:rgba(255,255,255,.02);border-color:rgba(255,255,255,.12);}
  :root[data-theme="night"] .render-lab-staff{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.1);}
</style>

<script>
(function(){
  const App = window.App || {};
  const staff = App.staffRenderer;
  const SVG_NS = 'http://www.w3.org/2000/svg';
  if(!staff || typeof staff.render !== 'function') return;

  const SHARP_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const FLAT_NAMES = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
  const MAJOR_KEYS = [
    { id:'C', label:'C dur', tonic:'C4', preferFlats:false, marks:[] },
    { id:'G', label:'G dur (1♯)', tonic:'G3', preferFlats:false, marks:['F#4'] },
    { id:'D', label:'D dur (2♯)', tonic:'D3', preferFlats:false, marks:['F#4','C#5'] },
    { id:'A', label:'A dur (3♯)', tonic:'A3', preferFlats:false, marks:['F#4','C#5','G#4'] },
    { id:'E', label:'E dur (4♯)', tonic:'E3', preferFlats:false, marks:['F#4','C#5','G#4','D#5'] },
    { id:'B', label:'H dur (5♯)', tonic:'B2', preferFlats:false, marks:['F#4','C#5','G#4','D#5','A#4'] },
    { id:'F#', label:'Fis dur (6♯)', tonic:'F#3', preferFlats:false, marks:['F#4','C#5','G#4','D#5','A#4','E#5'] },
    { id:'C#', label:'Cis dur (7♯)', tonic:'C#3', preferFlats:false, marks:['F#4','C#5','G#4','D#5','A#4','E#5','B#4'] },
    { id:'F', label:'F dur (1♭)', tonic:'F3', preferFlats:true, marks:['Bb4'] },
    { id:'Bb', label:'B dur (2♭)', tonic:'Bb2', preferFlats:true, marks:['Bb4','Eb5'] },
    { id:'Eb', label:'Es dur (3♭)', tonic:'Eb3', preferFlats:true, marks:['Bb4','Eb5','Ab4'] },
    { id:'Ab', label:'As dur (4♭)', tonic:'Ab3', preferFlats:true, marks:['Bb4','Eb5','Ab4','Db5'] },
    { id:'Db', label:'Des dur (5♭)', tonic:'Db3', preferFlats:true, marks:['Bb4','Eb5','Ab4','Db5','Gb4'] },
    { id:'Gb', label:'Ges dur (6♭)', tonic:'Gb2', preferFlats:true, marks:['Bb4','Eb5','Ab4','Db5','Gb4','Cb5'] },
    { id:'Cb', label:'Ces dur (7♭)', tonic:'Cb3', preferFlats:true, marks:['Bb4','Eb5','Ab4','Db5','Gb4','Cb5','Fb4'] }
  ];

  function ready(fn){
    if(document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  function leadingSpaceFor(marks, meter){
    const count = Array.isArray(marks) ? marks.length : 0;
    const markWidth = count ? count * 16 + 12 : 0;
    const meterWidth = meter ? 32 : 0;
    const gap = 12;
    return markWidth + meterWidth + gap;
  }

  function valueToNote(value, preferFlats){
    const octave = Math.floor(value / 12);
    const names = preferFlats ? FLAT_NAMES : SHARP_NAMES;
    const name = names[((value % 12) + 12) % 12];
    const note = staff.parseNote(`${name}${octave}`);
    note.answer = note.answer || `${note.letter}${note.accidental||''}`;
    return note;
  }

  function buildMajorSequence(tonicId, preferFlats, count){
    const tonic = staff.parseNote(tonicId);
    const base = staff.noteValue(tonic);
    const degrees = [0,2,4,5,7,9,11]; // durový vzorec v rámci oktávy
    const list = [];
    for(let i=0;i<count;i++){
      const octave = Math.floor(i / degrees.length);
      const step = degrees[i % degrees.length] + 12 * octave;
      list.push(valueToNote(base + step, preferFlats));
    }
    return list;
  }

  // drawSignatureMarksLab was unified into drawSignatureMarks (global renderer)

  function initLab(){
    const url = new URL(window.location.href);
    const active = url.hash === '#render-lab' || url.searchParams.has('renderLab');
    const root = document.getElementById('view-render-lab');
    if(!root) return;
    if(!active){
      root.classList.add('hidden');
      return;
    }
    root.classList.remove('hidden');
    const clefSel = document.getElementById('render-lab-clef');
    const modeSel = document.getElementById('render-lab-mode');
    const scaleSel = document.getElementById('render-lab-scale');
    const zonesToggle = document.getElementById('render-lab-zones');
    const staffHost = document.getElementById('render-lab-staff');
    const debugEl = document.getElementById('render-lab-debug');
    if(!staffHost || !clefSel || !modeSel || !scaleSel) return;

    scaleSel.innerHTML = '';
    MAJOR_KEYS.forEach(key=>{
      const opt = document.createElement('option');
      opt.value = key.id;
      opt.textContent = key.label;
      scaleSel.appendChild(opt);
    });

  function buildTimeline(key, preferFlats){
    // připravíme dostatečně dlouhou řadu tónů, aby se neopakovaly
    const events = [
      { type:'note', duration:'whole' },
      { type:'note', duration:'half' },
      { type:'note', duration:'quarter' },
      { type:'note', duration:'quarter' },
      { type:'note', duration:'eighth' , beam:'8a'},
      { type:'note', duration:'eighth' , beam:'8a'},
      { type:'note', duration:'quarter' },
      { type:'note', duration:'quarter' },
      { type:'note', duration:'quarter' },
      { type:'note', duration:'quarter' },
      { type:'note', duration:'eighth' , beam:'8b'},
      { type:'note', duration:'eighth' , beam:'8b'},
      // čtyři šestnáctiny (1 doba)
      { type:'note', duration:'sixteenth' , beam:'16a' },
      { type:'note', duration:'sixteenth' , beam:'16a' },
      { type:'note', duration:'sixteenth' , beam:'16a' },
      { type:'note', duration:'sixteenth' , beam:'16a' },
      // osminová triola (1 doba) – aktuálně ponechána zakomentovaná, lze zapnout pro další ladění
      { type:'note', duration:'eighth', beam:'t3a', meta:{ tuplet:{ n:3, in:2 } } },
      { type:'note', duration:'eighth', beam:'t3a', meta:{ tuplet:{ n:3, in:2 } } },
      { type:'note', duration:'eighth', beam:'t3a', meta:{ tuplet:{ n:3, in:2 } } },
      // závěrečná osmina (0.5 doby)
      { type:'rest', duration:'whole' },
      { type:'rest', duration:'half' },
      { type:'rest', duration:'quarter' },
      { type:'rest', duration:'eighth' },
      { type:'rest', duration:'sixteenth' },
      { type:'rest', duration:'sixteenth' }
    ];

    const notesPool = buildMajorSequence(key.tonic, preferFlats, events.length + 6);
    let noteIdx = 0;
    const takeNote = ()=>{
      const n = notesPool[noteIdx % notesPool.length];
      noteIdx += 1;
      return n;
    };

    const items = events.map(evt=>{
      const note = takeNote();
      note.noteType = evt.duration;
      note.duration = evt.duration;
      note.kind = evt.type;
      note.beam = evt.beam;
      const mergedMeta = Object.assign({}, note.meta || {}, evt.meta || {});
      mergedMeta.kind = evt.type;
      note.meta = mergedMeta;
      return note;
    });
    return { items };
  }

    function render(){
      const keyId = scaleSel.value || 'C';
      const key = MAJOR_KEYS.find(k=>k.id === keyId) || MAJOR_KEYS[0];
      const preferFlats = !!key.preferFlats;
      const mode = modeSel.value || 'signature';
      const timeline = buildTimeline(key, preferFlats);
      if(!timeline.items.length) return;
      const layout = (App.noteDrawing && typeof App.noteDrawing.layoutMeasure === 'function')
        ? App.noteDrawing.layoutMeasure(timeline.items, {
            meterUnits:16,
            maxWidth:null,
            measures:4,
            accidentalSpace: mode === 'signature' ? 'forced' : 'all'
          })
        : null;
      staffHost.innerHTML = '';
      const useSignature = mode === 'signature';
      const lead = useSignature ? Math.max(40, leadingSpaceFor(key.marks, '4/4')) : 40;
      const placeholder = staff.parseNote(key.tonic);

      const render = staff.render({
        container: staffHost,
        clef: clefSel.value || 'treble',
        notes: timeline.items.map(item=>item || placeholder),
        options:{
          noteGap:18,
          paddingX:18,
          paddingY:10,
          extraTop:6,
          extraBottom:16,
          labelMargin:12,
          fillWidth:false,
          variableSpacing:true,
          meter:'4/4',
          layout,
          barUnits: layout && layout.barUnits ? layout.barUnits : null,
          finalBar:true,
          meterBase:'quarter',
          leadingSpace: lead,
          showAccidentals: mode !== 'signature',
          debugLayout:true,
          debugPositions:true,
          debugZones: zonesToggle ? zonesToggle.checked : true,
          debugSignatureSpace: useSignature && key.marks.length ? key.marks.length * 16 + 12 : 0,
          debugMeterSpace: 32,
          initialLabel:(_, idx)=>{
            const item = timeline.items[idx];
            if(!item) return '';
            return item.kind !== 'rest'
              ? (item.answer || `${item.letter}${item.accidental||''}`)
              : '';
          }
        }
      });
      const markFn = (window.App && App.drawSignatureMarks) ? App.drawSignatureMarks : null;
      if(useSignature && typeof markFn === 'function') markFn(render, key.marks);
      // Meter + barlines přes sdílený renderer (meter option) a ručně už nic nekreslíme
      if(debugEl && render && render.metrics){
        debugEl.textContent = JSON.stringify({
          key: key.id,
          preferFlats,
          mode,
          leadingSpace: lead,
          noteGap: render.metrics.noteGap,
          paddingX: render.metrics.paddingX,
          clefOffset: render.metrics.clefOffset,
          barUnits: timeline.bars,
          totalUnits: timeline.totalUnits
        }, null, 2);
      }

    }

    clefSel.addEventListener('change', render);
    modeSel.addEventListener('change', render);
    scaleSel.addEventListener('change', render);
    if(zonesToggle) zonesToggle.addEventListener('change', render);
    render();
  }

  ready(initLab);
})();
</script>






</body>
</html>
